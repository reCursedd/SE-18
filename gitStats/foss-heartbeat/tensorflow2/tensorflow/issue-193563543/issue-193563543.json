{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6091", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6091/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6091/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6091/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6091", "id": 193563543, "node_id": "MDU6SXNzdWUxOTM1NjM1NDM=", "number": 6091, "title": "Use model after trained in tensorflow (save/load graph)", "user": {"login": "shaolinkhoa", "id": 12138158, "node_id": "MDQ6VXNlcjEyMTM4MTU4", "avatar_url": "https://avatars2.githubusercontent.com/u/12138158?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shaolinkhoa", "html_url": "https://github.com/shaolinkhoa", "followers_url": "https://api.github.com/users/shaolinkhoa/followers", "following_url": "https://api.github.com/users/shaolinkhoa/following{/other_user}", "gists_url": "https://api.github.com/users/shaolinkhoa/gists{/gist_id}", "starred_url": "https://api.github.com/users/shaolinkhoa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shaolinkhoa/subscriptions", "organizations_url": "https://api.github.com/users/shaolinkhoa/orgs", "repos_url": "https://api.github.com/users/shaolinkhoa/repos", "events_url": "https://api.github.com/users/shaolinkhoa/events{/privacy}", "received_events_url": "https://api.github.com/users/shaolinkhoa/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-12-05T17:41:15Z", "updated_at": "2018-03-06T10:34:47Z", "closed_at": "2016-12-15T19:17:30Z", "author_association": "NONE", "body_html": "<p><strong>What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?</strong><br>\n<a href=\"http://stackoverflow.com/questions/33759623/tensorflow-how-to-restore-a-previously-saved-model-python\" rel=\"nofollow\">http://stackoverflow.com/questions/33759623/tensorflow-how-to-restore-a-previously-saved-model-python</a></p>\n<p><strong>Environment info<br>\nOperating System:</strong> Ubuntu 14.04</p>\n<p><strong>Installed version of tensorflow</strong>: '0.11.0'</p>\n<p>I already asked my question on stackoverflow: <a href=\"http://stackoverflow.com/questions/40956040/how-to-use-model-after-trained-in-tensorflow-save-load-graph\" rel=\"nofollow\">http://stackoverflow.com/questions/40956040/how-to-use-model-after-trained-in-tensorflow-save-load-graph</a><br>\nBut I can't find any helps so I have to ask here.</p>\n<p>I want to save a graph after training or save something else which tensorflow can load it.<br>\nI found there are two ways :</p>\n<ul>\n<li>using MetaGraph : <a href=\"https://www.tensorflow.org/versions/r0.11/how_tos/meta_graph/index.html\" rel=\"nofollow\">https://www.tensorflow.org/versions/r0.11/how_tos/meta_graph/index.html</a></li>\n<li>save Graph like the example <strong>image_retraining</strong> : <a href=\"https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/image_retraining\">https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/image_retraining</a></li>\n</ul>\n<p><strong>## I/ Using Exporting and Importing a MetaGraph</strong></p>\n<p>My <a href=\"https://github.com/shaolinkhoa/tensorflow/blob/master/05_convolutional_net.py\">Save.py</a> file:</p>\n<pre><code>X = tf.placeholder(\"float\", [None, 28, 28, 1], name='X')\nY = tf.placeholder(\"float\", [None, 10], name='Y')\n\ntf.train.Saver()\nwith tf.Session() as sess:\n     ...run something ...\n     final_tensor = tf.nn.softmax(py_x, name='final_result')\n     tf.add_to_collection(\"final_tensor\", final_tensor)\n\n     predict_op = tf.argmax(py_x, 1)\n     tf.add_to_collection(\"predict_op\", predict_op)\n\nsaver.save(sess, 'my_project') \n</code></pre>\n<p>Then I run <a href=\"https://github.com/shaolinkhoa/tensorflow/blob/master/load_05_convolution.py\">load.py</a>:</p>\n<pre><code>with tf.Session() as sess:\n   new_saver = tf.train.import_meta_graph('my_project.meta')\n   new_saver.restore(sess, 'my_project')\n   predict_op = tf.get_collection(\"predict_op\")[0]\n   for i in range(2):\n        test_indices = np.arange(len(teX)) # Get A Test Batch\n        np.random.shuffle(test_indices)\n        test_indices = test_indices[0:test_size]\n\n        print(i, np.mean(np.argmax(teY[test_indices], axis=1) ==\n                         sess.run(predict_op, feed_dict={\"X:0\": teX[test_indices],\n                                                         \"p_keep_conv:0\": 1.0,\n                                                         \"p_keep_hidden:0\": 1.0})))\n\n\n</code></pre>\n<p>but it return error</p>\n<pre><code>Traceback (most recent call last):\n  File \"load_05_convolution.py\", line 62, in &lt;module&gt;\n    \"p_keep_hidden:0\": 1.0})))\n  File \"/home/khoa/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 717, in run\n    run_metadata_ptr)\n  File \"/home/khoa/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 894, in _run\n    % (np_val.shape, subfeed_t.name, str(subfeed_t.get_shape())))\nValueError: Cannot feed value of shape (256, 784) for Tensor u'X:0', which has shape '(?, 28, 28, 1)'\n\n</code></pre>\n<p>I really don't know why?</p>\n<p>If I add <code>final_tensor = tf.get_collection(\"final_result\")[0]</code></p>\n<p>It return another error:</p>\n<pre><code>Traceback (most recent call last):\n  File \"load_05_convolution.py\", line 46, in &lt;module&gt;\n    final_tensor = tf.get_collection(\"final_result\")[0]\nIndexError: list index out of range\n</code></pre>\n<p>Is it because tf.add_to_collection only contains only one tensor ?</p>\n<h2><strong>II/ using tf.train.write_graph</strong></h2>\n<p>I add this line to the end of the save.py :  <code>tf.train.write_graph(graph, 'folder', 'train.pb')</code></p>\n<p>It created file 'train.pb' successfully.</p>\n<p>My <a href=\"https://github.com/shaolinkhoa/tensorflow/blob/master/load_05_convolution.py\">load.py</a>:</p>\n<pre><code>with tf.gfile.FastGFile('folder/train.pb', 'rb') as f:\n    graph_def = tf.GraphDef()\n    graph_def.ParseFromString(f.read())\n    _ = tf.import_graph_def(graph_def, name='')\n\nwith tf.Session() as sess:\n  predict_op = sess.graph.get_tensor_by_name('predict_op:0')\n  for i in range(2):\n        test_indices = np.arange(len(teX)) # Get A Test Batch\n        np.random.shuffle(test_indices)\n        test_indices = test_indices[0:test_size]\n\n        print(i, np.mean(np.argmax(teY[test_indices], axis=1) ==\n                         sess.run(predict_op, feed_dict={\"X:0\": teX[test_indices],\n                                                         \"p_keep_conv:0\": 1.0,\n                                                         \"p_keep_hidden:0\": 1.0})))\n\n</code></pre>\n<p>Then it return error:</p>\n<pre><code>Traceback (most recent call last):\n  File \"load_05_convolution.py\", line 22, in &lt;module&gt;\n    graph_def.ParseFromString(f.read())\n  File \"/home/khoa/tensorflow/lib/python2.7/site-packages/google/protobuf/message.py\", line 185, in ParseFromString\n    self.MergeFromString(serialized)\n  File \"/home/khoa/tensorflow/lib/python2.7/site-packages/google/protobuf/internal/python_message.py\", line 1085, in MergeFromString\n    raise message_mod.DecodeError('Unexpected end-group tag.')\ngoogle.protobuf.message.DecodeError: Unexpected end-group tag.\n</code></pre>\n<p>would you mind sharing the standard way, code or tutorial to save/load model ? I'm really confused.</p>", "body_text": "What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\nhttp://stackoverflow.com/questions/33759623/tensorflow-how-to-restore-a-previously-saved-model-python\nEnvironment info\nOperating System: Ubuntu 14.04\nInstalled version of tensorflow: '0.11.0'\nI already asked my question on stackoverflow: http://stackoverflow.com/questions/40956040/how-to-use-model-after-trained-in-tensorflow-save-load-graph\nBut I can't find any helps so I have to ask here.\nI want to save a graph after training or save something else which tensorflow can load it.\nI found there are two ways :\n\nusing MetaGraph : https://www.tensorflow.org/versions/r0.11/how_tos/meta_graph/index.html\nsave Graph like the example image_retraining : https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/image_retraining\n\n## I/ Using Exporting and Importing a MetaGraph\nMy Save.py file:\nX = tf.placeholder(\"float\", [None, 28, 28, 1], name='X')\nY = tf.placeholder(\"float\", [None, 10], name='Y')\n\ntf.train.Saver()\nwith tf.Session() as sess:\n     ...run something ...\n     final_tensor = tf.nn.softmax(py_x, name='final_result')\n     tf.add_to_collection(\"final_tensor\", final_tensor)\n\n     predict_op = tf.argmax(py_x, 1)\n     tf.add_to_collection(\"predict_op\", predict_op)\n\nsaver.save(sess, 'my_project') \n\nThen I run load.py:\nwith tf.Session() as sess:\n   new_saver = tf.train.import_meta_graph('my_project.meta')\n   new_saver.restore(sess, 'my_project')\n   predict_op = tf.get_collection(\"predict_op\")[0]\n   for i in range(2):\n        test_indices = np.arange(len(teX)) # Get A Test Batch\n        np.random.shuffle(test_indices)\n        test_indices = test_indices[0:test_size]\n\n        print(i, np.mean(np.argmax(teY[test_indices], axis=1) ==\n                         sess.run(predict_op, feed_dict={\"X:0\": teX[test_indices],\n                                                         \"p_keep_conv:0\": 1.0,\n                                                         \"p_keep_hidden:0\": 1.0})))\n\n\n\nbut it return error\nTraceback (most recent call last):\n  File \"load_05_convolution.py\", line 62, in <module>\n    \"p_keep_hidden:0\": 1.0})))\n  File \"/home/khoa/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 717, in run\n    run_metadata_ptr)\n  File \"/home/khoa/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 894, in _run\n    % (np_val.shape, subfeed_t.name, str(subfeed_t.get_shape())))\nValueError: Cannot feed value of shape (256, 784) for Tensor u'X:0', which has shape '(?, 28, 28, 1)'\n\n\nI really don't know why?\nIf I add final_tensor = tf.get_collection(\"final_result\")[0]\nIt return another error:\nTraceback (most recent call last):\n  File \"load_05_convolution.py\", line 46, in <module>\n    final_tensor = tf.get_collection(\"final_result\")[0]\nIndexError: list index out of range\n\nIs it because tf.add_to_collection only contains only one tensor ?\nII/ using tf.train.write_graph\nI add this line to the end of the save.py :  tf.train.write_graph(graph, 'folder', 'train.pb')\nIt created file 'train.pb' successfully.\nMy load.py:\nwith tf.gfile.FastGFile('folder/train.pb', 'rb') as f:\n    graph_def = tf.GraphDef()\n    graph_def.ParseFromString(f.read())\n    _ = tf.import_graph_def(graph_def, name='')\n\nwith tf.Session() as sess:\n  predict_op = sess.graph.get_tensor_by_name('predict_op:0')\n  for i in range(2):\n        test_indices = np.arange(len(teX)) # Get A Test Batch\n        np.random.shuffle(test_indices)\n        test_indices = test_indices[0:test_size]\n\n        print(i, np.mean(np.argmax(teY[test_indices], axis=1) ==\n                         sess.run(predict_op, feed_dict={\"X:0\": teX[test_indices],\n                                                         \"p_keep_conv:0\": 1.0,\n                                                         \"p_keep_hidden:0\": 1.0})))\n\n\nThen it return error:\nTraceback (most recent call last):\n  File \"load_05_convolution.py\", line 22, in <module>\n    graph_def.ParseFromString(f.read())\n  File \"/home/khoa/tensorflow/lib/python2.7/site-packages/google/protobuf/message.py\", line 185, in ParseFromString\n    self.MergeFromString(serialized)\n  File \"/home/khoa/tensorflow/lib/python2.7/site-packages/google/protobuf/internal/python_message.py\", line 1085, in MergeFromString\n    raise message_mod.DecodeError('Unexpected end-group tag.')\ngoogle.protobuf.message.DecodeError: Unexpected end-group tag.\n\nwould you mind sharing the standard way, code or tutorial to save/load model ? I'm really confused.", "body": "**What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?**\r\nhttp://stackoverflow.com/questions/33759623/tensorflow-how-to-restore-a-previously-saved-model-python\r\n\r\n **Environment info\r\nOperating System:** Ubuntu 14.04\r\n\r\n**Installed version of tensorflow**: '0.11.0'\r\n\r\nI already asked my question on stackoverflow: http://stackoverflow.com/questions/40956040/how-to-use-model-after-trained-in-tensorflow-save-load-graph\r\nBut I can't find any helps so I have to ask here.\r\n\r\nI want to save a graph after training or save something else which tensorflow can load it. \r\nI found there are two ways : \r\n\r\n- using MetaGraph : https://www.tensorflow.org/versions/r0.11/how_tos/meta_graph/index.html\r\n- save Graph like the example **image_retraining** : https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/image_retraining\r\n\r\n**## I/ Using Exporting and Importing a MetaGraph**\r\n\r\nMy [Save.py](https://github.com/shaolinkhoa/tensorflow/blob/master/05_convolutional_net.py) file:\r\n```\r\nX = tf.placeholder(\"float\", [None, 28, 28, 1], name='X')\r\nY = tf.placeholder(\"float\", [None, 10], name='Y')\r\n\r\ntf.train.Saver()\r\nwith tf.Session() as sess:\r\n     ...run something ...\r\n     final_tensor = tf.nn.softmax(py_x, name='final_result')\r\n     tf.add_to_collection(\"final_tensor\", final_tensor)\r\n\r\n     predict_op = tf.argmax(py_x, 1)\r\n     tf.add_to_collection(\"predict_op\", predict_op)\r\n\r\nsaver.save(sess, 'my_project') \r\n```\r\n\r\nThen I run [load.py](https://github.com/shaolinkhoa/tensorflow/blob/master/load_05_convolution.py):\r\n```\r\nwith tf.Session() as sess:\r\n   new_saver = tf.train.import_meta_graph('my_project.meta')\r\n   new_saver.restore(sess, 'my_project')\r\n   predict_op = tf.get_collection(\"predict_op\")[0]\r\n   for i in range(2):\r\n        test_indices = np.arange(len(teX)) # Get A Test Batch\r\n        np.random.shuffle(test_indices)\r\n        test_indices = test_indices[0:test_size]\r\n\r\n        print(i, np.mean(np.argmax(teY[test_indices], axis=1) ==\r\n                         sess.run(predict_op, feed_dict={\"X:0\": teX[test_indices],\r\n                                                         \"p_keep_conv:0\": 1.0,\r\n                                                         \"p_keep_hidden:0\": 1.0})))\r\n\r\n\r\n```\r\n\r\nbut it return error\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"load_05_convolution.py\", line 62, in <module>\r\n    \"p_keep_hidden:0\": 1.0})))\r\n  File \"/home/khoa/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 717, in run\r\n    run_metadata_ptr)\r\n  File \"/home/khoa/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 894, in _run\r\n    % (np_val.shape, subfeed_t.name, str(subfeed_t.get_shape())))\r\nValueError: Cannot feed value of shape (256, 784) for Tensor u'X:0', which has shape '(?, 28, 28, 1)'\r\n\r\n```\r\nI really don't know why?\r\n\r\n\r\nIf I add `final_tensor = tf.get_collection(\"final_result\")[0]`\r\n\r\nIt return another error:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"load_05_convolution.py\", line 46, in <module>\r\n    final_tensor = tf.get_collection(\"final_result\")[0]\r\nIndexError: list index out of range\r\n```\r\n\r\nIs it because tf.add_to_collection only contains only one tensor ?\r\n\r\n## **II/ using tf.train.write_graph**\r\n\r\nI add this line to the end of the save.py :  `tf.train.write_graph(graph, 'folder', 'train.pb')`\r\n\r\nIt created file 'train.pb' successfully.\r\n\r\nMy [load.py](https://github.com/shaolinkhoa/tensorflow/blob/master/load_05_convolution.py):\r\n```\r\nwith tf.gfile.FastGFile('folder/train.pb', 'rb') as f:\r\n    graph_def = tf.GraphDef()\r\n    graph_def.ParseFromString(f.read())\r\n    _ = tf.import_graph_def(graph_def, name='')\r\n\r\nwith tf.Session() as sess:\r\n  predict_op = sess.graph.get_tensor_by_name('predict_op:0')\r\n  for i in range(2):\r\n        test_indices = np.arange(len(teX)) # Get A Test Batch\r\n        np.random.shuffle(test_indices)\r\n        test_indices = test_indices[0:test_size]\r\n\r\n        print(i, np.mean(np.argmax(teY[test_indices], axis=1) ==\r\n                         sess.run(predict_op, feed_dict={\"X:0\": teX[test_indices],\r\n                                                         \"p_keep_conv:0\": 1.0,\r\n                                                         \"p_keep_hidden:0\": 1.0})))\r\n\r\n```\r\nThen it return error:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"load_05_convolution.py\", line 22, in <module>\r\n    graph_def.ParseFromString(f.read())\r\n  File \"/home/khoa/tensorflow/lib/python2.7/site-packages/google/protobuf/message.py\", line 185, in ParseFromString\r\n    self.MergeFromString(serialized)\r\n  File \"/home/khoa/tensorflow/lib/python2.7/site-packages/google/protobuf/internal/python_message.py\", line 1085, in MergeFromString\r\n    raise message_mod.DecodeError('Unexpected end-group tag.')\r\ngoogle.protobuf.message.DecodeError: Unexpected end-group tag.\r\n```\r\n\r\nwould you mind sharing the standard way, code or tutorial to save/load model ? I'm really confused."}