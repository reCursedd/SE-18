{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9401", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9401/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9401/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9401/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/9401", "id": 223704639, "node_id": "MDU6SXNzdWUyMjM3MDQ2Mzk=", "number": 9401, "title": "ValueError: Attempt to reuse RNNCell with a different variable scope than its first use", "user": {"login": "Songweiping", "id": 11703156, "node_id": "MDQ6VXNlcjExNzAzMTU2", "avatar_url": "https://avatars2.githubusercontent.com/u/11703156?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Songweiping", "html_url": "https://github.com/Songweiping", "followers_url": "https://api.github.com/users/Songweiping/followers", "following_url": "https://api.github.com/users/Songweiping/following{/other_user}", "gists_url": "https://api.github.com/users/Songweiping/gists{/gist_id}", "starred_url": "https://api.github.com/users/Songweiping/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Songweiping/subscriptions", "organizations_url": "https://api.github.com/users/Songweiping/orgs", "repos_url": "https://api.github.com/users/Songweiping/repos", "events_url": "https://api.github.com/users/Songweiping/events{/privacy}", "received_events_url": "https://api.github.com/users/Songweiping/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2017-04-24T05:03:54Z", "updated_at": "2018-08-02T05:03:37Z", "closed_at": "2017-04-25T02:28:36Z", "author_association": "CONTRIBUTOR", "body_html": "<p>OS: Ubuntu 14.04<br>\nTF installed from source.<br>\nTF version: 1.1.0-rc</p>\n<p>I want to reuse a RNNCell in two different variable scopes, which could simply  be like this:</p>\n<pre><code>import tensorflow as tf\nfrom tensorflow.contrib import rnn\n\nx = tf.placeholder(tf.int32, [128, 20])\nembedding = tf.get_variable('embedding', [10000, 100])\ncells = []\nfor _ in range(10):\n    cell = rnn.BasicLSTMCell(100, state_is_tuple=True)\n    cells.append(cell)\ncell = rnn.MultiRNNCell(cells)\nzero_state = cell.zero_state(128, tf.float32)\n\ninputs = tf.nn.embedding_lookup(embedding, x)\nwith tf.variable_scope('rnn1'):\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\nwith tf.variable_scope('rnn2'):\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\n</code></pre>\n<p>But I got following error:</p>\n<pre><code>Traceback (most recent call last):\n  File \"test.py\", line 18, in &lt;module&gt;\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 582, in dynamic_rnn\n    dtype=dtype)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 745, in _dynamic_rnn_loop\n    swap_memory=swap_memory)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2623, in while_loop\n    result = context.BuildLoop(cond, body, loop_vars, shape_invariants)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2456, in BuildLoop\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2406, in _BuildLoop\n    body_result = body(*packed_vars_for_body)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 730, in _time_step\n    (output, new_state) = call_cell()\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 716, in &lt;lambda&gt;\n    call_cell = lambda: cell(input_t, state)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 968, in __call__\n    cur_inp, new_state = cell(cur_inp, cur_state)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 242, in __call__\n    with _checked_scope(self, scope or \"basic_lstm_cell\", reuse=self._reuse):\n  File \"/usr/lib/python2.7/contextlib.py\", line 17, in __enter__\n    return self.gen.next()\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 84, in _checked_scope\n    type(cell).__name__))\nValueError: Attempt to reuse RNNCell &lt;tensorflow.contrib.rnn.python.ops.core_rnn_cell_impl.BasicLSTMCell object at 0x7fb1c0aa1e90&gt; with a different variable scope than its first use.  First use of cell was with scope 'rnn1/rnn/multi_rnn_cell/cell_0/basic_lstm_cell', this attempt is with scope 'rnn2/rnn/multi_rnn_cell/cell_0/basic_lstm_cell'.  Please create a new instance of the cell if you would like it to use a different set of weights.  If before you were using: MultiRNNCell([BasicLSTMCell(...)] * num_layers), change to: MultiRNNCell([BasicLSTMCell(...) for _ in range(num_layers)]).  If before you were using the same cell instance as both the forward and reverse cell of a bidirectional RNN, simply create two instances (one for forward, one for reverse).  In May 2017, we will start transitioning this cell's behavior to use existing stored weights, if any, when it is called with scope=None (which can lead to silent model degradation, so this error will remain until then.)\n\n</code></pre>\n<p>I googled this issue and found that <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"212690293\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/8191\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/8191/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/8191\">#8191</a> is similar but not identical. That issue was caused by new arg \"reuse\" of LSTMCell.<br>\nStrangely, when I use TF with version 1.0.1 builf from binary. the same code doesn't have this ValueError.</p>\n<p>So, my questions is how to reuse a RNNCell within different variable scopes correctly in version 1.1.0-rc.<br>\nThanks!</p>", "body_text": "OS: Ubuntu 14.04\nTF installed from source.\nTF version: 1.1.0-rc\nI want to reuse a RNNCell in two different variable scopes, which could simply  be like this:\nimport tensorflow as tf\nfrom tensorflow.contrib import rnn\n\nx = tf.placeholder(tf.int32, [128, 20])\nembedding = tf.get_variable('embedding', [10000, 100])\ncells = []\nfor _ in range(10):\n    cell = rnn.BasicLSTMCell(100, state_is_tuple=True)\n    cells.append(cell)\ncell = rnn.MultiRNNCell(cells)\nzero_state = cell.zero_state(128, tf.float32)\n\ninputs = tf.nn.embedding_lookup(embedding, x)\nwith tf.variable_scope('rnn1'):\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\nwith tf.variable_scope('rnn2'):\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\n\nBut I got following error:\nTraceback (most recent call last):\n  File \"test.py\", line 18, in <module>\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 582, in dynamic_rnn\n    dtype=dtype)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 745, in _dynamic_rnn_loop\n    swap_memory=swap_memory)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2623, in while_loop\n    result = context.BuildLoop(cond, body, loop_vars, shape_invariants)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2456, in BuildLoop\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2406, in _BuildLoop\n    body_result = body(*packed_vars_for_body)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 730, in _time_step\n    (output, new_state) = call_cell()\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 716, in <lambda>\n    call_cell = lambda: cell(input_t, state)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 968, in __call__\n    cur_inp, new_state = cell(cur_inp, cur_state)\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 242, in __call__\n    with _checked_scope(self, scope or \"basic_lstm_cell\", reuse=self._reuse):\n  File \"/usr/lib/python2.7/contextlib.py\", line 17, in __enter__\n    return self.gen.next()\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 84, in _checked_scope\n    type(cell).__name__))\nValueError: Attempt to reuse RNNCell <tensorflow.contrib.rnn.python.ops.core_rnn_cell_impl.BasicLSTMCell object at 0x7fb1c0aa1e90> with a different variable scope than its first use.  First use of cell was with scope 'rnn1/rnn/multi_rnn_cell/cell_0/basic_lstm_cell', this attempt is with scope 'rnn2/rnn/multi_rnn_cell/cell_0/basic_lstm_cell'.  Please create a new instance of the cell if you would like it to use a different set of weights.  If before you were using: MultiRNNCell([BasicLSTMCell(...)] * num_layers), change to: MultiRNNCell([BasicLSTMCell(...) for _ in range(num_layers)]).  If before you were using the same cell instance as both the forward and reverse cell of a bidirectional RNN, simply create two instances (one for forward, one for reverse).  In May 2017, we will start transitioning this cell's behavior to use existing stored weights, if any, when it is called with scope=None (which can lead to silent model degradation, so this error will remain until then.)\n\n\nI googled this issue and found that #8191 is similar but not identical. That issue was caused by new arg \"reuse\" of LSTMCell.\nStrangely, when I use TF with version 1.0.1 builf from binary. the same code doesn't have this ValueError.\nSo, my questions is how to reuse a RNNCell within different variable scopes correctly in version 1.1.0-rc.\nThanks!", "body": "OS: Ubuntu 14.04\r\nTF installed from source.\r\nTF version: 1.1.0-rc\r\n\r\nI want to reuse a RNNCell in two different variable scopes, which could simply  be like this:\r\n\r\n```\r\nimport tensorflow as tf\r\nfrom tensorflow.contrib import rnn\r\n\r\nx = tf.placeholder(tf.int32, [128, 20])\r\nembedding = tf.get_variable('embedding', [10000, 100])\r\ncells = []\r\nfor _ in range(10):\r\n    cell = rnn.BasicLSTMCell(100, state_is_tuple=True)\r\n    cells.append(cell)\r\ncell = rnn.MultiRNNCell(cells)\r\nzero_state = cell.zero_state(128, tf.float32)\r\n\r\ninputs = tf.nn.embedding_lookup(embedding, x)\r\nwith tf.variable_scope('rnn1'):\r\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\r\nwith tf.variable_scope('rnn2'):\r\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\r\n```\r\n\r\nBut I got following error:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 18, in <module>\r\n    _, state = tf.nn.dynamic_rnn(cell, inputs=inputs, initial_state=zero_state)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 582, in dynamic_rnn\r\n    dtype=dtype)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 745, in _dynamic_rnn_loop\r\n    swap_memory=swap_memory)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2623, in while_loop\r\n    result = context.BuildLoop(cond, body, loop_vars, shape_invariants)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2456, in BuildLoop\r\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2406, in _BuildLoop\r\n    body_result = body(*packed_vars_for_body)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 730, in _time_step\r\n    (output, new_state) = call_cell()\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py\", line 716, in <lambda>\r\n    call_cell = lambda: cell(input_t, state)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 968, in __call__\r\n    cur_inp, new_state = cell(cur_inp, cur_state)\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 242, in __call__\r\n    with _checked_scope(self, scope or \"basic_lstm_cell\", reuse=self._reuse):\r\n  File \"/usr/lib/python2.7/contextlib.py\", line 17, in __enter__\r\n    return self.gen.next()\r\n  File \"/home/swp/test/local/lib/python2.7/site-packages/tensorflow/contrib/rnn/python/ops/core_rnn_cell_impl.py\", line 84, in _checked_scope\r\n    type(cell).__name__))\r\nValueError: Attempt to reuse RNNCell <tensorflow.contrib.rnn.python.ops.core_rnn_cell_impl.BasicLSTMCell object at 0x7fb1c0aa1e90> with a different variable scope than its first use.  First use of cell was with scope 'rnn1/rnn/multi_rnn_cell/cell_0/basic_lstm_cell', this attempt is with scope 'rnn2/rnn/multi_rnn_cell/cell_0/basic_lstm_cell'.  Please create a new instance of the cell if you would like it to use a different set of weights.  If before you were using: MultiRNNCell([BasicLSTMCell(...)] * num_layers), change to: MultiRNNCell([BasicLSTMCell(...) for _ in range(num_layers)]).  If before you were using the same cell instance as both the forward and reverse cell of a bidirectional RNN, simply create two instances (one for forward, one for reverse).  In May 2017, we will start transitioning this cell's behavior to use existing stored weights, if any, when it is called with scope=None (which can lead to silent model degradation, so this error will remain until then.)\r\n\r\n```\r\nI googled this issue and found that https://github.com/tensorflow/tensorflow/issues/8191 is similar but not identical. That issue was caused by new arg \"reuse\" of LSTMCell.\r\nStrangely, when I use TF with version 1.0.1 builf from binary. the same code doesn't have this ValueError.\r\n\r\nSo, my questions is how to reuse a RNNCell within different variable scopes correctly in version 1.1.0-rc.\r\nThanks!"}