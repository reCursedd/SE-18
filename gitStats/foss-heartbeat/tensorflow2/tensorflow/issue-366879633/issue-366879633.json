{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22737", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22737/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22737/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22737/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22737", "id": 366879633, "node_id": "MDU6SXNzdWUzNjY4Nzk2MzM=", "number": 22737, "title": "Batch Jacobian seems to have troubles to pass through `tf.nn.elu` and `tf.nn softplus`", "user": {"login": "ricvo", "id": 9975354, "node_id": "MDQ6VXNlcjk5NzUzNTQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/9975354?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ricvo", "html_url": "https://github.com/ricvo", "followers_url": "https://api.github.com/users/ricvo/followers", "following_url": "https://api.github.com/users/ricvo/following{/other_user}", "gists_url": "https://api.github.com/users/ricvo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ricvo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ricvo/subscriptions", "organizations_url": "https://api.github.com/users/ricvo/orgs", "repos_url": "https://api.github.com/users/ricvo/repos", "events_url": "https://api.github.com/users/ricvo/events{/privacy}", "received_events_url": "https://api.github.com/users/ricvo/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2018-10-04T16:49:28Z", "updated_at": "2018-11-02T01:49:15Z", "closed_at": "2018-10-19T16:20:38Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>Linux Ubuntu 16.04</li>\n<li>tensorflow 1.11.0</li>\n<li>python3.5.2</li>\n</ul>\n<h3>The problem</h3>\n<p>Batch Jacobian seems to have troubles to pass through <code>tf.nn.elu</code> and <code>tf.nn softplus</code></p>\n<h3>Source code</h3>\n<pre><code>import tensorflow as tf\nfrom tensorflow.python.ops.parallel_for.gradients import batch_jacobian\ntf.set_random_seed(1000)\nimport os\nos.environ[\"CUDA_DEVICE_ORDER\"]=\"PCI_BUS_ID\"\nos.environ[\"CUDA_VISIBLE_DEVICES\"]='1'\nimport argparse\n\n\nparser = argparse.ArgumentParser(description='test jacobian', formatter_class=argparse.ArgumentDefaultsHelpFormatter)\n\nparser.add_argument('--activation', '-a', default=None)\n\nargs = parser.parse_args()\n\nprint(\"using tensorflow\"+tf.__version__)\nact1=None\nif args.activation:\n    act1 = getattr(tf.nn, args.activation)\n\nprint(\"activation = \"+str(act1))\n\nx = tf.placeholder(tf.float32, shape=[None, 784], name='input')\nmy_layer = tf.layers.dense(inputs=x,\n                           units=10,\n                           activation=act1\n                           )\n\njac = batch_jacobian(my_layer,x)\n</code></pre>\n<h3>Error</h3>\n<pre><code>$ python test-jacobian-simple.py -a softplus\nusing tensorflow1.11.0\nactivation = &lt;function softplus at 0x7f345a279840&gt;\nTraceback (most recent call last):\n  File \"test-jacobian-simple.py\", line 29, in &lt;module&gt;\n    jac = batch_jacobian(my_layer,x)\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/gradients.py\", line 119, in batch_jacobian\n    pfor_output = control_flow_ops.pfor(loop_fn, output_row_size)\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/control_flow_ops.py\", line 129, in pfor\n    outputs.append(converter.convert(loop_fn_output))\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/pfor.py\", line 1077, in convert\n    output = self._convert_helper(y)\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/pfor.py\", line 1216, in _convert_helper\n    if flags.FLAGS.op_conversion_fallback_to_while_loop:\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/absl/flags/_flagvalues.py\", line 490, in __getattr__\n    raise _exceptions.UnparsedFlagAccessError(error_message)\nabsl.flags._exceptions.UnparsedFlagAccessError: Trying to access flag --op_conversion_fallback_to_while_loop before flags were parsed.\n</code></pre>\n<p>Same error with:<br>\n<code>python test-jacobian-simple.py -a elu</code></p>\n<p>If I run with rel;u or leaky_relu instead it works fine:<br>\n<code>python test-jacobian-simple.py -a relu</code><br>\n<code>python test-jacobian-simple.py -a leaky_relu</code></p>\n<p>Any ideas on how to fix this or how to workaround?</p>", "body_text": "System information\n\nLinux Ubuntu 16.04\ntensorflow 1.11.0\npython3.5.2\n\nThe problem\nBatch Jacobian seems to have troubles to pass through tf.nn.elu and tf.nn softplus\nSource code\nimport tensorflow as tf\nfrom tensorflow.python.ops.parallel_for.gradients import batch_jacobian\ntf.set_random_seed(1000)\nimport os\nos.environ[\"CUDA_DEVICE_ORDER\"]=\"PCI_BUS_ID\"\nos.environ[\"CUDA_VISIBLE_DEVICES\"]='1'\nimport argparse\n\n\nparser = argparse.ArgumentParser(description='test jacobian', formatter_class=argparse.ArgumentDefaultsHelpFormatter)\n\nparser.add_argument('--activation', '-a', default=None)\n\nargs = parser.parse_args()\n\nprint(\"using tensorflow\"+tf.__version__)\nact1=None\nif args.activation:\n    act1 = getattr(tf.nn, args.activation)\n\nprint(\"activation = \"+str(act1))\n\nx = tf.placeholder(tf.float32, shape=[None, 784], name='input')\nmy_layer = tf.layers.dense(inputs=x,\n                           units=10,\n                           activation=act1\n                           )\n\njac = batch_jacobian(my_layer,x)\n\nError\n$ python test-jacobian-simple.py -a softplus\nusing tensorflow1.11.0\nactivation = <function softplus at 0x7f345a279840>\nTraceback (most recent call last):\n  File \"test-jacobian-simple.py\", line 29, in <module>\n    jac = batch_jacobian(my_layer,x)\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/gradients.py\", line 119, in batch_jacobian\n    pfor_output = control_flow_ops.pfor(loop_fn, output_row_size)\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/control_flow_ops.py\", line 129, in pfor\n    outputs.append(converter.convert(loop_fn_output))\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/pfor.py\", line 1077, in convert\n    output = self._convert_helper(y)\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/pfor.py\", line 1216, in _convert_helper\n    if flags.FLAGS.op_conversion_fallback_to_while_loop:\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/absl/flags/_flagvalues.py\", line 490, in __getattr__\n    raise _exceptions.UnparsedFlagAccessError(error_message)\nabsl.flags._exceptions.UnparsedFlagAccessError: Trying to access flag --op_conversion_fallback_to_while_loop before flags were parsed.\n\nSame error with:\npython test-jacobian-simple.py -a elu\nIf I run with rel;u or leaky_relu instead it works fine:\npython test-jacobian-simple.py -a relu\npython test-jacobian-simple.py -a leaky_relu\nAny ideas on how to fix this or how to workaround?", "body": "### System information\r\n- Linux Ubuntu 16.04\r\n- tensorflow 1.11.0\r\n- python3.5.2\r\n\r\n### The problem\r\nBatch Jacobian seems to have troubles to pass through `tf.nn.elu` and `tf.nn softplus`\r\n\r\n### Source code\r\n```\r\nimport tensorflow as tf\r\nfrom tensorflow.python.ops.parallel_for.gradients import batch_jacobian\r\ntf.set_random_seed(1000)\r\nimport os\r\nos.environ[\"CUDA_DEVICE_ORDER\"]=\"PCI_BUS_ID\"\r\nos.environ[\"CUDA_VISIBLE_DEVICES\"]='1'\r\nimport argparse\r\n\r\n\r\nparser = argparse.ArgumentParser(description='test jacobian', formatter_class=argparse.ArgumentDefaultsHelpFormatter)\r\n\r\nparser.add_argument('--activation', '-a', default=None)\r\n\r\nargs = parser.parse_args()\r\n\r\nprint(\"using tensorflow\"+tf.__version__)\r\nact1=None\r\nif args.activation:\r\n    act1 = getattr(tf.nn, args.activation)\r\n\r\nprint(\"activation = \"+str(act1))\r\n\r\nx = tf.placeholder(tf.float32, shape=[None, 784], name='input')\r\nmy_layer = tf.layers.dense(inputs=x,\r\n                           units=10,\r\n                           activation=act1\r\n                           )\r\n\r\njac = batch_jacobian(my_layer,x)\r\n```\r\n\r\n ### Error\r\n```\r\n$ python test-jacobian-simple.py -a softplus\r\nusing tensorflow1.11.0\r\nactivation = <function softplus at 0x7f345a279840>\r\nTraceback (most recent call last):\r\n  File \"test-jacobian-simple.py\", line 29, in <module>\r\n    jac = batch_jacobian(my_layer,x)\r\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/gradients.py\", line 119, in batch_jacobian\r\n    pfor_output = control_flow_ops.pfor(loop_fn, output_row_size)\r\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/control_flow_ops.py\", line 129, in pfor\r\n    outputs.append(converter.convert(loop_fn_output))\r\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/pfor.py\", line 1077, in convert\r\n    output = self._convert_helper(y)\r\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/tensorflow/python/ops/parallel_for/pfor.py\", line 1216, in _convert_helper\r\n    if flags.FLAGS.op_conversion_fallback_to_while_loop:\r\n  File \"/data1/env/tf1.11.0/lib/python3.5/site-packages/absl/flags/_flagvalues.py\", line 490, in __getattr__\r\n    raise _exceptions.UnparsedFlagAccessError(error_message)\r\nabsl.flags._exceptions.UnparsedFlagAccessError: Trying to access flag --op_conversion_fallback_to_while_loop before flags were parsed.\r\n```\r\n\r\nSame error with:\r\n`python test-jacobian-simple.py -a elu`\r\n\r\nIf I run with rel;u or leaky_relu instead it works fine:\r\n`python test-jacobian-simple.py -a relu`\r\n`python test-jacobian-simple.py -a leaky_relu`\r\n\r\nAny ideas on how to fix this or how to workaround?\r\n"}