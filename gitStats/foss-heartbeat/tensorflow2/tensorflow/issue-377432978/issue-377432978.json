{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23525", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23525/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23525/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23525/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23525", "id": 377432978, "node_id": "MDU6SXNzdWUzNzc0MzI5Nzg=", "number": 23525, "title": "tf.contrib.estimator.InMemoryEvaluatorHook does not work with MirroredStrategy", "user": {"login": "KDMueller", "id": 38278891, "node_id": "MDQ6VXNlcjM4Mjc4ODkx", "avatar_url": "https://avatars3.githubusercontent.com/u/38278891?v=4", "gravatar_id": "", "url": "https://api.github.com/users/KDMueller", "html_url": "https://github.com/KDMueller", "followers_url": "https://api.github.com/users/KDMueller/followers", "following_url": "https://api.github.com/users/KDMueller/following{/other_user}", "gists_url": "https://api.github.com/users/KDMueller/gists{/gist_id}", "starred_url": "https://api.github.com/users/KDMueller/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/KDMueller/subscriptions", "organizations_url": "https://api.github.com/users/KDMueller/orgs", "repos_url": "https://api.github.com/users/KDMueller/repos", "events_url": "https://api.github.com/users/KDMueller/events{/privacy}", "received_events_url": "https://api.github.com/users/KDMueller/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "open", "locked": false, "assignee": {"login": "josh11b", "id": 15258583, "node_id": "MDQ6VXNlcjE1MjU4NTgz", "avatar_url": "https://avatars0.githubusercontent.com/u/15258583?v=4", "gravatar_id": "", "url": "https://api.github.com/users/josh11b", "html_url": "https://github.com/josh11b", "followers_url": "https://api.github.com/users/josh11b/followers", "following_url": "https://api.github.com/users/josh11b/following{/other_user}", "gists_url": "https://api.github.com/users/josh11b/gists{/gist_id}", "starred_url": "https://api.github.com/users/josh11b/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/josh11b/subscriptions", "organizations_url": "https://api.github.com/users/josh11b/orgs", "repos_url": "https://api.github.com/users/josh11b/repos", "events_url": "https://api.github.com/users/josh11b/events{/privacy}", "received_events_url": "https://api.github.com/users/josh11b/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "josh11b", "id": 15258583, "node_id": "MDQ6VXNlcjE1MjU4NTgz", "avatar_url": "https://avatars0.githubusercontent.com/u/15258583?v=4", "gravatar_id": "", "url": "https://api.github.com/users/josh11b", "html_url": "https://github.com/josh11b", "followers_url": "https://api.github.com/users/josh11b/followers", "following_url": "https://api.github.com/users/josh11b/following{/other_user}", "gists_url": "https://api.github.com/users/josh11b/gists{/gist_id}", "starred_url": "https://api.github.com/users/josh11b/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/josh11b/subscriptions", "organizations_url": "https://api.github.com/users/josh11b/orgs", "repos_url": "https://api.github.com/users/josh11b/repos", "events_url": "https://api.github.com/users/josh11b/events{/privacy}", "received_events_url": "https://api.github.com/users/josh11b/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-11-05T14:49:54Z", "updated_at": "2018-11-23T18:37:40Z", "closed_at": null, "author_association": "NONE", "body_html": "<p><em>Please make sure that this is a bug. As per our <a href=\"https://github.com/tensorflow/tensorflow/blob/master/ISSUES.md\">GitHub Policy</a>, we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template</em></p>\n<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes</li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux 3.10.0-862.9.1.el7.x86_64, CentOS 7.5</li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:</li>\n<li>TensorFlow installed from (source or binary): source</li>\n<li>TensorFlow version (use command below): ('v1.9.0-rc2-2836-g05f8ea8', '1.10.0')</li>\n<li>Python version: 2.7</li>\n<li>Bazel version (if compiling from source): 0.16.1</li>\n<li>GCC/Compiler version (if compiling from source): c++ (GCC) 4.8.5 20150623 (Red Hat 4.8.5-28)</li>\n<li>CUDA/cuDNN version: 9.2.148</li>\n<li>GPU model and memory: 8x GTX 1080 Ti, 11178MiB</li>\n</ul>\n<p><strong>Describe the current behavior</strong><br>\nWhen using tf.contrib.estimator.InMemoryEvaluatorHook together with tf.contrib.distribute.MirroredStrategy on more than 1 GPU I get an error as soon as evaluation starts:<br>\nRuntimeError: Graph is finalized and cannot be modified.</p>\n<p>This does not occur when using OneDeviceStrategy. The documentation of InMemoryEvaluatorHook states: \"It doesn't support multi-node distributed mode.\" However, I am on a single node and multi-GPU</p>\n<p><strong>Describe the expected behavior</strong><br>\nThe error should not occur. If multi-GPU support is not supported yet, will it be in the future? The documentation should also be updated then.</p>\n<p><strong>Code to reproduce the issue</strong><br>\ndistribution = tf.contrib.distribute.MirroredStrategy(num_gpus=2)<br>\nrun_config = tf.estimator.RunConfig(train_distribute=distribution)<br>\nestimator = tf.estimator.Estimator(model.model_fn, config=run_config)<br>\nevaluator = tf.contrib.estimator.InMemoryEvaluatorHook(estimator, eval_input_fn, steps=20, every_n_iter=20)<br>\nestimator.train(train_input_fn, steps=100, hooks=[evaluator])</p>\n<p><strong>Other info / logs</strong><br>\nTraceback (most recent call last):<br>\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd_launcher.py\", line 115, in <br>\nvspd.run(filename, port_num, run_as, *sys.argv[1:])<br>\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/debugger.py\", line 43, in run<br>\nrun_main(address, filename, run_as, *args, **kwargs)<br>\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_local.py\", line 52, in run_main<br>\nrunner(addr, name, kind == 'module', *extra, **kwargs)<br>\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/runner.py\", line 32, in run<br>\nset_trace=False)<br>\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_vendored/pydevd/pydevd.py\", line 1107, in run<br>\nreturn self._exec(is_module, entry_point_fn, module_name, file, globals, locals)<br>\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_vendored/pydevd/pydevd.py\", line 1114, in _exec<br>\npydev_imports.execfile(file, globals, locals)  # execute the script<br>\nFile \"/home/xxx/test/mv_estimator/train.py\", line 91, in <br>\ntf.app.run()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 125, in run<br>\n_sys.exit(main(argv))<br>\nFile \"/home/xxx/test/mv_estimator/train.py\", line 80, in main<br>\nestimator.train(train_input_fn, steps=100, hooks=[evaluator])<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train<br>\nloss = self._train_model(input_fn, hooks, saving_listeners)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1177, in _train_model<br>\nreturn self._train_model_distributed(input_fn, hooks, saving_listeners)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1320, in _train_model_distributed<br>\nsaving_listeners)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1400, in _train_with_estimator_spec<br>\nlog_step_count_steps=self._config.log_step_count_steps) as mon_sess:<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession<br>\nstop_grace_period_secs=stop_grace_period_secs)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 920, in <strong>init</strong><br>\nstop_grace_period_secs=stop_grace_period_secs)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 643, in <strong>init</strong><br>\nself._sess = _RecoverableSession(self._coordinated_creator)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 1106, in <strong>init</strong><br>\n_WrappedSession.<strong>init</strong>(self, self._create_session())<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 1111, in _create_session<br>\nreturn self._sess_creator.create_session()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 806, in create_session<br>\nhook.after_create_session(self.tf_sess, self.coord)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/estimator/python/estimator/hooks.py\", line 178, in after_create_session<br>\nself._evaluate(session)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/estimator/python/estimator/hooks.py\", line 181, in _evaluate<br>\nvar_name_to_value = train_session.run(self._var_name_to_train_var)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 887, in run<br>\nrun_metadata_ptr)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1095, in _run<br>\nself._graph, fetches, feed_dict_tensor, feed_handles=feed_handles)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 429, in <strong>init</strong><br>\nself._fetch_mapper = _FetchMapper.for_fetch(fetches)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 249, in for_fetch<br>\nreturn _DictFetchMapper(fetch)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 387, in <strong>init</strong><br>\n_FetchMapper.for_fetch(fetch) for fetch in fetches.values()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 255, in for_fetch<br>\nreturn _ElementFetchMapper(fetches, contraction_fn)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 284, in <strong>init</strong><br>\nfetch, allow_tensor=True, allow_operation=True))<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3473, in as_graph_element<br>\nreturn self._as_graph_element_locked(obj, allow_tensor, allow_operation)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3496, in _as_graph_element_locked<br>\ntemp_obj = _as_graph_element(obj)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 148, in _as_graph_element<br>\nreturn conv_fn()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/distribute/python/values.py\", line 513, in _as_graph_element<br>\nreturn self._get_cross_tower()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/distribute/python/values.py\", line 505, in _get_cross_tower<br>\ntotal = math_ops.add_n(all_components)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/math_ops.py\", line 2145, in add_n<br>\ninputs = ops.convert_n_to_tensor_or_indexed_slices(inputs)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1355, in convert_n_to_tensor_or_indexed_slices<br>\nvalues=values, dtype=dtype, name=name, as_ref=False)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1326, in internal_convert_n_to_tensor_or_indexed_slices<br>\nvalue, dtype=dtype, name=n, as_ref=as_ref))<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1285, in internal_convert_to_tensor_or_indexed_slices<br>\nvalue, dtype=dtype, name=name, as_ref=as_ref)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1124, in internal_convert_to_tensor<br>\nret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 1258, in _dense_var_to_tensor<br>\nreturn var._dense_var_to_tensor(dtype=dtype, name=name, as_ref=as_ref)  # pylint: disable=protected-access<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 1213, in _dense_var_to_tensor<br>\nreturn self.value()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 647, in value<br>\nreturn self._read_variable_op()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 730, in _read_variable_op<br>\nself._dtype)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/gen_resource_variable_ops.py\", line 508, in read_variable_op<br>\n\"ReadVariableOp\", resource=resource, dtype=dtype, name=name)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper<br>\nop_def=op_def)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func<br>\nreturn func(*args, **kwargs)<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3232, in create_op<br>\nself._check_not_finalized()<br>\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2905, in _check_not_finalized<br>\nraise RuntimeError(\"Graph is finalized and cannot be modified.\")</p>", "body_text": "Please make sure that this is a bug. As per our GitHub Policy, we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux 3.10.0-862.9.1.el7.x86_64, CentOS 7.5\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): ('v1.9.0-rc2-2836-g05f8ea8', '1.10.0')\nPython version: 2.7\nBazel version (if compiling from source): 0.16.1\nGCC/Compiler version (if compiling from source): c++ (GCC) 4.8.5 20150623 (Red Hat 4.8.5-28)\nCUDA/cuDNN version: 9.2.148\nGPU model and memory: 8x GTX 1080 Ti, 11178MiB\n\nDescribe the current behavior\nWhen using tf.contrib.estimator.InMemoryEvaluatorHook together with tf.contrib.distribute.MirroredStrategy on more than 1 GPU I get an error as soon as evaluation starts:\nRuntimeError: Graph is finalized and cannot be modified.\nThis does not occur when using OneDeviceStrategy. The documentation of InMemoryEvaluatorHook states: \"It doesn't support multi-node distributed mode.\" However, I am on a single node and multi-GPU\nDescribe the expected behavior\nThe error should not occur. If multi-GPU support is not supported yet, will it be in the future? The documentation should also be updated then.\nCode to reproduce the issue\ndistribution = tf.contrib.distribute.MirroredStrategy(num_gpus=2)\nrun_config = tf.estimator.RunConfig(train_distribute=distribution)\nestimator = tf.estimator.Estimator(model.model_fn, config=run_config)\nevaluator = tf.contrib.estimator.InMemoryEvaluatorHook(estimator, eval_input_fn, steps=20, every_n_iter=20)\nestimator.train(train_input_fn, steps=100, hooks=[evaluator])\nOther info / logs\nTraceback (most recent call last):\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd_launcher.py\", line 115, in \nvspd.run(filename, port_num, run_as, *sys.argv[1:])\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/debugger.py\", line 43, in run\nrun_main(address, filename, run_as, *args, **kwargs)\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_local.py\", line 52, in run_main\nrunner(addr, name, kind == 'module', *extra, **kwargs)\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/runner.py\", line 32, in run\nset_trace=False)\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_vendored/pydevd/pydevd.py\", line 1107, in run\nreturn self._exec(is_module, entry_point_fn, module_name, file, globals, locals)\nFile \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_vendored/pydevd/pydevd.py\", line 1114, in _exec\npydev_imports.execfile(file, globals, locals)  # execute the script\nFile \"/home/xxx/test/mv_estimator/train.py\", line 91, in \ntf.app.run()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 125, in run\n_sys.exit(main(argv))\nFile \"/home/xxx/test/mv_estimator/train.py\", line 80, in main\nestimator.train(train_input_fn, steps=100, hooks=[evaluator])\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\nloss = self._train_model(input_fn, hooks, saving_listeners)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1177, in _train_model\nreturn self._train_model_distributed(input_fn, hooks, saving_listeners)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1320, in _train_model_distributed\nsaving_listeners)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1400, in _train_with_estimator_spec\nlog_step_count_steps=self._config.log_step_count_steps) as mon_sess:\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession\nstop_grace_period_secs=stop_grace_period_secs)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 920, in init\nstop_grace_period_secs=stop_grace_period_secs)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 643, in init\nself._sess = _RecoverableSession(self._coordinated_creator)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 1106, in init\n_WrappedSession.init(self, self._create_session())\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 1111, in _create_session\nreturn self._sess_creator.create_session()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 806, in create_session\nhook.after_create_session(self.tf_sess, self.coord)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/estimator/python/estimator/hooks.py\", line 178, in after_create_session\nself._evaluate(session)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/estimator/python/estimator/hooks.py\", line 181, in _evaluate\nvar_name_to_value = train_session.run(self._var_name_to_train_var)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 887, in run\nrun_metadata_ptr)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1095, in _run\nself._graph, fetches, feed_dict_tensor, feed_handles=feed_handles)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 429, in init\nself._fetch_mapper = _FetchMapper.for_fetch(fetches)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 249, in for_fetch\nreturn _DictFetchMapper(fetch)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 387, in init\n_FetchMapper.for_fetch(fetch) for fetch in fetches.values()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 255, in for_fetch\nreturn _ElementFetchMapper(fetches, contraction_fn)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 284, in init\nfetch, allow_tensor=True, allow_operation=True))\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3473, in as_graph_element\nreturn self._as_graph_element_locked(obj, allow_tensor, allow_operation)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3496, in _as_graph_element_locked\ntemp_obj = _as_graph_element(obj)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 148, in _as_graph_element\nreturn conv_fn()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/distribute/python/values.py\", line 513, in _as_graph_element\nreturn self._get_cross_tower()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/distribute/python/values.py\", line 505, in _get_cross_tower\ntotal = math_ops.add_n(all_components)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/math_ops.py\", line 2145, in add_n\ninputs = ops.convert_n_to_tensor_or_indexed_slices(inputs)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1355, in convert_n_to_tensor_or_indexed_slices\nvalues=values, dtype=dtype, name=name, as_ref=False)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1326, in internal_convert_n_to_tensor_or_indexed_slices\nvalue, dtype=dtype, name=n, as_ref=as_ref))\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1285, in internal_convert_to_tensor_or_indexed_slices\nvalue, dtype=dtype, name=name, as_ref=as_ref)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1124, in internal_convert_to_tensor\nret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 1258, in _dense_var_to_tensor\nreturn var._dense_var_to_tensor(dtype=dtype, name=name, as_ref=as_ref)  # pylint: disable=protected-access\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 1213, in _dense_var_to_tensor\nreturn self.value()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 647, in value\nreturn self._read_variable_op()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 730, in _read_variable_op\nself._dtype)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/gen_resource_variable_ops.py\", line 508, in read_variable_op\n\"ReadVariableOp\", resource=resource, dtype=dtype, name=name)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\nop_def=op_def)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\nreturn func(*args, **kwargs)\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3232, in create_op\nself._check_not_finalized()\nFile \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2905, in _check_not_finalized\nraise RuntimeError(\"Graph is finalized and cannot be modified.\")", "body": "<em>Please make sure that this is a bug. As per our [GitHub Policy](https://github.com/tensorflow/tensorflow/blob/master/ISSUES.md), we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template</em>\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux 3.10.0-862.9.1.el7.x86_64, CentOS 7.5\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\r\n- TensorFlow installed from (source or binary): source\r\n- TensorFlow version (use command below): ('v1.9.0-rc2-2836-g05f8ea8', '1.10.0')\r\n- Python version: 2.7\r\n- Bazel version (if compiling from source): 0.16.1\r\n- GCC/Compiler version (if compiling from source): c++ (GCC) 4.8.5 20150623 (Red Hat 4.8.5-28)\r\n- CUDA/cuDNN version: 9.2.148\r\n- GPU model and memory: 8x GTX 1080 Ti, 11178MiB\r\n\r\n**Describe the current behavior**\r\nWhen using tf.contrib.estimator.InMemoryEvaluatorHook together with tf.contrib.distribute.MirroredStrategy on more than 1 GPU I get an error as soon as evaluation starts:\r\nRuntimeError: Graph is finalized and cannot be modified.\r\n\r\nThis does not occur when using OneDeviceStrategy. The documentation of InMemoryEvaluatorHook states: \"It doesn't support multi-node distributed mode.\" However, I am on a single node and multi-GPU\r\n\r\n**Describe the expected behavior**\r\nThe error should not occur. If multi-GPU support is not supported yet, will it be in the future? The documentation should also be updated then.\r\n\r\n**Code to reproduce the issue**\r\ndistribution = tf.contrib.distribute.MirroredStrategy(num_gpus=2)\r\nrun_config = tf.estimator.RunConfig(train_distribute=distribution)\r\nestimator = tf.estimator.Estimator(model.model_fn, config=run_config)\r\nevaluator = tf.contrib.estimator.InMemoryEvaluatorHook(estimator, eval_input_fn, steps=20, every_n_iter=20)\r\nestimator.train(train_input_fn, steps=100, hooks=[evaluator])\r\n\r\n**Other info / logs**\r\nTraceback (most recent call last):\r\n  File \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd_launcher.py\", line 115, in <module>\r\n    vspd.run(filename, port_num, run_as, *sys.argv[1:])\r\n  File \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/debugger.py\", line 43, in run\r\n    run_main(address, filename, run_as, *args, **kwargs)\r\n  File \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_local.py\", line 52, in run_main\r\n    runner(addr, name, kind == 'module', *extra, **kwargs)\r\n  File \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/runner.py\", line 32, in run\r\n    set_trace=False)\r\n  File \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_vendored/pydevd/pydevd.py\", line 1107, in run\r\n    return self._exec(is_module, entry_point_fn, module_name, file, globals, locals)\r\n  File \"/home/xxx/.vscode/extensions/ms-python.python-2018.9.2/pythonFiles/experimental/ptvsd/ptvsd/_vendored/pydevd/pydevd.py\", line 1114, in _exec\r\n    pydev_imports.execfile(file, globals, locals)  # execute the script\r\n  File \"/home/xxx/test/mv_estimator/train.py\", line 91, in <module>\r\n    tf.app.run()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 125, in run\r\n    _sys.exit(main(argv))\r\n  File \"/home/xxx/test/mv_estimator/train.py\", line 80, in main\r\n    estimator.train(train_input_fn, steps=100, hooks=[evaluator])\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1177, in _train_model\r\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1320, in _train_model_distributed\r\n    saving_listeners)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1400, in _train_with_estimator_spec\r\n    log_step_count_steps=self._config.log_step_count_steps) as mon_sess:\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession\r\n    stop_grace_period_secs=stop_grace_period_secs)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 920, in __init__\r\n    stop_grace_period_secs=stop_grace_period_secs)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 643, in __init__\r\n    self._sess = _RecoverableSession(self._coordinated_creator)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 1106, in __init__\r\n    _WrappedSession.__init__(self, self._create_session())\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 1111, in _create_session\r\n    return self._sess_creator.create_session()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/training/monitored_session.py\", line 806, in create_session\r\n    hook.after_create_session(self.tf_sess, self.coord)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/estimator/python/estimator/hooks.py\", line 178, in after_create_session\r\n    self._evaluate(session)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/estimator/python/estimator/hooks.py\", line 181, in _evaluate\r\n    var_name_to_value = train_session.run(self._var_name_to_train_var)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 887, in run\r\n    run_metadata_ptr)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1095, in _run\r\n    self._graph, fetches, feed_dict_tensor, feed_handles=feed_handles)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 429, in __init__\r\n    self._fetch_mapper = _FetchMapper.for_fetch(fetches)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 249, in for_fetch\r\n    return _DictFetchMapper(fetch)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 387, in __init__\r\n    _FetchMapper.for_fetch(fetch) for fetch in fetches.values()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 255, in for_fetch\r\n    return _ElementFetchMapper(fetches, contraction_fn)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 284, in __init__\r\n    fetch, allow_tensor=True, allow_operation=True))\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3473, in as_graph_element\r\n    return self._as_graph_element_locked(obj, allow_tensor, allow_operation)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3496, in _as_graph_element_locked\r\n    temp_obj = _as_graph_element(obj)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 148, in _as_graph_element\r\n    return conv_fn()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/distribute/python/values.py\", line 513, in _as_graph_element\r\n    return self._get_cross_tower()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/contrib/distribute/python/values.py\", line 505, in _get_cross_tower\r\n    total = math_ops.add_n(all_components)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/math_ops.py\", line 2145, in add_n\r\n    inputs = ops.convert_n_to_tensor_or_indexed_slices(inputs)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1355, in convert_n_to_tensor_or_indexed_slices\r\n    values=values, dtype=dtype, name=name, as_ref=False)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1326, in internal_convert_n_to_tensor_or_indexed_slices\r\n    value, dtype=dtype, name=n, as_ref=as_ref))\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1285, in internal_convert_to_tensor_or_indexed_slices\r\n    value, dtype=dtype, name=name, as_ref=as_ref)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1124, in internal_convert_to_tensor\r\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 1258, in _dense_var_to_tensor\r\n    return var._dense_var_to_tensor(dtype=dtype, name=name, as_ref=as_ref)  # pylint: disable=protected-access\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 1213, in _dense_var_to_tensor\r\n    return self.value()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 647, in value\r\n    return self._read_variable_op()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 730, in _read_variable_op\r\n    self._dtype)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/ops/gen_resource_variable_ops.py\", line 508, in read_variable_op\r\n    \"ReadVariableOp\", resource=resource, dtype=dtype, name=name)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3232, in create_op\r\n    self._check_not_finalized()\r\n  File \"/home/xxx/.local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2905, in _check_not_finalized\r\n    raise RuntimeError(\"Graph is finalized and cannot be modified.\")\r\n"}