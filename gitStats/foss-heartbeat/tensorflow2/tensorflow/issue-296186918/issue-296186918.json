{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16933", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16933/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16933/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16933/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/16933", "id": 296186918, "node_id": "MDU6SXNzdWUyOTYxODY5MTg=", "number": 16933, "title": "Converting numpy array to TFRecord is slow", "user": {"login": "lxkarthi", "id": 6488848, "node_id": "MDQ6VXNlcjY0ODg4NDg=", "avatar_url": "https://avatars3.githubusercontent.com/u/6488848?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lxkarthi", "html_url": "https://github.com/lxkarthi", "followers_url": "https://api.github.com/users/lxkarthi/followers", "following_url": "https://api.github.com/users/lxkarthi/following{/other_user}", "gists_url": "https://api.github.com/users/lxkarthi/gists{/gist_id}", "starred_url": "https://api.github.com/users/lxkarthi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lxkarthi/subscriptions", "organizations_url": "https://api.github.com/users/lxkarthi/orgs", "repos_url": "https://api.github.com/users/lxkarthi/repos", "events_url": "https://api.github.com/users/lxkarthi/events{/privacy}", "received_events_url": "https://api.github.com/users/lxkarthi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "shivaniag", "id": 16565716, "node_id": "MDQ6VXNlcjE2NTY1NzE2", "avatar_url": "https://avatars1.githubusercontent.com/u/16565716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shivaniag", "html_url": "https://github.com/shivaniag", "followers_url": "https://api.github.com/users/shivaniag/followers", "following_url": "https://api.github.com/users/shivaniag/following{/other_user}", "gists_url": "https://api.github.com/users/shivaniag/gists{/gist_id}", "starred_url": "https://api.github.com/users/shivaniag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shivaniag/subscriptions", "organizations_url": "https://api.github.com/users/shivaniag/orgs", "repos_url": "https://api.github.com/users/shivaniag/repos", "events_url": "https://api.github.com/users/shivaniag/events{/privacy}", "received_events_url": "https://api.github.com/users/shivaniag/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "shivaniag", "id": 16565716, "node_id": "MDQ6VXNlcjE2NTY1NzE2", "avatar_url": "https://avatars1.githubusercontent.com/u/16565716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shivaniag", "html_url": "https://github.com/shivaniag", "followers_url": "https://api.github.com/users/shivaniag/followers", "following_url": "https://api.github.com/users/shivaniag/following{/other_user}", "gists_url": "https://api.github.com/users/shivaniag/gists{/gist_id}", "starred_url": "https://api.github.com/users/shivaniag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shivaniag/subscriptions", "organizations_url": "https://api.github.com/users/shivaniag/orgs", "repos_url": "https://api.github.com/users/shivaniag/repos", "events_url": "https://api.github.com/users/shivaniag/events{/privacy}", "received_events_url": "https://api.github.com/users/shivaniag/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 8, "created_at": "2018-02-11T12:38:19Z", "updated_at": "2018-06-02T07:19:13Z", "closed_at": "2018-06-02T07:06:31Z", "author_association": "NONE", "body_html": "<h3>FloatList and Feature is slow for numpy array.</h3>\n<p>Saving numpy arrays with np.load and np.save is much faster than Converting to TFRecord and reading it back.<br>\nwhile profiling the code, I found that half of the time is spent in _floats_feature.<br>\ntf.train.FloatList is taking 1/3 of the time.<br>\nHow to speed this up?</p>\n<h3>System information</h3>\n<ul>\n<li><strong>Below snippet of code to convert numpy array is much slow compared  np.save, np.load</strong>:</li>\n<li>**OS Platform and Distribution: Linux Ubuntu 16.04</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.4.0</li>\n<li><strong>Python version</strong>: 2.7.12</li>\n</ul>\n<h3>Source code / logs</h3>\n<pre><code>import tensorflow as tf\nimport numpy as np\n\n\n\ndef floatme(value):\n    return tf.train.FloatList(value=value)\n\ndef _floats_feature(value):\n    return tf.train.Feature(float_list=floatme(value))\n\ntfr_filename = \"deleteme.tfr\"\ndata = [\" \".join(np.random.randint(0, 1000, size=4005).astype(str)) for i in range(10000)]\nwith tf.python_io.TFRecordWriter(tfr_filename) as writer:\n    print('Converting to vectors')\n    vectors = [np.fromstring(line, dtype=int, sep=' ', count=4004+1) for line in data]\n    print('Converting to examples')\n    for i, vec in enumerate(vectors):\n        # Create an example protocol buffer\n        example = tf.train.Example(features=tf.train.Features(feature={\n            'label': _floats_feature([vec[4004], vec[4004]&lt;1.0]),\n            'data' : _floats_feature(vec[:4004]),\n            }))\n        writer.write(example.SerializeToString())\n\n\n</code></pre>\n<table>\n<thead>\n<tr>\n<th>ncalls</th>\n<th>tottime</th>\n<th>percall</th>\n<th>cumtime</th>\n<th>percall</th>\n<th>filename:lineno(function)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>232810</td>\n<td>49.887</td>\n<td>0</td>\n<td>49.887</td>\n<td>0</td>\n<td>convert_train_dataset_tfrecord.py:76(floatme)</td>\n</tr>\n<tr>\n<td>116405</td>\n<td>20.095</td>\n<td>0</td>\n<td>20.095</td>\n<td>0</td>\n<td>{numpy.core.multiarray.fromstring}</td>\n</tr>\n<tr>\n<td>232810</td>\n<td>13.328</td>\n<td>0</td>\n<td>63.216</td>\n<td>0</td>\n<td>convert_train_dataset_tfrecord.py:79(_floats_feature)</td>\n</tr>\n</tbody>\n</table>", "body_text": "FloatList and Feature is slow for numpy array.\nSaving numpy arrays with np.load and np.save is much faster than Converting to TFRecord and reading it back.\nwhile profiling the code, I found that half of the time is spent in _floats_feature.\ntf.train.FloatList is taking 1/3 of the time.\nHow to speed this up?\nSystem information\n\nBelow snippet of code to convert numpy array is much slow compared  np.save, np.load:\n**OS Platform and Distribution: Linux Ubuntu 16.04\nTensorFlow version (use command below): 1.4.0\nPython version: 2.7.12\n\nSource code / logs\nimport tensorflow as tf\nimport numpy as np\n\n\n\ndef floatme(value):\n    return tf.train.FloatList(value=value)\n\ndef _floats_feature(value):\n    return tf.train.Feature(float_list=floatme(value))\n\ntfr_filename = \"deleteme.tfr\"\ndata = [\" \".join(np.random.randint(0, 1000, size=4005).astype(str)) for i in range(10000)]\nwith tf.python_io.TFRecordWriter(tfr_filename) as writer:\n    print('Converting to vectors')\n    vectors = [np.fromstring(line, dtype=int, sep=' ', count=4004+1) for line in data]\n    print('Converting to examples')\n    for i, vec in enumerate(vectors):\n        # Create an example protocol buffer\n        example = tf.train.Example(features=tf.train.Features(feature={\n            'label': _floats_feature([vec[4004], vec[4004]<1.0]),\n            'data' : _floats_feature(vec[:4004]),\n            }))\n        writer.write(example.SerializeToString())\n\n\n\n\n\n\nncalls\ntottime\npercall\ncumtime\npercall\nfilename:lineno(function)\n\n\n\n\n232810\n49.887\n0\n49.887\n0\nconvert_train_dataset_tfrecord.py:76(floatme)\n\n\n116405\n20.095\n0\n20.095\n0\n{numpy.core.multiarray.fromstring}\n\n\n232810\n13.328\n0\n63.216\n0\nconvert_train_dataset_tfrecord.py:79(_floats_feature)", "body": "### FloatList and Feature is slow for numpy array.\r\nSaving numpy arrays with np.load and np.save is much faster than Converting to TFRecord and reading it back.\r\nwhile profiling the code, I found that half of the time is spent in _floats_feature.\r\ntf.train.FloatList is taking 1/3 of the time.\r\nHow to speed this up? \r\n\r\n### System information\r\n- **Below snippet of code to convert numpy array is much slow compared  np.save, np.load**:\r\n- **OS Platform and Distribution: Linux Ubuntu 16.04\r\n- **TensorFlow version (use command below)**: 1.4.0\r\n- **Python version**: 2.7.12\r\n\r\n\r\n### Source code / logs\r\n\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\n\r\n\r\n\r\ndef floatme(value):\r\n    return tf.train.FloatList(value=value)\r\n\r\ndef _floats_feature(value):\r\n    return tf.train.Feature(float_list=floatme(value))\r\n\r\ntfr_filename = \"deleteme.tfr\"\r\ndata = [\" \".join(np.random.randint(0, 1000, size=4005).astype(str)) for i in range(10000)]\r\nwith tf.python_io.TFRecordWriter(tfr_filename) as writer:\r\n    print('Converting to vectors')\r\n    vectors = [np.fromstring(line, dtype=int, sep=' ', count=4004+1) for line in data]\r\n    print('Converting to examples')\r\n    for i, vec in enumerate(vectors):\r\n        # Create an example protocol buffer\r\n        example = tf.train.Example(features=tf.train.Features(feature={\r\n            'label': _floats_feature([vec[4004], vec[4004]<1.0]),\r\n            'data' : _floats_feature(vec[:4004]),\r\n            }))\r\n        writer.write(example.SerializeToString())\r\n\r\n\r\n```\r\n\r\n\r\nncalls | tottime | percall | cumtime | percall | filename:lineno(function)\r\n-- | -- | -- | -- | -- | --\r\n232810 | 49.887 | 0 | 49.887 | 0 | convert_train_dataset_tfrecord.py:76(floatme)\r\n116405 | 20.095 | 0 | 20.095 | 0 | {numpy.core.multiarray.fromstring}\r\n232810 | 13.328 | 0 | 63.216 | 0 | convert_train_dataset_tfrecord.py:79(_floats_feature)\r\n\r\n"}