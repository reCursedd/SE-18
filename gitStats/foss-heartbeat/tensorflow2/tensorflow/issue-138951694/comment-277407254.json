{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/277407254", "html_url": "https://github.com/tensorflow/tensorflow/issues/1419#issuecomment-277407254", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/1419", "id": 277407254, "node_id": "MDEyOklzc3VlQ29tbWVudDI3NzQwNzI1NA==", "user": {"login": "jkiske", "id": 1057200, "node_id": "MDQ6VXNlcjEwNTcyMDA=", "avatar_url": "https://avatars0.githubusercontent.com/u/1057200?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jkiske", "html_url": "https://github.com/jkiske", "followers_url": "https://api.github.com/users/jkiske/followers", "following_url": "https://api.github.com/users/jkiske/following{/other_user}", "gists_url": "https://api.github.com/users/jkiske/gists{/gist_id}", "starred_url": "https://api.github.com/users/jkiske/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jkiske/subscriptions", "organizations_url": "https://api.github.com/users/jkiske/orgs", "repos_url": "https://api.github.com/users/jkiske/repos", "events_url": "https://api.github.com/users/jkiske/events{/privacy}", "received_events_url": "https://api.github.com/users/jkiske/received_events", "type": "User", "site_admin": false}, "created_at": "2017-02-04T01:33:46Z", "updated_at": "2017-02-04T01:33:46Z", "author_association": "NONE", "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=25468229\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/crjensen21\">@crjensen21</a> &amp; <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=23068\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/yaroslavvb\">@yaroslavvb</a> I am having the same issue. Patching with below allows compilation into a shared library, but seg faults after any program that loads the library (with <code>tf.load_op_library</code>) finishes.</p>\n<pre>diff --git a/tensorflow/tensorflow.bzl b/tensorflow/tensorflow.bzl\nindex d78cb7b57..7d0d5ae9a 100644\n--- a/tensorflow/tensorflow.bzl\n+++ b/tensorflow/tensorflow.bzl\n@@ -774,8 +774,9 @@ def tf_custom_op_library(name, srcs=[], gpu_srcs=[], deps=[]):\n \n   check_deps(name=name+\"_check_deps\",\n              deps=deps + if_cuda(cuda_deps),\n-             disallowed_deps=[\"//tensorflow/core:framework\",\n-                              \"//tensorflow/core:lib\"])\n+              disallowed_deps=[])\n+#            disallowed_deps=[\"//tensorflow/core:framework\",\n+#                             \"//tensorflow/core:lib\"])\n</pre>\n<p>Segfault backtrace:</p>\n<pre>Program received signal SIGSEGV, Segmentation fault.\nmalloc_consolidate (av=av@entry=0x7ffff7bb5760 ) at malloc.c:4151\n4151\tmalloc.c: No such file or directory.\n(gdb) bt\n#0  malloc_consolidate (av=av@entry=0x7ffff7bb5760 ) at malloc.c:4151\n#1  0x00007ffff7876ce8 in _int_malloc (av=av@entry=0x7ffff7bb5760 , bytes=bytes@entry=1256) at malloc.c:3423\n#2  0x00007ffff787a1dc in __libc_calloc (n=, elem_size=) at malloc.c:3219\n#3  0x00007fffb8b00361 in ?? () from /usr/local/cuda/lib64/libcudnn.so\n#4  0x00007fffb8b00477 in ?? () from /usr/local/cuda/lib64/libcudnn.so\n#5  0x00007ffff78331a9 in __run_exit_handlers (status=0, listp=0x7ffff7bb56c8 &lt;__exit_funcs&gt;, run_list_atexit=run_list_atexit@entry=true) at exit.c:82\n#6  0x00007ffff78331f5 in __GI_exit (status=) at exit.c:104\n#7  0x00007ffff7818f4c in __libc_start_main (main=0x466e50 , argc=2, argv=0x7fffffffdf58, init=, fini=, rtld_fini=, \n    stack_end=0x7fffffffdf48) at libc-start.c:321\n#8  0x0000000000577c2e in _start ()\n</pre>\n<p>Hopefully <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=229914\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/keveman\">@keveman</a> can help.</p>", "body_text": "@crjensen21 & @yaroslavvb I am having the same issue. Patching with below allows compilation into a shared library, but seg faults after any program that loads the library (with tf.load_op_library) finishes.\ndiff --git a/tensorflow/tensorflow.bzl b/tensorflow/tensorflow.bzl\nindex d78cb7b57..7d0d5ae9a 100644\n--- a/tensorflow/tensorflow.bzl\n+++ b/tensorflow/tensorflow.bzl\n@@ -774,8 +774,9 @@ def tf_custom_op_library(name, srcs=[], gpu_srcs=[], deps=[]):\n \n   check_deps(name=name+\"_check_deps\",\n              deps=deps + if_cuda(cuda_deps),\n-             disallowed_deps=[\"//tensorflow/core:framework\",\n-                              \"//tensorflow/core:lib\"])\n+              disallowed_deps=[])\n+#            disallowed_deps=[\"//tensorflow/core:framework\",\n+#                             \"//tensorflow/core:lib\"])\n\nSegfault backtrace:\nProgram received signal SIGSEGV, Segmentation fault.\nmalloc_consolidate (av=av@entry=0x7ffff7bb5760 ) at malloc.c:4151\n4151\tmalloc.c: No such file or directory.\n(gdb) bt\n#0  malloc_consolidate (av=av@entry=0x7ffff7bb5760 ) at malloc.c:4151\n#1  0x00007ffff7876ce8 in _int_malloc (av=av@entry=0x7ffff7bb5760 , bytes=bytes@entry=1256) at malloc.c:3423\n#2  0x00007ffff787a1dc in __libc_calloc (n=, elem_size=) at malloc.c:3219\n#3  0x00007fffb8b00361 in ?? () from /usr/local/cuda/lib64/libcudnn.so\n#4  0x00007fffb8b00477 in ?? () from /usr/local/cuda/lib64/libcudnn.so\n#5  0x00007ffff78331a9 in __run_exit_handlers (status=0, listp=0x7ffff7bb56c8 <__exit_funcs>, run_list_atexit=run_list_atexit@entry=true) at exit.c:82\n#6  0x00007ffff78331f5 in __GI_exit (status=) at exit.c:104\n#7  0x00007ffff7818f4c in __libc_start_main (main=0x466e50 , argc=2, argv=0x7fffffffdf58, init=, fini=, rtld_fini=, \n    stack_end=0x7fffffffdf48) at libc-start.c:321\n#8  0x0000000000577c2e in _start ()\n\nHopefully @keveman can help.", "body": "@crjensen21 & @yaroslavvb I am having the same issue. Patching with below allows compilation into a shared library, but seg faults after any program that loads the library (with `tf.load_op_library`) finishes.\r\n\r\n<pre>\r\ndiff --git a/tensorflow/tensorflow.bzl b/tensorflow/tensorflow.bzl\r\nindex d78cb7b57..7d0d5ae9a 100644\r\n--- a/tensorflow/tensorflow.bzl\r\n+++ b/tensorflow/tensorflow.bzl\r\n@@ -774,8 +774,9 @@ def tf_custom_op_library(name, srcs=[], gpu_srcs=[], deps=[]):\r\n \r\n   check_deps(name=name+\"_check_deps\",\r\n              deps=deps + if_cuda(cuda_deps),\r\n-             disallowed_deps=[\"//tensorflow/core:framework\",\r\n-                              \"//tensorflow/core:lib\"])\r\n+              disallowed_deps=[])\r\n+#            disallowed_deps=[\"//tensorflow/core:framework\",\r\n+#                             \"//tensorflow/core:lib\"])\r\n</pre>\r\n\r\nSegfault backtrace:\r\n<pre>\r\nProgram received signal SIGSEGV, Segmentation fault.\r\nmalloc_consolidate (av=av@entry=0x7ffff7bb5760 <main_arena>) at malloc.c:4151\r\n4151\tmalloc.c: No such file or directory.\r\n(gdb) bt\r\n#0  malloc_consolidate (av=av@entry=0x7ffff7bb5760 <main_arena>) at malloc.c:4151\r\n#1  0x00007ffff7876ce8 in _int_malloc (av=av@entry=0x7ffff7bb5760 <main_arena>, bytes=bytes@entry=1256) at malloc.c:3423\r\n#2  0x00007ffff787a1dc in __libc_calloc (n=<optimized out>, elem_size=<optimized out>) at malloc.c:3219\r\n#3  0x00007fffb8b00361 in ?? () from /usr/local/cuda/lib64/libcudnn.so\r\n#4  0x00007fffb8b00477 in ?? () from /usr/local/cuda/lib64/libcudnn.so\r\n#5  0x00007ffff78331a9 in __run_exit_handlers (status=0, listp=0x7ffff7bb56c8 <__exit_funcs>, run_list_atexit=run_list_atexit@entry=true) at exit.c:82\r\n#6  0x00007ffff78331f5 in __GI_exit (status=<optimized out>) at exit.c:104\r\n#7  0x00007ffff7818f4c in __libc_start_main (main=0x466e50 <main>, argc=2, argv=0x7fffffffdf58, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, \r\n    stack_end=0x7fffffffdf48) at libc-start.c:321\r\n#8  0x0000000000577c2e in _start ()\r\n</pre>\r\n\r\nHopefully @keveman can help."}