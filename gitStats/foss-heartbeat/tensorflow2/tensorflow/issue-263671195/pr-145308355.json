{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13557", "id": 145308355, "node_id": "MDExOlB1bGxSZXF1ZXN0MTQ1MzA4MzU1", "html_url": "https://github.com/tensorflow/tensorflow/pull/13557", "diff_url": "https://github.com/tensorflow/tensorflow/pull/13557.diff", "patch_url": "https://github.com/tensorflow/tensorflow/pull/13557.patch", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13557", "number": 13557, "state": "open", "locked": false, "title": "Fix the gradient computation of dynamic stitch.", "user": {"login": "codrut3", "id": 10788581, "node_id": "MDQ6VXNlcjEwNzg4NTgx", "avatar_url": "https://avatars1.githubusercontent.com/u/10788581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/codrut3", "html_url": "https://github.com/codrut3", "followers_url": "https://api.github.com/users/codrut3/followers", "following_url": "https://api.github.com/users/codrut3/following{/other_user}", "gists_url": "https://api.github.com/users/codrut3/gists{/gist_id}", "starred_url": "https://api.github.com/users/codrut3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/codrut3/subscriptions", "organizations_url": "https://api.github.com/users/codrut3/orgs", "repos_url": "https://api.github.com/users/codrut3/repos", "events_url": "https://api.github.com/users/codrut3/events{/privacy}", "received_events_url": "https://api.github.com/users/codrut3/received_events", "type": "User", "site_admin": false}, "body": "Currently the gradient of tf.dynamic_stitch is not correct for duplicated indices. This is\r\nissue #7397. @drasmuss submitted a pull request for this issue, but it was ultimately not merged\r\ndue to a performance drop.\r\n\r\nWhile working on this, I realised that the problem is more complicated than what follows\r\nfrom the discussion in #7487. In fact, the solution proposed in #7487 is not correct, because\r\none can have duplicated indices in the same input tensor. The following example shows this:\r\n\r\n```\r\nimport tensorflow as tf\r\n\r\nx = tf.zeros((3,))\r\ny = tf.dynamic_stitch([[0, 1, 0]], [x])\r\n\r\nwith tf.Session() as sess:\r\n    print(\"y\")\r\n    print(sess.run(y))\r\n\r\n    analytic, numeric = tf.test.compute_gradient(x, (3,), y, (2,))\r\n    print(\"analytic\")\r\n    print(analytic)\r\n    print(\"numeric\")\r\n    print(numeric)\r\n```\r\n\r\nThe output (even with #7487) is\r\n\r\n```\r\ny\r\n[ 0.  0.]\r\nanalytic\r\n[[ 1.  0.]\r\n [ 0.  1.]\r\n [ 1.  0.]]\r\nnumeric\r\n[[ 0.          0.        ]\r\n [ 0.          0.99998707]\r\n [ 0.99998707  0.        ]]\r\n```\r\n\r\nMy fix is to add a new kernel op `GatherDisjoint`, that can handle all the inputs together.\r\nThis replaces the `n` calls to `gather` in `data_flow_grad._DynamicStitchGrads` with a\r\nsingle `gather_disjoint`.\r\n\r\nThe implementation is very similar to `gather`, I just zero out duplicated slices at the end.\r\nI've put this op in core/, if you would like I can move it to contrib/, just let me know where.\r\n\r\nI've also added tests for the op and new tests for the gradient of dynamic stitch. Here\r\nI inspired myself from @drasmuss pull request.\r\n\r\nI've run the script by @drasmuss again:\r\n\r\n```\r\nimport time\r\n\r\nimport numpy as np\r\nimport tensorflow as tf\r\n\r\nstitch_size = 1000\r\nn_inputs = 10\r\ninput_shape = (100, 50, 50)\r\nreps = 10\r\n\r\nwith tf.device(\"cpu:0\"):\r\n    idxs = [tf.constant(np.random.randint(stitch_size, size=input_shape[0]), dtype=tf.int32)\r\n            for _ in range(n_inputs)]\r\n    vals = [tf.constant(np.random.uniform(-1, 1, size=input_shape), dtype=tf.float32)\r\n            for _ in range(n_inputs)]\r\n    y = tf.dynamic_stitch(idxs, vals)\r\n    grad = tf.gradients(y, vals)\r\n\r\ntotal_time = 0.0\r\nfor _ in range(reps):\r\n    with tf.Session() as sess:\r\n        start = time.time()\r\n        sess.run(grad)\r\n        total_time += time.time() - start\r\n\r\nprint(total_time / reps)\r\n```\r\n\r\nThe results are as follows:\r\nwith my fix:\r\nCPU - 0.09455678462982178\r\nGPU - 0.09739606380462647\r\nwithout my fix:\r\nCPU - 0.11728813648223876\r\nGPU - 0.11805038452148438\r\n\r\nSo with the fix it runs faster. On GPU the slowdown is due to the memory copies from host to device\r\nand back, for input and output (I've checked with nvprof), and not because of my fix.\r\n\r\nI've run this script using local builds of the same master branch, with and without my patch.\r\n\r\nLet me know if the op should be moved somewhere else, or it should be made hidden.", "created_at": "2017-10-07T20:50:05Z", "updated_at": "2018-11-22T18:52:28Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "836a3b7147aa00a4e00d6893dd2f093c32467f85", "assignee": {"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [{"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}], "requested_teams": [], "labels": [{"id": 390482148, "node_id": "MDU6TGFiZWwzOTA0ODIxNDg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/awaiting%20review", "name": "awaiting review", "color": "fef2c0", "default": false}, {"id": 300136587, "node_id": "MDU6TGFiZWwzMDAxMzY1ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/cla:%20yes", "name": "cla: yes", "color": "009800", "default": false}], "milestone": null, "commits_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13557/commits", "review_comments_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13557/comments", "review_comment_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13557/comments", "statuses_url": "https://api.github.com/repos/tensorflow/tensorflow/statuses/3dceceb3fce6a20e1a03f4f07e26aa96fd05fdf7", "head": {"label": "codrut3:dynamic_stitch_fix_grad", "ref": "dynamic_stitch_fix_grad", "sha": "3dceceb3fce6a20e1a03f4f07e26aa96fd05fdf7", "user": {"login": "codrut3", "id": 10788581, "node_id": "MDQ6VXNlcjEwNzg4NTgx", "avatar_url": "https://avatars1.githubusercontent.com/u/10788581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/codrut3", "html_url": "https://github.com/codrut3", "followers_url": "https://api.github.com/users/codrut3/followers", "following_url": "https://api.github.com/users/codrut3/following{/other_user}", "gists_url": "https://api.github.com/users/codrut3/gists{/gist_id}", "starred_url": "https://api.github.com/users/codrut3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/codrut3/subscriptions", "organizations_url": "https://api.github.com/users/codrut3/orgs", "repos_url": "https://api.github.com/users/codrut3/repos", "events_url": "https://api.github.com/users/codrut3/events{/privacy}", "received_events_url": "https://api.github.com/users/codrut3/received_events", "type": "User", "site_admin": false}, "repo": {"id": 87010172, "node_id": "MDEwOlJlcG9zaXRvcnk4NzAxMDE3Mg==", "name": "tensorflow", "full_name": "codrut3/tensorflow", "private": false, "owner": {"login": "codrut3", "id": 10788581, "node_id": "MDQ6VXNlcjEwNzg4NTgx", "avatar_url": "https://avatars1.githubusercontent.com/u/10788581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/codrut3", "html_url": "https://github.com/codrut3", "followers_url": "https://api.github.com/users/codrut3/followers", "following_url": "https://api.github.com/users/codrut3/following{/other_user}", "gists_url": "https://api.github.com/users/codrut3/gists{/gist_id}", "starred_url": "https://api.github.com/users/codrut3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/codrut3/subscriptions", "organizations_url": "https://api.github.com/users/codrut3/orgs", "repos_url": "https://api.github.com/users/codrut3/repos", "events_url": "https://api.github.com/users/codrut3/events{/privacy}", "received_events_url": "https://api.github.com/users/codrut3/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/codrut3/tensorflow", "description": "Computation using data flow graphs for scalable machine learning", "fork": true, "url": "https://api.github.com/repos/codrut3/tensorflow", "forks_url": "https://api.github.com/repos/codrut3/tensorflow/forks", "keys_url": "https://api.github.com/repos/codrut3/tensorflow/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/codrut3/tensorflow/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/codrut3/tensorflow/teams", "hooks_url": "https://api.github.com/repos/codrut3/tensorflow/hooks", "issue_events_url": "https://api.github.com/repos/codrut3/tensorflow/issues/events{/number}", "events_url": "https://api.github.com/repos/codrut3/tensorflow/events", "assignees_url": "https://api.github.com/repos/codrut3/tensorflow/assignees{/user}", "branches_url": "https://api.github.com/repos/codrut3/tensorflow/branches{/branch}", "tags_url": "https://api.github.com/repos/codrut3/tensorflow/tags", "blobs_url": "https://api.github.com/repos/codrut3/tensorflow/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/codrut3/tensorflow/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/codrut3/tensorflow/git/refs{/sha}", "trees_url": "https://api.github.com/repos/codrut3/tensorflow/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/codrut3/tensorflow/statuses/{sha}", "languages_url": "https://api.github.com/repos/codrut3/tensorflow/languages", "stargazers_url": "https://api.github.com/repos/codrut3/tensorflow/stargazers", "contributors_url": "https://api.github.com/repos/codrut3/tensorflow/contributors", "subscribers_url": "https://api.github.com/repos/codrut3/tensorflow/subscribers", "subscription_url": "https://api.github.com/repos/codrut3/tensorflow/subscription", "commits_url": "https://api.github.com/repos/codrut3/tensorflow/commits{/sha}", "git_commits_url": "https://api.github.com/repos/codrut3/tensorflow/git/commits{/sha}", "comments_url": "https://api.github.com/repos/codrut3/tensorflow/comments{/number}", "issue_comment_url": "https://api.github.com/repos/codrut3/tensorflow/issues/comments{/number}", "contents_url": "https://api.github.com/repos/codrut3/tensorflow/contents/{+path}", "compare_url": "https://api.github.com/repos/codrut3/tensorflow/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/codrut3/tensorflow/merges", "archive_url": "https://api.github.com/repos/codrut3/tensorflow/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/codrut3/tensorflow/downloads", "issues_url": "https://api.github.com/repos/codrut3/tensorflow/issues{/number}", "pulls_url": "https://api.github.com/repos/codrut3/tensorflow/pulls{/number}", "milestones_url": "https://api.github.com/repos/codrut3/tensorflow/milestones{/number}", "notifications_url": "https://api.github.com/repos/codrut3/tensorflow/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/codrut3/tensorflow/labels{/name}", "releases_url": "https://api.github.com/repos/codrut3/tensorflow/releases{/id}", "deployments_url": "https://api.github.com/repos/codrut3/tensorflow/deployments", "created_at": "2017-04-02T19:26:25Z", "updated_at": "2017-04-02T19:26:47Z", "pushed_at": "2018-10-12T16:42:29Z", "git_url": "git://github.com/codrut3/tensorflow.git", "ssh_url": "git@github.com:codrut3/tensorflow.git", "clone_url": "https://github.com/codrut3/tensorflow.git", "svn_url": "https://github.com/codrut3/tensorflow", "homepage": "http://tensorflow.org", "size": 265050, "stargazers_count": 0, "watchers_count": 0, "language": "C++", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "forks_count": 0, "mirror_url": null, "archived": false, "open_issues_count": 0, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "tensorflow:master", "ref": "master", "sha": "d7dbf21bda3fae90ced99db1bb5c592264c02526", "user": {"login": "tensorflow", "id": 15658638, "node_id": "MDEyOk9yZ2FuaXphdGlvbjE1NjU4NjM4", "avatar_url": "https://avatars1.githubusercontent.com/u/15658638?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tensorflow", "html_url": "https://github.com/tensorflow", "followers_url": "https://api.github.com/users/tensorflow/followers", "following_url": "https://api.github.com/users/tensorflow/following{/other_user}", "gists_url": "https://api.github.com/users/tensorflow/gists{/gist_id}", "starred_url": "https://api.github.com/users/tensorflow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tensorflow/subscriptions", "organizations_url": "https://api.github.com/users/tensorflow/orgs", "repos_url": "https://api.github.com/users/tensorflow/repos", "events_url": "https://api.github.com/users/tensorflow/events{/privacy}", "received_events_url": "https://api.github.com/users/tensorflow/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 45717250, "node_id": "MDEwOlJlcG9zaXRvcnk0NTcxNzI1MA==", "name": "tensorflow", "full_name": "tensorflow/tensorflow", "private": false, "owner": {"login": "tensorflow", "id": 15658638, "node_id": "MDEyOk9yZ2FuaXphdGlvbjE1NjU4NjM4", "avatar_url": "https://avatars1.githubusercontent.com/u/15658638?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tensorflow", "html_url": "https://github.com/tensorflow", "followers_url": "https://api.github.com/users/tensorflow/followers", "following_url": "https://api.github.com/users/tensorflow/following{/other_user}", "gists_url": "https://api.github.com/users/tensorflow/gists{/gist_id}", "starred_url": "https://api.github.com/users/tensorflow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tensorflow/subscriptions", "organizations_url": "https://api.github.com/users/tensorflow/orgs", "repos_url": "https://api.github.com/users/tensorflow/repos", "events_url": "https://api.github.com/users/tensorflow/events{/privacy}", "received_events_url": "https://api.github.com/users/tensorflow/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/tensorflow/tensorflow", "description": "An Open Source Machine Learning Framework for Everyone", "fork": false, "url": "https://api.github.com/repos/tensorflow/tensorflow", "forks_url": "https://api.github.com/repos/tensorflow/tensorflow/forks", "keys_url": "https://api.github.com/repos/tensorflow/tensorflow/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/tensorflow/tensorflow/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/tensorflow/tensorflow/teams", "hooks_url": "https://api.github.com/repos/tensorflow/tensorflow/hooks", "issue_events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/events{/number}", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/events", "assignees_url": "https://api.github.com/repos/tensorflow/tensorflow/assignees{/user}", "branches_url": "https://api.github.com/repos/tensorflow/tensorflow/branches{/branch}", "tags_url": "https://api.github.com/repos/tensorflow/tensorflow/tags", "blobs_url": "https://api.github.com/repos/tensorflow/tensorflow/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/tensorflow/tensorflow/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/tensorflow/tensorflow/git/refs{/sha}", "trees_url": "https://api.github.com/repos/tensorflow/tensorflow/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/tensorflow/tensorflow/statuses/{sha}", "languages_url": "https://api.github.com/repos/tensorflow/tensorflow/languages", "stargazers_url": "https://api.github.com/repos/tensorflow/tensorflow/stargazers", "contributors_url": "https://api.github.com/repos/tensorflow/tensorflow/contributors", "subscribers_url": "https://api.github.com/repos/tensorflow/tensorflow/subscribers", "subscription_url": "https://api.github.com/repos/tensorflow/tensorflow/subscription", "commits_url": "https://api.github.com/repos/tensorflow/tensorflow/commits{/sha}", "git_commits_url": "https://api.github.com/repos/tensorflow/tensorflow/git/commits{/sha}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/comments{/number}", "issue_comment_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments{/number}", "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/{+path}", "compare_url": "https://api.github.com/repos/tensorflow/tensorflow/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/tensorflow/tensorflow/merges", "archive_url": "https://api.github.com/repos/tensorflow/tensorflow/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/tensorflow/tensorflow/downloads", "issues_url": "https://api.github.com/repos/tensorflow/tensorflow/issues{/number}", "pulls_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls{/number}", "milestones_url": "https://api.github.com/repos/tensorflow/tensorflow/milestones{/number}", "notifications_url": "https://api.github.com/repos/tensorflow/tensorflow/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/labels{/name}", "releases_url": "https://api.github.com/repos/tensorflow/tensorflow/releases{/id}", "deployments_url": "https://api.github.com/repos/tensorflow/tensorflow/deployments", "created_at": "2015-11-07T01:19:20Z", "updated_at": "2018-11-24T19:13:45Z", "pushed_at": "2018-11-24T18:40:19Z", "git_url": "git://github.com/tensorflow/tensorflow.git", "ssh_url": "git@github.com:tensorflow/tensorflow.git", "clone_url": "https://github.com/tensorflow/tensorflow.git", "svn_url": "https://github.com/tensorflow/tensorflow", "homepage": "https://tensorflow.org", "size": 284546, "stargazers_count": 115174, "watchers_count": 115174, "language": "C++", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "forks_count": 69944, "mirror_url": null, "archived": false, "open_issues_count": 1759, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "forks": 69944, "open_issues": 1759, "watchers": 115174, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13557"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/13557"}, "issue": {"href": "https://api.github.com/repos/tensorflow/tensorflow/issues/13557"}, "comments": {"href": "https://api.github.com/repos/tensorflow/tensorflow/issues/13557/comments"}, "review_comments": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13557/comments"}, "review_comment": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13557/commits"}, "statuses": {"href": "https://api.github.com/repos/tensorflow/tensorflow/statuses/3dceceb3fce6a20e1a03f4f07e26aa96fd05fdf7"}}, "author_association": "CONTRIBUTOR", "body_html": "<p>Currently the gradient of tf.dynamic_stitch is not correct for duplicated indices. This is<br>\nissue <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"206600235\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/7397\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/7397/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/7397\">#7397</a>. <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1952220\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/drasmuss\">@drasmuss</a> submitted a pull request for this issue, but it was ultimately not merged<br>\ndue to a performance drop.</p>\n<p>While working on this, I realised that the problem is more complicated than what follows<br>\nfrom the discussion in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"207403669\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/7487\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/tensorflow/tensorflow/pull/7487/hovercard\" href=\"https://github.com/tensorflow/tensorflow/pull/7487\">#7487</a>. In fact, the solution proposed in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"207403669\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/7487\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/tensorflow/tensorflow/pull/7487/hovercard\" href=\"https://github.com/tensorflow/tensorflow/pull/7487\">#7487</a> is not correct, because<br>\none can have duplicated indices in the same input tensor. The following example shows this:</p>\n<pre><code>import tensorflow as tf\n\nx = tf.zeros((3,))\ny = tf.dynamic_stitch([[0, 1, 0]], [x])\n\nwith tf.Session() as sess:\n    print(\"y\")\n    print(sess.run(y))\n\n    analytic, numeric = tf.test.compute_gradient(x, (3,), y, (2,))\n    print(\"analytic\")\n    print(analytic)\n    print(\"numeric\")\n    print(numeric)\n</code></pre>\n<p>The output (even with <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"207403669\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/7487\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/tensorflow/tensorflow/pull/7487/hovercard\" href=\"https://github.com/tensorflow/tensorflow/pull/7487\">#7487</a>) is</p>\n<pre><code>y\n[ 0.  0.]\nanalytic\n[[ 1.  0.]\n [ 0.  1.]\n [ 1.  0.]]\nnumeric\n[[ 0.          0.        ]\n [ 0.          0.99998707]\n [ 0.99998707  0.        ]]\n</code></pre>\n<p>My fix is to add a new kernel op <code>GatherDisjoint</code>, that can handle all the inputs together.<br>\nThis replaces the <code>n</code> calls to <code>gather</code> in <code>data_flow_grad._DynamicStitchGrads</code> with a<br>\nsingle <code>gather_disjoint</code>.</p>\n<p>The implementation is very similar to <code>gather</code>, I just zero out duplicated slices at the end.<br>\nI've put this op in core/, if you would like I can move it to contrib/, just let me know where.</p>\n<p>I've also added tests for the op and new tests for the gradient of dynamic stitch. Here<br>\nI inspired myself from <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1952220\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/drasmuss\">@drasmuss</a> pull request.</p>\n<p>I've run the script by <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1952220\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/drasmuss\">@drasmuss</a> again:</p>\n<pre><code>import time\n\nimport numpy as np\nimport tensorflow as tf\n\nstitch_size = 1000\nn_inputs = 10\ninput_shape = (100, 50, 50)\nreps = 10\n\nwith tf.device(\"cpu:0\"):\n    idxs = [tf.constant(np.random.randint(stitch_size, size=input_shape[0]), dtype=tf.int32)\n            for _ in range(n_inputs)]\n    vals = [tf.constant(np.random.uniform(-1, 1, size=input_shape), dtype=tf.float32)\n            for _ in range(n_inputs)]\n    y = tf.dynamic_stitch(idxs, vals)\n    grad = tf.gradients(y, vals)\n\ntotal_time = 0.0\nfor _ in range(reps):\n    with tf.Session() as sess:\n        start = time.time()\n        sess.run(grad)\n        total_time += time.time() - start\n\nprint(total_time / reps)\n</code></pre>\n<p>The results are as follows:<br>\nwith my fix:<br>\nCPU - 0.09455678462982178<br>\nGPU - 0.09739606380462647<br>\nwithout my fix:<br>\nCPU - 0.11728813648223876<br>\nGPU - 0.11805038452148438</p>\n<p>So with the fix it runs faster. On GPU the slowdown is due to the memory copies from host to device<br>\nand back, for input and output (I've checked with nvprof), and not because of my fix.</p>\n<p>I've run this script using local builds of the same master branch, with and without my patch.</p>\n<p>Let me know if the op should be moved somewhere else, or it should be made hidden.</p>", "body_text": "Currently the gradient of tf.dynamic_stitch is not correct for duplicated indices. This is\nissue #7397. @drasmuss submitted a pull request for this issue, but it was ultimately not merged\ndue to a performance drop.\nWhile working on this, I realised that the problem is more complicated than what follows\nfrom the discussion in #7487. In fact, the solution proposed in #7487 is not correct, because\none can have duplicated indices in the same input tensor. The following example shows this:\nimport tensorflow as tf\n\nx = tf.zeros((3,))\ny = tf.dynamic_stitch([[0, 1, 0]], [x])\n\nwith tf.Session() as sess:\n    print(\"y\")\n    print(sess.run(y))\n\n    analytic, numeric = tf.test.compute_gradient(x, (3,), y, (2,))\n    print(\"analytic\")\n    print(analytic)\n    print(\"numeric\")\n    print(numeric)\n\nThe output (even with #7487) is\ny\n[ 0.  0.]\nanalytic\n[[ 1.  0.]\n [ 0.  1.]\n [ 1.  0.]]\nnumeric\n[[ 0.          0.        ]\n [ 0.          0.99998707]\n [ 0.99998707  0.        ]]\n\nMy fix is to add a new kernel op GatherDisjoint, that can handle all the inputs together.\nThis replaces the n calls to gather in data_flow_grad._DynamicStitchGrads with a\nsingle gather_disjoint.\nThe implementation is very similar to gather, I just zero out duplicated slices at the end.\nI've put this op in core/, if you would like I can move it to contrib/, just let me know where.\nI've also added tests for the op and new tests for the gradient of dynamic stitch. Here\nI inspired myself from @drasmuss pull request.\nI've run the script by @drasmuss again:\nimport time\n\nimport numpy as np\nimport tensorflow as tf\n\nstitch_size = 1000\nn_inputs = 10\ninput_shape = (100, 50, 50)\nreps = 10\n\nwith tf.device(\"cpu:0\"):\n    idxs = [tf.constant(np.random.randint(stitch_size, size=input_shape[0]), dtype=tf.int32)\n            for _ in range(n_inputs)]\n    vals = [tf.constant(np.random.uniform(-1, 1, size=input_shape), dtype=tf.float32)\n            for _ in range(n_inputs)]\n    y = tf.dynamic_stitch(idxs, vals)\n    grad = tf.gradients(y, vals)\n\ntotal_time = 0.0\nfor _ in range(reps):\n    with tf.Session() as sess:\n        start = time.time()\n        sess.run(grad)\n        total_time += time.time() - start\n\nprint(total_time / reps)\n\nThe results are as follows:\nwith my fix:\nCPU - 0.09455678462982178\nGPU - 0.09739606380462647\nwithout my fix:\nCPU - 0.11728813648223876\nGPU - 0.11805038452148438\nSo with the fix it runs faster. On GPU the slowdown is due to the memory copies from host to device\nand back, for input and output (I've checked with nvprof), and not because of my fix.\nI've run this script using local builds of the same master branch, with and without my patch.\nLet me know if the op should be moved somewhere else, or it should be made hidden.", "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 9, "review_comments": 0, "maintainer_can_modify": true, "commits": 9, "additions": 868, "deletions": 10, "changed_files": 11}