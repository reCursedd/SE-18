{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17322", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17322/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17322/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17322/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17322", "id": 301008117, "node_id": "MDU6SXNzdWUzMDEwMDgxMTc=", "number": 17322, "title": "A bug When use kmean and tensorboard", "user": {"login": "burness", "id": 3112825, "node_id": "MDQ6VXNlcjMxMTI4MjU=", "avatar_url": "https://avatars2.githubusercontent.com/u/3112825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/burness", "html_url": "https://github.com/burness", "followers_url": "https://api.github.com/users/burness/followers", "following_url": "https://api.github.com/users/burness/following{/other_user}", "gists_url": "https://api.github.com/users/burness/gists{/gist_id}", "starred_url": "https://api.github.com/users/burness/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/burness/subscriptions", "organizations_url": "https://api.github.com/users/burness/orgs", "repos_url": "https://api.github.com/users/burness/repos", "events_url": "https://api.github.com/users/burness/events{/privacy}", "received_events_url": "https://api.github.com/users/burness/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-02-28T12:37:16Z", "updated_at": "2018-02-28T21:24:53Z", "closed_at": "2018-02-28T21:24:53Z", "author_association": "CONTRIBUTOR", "body_html": "<p>When I use the tensorboard in kmeans it cause an error, if i remove the merge_summary_op with <code>_, d, idx = sess.run([train_op, avg_distance, cluster_idx], feed_dict={X: full_data_x})</code>, it will be ok!!!  I don't know why the merge op will cause the error, could anyone help me with  ?</p>\n<pre><code>InvalidArgumentError: Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder_28 = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nCaused by op u'Placeholder_28', defined at:\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py\", line 16, in &lt;module&gt;\n    app.launch_new_instance()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/traitlets/config/application.py\", line 658, in launch_instance\n    app.start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 477, in start\n    ioloop.IOLoop.instance().start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 151, in start\n    super(ZMQIOLoop, self).start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/ioloop.py\", line 888, in start\n    handler_func(fd_obj, events)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 433, in _handle_events\n    self._handle_recv()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 465, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 407, in _run_callback\n    callback(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\n    user_expressions, allow_stdin)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"&lt;ipython-input-15-830a4475ac2c&gt;\", line 26, in &lt;module&gt;\n    X = tf.placeholder(tf.float32, shape=[None, num_features])\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1530, in placeholder\n    return gen_array_ops._placeholder(dtype=dtype, shape=shape, name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1954, in _placeholder\n    name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder_28 = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\n\n\n\u200b\nExtracting /tmp/data/train-images-idx3-ubyte.gz\nExtracting /tmp/data/train-labels-idx1-ubyte.gz\nExtracting /tmp/data/t10k-images-idx3-ubyte.gz\nExtracting /tmp/data/t10k-labels-idx1-ubyte.gz\n---------------------------------------------------------------------------\nInvalidArgumentError                      Traceback (most recent call last)\n&lt;ipython-input-5-77f99f84eb11&gt; in &lt;module&gt;()\n     54 for i in range(1, num_steps + 1):\n     55     _, d, idx, summary = sess.run([train_op, avg_distance, cluster_idx, merged_summary_op],\n---&gt; 56                          feed_dict={X: full_data_x})\n     57 #     summary_writer.add_summary(summary, i)\n     58     if i % 10 == 0 or i == 1:\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in run(self, fetches, feed_dict, options, run_metadata)\n    787     try:\n    788       result = self._run(None, fetches, feed_dict, options_ptr,\n--&gt; 789                          run_metadata_ptr)\n    790       if run_metadata:\n    791         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _run(self, handle, fetches, feed_dict, options, run_metadata)\n    995     if final_fetches or final_targets:\n    996       results = self._do_run(handle, final_targets, final_fetches,\n--&gt; 997                              feed_dict_string, options, run_metadata)\n    998     else:\n    999       results = []\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n   1130     if handle is None:\n   1131       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n-&gt; 1132                            target_list, options, run_metadata)\n   1133     else:\n   1134       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _do_call(self, fn, *args)\n   1150         except KeyError:\n   1151           pass\n-&gt; 1152       raise type(e)(node_def, op, message)\n   1153 \n   1154   def _extend_graph(self):\n\nInvalidArgumentError: Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nCaused by op u'Placeholder', defined at:\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py\", line 16, in &lt;module&gt;\n    app.launch_new_instance()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/traitlets/config/application.py\", line 658, in launch_instance\n    app.start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 477, in start\n    ioloop.IOLoop.instance().start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 151, in start\n    super(ZMQIOLoop, self).start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/ioloop.py\", line 888, in start\n    handler_func(fd_obj, events)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 433, in _handle_events\n    self._handle_recv()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 465, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 407, in _run_callback\n    callback(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\n    user_expressions, allow_stdin)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"&lt;ipython-input-1-b3a44847e28e&gt;\", line 25, in &lt;module&gt;\n    X = tf.placeholder(tf.float32, shape=[None, num_features])\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1530, in placeholder\n    return gen_array_ops._placeholder(dtype=dtype, shape=shape, name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1954, in _placeholder\n    name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n</code></pre>\n<pre><code>from __future__ import print_function\n\nimport numpy as np\nimport tensorflow as tf\nfrom tensorflow.contrib.factorization import KMeans\n\nimport os\nos.environ[\"CUDA_VISIBLE_DEVICES\"] = \"\"\nlogs_path = '/tmp/tensorflow_logs/k-means'\n\nfrom tensorflow.examples.tutorials.mnist import input_data\nmnist = input_data.read_data_sets(\"/tmp/data/\", one_hot=True)\nfull_data_x = mnist.train.images\n\nnum_steps = 50 \nbatch_size = 1024\nk = 25 \nnum_classes = 10\nnum_features = 784 \n\nX = tf.placeholder(tf.float32, shape=[None, num_features])\n# Labels (for assigning a label to a centroid and testing)\nY = tf.placeholder(tf.float32, shape=[None, num_classes])\n\n# K-Means Parameters\nkmeans = KMeans(inputs=X, num_clusters=k, distance_metric='cosine',\n                use_mini_batch=True)\n\ntraining_graph = kmeans.training_graph()\n\nif len(training_graph) &gt; 6: # Tensorflow 1.4+\n    (all_scores, cluster_idx, scores, cluster_centers_initialized,\n     cluster_centers_var, init_op, train_op) = training_graph\nelse:\n    (all_scores, cluster_idx, scores, cluster_centers_initialized,\n     init_op, train_op) = training_graph\n\ncluster_idx = cluster_idx[0] # fix for cluster_idx being a tuple\navg_distance = tf.reduce_mean(scores)\ntf.summary.scalar(\"avg_distance\", avg_distance)\n\ninit_vars = tf.initialize_all_variables()\nmerged_summary_op = tf.summary.merge_all()\n\nsess = tf.Session()\n\nsess.run(init_vars)\nsummary_writer = tf.summary.FileWriter(logs_path, graph=tf.get_default_graph())\nsess.run(init_op, feed_dict={X: full_data_x})\n\nfor i in range(1, num_steps + 1):\n    _, d, idx, summary = sess.run([train_op, avg_distance, cluster_idx, merged_summary_op],\n                         feed_dict={X: full_data_x})\n    summary_writer.add_summary(summary, i)\n    if i % 10 == 0 or i == 1:\n        print(\"Step %i, Avg Distance: %f\" % (i, d))\n\n\ncounts = np.zeros(shape=(k, num_classes))\nfor i in range(len(idx)):\n    counts[idx[i]] += mnist.train.labels[i]\n\nlabels_map = [np.argmax(c) for c in counts]\nlabels_map = tf.convert_to_tensor(labels_map)\n\n\ncluster_label = tf.nn.embedding_lookup(labels_map, cluster_idx)\ncorrect_prediction = tf.equal(cluster_label, tf.cast(tf.argmax(Y, 1), tf.int32))\naccuracy_op = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))\n\ntest_x, test_y = mnist.test.images, mnist.test.labels\nprint(\"Test Accuracy:\", sess.run(accuracy_op, feed_dict={X: test_x, Y: test_y}))\n\n</code></pre>", "body_text": "When I use the tensorboard in kmeans it cause an error, if i remove the merge_summary_op with _, d, idx = sess.run([train_op, avg_distance, cluster_idx], feed_dict={X: full_data_x}), it will be ok!!!  I don't know why the merge op will cause the error, could anyone help me with  ?\nInvalidArgumentError: Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder_28 = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nCaused by op u'Placeholder_28', defined at:\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py\", line 16, in <module>\n    app.launch_new_instance()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/traitlets/config/application.py\", line 658, in launch_instance\n    app.start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 477, in start\n    ioloop.IOLoop.instance().start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 151, in start\n    super(ZMQIOLoop, self).start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/ioloop.py\", line 888, in start\n    handler_func(fd_obj, events)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 433, in _handle_events\n    self._handle_recv()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 465, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 407, in _run_callback\n    callback(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\n    user_expressions, allow_stdin)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-15-830a4475ac2c>\", line 26, in <module>\n    X = tf.placeholder(tf.float32, shape=[None, num_features])\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1530, in placeholder\n    return gen_array_ops._placeholder(dtype=dtype, shape=shape, name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1954, in _placeholder\n    name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder_28 = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\n\n\n\u200b\nExtracting /tmp/data/train-images-idx3-ubyte.gz\nExtracting /tmp/data/train-labels-idx1-ubyte.gz\nExtracting /tmp/data/t10k-images-idx3-ubyte.gz\nExtracting /tmp/data/t10k-labels-idx1-ubyte.gz\n---------------------------------------------------------------------------\nInvalidArgumentError                      Traceback (most recent call last)\n<ipython-input-5-77f99f84eb11> in <module>()\n     54 for i in range(1, num_steps + 1):\n     55     _, d, idx, summary = sess.run([train_op, avg_distance, cluster_idx, merged_summary_op],\n---> 56                          feed_dict={X: full_data_x})\n     57 #     summary_writer.add_summary(summary, i)\n     58     if i % 10 == 0 or i == 1:\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in run(self, fetches, feed_dict, options, run_metadata)\n    787     try:\n    788       result = self._run(None, fetches, feed_dict, options_ptr,\n--> 789                          run_metadata_ptr)\n    790       if run_metadata:\n    791         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _run(self, handle, fetches, feed_dict, options, run_metadata)\n    995     if final_fetches or final_targets:\n    996       results = self._do_run(handle, final_targets, final_fetches,\n--> 997                              feed_dict_string, options, run_metadata)\n    998     else:\n    999       results = []\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n   1130     if handle is None:\n   1131       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n-> 1132                            target_list, options, run_metadata)\n   1133     else:\n   1134       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _do_call(self, fn, *args)\n   1150         except KeyError:\n   1151           pass\n-> 1152       raise type(e)(node_def, op, message)\n   1153 \n   1154   def _extend_graph(self):\n\nInvalidArgumentError: Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nCaused by op u'Placeholder', defined at:\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py\", line 16, in <module>\n    app.launch_new_instance()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/traitlets/config/application.py\", line 658, in launch_instance\n    app.start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 477, in start\n    ioloop.IOLoop.instance().start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 151, in start\n    super(ZMQIOLoop, self).start()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/ioloop.py\", line 888, in start\n    handler_func(fd_obj, events)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 433, in _handle_events\n    self._handle_recv()\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 465, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 407, in _run_callback\n    callback(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\n    user_expressions, allow_stdin)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-1-b3a44847e28e>\", line 25, in <module>\n    X = tf.placeholder(tf.float32, shape=[None, num_features])\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1530, in placeholder\n    return gen_array_ops._placeholder(dtype=dtype, shape=shape, name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1954, in _placeholder\n    name=name)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Shape [-1,784] has negative dimensions\n\t [[Node: Placeholder = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nfrom __future__ import print_function\n\nimport numpy as np\nimport tensorflow as tf\nfrom tensorflow.contrib.factorization import KMeans\n\nimport os\nos.environ[\"CUDA_VISIBLE_DEVICES\"] = \"\"\nlogs_path = '/tmp/tensorflow_logs/k-means'\n\nfrom tensorflow.examples.tutorials.mnist import input_data\nmnist = input_data.read_data_sets(\"/tmp/data/\", one_hot=True)\nfull_data_x = mnist.train.images\n\nnum_steps = 50 \nbatch_size = 1024\nk = 25 \nnum_classes = 10\nnum_features = 784 \n\nX = tf.placeholder(tf.float32, shape=[None, num_features])\n# Labels (for assigning a label to a centroid and testing)\nY = tf.placeholder(tf.float32, shape=[None, num_classes])\n\n# K-Means Parameters\nkmeans = KMeans(inputs=X, num_clusters=k, distance_metric='cosine',\n                use_mini_batch=True)\n\ntraining_graph = kmeans.training_graph()\n\nif len(training_graph) > 6: # Tensorflow 1.4+\n    (all_scores, cluster_idx, scores, cluster_centers_initialized,\n     cluster_centers_var, init_op, train_op) = training_graph\nelse:\n    (all_scores, cluster_idx, scores, cluster_centers_initialized,\n     init_op, train_op) = training_graph\n\ncluster_idx = cluster_idx[0] # fix for cluster_idx being a tuple\navg_distance = tf.reduce_mean(scores)\ntf.summary.scalar(\"avg_distance\", avg_distance)\n\ninit_vars = tf.initialize_all_variables()\nmerged_summary_op = tf.summary.merge_all()\n\nsess = tf.Session()\n\nsess.run(init_vars)\nsummary_writer = tf.summary.FileWriter(logs_path, graph=tf.get_default_graph())\nsess.run(init_op, feed_dict={X: full_data_x})\n\nfor i in range(1, num_steps + 1):\n    _, d, idx, summary = sess.run([train_op, avg_distance, cluster_idx, merged_summary_op],\n                         feed_dict={X: full_data_x})\n    summary_writer.add_summary(summary, i)\n    if i % 10 == 0 or i == 1:\n        print(\"Step %i, Avg Distance: %f\" % (i, d))\n\n\ncounts = np.zeros(shape=(k, num_classes))\nfor i in range(len(idx)):\n    counts[idx[i]] += mnist.train.labels[i]\n\nlabels_map = [np.argmax(c) for c in counts]\nlabels_map = tf.convert_to_tensor(labels_map)\n\n\ncluster_label = tf.nn.embedding_lookup(labels_map, cluster_idx)\ncorrect_prediction = tf.equal(cluster_label, tf.cast(tf.argmax(Y, 1), tf.int32))\naccuracy_op = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))\n\ntest_x, test_y = mnist.test.images, mnist.test.labels\nprint(\"Test Accuracy:\", sess.run(accuracy_op, feed_dict={X: test_x, Y: test_y}))", "body": "When I use the tensorboard in kmeans it cause an error, if i remove the merge_summary_op with `_, d, idx = sess.run([train_op, avg_distance, cluster_idx], feed_dict={X: full_data_x})`, it will be ok!!!  I don't know why the merge op will cause the error, could anyone help me with  ?\r\n\r\n```\r\nInvalidArgumentError: Shape [-1,784] has negative dimensions\r\n\t [[Node: Placeholder_28 = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\r\n\r\nCaused by op u'Placeholder_28', defined at:\r\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\r\n    \"__main__\", fname, loader, pkg_name)\r\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 72, in _run_code\r\n    exec code in run_globals\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py\", line 16, in <module>\r\n    app.launch_new_instance()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/traitlets/config/application.py\", line 658, in launch_instance\r\n    app.start()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 477, in start\r\n    ioloop.IOLoop.instance().start()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 151, in start\r\n    super(ZMQIOLoop, self).start()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/ioloop.py\", line 888, in start\r\n    handler_func(fd_obj, events)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 433, in _handle_events\r\n    self._handle_recv()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 465, in _handle_recv\r\n    self._run_callback(callback, msg)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 407, in _run_callback\r\n    callback(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\r\n    return self.dispatch_shell(stream, msg)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\r\n    handler(stream, idents, msg)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\r\n    user_expressions, allow_stdin)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\r\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\r\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\r\n    interactivity=interactivity, compiler=compiler, result=result)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\r\n    if self.run_code(code, result):\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-15-830a4475ac2c>\", line 26, in <module>\r\n    X = tf.placeholder(tf.float32, shape=[None, num_features])\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1530, in placeholder\r\n    return gen_array_ops._placeholder(dtype=dtype, shape=shape, name=name)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1954, in _placeholder\r\n    name=name)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\r\n    op_def=op_def)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\nInvalidArgumentError (see above for traceback): Shape [-1,784] has negative dimensions\r\n\t [[Node: Placeholder_28 = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\r\n\r\n\r\n\r\n\u200b\r\nExtracting /tmp/data/train-images-idx3-ubyte.gz\r\nExtracting /tmp/data/train-labels-idx1-ubyte.gz\r\nExtracting /tmp/data/t10k-images-idx3-ubyte.gz\r\nExtracting /tmp/data/t10k-labels-idx1-ubyte.gz\r\n---------------------------------------------------------------------------\r\nInvalidArgumentError                      Traceback (most recent call last)\r\n<ipython-input-5-77f99f84eb11> in <module>()\r\n     54 for i in range(1, num_steps + 1):\r\n     55     _, d, idx, summary = sess.run([train_op, avg_distance, cluster_idx, merged_summary_op],\r\n---> 56                          feed_dict={X: full_data_x})\r\n     57 #     summary_writer.add_summary(summary, i)\r\n     58     if i % 10 == 0 or i == 1:\r\n\r\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in run(self, fetches, feed_dict, options, run_metadata)\r\n    787     try:\r\n    788       result = self._run(None, fetches, feed_dict, options_ptr,\r\n--> 789                          run_metadata_ptr)\r\n    790       if run_metadata:\r\n    791         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\r\n\r\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _run(self, handle, fetches, feed_dict, options, run_metadata)\r\n    995     if final_fetches or final_targets:\r\n    996       results = self._do_run(handle, final_targets, final_fetches,\r\n--> 997                              feed_dict_string, options, run_metadata)\r\n    998     else:\r\n    999       results = []\r\n\r\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\r\n   1130     if handle is None:\r\n   1131       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\r\n-> 1132                            target_list, options, run_metadata)\r\n   1133     else:\r\n   1134       return self._do_call(_prun_fn, self._session, handle, feed_dict,\r\n\r\n/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/client/session.pyc in _do_call(self, fn, *args)\r\n   1150         except KeyError:\r\n   1151           pass\r\n-> 1152       raise type(e)(node_def, op, message)\r\n   1153 \r\n   1154   def _extend_graph(self):\r\n\r\nInvalidArgumentError: Shape [-1,784] has negative dimensions\r\n\t [[Node: Placeholder = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\r\n\r\nCaused by op u'Placeholder', defined at:\r\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\r\n    \"__main__\", fname, loader, pkg_name)\r\n  File \"/Users/burness/anaconda/lib/python2.7/runpy.py\", line 72, in _run_code\r\n    exec code in run_globals\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py\", line 16, in <module>\r\n    app.launch_new_instance()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/traitlets/config/application.py\", line 658, in launch_instance\r\n    app.start()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 477, in start\r\n    ioloop.IOLoop.instance().start()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 151, in start\r\n    super(ZMQIOLoop, self).start()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/ioloop.py\", line 888, in start\r\n    handler_func(fd_obj, events)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 433, in _handle_events\r\n    self._handle_recv()\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 465, in _handle_recv\r\n    self._run_callback(callback, msg)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 407, in _run_callback\r\n    callback(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\r\n    return self.dispatch_shell(stream, msg)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\r\n    handler(stream, idents, msg)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\r\n    user_expressions, allow_stdin)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\r\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\r\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\r\n    interactivity=interactivity, compiler=compiler, result=result)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\r\n    if self.run_code(code, result):\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-1-b3a44847e28e>\", line 25, in <module>\r\n    X = tf.placeholder(tf.float32, shape=[None, num_features])\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1530, in placeholder\r\n    return gen_array_ops._placeholder(dtype=dtype, shape=shape, name=name)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1954, in _placeholder\r\n    name=name)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\r\n    op_def=op_def)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/Users/burness/anaconda/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\nInvalidArgumentError (see above for traceback): Shape [-1,784] has negative dimensions\r\n\t [[Node: Placeholder = Placeholder[dtype=DT_FLOAT, shape=[?,784], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\r\n```\r\n\r\n```\r\nfrom __future__ import print_function\r\n\r\nimport numpy as np\r\nimport tensorflow as tf\r\nfrom tensorflow.contrib.factorization import KMeans\r\n\r\nimport os\r\nos.environ[\"CUDA_VISIBLE_DEVICES\"] = \"\"\r\nlogs_path = '/tmp/tensorflow_logs/k-means'\r\n\r\nfrom tensorflow.examples.tutorials.mnist import input_data\r\nmnist = input_data.read_data_sets(\"/tmp/data/\", one_hot=True)\r\nfull_data_x = mnist.train.images\r\n\r\nnum_steps = 50 \r\nbatch_size = 1024\r\nk = 25 \r\nnum_classes = 10\r\nnum_features = 784 \r\n\r\nX = tf.placeholder(tf.float32, shape=[None, num_features])\r\n# Labels (for assigning a label to a centroid and testing)\r\nY = tf.placeholder(tf.float32, shape=[None, num_classes])\r\n\r\n# K-Means Parameters\r\nkmeans = KMeans(inputs=X, num_clusters=k, distance_metric='cosine',\r\n                use_mini_batch=True)\r\n\r\ntraining_graph = kmeans.training_graph()\r\n\r\nif len(training_graph) > 6: # Tensorflow 1.4+\r\n    (all_scores, cluster_idx, scores, cluster_centers_initialized,\r\n     cluster_centers_var, init_op, train_op) = training_graph\r\nelse:\r\n    (all_scores, cluster_idx, scores, cluster_centers_initialized,\r\n     init_op, train_op) = training_graph\r\n\r\ncluster_idx = cluster_idx[0] # fix for cluster_idx being a tuple\r\navg_distance = tf.reduce_mean(scores)\r\ntf.summary.scalar(\"avg_distance\", avg_distance)\r\n\r\ninit_vars = tf.initialize_all_variables()\r\nmerged_summary_op = tf.summary.merge_all()\r\n\r\nsess = tf.Session()\r\n\r\nsess.run(init_vars)\r\nsummary_writer = tf.summary.FileWriter(logs_path, graph=tf.get_default_graph())\r\nsess.run(init_op, feed_dict={X: full_data_x})\r\n\r\nfor i in range(1, num_steps + 1):\r\n    _, d, idx, summary = sess.run([train_op, avg_distance, cluster_idx, merged_summary_op],\r\n                         feed_dict={X: full_data_x})\r\n    summary_writer.add_summary(summary, i)\r\n    if i % 10 == 0 or i == 1:\r\n        print(\"Step %i, Avg Distance: %f\" % (i, d))\r\n\r\n\r\ncounts = np.zeros(shape=(k, num_classes))\r\nfor i in range(len(idx)):\r\n    counts[idx[i]] += mnist.train.labels[i]\r\n\r\nlabels_map = [np.argmax(c) for c in counts]\r\nlabels_map = tf.convert_to_tensor(labels_map)\r\n\r\n\r\ncluster_label = tf.nn.embedding_lookup(labels_map, cluster_idx)\r\ncorrect_prediction = tf.equal(cluster_label, tf.cast(tf.argmax(Y, 1), tf.int32))\r\naccuracy_op = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))\r\n\r\ntest_x, test_y = mnist.test.images, mnist.test.labels\r\nprint(\"Test Accuracy:\", sess.run(accuracy_op, feed_dict={X: test_x, Y: test_y}))\r\n\r\n```"}