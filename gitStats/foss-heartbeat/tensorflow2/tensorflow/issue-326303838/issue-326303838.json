{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19541", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19541/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19541/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19541/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19541", "id": 326303838, "node_id": "MDU6SXNzdWUzMjYzMDM4Mzg=", "number": 19541, "title": "End of Sequence Error when using tf.estimator with tf.data", "user": {"login": "mrezak", "id": 4903456, "node_id": "MDQ6VXNlcjQ5MDM0NTY=", "avatar_url": "https://avatars0.githubusercontent.com/u/4903456?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrezak", "html_url": "https://github.com/mrezak", "followers_url": "https://api.github.com/users/mrezak/followers", "following_url": "https://api.github.com/users/mrezak/following{/other_user}", "gists_url": "https://api.github.com/users/mrezak/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrezak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrezak/subscriptions", "organizations_url": "https://api.github.com/users/mrezak/orgs", "repos_url": "https://api.github.com/users/mrezak/repos", "events_url": "https://api.github.com/users/mrezak/events{/privacy}", "received_events_url": "https://api.github.com/users/mrezak/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "xiejw", "id": 1184671, "node_id": "MDQ6VXNlcjExODQ2NzE=", "avatar_url": "https://avatars1.githubusercontent.com/u/1184671?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xiejw", "html_url": "https://github.com/xiejw", "followers_url": "https://api.github.com/users/xiejw/followers", "following_url": "https://api.github.com/users/xiejw/following{/other_user}", "gists_url": "https://api.github.com/users/xiejw/gists{/gist_id}", "starred_url": "https://api.github.com/users/xiejw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xiejw/subscriptions", "organizations_url": "https://api.github.com/users/xiejw/orgs", "repos_url": "https://api.github.com/users/xiejw/repos", "events_url": "https://api.github.com/users/xiejw/events{/privacy}", "received_events_url": "https://api.github.com/users/xiejw/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "xiejw", "id": 1184671, "node_id": "MDQ6VXNlcjExODQ2NzE=", "avatar_url": "https://avatars1.githubusercontent.com/u/1184671?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xiejw", "html_url": "https://github.com/xiejw", "followers_url": "https://api.github.com/users/xiejw/followers", "following_url": "https://api.github.com/users/xiejw/following{/other_user}", "gists_url": "https://api.github.com/users/xiejw/gists{/gist_id}", "starred_url": "https://api.github.com/users/xiejw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xiejw/subscriptions", "organizations_url": "https://api.github.com/users/xiejw/orgs", "repos_url": "https://api.github.com/users/xiejw/repos", "events_url": "https://api.github.com/users/xiejw/events{/privacy}", "received_events_url": "https://api.github.com/users/xiejw/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2018-05-24T21:34:57Z", "updated_at": "2018-05-25T22:01:04Z", "closed_at": "2018-05-25T22:01:03Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux CentOS v7</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: Binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.8</li>\n<li><strong>Python version</strong>: 2.7</li>\n<li><strong>Bazel version (if compiling from source)</strong>:</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0 / 7</li>\n<li><strong>GPU model and memory</strong>: Titan Xp, 12GB</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I am using tf.estimator.train_and_evaluate and tf.data.Dataset to feed data to the estimator:</p>\n<p>Input Data function:</p>\n<pre><code>    def data_fn(data_dict, batch_size, mode, num_epochs=10):\n        dataset = {}\n        if mode == tf.estimator.ModeKeys.TRAIN:\n            dataset = tf.data.Dataset.from_tensor_slices(data_dict['train_data'].astype(np.float32))\n            dataset = dataset.cache()\n            dataset = dataset.shuffle(buffer_size= batch_size * 10).repeat(num_epochs).batch(batch_size)\n        else:\n            dataset = tf.data.Dataset.from_tensor_slices(data_dict['valid_data'].astype(np.float32))\n            dataset = dataset.cache()\n            dataset = dataset.batch(batch_size)\n\n        iterator = dataset.make_one_shot_iterator()\n        next_element = iterator.get_next()\n\n    return next_element\n</code></pre>\n<p>Train Function:</p>\n<pre><code>def train_model(data):\n    tf.logging.set_verbosity(tf.logging.INFO)\n    config = tf.ConfigProto(allow_soft_placement=True,\n                            log_device_placement=False)\n    config.gpu_options.allow_growth = True\n    run_config = tf.contrib.learn.RunConfig(\n        save_checkpoints_steps=10,\n        keep_checkpoint_max=10,\n        session_config=config\n    )\n\n    train_input = lambda: data_fn(data, 100, tf.estimator.ModeKeys.TRAIN, num_epochs=1)\n    eval_input = lambda: data_fn(data, 1000, tf.estimator.ModeKeys.EVAL)\n    estimator = tf.estimator.Estimator(model_fn=model_fn, params=hps, config=run_config)\n    train_spec = tf.estimator.TrainSpec(train_input, max_steps=100)\n    eval_spec = tf.estimator.EvalSpec(eval_input,\n                                      steps=None,\n                                      throttle_secs = 30)\n\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n</code></pre>\n<p>The training goes fine, but when it comes to evaluation I get this error:<br>\n<code>OutOfRangeError (see above for traceback): End of sequence </code></p>\n<p>If I don't use Dataset.batch on evaluation dataset (by omitting the line dataset[name] = dataset[name].batch(batch_size) in data_fn) I get the same error but after a much longer time.</p>\n<p>I can only avoid this error if I don't batch the data and use steps=1 for evaluation (does that perform the evaluation on the whole dataset?)</p>\n<p>I don't understand what causes this error as the documentation suggests I should be able to evaluate on batches too.</p>\n<p>Note: I get the same error when using tf.estimator.evaluate on data batches.</p>\n<h3>Source code / logs</h3>\n<pre><code>  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 439, in train_and_evaluate\n    executor.run()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 518, in run\n    self.run_local()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 657, in run_local\n    eval_result = evaluator.evaluate_and_export()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 847, in evaluate_and_export\n    hooks=self._eval_spec.hooks)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 425, in evaluate\n    name=name)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1085, in _evaluate_model\n    input_fn, model_fn_lib.ModeKeys.EVAL))\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 691, in _get_features_and_labels_from_input_fn\n    result = self._call_input_fn(input_fn, mode)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 798, in _call_input_fn\n    return input_fn(**kwargs)\n  File \"/snel/home/mreza/projects/PBT_HP_opt/lfadslite/lfadslite.py\", line 748, in &lt;lambda&gt;\n    eval_input = lambda: self.data_fn(hps, tf.estimator.ModeKeys.EVAL)\n  File \"/snel/home/mreza/projects/PBT_HP_opt/lfadslite/lfadslite.py\", line 112, in data_fn\n    next_element = iterator.get_next()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/data/ops/iterator_ops.py\", line 370, in get_next\n    name=name)), self._output_types,\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/ops/gen_dataset_ops.py\", line 1466, in iterator_get_next\n    output_shapes=output_shapes, name=name)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\n    op_def=op_def)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nOutOfRangeError (see above for traceback): End of sequence\n\t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[[?,200,29]], output_types=[DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](OneShotIterator)]]\n\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux CentOS v7\nTensorFlow installed from (source or binary): Binary\nTensorFlow version (use command below): 1.8\nPython version: 2.7\nBazel version (if compiling from source):\nGCC/Compiler version (if compiling from source):\nCUDA/cuDNN version: 9.0 / 7\nGPU model and memory: Titan Xp, 12GB\nExact command to reproduce:\n\nDescribe the problem\nI am using tf.estimator.train_and_evaluate and tf.data.Dataset to feed data to the estimator:\nInput Data function:\n    def data_fn(data_dict, batch_size, mode, num_epochs=10):\n        dataset = {}\n        if mode == tf.estimator.ModeKeys.TRAIN:\n            dataset = tf.data.Dataset.from_tensor_slices(data_dict['train_data'].astype(np.float32))\n            dataset = dataset.cache()\n            dataset = dataset.shuffle(buffer_size= batch_size * 10).repeat(num_epochs).batch(batch_size)\n        else:\n            dataset = tf.data.Dataset.from_tensor_slices(data_dict['valid_data'].astype(np.float32))\n            dataset = dataset.cache()\n            dataset = dataset.batch(batch_size)\n\n        iterator = dataset.make_one_shot_iterator()\n        next_element = iterator.get_next()\n\n    return next_element\n\nTrain Function:\ndef train_model(data):\n    tf.logging.set_verbosity(tf.logging.INFO)\n    config = tf.ConfigProto(allow_soft_placement=True,\n                            log_device_placement=False)\n    config.gpu_options.allow_growth = True\n    run_config = tf.contrib.learn.RunConfig(\n        save_checkpoints_steps=10,\n        keep_checkpoint_max=10,\n        session_config=config\n    )\n\n    train_input = lambda: data_fn(data, 100, tf.estimator.ModeKeys.TRAIN, num_epochs=1)\n    eval_input = lambda: data_fn(data, 1000, tf.estimator.ModeKeys.EVAL)\n    estimator = tf.estimator.Estimator(model_fn=model_fn, params=hps, config=run_config)\n    train_spec = tf.estimator.TrainSpec(train_input, max_steps=100)\n    eval_spec = tf.estimator.EvalSpec(eval_input,\n                                      steps=None,\n                                      throttle_secs = 30)\n\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n\nThe training goes fine, but when it comes to evaluation I get this error:\nOutOfRangeError (see above for traceback): End of sequence \nIf I don't use Dataset.batch on evaluation dataset (by omitting the line dataset[name] = dataset[name].batch(batch_size) in data_fn) I get the same error but after a much longer time.\nI can only avoid this error if I don't batch the data and use steps=1 for evaluation (does that perform the evaluation on the whole dataset?)\nI don't understand what causes this error as the documentation suggests I should be able to evaluate on batches too.\nNote: I get the same error when using tf.estimator.evaluate on data batches.\nSource code / logs\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 439, in train_and_evaluate\n    executor.run()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 518, in run\n    self.run_local()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 657, in run_local\n    eval_result = evaluator.evaluate_and_export()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 847, in evaluate_and_export\n    hooks=self._eval_spec.hooks)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 425, in evaluate\n    name=name)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1085, in _evaluate_model\n    input_fn, model_fn_lib.ModeKeys.EVAL))\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 691, in _get_features_and_labels_from_input_fn\n    result = self._call_input_fn(input_fn, mode)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 798, in _call_input_fn\n    return input_fn(**kwargs)\n  File \"/snel/home/mreza/projects/PBT_HP_opt/lfadslite/lfadslite.py\", line 748, in <lambda>\n    eval_input = lambda: self.data_fn(hps, tf.estimator.ModeKeys.EVAL)\n  File \"/snel/home/mreza/projects/PBT_HP_opt/lfadslite/lfadslite.py\", line 112, in data_fn\n    next_element = iterator.get_next()\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/data/ops/iterator_ops.py\", line 370, in get_next\n    name=name)), self._output_types,\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/ops/gen_dataset_ops.py\", line 1466, in iterator_get_next\n    output_shapes=output_shapes, name=name)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\n    op_def=op_def)\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nOutOfRangeError (see above for traceback): End of sequence\n\t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[[?,200,29]], output_types=[DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](OneShotIterator)]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux CentOS v7\r\n- **TensorFlow installed from (source or binary)**: Binary\r\n- **TensorFlow version (use command below)**: 1.8\r\n- **Python version**: 2.7\r\n- **Bazel version (if compiling from source)**:\r\n- **GCC/Compiler version (if compiling from source)**:\r\n- **CUDA/cuDNN version**: 9.0 / 7\r\n- **GPU model and memory**: Titan Xp, 12GB \r\n- **Exact command to reproduce**: \r\n\r\n### Describe the problem\r\nI am using tf.estimator.train_and_evaluate and tf.data.Dataset to feed data to the estimator:\r\n\r\nInput Data function:\r\n\r\n```\r\n    def data_fn(data_dict, batch_size, mode, num_epochs=10):\r\n        dataset = {}\r\n        if mode == tf.estimator.ModeKeys.TRAIN:\r\n            dataset = tf.data.Dataset.from_tensor_slices(data_dict['train_data'].astype(np.float32))\r\n            dataset = dataset.cache()\r\n            dataset = dataset.shuffle(buffer_size= batch_size * 10).repeat(num_epochs).batch(batch_size)\r\n        else:\r\n            dataset = tf.data.Dataset.from_tensor_slices(data_dict['valid_data'].astype(np.float32))\r\n            dataset = dataset.cache()\r\n            dataset = dataset.batch(batch_size)\r\n\r\n        iterator = dataset.make_one_shot_iterator()\r\n        next_element = iterator.get_next()\r\n\r\n    return next_element\r\n```\r\n\r\nTrain Function:\r\n```\r\ndef train_model(data):\r\n    tf.logging.set_verbosity(tf.logging.INFO)\r\n    config = tf.ConfigProto(allow_soft_placement=True,\r\n                            log_device_placement=False)\r\n    config.gpu_options.allow_growth = True\r\n    run_config = tf.contrib.learn.RunConfig(\r\n        save_checkpoints_steps=10,\r\n        keep_checkpoint_max=10,\r\n        session_config=config\r\n    )\r\n\r\n    train_input = lambda: data_fn(data, 100, tf.estimator.ModeKeys.TRAIN, num_epochs=1)\r\n    eval_input = lambda: data_fn(data, 1000, tf.estimator.ModeKeys.EVAL)\r\n    estimator = tf.estimator.Estimator(model_fn=model_fn, params=hps, config=run_config)\r\n    train_spec = tf.estimator.TrainSpec(train_input, max_steps=100)\r\n    eval_spec = tf.estimator.EvalSpec(eval_input,\r\n                                      steps=None,\r\n                                      throttle_secs = 30)\r\n\r\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\r\n```\r\n\r\nThe training goes fine, but when it comes to evaluation I get this error:\r\n`OutOfRangeError (see above for traceback): End of sequence `\r\n\r\nIf I don't use Dataset.batch on evaluation dataset (by omitting the line dataset[name] = dataset[name].batch(batch_size) in data_fn) I get the same error but after a much longer time.\r\n\r\nI can only avoid this error if I don't batch the data and use steps=1 for evaluation (does that perform the evaluation on the whole dataset?)\r\n\r\nI don't understand what causes this error as the documentation suggests I should be able to evaluate on batches too.\r\n\r\nNote: I get the same error when using tf.estimator.evaluate on data batches.\r\n\r\n### Source code / logs\r\n\r\n```\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 439, in train_and_evaluate\r\n    executor.run()\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 518, in run\r\n    self.run_local()\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 657, in run_local\r\n    eval_result = evaluator.evaluate_and_export()\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/training.py\", line 847, in evaluate_and_export\r\n    hooks=self._eval_spec.hooks)\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 425, in evaluate\r\n    name=name)\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 1085, in _evaluate_model\r\n    input_fn, model_fn_lib.ModeKeys.EVAL))\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 691, in _get_features_and_labels_from_input_fn\r\n    result = self._call_input_fn(input_fn, mode)\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/estimator/estimator.py\", line 798, in _call_input_fn\r\n    return input_fn(**kwargs)\r\n  File \"/snel/home/mreza/projects/PBT_HP_opt/lfadslite/lfadslite.py\", line 748, in <lambda>\r\n    eval_input = lambda: self.data_fn(hps, tf.estimator.ModeKeys.EVAL)\r\n  File \"/snel/home/mreza/projects/PBT_HP_opt/lfadslite/lfadslite.py\", line 112, in data_fn\r\n    next_element = iterator.get_next()\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/data/ops/iterator_ops.py\", line 370, in get_next\r\n    name=name)), self._output_types,\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/ops/gen_dataset_ops.py\", line 1466, in iterator_get_next\r\n    output_shapes=output_shapes, name=name)\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\r\n    op_def=op_def)\r\n  File \"/usr/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nOutOfRangeError (see above for traceback): End of sequence\r\n\t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[[?,200,29]], output_types=[DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](OneShotIterator)]]\r\n\r\n```"}