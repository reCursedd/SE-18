{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4543", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4543/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4543/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4543/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/4543", "id": 178777995, "node_id": "MDU6SXNzdWUxNzg3Nzc5OTU=", "number": 4543, "title": "ValidationMonitor + readers lead to: Coordinator didn't stop cleanly: Attempted to use a closed Session.", "user": {"login": "mschulkind", "id": 523089, "node_id": "MDQ6VXNlcjUyMzA4OQ==", "avatar_url": "https://avatars2.githubusercontent.com/u/523089?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mschulkind", "html_url": "https://github.com/mschulkind", "followers_url": "https://api.github.com/users/mschulkind/followers", "following_url": "https://api.github.com/users/mschulkind/following{/other_user}", "gists_url": "https://api.github.com/users/mschulkind/gists{/gist_id}", "starred_url": "https://api.github.com/users/mschulkind/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mschulkind/subscriptions", "organizations_url": "https://api.github.com/users/mschulkind/orgs", "repos_url": "https://api.github.com/users/mschulkind/repos", "events_url": "https://api.github.com/users/mschulkind/events{/privacy}", "received_events_url": "https://api.github.com/users/mschulkind/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-09-23T03:47:25Z", "updated_at": "2016-10-29T00:53:05Z", "closed_at": "2016-10-29T00:53:05Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?</h3>\n<p><a href=\"http://andyljones.tumblr.com/post/133267887103/tensorflow-placeholder-queue-errors\" rel=\"nofollow\">http://andyljones.tumblr.com/post/133267887103/tensorflow-placeholder-queue-errors</a></p>\n<p>Above not totally relevant, but couldn't find much.</p>\n<h3>Environment info</h3>\n<p>Operating System:</p>\n<p>Relatively recently updated Arch.<br>\nLinux terrapin 4.6.5-4-ck <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP PREEMPT Mon Aug 8 20:47:19 EDT 2016 x86_64 GNU/Linux</p>\n<p>Installed version of CUDA and cuDNN:<br>\n(please attach the output of <code>ls -l /path/to/cuda/lib/libcud*</code>):</p>\n<pre><code>$ ls -l /usr/local/cuda/lib/libcud*\n-rw-r--r-- 1 root root 189170 Sep 17 01:09 /usr/local/cuda/lib/libcudadevrt.a\nlrwxrwxrwx 1 root root     16 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so -&gt; libcudart.so.7.5\nlrwxrwxrwx 1 root root     19 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so.7.5 -&gt; libcudart.so.7.5.18\n-rwxr-xr-x 1 root root 311596 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so.7.5.18\n-rw-r--r-- 1 root root 558020 Sep 17 01:09 /usr/local/cuda/lib/libcudart_static.a\n</code></pre>\n<p>If installed from binary pip package, provide:</p>\n<ol>\n<li>A link to the pip package you installed:<br>\n<a href=\"https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.10.0-cp35-cp35m-linux_x86_64.whl\" rel=\"nofollow\">https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.10.0-cp35-cp35m-linux_x86_64.whl</a></li>\n<li>The output from <code>python -c \"import tensorflow; print(tensorflow.__version__)\"</code>.</li>\n</ol>\n<pre><code>$ python -c \"import tensorflow; print(tensorflow.__version__)\"\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcurand.so locally\n0.10.0\n</code></pre>\n<p>If installed from source, provide</p>\n<ol>\n<li>The commit hash (<code>git rev-parse HEAD</code>)</li>\n<li>The output of <code>bazel version</code></li>\n</ol>\n<h3>If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)</h3>\n<p>Would be a bit of a hassle, and I think I already found the bug so...</p>\n<p>I've got a fairly simple model, it is fed by a <code>string_input_queue()</code> and then batched up by <code>shuffle_batch()</code> for training and <code>batch()</code> for evaluation. I'm using an <code>estimator.Estimator()</code> for the model and then calling <code>fit()</code> on the estimator with a <code>ValidationMonitor</code>.</p>\n<p>I get a bunch of errors in the output when trying this. Here are the relevant parts:</p>\n<pre><code>WARNING:tensorflow:Coordinator didn't stop cleanly: Attempted to use a closed Session.\nWARNING:tensorflow:Given features: {'clips': &lt;tf.Tensor 'input_test-11/batch:0' shape=(100, 3840) dtype=float32&gt;}, required signatures: {'clips': TensorSignature(dtype=tf.float32, shape=TensorShape([Dimension(100), Dimension(3840)]), is_sparse=False)}.\nWARNING:tensorflow:Given targets: Tensor(\"input_test-11/batch:1\", shape=(100,), dtype=int64), required signatures: TensorSignature(dtype=tf.int64, shape=TensorShape([Dimension(100)]), is_sparse=False).\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:838] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 970, pci bus id: 0000:03:00.0)\nW tensorflow/core/kernels/queue_base.cc:294] _9_input_test-11/input_producer: Skipping cancelled enqueue attempt with queue not closed\nWARNING:tensorflow:Coordinator didn't stop cleanly: Enqueue operation was cancelled\n     [[Node: input_test-11/input_producer/input_producer_EnqueueMany = QueueEnqueueMany[Tcomponents=[DT_STRING], _class=[\"loc:@input_test-11/input_producer\"], timeout_ms=-1, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](input_test-11/input_producer, input_test-11/input_producer/Identity)]]\nCaused by op 'input_test-11/input_producer/input_producer_EnqueueMany', defined at:\n  File \"./train.py\", line 320, in &lt;module&gt;\n    tf.app.run()\n</code></pre>\n<p>Without the <code>ValidationMonitor</code>, everything is fine, but with it, most of these errors happen on every validate, and sometimes it throws the exception shown.</p>\n<p>Of particular relevance is the error <code>Coordinator didn't stop cleanly: Attempted to use a closed Session.</code> which pretty clearly points out the problem.</p>\n<p>You can see the exact situation the error is complaining about here:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/learn/python/learn/graph_actions.py#L757\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/learn/python/learn/graph_actions.py#L757</a><br>\nThere's even a comment saying that exactly that is about to be done, although I don't know why. If I move the <code>session.close()</code> after the <code>coord.join(...)</code> call, then all my problems go away.</p>\n<p>Seems like a pretty clear problem with a pretty clear fix. Let me know if you need more details.</p>", "body_text": "What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\nhttp://andyljones.tumblr.com/post/133267887103/tensorflow-placeholder-queue-errors\nAbove not totally relevant, but couldn't find much.\nEnvironment info\nOperating System:\nRelatively recently updated Arch.\nLinux terrapin 4.6.5-4-ck #1 SMP PREEMPT Mon Aug 8 20:47:19 EDT 2016 x86_64 GNU/Linux\nInstalled version of CUDA and cuDNN:\n(please attach the output of ls -l /path/to/cuda/lib/libcud*):\n$ ls -l /usr/local/cuda/lib/libcud*\n-rw-r--r-- 1 root root 189170 Sep 17 01:09 /usr/local/cuda/lib/libcudadevrt.a\nlrwxrwxrwx 1 root root     16 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so -> libcudart.so.7.5\nlrwxrwxrwx 1 root root     19 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so.7.5 -> libcudart.so.7.5.18\n-rwxr-xr-x 1 root root 311596 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so.7.5.18\n-rw-r--r-- 1 root root 558020 Sep 17 01:09 /usr/local/cuda/lib/libcudart_static.a\n\nIf installed from binary pip package, provide:\n\nA link to the pip package you installed:\nhttps://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.10.0-cp35-cp35m-linux_x86_64.whl\nThe output from python -c \"import tensorflow; print(tensorflow.__version__)\".\n\n$ python -c \"import tensorflow; print(tensorflow.__version__)\"\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcurand.so locally\n0.10.0\n\nIf installed from source, provide\n\nThe commit hash (git rev-parse HEAD)\nThe output of bazel version\n\nIf possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\nWould be a bit of a hassle, and I think I already found the bug so...\nI've got a fairly simple model, it is fed by a string_input_queue() and then batched up by shuffle_batch() for training and batch() for evaluation. I'm using an estimator.Estimator() for the model and then calling fit() on the estimator with a ValidationMonitor.\nI get a bunch of errors in the output when trying this. Here are the relevant parts:\nWARNING:tensorflow:Coordinator didn't stop cleanly: Attempted to use a closed Session.\nWARNING:tensorflow:Given features: {'clips': <tf.Tensor 'input_test-11/batch:0' shape=(100, 3840) dtype=float32>}, required signatures: {'clips': TensorSignature(dtype=tf.float32, shape=TensorShape([Dimension(100), Dimension(3840)]), is_sparse=False)}.\nWARNING:tensorflow:Given targets: Tensor(\"input_test-11/batch:1\", shape=(100,), dtype=int64), required signatures: TensorSignature(dtype=tf.int64, shape=TensorShape([Dimension(100)]), is_sparse=False).\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:838] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 970, pci bus id: 0000:03:00.0)\nW tensorflow/core/kernels/queue_base.cc:294] _9_input_test-11/input_producer: Skipping cancelled enqueue attempt with queue not closed\nWARNING:tensorflow:Coordinator didn't stop cleanly: Enqueue operation was cancelled\n     [[Node: input_test-11/input_producer/input_producer_EnqueueMany = QueueEnqueueMany[Tcomponents=[DT_STRING], _class=[\"loc:@input_test-11/input_producer\"], timeout_ms=-1, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](input_test-11/input_producer, input_test-11/input_producer/Identity)]]\nCaused by op 'input_test-11/input_producer/input_producer_EnqueueMany', defined at:\n  File \"./train.py\", line 320, in <module>\n    tf.app.run()\n\nWithout the ValidationMonitor, everything is fine, but with it, most of these errors happen on every validate, and sometimes it throws the exception shown.\nOf particular relevance is the error Coordinator didn't stop cleanly: Attempted to use a closed Session. which pretty clearly points out the problem.\nYou can see the exact situation the error is complaining about here:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/learn/python/learn/graph_actions.py#L757\nThere's even a comment saying that exactly that is about to be done, although I don't know why. If I move the session.close() after the coord.join(...) call, then all my problems go away.\nSeems like a pretty clear problem with a pretty clear fix. Let me know if you need more details.", "body": "### What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\n\nhttp://andyljones.tumblr.com/post/133267887103/tensorflow-placeholder-queue-errors\n\nAbove not totally relevant, but couldn't find much.\n### Environment info\n\nOperating System:\n\nRelatively recently updated Arch.\nLinux terrapin 4.6.5-4-ck #1 SMP PREEMPT Mon Aug 8 20:47:19 EDT 2016 x86_64 GNU/Linux\n\nInstalled version of CUDA and cuDNN: \n(please attach the output of `ls -l /path/to/cuda/lib/libcud*`):\n\n```\n$ ls -l /usr/local/cuda/lib/libcud*\n-rw-r--r-- 1 root root 189170 Sep 17 01:09 /usr/local/cuda/lib/libcudadevrt.a\nlrwxrwxrwx 1 root root     16 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so -> libcudart.so.7.5\nlrwxrwxrwx 1 root root     19 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so.7.5 -> libcudart.so.7.5.18\n-rwxr-xr-x 1 root root 311596 Sep 17 01:09 /usr/local/cuda/lib/libcudart.so.7.5.18\n-rw-r--r-- 1 root root 558020 Sep 17 01:09 /usr/local/cuda/lib/libcudart_static.a\n```\n\nIf installed from binary pip package, provide:\n1. A link to the pip package you installed:\n   https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.10.0-cp35-cp35m-linux_x86_64.whl\n2. The output from `python -c \"import tensorflow; print(tensorflow.__version__)\"`.\n\n```\n$ python -c \"import tensorflow; print(tensorflow.__version__)\"\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcurand.so locally\n0.10.0\n```\n\nIf installed from source, provide \n1. The commit hash (`git rev-parse HEAD`)\n2. The output of `bazel version`\n### If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\n\nWould be a bit of a hassle, and I think I already found the bug so...\n\nI've got a fairly simple model, it is fed by a `string_input_queue()` and then batched up by `shuffle_batch()` for training and `batch()` for evaluation. I'm using an `estimator.Estimator()` for the model and then calling `fit()` on the estimator with a `ValidationMonitor`.\n\nI get a bunch of errors in the output when trying this. Here are the relevant parts:\n\n```\nWARNING:tensorflow:Coordinator didn't stop cleanly: Attempted to use a closed Session.\nWARNING:tensorflow:Given features: {'clips': <tf.Tensor 'input_test-11/batch:0' shape=(100, 3840) dtype=float32>}, required signatures: {'clips': TensorSignature(dtype=tf.float32, shape=TensorShape([Dimension(100), Dimension(3840)]), is_sparse=False)}.\nWARNING:tensorflow:Given targets: Tensor(\"input_test-11/batch:1\", shape=(100,), dtype=int64), required signatures: TensorSignature(dtype=tf.int64, shape=TensorShape([Dimension(100)]), is_sparse=False).\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:838] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 970, pci bus id: 0000:03:00.0)\nW tensorflow/core/kernels/queue_base.cc:294] _9_input_test-11/input_producer: Skipping cancelled enqueue attempt with queue not closed\nWARNING:tensorflow:Coordinator didn't stop cleanly: Enqueue operation was cancelled\n     [[Node: input_test-11/input_producer/input_producer_EnqueueMany = QueueEnqueueMany[Tcomponents=[DT_STRING], _class=[\"loc:@input_test-11/input_producer\"], timeout_ms=-1, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](input_test-11/input_producer, input_test-11/input_producer/Identity)]]\nCaused by op 'input_test-11/input_producer/input_producer_EnqueueMany', defined at:\n  File \"./train.py\", line 320, in <module>\n    tf.app.run()\n```\n\nWithout the `ValidationMonitor`, everything is fine, but with it, most of these errors happen on every validate, and sometimes it throws the exception shown.\n\nOf particular relevance is the error `Coordinator didn't stop cleanly: Attempted to use a closed Session.` which pretty clearly points out the problem.\n\nYou can see the exact situation the error is complaining about here:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/learn/python/learn/graph_actions.py#L757\nThere's even a comment saying that exactly that is about to be done, although I don't know why. If I move the `session.close()` after the `coord.join(...)` call, then all my problems go away.\n\nSeems like a pretty clear problem with a pretty clear fix. Let me know if you need more details.\n"}