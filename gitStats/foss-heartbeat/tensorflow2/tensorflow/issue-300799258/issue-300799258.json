{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17307", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17307/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17307/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17307/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17307", "id": 300799258, "node_id": "MDU6SXNzdWUzMDA3OTkyNTg=", "number": 17307, "title": "Dataset map KeyError from external tensors", "user": {"login": "skeggse", "id": 1348991, "node_id": "MDQ6VXNlcjEzNDg5OTE=", "avatar_url": "https://avatars2.githubusercontent.com/u/1348991?v=4", "gravatar_id": "", "url": "https://api.github.com/users/skeggse", "html_url": "https://github.com/skeggse", "followers_url": "https://api.github.com/users/skeggse/followers", "following_url": "https://api.github.com/users/skeggse/following{/other_user}", "gists_url": "https://api.github.com/users/skeggse/gists{/gist_id}", "starred_url": "https://api.github.com/users/skeggse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/skeggse/subscriptions", "organizations_url": "https://api.github.com/users/skeggse/orgs", "repos_url": "https://api.github.com/users/skeggse/repos", "events_url": "https://api.github.com/users/skeggse/events{/privacy}", "received_events_url": "https://api.github.com/users/skeggse/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-02-27T21:27:46Z", "updated_at": "2018-02-28T01:29:09Z", "closed_at": "2018-02-28T01:29:09Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Arch 15 Feb 2018</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary - <code>tensorflow-gpu</code> via <code>pip</code></li>\n<li><strong>TensorFlow version (use command below)</strong>: <code>v1.5.0-0-g37aa430d84 1.5.0</code></li>\n<li><strong>Python version</strong>: <code>3.6.4</code></li>\n<li><strong>CUDA/cuDNN version</strong>: <code>9.0.176</code>, <code>7.0.5-2</code></li>\n<li><strong>GPU model and memory</strong>: NVIDIA GeForce GTX 860M, 4GB</li>\n<li><strong>Exact command to reproduce</strong>: <code>python dataset-map.py</code></li>\n</ul>\n<h3>Describe the problem</h3>\n<p>Describe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.</p>\n<p>The following script raises the subsequent <code>KeyError</code>. I don't see anything obvious in the documentation that indicates that referencing tensors not defined in the callback function is invalid, though perhaps this is a common feature/limitation of library functions that call user functions to generate subgraphs, such as <code>Dataset#map</code> and <code>tf.cond</code>.</p>\n<p>This exact issue has an obvious workaround, but it gets a little trickier when you're referencing something more complex than a simple <code>tf.zeros</code> tensor.</p>\n<p>The type of <code>Dataset</code> doesn't matter - I'm just using <code>from_generator</code> for brevity.</p>\n<h3>Source code / logs</h3>\n<p>Include any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.</p>\n<h4>Source (<a href=\"https://gist.github.com/skeggse/1da719766772da217451a64fc20b1983\">permalink</a>)</h4>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\ndataset <span class=\"pl-k\">=</span> tf.data.Dataset.from_generator(<span class=\"pl-k\">lambda</span>: <span class=\"pl-c1\">None</span>, tf.float32)\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> raises no errors</span>\ndataset.map(<span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">i</span>: (i, tf.zeros(tf.float32)))\n\nzeros <span class=\"pl-k\">=</span> tf.zeros(tf.float32)\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> raises KeyError: 'zeros:0' (see below)</span>\ndataset.map(<span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">i</span>: (i, zeros))</pre></div>\n<h4>Traceback</h4>\n<pre><code>Traceback (most recent call last):\n  File \"dataset-map.py\", line 10, in &lt;module&gt;\n    dataset.map(lambda i: (i, zeros))\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 780, in map\n    return MapDataset(self, map_func)\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1591, in __init__\n    self._map_func.add_to_graph(ops.get_default_graph())\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 486, in add_to_graph\n    self._create_definition_if_needed()\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 321, in _create_definition_if_needed\n    self._create_definition_if_needed_impl()\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 376, in _create_definition_if_needed_impl\n    out_names=self._out_names)\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/graph_to_function_def.py\", line 185, in graph_to_function_def\n    func.ret[k] = input_dict[o.name]\nKeyError: 'zeros:0'\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Arch 15 Feb 2018\nTensorFlow installed from (source or binary): binary - tensorflow-gpu via pip\nTensorFlow version (use command below): v1.5.0-0-g37aa430d84 1.5.0\nPython version: 3.6.4\nCUDA/cuDNN version: 9.0.176, 7.0.5-2\nGPU model and memory: NVIDIA GeForce GTX 860M, 4GB\nExact command to reproduce: python dataset-map.py\n\nDescribe the problem\nDescribe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.\nThe following script raises the subsequent KeyError. I don't see anything obvious in the documentation that indicates that referencing tensors not defined in the callback function is invalid, though perhaps this is a common feature/limitation of library functions that call user functions to generate subgraphs, such as Dataset#map and tf.cond.\nThis exact issue has an obvious workaround, but it gets a little trickier when you're referencing something more complex than a simple tf.zeros tensor.\nThe type of Dataset doesn't matter - I'm just using from_generator for brevity.\nSource code / logs\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.\nSource (permalink)\nimport tensorflow as tf\n\ndataset = tf.data.Dataset.from_generator(lambda: None, tf.float32)\n\n# raises no errors\ndataset.map(lambda i: (i, tf.zeros(tf.float32)))\n\nzeros = tf.zeros(tf.float32)\n# raises KeyError: 'zeros:0' (see below)\ndataset.map(lambda i: (i, zeros))\nTraceback\nTraceback (most recent call last):\n  File \"dataset-map.py\", line 10, in <module>\n    dataset.map(lambda i: (i, zeros))\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 780, in map\n    return MapDataset(self, map_func)\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1591, in __init__\n    self._map_func.add_to_graph(ops.get_default_graph())\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 486, in add_to_graph\n    self._create_definition_if_needed()\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 321, in _create_definition_if_needed\n    self._create_definition_if_needed_impl()\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 376, in _create_definition_if_needed_impl\n    out_names=self._out_names)\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/graph_to_function_def.py\", line 185, in graph_to_function_def\n    func.ret[k] = input_dict[o.name]\nKeyError: 'zeros:0'", "body": "### System information\r\n\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Arch 15 Feb 2018\r\n- **TensorFlow installed from (source or binary)**: binary - `tensorflow-gpu` via `pip`\r\n- **TensorFlow version (use command below)**: `v1.5.0-0-g37aa430d84 1.5.0`\r\n- **Python version**: `3.6.4`\r\n- **CUDA/cuDNN version**: `9.0.176`, `7.0.5-2`\r\n- **GPU model and memory**: NVIDIA GeForce GTX 860M, 4GB\r\n- **Exact command to reproduce**: `python dataset-map.py`\r\n\r\n### Describe the problem\r\n\r\nDescribe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.\r\n\r\nThe following script raises the subsequent `KeyError`. I don't see anything obvious in the documentation that indicates that referencing tensors not defined in the callback function is invalid, though perhaps this is a common feature/limitation of library functions that call user functions to generate subgraphs, such as `Dataset#map` and `tf.cond`.\r\n\r\nThis exact issue has an obvious workaround, but it gets a little trickier when you're referencing something more complex than a simple `tf.zeros` tensor.\r\n\r\nThe type of `Dataset` doesn't matter - I'm just using `from_generator` for brevity.\r\n\r\n### Source code / logs\r\n\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\n#### Source ([permalink](https://gist.github.com/skeggse/1da719766772da217451a64fc20b1983))\r\n\r\n```py\r\nimport tensorflow as tf\r\n\r\ndataset = tf.data.Dataset.from_generator(lambda: None, tf.float32)\r\n\r\n# raises no errors\r\ndataset.map(lambda i: (i, tf.zeros(tf.float32)))\r\n\r\nzeros = tf.zeros(tf.float32)\r\n# raises KeyError: 'zeros:0' (see below)\r\ndataset.map(lambda i: (i, zeros))\r\n```\r\n\r\n#### Traceback\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"dataset-map.py\", line 10, in <module>\r\n    dataset.map(lambda i: (i, zeros))\r\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 780, in map\r\n    return MapDataset(self, map_func)\r\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1591, in __init__\r\n    self._map_func.add_to_graph(ops.get_default_graph())\r\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 486, in add_to_graph\r\n    self._create_definition_if_needed()\r\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 321, in _create_definition_if_needed\r\n    self._create_definition_if_needed_impl()\r\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 376, in _create_definition_if_needed_impl\r\n    out_names=self._out_names)\r\n  File \"/usr/lib/python3.6/site-packages/tensorflow/python/framework/graph_to_function_def.py\", line 185, in graph_to_function_def\r\n    func.ret[k] = input_dict[o.name]\r\nKeyError: 'zeros:0'\r\n```"}