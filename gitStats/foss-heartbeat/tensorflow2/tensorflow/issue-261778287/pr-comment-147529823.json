{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/147529823", "pull_request_review_id": 72645223, "id": 147529823, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE0NzUyOTgyMw==", "diff_hunk": "@@ -90,15 +93,73 @@ def _train(self,\n         saver.save(sess, checkpoint_path)\n \n   def _infer(self, checkpoint_path, image_val, shape, use_gpu, is_fused):\n+    dtype = image_val.dtype\n     ops.reset_default_graph()\n     graph = ops.get_default_graph()\n     with self.test_session(graph=graph, use_gpu=use_gpu) as sess:\n-      image = array_ops.placeholder(dtype='float32', shape=shape)\n+      image = array_ops.placeholder(dtype=dtype, shape=shape)\n       loss, _, saver = self._simple_model(image, is_fused, True)\n       saver.restore(sess, checkpoint_path)\n       loss_val = sess.run(loss, feed_dict={image: image_val})\n       return loss_val\n \n+  def _trainEvalSequence(self,\n+                         dtype,\n+                         train1_use_gpu,\n+                         train2_use_gpu,\n+                         infer_use_gpu):\n+    batch, height, width, input_channels = 2, 4, 5, 3\n+    shape = [batch, height, width, input_channels]\n+    checkpoint = os.path.join(self.get_temp_dir(), 'cp_%s_%s_%s_%s' %\n+        (dtype, train1_use_gpu, train2_use_gpu, infer_use_gpu))\n+\n+    self._train(\n+        checkpoint,\n+        shape,\n+        use_gpu=train1_use_gpu,\n+        is_fused=True,\n+        restore=False,\n+        freeze_mode=False,\n+        dtype=dtype)\n+\n+    train_vars = self._train(\n+        checkpoint,\n+        shape,\n+        use_gpu=train2_use_gpu,\n+        is_fused=True,\n+        restore=True,\n+        freeze_mode=False,\n+        dtype=dtype)\n+\n+    image_val = np.random.rand(batch,\n+                               height,\n+                               width,\n+                               input_channels).astype(dtype.as_numpy_dtype)\n+    loss_val = self._infer(checkpoint, image_val, shape,\n+                           use_gpu=infer_use_gpu, is_fused=True)\n+\n+    return train_vars, loss_val\n+\n+  def testHalfPrecision(self):\n+    ref_vars, ref_loss = self._trainEvalSequence(dtype=dtypes.float32,\n+                                                 train1_use_gpu=True,\n+                                                 train2_use_gpu=True,\n+                                                 infer_use_gpu=True)\n+ \n+    self.assertEqual(len(ref_vars), 5)\n+\n+    for train1_use_gpu in [True, False]:\n+      for train2_use_gpu in [True, False]:\n+        for infer_use_gpu in [True, False]:\n+          v, l = self._trainEvalSequence(dtypes.float16,", "path": "tensorflow/python/layers/normalization_test.py", "position": null, "original_position": 89, "commit_id": "8755a4305af31c18f1a4bc3b0cf4cbb875027156", "original_commit_id": "c51f11bb58bca592759811e9465df479c6b82bc5", "user": {"login": "nluehr", "id": 1873655, "node_id": "MDQ6VXNlcjE4NzM2NTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1873655?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nluehr", "html_url": "https://github.com/nluehr", "followers_url": "https://api.github.com/users/nluehr/followers", "following_url": "https://api.github.com/users/nluehr/following{/other_user}", "gists_url": "https://api.github.com/users/nluehr/gists{/gist_id}", "starred_url": "https://api.github.com/users/nluehr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nluehr/subscriptions", "organizations_url": "https://api.github.com/users/nluehr/orgs", "repos_url": "https://api.github.com/users/nluehr/repos", "events_url": "https://api.github.com/users/nluehr/events{/privacy}", "received_events_url": "https://api.github.com/users/nluehr/received_events", "type": "User", "site_admin": false}, "body": "Done.", "created_at": "2017-10-27T22:31:14Z", "updated_at": "2017-11-08T17:01:09Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/13388#discussion_r147529823", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13388", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/147529823"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/13388#discussion_r147529823"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13388"}}, "body_html": "<p>Done.</p>", "body_text": "Done.", "in_reply_to_id": 147498360}