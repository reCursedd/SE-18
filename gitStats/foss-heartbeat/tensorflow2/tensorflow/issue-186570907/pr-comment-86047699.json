{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/86047699", "pull_request_review_id": 6726349, "id": 86047699, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDg2MDQ3Njk5", "diff_hunk": "@@ -829,3 +829,64 @@ def _hessian_vector_product(ys, xs, v):\n \n   # Second backprop\n   return gradients(elemwise_products, xs)\n+\n+\n+def hessians(ys, xs, name=\"hessians\", colocate_gradients_with_ops=False, \n+            gate_gradients=False, aggregation_method=None):\n+  \"\"\"Constructs the Hessian of sum of `ys` with respect to `x` in `xs`.\n+\n+  `hessians()` adds ops to the graph to output the Hessian matrix of `ys` \n+  with respect to `xs`.  It returns a list of `Tensor` of length `len(xs)` \n+  where each tensor is the Hessian of `sum(ys)`. This function currently\n+  only supports evaluating the Hessian with respect to (a list of) one-\n+  dimensional tensors.\n+\n+  The Hessian is a matrix of second-order partial derivatives of a scalar\n+  tensor (see https://en.wikipedia.org/wiki/Hessian_matrix for more details).\n+\n+  Args:\n+    ys: A `Tensor` or list of tensors to be differentiated.\n+    xs: A `Tensor` or list of tensors to be used for differentiation.\n+    name: Optional name to use for grouping all the gradient ops together.\n+      defaults to 'hessians'.\n+    colocate_gradients_with_ops: See `gradients()` documentation for details.\n+    gate_gradients: See `gradients()` documentation for details.\n+    aggregation_method: See `gradients()` documentation for details.\n+\n+  Returns:\n+    A list of Hessian matrices of `sum(y)` for each `x` in `xs`.\n+\n+  Raises:\n+    LookupError: if one of the operations between `xs` and `ys` does not\n+      have a registered gradient function.\n+    ValueError: if the arguments are invalid or not supported. Currently,\n+      this function only supports one-dimensional `x` in `xs`.\n+  \"\"\"\n+  xs = _AsList(xs)\n+  kwargs = {\n+      'colocate_gradients_with_ops': colocate_gradients_with_ops,\n+      'gate_gradients': gate_gradients,\n+      'aggregation_method': aggregation_method\n+    }\n+  # Compute a hessian matrix for each x in xs\n+  hessians = []\n+  for x in xs:\n+    # Check dimensions\n+    ndims = x.get_shape().ndims\n+    if ndims is None:\n+      raise ValueError('cannot compute Hessian because the dimensionality of ' \\\n+                       '`x` cannot be determined')\n+    elif ndims != 1:\n+      raise ValueError('computing hessians is currently only supported for ' \\\n+                       'one-dimensional tensors')\n+    # Compute the partial derivatives of the input with respect to all \n+    # elements of `x`\n+    _gradients = gradients(ys, x, **kwargs)[0]\n+    # Unpack the gradients into a list so we can take derivatives with \n+    # respect to each element\n+    _gradients = array_ops.unpack(_gradients)\n+    # Compute the partial derivatives with respect to each element of the list\n+    _hess = [gradients(_gradient, x, **kwargs)[0] for _gradient in _gradients]\n+    # Pack the list into a matrix and add to the list of hessians\n+    hessians.append(array_ops.pack(_hess, name=name))", "path": "tensorflow/python/ops/gradients.py", "position": null, "original_position": 72, "commit_id": "dd4fe4e3da2def7fa04ae4e8e503ee86de014be8", "original_commit_id": "eae3fd56089dd8fbe20c2a41f8ac84cd330f775d", "user": {"login": "tillahoffmann", "id": 966348, "node_id": "MDQ6VXNlcjk2NjM0OA==", "avatar_url": "https://avatars2.githubusercontent.com/u/966348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tillahoffmann", "html_url": "https://github.com/tillahoffmann", "followers_url": "https://api.github.com/users/tillahoffmann/followers", "following_url": "https://api.github.com/users/tillahoffmann/following{/other_user}", "gists_url": "https://api.github.com/users/tillahoffmann/gists{/gist_id}", "starred_url": "https://api.github.com/users/tillahoffmann/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tillahoffmann/subscriptions", "organizations_url": "https://api.github.com/users/tillahoffmann/orgs", "repos_url": "https://api.github.com/users/tillahoffmann/repos", "events_url": "https://api.github.com/users/tillahoffmann/events{/privacy}", "received_events_url": "https://api.github.com/users/tillahoffmann/received_events", "type": "User", "site_admin": false}, "body": "I think this works because tensorflow will rename the operations when they clash. E.g. changing the line in the tests to `hessians(quadratic, [x, x])` gives me\n\n``` python\n[<tf.Tensor 'hessians_1:0' shape=(4, 4) dtype=float32>,\n <tf.Tensor 'hessians_2:0' shape=(4, 4) dtype=float32>]\n```\n\nWill double check and extend the tests.\n", "created_at": "2016-11-01T23:33:26Z", "updated_at": "2016-11-02T17:10:25Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/5329#discussion_r86047699", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/5329", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/86047699"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/5329#discussion_r86047699"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/5329"}}, "body_html": "<p>I think this works because tensorflow will rename the operations when they clash. E.g. changing the line in the tests to <code>hessians(quadratic, [x, x])</code> gives me</p>\n<div class=\"highlight highlight-source-python\"><pre>[<span class=\"pl-k\">&lt;</span>tf.Tensor <span class=\"pl-s\"><span class=\"pl-pds\">'</span>hessians_1:0<span class=\"pl-pds\">'</span></span> shape=(<span class=\"pl-c1\">4</span>, <span class=\"pl-c1\">4</span>) dtype=float32<span class=\"pl-k\">&gt;</span>,\n <span class=\"pl-k\">&lt;</span>tf.Tensor <span class=\"pl-s\"><span class=\"pl-pds\">'</span>hessians_2:0<span class=\"pl-pds\">'</span></span> shape=(<span class=\"pl-c1\">4</span>, <span class=\"pl-c1\">4</span>) dtype=float32<span class=\"pl-k\">&gt;</span>]</pre></div>\n<p>Will double check and extend the tests.</p>", "body_text": "I think this works because tensorflow will rename the operations when they clash. E.g. changing the line in the tests to hessians(quadratic, [x, x]) gives me\n[<tf.Tensor 'hessians_1:0' shape=(4, 4) dtype=float32>,\n <tf.Tensor 'hessians_2:0' shape=(4, 4) dtype=float32>]\nWill double check and extend the tests.", "in_reply_to_id": 86040726}