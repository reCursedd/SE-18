{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/306411534", "html_url": "https://github.com/tensorflow/tensorflow/pull/10276#issuecomment-306411534", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10276", "id": 306411534, "node_id": "MDEyOklzc3VlQ29tbWVudDMwNjQxMTUzNA==", "user": {"login": "sjperkins", "id": 3530212, "node_id": "MDQ6VXNlcjM1MzAyMTI=", "avatar_url": "https://avatars3.githubusercontent.com/u/3530212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sjperkins", "html_url": "https://github.com/sjperkins", "followers_url": "https://api.github.com/users/sjperkins/followers", "following_url": "https://api.github.com/users/sjperkins/following{/other_user}", "gists_url": "https://api.github.com/users/sjperkins/gists{/gist_id}", "starred_url": "https://api.github.com/users/sjperkins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sjperkins/subscriptions", "organizations_url": "https://api.github.com/users/sjperkins/orgs", "repos_url": "https://api.github.com/users/sjperkins/repos", "events_url": "https://api.github.com/users/sjperkins/events{/privacy}", "received_events_url": "https://api.github.com/users/sjperkins/received_events", "type": "User", "site_admin": false}, "created_at": "2017-06-06T07:59:29Z", "updated_at": "2017-06-06T08:13:25Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I ran <code>stage_op_test.py</code> 1000 times and saw no failures. One thing that immediately came to mind was that <a href=\"https://github.com/tensorflow/tensorflow/blob/2eac53d5ea540b0b09326ba9330b6051d742532d/tensorflow/python/framework/test_util.py#L368-L377\">test_util.test_session</a> states that test sessions are re-used unless an explicit graph is provided:</p>\n<div class=\"highlight highlight-source-python\"><pre>Returns a TensorFlow Session <span class=\"pl-k\">for</span> use <span class=\"pl-k\">in</span> executing tests.\n    This method should be used <span class=\"pl-k\">for</span> <span class=\"pl-c1\">all</span> functional tests.\n    This method behaves different than session.Session: <span class=\"pl-k\">for</span> performance reasons\n    <span class=\"pl-bu\">`test_session`</span> will by default (<span class=\"pl-k\">if</span> <span class=\"pl-bu\">`graph`</span> <span class=\"pl-k\">is</span> <span class=\"pl-c1\">None</span>) reuse the same session\n    across tests. This means you may want to either call the function\n    <span class=\"pl-bu\">`reset_default_graph()`</span> before tests, <span class=\"pl-k\">or</span> <span class=\"pl-k\">if</span> creating an explicit new graph,\n    <span class=\"pl-k\">pass</span> it here (simply setting it <span class=\"pl-k\">with</span> <span class=\"pl-bu\">`as_default()`</span> won<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t do it), which will<span class=\"pl-ii\"></span></span>\n    trigger the creation of a new session.</pre></div>\n<p>I've:</p>\n<ol>\n<li>modified all the tests cases to explicitly create and finalize the compute graph (and hence recreate the Session in each case).</li>\n<li>Separated some test cases that involved multiple graphs and sessions into separate tests.</li>\n</ol>\n<p>I'll do some more test runs overnight (GMT +2) and see if I can reproduce any hangs.</p>", "body_text": "I ran stage_op_test.py 1000 times and saw no failures. One thing that immediately came to mind was that test_util.test_session states that test sessions are re-used unless an explicit graph is provided:\nReturns a TensorFlow Session for use in executing tests.\n    This method should be used for all functional tests.\n    This method behaves different than session.Session: for performance reasons\n    `test_session` will by default (if `graph` is None) reuse the same session\n    across tests. This means you may want to either call the function\n    `reset_default_graph()` before tests, or if creating an explicit new graph,\n    pass it here (simply setting it with `as_default()` won't do it), which will\n    trigger the creation of a new session.\nI've:\n\nmodified all the tests cases to explicitly create and finalize the compute graph (and hence recreate the Session in each case).\nSeparated some test cases that involved multiple graphs and sessions into separate tests.\n\nI'll do some more test runs overnight (GMT +2) and see if I can reproduce any hangs.", "body": "I ran `stage_op_test.py` 1000 times and saw no failures. One thing that immediately came to mind was that [test_util.test_session](https://github.com/tensorflow/tensorflow/blob/2eac53d5ea540b0b09326ba9330b6051d742532d/tensorflow/python/framework/test_util.py#L368-L377) states that test sessions are re-used unless an explicit graph is provided:\r\n\r\n```python\r\nReturns a TensorFlow Session for use in executing tests.\r\n    This method should be used for all functional tests.\r\n    This method behaves different than session.Session: for performance reasons\r\n    `test_session` will by default (if `graph` is None) reuse the same session\r\n    across tests. This means you may want to either call the function\r\n    `reset_default_graph()` before tests, or if creating an explicit new graph,\r\n    pass it here (simply setting it with `as_default()` won't do it), which will\r\n    trigger the creation of a new session.\r\n```\r\n\r\nI've:\r\n\r\n1. modified all the tests cases to explicitly create and finalize the compute graph (and hence recreate the Session in each case).\r\n2. Separated some test cases that involved multiple graphs and sessions into separate tests.\r\n\r\nI'll do some more test runs overnight (GMT +2) and see if I can reproduce any hangs."}