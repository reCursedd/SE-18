{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21421", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21421/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21421/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21421/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21421", "id": 348092926, "node_id": "MDU6SXNzdWUzNDgwOTI5MjY=", "number": 21421, "title": "Android: cannot find -lpthread for simple binary", "user": {"login": "gibiansky", "id": 1865411, "node_id": "MDQ6VXNlcjE4NjU0MTE=", "avatar_url": "https://avatars3.githubusercontent.com/u/1865411?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gibiansky", "html_url": "https://github.com/gibiansky", "followers_url": "https://api.github.com/users/gibiansky/followers", "following_url": "https://api.github.com/users/gibiansky/following{/other_user}", "gists_url": "https://api.github.com/users/gibiansky/gists{/gist_id}", "starred_url": "https://api.github.com/users/gibiansky/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gibiansky/subscriptions", "organizations_url": "https://api.github.com/users/gibiansky/orgs", "repos_url": "https://api.github.com/users/gibiansky/repos", "events_url": "https://api.github.com/users/gibiansky/events{/privacy}", "received_events_url": "https://api.github.com/users/gibiansky/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586558, "node_id": "MDU6TGFiZWw0MDQ1ODY1NTg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:community%20support", "name": "stat:community support", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "shivaniag", "id": 16565716, "node_id": "MDQ6VXNlcjE2NTY1NzE2", "avatar_url": "https://avatars1.githubusercontent.com/u/16565716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shivaniag", "html_url": "https://github.com/shivaniag", "followers_url": "https://api.github.com/users/shivaniag/followers", "following_url": "https://api.github.com/users/shivaniag/following{/other_user}", "gists_url": "https://api.github.com/users/shivaniag/gists{/gist_id}", "starred_url": "https://api.github.com/users/shivaniag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shivaniag/subscriptions", "organizations_url": "https://api.github.com/users/shivaniag/orgs", "repos_url": "https://api.github.com/users/shivaniag/repos", "events_url": "https://api.github.com/users/shivaniag/events{/privacy}", "received_events_url": "https://api.github.com/users/shivaniag/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "shivaniag", "id": 16565716, "node_id": "MDQ6VXNlcjE2NTY1NzE2", "avatar_url": "https://avatars1.githubusercontent.com/u/16565716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shivaniag", "html_url": "https://github.com/shivaniag", "followers_url": "https://api.github.com/users/shivaniag/followers", "following_url": "https://api.github.com/users/shivaniag/following{/other_user}", "gists_url": "https://api.github.com/users/shivaniag/gists{/gist_id}", "starred_url": "https://api.github.com/users/shivaniag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shivaniag/subscriptions", "organizations_url": "https://api.github.com/users/shivaniag/orgs", "repos_url": "https://api.github.com/users/shivaniag/repos", "events_url": "https://api.github.com/users/shivaniag/events{/privacy}", "received_events_url": "https://api.github.com/users/shivaniag/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2018-08-06T21:45:45Z", "updated_at": "2018-08-10T21:41:52Z", "closed_at": "2018-08-10T21:41:52Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I'm trying to compile a simple application for Android and getting linker errors: Bazel is linking in <code>-lpthread</code>, even though Android doesn't support that.</p>\n<p>The application code is as follows:</p>\n<p><em>tensorflow/demo-bug/main.cc</em>:</p>\n<pre><code>int main() {\n  return 0;\n}\n</code></pre>\n<p>The BUILD file is as follows:</p>\n<p><em>tensorflow/demo-bug/BUILD</em>:</p>\n<pre><code>cc_binary(\n    name = \"main\",\n    srcs = [\"main.cc\"],\n    deps = [\"//tensorflow/core:core_cpu\"],\n)\n</code></pre>\n<p>If you don't include <code>//tensorflow/core:core_cpu</code> in the <code>deps</code>, the error doesn't happen. For some reason, that dependency pulls in the <code>-lpthread</code> from somewhere.</p>\n<p>When you run the <code>bazel build</code> command (see below), you get the following error:</p>\n<pre><code>external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: cannot find -lpthread\n</code></pre>\n<p>Indeed, looking through the command that it uses to compile it, you see the flag:</p>\n<pre><code>...-stl/llvm-libc++/libs/armeabi-v7a/libunwind.a -ldl -lm -ldl -lpthread -lm -pthread -lm -lm -static-libgcc -gcc-toolchain external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -no-canonical-prefixes ...\n</code></pre>\n<p>(Full command below)</p>\n<pre><code>  external/androidndk/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang -o bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/demo-bug/main bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/demo-bug/_objs/main/tensorflow/demo-bug/main.o -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_internal.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmeta_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libarithmetic_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libgraph_optimizer_stage.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libauto_parallel.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libcustom_graph_optimizer_registry_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libdebug_stripper.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libdependency_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libfunction_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/liblayout_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libloop_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmemory_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libstatic_schedule.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libgraph_memory.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libvirtual_cluster.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libop_level_cost_estimator.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libvirtual_scheduler.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libvirtual_placer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libdevices.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libtraversal.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmodel_pruner.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libgraph_rewriter.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libremapper.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libconstant_folding.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libscoped_allocator_optimizer.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libscoped_allocator_ops_op_lib.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libshape_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libsymbolic_shapes.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libgraph_properties.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libutils.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libutils.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libgpu_id_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libgraph_view.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libcluster.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libframe.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_base.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunction_ops_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunctional_grad.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunctional_ops_op_lib.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libcolocation.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libfunctions.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libtopological_sort.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/kernels/libno_op.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/kernels/libsendrecv_ops.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libno_op_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libsendrecv_ops_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_impl.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libgraph.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libgrappler_item.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libop_types.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libutils.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libframework_internal_impl.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libprotos_all_proto_text.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liberror_codes_proto_text.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_internal_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_hash_crc32c_accelerate_internal.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_proto_parsing.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libabi.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_stringpiece.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libplatform_base.a bazel-out/armeabi-v7a-py3-opt/bin/external/snappy/libsnappy.a bazel-out/armeabi-v7a-py3-opt/bin/external/double_conversion/libdouble-conversion.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libop_performance_data_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libversion_lib.a bazel-out/armeabi-v7a-py3-opt/bin/external/gif_archive/libgif.a bazel-out/armeabi-v7a-py3-opt/bin/external/jpeg/libjpeg.a bazel-out/armeabi-v7a-py3-opt/bin/external/jpeg/libsimd_armv7a.a bazel-out/armeabi-v7a-py3-opt/bin/external/com_googlesource_code_re2/libre2.a bazel-out/armeabi-v7a-py3-opt/bin/external/farmhash_archive/libfarmhash.a bazel-out/armeabi-v7a-py3-opt/bin/external/fft2d/libfft2d.a bazel-out/armeabi-v7a-py3-opt/bin/external/highwayhash/libsip_hash.a bazel-out/armeabi-v7a-py3-opt/bin/external/highwayhash/libarch_specific.a bazel-out/armeabi-v7a-py3-opt/bin/external/png_archive/libpng.a bazel-out/armeabi-v7a-py3-opt/bin/external/zlib_archive/libzlib.a bazel-out/armeabi-v7a-py3-opt/bin/external/nsync/libnsync_cpp.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libprotos_all_proto_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liberror_codes_proto_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/external/protobuf_archive/libprotobuf.a bazel-out/armeabi-v7a-py3-opt/bin/external/protobuf_archive/libprotobuf_lite.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libandroid_support.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++_static.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++abi.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libunwind.a -ldl -lm -ldl -lpthread -lm -pthread -lm -lm -static-libgcc -gcc-toolchain external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -no-canonical-prefixes -target armv7-none-linux-androideabi -Wl,--fix-cortex-a8 -Lexternal/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a '--sysroot=external/androidndk/ndk/platforms/android-23/arch-arm')\n</code></pre>\n<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes, see above</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Ubuntu 16.04</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>: N/A</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: Source</li>\n<li><strong>TensorFlow version (use command below)</strong>: v1.9.0 (git tag)</li>\n<li><strong>Python version</strong>: 3.5</li>\n<li><strong>Bazel version (if compiling from source)</strong>: 0.15.2</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: Android NDK r17b</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<pre><code># ARM v7\nbazel \\\n  --crosstool_top=//external:android/crosstool \\\n  --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \\\n  --config=android \\\n  --cpu=armeabi-v7a \\\n  --fat_apk_cpu=armeabi-v7a \\\n  --verbose_failures \\\n  --cxxopt=-std=c++11 \\\n  --config=monolithic \\\n  //tensorflow/demo-bug:main\n\n# ARM v8\nbazel \\\n  --crosstool_top=//external:android/crosstool \\\n  --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \\\n  --config=android \\\n  --cpu=arm64-v8a \\\n  --fat_apk_cpu=arm64-v8a \\\n  --verbose_failures \\\n  --cxxopt=-std=c++11 \\\n  --config=monolithic \\\n  //tensorflow/demo-bug:main\n</code></pre>", "body_text": "I'm trying to compile a simple application for Android and getting linker errors: Bazel is linking in -lpthread, even though Android doesn't support that.\nThe application code is as follows:\ntensorflow/demo-bug/main.cc:\nint main() {\n  return 0;\n}\n\nThe BUILD file is as follows:\ntensorflow/demo-bug/BUILD:\ncc_binary(\n    name = \"main\",\n    srcs = [\"main.cc\"],\n    deps = [\"//tensorflow/core:core_cpu\"],\n)\n\nIf you don't include //tensorflow/core:core_cpu in the deps, the error doesn't happen. For some reason, that dependency pulls in the -lpthread from somewhere.\nWhen you run the bazel build command (see below), you get the following error:\nexternal/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: cannot find -lpthread\n\nIndeed, looking through the command that it uses to compile it, you see the flag:\n...-stl/llvm-libc++/libs/armeabi-v7a/libunwind.a -ldl -lm -ldl -lpthread -lm -pthread -lm -lm -static-libgcc -gcc-toolchain external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -no-canonical-prefixes ...\n\n(Full command below)\n  external/androidndk/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang -o bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/demo-bug/main bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/demo-bug/_objs/main/tensorflow/demo-bug/main.o -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_internal.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmeta_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libarithmetic_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libgraph_optimizer_stage.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libauto_parallel.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libcustom_graph_optimizer_registry_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libdebug_stripper.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libdependency_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libfunction_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/liblayout_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libloop_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmemory_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libstatic_schedule.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libgraph_memory.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libvirtual_cluster.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libop_level_cost_estimator.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libvirtual_scheduler.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libvirtual_placer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libdevices.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libtraversal.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmodel_pruner.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libgraph_rewriter.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libremapper.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libconstant_folding.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libscoped_allocator_optimizer.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libscoped_allocator_ops_op_lib.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libshape_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libsymbolic_shapes.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libgraph_properties.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libutils.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libutils.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libgpu_id_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libgraph_view.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libcluster.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libframe.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_base.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunction_ops_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunctional_grad.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunctional_ops_op_lib.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libcolocation.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libfunctions.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libtopological_sort.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/kernels/libno_op.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/kernels/libsendrecv_ops.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libno_op_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libsendrecv_ops_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_impl.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libgraph.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libgrappler_item.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libop_types.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libutils.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libframework_internal_impl.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libprotos_all_proto_text.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liberror_codes_proto_text.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_internal_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_hash_crc32c_accelerate_internal.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_proto_parsing.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libabi.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_stringpiece.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libplatform_base.a bazel-out/armeabi-v7a-py3-opt/bin/external/snappy/libsnappy.a bazel-out/armeabi-v7a-py3-opt/bin/external/double_conversion/libdouble-conversion.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libop_performance_data_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libversion_lib.a bazel-out/armeabi-v7a-py3-opt/bin/external/gif_archive/libgif.a bazel-out/armeabi-v7a-py3-opt/bin/external/jpeg/libjpeg.a bazel-out/armeabi-v7a-py3-opt/bin/external/jpeg/libsimd_armv7a.a bazel-out/armeabi-v7a-py3-opt/bin/external/com_googlesource_code_re2/libre2.a bazel-out/armeabi-v7a-py3-opt/bin/external/farmhash_archive/libfarmhash.a bazel-out/armeabi-v7a-py3-opt/bin/external/fft2d/libfft2d.a bazel-out/armeabi-v7a-py3-opt/bin/external/highwayhash/libsip_hash.a bazel-out/armeabi-v7a-py3-opt/bin/external/highwayhash/libarch_specific.a bazel-out/armeabi-v7a-py3-opt/bin/external/png_archive/libpng.a bazel-out/armeabi-v7a-py3-opt/bin/external/zlib_archive/libzlib.a bazel-out/armeabi-v7a-py3-opt/bin/external/nsync/libnsync_cpp.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libprotos_all_proto_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liberror_codes_proto_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/external/protobuf_archive/libprotobuf.a bazel-out/armeabi-v7a-py3-opt/bin/external/protobuf_archive/libprotobuf_lite.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libandroid_support.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++_static.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++abi.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libunwind.a -ldl -lm -ldl -lpthread -lm -pthread -lm -lm -static-libgcc -gcc-toolchain external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -no-canonical-prefixes -target armv7-none-linux-androideabi -Wl,--fix-cortex-a8 -Lexternal/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a '--sysroot=external/androidndk/ndk/platforms/android-23/arch-arm')\n\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes, see above\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: N/A\nTensorFlow installed from (source or binary): Source\nTensorFlow version (use command below): v1.9.0 (git tag)\nPython version: 3.5\nBazel version (if compiling from source): 0.15.2\nGCC/Compiler version (if compiling from source): Android NDK r17b\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A\nExact command to reproduce:\n\n# ARM v7\nbazel \\\n  --crosstool_top=//external:android/crosstool \\\n  --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \\\n  --config=android \\\n  --cpu=armeabi-v7a \\\n  --fat_apk_cpu=armeabi-v7a \\\n  --verbose_failures \\\n  --cxxopt=-std=c++11 \\\n  --config=monolithic \\\n  //tensorflow/demo-bug:main\n\n# ARM v8\nbazel \\\n  --crosstool_top=//external:android/crosstool \\\n  --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \\\n  --config=android \\\n  --cpu=arm64-v8a \\\n  --fat_apk_cpu=arm64-v8a \\\n  --verbose_failures \\\n  --cxxopt=-std=c++11 \\\n  --config=monolithic \\\n  //tensorflow/demo-bug:main", "body": "I'm trying to compile a simple application for Android and getting linker errors: Bazel is linking in `-lpthread`, even though Android doesn't support that.\r\n\r\nThe application code is as follows:\r\n\r\n*tensorflow/demo-bug/main.cc*:\r\n```\r\nint main() {\r\n  return 0;\r\n}\r\n```\r\n\r\nThe BUILD file is as follows:\r\n\r\n*tensorflow/demo-bug/BUILD*:\r\n```\r\ncc_binary(\r\n    name = \"main\",\r\n    srcs = [\"main.cc\"],\r\n    deps = [\"//tensorflow/core:core_cpu\"],\r\n)\r\n```\r\n\r\nIf you don't include `//tensorflow/core:core_cpu` in the `deps`, the error doesn't happen. For some reason, that dependency pulls in the `-lpthread` from somewhere.\r\n\r\nWhen you run the `bazel build` command (see below), you get the following error:\r\n```\r\nexternal/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: cannot find -lpthread\r\n```\r\nIndeed, looking through the command that it uses to compile it, you see the flag:\r\n```\r\n...-stl/llvm-libc++/libs/armeabi-v7a/libunwind.a -ldl -lm -ldl -lpthread -lm -pthread -lm -lm -static-libgcc -gcc-toolchain external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -no-canonical-prefixes ...\r\n```\r\n(Full command below)\r\n```\r\n  external/androidndk/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang -o bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/demo-bug/main bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/demo-bug/_objs/main/tensorflow/demo-bug/main.o -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_internal.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmeta_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libarithmetic_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libgraph_optimizer_stage.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libauto_parallel.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libcustom_graph_optimizer_registry_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libdebug_stripper.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libdependency_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libfunction_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/liblayout_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libloop_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmemory_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libstatic_schedule.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libgraph_memory.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libvirtual_cluster.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libop_level_cost_estimator.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libvirtual_scheduler.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libvirtual_placer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libdevices.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libtraversal.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libmodel_pruner.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libgraph_rewriter.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libremapper.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libconstant_folding.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libscoped_allocator_optimizer.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libscoped_allocator_ops_op_lib.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libshape_optimizer.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/optimizers/libsymbolic_shapes.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libgraph_properties.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libutils.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libutils.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libgpu_id_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libgraph_view.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/clusters/libcluster.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libframe.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_base.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunction_ops_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunctional_grad.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libfunctional_ops_op_lib.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libcolocation.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libfunctions.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/utils/libtopological_sort.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/kernels/libno_op.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/kernels/libsendrecv_ops.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libno_op_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libsendrecv_ops_op_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_cpu_impl.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libgraph.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libgrappler_item.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libop_types.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/libutils.a -Wl,-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libframework_internal_impl.lo -Wl,-no-whole-archive bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libprotos_all_proto_text.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liberror_codes_proto_text.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_internal_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_hash_crc32c_accelerate_internal.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liblib_proto_parsing.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libabi.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libcore_stringpiece.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libplatform_base.a bazel-out/armeabi-v7a-py3-opt/bin/external/snappy/libsnappy.a bazel-out/armeabi-v7a-py3-opt/bin/external/double_conversion/libdouble-conversion.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/grappler/costs/libop_performance_data_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libversion_lib.a bazel-out/armeabi-v7a-py3-opt/bin/external/gif_archive/libgif.a bazel-out/armeabi-v7a-py3-opt/bin/external/jpeg/libjpeg.a bazel-out/armeabi-v7a-py3-opt/bin/external/jpeg/libsimd_armv7a.a bazel-out/armeabi-v7a-py3-opt/bin/external/com_googlesource_code_re2/libre2.a bazel-out/armeabi-v7a-py3-opt/bin/external/farmhash_archive/libfarmhash.a bazel-out/armeabi-v7a-py3-opt/bin/external/fft2d/libfft2d.a bazel-out/armeabi-v7a-py3-opt/bin/external/highwayhash/libsip_hash.a bazel-out/armeabi-v7a-py3-opt/bin/external/highwayhash/libarch_specific.a bazel-out/armeabi-v7a-py3-opt/bin/external/png_archive/libpng.a bazel-out/armeabi-v7a-py3-opt/bin/external/zlib_archive/libzlib.a bazel-out/armeabi-v7a-py3-opt/bin/external/nsync/libnsync_cpp.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/libprotos_all_proto_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/tensorflow/core/liberror_codes_proto_cc_impl.a bazel-out/armeabi-v7a-py3-opt/bin/external/protobuf_archive/libprotobuf.a bazel-out/armeabi-v7a-py3-opt/bin/external/protobuf_archive/libprotobuf_lite.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libandroid_support.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++_static.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libc++abi.a external/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/libunwind.a -ldl -lm -ldl -lpthread -lm -pthread -lm -lm -static-libgcc -gcc-toolchain external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -no-canonical-prefixes -target armv7-none-linux-androideabi -Wl,--fix-cortex-a8 -Lexternal/androidndk/ndk/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a '--sysroot=external/androidndk/ndk/platforms/android-23/arch-arm')\r\n```\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes, see above\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 16.04\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**: N/A\r\n- **TensorFlow installed from (source or binary)**: Source\r\n- **TensorFlow version (use command below)**: v1.9.0 (git tag)\r\n- **Python version**: 3.5\r\n- **Bazel version (if compiling from source)**: 0.15.2\r\n- **GCC/Compiler version (if compiling from source)**: Android NDK r17b\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Exact command to reproduce**:\r\n```\r\n# ARM v7\r\nbazel \\\r\n  --crosstool_top=//external:android/crosstool \\\r\n  --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \\\r\n  --config=android \\\r\n  --cpu=armeabi-v7a \\\r\n  --fat_apk_cpu=armeabi-v7a \\\r\n  --verbose_failures \\\r\n  --cxxopt=-std=c++11 \\\r\n  --config=monolithic \\\r\n  //tensorflow/demo-bug:main\r\n\r\n# ARM v8\r\nbazel \\\r\n  --crosstool_top=//external:android/crosstool \\\r\n  --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \\\r\n  --config=android \\\r\n  --cpu=arm64-v8a \\\r\n  --fat_apk_cpu=arm64-v8a \\\r\n  --verbose_failures \\\r\n  --cxxopt=-std=c++11 \\\r\n  --config=monolithic \\\r\n  //tensorflow/demo-bug:main\r\n```"}