{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/274438845", "html_url": "https://github.com/tensorflow/tensorflow/pull/7012#issuecomment-274438845", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7012", "id": 274438845, "node_id": "MDEyOklzc3VlQ29tbWVudDI3NDQzODg0NQ==", "user": {"login": "gaohuazuo", "id": 10446514, "node_id": "MDQ6VXNlcjEwNDQ2NTE0", "avatar_url": "https://avatars0.githubusercontent.com/u/10446514?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gaohuazuo", "html_url": "https://github.com/gaohuazuo", "followers_url": "https://api.github.com/users/gaohuazuo/followers", "following_url": "https://api.github.com/users/gaohuazuo/following{/other_user}", "gists_url": "https://api.github.com/users/gaohuazuo/gists{/gist_id}", "starred_url": "https://api.github.com/users/gaohuazuo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gaohuazuo/subscriptions", "organizations_url": "https://api.github.com/users/gaohuazuo/orgs", "repos_url": "https://api.github.com/users/gaohuazuo/repos", "events_url": "https://api.github.com/users/gaohuazuo/events{/privacy}", "received_events_url": "https://api.github.com/users/gaohuazuo/received_events", "type": "User", "site_admin": false}, "created_at": "2017-01-23T09:32:54Z", "updated_at": "2017-01-23T09:32:54Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Gradient registered in python api only. I found no existing python test for the gradient of <code>identity</code>, so I didn't create one for <code>placeholder_with_default</code> (manual test seems ok).</p>\n<p>I also tried to register the gradient in c api, but I'm not sure how to do it. My attempt:</p>\n<pre><code>diff --git a/tensorflow/cc/gradients/array_grad_test.cc b/tensorflow/cc/gradients/array_grad_test.cc\nindex 2d6fabd..c91166f 100644\n--- a/tensorflow/cc/gradients/array_grad_test.cc\n+++ b/tensorflow/cc/gradients/array_grad_test.cc\n@@ -96,6 +96,13 @@ TEST_F(ArrayGradTest, IdentityGrad) {\n   RunTest(x, shape, y, shape);\n }\n \n+TEST_F(ArrayGradTest, PlaceholderWithDefaultGrad) {\n+  TensorShape shape({5, 2});\n+  auto x = Placeholder(scope_, DT_FLOAT, Placeholder::Shape(shape));\n+  auto y = PlaceholderWithDefault(scope_, x, TensorShape());\n+  RunTest(x, shape, y, shape);\n+}\n+\n TEST_F(ArrayGradTest, SplitGrad) {\n   TensorShape x_shape({5, 2});\n   auto x = Placeholder(scope_, DT_FLOAT, Placeholder::Shape(x_shape));\n\ndiff --git a/tensorflow/core/ops/array_grad.cc b/tensorflow/core/ops/array_grad.cc\nindex 2894e3c..844585b 100644\n--- a/tensorflow/core/ops/array_grad.cc\n+++ b/tensorflow/core/ops/array_grad.cc\n@@ -87,6 +87,7 @@ Status IdentityGrad(const AttrSlice&amp; attrs, FunctionDef* g) {\n   return Status::OK();\n }\n REGISTER_OP_GRADIENT(\"Identity\", IdentityGrad);\n+REGISTER_OP_GRADIENT(\"PlaceholderWithDefault\", IdentityGrad);\n \n Status PackGrad(const AttrSlice&amp; attrs, FunctionDef* g) {\n   // clang-format off\n</code></pre>\n<p><code>//tensorflow/cc:gradients_array_grad_test</code> reports the following error:</p>\n<pre><code>tensorflow/cc/gradients/array_grad_test.cc:38: Failure\nValue of: (ComputeGradientError(scope_, {x}, {x_shape}, {y}, {y_shape}, &amp;max_error))\n  Actual: Not found: No gradient defined for op: PlaceholderWithDefault\nExpected: ::tensorflow::Status::OK()\n</code></pre>", "body_text": "Gradient registered in python api only. I found no existing python test for the gradient of identity, so I didn't create one for placeholder_with_default (manual test seems ok).\nI also tried to register the gradient in c api, but I'm not sure how to do it. My attempt:\ndiff --git a/tensorflow/cc/gradients/array_grad_test.cc b/tensorflow/cc/gradients/array_grad_test.cc\nindex 2d6fabd..c91166f 100644\n--- a/tensorflow/cc/gradients/array_grad_test.cc\n+++ b/tensorflow/cc/gradients/array_grad_test.cc\n@@ -96,6 +96,13 @@ TEST_F(ArrayGradTest, IdentityGrad) {\n   RunTest(x, shape, y, shape);\n }\n \n+TEST_F(ArrayGradTest, PlaceholderWithDefaultGrad) {\n+  TensorShape shape({5, 2});\n+  auto x = Placeholder(scope_, DT_FLOAT, Placeholder::Shape(shape));\n+  auto y = PlaceholderWithDefault(scope_, x, TensorShape());\n+  RunTest(x, shape, y, shape);\n+}\n+\n TEST_F(ArrayGradTest, SplitGrad) {\n   TensorShape x_shape({5, 2});\n   auto x = Placeholder(scope_, DT_FLOAT, Placeholder::Shape(x_shape));\n\ndiff --git a/tensorflow/core/ops/array_grad.cc b/tensorflow/core/ops/array_grad.cc\nindex 2894e3c..844585b 100644\n--- a/tensorflow/core/ops/array_grad.cc\n+++ b/tensorflow/core/ops/array_grad.cc\n@@ -87,6 +87,7 @@ Status IdentityGrad(const AttrSlice& attrs, FunctionDef* g) {\n   return Status::OK();\n }\n REGISTER_OP_GRADIENT(\"Identity\", IdentityGrad);\n+REGISTER_OP_GRADIENT(\"PlaceholderWithDefault\", IdentityGrad);\n \n Status PackGrad(const AttrSlice& attrs, FunctionDef* g) {\n   // clang-format off\n\n//tensorflow/cc:gradients_array_grad_test reports the following error:\ntensorflow/cc/gradients/array_grad_test.cc:38: Failure\nValue of: (ComputeGradientError(scope_, {x}, {x_shape}, {y}, {y_shape}, &max_error))\n  Actual: Not found: No gradient defined for op: PlaceholderWithDefault\nExpected: ::tensorflow::Status::OK()", "body": "Gradient registered in python api only. I found no existing python test for the gradient of `identity`, so I didn't create one for `placeholder_with_default` (manual test seems ok).\r\n\r\nI also tried to register the gradient in c api, but I'm not sure how to do it. My attempt:\r\n\r\n```\r\ndiff --git a/tensorflow/cc/gradients/array_grad_test.cc b/tensorflow/cc/gradients/array_grad_test.cc\r\nindex 2d6fabd..c91166f 100644\r\n--- a/tensorflow/cc/gradients/array_grad_test.cc\r\n+++ b/tensorflow/cc/gradients/array_grad_test.cc\r\n@@ -96,6 +96,13 @@ TEST_F(ArrayGradTest, IdentityGrad) {\r\n   RunTest(x, shape, y, shape);\r\n }\r\n \r\n+TEST_F(ArrayGradTest, PlaceholderWithDefaultGrad) {\r\n+  TensorShape shape({5, 2});\r\n+  auto x = Placeholder(scope_, DT_FLOAT, Placeholder::Shape(shape));\r\n+  auto y = PlaceholderWithDefault(scope_, x, TensorShape());\r\n+  RunTest(x, shape, y, shape);\r\n+}\r\n+\r\n TEST_F(ArrayGradTest, SplitGrad) {\r\n   TensorShape x_shape({5, 2});\r\n   auto x = Placeholder(scope_, DT_FLOAT, Placeholder::Shape(x_shape));\r\n\r\ndiff --git a/tensorflow/core/ops/array_grad.cc b/tensorflow/core/ops/array_grad.cc\r\nindex 2894e3c..844585b 100644\r\n--- a/tensorflow/core/ops/array_grad.cc\r\n+++ b/tensorflow/core/ops/array_grad.cc\r\n@@ -87,6 +87,7 @@ Status IdentityGrad(const AttrSlice& attrs, FunctionDef* g) {\r\n   return Status::OK();\r\n }\r\n REGISTER_OP_GRADIENT(\"Identity\", IdentityGrad);\r\n+REGISTER_OP_GRADIENT(\"PlaceholderWithDefault\", IdentityGrad);\r\n \r\n Status PackGrad(const AttrSlice& attrs, FunctionDef* g) {\r\n   // clang-format off\r\n```\r\n\r\n`//tensorflow/cc:gradients_array_grad_test` reports the following error:\r\n\r\n```\r\ntensorflow/cc/gradients/array_grad_test.cc:38: Failure\r\nValue of: (ComputeGradientError(scope_, {x}, {x_shape}, {y}, {y_shape}, &max_error))\r\n  Actual: Not found: No gradient defined for op: PlaceholderWithDefault\r\nExpected: ::tensorflow::Status::OK()\r\n```"}