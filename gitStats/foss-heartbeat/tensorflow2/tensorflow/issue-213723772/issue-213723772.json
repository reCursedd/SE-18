{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8348", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8348/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8348/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8348/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/8348", "id": 213723772, "node_id": "MDU6SXNzdWUyMTM3MjM3NzI=", "number": 8348, "title": "Taking gradients after using SparseTensor in while_loop leads to TypeError", "user": {"login": "hhultin", "id": 21335863, "node_id": "MDQ6VXNlcjIxMzM1ODYz", "avatar_url": "https://avatars3.githubusercontent.com/u/21335863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hhultin", "html_url": "https://github.com/hhultin", "followers_url": "https://api.github.com/users/hhultin/followers", "following_url": "https://api.github.com/users/hhultin/following{/other_user}", "gists_url": "https://api.github.com/users/hhultin/gists{/gist_id}", "starred_url": "https://api.github.com/users/hhultin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hhultin/subscriptions", "organizations_url": "https://api.github.com/users/hhultin/orgs", "repos_url": "https://api.github.com/users/hhultin/repos", "events_url": "https://api.github.com/users/hhultin/events{/privacy}", "received_events_url": "https://api.github.com/users/hhultin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-03-13T10:17:28Z", "updated_at": "2017-06-16T19:18:14Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?</h3>\n<p>Found various issues on SparseTensors, but nothing about while loops and gradients.</p>\n<h3>Environment info</h3>\n<p>Operating System:<br>\nUbuntu 14.04</p>\n<p>Installed version of CUDA and cuDNN:<br>\nNone</p>\n<p>If installed from binary pip package, provide:</p>\n<ol>\n<li>\n<p>A link to the pip package you installed: <a href=\"https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.12.1-cp35-cp35m-linux_x86_64.whl\" rel=\"nofollow\">https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.12.1-cp35-cp35m-linux_x86_64.whl</a></p>\n</li>\n<li>\n<p>The output from <code>python -c \"import tensorflow; print(tensorflow.__version__)\"</code>:<br>\n0.12.1</p>\n</li>\n</ol>\n<h3>If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)</h3>\n<p>This code leads to the error (when trying to compute the gradients) <code>TypeError: Expected binary or unicode string, got &lt;tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x7fb966845f98&gt;</code></p>\n<pre><code>import tensorflow as tf\n\n\ndef body(A, b, x, i):\n    i += 1\n    b = b + tf.sparse_tensor_dense_matmul(A, x)\n    return A, b, x, i\n\n\ndef cond(A, b, x, i):\n    return i &lt; 5\n\n\nsess = tf.InteractiveSession()\nindices = [[0, 0], [1, 1]]\nvalues = [1., 1.]\nA = tf.SparseTensor(indices, values, (100, 100))\nx = tf.ones((100, 1))\nb = tf.zeros_like(x)\n[_, b, _, _] = tf.while_loop(cond, body, [A, b, x, tf.constant(0)])\ngrad = tf.gradients(b, x)\nprint(sess.run([grad]))\nsess.close()\n</code></pre>\n<h3>What other attempted solutions have you tried?</h3>\n<p>If <code>A</code> is removed as a loop variable everything works as expected:</p>\n<pre><code>import tensorflow as tf\n\n\ndef body(b, x, i):\n    i += 1\n    b = b + tf.sparse_tensor_dense_matmul(A, x)\n    return b, x, i\n\n\ndef cond(b, x, i):\n    return i &lt; 5\n\n\nsess = tf.InteractiveSession()\nindices = [[0, 0], [1, 1]]\nvalues = [1., 1.]\nA = tf.SparseTensor(indices, values, (100, 100))\nx = tf.ones((100, 1))\nb = tf.zeros_like(x)\n[b, _, _] = tf.while_loop(cond, body, [b, x, tf.constant(0)])\ngrad = tf.gradients(b, x)\nprint(sess.run([grad]))\nsess.close()\n</code></pre>\n<h3>Logs or other output that would be helpful</h3>\n<p>(If logs are large, please upload as attachment or provide link).</p>\n<pre><code>Traceback (most recent call last):\n  File \"sparse_tensor_gradient_error.py\", line 21, in &lt;module&gt;\n    grad = tf.gradients(b, x)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/gradients_impl.py\", line 427, in gradients\n    _SetGrad(grads, y, loop_state.ZerosLikeForExit(y))\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1165, in ZerosLikeForExit\n    result = array_ops.zeros_like(val, optimize=False)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/array_ops.py\", line 1471, in zeros_like\n    tensor = ops.convert_to_tensor(tensor, name=\"tensor\")\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 669, in convert_to_tensor\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/constant_op.py\", line 176, in _constant_tensor_conversion_function\n    return constant(v, dtype=dtype, name=name)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/constant_op.py\", line 165, in constant\n    tensor_util.make_tensor_proto(value, dtype=dtype, shape=shape, verify_shape=verify_shape))\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/tensor_util.py\", line 441, in make_tensor_proto\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/tensor_util.py\", line 441, in &lt;listcomp&gt;\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/util/compat.py\", line 65, in as_bytes\n    (bytes_or_text,))\nTypeError: Expected binary or unicode string, got &lt;tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x7fb966845f98&gt;\n</code></pre>", "body_text": "What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\nFound various issues on SparseTensors, but nothing about while loops and gradients.\nEnvironment info\nOperating System:\nUbuntu 14.04\nInstalled version of CUDA and cuDNN:\nNone\nIf installed from binary pip package, provide:\n\n\nA link to the pip package you installed: https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.12.1-cp35-cp35m-linux_x86_64.whl\n\n\nThe output from python -c \"import tensorflow; print(tensorflow.__version__)\":\n0.12.1\n\n\nIf possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\nThis code leads to the error (when trying to compute the gradients) TypeError: Expected binary or unicode string, got <tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x7fb966845f98>\nimport tensorflow as tf\n\n\ndef body(A, b, x, i):\n    i += 1\n    b = b + tf.sparse_tensor_dense_matmul(A, x)\n    return A, b, x, i\n\n\ndef cond(A, b, x, i):\n    return i < 5\n\n\nsess = tf.InteractiveSession()\nindices = [[0, 0], [1, 1]]\nvalues = [1., 1.]\nA = tf.SparseTensor(indices, values, (100, 100))\nx = tf.ones((100, 1))\nb = tf.zeros_like(x)\n[_, b, _, _] = tf.while_loop(cond, body, [A, b, x, tf.constant(0)])\ngrad = tf.gradients(b, x)\nprint(sess.run([grad]))\nsess.close()\n\nWhat other attempted solutions have you tried?\nIf A is removed as a loop variable everything works as expected:\nimport tensorflow as tf\n\n\ndef body(b, x, i):\n    i += 1\n    b = b + tf.sparse_tensor_dense_matmul(A, x)\n    return b, x, i\n\n\ndef cond(b, x, i):\n    return i < 5\n\n\nsess = tf.InteractiveSession()\nindices = [[0, 0], [1, 1]]\nvalues = [1., 1.]\nA = tf.SparseTensor(indices, values, (100, 100))\nx = tf.ones((100, 1))\nb = tf.zeros_like(x)\n[b, _, _] = tf.while_loop(cond, body, [b, x, tf.constant(0)])\ngrad = tf.gradients(b, x)\nprint(sess.run([grad]))\nsess.close()\n\nLogs or other output that would be helpful\n(If logs are large, please upload as attachment or provide link).\nTraceback (most recent call last):\n  File \"sparse_tensor_gradient_error.py\", line 21, in <module>\n    grad = tf.gradients(b, x)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/gradients_impl.py\", line 427, in gradients\n    _SetGrad(grads, y, loop_state.ZerosLikeForExit(y))\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1165, in ZerosLikeForExit\n    result = array_ops.zeros_like(val, optimize=False)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/array_ops.py\", line 1471, in zeros_like\n    tensor = ops.convert_to_tensor(tensor, name=\"tensor\")\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 669, in convert_to_tensor\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/constant_op.py\", line 176, in _constant_tensor_conversion_function\n    return constant(v, dtype=dtype, name=name)\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/constant_op.py\", line 165, in constant\n    tensor_util.make_tensor_proto(value, dtype=dtype, shape=shape, verify_shape=verify_shape))\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/tensor_util.py\", line 441, in make_tensor_proto\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/tensor_util.py\", line 441, in <listcomp>\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/util/compat.py\", line 65, in as_bytes\n    (bytes_or_text,))\nTypeError: Expected binary or unicode string, got <tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x7fb966845f98>", "body": "### What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\r\n\r\nFound various issues on SparseTensors, but nothing about while loops and gradients.\r\n\r\n\r\n### Environment info\r\nOperating System:\r\nUbuntu 14.04\r\n\r\nInstalled version of CUDA and cuDNN: \r\nNone\r\n\r\nIf installed from binary pip package, provide:\r\n\r\n1. A link to the pip package you installed: https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.12.1-cp35-cp35m-linux_x86_64.whl\r\n\r\n2. The output from `python -c \"import tensorflow; print(tensorflow.__version__)\"`: \r\n0.12.1\r\n\r\n### If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\r\n\r\nThis code leads to the error (when trying to compute the gradients) `TypeError: Expected binary or unicode string, got <tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x7fb966845f98>`\r\n```\r\nimport tensorflow as tf\r\n\r\n\r\ndef body(A, b, x, i):\r\n    i += 1\r\n    b = b + tf.sparse_tensor_dense_matmul(A, x)\r\n    return A, b, x, i\r\n\r\n\r\ndef cond(A, b, x, i):\r\n    return i < 5\r\n\r\n\r\nsess = tf.InteractiveSession()\r\nindices = [[0, 0], [1, 1]]\r\nvalues = [1., 1.]\r\nA = tf.SparseTensor(indices, values, (100, 100))\r\nx = tf.ones((100, 1))\r\nb = tf.zeros_like(x)\r\n[_, b, _, _] = tf.while_loop(cond, body, [A, b, x, tf.constant(0)])\r\ngrad = tf.gradients(b, x)\r\nprint(sess.run([grad]))\r\nsess.close()\r\n```\r\n\r\n### What other attempted solutions have you tried?\r\n\r\nIf `A` is removed as a loop variable everything works as expected:\r\n\r\n```\r\nimport tensorflow as tf\r\n\r\n\r\ndef body(b, x, i):\r\n    i += 1\r\n    b = b + tf.sparse_tensor_dense_matmul(A, x)\r\n    return b, x, i\r\n\r\n\r\ndef cond(b, x, i):\r\n    return i < 5\r\n\r\n\r\nsess = tf.InteractiveSession()\r\nindices = [[0, 0], [1, 1]]\r\nvalues = [1., 1.]\r\nA = tf.SparseTensor(indices, values, (100, 100))\r\nx = tf.ones((100, 1))\r\nb = tf.zeros_like(x)\r\n[b, _, _] = tf.while_loop(cond, body, [b, x, tf.constant(0)])\r\ngrad = tf.gradients(b, x)\r\nprint(sess.run([grad]))\r\nsess.close()\r\n```\r\n\r\n\r\n### Logs or other output that would be helpful\r\n(If logs are large, please upload as attachment or provide link).\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"sparse_tensor_gradient_error.py\", line 21, in <module>\r\n    grad = tf.gradients(b, x)\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/gradients_impl.py\", line 427, in gradients\r\n    _SetGrad(grads, y, loop_state.ZerosLikeForExit(y))\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1165, in ZerosLikeForExit\r\n    result = array_ops.zeros_like(val, optimize=False)\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/ops/array_ops.py\", line 1471, in zeros_like\r\n    tensor = ops.convert_to_tensor(tensor, name=\"tensor\")\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 669, in convert_to_tensor\r\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/constant_op.py\", line 176, in _constant_tensor_conversion_function\r\n    return constant(v, dtype=dtype, name=name)\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/constant_op.py\", line 165, in constant\r\n    tensor_util.make_tensor_proto(value, dtype=dtype, shape=shape, verify_shape=verify_shape))\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/tensor_util.py\", line 441, in make_tensor_proto\r\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/tensor_util.py\", line 441, in <listcomp>\r\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\r\n  File \"/home/y/anaconda3/lib/python3.5/site-packages/tensorflow/python/util/compat.py\", line 65, in as_bytes\r\n    (bytes_or_text,))\r\nTypeError: Expected binary or unicode string, got <tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x7fb966845f98>\r\n```\r\n"}