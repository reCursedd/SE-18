{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3541", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3541/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3541/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3541/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/3541", "id": 167996280, "node_id": "MDU6SXNzdWUxNjc5OTYyODA=", "number": 3541, "title": "Constant folding seems to cause error with ImmutableConst ops", "user": {"login": "petewarden", "id": 161459, "node_id": "MDQ6VXNlcjE2MTQ1OQ==", "avatar_url": "https://avatars0.githubusercontent.com/u/161459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petewarden", "html_url": "https://github.com/petewarden", "followers_url": "https://api.github.com/users/petewarden/followers", "following_url": "https://api.github.com/users/petewarden/following{/other_user}", "gists_url": "https://api.github.com/users/petewarden/gists{/gist_id}", "starred_url": "https://api.github.com/users/petewarden/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petewarden/subscriptions", "organizations_url": "https://api.github.com/users/petewarden/orgs", "repos_url": "https://api.github.com/users/petewarden/repos", "events_url": "https://api.github.com/users/petewarden/events{/privacy}", "received_events_url": "https://api.github.com/users/petewarden/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "keveman", "id": 229914, "node_id": "MDQ6VXNlcjIyOTkxNA==", "avatar_url": "https://avatars1.githubusercontent.com/u/229914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/keveman", "html_url": "https://github.com/keveman", "followers_url": "https://api.github.com/users/keveman/followers", "following_url": "https://api.github.com/users/keveman/following{/other_user}", "gists_url": "https://api.github.com/users/keveman/gists{/gist_id}", "starred_url": "https://api.github.com/users/keveman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/keveman/subscriptions", "organizations_url": "https://api.github.com/users/keveman/orgs", "repos_url": "https://api.github.com/users/keveman/repos", "events_url": "https://api.github.com/users/keveman/events{/privacy}", "received_events_url": "https://api.github.com/users/keveman/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "keveman", "id": 229914, "node_id": "MDQ6VXNlcjIyOTkxNA==", "avatar_url": "https://avatars1.githubusercontent.com/u/229914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/keveman", "html_url": "https://github.com/keveman", "followers_url": "https://api.github.com/users/keveman/followers", "following_url": "https://api.github.com/users/keveman/following{/other_user}", "gists_url": "https://api.github.com/users/keveman/gists{/gist_id}", "starred_url": "https://api.github.com/users/keveman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/keveman/subscriptions", "organizations_url": "https://api.github.com/users/keveman/orgs", "repos_url": "https://api.github.com/users/keveman/repos", "events_url": "https://api.github.com/users/keveman/events{/privacy}", "received_events_url": "https://api.github.com/users/keveman/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2016-07-28T01:53:19Z", "updated_at": "2017-01-23T23:10:01Z", "closed_at": "2017-01-23T23:10:01Z", "author_association": "MEMBER", "body_html": "<p>Using memory-mapped ImmutableConst ops seems to cause the initial constant folding process to fail.</p>\n<h2>Reproduction steps:</h2>\n<ul>\n<li>Load a graph containing ImmutableConst ops.</li>\n<li>Create a memory-mapped environment and session like this:</li>\n</ul>\n<div class=\"highlight highlight-source-c++\"><pre> <span class=\"pl-c\"><span class=\"pl-c\">//</span> Create and initialize MemmappedEnv from the converted file.</span>\n  MemmappedEnv <span class=\"pl-en\">memmapped_env</span>(Env::Default());\n  <span class=\"pl-en\">TF_ASSERT_OK</span>(memmapped_env.InitializeFromFile(filename_mmap));\n\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> Load the graph and run calculations.</span>\n  SessionOptions session_options;\n  session_options.env = &amp;memmapped_env;\n  std::unique_ptr&lt;Session&gt; <span class=\"pl-en\">session</span>(NewSession(session_options));</pre></div>\n<ul>\n<li>Run the graph using session-&gt;Run().</li>\n</ul>\n<h2>Expected results:</h2>\n<p>The graph should execute successfully with no error messages.</p>\n<h2>Actual results:</h2>\n<p>The graph seems to execute correctly, but the following is printed to the console:</p>\n<pre><code>E tensorflow/core/common_runtime/executor.cc:334] Executor failed to create kernel. Unimplemented: File system scheme memmapped_package not implemented\n     [[Node: W_conv23 = ImmutableConst[dtype=DT_FLOAT, memory_region_name=\"memmapped_package://W_conv23\", shape=[9,9,32,3], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n</code></pre>\n<h2>Notes</h2>\n<p>From investigation, it seems like the constant folding code creates a new device with empty session options, which means a default Env is used instead of the memory-map-aware one the client passes in:</p>\n<p><a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/constant_folding.cc#L166\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/constant_folding.cc#L166</a></p>", "body_text": "Using memory-mapped ImmutableConst ops seems to cause the initial constant folding process to fail.\nReproduction steps:\n\nLoad a graph containing ImmutableConst ops.\nCreate a memory-mapped environment and session like this:\n\n // Create and initialize MemmappedEnv from the converted file.\n  MemmappedEnv memmapped_env(Env::Default());\n  TF_ASSERT_OK(memmapped_env.InitializeFromFile(filename_mmap));\n\n  // Load the graph and run calculations.\n  SessionOptions session_options;\n  session_options.env = &memmapped_env;\n  std::unique_ptr<Session> session(NewSession(session_options));\n\nRun the graph using session->Run().\n\nExpected results:\nThe graph should execute successfully with no error messages.\nActual results:\nThe graph seems to execute correctly, but the following is printed to the console:\nE tensorflow/core/common_runtime/executor.cc:334] Executor failed to create kernel. Unimplemented: File system scheme memmapped_package not implemented\n     [[Node: W_conv23 = ImmutableConst[dtype=DT_FLOAT, memory_region_name=\"memmapped_package://W_conv23\", shape=[9,9,32,3], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nNotes\nFrom investigation, it seems like the constant folding code creates a new device with empty session options, which means a default Env is used instead of the memory-map-aware one the client passes in:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/constant_folding.cc#L166", "body": "Using memory-mapped ImmutableConst ops seems to cause the initial constant folding process to fail.\n## Reproduction steps:\n- Load a graph containing ImmutableConst ops.\n- Create a memory-mapped environment and session like this:\n\n``` c++\n // Create and initialize MemmappedEnv from the converted file.\n  MemmappedEnv memmapped_env(Env::Default());\n  TF_ASSERT_OK(memmapped_env.InitializeFromFile(filename_mmap));\n\n  // Load the graph and run calculations.\n  SessionOptions session_options;\n  session_options.env = &memmapped_env;\n  std::unique_ptr<Session> session(NewSession(session_options));\n```\n- Run the graph using session->Run().\n## Expected results:\n\nThe graph should execute successfully with no error messages.\n## Actual results:\n\nThe graph seems to execute correctly, but the following is printed to the console:\n\n```\nE tensorflow/core/common_runtime/executor.cc:334] Executor failed to create kernel. Unimplemented: File system scheme memmapped_package not implemented\n     [[Node: W_conv23 = ImmutableConst[dtype=DT_FLOAT, memory_region_name=\"memmapped_package://W_conv23\", shape=[9,9,32,3], _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n```\n## Notes\n\nFrom investigation, it seems like the constant folding code creates a new device with empty session options, which means a default Env is used instead of the memory-map-aware one the client passes in:\n\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/constant_folding.cc#L166\n"}