{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13610", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13610/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13610/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13610/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13610", "id": 264322422, "node_id": "MDU6SXNzdWUyNjQzMjI0MjI=", "number": 13610, "title": "Can we run Dataset API on GPU?", "user": {"login": "tongda", "id": 653425, "node_id": "MDQ6VXNlcjY1MzQyNQ==", "avatar_url": "https://avatars0.githubusercontent.com/u/653425?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tongda", "html_url": "https://github.com/tongda", "followers_url": "https://api.github.com/users/tongda/followers", "following_url": "https://api.github.com/users/tongda/following{/other_user}", "gists_url": "https://api.github.com/users/tongda/gists{/gist_id}", "starred_url": "https://api.github.com/users/tongda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tongda/subscriptions", "organizations_url": "https://api.github.com/users/tongda/orgs", "repos_url": "https://api.github.com/users/tongda/repos", "events_url": "https://api.github.com/users/tongda/events{/privacy}", "received_events_url": "https://api.github.com/users/tongda/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473173272, "node_id": "MDU6TGFiZWw0NzMxNzMyNzI=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:feature", "name": "type:feature", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 34, "created_at": "2017-10-10T18:02:18Z", "updated_at": "2018-09-28T18:05:26Z", "closed_at": "2018-08-09T20:52:23Z", "author_association": "NONE", "body_html": "<p>I am running binary TF 1.3.0 on Ubuntu 16.04.</p>\n<p>Python Version: 3.5.3</p>\n<p>I have Nvidia TITAN Xp installed.</p>\n<p>I use Dataset API to build input pipeline. What I want is to extract image features using CNN layers<br>\nin the input pipeline. The code looks like this:</p>\n<pre><code>    def extract_feats(image):\n      with tf.device(\"/gpu:0\"):\n        _, end_points = vgg.vgg_16(tf.expand_dims(image, 0),\n                                   is_training=(mode == ModeKeys.TRAIN),\n                                   spatial_squeeze=False)\n        final_conv_layer = end_points['vgg_16/conv5/conv5_3']\n        feats = spatial_pyramid_pooling(final_conv_layer, [bin_size], mode='avg')\n      return tf.reshape(feats, shape=(bin_size * bin_size, tf.shape(final_conv_layer)[-1]))\n\n    features = features.map(extract_feats)\n</code></pre>\n<p>When running the code, my CPU usage is more than 1000% (I have an 6 cores/12 threads CPU), while the GPU usage is 0%. I suspect that the input pipeline built from Dataset API are forced to run on CPU. I tried to set <code>log_device_placement=True</code> and I can see that the operation is placed on GPU.</p>\n<p>Since I want to extract vectors with same length from variable-sized images using SPP pooling, I have to process these images one by one using <code>Dataset.map</code> before calling <code>Dataset.batch</code>. So I hope the operations inside <code>Dataset</code> could be run on GPU.</p>", "body_text": "I am running binary TF 1.3.0 on Ubuntu 16.04.\nPython Version: 3.5.3\nI have Nvidia TITAN Xp installed.\nI use Dataset API to build input pipeline. What I want is to extract image features using CNN layers\nin the input pipeline. The code looks like this:\n    def extract_feats(image):\n      with tf.device(\"/gpu:0\"):\n        _, end_points = vgg.vgg_16(tf.expand_dims(image, 0),\n                                   is_training=(mode == ModeKeys.TRAIN),\n                                   spatial_squeeze=False)\n        final_conv_layer = end_points['vgg_16/conv5/conv5_3']\n        feats = spatial_pyramid_pooling(final_conv_layer, [bin_size], mode='avg')\n      return tf.reshape(feats, shape=(bin_size * bin_size, tf.shape(final_conv_layer)[-1]))\n\n    features = features.map(extract_feats)\n\nWhen running the code, my CPU usage is more than 1000% (I have an 6 cores/12 threads CPU), while the GPU usage is 0%. I suspect that the input pipeline built from Dataset API are forced to run on CPU. I tried to set log_device_placement=True and I can see that the operation is placed on GPU.\nSince I want to extract vectors with same length from variable-sized images using SPP pooling, I have to process these images one by one using Dataset.map before calling Dataset.batch. So I hope the operations inside Dataset could be run on GPU.", "body": "I am running binary TF 1.3.0 on Ubuntu 16.04.\r\n\r\nPython Version: 3.5.3\r\n\r\nI have Nvidia TITAN Xp installed.\r\n\r\nI use Dataset API to build input pipeline. What I want is to extract image features using CNN layers \r\nin the input pipeline. The code looks like this:\r\n\r\n```\r\n    def extract_feats(image):\r\n      with tf.device(\"/gpu:0\"):\r\n        _, end_points = vgg.vgg_16(tf.expand_dims(image, 0),\r\n                                   is_training=(mode == ModeKeys.TRAIN),\r\n                                   spatial_squeeze=False)\r\n        final_conv_layer = end_points['vgg_16/conv5/conv5_3']\r\n        feats = spatial_pyramid_pooling(final_conv_layer, [bin_size], mode='avg')\r\n      return tf.reshape(feats, shape=(bin_size * bin_size, tf.shape(final_conv_layer)[-1]))\r\n\r\n    features = features.map(extract_feats)\r\n```\r\n\r\nWhen running the code, my CPU usage is more than 1000% (I have an 6 cores/12 threads CPU), while the GPU usage is 0%. I suspect that the input pipeline built from Dataset API are forced to run on CPU. I tried to set `log_device_placement=True` and I can see that the operation is placed on GPU.\r\n\r\nSince I want to extract vectors with same length from variable-sized images using SPP pooling, I have to process these images one by one using `Dataset.map` before calling `Dataset.batch`. So I hope the operations inside `Dataset` could be run on GPU.\r\n"}