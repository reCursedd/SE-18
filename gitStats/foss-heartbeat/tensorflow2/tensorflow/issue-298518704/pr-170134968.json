{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17148", "id": 170134968, "node_id": "MDExOlB1bGxSZXF1ZXN0MTcwMTM0OTY4", "html_url": "https://github.com/tensorflow/tensorflow/pull/17148", "diff_url": "https://github.com/tensorflow/tensorflow/pull/17148.diff", "patch_url": "https://github.com/tensorflow/tensorflow/pull/17148.patch", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17148", "number": 17148, "state": "closed", "locked": false, "title": "fix: Error on we feed float16 values into BeamSearchDecoder", "user": {"login": "halhorn", "id": 4395870, "node_id": "MDQ6VXNlcjQzOTU4NzA=", "avatar_url": "https://avatars2.githubusercontent.com/u/4395870?v=4", "gravatar_id": "", "url": "https://api.github.com/users/halhorn", "html_url": "https://github.com/halhorn", "followers_url": "https://api.github.com/users/halhorn/followers", "following_url": "https://api.github.com/users/halhorn/following{/other_user}", "gists_url": "https://api.github.com/users/halhorn/gists{/gist_id}", "starred_url": "https://api.github.com/users/halhorn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/halhorn/subscriptions", "organizations_url": "https://api.github.com/users/halhorn/orgs", "repos_url": "https://api.github.com/users/halhorn/repos", "events_url": "https://api.github.com/users/halhorn/events{/privacy}", "received_events_url": "https://api.github.com/users/halhorn/received_events", "type": "User", "site_admin": false}, "body": "I tried to feed float16 values into BeamSearchDecoder. Then `Type Error` occurred.\r\n\r\nThe cause is that:\r\n\r\n1. `_mask_probs` in beam_search_decoder calls `array_ops.one_hot()` and the `on_value` arg is `0.`.\r\n2. `one_hot` in array_ops infers the `dtype` of `on_value` from the value `0.`\r\n3.  `dtype` of `on_value` becomes `tf.float32`\r\n4. then raises `TypeError: dtype <dtype: 'float32'> of on_value does not match dtype parameter <dtype: 'float16'>`\r\n\r\nThe main cause is that `array_ops.one_hot` gets value `0.` but the `dtype` is unknown, so I convert the value `0.` into tensor that has right `dtype` before it is fed to `one_hot`.\r\n\r\n# Code that raises error\r\n\r\n```py3\r\nimport tensorflow as tf\r\nfrom tensorflow.python.layers import core as layers_core\r\n\r\nFL_TYPE = tf.float16  # error does not occur if FL_TYPE is tf.float32\r\nhidden_dim = 16\r\nvocab_size = 100\r\nbeam_width = 2\r\n\r\nwith tf.Graph().as_default():\r\n    cell = tf.nn.rnn_cell.GRUCell(hidden_dim)\r\n    embeddings = tf.Variable(tf.random_uniform(shape=[vocab_size, hidden_dim], dtype=FL_TYPE))\r\n    output_layer = layers_core.Dense(vocab_size, use_bias=False)\r\n\r\n    decoder = tf.contrib.seq2seq.BeamSearchDecoder(\r\n        cell=cell,\r\n        embedding=embeddings,\r\n        start_tokens=tf.ones([1], dtype=tf.int32),\r\n        end_token=99,\r\n        initial_state=tf.random_uniform(shape=[beam_width, hidden_dim], dtype=FL_TYPE),\r\n        beam_width=beam_width,\r\n        output_layer=output_layer,\r\n    )\r\n    decoder_outputs, _, _ = tf.contrib.seq2seq.dynamic_decode(\r\n        decoder=decoder,\r\n        maximum_iterations=20,\r\n         scope='generator_decode'\r\n    )\r\n\r\n    with tf.Session() as sess:\r\n        sess.run(tf.global_variables_initializer())\r\n        sess.run(decoder_outputs)\r\n```\r\n\r\noutput is bellow\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n<ipython-input-14-321fa872acec> in <module>()\r\n     24         decoder=decoder,\r\n     25         maximum_iterations=20,\r\n---> 26          scope='generator_decode'\r\n     27     )\r\n     28 \r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/decoder.py in dynamic_decode(decoder, output_time_major, impute_finished, maximum_iterations, parallel_iterations, swap_memory, scope)\r\n    307         ],\r\n    308         parallel_iterations=parallel_iterations,\r\n--> 309         swap_memory=swap_memory)\r\n    310 \r\n    311     final_outputs_ta = res[1]\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in while_loop(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, name, maximum_iterations)\r\n   2932         swap_memory=swap_memory)\r\n   2933     ops.add_to_collection(ops.GraphKeys.WHILE_CONTEXT, loop_context)\r\n-> 2934     result = loop_context.BuildLoop(cond, body, loop_vars, shape_invariants)\r\n   2935     if maximum_iterations is not None:\r\n   2936       return result[1]\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in BuildLoop(self, pred, body, loop_vars, shape_invariants)\r\n   2718       self.Enter()\r\n   2719       original_body_result, exit_vars = self._BuildLoop(\r\n-> 2720           pred, body, original_loop_vars, loop_vars, shape_invariants)\r\n   2721     finally:\r\n   2722       self.Exit()\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in _BuildLoop(self, pred, body, original_loop_vars, loop_vars, shape_invariants)\r\n   2660         flat_sequence=vars_for_body_with_tensor_arrays)\r\n   2661     pre_summaries = ops.get_collection(ops.GraphKeys._SUMMARY_COLLECTION)  # pylint: disable=protected-access\r\n-> 2662     body_result = body(*packed_vars_for_body)\r\n   2663     post_summaries = ops.get_collection(ops.GraphKeys._SUMMARY_COLLECTION)  # pylint: disable=protected-access\r\n   2664     if not nest.is_sequence(body_result):\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/decoder.py in body(time, outputs_ta, state, inputs, finished, sequence_lengths)\r\n    252       \"\"\"\r\n    253       (next_outputs, decoder_state, next_inputs,\r\n--> 254        decoder_finished) = decoder.step(time, inputs, state)\r\n    255       if decoder.tracks_own_finished:\r\n    256         next_finished = decoder_finished\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in step(self, time, inputs, state, name)\r\n    497           beam_width=beam_width,\r\n    498           end_token=end_token,\r\n--> 499           length_penalty_weight=length_penalty_weight)\r\n    500 \r\n    501       finished = beam_search_state.finished\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in _beam_search_step(time, logits, next_cell_state, beam_state, batch_size, beam_width, end_token, length_penalty_weight)\r\n    539   # Final Shape: [batch_size, beam_width, vocab_size]\r\n    540   step_log_probs = nn_ops.log_softmax(logits)\r\n--> 541   step_log_probs = _mask_probs(step_log_probs, end_token, previously_finished)\r\n    542   total_probs = array_ops.expand_dims(beam_state.log_probs, 2) + step_log_probs\r\n    543 \r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in _mask_probs(probs, eos_token, finished)\r\n    723       dtype=probs.dtype,\r\n    724       on_value=0.,\r\n--> 725       off_value=probs.dtype.min)\r\n    726   finished_probs = array_ops.tile(\r\n    727       array_ops.reshape(finished_row, [1, 1, -1]),\r\n\r\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/array_ops.py in one_hot(indices, depth, on_value, off_value, axis, dtype, name)\r\n   2337         if on_exists and on_dtype != dtype:\r\n   2338           raise TypeError(\"dtype {0} of on_value does not match \"\r\n-> 2339                           \"dtype parameter {1}\".format(on_dtype, dtype))\r\n   2340         if off_exists and off_dtype != dtype:\r\n   2341           raise TypeError(\"dtype {0} of off_value does not match \"\r\n\r\nTypeError: dtype <dtype: 'float32'> of on_value does not match dtype parameter <dtype: 'float16'>\r\n```", "created_at": "2018-02-20T09:12:01Z", "updated_at": "2018-02-24T01:38:52Z", "closed_at": "2018-02-23T22:41:07Z", "merged_at": "2018-02-23T22:41:07Z", "merge_commit_sha": "8c67c5932666e56662af58777675e5909d4391aa", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 300136587, "node_id": "MDU6TGFiZWwzMDAxMzY1ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/cla:%20yes", "name": "cla: yes", "color": "009800", "default": false}], "milestone": null, "commits_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17148/commits", "review_comments_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17148/comments", "review_comment_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17148/comments", "statuses_url": "https://api.github.com/repos/tensorflow/tensorflow/statuses/309fb111931bb7aae3e716594e5c53ac4976e76a", "head": {"label": "halhorn:beam_search_decoder_for_float16", "ref": "beam_search_decoder_for_float16", "sha": "309fb111931bb7aae3e716594e5c53ac4976e76a", "user": {"login": "halhorn", "id": 4395870, "node_id": "MDQ6VXNlcjQzOTU4NzA=", "avatar_url": "https://avatars2.githubusercontent.com/u/4395870?v=4", "gravatar_id": "", "url": "https://api.github.com/users/halhorn", "html_url": "https://github.com/halhorn", "followers_url": "https://api.github.com/users/halhorn/followers", "following_url": "https://api.github.com/users/halhorn/following{/other_user}", "gists_url": "https://api.github.com/users/halhorn/gists{/gist_id}", "starred_url": "https://api.github.com/users/halhorn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/halhorn/subscriptions", "organizations_url": "https://api.github.com/users/halhorn/orgs", "repos_url": "https://api.github.com/users/halhorn/repos", "events_url": "https://api.github.com/users/halhorn/events{/privacy}", "received_events_url": "https://api.github.com/users/halhorn/received_events", "type": "User", "site_admin": false}, "repo": {"id": 122166550, "node_id": "MDEwOlJlcG9zaXRvcnkxMjIxNjY1NTA=", "name": "tensorflow", "full_name": "halhorn/tensorflow", "private": false, "owner": {"login": "halhorn", "id": 4395870, "node_id": "MDQ6VXNlcjQzOTU4NzA=", "avatar_url": "https://avatars2.githubusercontent.com/u/4395870?v=4", "gravatar_id": "", "url": "https://api.github.com/users/halhorn", "html_url": "https://github.com/halhorn", "followers_url": "https://api.github.com/users/halhorn/followers", "following_url": "https://api.github.com/users/halhorn/following{/other_user}", "gists_url": "https://api.github.com/users/halhorn/gists{/gist_id}", "starred_url": "https://api.github.com/users/halhorn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/halhorn/subscriptions", "organizations_url": "https://api.github.com/users/halhorn/orgs", "repos_url": "https://api.github.com/users/halhorn/repos", "events_url": "https://api.github.com/users/halhorn/events{/privacy}", "received_events_url": "https://api.github.com/users/halhorn/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/halhorn/tensorflow", "description": "Computation using data flow graphs for scalable machine learning", "fork": true, "url": "https://api.github.com/repos/halhorn/tensorflow", "forks_url": "https://api.github.com/repos/halhorn/tensorflow/forks", "keys_url": "https://api.github.com/repos/halhorn/tensorflow/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/halhorn/tensorflow/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/halhorn/tensorflow/teams", "hooks_url": "https://api.github.com/repos/halhorn/tensorflow/hooks", "issue_events_url": "https://api.github.com/repos/halhorn/tensorflow/issues/events{/number}", "events_url": "https://api.github.com/repos/halhorn/tensorflow/events", "assignees_url": "https://api.github.com/repos/halhorn/tensorflow/assignees{/user}", "branches_url": "https://api.github.com/repos/halhorn/tensorflow/branches{/branch}", "tags_url": "https://api.github.com/repos/halhorn/tensorflow/tags", "blobs_url": "https://api.github.com/repos/halhorn/tensorflow/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/halhorn/tensorflow/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/halhorn/tensorflow/git/refs{/sha}", "trees_url": "https://api.github.com/repos/halhorn/tensorflow/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/halhorn/tensorflow/statuses/{sha}", "languages_url": "https://api.github.com/repos/halhorn/tensorflow/languages", "stargazers_url": "https://api.github.com/repos/halhorn/tensorflow/stargazers", "contributors_url": "https://api.github.com/repos/halhorn/tensorflow/contributors", "subscribers_url": "https://api.github.com/repos/halhorn/tensorflow/subscribers", "subscription_url": "https://api.github.com/repos/halhorn/tensorflow/subscription", "commits_url": "https://api.github.com/repos/halhorn/tensorflow/commits{/sha}", "git_commits_url": "https://api.github.com/repos/halhorn/tensorflow/git/commits{/sha}", "comments_url": "https://api.github.com/repos/halhorn/tensorflow/comments{/number}", "issue_comment_url": "https://api.github.com/repos/halhorn/tensorflow/issues/comments{/number}", "contents_url": "https://api.github.com/repos/halhorn/tensorflow/contents/{+path}", "compare_url": "https://api.github.com/repos/halhorn/tensorflow/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/halhorn/tensorflow/merges", "archive_url": "https://api.github.com/repos/halhorn/tensorflow/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/halhorn/tensorflow/downloads", "issues_url": "https://api.github.com/repos/halhorn/tensorflow/issues{/number}", "pulls_url": "https://api.github.com/repos/halhorn/tensorflow/pulls{/number}", "milestones_url": "https://api.github.com/repos/halhorn/tensorflow/milestones{/number}", "notifications_url": "https://api.github.com/repos/halhorn/tensorflow/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/halhorn/tensorflow/labels{/name}", "releases_url": "https://api.github.com/repos/halhorn/tensorflow/releases{/id}", "deployments_url": "https://api.github.com/repos/halhorn/tensorflow/deployments", "created_at": "2018-02-20T07:16:31Z", "updated_at": "2018-02-20T07:17:09Z", "pushed_at": "2018-02-24T01:38:52Z", "git_url": "git://github.com/halhorn/tensorflow.git", "ssh_url": "git@github.com:halhorn/tensorflow.git", "clone_url": "https://github.com/halhorn/tensorflow.git", "svn_url": "https://github.com/halhorn/tensorflow", "homepage": "https://tensorflow.org", "size": 151670, "stargazers_count": 0, "watchers_count": 0, "language": "C++", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "forks_count": 0, "mirror_url": null, "archived": false, "open_issues_count": 0, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "tensorflow:master", "ref": "master", "sha": "a4f1478134cdbf73f0ad7eda3e73407135a54566", "user": {"login": "tensorflow", "id": 15658638, "node_id": "MDEyOk9yZ2FuaXphdGlvbjE1NjU4NjM4", "avatar_url": "https://avatars1.githubusercontent.com/u/15658638?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tensorflow", "html_url": "https://github.com/tensorflow", "followers_url": "https://api.github.com/users/tensorflow/followers", "following_url": "https://api.github.com/users/tensorflow/following{/other_user}", "gists_url": "https://api.github.com/users/tensorflow/gists{/gist_id}", "starred_url": "https://api.github.com/users/tensorflow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tensorflow/subscriptions", "organizations_url": "https://api.github.com/users/tensorflow/orgs", "repos_url": "https://api.github.com/users/tensorflow/repos", "events_url": "https://api.github.com/users/tensorflow/events{/privacy}", "received_events_url": "https://api.github.com/users/tensorflow/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 45717250, "node_id": "MDEwOlJlcG9zaXRvcnk0NTcxNzI1MA==", "name": "tensorflow", "full_name": "tensorflow/tensorflow", "private": false, "owner": {"login": "tensorflow", "id": 15658638, "node_id": "MDEyOk9yZ2FuaXphdGlvbjE1NjU4NjM4", "avatar_url": "https://avatars1.githubusercontent.com/u/15658638?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tensorflow", "html_url": "https://github.com/tensorflow", "followers_url": "https://api.github.com/users/tensorflow/followers", "following_url": "https://api.github.com/users/tensorflow/following{/other_user}", "gists_url": "https://api.github.com/users/tensorflow/gists{/gist_id}", "starred_url": "https://api.github.com/users/tensorflow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tensorflow/subscriptions", "organizations_url": "https://api.github.com/users/tensorflow/orgs", "repos_url": "https://api.github.com/users/tensorflow/repos", "events_url": "https://api.github.com/users/tensorflow/events{/privacy}", "received_events_url": "https://api.github.com/users/tensorflow/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/tensorflow/tensorflow", "description": "An Open Source Machine Learning Framework for Everyone", "fork": false, "url": "https://api.github.com/repos/tensorflow/tensorflow", "forks_url": "https://api.github.com/repos/tensorflow/tensorflow/forks", "keys_url": "https://api.github.com/repos/tensorflow/tensorflow/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/tensorflow/tensorflow/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/tensorflow/tensorflow/teams", "hooks_url": "https://api.github.com/repos/tensorflow/tensorflow/hooks", "issue_events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/events{/number}", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/events", "assignees_url": "https://api.github.com/repos/tensorflow/tensorflow/assignees{/user}", "branches_url": "https://api.github.com/repos/tensorflow/tensorflow/branches{/branch}", "tags_url": "https://api.github.com/repos/tensorflow/tensorflow/tags", "blobs_url": "https://api.github.com/repos/tensorflow/tensorflow/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/tensorflow/tensorflow/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/tensorflow/tensorflow/git/refs{/sha}", "trees_url": "https://api.github.com/repos/tensorflow/tensorflow/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/tensorflow/tensorflow/statuses/{sha}", "languages_url": "https://api.github.com/repos/tensorflow/tensorflow/languages", "stargazers_url": "https://api.github.com/repos/tensorflow/tensorflow/stargazers", "contributors_url": "https://api.github.com/repos/tensorflow/tensorflow/contributors", "subscribers_url": "https://api.github.com/repos/tensorflow/tensorflow/subscribers", "subscription_url": "https://api.github.com/repos/tensorflow/tensorflow/subscription", "commits_url": "https://api.github.com/repos/tensorflow/tensorflow/commits{/sha}", "git_commits_url": "https://api.github.com/repos/tensorflow/tensorflow/git/commits{/sha}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/comments{/number}", "issue_comment_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments{/number}", "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/{+path}", "compare_url": "https://api.github.com/repos/tensorflow/tensorflow/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/tensorflow/tensorflow/merges", "archive_url": "https://api.github.com/repos/tensorflow/tensorflow/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/tensorflow/tensorflow/downloads", "issues_url": "https://api.github.com/repos/tensorflow/tensorflow/issues{/number}", "pulls_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls{/number}", "milestones_url": "https://api.github.com/repos/tensorflow/tensorflow/milestones{/number}", "notifications_url": "https://api.github.com/repos/tensorflow/tensorflow/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/labels{/name}", "releases_url": "https://api.github.com/repos/tensorflow/tensorflow/releases{/id}", "deployments_url": "https://api.github.com/repos/tensorflow/tensorflow/deployments", "created_at": "2015-11-07T01:19:20Z", "updated_at": "2018-11-24T22:13:04Z", "pushed_at": "2018-11-24T18:40:19Z", "git_url": "git://github.com/tensorflow/tensorflow.git", "ssh_url": "git@github.com:tensorflow/tensorflow.git", "clone_url": "https://github.com/tensorflow/tensorflow.git", "svn_url": "https://github.com/tensorflow/tensorflow", "homepage": "https://tensorflow.org", "size": 284546, "stargazers_count": 115176, "watchers_count": 115176, "language": "C++", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "forks_count": 69946, "mirror_url": null, "archived": false, "open_issues_count": 1760, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "forks": 69946, "open_issues": 1760, "watchers": 115176, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17148"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/17148"}, "issue": {"href": "https://api.github.com/repos/tensorflow/tensorflow/issues/17148"}, "comments": {"href": "https://api.github.com/repos/tensorflow/tensorflow/issues/17148/comments"}, "review_comments": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17148/comments"}, "review_comment": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17148/commits"}, "statuses": {"href": "https://api.github.com/repos/tensorflow/tensorflow/statuses/309fb111931bb7aae3e716594e5c53ac4976e76a"}}, "author_association": "CONTRIBUTOR", "body_html": "<p>I tried to feed float16 values into BeamSearchDecoder. Then <code>Type Error</code> occurred.</p>\n<p>The cause is that:</p>\n<ol>\n<li><code>_mask_probs</code> in beam_search_decoder calls <code>array_ops.one_hot()</code> and the <code>on_value</code> arg is <code>0.</code>.</li>\n<li><code>one_hot</code> in array_ops infers the <code>dtype</code> of <code>on_value</code> from the value <code>0.</code></li>\n<li><code>dtype</code> of <code>on_value</code> becomes <code>tf.float32</code></li>\n<li>then raises <code>TypeError: dtype &lt;dtype: 'float32'&gt; of on_value does not match dtype parameter &lt;dtype: 'float16'&gt;</code></li>\n</ol>\n<p>The main cause is that <code>array_ops.one_hot</code> gets value <code>0.</code> but the <code>dtype</code> is unknown, so I convert the value <code>0.</code> into tensor that has right <code>dtype</code> before it is fed to <code>one_hot</code>.</p>\n<h1>Code that raises error</h1>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> tensorflow.python.layers <span class=\"pl-k\">import</span> core <span class=\"pl-k\">as</span> layers_core\n\n<span class=\"pl-c1\">FL_TYPE</span> <span class=\"pl-k\">=</span> tf.float16  <span class=\"pl-c\"><span class=\"pl-c\">#</span> error does not occur if FL_TYPE is tf.float32</span>\nhidden_dim <span class=\"pl-k\">=</span> <span class=\"pl-c1\">16</span>\nvocab_size <span class=\"pl-k\">=</span> <span class=\"pl-c1\">100</span>\nbeam_width <span class=\"pl-k\">=</span> <span class=\"pl-c1\">2</span>\n\n<span class=\"pl-k\">with</span> tf.Graph().as_default():\n    cell <span class=\"pl-k\">=</span> tf.nn.rnn_cell.GRUCell(hidden_dim)\n    embeddings <span class=\"pl-k\">=</span> tf.Variable(tf.random_uniform(<span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[vocab_size, hidden_dim], <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">FL_TYPE</span>))\n    output_layer <span class=\"pl-k\">=</span> layers_core.Dense(vocab_size, <span class=\"pl-v\">use_bias</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>)\n\n    decoder <span class=\"pl-k\">=</span> tf.contrib.seq2seq.BeamSearchDecoder(\n        <span class=\"pl-v\">cell</span><span class=\"pl-k\">=</span>cell,\n        <span class=\"pl-v\">embedding</span><span class=\"pl-k\">=</span>embeddings,\n        <span class=\"pl-v\">start_tokens</span><span class=\"pl-k\">=</span>tf.ones([<span class=\"pl-c1\">1</span>], <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.int32),\n        <span class=\"pl-v\">end_token</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">99</span>,\n        <span class=\"pl-v\">initial_state</span><span class=\"pl-k\">=</span>tf.random_uniform(<span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[beam_width, hidden_dim], <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">FL_TYPE</span>),\n        <span class=\"pl-v\">beam_width</span><span class=\"pl-k\">=</span>beam_width,\n        <span class=\"pl-v\">output_layer</span><span class=\"pl-k\">=</span>output_layer,\n    )\n    decoder_outputs, _, _ <span class=\"pl-k\">=</span> tf.contrib.seq2seq.dynamic_decode(\n        <span class=\"pl-v\">decoder</span><span class=\"pl-k\">=</span>decoder,\n        <span class=\"pl-v\">maximum_iterations</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">20</span>,\n         <span class=\"pl-v\">scope</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>generator_decode<span class=\"pl-pds\">'</span></span>\n    )\n\n    <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n        sess.run(tf.global_variables_initializer())\n        sess.run(decoder_outputs)</pre></div>\n<p>output is bellow</p>\n<pre><code>---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n&lt;ipython-input-14-321fa872acec&gt; in &lt;module&gt;()\n     24         decoder=decoder,\n     25         maximum_iterations=20,\n---&gt; 26          scope='generator_decode'\n     27     )\n     28 \n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/decoder.py in dynamic_decode(decoder, output_time_major, impute_finished, maximum_iterations, parallel_iterations, swap_memory, scope)\n    307         ],\n    308         parallel_iterations=parallel_iterations,\n--&gt; 309         swap_memory=swap_memory)\n    310 \n    311     final_outputs_ta = res[1]\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in while_loop(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, name, maximum_iterations)\n   2932         swap_memory=swap_memory)\n   2933     ops.add_to_collection(ops.GraphKeys.WHILE_CONTEXT, loop_context)\n-&gt; 2934     result = loop_context.BuildLoop(cond, body, loop_vars, shape_invariants)\n   2935     if maximum_iterations is not None:\n   2936       return result[1]\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in BuildLoop(self, pred, body, loop_vars, shape_invariants)\n   2718       self.Enter()\n   2719       original_body_result, exit_vars = self._BuildLoop(\n-&gt; 2720           pred, body, original_loop_vars, loop_vars, shape_invariants)\n   2721     finally:\n   2722       self.Exit()\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in _BuildLoop(self, pred, body, original_loop_vars, loop_vars, shape_invariants)\n   2660         flat_sequence=vars_for_body_with_tensor_arrays)\n   2661     pre_summaries = ops.get_collection(ops.GraphKeys._SUMMARY_COLLECTION)  # pylint: disable=protected-access\n-&gt; 2662     body_result = body(*packed_vars_for_body)\n   2663     post_summaries = ops.get_collection(ops.GraphKeys._SUMMARY_COLLECTION)  # pylint: disable=protected-access\n   2664     if not nest.is_sequence(body_result):\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/decoder.py in body(time, outputs_ta, state, inputs, finished, sequence_lengths)\n    252       \"\"\"\n    253       (next_outputs, decoder_state, next_inputs,\n--&gt; 254        decoder_finished) = decoder.step(time, inputs, state)\n    255       if decoder.tracks_own_finished:\n    256         next_finished = decoder_finished\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in step(self, time, inputs, state, name)\n    497           beam_width=beam_width,\n    498           end_token=end_token,\n--&gt; 499           length_penalty_weight=length_penalty_weight)\n    500 \n    501       finished = beam_search_state.finished\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in _beam_search_step(time, logits, next_cell_state, beam_state, batch_size, beam_width, end_token, length_penalty_weight)\n    539   # Final Shape: [batch_size, beam_width, vocab_size]\n    540   step_log_probs = nn_ops.log_softmax(logits)\n--&gt; 541   step_log_probs = _mask_probs(step_log_probs, end_token, previously_finished)\n    542   total_probs = array_ops.expand_dims(beam_state.log_probs, 2) + step_log_probs\n    543 \n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in _mask_probs(probs, eos_token, finished)\n    723       dtype=probs.dtype,\n    724       on_value=0.,\n--&gt; 725       off_value=probs.dtype.min)\n    726   finished_probs = array_ops.tile(\n    727       array_ops.reshape(finished_row, [1, 1, -1]),\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/array_ops.py in one_hot(indices, depth, on_value, off_value, axis, dtype, name)\n   2337         if on_exists and on_dtype != dtype:\n   2338           raise TypeError(\"dtype {0} of on_value does not match \"\n-&gt; 2339                           \"dtype parameter {1}\".format(on_dtype, dtype))\n   2340         if off_exists and off_dtype != dtype:\n   2341           raise TypeError(\"dtype {0} of off_value does not match \"\n\nTypeError: dtype &lt;dtype: 'float32'&gt; of on_value does not match dtype parameter &lt;dtype: 'float16'&gt;\n</code></pre>", "body_text": "I tried to feed float16 values into BeamSearchDecoder. Then Type Error occurred.\nThe cause is that:\n\n_mask_probs in beam_search_decoder calls array_ops.one_hot() and the on_value arg is 0..\none_hot in array_ops infers the dtype of on_value from the value 0.\ndtype of on_value becomes tf.float32\nthen raises TypeError: dtype <dtype: 'float32'> of on_value does not match dtype parameter <dtype: 'float16'>\n\nThe main cause is that array_ops.one_hot gets value 0. but the dtype is unknown, so I convert the value 0. into tensor that has right dtype before it is fed to one_hot.\nCode that raises error\nimport tensorflow as tf\nfrom tensorflow.python.layers import core as layers_core\n\nFL_TYPE = tf.float16  # error does not occur if FL_TYPE is tf.float32\nhidden_dim = 16\nvocab_size = 100\nbeam_width = 2\n\nwith tf.Graph().as_default():\n    cell = tf.nn.rnn_cell.GRUCell(hidden_dim)\n    embeddings = tf.Variable(tf.random_uniform(shape=[vocab_size, hidden_dim], dtype=FL_TYPE))\n    output_layer = layers_core.Dense(vocab_size, use_bias=False)\n\n    decoder = tf.contrib.seq2seq.BeamSearchDecoder(\n        cell=cell,\n        embedding=embeddings,\n        start_tokens=tf.ones([1], dtype=tf.int32),\n        end_token=99,\n        initial_state=tf.random_uniform(shape=[beam_width, hidden_dim], dtype=FL_TYPE),\n        beam_width=beam_width,\n        output_layer=output_layer,\n    )\n    decoder_outputs, _, _ = tf.contrib.seq2seq.dynamic_decode(\n        decoder=decoder,\n        maximum_iterations=20,\n         scope='generator_decode'\n    )\n\n    with tf.Session() as sess:\n        sess.run(tf.global_variables_initializer())\n        sess.run(decoder_outputs)\noutput is bellow\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-14-321fa872acec> in <module>()\n     24         decoder=decoder,\n     25         maximum_iterations=20,\n---> 26          scope='generator_decode'\n     27     )\n     28 \n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/decoder.py in dynamic_decode(decoder, output_time_major, impute_finished, maximum_iterations, parallel_iterations, swap_memory, scope)\n    307         ],\n    308         parallel_iterations=parallel_iterations,\n--> 309         swap_memory=swap_memory)\n    310 \n    311     final_outputs_ta = res[1]\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in while_loop(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, name, maximum_iterations)\n   2932         swap_memory=swap_memory)\n   2933     ops.add_to_collection(ops.GraphKeys.WHILE_CONTEXT, loop_context)\n-> 2934     result = loop_context.BuildLoop(cond, body, loop_vars, shape_invariants)\n   2935     if maximum_iterations is not None:\n   2936       return result[1]\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in BuildLoop(self, pred, body, loop_vars, shape_invariants)\n   2718       self.Enter()\n   2719       original_body_result, exit_vars = self._BuildLoop(\n-> 2720           pred, body, original_loop_vars, loop_vars, shape_invariants)\n   2721     finally:\n   2722       self.Exit()\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/control_flow_ops.py in _BuildLoop(self, pred, body, original_loop_vars, loop_vars, shape_invariants)\n   2660         flat_sequence=vars_for_body_with_tensor_arrays)\n   2661     pre_summaries = ops.get_collection(ops.GraphKeys._SUMMARY_COLLECTION)  # pylint: disable=protected-access\n-> 2662     body_result = body(*packed_vars_for_body)\n   2663     post_summaries = ops.get_collection(ops.GraphKeys._SUMMARY_COLLECTION)  # pylint: disable=protected-access\n   2664     if not nest.is_sequence(body_result):\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/decoder.py in body(time, outputs_ta, state, inputs, finished, sequence_lengths)\n    252       \"\"\"\n    253       (next_outputs, decoder_state, next_inputs,\n--> 254        decoder_finished) = decoder.step(time, inputs, state)\n    255       if decoder.tracks_own_finished:\n    256         next_finished = decoder_finished\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in step(self, time, inputs, state, name)\n    497           beam_width=beam_width,\n    498           end_token=end_token,\n--> 499           length_penalty_weight=length_penalty_weight)\n    500 \n    501       finished = beam_search_state.finished\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in _beam_search_step(time, logits, next_cell_state, beam_state, batch_size, beam_width, end_token, length_penalty_weight)\n    539   # Final Shape: [batch_size, beam_width, vocab_size]\n    540   step_log_probs = nn_ops.log_softmax(logits)\n--> 541   step_log_probs = _mask_probs(step_log_probs, end_token, previously_finished)\n    542   total_probs = array_ops.expand_dims(beam_state.log_probs, 2) + step_log_probs\n    543 \n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py in _mask_probs(probs, eos_token, finished)\n    723       dtype=probs.dtype,\n    724       on_value=0.,\n--> 725       off_value=probs.dtype.min)\n    726   finished_probs = array_ops.tile(\n    727       array_ops.reshape(finished_row, [1, 1, -1]),\n\n~/.pyenv/versions/3.5.2/lib/python3.5/site-packages/tensorflow/python/ops/array_ops.py in one_hot(indices, depth, on_value, off_value, axis, dtype, name)\n   2337         if on_exists and on_dtype != dtype:\n   2338           raise TypeError(\"dtype {0} of on_value does not match \"\n-> 2339                           \"dtype parameter {1}\".format(on_dtype, dtype))\n   2340         if off_exists and off_dtype != dtype:\n   2341           raise TypeError(\"dtype {0} of off_value does not match \"\n\nTypeError: dtype <dtype: 'float32'> of on_value does not match dtype parameter <dtype: 'float16'>", "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "ekelsen", "id": 2533174, "node_id": "MDQ6VXNlcjI1MzMxNzQ=", "avatar_url": "https://avatars0.githubusercontent.com/u/2533174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ekelsen", "html_url": "https://github.com/ekelsen", "followers_url": "https://api.github.com/users/ekelsen/followers", "following_url": "https://api.github.com/users/ekelsen/following{/other_user}", "gists_url": "https://api.github.com/users/ekelsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/ekelsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ekelsen/subscriptions", "organizations_url": "https://api.github.com/users/ekelsen/orgs", "repos_url": "https://api.github.com/users/ekelsen/repos", "events_url": "https://api.github.com/users/ekelsen/events{/privacy}", "received_events_url": "https://api.github.com/users/ekelsen/received_events", "type": "User", "site_admin": false}, "comments": 0, "review_comments": 0, "maintainer_can_modify": false, "commits": 1, "additions": 1, "deletions": 1, "changed_files": 1}