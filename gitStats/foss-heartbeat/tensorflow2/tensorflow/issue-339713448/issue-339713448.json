{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20661", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20661/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20661/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20661/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/20661", "id": 339713448, "node_id": "MDU6SXNzdWUzMzk3MTM0NDg=", "number": 20661, "title": "tensorflow c++ api session->run() consumes too much time.", "user": {"login": "fffupeng", "id": 20182561, "node_id": "MDQ6VXNlcjIwMTgyNTYx", "avatar_url": "https://avatars2.githubusercontent.com/u/20182561?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fffupeng", "html_url": "https://github.com/fffupeng", "followers_url": "https://api.github.com/users/fffupeng/followers", "following_url": "https://api.github.com/users/fffupeng/following{/other_user}", "gists_url": "https://api.github.com/users/fffupeng/gists{/gist_id}", "starred_url": "https://api.github.com/users/fffupeng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fffupeng/subscriptions", "organizations_url": "https://api.github.com/users/fffupeng/orgs", "repos_url": "https://api.github.com/users/fffupeng/repos", "events_url": "https://api.github.com/users/fffupeng/events{/privacy}", "received_events_url": "https://api.github.com/users/fffupeng/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "robieta", "id": 13089297, "node_id": "MDQ6VXNlcjEzMDg5Mjk3", "avatar_url": "https://avatars0.githubusercontent.com/u/13089297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/robieta", "html_url": "https://github.com/robieta", "followers_url": "https://api.github.com/users/robieta/followers", "following_url": "https://api.github.com/users/robieta/following{/other_user}", "gists_url": "https://api.github.com/users/robieta/gists{/gist_id}", "starred_url": "https://api.github.com/users/robieta/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/robieta/subscriptions", "organizations_url": "https://api.github.com/users/robieta/orgs", "repos_url": "https://api.github.com/users/robieta/repos", "events_url": "https://api.github.com/users/robieta/events{/privacy}", "received_events_url": "https://api.github.com/users/robieta/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "robieta", "id": 13089297, "node_id": "MDQ6VXNlcjEzMDg5Mjk3", "avatar_url": "https://avatars0.githubusercontent.com/u/13089297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/robieta", "html_url": "https://github.com/robieta", "followers_url": "https://api.github.com/users/robieta/followers", "following_url": "https://api.github.com/users/robieta/following{/other_user}", "gists_url": "https://api.github.com/users/robieta/gists{/gist_id}", "starred_url": "https://api.github.com/users/robieta/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/robieta/subscriptions", "organizations_url": "https://api.github.com/users/robieta/orgs", "repos_url": "https://api.github.com/users/robieta/repos", "events_url": "https://api.github.com/users/robieta/events{/privacy}", "received_events_url": "https://api.github.com/users/robieta/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2018-07-10T06:46:14Z", "updated_at": "2018-09-12T03:44:12Z", "closed_at": "2018-07-11T06:27:36Z", "author_association": "NONE", "body_html": "<p>Here are my codes:</p>\n<pre><code>void tensorflow_class_wrapper::load_model(string model_path)\n{\n\t// set gpu options\n\tSessionOptions opts;\n\tGraphDef graph_def;\n\tConfigProto* config = &amp;opts.config;\n\topts.config.mutable_gpu_options()-&gt;set_per_process_gpu_memory_fraction(0.3);\n\topts.config.mutable_gpu_options()-&gt;set_allow_growth(true);\n\tassert(_session == NULL);\n\tTF_CHECK_OK(NewSession(opts, &amp;_session));\n\tprintf(\"Create session done.\\n\");\n\n\t//read the pb file into the grapdef member\n\tTF_CHECK_OK(ReadBinaryProto(Env::Default(), model_path, &amp;graph_def));\n\tprintf(\"Load model done.\\n\");\n\n\t//Add the graph to the session\n\tTF_CHECK_OK(_session-&gt;Create(graph_def));\n\tprintf(\"Create graph done.\\n\");\n\treturn;\n}\n</code></pre>\n<pre><code>void tensorflow_class_wrapper::predict()\n{\n\t// convert data\n\tconvert_data();\n\tprintf(\"Convert data done.\\n\");\n\n\tclock_t t1, t2;\n\tt1 = clock();\n\t//The session will initialize the outputs\n\tvector&lt;Tensor&gt; outputs;\n\tTF_CHECK_OK( _session-&gt;Run(_input_dict,  _output_tensor_names , {}, &amp;outputs));\n\tt2 = clock();\n\tcout &lt;&lt; \"predict consume time: \" &lt;&lt; float(t2 - t1) / CLOCKS_PER_SEC &lt;&lt; endl;\n\n\tfor (auto _o : outputs)\n\t\tcout &lt;&lt; _o.DebugString() &lt;&lt; endl;\n\tvector&lt;vector&lt;float&gt;&gt; predict_res(outputs.size());\n\tfor (int nr = 0; nr &lt; outputs.size(); nr++)\n\t\tpredict_res[nr].assign(outputs[nr].flat&lt;float&gt;().data(), outputs[nr].flat&lt;float&gt;().data() + outputs[nr].dims());\n\n}\n</code></pre>\n<p>My input img size is 512x512x1. PB model is just single convolution and the output shape is 512x512x1. It's confused that session-&gt;Run() consumes over 2 seconds even more. By the way, i compile tensorflow1.8 release codes to get tensorflow lib/dll. Is there anything wrong when i compiled the source codes? Or I did not set some options in the right way?</p>", "body_text": "Here are my codes:\nvoid tensorflow_class_wrapper::load_model(string model_path)\n{\n\t// set gpu options\n\tSessionOptions opts;\n\tGraphDef graph_def;\n\tConfigProto* config = &opts.config;\n\topts.config.mutable_gpu_options()->set_per_process_gpu_memory_fraction(0.3);\n\topts.config.mutable_gpu_options()->set_allow_growth(true);\n\tassert(_session == NULL);\n\tTF_CHECK_OK(NewSession(opts, &_session));\n\tprintf(\"Create session done.\\n\");\n\n\t//read the pb file into the grapdef member\n\tTF_CHECK_OK(ReadBinaryProto(Env::Default(), model_path, &graph_def));\n\tprintf(\"Load model done.\\n\");\n\n\t//Add the graph to the session\n\tTF_CHECK_OK(_session->Create(graph_def));\n\tprintf(\"Create graph done.\\n\");\n\treturn;\n}\n\nvoid tensorflow_class_wrapper::predict()\n{\n\t// convert data\n\tconvert_data();\n\tprintf(\"Convert data done.\\n\");\n\n\tclock_t t1, t2;\n\tt1 = clock();\n\t//The session will initialize the outputs\n\tvector<Tensor> outputs;\n\tTF_CHECK_OK( _session->Run(_input_dict,  _output_tensor_names , {}, &outputs));\n\tt2 = clock();\n\tcout << \"predict consume time: \" << float(t2 - t1) / CLOCKS_PER_SEC << endl;\n\n\tfor (auto _o : outputs)\n\t\tcout << _o.DebugString() << endl;\n\tvector<vector<float>> predict_res(outputs.size());\n\tfor (int nr = 0; nr < outputs.size(); nr++)\n\t\tpredict_res[nr].assign(outputs[nr].flat<float>().data(), outputs[nr].flat<float>().data() + outputs[nr].dims());\n\n}\n\nMy input img size is 512x512x1. PB model is just single convolution and the output shape is 512x512x1. It's confused that session->Run() consumes over 2 seconds even more. By the way, i compile tensorflow1.8 release codes to get tensorflow lib/dll. Is there anything wrong when i compiled the source codes? Or I did not set some options in the right way?", "body": "Here are my codes:\r\n```\r\nvoid tensorflow_class_wrapper::load_model(string model_path)\r\n{\r\n\t// set gpu options\r\n\tSessionOptions opts;\r\n\tGraphDef graph_def;\r\n\tConfigProto* config = &opts.config;\r\n\topts.config.mutable_gpu_options()->set_per_process_gpu_memory_fraction(0.3);\r\n\topts.config.mutable_gpu_options()->set_allow_growth(true);\r\n\tassert(_session == NULL);\r\n\tTF_CHECK_OK(NewSession(opts, &_session));\r\n\tprintf(\"Create session done.\\n\");\r\n\r\n\t//read the pb file into the grapdef member\r\n\tTF_CHECK_OK(ReadBinaryProto(Env::Default(), model_path, &graph_def));\r\n\tprintf(\"Load model done.\\n\");\r\n\r\n\t//Add the graph to the session\r\n\tTF_CHECK_OK(_session->Create(graph_def));\r\n\tprintf(\"Create graph done.\\n\");\r\n\treturn;\r\n}\r\n```\r\n\r\n```\r\nvoid tensorflow_class_wrapper::predict()\r\n{\r\n\t// convert data\r\n\tconvert_data();\r\n\tprintf(\"Convert data done.\\n\");\r\n\r\n\tclock_t t1, t2;\r\n\tt1 = clock();\r\n\t//The session will initialize the outputs\r\n\tvector<Tensor> outputs;\r\n\tTF_CHECK_OK( _session->Run(_input_dict,  _output_tensor_names , {}, &outputs));\r\n\tt2 = clock();\r\n\tcout << \"predict consume time: \" << float(t2 - t1) / CLOCKS_PER_SEC << endl;\r\n\r\n\tfor (auto _o : outputs)\r\n\t\tcout << _o.DebugString() << endl;\r\n\tvector<vector<float>> predict_res(outputs.size());\r\n\tfor (int nr = 0; nr < outputs.size(); nr++)\r\n\t\tpredict_res[nr].assign(outputs[nr].flat<float>().data(), outputs[nr].flat<float>().data() + outputs[nr].dims());\r\n\r\n}\r\n```\r\nMy input img size is 512x512x1. PB model is just single convolution and the output shape is 512x512x1. It's confused that session->Run() consumes over 2 seconds even more. By the way, i compile tensorflow1.8 release codes to get tensorflow lib/dll. Is there anything wrong when i compiled the source codes? Or I did not set some options in the right way?"}