{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/298040918", "html_url": "https://github.com/tensorflow/tensorflow/issues/7530#issuecomment-298040918", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7530", "id": 298040918, "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODA0MDkxOA==", "user": {"login": "David-Levinthal", "id": 8728143, "node_id": "MDQ6VXNlcjg3MjgxNDM=", "avatar_url": "https://avatars2.githubusercontent.com/u/8728143?v=4", "gravatar_id": "", "url": "https://api.github.com/users/David-Levinthal", "html_url": "https://github.com/David-Levinthal", "followers_url": "https://api.github.com/users/David-Levinthal/followers", "following_url": "https://api.github.com/users/David-Levinthal/following{/other_user}", "gists_url": "https://api.github.com/users/David-Levinthal/gists{/gist_id}", "starred_url": "https://api.github.com/users/David-Levinthal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/David-Levinthal/subscriptions", "organizations_url": "https://api.github.com/users/David-Levinthal/orgs", "repos_url": "https://api.github.com/users/David-Levinthal/repos", "events_url": "https://api.github.com/users/David-Levinthal/events{/privacy}", "received_events_url": "https://api.github.com/users/David-Levinthal/received_events", "type": "User", "site_admin": false}, "created_at": "2017-04-28T16:14:22Z", "updated_at": "2017-04-28T16:14:22Z", "author_association": "NONE", "body_html": "<p>for a bazel build like:<br>\nbazel build  --copt=\"-mavx512f\" --copt=\"-mavx512dq\" --copt=\"-mavx512vl\" --copt=\"-Ofast\" -s -c opt //tensorflow/tools/pip_package:build_pip_package<br>\nThere are errors in PacketMathAVX512 and PacketMathAVX2<br>\navx2 seems to need something like:</p>\n<p>typedef struct Packet16q16i {<br>\n__m256i val;<br>\noperator __m256i() const { return val; }<br>\nPacket16q16i();<br>\nPacket16q16i(__m256i val) : val(val) {}<br>\n} Packet16q16i;</p>\n<p>in avx512<br>\n#ifdef EIGEN_VECTORIZE_AVX512DQ<br>\n// AVX512F does not define _mm512_extractf32x8_ps to extract _m256 from _m512<br>\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                           <br>\n__m256 OUTPUT##_0 = _mm512_extractf32x8_ps(INPUT, 0) __m256 OUTPUT##_1 = <br>\n_mm512_extractf32x8_ps(INPUT, 1)<br>\n#else<br>\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                <br>\n__m256 OUTPUT##_0 = _mm256_insertf128_ps(                     <br>\n_mm256_castps128_ps256(_mm512_extractf32x4_ps(INPUT, 0)), <br>\n_mm512_extractf32x4_ps(INPUT, 1), 1);                     <br>\n__m256 OUTPUT##_1 = _mm256_insertf128_ps(                     <br>\n_mm256_castps128_ps256(_mm512_extractf32x4_ps(INPUT, 2)), <br>\n_mm512_extractf32x4_ps(INPUT, 3), 1);<br>\n#endif</p>\n<p>And<br>\ntemplate&lt;&gt; EIGEN_STRONG_INLINE Packet16f preduxp(const Packet16f*<br>\nvecs)<br>\n{<br>\nshould be something like:<br>\n// AVX512F does not define _mm512_extractf32x8_ps to extract _m256 from _m512<br>\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                           <br>\n__m256 OUTPUT##_0 = _mm512_extractf32x8_ps(INPUT, 0);        <br>\n__m256 OUTPUT##_1 =  _mm512_extractf32x8_ps(INPUT, 1);</p>\n<p>And maybe missing \u201c \u201c<br>\ntemplate&lt;&gt; EIGEN_STRONG_INLINE Packet16f preduxp(const Packet16f* vecs)<br>\n{</p>\n<p>this does not finish the problems..see attachment  is this stuff fixed in r1.1?<br>\n<a href=\"https://github.com/tensorflow/tensorflow/files/964910/avx512_error_after_PacketMath_fixes.txt\">avx512_error_after_PacketMath_fixes.txt</a></p>", "body_text": "for a bazel build like:\nbazel build  --copt=\"-mavx512f\" --copt=\"-mavx512dq\" --copt=\"-mavx512vl\" --copt=\"-Ofast\" -s -c opt //tensorflow/tools/pip_package:build_pip_package\nThere are errors in PacketMathAVX512 and PacketMathAVX2\navx2 seems to need something like:\ntypedef struct Packet16q16i {\n__m256i val;\noperator __m256i() const { return val; }\nPacket16q16i();\nPacket16q16i(__m256i val) : val(val) {}\n} Packet16q16i;\nin avx512\n#ifdef EIGEN_VECTORIZE_AVX512DQ\n// AVX512F does not define _mm512_extractf32x8_ps to extract _m256 from _m512\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                           \n__m256 OUTPUT##_0 = _mm512_extractf32x8_ps(INPUT, 0) __m256 OUTPUT##_1 = \n_mm512_extractf32x8_ps(INPUT, 1)\n#else\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                \n__m256 OUTPUT##_0 = _mm256_insertf128_ps(                     \n_mm256_castps128_ps256(_mm512_extractf32x4_ps(INPUT, 0)), \n_mm512_extractf32x4_ps(INPUT, 1), 1);                     \n__m256 OUTPUT##_1 = _mm256_insertf128_ps(                     \n_mm256_castps128_ps256(_mm512_extractf32x4_ps(INPUT, 2)), \n_mm512_extractf32x4_ps(INPUT, 3), 1);\n#endif\nAnd\ntemplate<> EIGEN_STRONG_INLINE Packet16f preduxp(const Packet16f*\nvecs)\n{\nshould be something like:\n// AVX512F does not define _mm512_extractf32x8_ps to extract _m256 from _m512\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                           \n__m256 OUTPUT##_0 = _mm512_extractf32x8_ps(INPUT, 0);        \n__m256 OUTPUT##_1 =  _mm512_extractf32x8_ps(INPUT, 1);\nAnd maybe missing \u201c \u201c\ntemplate<> EIGEN_STRONG_INLINE Packet16f preduxp(const Packet16f* vecs)\n{\nthis does not finish the problems..see attachment  is this stuff fixed in r1.1?\navx512_error_after_PacketMath_fixes.txt", "body": "for a bazel build like:\r\nbazel build  --copt=\"-mavx512f\" --copt=\"-mavx512dq\" --copt=\"-mavx512vl\" --copt=\"-Ofast\" -s -c opt //tensorflow/tools/pip_package:build_pip_package \r\nThere are errors in PacketMathAVX512 and PacketMathAVX2\r\navx2 seems to need something like:\r\n\r\ntypedef struct Packet16q16i {\r\n  __m256i val;\r\n  operator __m256i() const { return val; }\r\n  Packet16q16i();\r\n  Packet16q16i(__m256i val) : val(val) {}\r\n} Packet16q16i;\r\n\r\nin avx512\r\n#ifdef EIGEN_VECTORIZE_AVX512DQ\r\n// AVX512F does not define _mm512_extractf32x8_ps to extract _m256 from _m512\r\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                           \\\r\n  __m256 OUTPUT##_0 = _mm512_extractf32x8_ps(INPUT, 0) __m256 OUTPUT##_1 = \\\r\n      _mm512_extractf32x8_ps(INPUT, 1)\r\n#else\r\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                \\\r\n  __m256 OUTPUT##_0 = _mm256_insertf128_ps(                     \\\r\n      _mm256_castps128_ps256(_mm512_extractf32x4_ps(INPUT, 0)), \\\r\n      _mm512_extractf32x4_ps(INPUT, 1), 1);                     \\\r\n  __m256 OUTPUT##_1 = _mm256_insertf128_ps(                     \\\r\n      _mm256_castps128_ps256(_mm512_extractf32x4_ps(INPUT, 2)), \\\r\n      _mm512_extractf32x4_ps(INPUT, 3), 1);\r\n#endif\r\n\r\nAnd\r\ntemplate<> EIGEN_STRONG_INLINE Packet16f preduxp<Packet16f>(const Packet16f*\r\nvecs)\r\n{\r\nshould be something like:\r\n// AVX512F does not define _mm512_extractf32x8_ps to extract _m256 from _m512\r\n#define EIGEN_EXTRACT_8f_FROM_16f(INPUT, OUTPUT)                           \\\r\n  __m256 OUTPUT##_0 = _mm512_extractf32x8_ps(INPUT, 0);        \\\r\n__m256 OUTPUT##_1 =  _mm512_extractf32x8_ps(INPUT, 1);\r\n\r\nAnd maybe missing \u201c \u201c\r\ntemplate<> EIGEN_STRONG_INLINE Packet16f preduxp<Packet16f>(const Packet16f* vecs)\r\n{\r\n\r\nthis does not finish the problems..see attachment  is this stuff fixed in r1.1?\r\n[avx512_error_after_PacketMath_fixes.txt](https://github.com/tensorflow/tensorflow/files/964910/avx512_error_after_PacketMath_fixes.txt)\r\n\r\n\r\n"}