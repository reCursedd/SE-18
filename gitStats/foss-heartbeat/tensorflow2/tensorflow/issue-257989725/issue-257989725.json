{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13061", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13061/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13061/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13061/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13061", "id": 257989725, "node_id": "MDU6SXNzdWUyNTc5ODk3MjU=", "number": 13061, "title": "Proposal: Making the cmake build distribution friendly", "user": {"login": "dmacvicar", "id": 15332, "node_id": "MDQ6VXNlcjE1MzMy", "avatar_url": "https://avatars2.githubusercontent.com/u/15332?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dmacvicar", "html_url": "https://github.com/dmacvicar", "followers_url": "https://api.github.com/users/dmacvicar/followers", "following_url": "https://api.github.com/users/dmacvicar/following{/other_user}", "gists_url": "https://api.github.com/users/dmacvicar/gists{/gist_id}", "starred_url": "https://api.github.com/users/dmacvicar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dmacvicar/subscriptions", "organizations_url": "https://api.github.com/users/dmacvicar/orgs", "repos_url": "https://api.github.com/users/dmacvicar/repos", "events_url": "https://api.github.com/users/dmacvicar/events{/privacy}", "received_events_url": "https://api.github.com/users/dmacvicar/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 27, "created_at": "2017-09-15T10:05:21Z", "updated_at": "2018-09-05T06:50:22Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<p>The following is a proposal, and I don't have it fully working yet, so a Pull Request is too early, and I want to gather some feedback. If an issue is not appropriate, let me know and I will look for a different medium.</p>\n<h3>System information</h3>\n<p>Almost any Linux distribution.</p>\n<h3>Describe the problem</h3>\n<p>Most Linux distributions have similar policies/limitations:</p>\n<ol>\n<li>Not accepting bundling of system libraries (specially those security-sensitive).</li>\n<li>Requiring building the whole from source and allowing patching the sources.</li>\n<li>Requiring building offline (without Internet access).</li>\n<li>Not having enough manpower to package hundred of packages in a dependency chain just to get packages like maven built in these source-chains environments.</li>\n</ol>\n<p>Because of 4., cmake makes things easier. It is a build tool with a few dependencies that does not need complex bootstrapping. Building bazel itself will bring you into the Java maven dependency chain which we already proved in openSUSE to expand into hundred of packages.</p>\n<p>Both the bazel and cmake build files do not play well with 1. 2. 3., but cmake already improves 4.</p>\n<p>The cmake build files, also pull the sources of different projects. That is because the top <code>CMakeLists.txt</code> includes:</p>\n<div class=\"highlight highlight-source-cmake\"><pre><span class=\"pl-c1\">set</span>(<span class=\"pl-k\">CMAKE_MODULE_PATH</span> <span class=\"pl-smi\">${PROJECT_SOURCE_DIR}</span>/external)</pre></div>\n<p>into the load path.</p>\n<p>that external/ directory is full of snippets like:</p>\n<ul>\n<li><code>tensorflow/contrib/cmake/external/jpeg.cmake</code></li>\n<li><code>tensorflow/contrib/cmake/external/gif.cmake</code></li>\n<li>...</li>\n<li>etc</li>\n</ul>\n<p>Those snippets use the <a href=\"https://cmake.org/cmake/help/v3.0/module/ExternalProject.html\" rel=\"nofollow\">external project</a> cmake api to build directly from git or tarballs upstream. This clashes with<br>\n1., 2., 3.</p>\n<p>It is a bit sad that things like curl used to be looked up in the system and developers deliberately bundled them without making the cmake snippet first look for it, and if not, configure the bundled one.</p>\n<h3>Proposal</h3>\n<p>The proposal is to make the cmake build support both the Google/Mac user type of build with bundled sources, and the classical Linux distribution build.<br>\nThis would be a gradual refactoring. Steps could be:</p>\n<ul>\n<li>Add to CMakeLists.txt an option:</li>\n</ul>\n<div class=\"highlight highlight-source-cmake\"><pre><span class=\"pl-c1\">option</span>(tensorflow_SYSTEM_LIBRARIES <span class=\"pl-s\">\"Use system libraries\"</span> <span class=\"pl-k\">ON</span>)</pre></div>\n<ul>\n<li>Replicate the external/ directory as platform/ and conditionally make it use one or the other:</li>\n</ul>\n<div class=\"highlight highlight-source-cmake\"><pre><span class=\"pl-k\">if</span>(tensorflow_SYSTEM_LIBRARIES)\n <span class=\"pl-c1\">set</span>(<span class=\"pl-k\">CMAKE_MODULE_PATH</span> <span class=\"pl-smi\">${PROJECT_SOURCE_DIR}</span>/platform)\n<span class=\"pl-k\">else</span>()\n  <span class=\"pl-c1\">set</span>(<span class=\"pl-k\">CMAKE_MODULE_PATH</span> <span class=\"pl-smi\">${PROJECT_SOURCE_DIR}</span>/external)\n<span class=\"pl-k\">endif</span>()</pre></div>\n<p>So that then the part that does:</p>\n<div class=\"highlight highlight-source-cmake\"><pre><span class=\"pl-c\"><span class=\"pl-c\">#</span> External dependencies</span>\n<span class=\"pl-c1\">include</span>(zlib)\n<span class=\"pl-c1\">include</span>(gif)\n<span class=\"pl-c1\">include</span>(png)\n<span class=\"pl-c1\">include</span>(jpeg)</pre></div>\n<p>would just work...</p>\n<ul>\n<li>Replace incrementaly and one by one the $dep.cmake snippets in <code>platform/</code>.</li>\n</ul>\n<p>Example with gif.cmake:</p>\n<p>Using the standard <code>/usr/share/cmake/Modules/FindGIF.cmake</code> included in cmake, which may use <code>pkg-config</code> for some modules. The module itself documents it would then set: <code>GIF_LIBRARIES</code>, <code>GIF_INCLUDE_DIR</code>, etc.</p>\n<p>Unfortunately the variable that the original set is called <code>gif_STATIC_LIBRARIES</code>, because it assumes it would be static. I think we could fix that later so that naming ends making sense, but lets not focus on that for now.</p>\n<p>The <code>gif.cmake</code> I cited above would become a simple:</p>\n<div class=\"highlight highlight-source-cmake\"><pre><span class=\"pl-c1\">find_package</span>(GIF <span class=\"pl-k\">REQUIRED</span>)\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> dummy targets other targets depend on.</span>\n<span class=\"pl-c1\">add_custom_target</span>(gif)\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> These can be removed if we fix CMakeLists</span>\n<span class=\"pl-c1\">add_custom_target</span>(gif_copy_headers_to_destination)\n\n<span class=\"pl-c1\">set</span>(gif_STATIC_LIBRARIES <span class=\"pl-smi\">${GIF_LIBRARIES}</span>)\n<span class=\"pl-c1\">set</span>(gif_INCLUDE_DIR <span class=\"pl-smi\">${GIF_INCLUDE_DIR}</span>)</pre></div>\n<p>And that is more or less enough to move forward with this dependency... repeat.<br>\nIt may need some hacks also in the top level cmake files however...</p>\n<p>I think this approach is doable, and could be turned into making the cmake build fully Linux distro enabled upstream. Slowly cleaning the naming, etc, removing these copy_headers targets so that the platform/ version of the .cmake files do not need to create dummy targets, etc.</p>\n<ul>\n<li>Similarly, the sqlite one becomes:</li>\n</ul>\n<div class=\"highlight highlight-source-cmake\"><pre><span class=\"pl-c1\">find_package</span>(SQLite3)\n<span class=\"pl-c1\">set</span>(sqlite_STATIC_LIBRARIES <span class=\"pl-smi\">${SQLITE3_LIBRARIES}</span>)\n<span class=\"pl-c1\">set</span>(sqlite_HEADERS <span class=\"pl-smi\">${SQLITE3_INCLUDE_DIR}</span>)\n<span class=\"pl-c1\">add_custom_target</span>(sqlite)\n<span class=\"pl-c1\">add_custom_target</span>(sqlite_copy_headers_to_destination)</pre></div>\n<p>With the only difference is that the <code>Find</code> module was not included in cmake, so I just copied it into<br>\nplatform from <a href=\"https://raw.githubusercontent.com/LuaDist/libsqlite3/master/cmake/FindSQLite3.cmake\" rel=\"nofollow\">https://raw.githubusercontent.com/LuaDist/libsqlite3/master/cmake/FindSQLite3.cmake</a> somewhere.</p>\n<ul>\n<li>With this method I have been able to move forward and forward with the build.</li>\n</ul>\n<h3>Current blockers</h3>\n<ul>\n<li>cmake build does not work out of the box <a href=\"https://github.com/tensorflow/tensorflow/pull/12734\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/tensorflow/tensorflow/pull/12734/hovercard\">PR</a></li>\n<li><a href=\"https://github.com/tensorflow/tensorflow/issues/12018\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/12018/hovercard\">Issue</a> with <code>Missing tensorflow/core/debug/debug_service.grpc.pb.h</code></li>\n</ul>\n<p>//cc <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=7229203\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/meaksh\">@meaksh</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1615643\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/dincamihai\">@dincamihai</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=7080830\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ncounter\">@ncounter</a></p>", "body_text": "The following is a proposal, and I don't have it fully working yet, so a Pull Request is too early, and I want to gather some feedback. If an issue is not appropriate, let me know and I will look for a different medium.\nSystem information\nAlmost any Linux distribution.\nDescribe the problem\nMost Linux distributions have similar policies/limitations:\n\nNot accepting bundling of system libraries (specially those security-sensitive).\nRequiring building the whole from source and allowing patching the sources.\nRequiring building offline (without Internet access).\nNot having enough manpower to package hundred of packages in a dependency chain just to get packages like maven built in these source-chains environments.\n\nBecause of 4., cmake makes things easier. It is a build tool with a few dependencies that does not need complex bootstrapping. Building bazel itself will bring you into the Java maven dependency chain which we already proved in openSUSE to expand into hundred of packages.\nBoth the bazel and cmake build files do not play well with 1. 2. 3., but cmake already improves 4.\nThe cmake build files, also pull the sources of different projects. That is because the top CMakeLists.txt includes:\nset(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/external)\ninto the load path.\nthat external/ directory is full of snippets like:\n\ntensorflow/contrib/cmake/external/jpeg.cmake\ntensorflow/contrib/cmake/external/gif.cmake\n...\netc\n\nThose snippets use the external project cmake api to build directly from git or tarballs upstream. This clashes with\n1., 2., 3.\nIt is a bit sad that things like curl used to be looked up in the system and developers deliberately bundled them without making the cmake snippet first look for it, and if not, configure the bundled one.\nProposal\nThe proposal is to make the cmake build support both the Google/Mac user type of build with bundled sources, and the classical Linux distribution build.\nThis would be a gradual refactoring. Steps could be:\n\nAdd to CMakeLists.txt an option:\n\noption(tensorflow_SYSTEM_LIBRARIES \"Use system libraries\" ON)\n\nReplicate the external/ directory as platform/ and conditionally make it use one or the other:\n\nif(tensorflow_SYSTEM_LIBRARIES)\n set(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/platform)\nelse()\n  set(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/external)\nendif()\nSo that then the part that does:\n# External dependencies\ninclude(zlib)\ninclude(gif)\ninclude(png)\ninclude(jpeg)\nwould just work...\n\nReplace incrementaly and one by one the $dep.cmake snippets in platform/.\n\nExample with gif.cmake:\nUsing the standard /usr/share/cmake/Modules/FindGIF.cmake included in cmake, which may use pkg-config for some modules. The module itself documents it would then set: GIF_LIBRARIES, GIF_INCLUDE_DIR, etc.\nUnfortunately the variable that the original set is called gif_STATIC_LIBRARIES, because it assumes it would be static. I think we could fix that later so that naming ends making sense, but lets not focus on that for now.\nThe gif.cmake I cited above would become a simple:\nfind_package(GIF REQUIRED)\n# dummy targets other targets depend on.\nadd_custom_target(gif)\n# These can be removed if we fix CMakeLists\nadd_custom_target(gif_copy_headers_to_destination)\n\nset(gif_STATIC_LIBRARIES ${GIF_LIBRARIES})\nset(gif_INCLUDE_DIR ${GIF_INCLUDE_DIR})\nAnd that is more or less enough to move forward with this dependency... repeat.\nIt may need some hacks also in the top level cmake files however...\nI think this approach is doable, and could be turned into making the cmake build fully Linux distro enabled upstream. Slowly cleaning the naming, etc, removing these copy_headers targets so that the platform/ version of the .cmake files do not need to create dummy targets, etc.\n\nSimilarly, the sqlite one becomes:\n\nfind_package(SQLite3)\nset(sqlite_STATIC_LIBRARIES ${SQLITE3_LIBRARIES})\nset(sqlite_HEADERS ${SQLITE3_INCLUDE_DIR})\nadd_custom_target(sqlite)\nadd_custom_target(sqlite_copy_headers_to_destination)\nWith the only difference is that the Find module was not included in cmake, so I just copied it into\nplatform from https://raw.githubusercontent.com/LuaDist/libsqlite3/master/cmake/FindSQLite3.cmake somewhere.\n\nWith this method I have been able to move forward and forward with the build.\n\nCurrent blockers\n\ncmake build does not work out of the box PR\nIssue with Missing tensorflow/core/debug/debug_service.grpc.pb.h\n\n//cc @meaksh @dincamihai @ncounter", "body": "The following is a proposal, and I don't have it fully working yet, so a Pull Request is too early, and I want to gather some feedback. If an issue is not appropriate, let me know and I will look for a different medium.\r\n\r\n### System information\r\n\r\nAlmost any Linux distribution.\r\n\r\n### Describe the problem\r\n\r\nMost Linux distributions have similar policies/limitations:\r\n\r\n1. Not accepting bundling of system libraries (specially those security-sensitive).\r\n2. Requiring building the whole from source and allowing patching the sources.\r\n3. Requiring building offline (without Internet access).\r\n4. Not having enough manpower to package hundred of packages in a dependency chain just to get packages like maven built in these source-chains environments.\r\n\r\nBecause of 4., cmake makes things easier. It is a build tool with a few dependencies that does not need complex bootstrapping. Building bazel itself will bring you into the Java maven dependency chain which we already proved in openSUSE to expand into hundred of packages.\r\n\r\nBoth the bazel and cmake build files do not play well with 1. 2. 3., but cmake already improves 4.\r\n\r\nThe cmake build files, also pull the sources of different projects. That is because the top `CMakeLists.txt` includes:\r\n\r\n```cmake\r\nset(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/external)\r\n```\r\n\r\ninto the load path.\r\n\r\nthat external/ directory is full of snippets like:\r\n\r\n* `tensorflow/contrib/cmake/external/jpeg.cmake`\r\n* `tensorflow/contrib/cmake/external/gif.cmake`\r\n* ...\r\n* etc\r\n\r\nThose snippets use the [external project](https://cmake.org/cmake/help/v3.0/module/ExternalProject.html) cmake api to build directly from git or tarballs upstream. This clashes with\r\n1., 2., 3.\r\n\r\nIt is a bit sad that things like curl used to be looked up in the system and developers deliberately bundled them without making the cmake snippet first look for it, and if not, configure the bundled one.\r\n\r\n### Proposal\r\n\r\nThe proposal is to make the cmake build support both the Google/Mac user type of build with bundled sources, and the classical Linux distribution build.\r\nThis would be a gradual refactoring. Steps could be:\r\n\r\n* Add to CMakeLists.txt an option:\r\n\r\n```cmake\r\noption(tensorflow_SYSTEM_LIBRARIES \"Use system libraries\" ON)\r\n```\r\n\r\n* Replicate the external/ directory as platform/ and conditionally make it use one or the other:\r\n\r\n```cmake\r\nif(tensorflow_SYSTEM_LIBRARIES)\r\n set(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/platform)\r\nelse()\r\n  set(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/external)\r\nendif()\r\n```\r\n\r\nSo that then the part that does:\r\n\r\n```cmake\r\n# External dependencies\r\ninclude(zlib)\r\ninclude(gif)\r\ninclude(png)\r\ninclude(jpeg)\r\n```\r\n\r\nwould just work...\r\n\r\n* Replace incrementaly and one by one the $dep.cmake snippets in `platform/`.\r\n\r\nExample with gif.cmake:\r\n\r\nUsing the standard `/usr/share/cmake/Modules/FindGIF.cmake` included in cmake, which may use `pkg-config` for some modules. The module itself documents it would then set: `GIF_LIBRARIES`, `GIF_INCLUDE_DIR`, etc.\r\n\r\nUnfortunately the variable that the original set is called `gif_STATIC_LIBRARIES`, because it assumes it would be static. I think we could fix that later so that naming ends making sense, but lets not focus on that for now.\r\n\r\nThe `gif.cmake` I cited above would become a simple:\r\n\r\n```cmake\r\nfind_package(GIF REQUIRED)\r\n# dummy targets other targets depend on.\r\nadd_custom_target(gif)\r\n# These can be removed if we fix CMakeLists\r\nadd_custom_target(gif_copy_headers_to_destination)\r\n\r\nset(gif_STATIC_LIBRARIES ${GIF_LIBRARIES})\r\nset(gif_INCLUDE_DIR ${GIF_INCLUDE_DIR})\r\n```\r\n\r\nAnd that is more or less enough to move forward with this dependency... repeat.\r\nIt may need some hacks also in the top level cmake files however...\r\n\r\nI think this approach is doable, and could be turned into making the cmake build fully Linux distro enabled upstream. Slowly cleaning the naming, etc, removing these copy_headers targets so that the platform/ version of the .cmake files do not need to create dummy targets, etc.\r\n\r\n- Similarly, the sqlite one becomes:\r\n\r\n```cmake\r\nfind_package(SQLite3)\r\nset(sqlite_STATIC_LIBRARIES ${SQLITE3_LIBRARIES})\r\nset(sqlite_HEADERS ${SQLITE3_INCLUDE_DIR})\r\nadd_custom_target(sqlite)\r\nadd_custom_target(sqlite_copy_headers_to_destination)\r\n```\r\n\r\nWith the only difference is that the `Find` module was not included in cmake, so I just copied it into\r\nplatform from https://raw.githubusercontent.com/LuaDist/libsqlite3/master/cmake/FindSQLite3.cmake somewhere.\r\n\r\n* With this method I have been able to move forward and forward with the build.\r\n\r\n### Current blockers\r\n\r\n* cmake build does not work out of the box [PR](https://github.com/tensorflow/tensorflow/pull/12734)\r\n* [Issue](https://github.com/tensorflow/tensorflow/issues/12018) with `Missing tensorflow/core/debug/debug_service.grpc.pb.h`\r\n\r\n//cc @meaksh @dincamihai @ncounter"}