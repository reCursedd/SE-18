{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12039", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12039/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12039/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12039/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/12039", "id": 248017276, "node_id": "MDU6SXNzdWUyNDgwMTcyNzY=", "number": 12039, "title": "Model callbacks don't work in TF r1.2 and Keras functional API (Python 3.6 + windows 10)", "user": {"login": "NatLun091238", "id": 26412310, "node_id": "MDQ6VXNlcjI2NDEyMzEw", "avatar_url": "https://avatars0.githubusercontent.com/u/26412310?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NatLun091238", "html_url": "https://github.com/NatLun091238", "followers_url": "https://api.github.com/users/NatLun091238/followers", "following_url": "https://api.github.com/users/NatLun091238/following{/other_user}", "gists_url": "https://api.github.com/users/NatLun091238/gists{/gist_id}", "starred_url": "https://api.github.com/users/NatLun091238/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NatLun091238/subscriptions", "organizations_url": "https://api.github.com/users/NatLun091238/orgs", "repos_url": "https://api.github.com/users/NatLun091238/repos", "events_url": "https://api.github.com/users/NatLun091238/events{/privacy}", "received_events_url": "https://api.github.com/users/NatLun091238/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-08-04T14:08:35Z", "updated_at": "2017-08-07T18:17:20Z", "closed_at": "2017-08-07T18:08:40Z", "author_association": "NONE", "body_html": "<p>Two test cases were constructed in order to show better the problem with \"Model callbacks, which don't work in TF r1.2 and Keras functional API\".</p>\n<p>1/ Callbackes were used in the following way:<br>\n#------------ checkpoints -------------------------------<br>\nimport tensorflow.contrib.keras as K<br>\nfiledest=\"./models/weights_model011a.best.hdf5\"<br>\ncheckpoint = K.callbacks.ModelCheckpoint(filedest, monitor='val_acc', verbose=1,<br>\nsave_best_only=True, mode='max')</p>\n<p>checkRLR = K.callbacks.ReduceLROnPlateau(monitor='val_acc', factor=0.1,<br>\npatience=7,min_lr=1.0e-10)</p>\n<p>earlyStop = K.callbacks.EarlyStopping(monitor='val_acc', patience=30)<br>\ntbgraph = K.callbacks.TensorBoard(log_dir='./graphs', histogram_freq=1,<br>\nwrite_graph=True, write_images=False,<br>\nembeddings_freq=1)</p>\n<p>callbacks_list = [checkpoint,earlyStop,checkRLR,tbgraph]</p>\n<p>and then:<br>\nhistory = model.fit(X_train, y_train[:11200], validation_data=(X_test, y_tst_cat[:7200]),<br>\nepochs=epochs, batch_size=40,shuffle=True,<br>\ncallbacks=callbacks_list, verbose=0)</p>\n<p>That resulted in successful run through the training session, but with the following info:<br>\nINFO:tensorflow:Summary name embedding/embeddings:0 is illegal; using embedding/embeddings_0 instead.<br>\nINFO:tensorflow:Summary name conv1d/kernel:0 is illegal; using conv1d/kernel_0 instead.<br>\nINFO:tensorflow:Summary name conv1d/bias:0 is illegal; using conv1d/bias_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_1/kernel:0 is illegal; using conv1d_1/kernel_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_1/bias:0 is illegal; using conv1d_1/bias_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_2/kernel:0 is illegal; using conv1d_2/kernel_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_2/bias:0 is illegal; using conv1d_2/bias_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_3/kernel:0 is illegal; using conv1d_3/kernel_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_3/bias:0 is illegal; using conv1d_3/bias_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_4/kernel:0 is illegal; using conv1d_4/kernel_0 instead.<br>\nINFO:tensorflow:Summary name conv1d_4/bias:0 is illegal; using conv1d_4/bias_0 instead.<br>\nINFO:tensorflow:Summary name dense/kernel:0 is illegal; using dense/kernel_0 instead.<br>\nINFO:tensorflow:Summary name dense/bias:0 is illegal; using dense/bias_0 instead.</p>\n<p>2/ Callbacks were used with Keras functional API in similar way, described above. The run resulted in similar info message PLUS the following:<br>\nC:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py:411: RuntimeWarning: Can save best model only with val_acc available, skipping.<br>\n'skipping.' % (self.monitor), RuntimeWarning)<br>\nC:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py:499: RuntimeWarning: Early stopping requires val_acc available!<br>\nRuntimeWarning)<br>\nTraceback (most recent call last):</p>\n<p>File \"\", line 1, in <br>\nrunfile('C:/path_to_the files/Test_bugs/NonTagTFmodel_local_v011.py', wdir='C:/path_to_the files/Test_bugs')</p>\n<p>File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\spyder\\utils\\site\\sitecustomize.py\", line 880, in runfile<br>\nexecfile(filename, namespace)</p>\n<p>File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\spyder\\utils\\site\\sitecustomize.py\", line 102, in execfile<br>\nexec(compile(f.read(), filename, 'exec'), namespace)</p>\n<p>File \"C:/path/Documents/Python Scripts/Recognition/Run09recipes/Test_bugs/NonTagTFmodel_local_v011.py\", line 149, in <br>\ncallbacks=callbacks_list, verbose=0)</p>\n<p>File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\engine\\training.py\", line 1495, in fit<br>\ninitial_epoch=initial_epoch)</p>\n<p>File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\engine\\training.py\", line 1158, in _fit_loop<br>\ncallbacks.on_epoch_end(epoch, epoch_logs)</p>\n<p>File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py\", line 96, in on_epoch_end<br>\ncallback.on_epoch_end(epoch, logs)</p>\n<p>File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py\", line 501, in on_epoch_end<br>\nif self.monitor_op(current - self.min_delta, self.best):</p>\n<p>TypeError: unsupported operand type(s) for -: 'NoneType' and 'int'</p>\n<p>The same code (TF r1.2 and Keras functional API) runs perfectly alright if 'callbacks=None':<br>\nhistory = model.fit(X_train, [Y_tr_hot,y_tr_cat[:11200]], validation_data=(X_test, [Y_ts_hot,y_ts_cat[:7200]]),<br>\nepochs=epochs, batch_size=40, shuffle=True,<br>\ncallbacks=None, verbose=1)</p>\n<p>What can be the reason for Model callbacks not working???</p>", "body_text": "Two test cases were constructed in order to show better the problem with \"Model callbacks, which don't work in TF r1.2 and Keras functional API\".\n1/ Callbackes were used in the following way:\n#------------ checkpoints -------------------------------\nimport tensorflow.contrib.keras as K\nfiledest=\"./models/weights_model011a.best.hdf5\"\ncheckpoint = K.callbacks.ModelCheckpoint(filedest, monitor='val_acc', verbose=1,\nsave_best_only=True, mode='max')\ncheckRLR = K.callbacks.ReduceLROnPlateau(monitor='val_acc', factor=0.1,\npatience=7,min_lr=1.0e-10)\nearlyStop = K.callbacks.EarlyStopping(monitor='val_acc', patience=30)\ntbgraph = K.callbacks.TensorBoard(log_dir='./graphs', histogram_freq=1,\nwrite_graph=True, write_images=False,\nembeddings_freq=1)\ncallbacks_list = [checkpoint,earlyStop,checkRLR,tbgraph]\nand then:\nhistory = model.fit(X_train, y_train[:11200], validation_data=(X_test, y_tst_cat[:7200]),\nepochs=epochs, batch_size=40,shuffle=True,\ncallbacks=callbacks_list, verbose=0)\nThat resulted in successful run through the training session, but with the following info:\nINFO:tensorflow:Summary name embedding/embeddings:0 is illegal; using embedding/embeddings_0 instead.\nINFO:tensorflow:Summary name conv1d/kernel:0 is illegal; using conv1d/kernel_0 instead.\nINFO:tensorflow:Summary name conv1d/bias:0 is illegal; using conv1d/bias_0 instead.\nINFO:tensorflow:Summary name conv1d_1/kernel:0 is illegal; using conv1d_1/kernel_0 instead.\nINFO:tensorflow:Summary name conv1d_1/bias:0 is illegal; using conv1d_1/bias_0 instead.\nINFO:tensorflow:Summary name conv1d_2/kernel:0 is illegal; using conv1d_2/kernel_0 instead.\nINFO:tensorflow:Summary name conv1d_2/bias:0 is illegal; using conv1d_2/bias_0 instead.\nINFO:tensorflow:Summary name conv1d_3/kernel:0 is illegal; using conv1d_3/kernel_0 instead.\nINFO:tensorflow:Summary name conv1d_3/bias:0 is illegal; using conv1d_3/bias_0 instead.\nINFO:tensorflow:Summary name conv1d_4/kernel:0 is illegal; using conv1d_4/kernel_0 instead.\nINFO:tensorflow:Summary name conv1d_4/bias:0 is illegal; using conv1d_4/bias_0 instead.\nINFO:tensorflow:Summary name dense/kernel:0 is illegal; using dense/kernel_0 instead.\nINFO:tensorflow:Summary name dense/bias:0 is illegal; using dense/bias_0 instead.\n2/ Callbacks were used with Keras functional API in similar way, described above. The run resulted in similar info message PLUS the following:\nC:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py:411: RuntimeWarning: Can save best model only with val_acc available, skipping.\n'skipping.' % (self.monitor), RuntimeWarning)\nC:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py:499: RuntimeWarning: Early stopping requires val_acc available!\nRuntimeWarning)\nTraceback (most recent call last):\nFile \"\", line 1, in \nrunfile('C:/path_to_the files/Test_bugs/NonTagTFmodel_local_v011.py', wdir='C:/path_to_the files/Test_bugs')\nFile \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\spyder\\utils\\site\\sitecustomize.py\", line 880, in runfile\nexecfile(filename, namespace)\nFile \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\spyder\\utils\\site\\sitecustomize.py\", line 102, in execfile\nexec(compile(f.read(), filename, 'exec'), namespace)\nFile \"C:/path/Documents/Python Scripts/Recognition/Run09recipes/Test_bugs/NonTagTFmodel_local_v011.py\", line 149, in \ncallbacks=callbacks_list, verbose=0)\nFile \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\engine\\training.py\", line 1495, in fit\ninitial_epoch=initial_epoch)\nFile \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\engine\\training.py\", line 1158, in _fit_loop\ncallbacks.on_epoch_end(epoch, epoch_logs)\nFile \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py\", line 96, in on_epoch_end\ncallback.on_epoch_end(epoch, logs)\nFile \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py\", line 501, in on_epoch_end\nif self.monitor_op(current - self.min_delta, self.best):\nTypeError: unsupported operand type(s) for -: 'NoneType' and 'int'\nThe same code (TF r1.2 and Keras functional API) runs perfectly alright if 'callbacks=None':\nhistory = model.fit(X_train, [Y_tr_hot,y_tr_cat[:11200]], validation_data=(X_test, [Y_ts_hot,y_ts_cat[:7200]]),\nepochs=epochs, batch_size=40, shuffle=True,\ncallbacks=None, verbose=1)\nWhat can be the reason for Model callbacks not working???", "body": "Two test cases were constructed in order to show better the problem with \"Model callbacks, which don't work in TF r1.2 and Keras functional API\".\r\n\r\n1/ Callbackes were used in the following way:\r\n#------------ checkpoints -------------------------------\r\nimport tensorflow.contrib.keras as K\r\nfiledest=\"./models/weights_model011a.best.hdf5\"\r\ncheckpoint = K.callbacks.ModelCheckpoint(filedest, monitor='val_acc', verbose=1, \r\n                             save_best_only=True, mode='max')\r\n\r\ncheckRLR = K.callbacks.ReduceLROnPlateau(monitor='val_acc', factor=0.1, \r\n                                         patience=7,min_lr=1.0e-10)\r\n\r\nearlyStop = K.callbacks.EarlyStopping(monitor='val_acc', patience=30)\r\ntbgraph = K.callbacks.TensorBoard(log_dir='./graphs', histogram_freq=1, \r\n                      write_graph=True, write_images=False, \r\n                      embeddings_freq=1)\r\n\r\ncallbacks_list = [checkpoint,earlyStop,checkRLR,tbgraph]\r\n\r\nand then:\r\nhistory = model.fit(X_train, y_train[:11200], validation_data=(X_test, y_tst_cat[:7200]),\r\n          epochs=epochs, batch_size=40,shuffle=True,\r\n          callbacks=callbacks_list, verbose=0)\r\n\r\nThat resulted in successful run through the training session, but with the following info:\r\nINFO:tensorflow:Summary name embedding/embeddings:0 is illegal; using embedding/embeddings_0 instead.\r\nINFO:tensorflow:Summary name conv1d/kernel:0 is illegal; using conv1d/kernel_0 instead.\r\nINFO:tensorflow:Summary name conv1d/bias:0 is illegal; using conv1d/bias_0 instead.\r\nINFO:tensorflow:Summary name conv1d_1/kernel:0 is illegal; using conv1d_1/kernel_0 instead.\r\nINFO:tensorflow:Summary name conv1d_1/bias:0 is illegal; using conv1d_1/bias_0 instead.\r\nINFO:tensorflow:Summary name conv1d_2/kernel:0 is illegal; using conv1d_2/kernel_0 instead.\r\nINFO:tensorflow:Summary name conv1d_2/bias:0 is illegal; using conv1d_2/bias_0 instead.\r\nINFO:tensorflow:Summary name conv1d_3/kernel:0 is illegal; using conv1d_3/kernel_0 instead.\r\nINFO:tensorflow:Summary name conv1d_3/bias:0 is illegal; using conv1d_3/bias_0 instead.\r\nINFO:tensorflow:Summary name conv1d_4/kernel:0 is illegal; using conv1d_4/kernel_0 instead.\r\nINFO:tensorflow:Summary name conv1d_4/bias:0 is illegal; using conv1d_4/bias_0 instead.\r\nINFO:tensorflow:Summary name dense/kernel:0 is illegal; using dense/kernel_0 instead.\r\nINFO:tensorflow:Summary name dense/bias:0 is illegal; using dense/bias_0 instead.\r\n\r\n2/ Callbacks were used with Keras functional API in similar way, described above. The run resulted in similar info message PLUS the following:\r\nC:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py:411: RuntimeWarning: Can save best model only with val_acc available, skipping.\r\n  'skipping.' % (self.monitor), RuntimeWarning)\r\nC:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py:499: RuntimeWarning: Early stopping requires val_acc available!\r\n  RuntimeWarning)\r\nTraceback (most recent call last):\r\n\r\n  File \"<ipython-input-1-70e23aa02b0a>\", line 1, in <module>\r\n    runfile('C:/path_to_the files/Test_bugs/NonTagTFmodel_local_v011.py', wdir='C:/path_to_the files/Test_bugs')\r\n\r\n  File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\spyder\\utils\\site\\sitecustomize.py\", line 880, in runfile\r\n    execfile(filename, namespace)\r\n\r\n  File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\spyder\\utils\\site\\sitecustomize.py\", line 102, in execfile\r\n    exec(compile(f.read(), filename, 'exec'), namespace)\r\n\r\n  File \"C:/path/Documents/Python Scripts/Recognition/Run09recipes/Test_bugs/NonTagTFmodel_local_v011.py\", line 149, in <module>\r\n    callbacks=callbacks_list, verbose=0)\r\n\r\n  File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\engine\\training.py\", line 1495, in fit\r\n    initial_epoch=initial_epoch)\r\n\r\n  File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\engine\\training.py\", line 1158, in _fit_loop\r\n    callbacks.on_epoch_end(epoch, epoch_logs)\r\n\r\n  File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py\", line 96, in on_epoch_end\r\n    callback.on_epoch_end(epoch, logs)\r\n\r\n  File \"C:\\path\\AppData\\Local\\Continuum\\Miniconda3\\envs\\tensorflow\\lib\\site-packages\\tensorflow\\contrib\\keras\\python\\keras\\callbacks.py\", line 501, in on_epoch_end\r\n    if self.monitor_op(current - self.min_delta, self.best):\r\n\r\nTypeError: unsupported operand type(s) for -: 'NoneType' and 'int'\r\n\r\nThe same code (TF r1.2 and Keras functional API) runs perfectly alright if 'callbacks=None':\r\nhistory = model.fit(X_train, [Y_tr_hot,y_tr_cat[:11200]], validation_data=(X_test, [Y_ts_hot,y_ts_cat[:7200]]),\r\n          epochs=epochs, batch_size=40, shuffle=True,\r\n          callbacks=None, verbose=1)\r\n\r\nWhat can be the reason for Model callbacks not working???"}