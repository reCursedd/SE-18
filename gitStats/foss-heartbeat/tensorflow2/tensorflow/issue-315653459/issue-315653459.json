{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18677", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18677/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18677/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18677/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/18677", "id": 315653459, "node_id": "MDU6SXNzdWUzMTU2NTM0NTk=", "number": 18677, "title": "Tensorflow not respecting device placement for custom ops", "user": {"login": "proteneer", "id": 2280724, "node_id": "MDQ6VXNlcjIyODA3MjQ=", "avatar_url": "https://avatars2.githubusercontent.com/u/2280724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/proteneer", "html_url": "https://github.com/proteneer", "followers_url": "https://api.github.com/users/proteneer/followers", "following_url": "https://api.github.com/users/proteneer/following{/other_user}", "gists_url": "https://api.github.com/users/proteneer/gists{/gist_id}", "starred_url": "https://api.github.com/users/proteneer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/proteneer/subscriptions", "organizations_url": "https://api.github.com/users/proteneer/orgs", "repos_url": "https://api.github.com/users/proteneer/repos", "events_url": "https://api.github.com/users/proteneer/events{/privacy}", "received_events_url": "https://api.github.com/users/proteneer/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-04-18T21:45:25Z", "updated_at": "2018-04-25T16:29:31Z", "closed_at": "2018-04-25T16:29:31Z", "author_association": "NONE", "body_html": "<p>Please go to Stack Overflow for help and support:</p>\n<p><a href=\"https://stackoverflow.com/questions/tagged/tensorflow\" rel=\"nofollow\">https://stackoverflow.com/questions/tagged/tensorflow</a></p>\n<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Ubuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: v1.7.0-3-g024aecf414 1.7.0</li>\n<li><strong>Python version</strong>:  3.5.2</li>\n<li><strong>Bazel version (if compiling from source)</strong>:</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: gcc (Ubuntu 5.4.0-6ubuntu1~16.04.9) 5.4.0 20160609, for the custom op</li>\n<li><strong>CUDA/cuDNN version</strong>: nvcc: NVIDIA (R) Cuda compiler driver<br>\nCopyright (c) 2005-2017 NVIDIA Corporation<br>\nBuilt on Fri_Sep__1_21:08:03_CDT_2017<br>\nCuda compilation tools, release 9.0, V9.0.176</li>\n<li><strong>GPU model and memory</strong>: GTX 1080 Ti</li>\n</ul>\n<h3>Exact command to reproduce</h3>\n<p>Folder for reproducing the issue:</p>\n<p><a href=\"https://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer/debug.py\">https://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer/debug.py</a></p>\n<ol start=\"0\">\n<li>\n<p>Compile with instructions in README.build</p>\n</li>\n<li>\n<p>Run debug.py</p>\n</li>\n</ol>\n<p>log device placement shows that the op is placed on a gpu:</p>\n<p>2018-04-18 17:24:01.008389: I tensorflow/core/common_runtime/placer.cc:884] Featurize: (Featurize)/job:localhost/replica:0/task:0/device:GPU:0</p>\n<p>however, it actually runs on the CPU:</p>\n<div class=\"highlight highlight-source-shell\"><pre>stdout: RUNNING ON CPU<span class=\"pl-k\">!!</span> (this is emitted by the actual CPU kernel <span class=\"pl-k\">in</span> C++)</pre></div>\n<ol start=\"2\">\n<li>Removing the reshape line (line 55) in debug.py:</li>\n</ol>\n<div class=\"highlight highlight-source-python\"><pre>f0, f1, f2, f3 <span class=\"pl-k\">=</span> tf.reshape(f0, (<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">384</span>)), tf.reshape(f1, (<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">384</span>)), tf.reshape(f2, (<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">384</span>)), tf.reshape(f3, (<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">384</span>))</pre></div>\n<p>Successfully triggers the custom op to be run on the GPU:</p>\n<div class=\"highlight highlight-source-shell\"><pre>stdout: RUNNING ON GPU.. (this is emitted by the actual GPU kernel <span class=\"pl-k\">in</span> C++)</pre></div>\n<ol start=\"3\">\n<li>Removing the registration line in ani_op.cpp:</li>\n</ol>\n<div class=\"highlight highlight-source-c++\"><pre><span class=\"pl-en\">REGISTER_KERNEL_BUILDER</span>(Name(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Featurize<span class=\"pl-pds\">\"</span></span>).HostMemory(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>acs<span class=\"pl-pds\">\"</span></span>).Device(DEVICE_CPU), AniCombined&lt;CPUDevice&gt;);</pre></div>\n<p>Restores the intended behavior as in runs properly on the GPU with or without the reshape. But cripples the op in that it only works on GPUs.</p>\n<h3>Describe the problem</h3>\n<p>This should be a bug since we should be enforcing placement of the op onto the GPU. See steps to reproduce the bug. Oddly enough the custom Featurize op in addition to the Reshape op is shown being placed on the GPU:</p>\n<p>2018-04-18 17:24:01.008389: I tensorflow/core/common_runtime/placer.cc:884] Featurize: (Featurize)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape_3: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008404: I tensorflow/core/common_runtime/placer.cc:884] Reshape_3: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape_2: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008418: I tensorflow/core/common_runtime/placer.cc:884] Reshape_2: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape_1: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008432: I tensorflow/core/common_runtime/placer.cc:884] Reshape_1: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008446: I tensorflow/core/common_runtime/placer.cc:884] Reshape: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape_3/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008462: I tensorflow/core/common_runtime/placer.cc:884] Reshape_3/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape_2/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008476: I tensorflow/core/common_runtime/placer.cc:884] Reshape_2/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape_1/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008490: I tensorflow/core/common_runtime/placer.cc:884] Reshape_1/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0<br>\nReshape/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0<br>\n2018-04-18 17:24:01.008505: I tensorflow/core/common_runtime/placer.cc:884] Reshape/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0</p>\n<h3>Source code / logs</h3>\n<p>All the code required is inside here:</p>\n<p><a href=\"https://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer\">https://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer</a></p>", "body_text": "Please go to Stack Overflow for help and support:\nhttps://stackoverflow.com/questions/tagged/tensorflow\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): v1.7.0-3-g024aecf414 1.7.0\nPython version:  3.5.2\nBazel version (if compiling from source):\nGCC/Compiler version (if compiling from source): gcc (Ubuntu 5.4.0-6ubuntu1~16.04.9) 5.4.0 20160609, for the custom op\nCUDA/cuDNN version: nvcc: NVIDIA (R) Cuda compiler driver\nCopyright (c) 2005-2017 NVIDIA Corporation\nBuilt on Fri_Sep__1_21:08:03_CDT_2017\nCuda compilation tools, release 9.0, V9.0.176\nGPU model and memory: GTX 1080 Ti\n\nExact command to reproduce\nFolder for reproducing the issue:\nhttps://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer/debug.py\n\n\nCompile with instructions in README.build\n\n\nRun debug.py\n\n\nlog device placement shows that the op is placed on a gpu:\n2018-04-18 17:24:01.008389: I tensorflow/core/common_runtime/placer.cc:884] Featurize: (Featurize)/job:localhost/replica:0/task:0/device:GPU:0\nhowever, it actually runs on the CPU:\nstdout: RUNNING ON CPU!! (this is emitted by the actual CPU kernel in C++)\n\nRemoving the reshape line (line 55) in debug.py:\n\nf0, f1, f2, f3 = tf.reshape(f0, (-1, 384)), tf.reshape(f1, (-1, 384)), tf.reshape(f2, (-1, 384)), tf.reshape(f3, (-1, 384))\nSuccessfully triggers the custom op to be run on the GPU:\nstdout: RUNNING ON GPU.. (this is emitted by the actual GPU kernel in C++)\n\nRemoving the registration line in ani_op.cpp:\n\nREGISTER_KERNEL_BUILDER(Name(\"Featurize\").HostMemory(\"acs\").Device(DEVICE_CPU), AniCombined<CPUDevice>);\nRestores the intended behavior as in runs properly on the GPU with or without the reshape. But cripples the op in that it only works on GPUs.\nDescribe the problem\nThis should be a bug since we should be enforcing placement of the op onto the GPU. See steps to reproduce the bug. Oddly enough the custom Featurize op in addition to the Reshape op is shown being placed on the GPU:\n2018-04-18 17:24:01.008389: I tensorflow/core/common_runtime/placer.cc:884] Featurize: (Featurize)/job:localhost/replica:0/task:0/device:GPU:0\nReshape_3: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008404: I tensorflow/core/common_runtime/placer.cc:884] Reshape_3: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\nReshape_2: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008418: I tensorflow/core/common_runtime/placer.cc:884] Reshape_2: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\nReshape_1: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008432: I tensorflow/core/common_runtime/placer.cc:884] Reshape_1: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\nReshape: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008446: I tensorflow/core/common_runtime/placer.cc:884] Reshape: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\nReshape_3/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008462: I tensorflow/core/common_runtime/placer.cc:884] Reshape_3/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\nReshape_2/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008476: I tensorflow/core/common_runtime/placer.cc:884] Reshape_2/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\nReshape_1/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008490: I tensorflow/core/common_runtime/placer.cc:884] Reshape_1/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\nReshape/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\n2018-04-18 17:24:01.008505: I tensorflow/core/common_runtime/placer.cc:884] Reshape/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\nSource code / logs\nAll the code required is inside here:\nhttps://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer", "body": "Please go to Stack Overflow for help and support:\r\n\r\nhttps://stackoverflow.com/questions/tagged/tensorflow\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Ubuntu 16.04\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: v1.7.0-3-g024aecf414 1.7.0\r\n- **Python version**:  3.5.2\r\n- **Bazel version (if compiling from source)**:\r\n- **GCC/Compiler version (if compiling from source)**: gcc (Ubuntu 5.4.0-6ubuntu1~16.04.9) 5.4.0 20160609, for the custom op\r\n- **CUDA/cuDNN version**: nvcc: NVIDIA (R) Cuda compiler driver\r\nCopyright (c) 2005-2017 NVIDIA Corporation\r\nBuilt on Fri_Sep__1_21:08:03_CDT_2017\r\nCuda compilation tools, release 9.0, V9.0.176\r\n- **GPU model and memory**: GTX 1080 Ti\r\n\r\n\r\n### Exact command to reproduce\r\n\r\nFolder for reproducing the issue:\r\n\r\nhttps://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer/debug.py\r\n\r\n0. Compile with instructions in README.build\r\n\r\n1. Run debug.py\r\n\r\nlog device placement shows that the op is placed on a gpu:\r\n\r\n2018-04-18 17:24:01.008389: I tensorflow/core/common_runtime/placer.cc:884] Featurize: (Featurize)/job:localhost/replica:0/task:0/device:GPU:0\r\n\r\nhowever, it actually runs on the CPU:\r\n\r\n``` bash\r\nstdout: RUNNING ON CPU!! (this is emitted by the actual CPU kernel in C++)\r\n```\r\n\r\n2. Removing the reshape line (line 55) in debug.py:\r\n\r\n``` python\r\nf0, f1, f2, f3 = tf.reshape(f0, (-1, 384)), tf.reshape(f1, (-1, 384)), tf.reshape(f2, (-1, 384)), tf.reshape(f3, (-1, 384))\r\n```\r\nSuccessfully triggers the custom op to be run on the GPU:\r\n\r\n``` bash\r\nstdout: RUNNING ON GPU.. (this is emitted by the actual GPU kernel in C++)\r\n```\r\n\r\n3. Removing the registration line in ani_op.cpp:\r\n\r\n``` cpp\r\nREGISTER_KERNEL_BUILDER(Name(\"Featurize\").HostMemory(\"acs\").Device(DEVICE_CPU), AniCombined<CPUDevice>);\r\n```\r\n\r\nRestores the intended behavior as in runs properly on the GPU with or without the reshape. But cripples the op in that it only works on GPUs.\r\n\r\n### Describe the problem\r\n\r\nThis should be a bug since we should be enforcing placement of the op onto the GPU. See steps to reproduce the bug. Oddly enough the custom Featurize op in addition to the Reshape op is shown being placed on the GPU:\r\n\r\n2018-04-18 17:24:01.008389: I tensorflow/core/common_runtime/placer.cc:884] Featurize: (Featurize)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape_3: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008404: I tensorflow/core/common_runtime/placer.cc:884] Reshape_3: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape_2: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008418: I tensorflow/core/common_runtime/placer.cc:884] Reshape_2: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape_1: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008432: I tensorflow/core/common_runtime/placer.cc:884] Reshape_1: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape: (Reshape): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008446: I tensorflow/core/common_runtime/placer.cc:884] Reshape: (Reshape)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape_3/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008462: I tensorflow/core/common_runtime/placer.cc:884] Reshape_3/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape_2/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008476: I tensorflow/core/common_runtime/placer.cc:884] Reshape_2/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape_1/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008490: I tensorflow/core/common_runtime/placer.cc:884] Reshape_1/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\r\nReshape/shape: (Const): /job:localhost/replica:0/task:0/device:GPU:0\r\n2018-04-18 17:24:01.008505: I tensorflow/core/common_runtime/placer.cc:884] Reshape/shape: (Const)/job:localhost/replica:0/task:0/device:GPU:0\r\n\r\n\r\n### Source code / logs\r\n\r\nAll the code required is inside here:\r\n\r\nhttps://github.com/proteneer/khan/tree/tf_bug_repro/gpu_featurizer"}