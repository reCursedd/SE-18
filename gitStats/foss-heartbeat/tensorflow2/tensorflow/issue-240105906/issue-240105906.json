{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11239", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11239/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11239/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11239/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/11239", "id": 240105906, "node_id": "MDU6SXNzdWUyNDAxMDU5MDY=", "number": 11239, "title": "Variables in Dataset functions not (always) initialized", "user": {"login": "OlavHN", "id": 324645, "node_id": "MDQ6VXNlcjMyNDY0NQ==", "avatar_url": "https://avatars0.githubusercontent.com/u/324645?v=4", "gravatar_id": "", "url": "https://api.github.com/users/OlavHN", "html_url": "https://github.com/OlavHN", "followers_url": "https://api.github.com/users/OlavHN/followers", "following_url": "https://api.github.com/users/OlavHN/following{/other_user}", "gists_url": "https://api.github.com/users/OlavHN/gists{/gist_id}", "starred_url": "https://api.github.com/users/OlavHN/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/OlavHN/subscriptions", "organizations_url": "https://api.github.com/users/OlavHN/orgs", "repos_url": "https://api.github.com/users/OlavHN/repos", "events_url": "https://api.github.com/users/OlavHN/events{/privacy}", "received_events_url": "https://api.github.com/users/OlavHN/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2017-07-03T08:49:22Z", "updated_at": "2018-05-17T14:13:58Z", "closed_at": "2017-07-07T22:41:10Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>OS</strong>: MacOS 10.12.4</li>\n<li><strong>TensorFlow</strong>: stock cpu tensorflow 1.2 from pip</li>\n<li><strong>Python</strong>: Python 2.7.13</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When using a Dataset function containing tf.Variables needing initialization it succeeds sometimes, but fails other times. I haven't managed to pin point it further using <code>sleep</code>s or <code>tf.control_dependencies</code>.</p>\n<h3>Source code / logs</h3>\n<pre><code>import tensorflow as tf\n\ndef fn(x):\n    v = tf.Variable(5, dtype=tf.int64)\n    return x + v\n\ndataset = (tf.contrib.data.Dataset.range(10)\n    .map(fn)\n)\n\niterator = dataset.make_initializable_iterator()\nnext = iterator.get_next()\n\nwith tf.Session() as sess:\n    sess.run(tf.global_variables_initializer())\n    sess.run(iterator.initializer)\n\n    for i in range(3):\n        res = sess.run(next)\n        print(res)\n</code></pre>\n<p>Moving the <code>v</code> variable out of the <code>fn</code> scope seems to resolve the issue.</p>\n<p>Error log when variable fails to initialize:</p>\n<pre><code>(tf) no00023794:distributed-cluster olanymoe$ python set_test.py \n&lt;MapDataset shapes: (), types: tf.int64&gt;\n2017-07-03 10:33:55.377579: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use SSE4.2 instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:33:55.377593: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:33:55.377597: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:33:55.377601: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use FMA instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:34:05.404642: W tensorflow/core/framework/op_kernel.cc:1158] Failed precondition: Attempting to use uninitialized value Variable\n\t [[Node: Variable/read = Identity[T=DT_INT64, _class=[\"loc:@Variable\"]](Variable)]]\nTraceback (most recent call last):\n  File \"set_test.py\", line 49, in &lt;module&gt;\n    res = sess.run(next)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 789, in run\n    run_metadata_ptr)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 997, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\n    target_list, options, run_metadata)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\n\t [[Node: Variable/read = Identity[T=DT_INT64, _class=[\"loc:@Variable\"]](Variable)]]\n\t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[[]], output_types=[DT_INT64], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](Iterator)]]\n</code></pre>", "body_text": "System information\n\nOS: MacOS 10.12.4\nTensorFlow: stock cpu tensorflow 1.2 from pip\nPython: Python 2.7.13\n\nDescribe the problem\nWhen using a Dataset function containing tf.Variables needing initialization it succeeds sometimes, but fails other times. I haven't managed to pin point it further using sleeps or tf.control_dependencies.\nSource code / logs\nimport tensorflow as tf\n\ndef fn(x):\n    v = tf.Variable(5, dtype=tf.int64)\n    return x + v\n\ndataset = (tf.contrib.data.Dataset.range(10)\n    .map(fn)\n)\n\niterator = dataset.make_initializable_iterator()\nnext = iterator.get_next()\n\nwith tf.Session() as sess:\n    sess.run(tf.global_variables_initializer())\n    sess.run(iterator.initializer)\n\n    for i in range(3):\n        res = sess.run(next)\n        print(res)\n\nMoving the v variable out of the fn scope seems to resolve the issue.\nError log when variable fails to initialize:\n(tf) no00023794:distributed-cluster olanymoe$ python set_test.py \n<MapDataset shapes: (), types: tf.int64>\n2017-07-03 10:33:55.377579: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use SSE4.2 instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:33:55.377593: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:33:55.377597: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:33:55.377601: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use FMA instructions, but these are available on your machine and could speed up CPU computations.\n2017-07-03 10:34:05.404642: W tensorflow/core/framework/op_kernel.cc:1158] Failed precondition: Attempting to use uninitialized value Variable\n\t [[Node: Variable/read = Identity[T=DT_INT64, _class=[\"loc:@Variable\"]](Variable)]]\nTraceback (most recent call last):\n  File \"set_test.py\", line 49, in <module>\n    res = sess.run(next)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 789, in run\n    run_metadata_ptr)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 997, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\n    target_list, options, run_metadata)\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\n\t [[Node: Variable/read = Identity[T=DT_INT64, _class=[\"loc:@Variable\"]](Variable)]]\n\t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[[]], output_types=[DT_INT64], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](Iterator)]]", "body": "### System information\r\n- **OS**: MacOS 10.12.4\r\n- **TensorFlow**: stock cpu tensorflow 1.2 from pip\r\n- **Python**: Python 2.7.13\r\n\r\n### Describe the problem\r\nWhen using a Dataset function containing tf.Variables needing initialization it succeeds sometimes, but fails other times. I haven't managed to pin point it further using `sleep`s or `tf.control_dependencies`.\r\n\r\n### Source code / logs\r\n```\r\nimport tensorflow as tf\r\n\r\ndef fn(x):\r\n    v = tf.Variable(5, dtype=tf.int64)\r\n    return x + v\r\n\r\ndataset = (tf.contrib.data.Dataset.range(10)\r\n    .map(fn)\r\n)\r\n\r\niterator = dataset.make_initializable_iterator()\r\nnext = iterator.get_next()\r\n\r\nwith tf.Session() as sess:\r\n    sess.run(tf.global_variables_initializer())\r\n    sess.run(iterator.initializer)\r\n\r\n    for i in range(3):\r\n        res = sess.run(next)\r\n        print(res)\r\n```\r\n\r\nMoving the `v` variable out of the `fn` scope seems to resolve the issue.\r\n\r\nError log when variable fails to initialize:\r\n```\r\n(tf) no00023794:distributed-cluster olanymoe$ python set_test.py \r\n<MapDataset shapes: (), types: tf.int64>\r\n2017-07-03 10:33:55.377579: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use SSE4.2 instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-07-03 10:33:55.377593: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-07-03 10:33:55.377597: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-07-03 10:33:55.377601: W tensorflow/core/platform/cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use FMA instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-07-03 10:34:05.404642: W tensorflow/core/framework/op_kernel.cc:1158] Failed precondition: Attempting to use uninitialized value Variable\r\n\t [[Node: Variable/read = Identity[T=DT_INT64, _class=[\"loc:@Variable\"]](Variable)]]\r\nTraceback (most recent call last):\r\n  File \"set_test.py\", line 49, in <module>\r\n    res = sess.run(next)\r\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 789, in run\r\n    run_metadata_ptr)\r\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 997, in _run\r\n    feed_dict_string, options, run_metadata)\r\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\r\n    target_list, options, run_metadata)\r\n  File \"/Users/olanymoe/anaconda2/envs/tf/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\r\n\t [[Node: Variable/read = Identity[T=DT_INT64, _class=[\"loc:@Variable\"]](Variable)]]\r\n\t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[[]], output_types=[DT_INT64], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](Iterator)]]\r\n```"}