{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6910", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6910/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6910/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6910/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6910", "id": 201380913, "node_id": "MDU6SXNzdWUyMDEzODA5MTM=", "number": 6910, "title": "Feature Request: Allow disabling the use of host pinned memory", "user": {"login": "gibiansky", "id": 1865411, "node_id": "MDQ6VXNlcjE4NjU0MTE=", "avatar_url": "https://avatars3.githubusercontent.com/u/1865411?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gibiansky", "html_url": "https://github.com/gibiansky", "followers_url": "https://api.github.com/users/gibiansky/followers", "following_url": "https://api.github.com/users/gibiansky/following{/other_user}", "gists_url": "https://api.github.com/users/gibiansky/gists{/gist_id}", "starred_url": "https://api.github.com/users/gibiansky/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gibiansky/subscriptions", "organizations_url": "https://api.github.com/users/gibiansky/orgs", "repos_url": "https://api.github.com/users/gibiansky/repos", "events_url": "https://api.github.com/users/gibiansky/events{/privacy}", "received_events_url": "https://api.github.com/users/gibiansky/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-01-17T19:23:35Z", "updated_at": "2017-01-18T01:50:22Z", "closed_at": "2017-01-18T01:50:22Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Right now, TensorFlow will always use pinned memory (allocated by the stream executor with <code>cuMemHostAlloc</code>) whenever it knows that a tensor will need to be transferred to the GPU (or something like that).</p>\n<p>When a TensorFlow process crashes (does not exit gracefully) due to segfaults or other unforeseen circumstances, the PoolAllocator destructor is not called, and the pinned memory is not freed. When pinned memory is not freed, the CUDA driver does not actually release it, and so memory usage grows over time if you have processes that are not exiting gracefully. After this happens for a while, the machine needs to swap and/or runs out of pinned memory, and if there is no swap space enabled, the node dies (and the only way to recover it is a hard-reboot, not accessible via the network).</p>\n<p>As far as we can tell, there is no workaround to this, and we simply need to disable the pinned memory allocator if we want to be absolutely certain that this cannot happen. Right now, TensorFlow does not allow you to do so.</p>\n<p>Proposal: There is currently an environment variable called <code>TF_CUDA_HOST_MEM_LIMIT_IN_MB</code> which used to set a maximum size for the <code>BFCAllocator</code> that does CUDA host memory allocation. In order to implement this feature, we would check whether the value of that environment variable is zero, and, if it is zero, use a non-pinned memory allocator as the sub-allocator for the BFCAllocator.</p>\n<p>Is that acceptable?</p>\n<p><a href=\"https://github.com/tensorflow/tensorflow/issues/3701\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/3701/hovercard\">This</a> issue was probably related.</p>", "body_text": "Right now, TensorFlow will always use pinned memory (allocated by the stream executor with cuMemHostAlloc) whenever it knows that a tensor will need to be transferred to the GPU (or something like that).\nWhen a TensorFlow process crashes (does not exit gracefully) due to segfaults or other unforeseen circumstances, the PoolAllocator destructor is not called, and the pinned memory is not freed. When pinned memory is not freed, the CUDA driver does not actually release it, and so memory usage grows over time if you have processes that are not exiting gracefully. After this happens for a while, the machine needs to swap and/or runs out of pinned memory, and if there is no swap space enabled, the node dies (and the only way to recover it is a hard-reboot, not accessible via the network).\nAs far as we can tell, there is no workaround to this, and we simply need to disable the pinned memory allocator if we want to be absolutely certain that this cannot happen. Right now, TensorFlow does not allow you to do so.\nProposal: There is currently an environment variable called TF_CUDA_HOST_MEM_LIMIT_IN_MB which used to set a maximum size for the BFCAllocator that does CUDA host memory allocation. In order to implement this feature, we would check whether the value of that environment variable is zero, and, if it is zero, use a non-pinned memory allocator as the sub-allocator for the BFCAllocator.\nIs that acceptable?\nThis issue was probably related.", "body": "Right now, TensorFlow will always use pinned memory (allocated by the stream executor with `cuMemHostAlloc`) whenever it knows that a tensor will need to be transferred to the GPU (or something like that).\r\n\r\nWhen a TensorFlow process crashes (does not exit gracefully) due to segfaults or other unforeseen circumstances, the PoolAllocator destructor is not called, and the pinned memory is not freed. When pinned memory is not freed, the CUDA driver does not actually release it, and so memory usage grows over time if you have processes that are not exiting gracefully. After this happens for a while, the machine needs to swap and/or runs out of pinned memory, and if there is no swap space enabled, the node dies (and the only way to recover it is a hard-reboot, not accessible via the network).\r\n\r\nAs far as we can tell, there is no workaround to this, and we simply need to disable the pinned memory allocator if we want to be absolutely certain that this cannot happen. Right now, TensorFlow does not allow you to do so.\r\n\r\nProposal: There is currently an environment variable called `TF_CUDA_HOST_MEM_LIMIT_IN_MB` which used to set a maximum size for the `BFCAllocator` that does CUDA host memory allocation. In order to implement this feature, we would check whether the value of that environment variable is zero, and, if it is zero, use a non-pinned memory allocator as the sub-allocator for the BFCAllocator.\r\n\r\nIs that acceptable?\r\n\r\n[This](https://github.com/tensorflow/tensorflow/issues/3701) issue was probably related."}