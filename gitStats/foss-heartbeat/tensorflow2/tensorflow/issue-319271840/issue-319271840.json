{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19003", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19003/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19003/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19003/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19003", "id": 319271840, "node_id": "MDU6SXNzdWUzMTkyNzE4NDA=", "number": 19003, "title": "Dockerfile.gpu keeps the pip package", "user": {"login": "flx42", "id": 3645581, "node_id": "MDQ6VXNlcjM2NDU1ODE=", "avatar_url": "https://avatars3.githubusercontent.com/u/3645581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flx42", "html_url": "https://github.com/flx42", "followers_url": "https://api.github.com/users/flx42/followers", "following_url": "https://api.github.com/users/flx42/following{/other_user}", "gists_url": "https://api.github.com/users/flx42/gists{/gist_id}", "starred_url": "https://api.github.com/users/flx42/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flx42/subscriptions", "organizations_url": "https://api.github.com/users/flx42/orgs", "repos_url": "https://api.github.com/users/flx42/repos", "events_url": "https://api.github.com/users/flx42/events{/privacy}", "received_events_url": "https://api.github.com/users/flx42/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": {"login": "angersson", "id": 32465472, "node_id": "MDQ6VXNlcjMyNDY1NDcy", "avatar_url": "https://avatars2.githubusercontent.com/u/32465472?v=4", "gravatar_id": "", "url": "https://api.github.com/users/angersson", "html_url": "https://github.com/angersson", "followers_url": "https://api.github.com/users/angersson/followers", "following_url": "https://api.github.com/users/angersson/following{/other_user}", "gists_url": "https://api.github.com/users/angersson/gists{/gist_id}", "starred_url": "https://api.github.com/users/angersson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/angersson/subscriptions", "organizations_url": "https://api.github.com/users/angersson/orgs", "repos_url": "https://api.github.com/users/angersson/repos", "events_url": "https://api.github.com/users/angersson/events{/privacy}", "received_events_url": "https://api.github.com/users/angersson/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "angersson", "id": 32465472, "node_id": "MDQ6VXNlcjMyNDY1NDcy", "avatar_url": "https://avatars2.githubusercontent.com/u/32465472?v=4", "gravatar_id": "", "url": "https://api.github.com/users/angersson", "html_url": "https://github.com/angersson", "followers_url": "https://api.github.com/users/angersson/followers", "following_url": "https://api.github.com/users/angersson/following{/other_user}", "gists_url": "https://api.github.com/users/angersson/gists{/gist_id}", "starred_url": "https://api.github.com/users/angersson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/angersson/subscriptions", "organizations_url": "https://api.github.com/users/angersson/orgs", "repos_url": "https://api.github.com/users/angersson/repos", "events_url": "https://api.github.com/users/angersson/events{/privacy}", "received_events_url": "https://api.github.com/users/angersson/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 10, "created_at": "2018-05-01T17:51:33Z", "updated_at": "2018-11-20T13:27:38Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<pre><code>$ docker run --rm tensorflow/tensorflow:nightly-gpu-py3 sh -c 'ls -lh /*.whl'\n-rw-rw-r-- 1 root root 207M May  1 04:54 /tf_nightly_gpu-1.9.0.dev20180429-cp35-cp35m-manylinux1_x86_64.whl\n</code></pre>\n<p>This is 200MB we should get rid of.</p>\n<p>In Dockerfile.gpu we have this:<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d/tensorflow/tools/docker/Dockerfile.gpu#L47-L56\">tensorflow/tensorflow/tools/docker/Dockerfile.gpu</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n        Lines 47 to 56\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d\">d0f5bc1</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L47\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"47\"></td>\n          <td id=\"LC47\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # --- DO NOT EDIT OR DELETE BETWEEN THE LINES --- # </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L48\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"48\"></td>\n          <td id=\"LC48\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # These lines will be edited automatically by parameterized_docker_build.sh. # </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L49\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"49\"></td>\n          <td id=\"LC49\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # COPY _PIP_FILE_ / </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L50\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"50\"></td>\n          <td id=\"LC50\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # RUN pip --no-cache-dir install /_PIP_FILE_ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L51\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"51\"></td>\n          <td id=\"LC51\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # RUN rm -f /_PIP_FILE_ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L52\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"52\"></td>\n          <td id=\"LC52\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L53\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"53\"></td>\n          <td id=\"LC53\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # Install TensorFlow GPU version. </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L54\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"54\"></td>\n          <td id=\"LC54\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> RUN pip --no-cache-dir install \\ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L55\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"55\"></td>\n          <td id=\"LC55\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\">     http://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.0.0-cp27-none-linux_x86_64.whl </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L56\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"56\"></td>\n          <td id=\"LC56\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # --- ~ DO NOT EDIT OR DELETE BETWEEN THE LINES --- # </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p>In <code>parameterized_docker_build.sh</code> this block is replaced this way:<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d/tensorflow/tools/docker/parameterized_docker_build.sh#L260-L263\">tensorflow/tensorflow/tools/docker/parameterized_docker_build.sh</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n        Lines 260 to 263\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d\">d0f5bc1</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L260\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"260\"></td>\n          <td id=\"LC260\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\">     sed -e <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/# --- DO NOT EDIT OR DELETE BETWEEN THE LINES --- #/,<span class=\"pl-pds\">\"</span></span>\\ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L261\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"261\"></td>\n          <td id=\"LC261\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/# --- ~ DO NOT EDIT OR DELETE BETWEEN THE LINES --- #/c<span class=\"pl-pds\">\"</span></span>\\ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L262\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"262\"></td>\n          <td id=\"LC262\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>COPY <span class=\"pl-smi\">${PIP_WHL}</span> /\\n<span class=\"pl-pds\">\"</span></span>\\ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L263\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"263\"></td>\n          <td id=\"LC263\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>RUN pip --no-cache-dir install /<span class=\"pl-smi\">${PIP_WHL}</span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${ORIG_DOCKERFILE}</span><span class=\"pl-pds\">\"</span></span> \\ </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p>We don't have the <code>RUN rm -f /_PIP_FILE_</code> but it doesn't really matter for the size of the image. Since the <code>COPY</code> is necessarily a different layer than the <code>RUN</code>, see my commit message here: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/9da73dedfc14861a7efcd44a9943d28ced038dc5/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/9da73dedfc14861a7efcd44a9943d28ced038dc5\"><tt>9da73de</tt></a></p>\n<p>There is no simple solution here, multi-stage builds won't help, I will spare you the black magic technique since we have another option right in front of us:<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d/tensorflow/tools/docker/Dockerfile.gpu#L53-L55\">tensorflow/tensorflow/tools/docker/Dockerfile.gpu</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n        Lines 53 to 55\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d\">d0f5bc1</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L53\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"53\"></td>\n          <td id=\"LC53\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> # Install TensorFlow GPU version. </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L54\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"54\"></td>\n          <td id=\"LC54\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> RUN pip --no-cache-dir install \\ </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L55\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"55\"></td>\n          <td id=\"LC55\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\">     http://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.0.0-cp27-none-linux_x86_64.whl </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<br>\nWhat prevents us from modifying the parameters passed to <code>parameterized_docker_build.sh</code> to download the pip package? I think a 200MB improvement is worth it.</p>\n<p>cc <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=7946809\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/gunan\">@gunan</a></p>", "body_text": "$ docker run --rm tensorflow/tensorflow:nightly-gpu-py3 sh -c 'ls -lh /*.whl'\n-rw-rw-r-- 1 root root 207M May  1 04:54 /tf_nightly_gpu-1.9.0.dev20180429-cp35-cp35m-manylinux1_x86_64.whl\n\nThis is 200MB we should get rid of.\nIn Dockerfile.gpu we have this:\n\n  \n    \n      tensorflow/tensorflow/tools/docker/Dockerfile.gpu\n    \n    \n        Lines 47 to 56\n      in\n      d0f5bc1\n    \n    \n    \n    \n\n        \n          \n           # --- DO NOT EDIT OR DELETE BETWEEN THE LINES --- # \n        \n\n        \n          \n           # These lines will be edited automatically by parameterized_docker_build.sh. # \n        \n\n        \n          \n           # COPY _PIP_FILE_ / \n        \n\n        \n          \n           # RUN pip --no-cache-dir install /_PIP_FILE_ \n        \n\n        \n          \n           # RUN rm -f /_PIP_FILE_ \n        \n\n        \n          \n            \n        \n\n        \n          \n           # Install TensorFlow GPU version. \n        \n\n        \n          \n           RUN pip --no-cache-dir install \\ \n        \n\n        \n          \n               http://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.0.0-cp27-none-linux_x86_64.whl \n        \n\n        \n          \n           # --- ~ DO NOT EDIT OR DELETE BETWEEN THE LINES --- # \n        \n    \n  \n\n\nIn parameterized_docker_build.sh this block is replaced this way:\n\n  \n    \n      tensorflow/tensorflow/tools/docker/parameterized_docker_build.sh\n    \n    \n        Lines 260 to 263\n      in\n      d0f5bc1\n    \n    \n    \n    \n\n        \n          \n               sed -e \"/# --- DO NOT EDIT OR DELETE BETWEEN THE LINES --- #/,\"\\ \n        \n\n        \n          \n           \"/# --- ~ DO NOT EDIT OR DELETE BETWEEN THE LINES --- #/c\"\\ \n        \n\n        \n          \n           \"COPY ${PIP_WHL} /\\n\"\\ \n        \n\n        \n          \n           \"RUN pip --no-cache-dir install /${PIP_WHL}\" \"${ORIG_DOCKERFILE}\" \\ \n        \n    \n  \n\n\nWe don't have the RUN rm -f /_PIP_FILE_ but it doesn't really matter for the size of the image. Since the COPY is necessarily a different layer than the RUN, see my commit message here: 9da73de\nThere is no simple solution here, multi-stage builds won't help, I will spare you the black magic technique since we have another option right in front of us:\n\n  \n    \n      tensorflow/tensorflow/tools/docker/Dockerfile.gpu\n    \n    \n        Lines 53 to 55\n      in\n      d0f5bc1\n    \n    \n    \n    \n\n        \n          \n           # Install TensorFlow GPU version. \n        \n\n        \n          \n           RUN pip --no-cache-dir install \\ \n        \n\n        \n          \n               http://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.0.0-cp27-none-linux_x86_64.whl \n        \n    \n  \n\n\nWhat prevents us from modifying the parameters passed to parameterized_docker_build.sh to download the pip package? I think a 200MB improvement is worth it.\ncc @gunan", "body": "```\r\n$ docker run --rm tensorflow/tensorflow:nightly-gpu-py3 sh -c 'ls -lh /*.whl'\r\n-rw-rw-r-- 1 root root 207M May  1 04:54 /tf_nightly_gpu-1.9.0.dev20180429-cp35-cp35m-manylinux1_x86_64.whl\r\n```\r\nThis is 200MB we should get rid of.\r\n\r\nIn Dockerfile.gpu we have this:\r\nhttps://github.com/tensorflow/tensorflow/blob/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d/tensorflow/tools/docker/Dockerfile.gpu#L47-L56\r\n\r\nIn `parameterized_docker_build.sh` this block is replaced this way:\r\nhttps://github.com/tensorflow/tensorflow/blob/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d/tensorflow/tools/docker/parameterized_docker_build.sh#L260-L263\r\n\r\nWe don't have the `RUN rm -f /_PIP_FILE_` but it doesn't really matter for the size of the image. Since the `COPY` is necessarily a different layer than the `RUN`, see my commit message here: https://github.com/tensorflow/tensorflow/commit/9da73dedfc14861a7efcd44a9943d28ced038dc5\r\n\r\nThere is no simple solution here, multi-stage builds won't help, I will spare you the black magic technique since we have another option right in front of us:\r\nhttps://github.com/tensorflow/tensorflow/blob/d0f5bc17560fc97bcc7de9164aa3b237a8d5221d/tensorflow/tools/docker/Dockerfile.gpu#L53-L55\r\nWhat prevents us from modifying the parameters passed to `parameterized_docker_build.sh` to download the pip package? I think a 200MB improvement is worth it. \r\n\r\ncc @gunan "}