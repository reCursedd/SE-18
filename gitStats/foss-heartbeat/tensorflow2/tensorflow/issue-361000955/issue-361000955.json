{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22321", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22321/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22321/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22321/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22321", "id": 361000955, "node_id": "MDU6SXNzdWUzNjEwMDA5NTU=", "number": 22321, "title": "Distributed training fails when I use CollectiveAllReduceStrategy", "user": {"login": "dmitrievanthony", "id": 1028969, "node_id": "MDQ6VXNlcjEwMjg5Njk=", "avatar_url": "https://avatars3.githubusercontent.com/u/1028969?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dmitrievanthony", "html_url": "https://github.com/dmitrievanthony", "followers_url": "https://api.github.com/users/dmitrievanthony/followers", "following_url": "https://api.github.com/users/dmitrievanthony/following{/other_user}", "gists_url": "https://api.github.com/users/dmitrievanthony/gists{/gist_id}", "starred_url": "https://api.github.com/users/dmitrievanthony/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dmitrievanthony/subscriptions", "organizations_url": "https://api.github.com/users/dmitrievanthony/orgs", "repos_url": "https://api.github.com/users/dmitrievanthony/repos", "events_url": "https://api.github.com/users/dmitrievanthony/events{/privacy}", "received_events_url": "https://api.github.com/users/dmitrievanthony/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "yuefengz", "id": 1647833, "node_id": "MDQ6VXNlcjE2NDc4MzM=", "avatar_url": "https://avatars0.githubusercontent.com/u/1647833?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yuefengz", "html_url": "https://github.com/yuefengz", "followers_url": "https://api.github.com/users/yuefengz/followers", "following_url": "https://api.github.com/users/yuefengz/following{/other_user}", "gists_url": "https://api.github.com/users/yuefengz/gists{/gist_id}", "starred_url": "https://api.github.com/users/yuefengz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yuefengz/subscriptions", "organizations_url": "https://api.github.com/users/yuefengz/orgs", "repos_url": "https://api.github.com/users/yuefengz/repos", "events_url": "https://api.github.com/users/yuefengz/events{/privacy}", "received_events_url": "https://api.github.com/users/yuefengz/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "yuefengz", "id": 1647833, "node_id": "MDQ6VXNlcjE2NDc4MzM=", "avatar_url": "https://avatars0.githubusercontent.com/u/1647833?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yuefengz", "html_url": "https://github.com/yuefengz", "followers_url": "https://api.github.com/users/yuefengz/followers", "following_url": "https://api.github.com/users/yuefengz/following{/other_user}", "gists_url": "https://api.github.com/users/yuefengz/gists{/gist_id}", "starred_url": "https://api.github.com/users/yuefengz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yuefengz/subscriptions", "organizations_url": "https://api.github.com/users/yuefengz/orgs", "repos_url": "https://api.github.com/users/yuefengz/repos", "events_url": "https://api.github.com/users/yuefengz/events{/privacy}", "received_events_url": "https://api.github.com/users/yuefengz/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 15, "created_at": "2018-09-17T19:03:18Z", "updated_at": "2018-09-22T16:23:37Z", "closed_at": "2018-09-22T16:23:37Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<ul>\n<li>\n<p><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nI slightly updated mnist.py example so that it uses CollectiveAllReduceStrategy. Updated version is <a href=\"https://github.com/dmitrievanthony/models/blob/ignite/official/mnist/mnist.py#L208\">here</a>.</p>\n</li>\n<li>\n<p><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nMac OS 10.13.3</p>\n</li>\n<li>\n<p><strong>TensorFlow installed from (source or binary)</strong>:<br>\nBinary</p>\n</li>\n<li>\n<p><strong>TensorFlow version (use command below)</strong>:<br>\n1.11.0-dev20180913</p>\n</li>\n<li>\n<p><strong>Python version</strong>:<br>\n3.6.3</p>\n</li>\n<li>\n<p><strong>Exact command to reproduce</strong>:<br>\nSee <a href=\"https://github.com/dmitrievanthony/models/blob/ignite/official/mnist/mnist.py#L208\">updated example</a>.</p>\n</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>Hi,</p>\n<p>I'm trying to update <code>mnist</code> model from <a href=\"https://github.com/tensorflow/models/tree/master/official/\">official repository</a> so that it uses CollectiveAllReduceStrategy as it's shown in <a href=\"https://github.com/tensorflow/ecosystem/blob/master/distribution_strategy/keras_model_to_estimator_client.py\">keras_model_to_estimator_client.py</a>. Updated example you can find <a href=\"https://github.com/dmitrievanthony/models/blob/ignite/official/mnist/mnist.py#L208\">here</a>. Unfortunately, it fails on <code>deepcopy</code> of run config.</p>\n<h3>Source code / logs</h3>\n<pre><code>Traceback (most recent call last):\n  File \"mnist.py\", line 286, in &lt;module&gt;\n    absl_app.run(main)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/absl/app.py\", line 274, in run\n    _run_main(main, args)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/absl/app.py\", line 238, in _run_main\n    sys.exit(main(argv))\n  File \"mnist.py\", line 280, in main\n    run_mnist(flags.FLAGS)\n  File \"mnist.py\", line 226, in run_mnist\n    'data_format': data_format,\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 190, in __init__\n    model_dir)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1591, in maybe_overwrite_model_dir_and_session_config\n    config = run_config.RunConfig.replace(config, session_config=session_config)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/run_config.py\", line 849, in replace\n    copy.deepcopy(self),\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\n    y = _reconstruct(x, memo, *rv)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\n    state = deepcopy(state, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\n    y = copier(x, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\n    y = _reconstruct(x, memo, *rv)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\n    state = deepcopy(state, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\n    y = copier(x, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\n    y = _reconstruct(x, memo, *rv)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\n    state = deepcopy(state, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\n    y = copier(x, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 169, in deepcopy\n    rv = reductor(4)\nTypeError: can't pickle _thread._local objects\n</code></pre>", "body_text": "System information\n\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nI slightly updated mnist.py example so that it uses CollectiveAllReduceStrategy. Updated version is here.\n\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nMac OS 10.13.3\n\n\nTensorFlow installed from (source or binary):\nBinary\n\n\nTensorFlow version (use command below):\n1.11.0-dev20180913\n\n\nPython version:\n3.6.3\n\n\nExact command to reproduce:\nSee updated example.\n\n\nDescribe the problem\nHi,\nI'm trying to update mnist model from official repository so that it uses CollectiveAllReduceStrategy as it's shown in keras_model_to_estimator_client.py. Updated example you can find here. Unfortunately, it fails on deepcopy of run config.\nSource code / logs\nTraceback (most recent call last):\n  File \"mnist.py\", line 286, in <module>\n    absl_app.run(main)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/absl/app.py\", line 274, in run\n    _run_main(main, args)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/absl/app.py\", line 238, in _run_main\n    sys.exit(main(argv))\n  File \"mnist.py\", line 280, in main\n    run_mnist(flags.FLAGS)\n  File \"mnist.py\", line 226, in run_mnist\n    'data_format': data_format,\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 190, in __init__\n    model_dir)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1591, in maybe_overwrite_model_dir_and_session_config\n    config = run_config.RunConfig.replace(config, session_config=session_config)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/run_config.py\", line 849, in replace\n    copy.deepcopy(self),\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\n    y = _reconstruct(x, memo, *rv)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\n    state = deepcopy(state, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\n    y = copier(x, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\n    y = _reconstruct(x, memo, *rv)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\n    state = deepcopy(state, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\n    y = copier(x, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\n    y = _reconstruct(x, memo, *rv)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\n    state = deepcopy(state, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\n    y = copier(x, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 169, in deepcopy\n    rv = reductor(4)\nTypeError: can't pickle _thread._local objects", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nI slightly updated mnist.py example so that it uses CollectiveAllReduceStrategy. Updated version is [here](https://github.com/dmitrievanthony/models/blob/ignite/official/mnist/mnist.py#L208).\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nMac OS 10.13.3\r\n\r\n- **TensorFlow installed from (source or binary)**:\r\nBinary\r\n\r\n- **TensorFlow version (use command below)**:\r\n1.11.0-dev20180913\r\n\r\n- **Python version**:\r\n3.6.3\r\n\r\n- **Exact command to reproduce**:\r\nSee [updated example](https://github.com/dmitrievanthony/models/blob/ignite/official/mnist/mnist.py#L208).\r\n\r\n### Describe the problem\r\n\r\nHi, \r\n\r\nI'm trying to update `mnist` model from [official repository](https://github.com/tensorflow/models/tree/master/official/) so that it uses CollectiveAllReduceStrategy as it's shown in [keras_model_to_estimator_client.py](https://github.com/tensorflow/ecosystem/blob/master/distribution_strategy/keras_model_to_estimator_client.py). Updated example you can find [here](https://github.com/dmitrievanthony/models/blob/ignite/official/mnist/mnist.py#L208). Unfortunately, it fails on `deepcopy` of run config.\r\n\r\n### Source code / logs\r\n```\r\nTraceback (most recent call last):\r\n  File \"mnist.py\", line 286, in <module>\r\n    absl_app.run(main)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/absl/app.py\", line 274, in run\r\n    _run_main(main, args)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/absl/app.py\", line 238, in _run_main\r\n    sys.exit(main(argv))\r\n  File \"mnist.py\", line 280, in main\r\n    run_mnist(flags.FLAGS)\r\n  File \"mnist.py\", line 226, in run_mnist\r\n    'data_format': data_format,\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 190, in __init__\r\n    model_dir)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1591, in maybe_overwrite_model_dir_and_session_config\r\n    config = run_config.RunConfig.replace(config, session_config=session_config)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/run_config.py\", line 849, in replace\r\n    copy.deepcopy(self),\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\r\n    y = _reconstruct(x, memo, *rv)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\r\n    state = deepcopy(state, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\r\n    y = copier(x, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\r\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\r\n    y = _reconstruct(x, memo, *rv)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\r\n    state = deepcopy(state, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\r\n    y = copier(x, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\r\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 180, in deepcopy\r\n    y = _reconstruct(x, memo, *rv)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 280, in _reconstruct\r\n    state = deepcopy(state, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 150, in deepcopy\r\n    y = copier(x, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 240, in _deepcopy_dict\r\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\r\n  File \"/Users/antondmitriev/anaconda3/lib/python3.6/copy.py\", line 169, in deepcopy\r\n    rv = reductor(4)\r\nTypeError: can't pickle _thread._local objects\r\n```\r\n"}