{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/368703721", "html_url": "https://github.com/tensorflow/tensorflow/issues/17204#issuecomment-368703721", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17204", "id": 368703721, "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODcwMzcyMQ==", "user": {"login": "yaroslavvb", "id": 23068, "node_id": "MDQ6VXNlcjIzMDY4", "avatar_url": "https://avatars3.githubusercontent.com/u/23068?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yaroslavvb", "html_url": "https://github.com/yaroslavvb", "followers_url": "https://api.github.com/users/yaroslavvb/followers", "following_url": "https://api.github.com/users/yaroslavvb/following{/other_user}", "gists_url": "https://api.github.com/users/yaroslavvb/gists{/gist_id}", "starred_url": "https://api.github.com/users/yaroslavvb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yaroslavvb/subscriptions", "organizations_url": "https://api.github.com/users/yaroslavvb/orgs", "repos_url": "https://api.github.com/users/yaroslavvb/repos", "events_url": "https://api.github.com/users/yaroslavvb/events{/privacy}", "received_events_url": "https://api.github.com/users/yaroslavvb/received_events", "type": "User", "site_admin": false}, "created_at": "2018-02-27T00:38:58Z", "updated_at": "2018-02-27T00:50:09Z", "author_association": "CONTRIBUTOR", "body_html": "<p>TensorFlow H2D becomes much faster if I enable tcmalloc.</p>\n<pre><code>sudo apt-get install -y google-perftools\nexport LD_PRELOAD=\"/usr/lib/libtcmalloc.so.4\"\npython tf_numpy_benchmark.py --benchmark=feed_gpu_tensor --allocator=numpy --num-iters=51\nfeed_gpu_tensor               :   7.9 GB/sec, min: 12.73, median: 13.07, mean: 13.00\n</code></pre>\n<p>Theory -- something in TensorFlow is sensitive to memory properties (posix_memalign flags?), and triggers an additional CPU memory copy before calling cudaMemCopyAsync. On other hand, PyTorch is not sensitive to this, and calls <code>cudaMemCopyAsync</code> right away. Hard to check because enabling cpu profiler also makes the slowness disappear, classical heisenbug</p>", "body_text": "TensorFlow H2D becomes much faster if I enable tcmalloc.\nsudo apt-get install -y google-perftools\nexport LD_PRELOAD=\"/usr/lib/libtcmalloc.so.4\"\npython tf_numpy_benchmark.py --benchmark=feed_gpu_tensor --allocator=numpy --num-iters=51\nfeed_gpu_tensor               :   7.9 GB/sec, min: 12.73, median: 13.07, mean: 13.00\n\nTheory -- something in TensorFlow is sensitive to memory properties (posix_memalign flags?), and triggers an additional CPU memory copy before calling cudaMemCopyAsync. On other hand, PyTorch is not sensitive to this, and calls cudaMemCopyAsync right away. Hard to check because enabling cpu profiler also makes the slowness disappear, classical heisenbug", "body": "TensorFlow H2D becomes much faster if I enable tcmalloc.\r\n```\r\nsudo apt-get install -y google-perftools\r\nexport LD_PRELOAD=\"/usr/lib/libtcmalloc.so.4\"\r\npython tf_numpy_benchmark.py --benchmark=feed_gpu_tensor --allocator=numpy --num-iters=51\r\nfeed_gpu_tensor               :   7.9 GB/sec, min: 12.73, median: 13.07, mean: 13.00\r\n```\r\n\r\nTheory -- something in TensorFlow is sensitive to memory properties (posix_memalign flags?), and triggers an additional CPU memory copy before calling cudaMemCopyAsync. On other hand, PyTorch is not sensitive to this, and calls `cudaMemCopyAsync` right away. Hard to check because enabling cpu profiler also makes the slowness disappear, classical heisenbug\r\n\r\n"}