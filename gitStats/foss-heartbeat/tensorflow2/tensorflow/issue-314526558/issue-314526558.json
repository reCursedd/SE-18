{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18546", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18546/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18546/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18546/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/18546", "id": 314526558, "node_id": "MDU6SXNzdWUzMTQ1MjY1NTg=", "number": 18546, "title": "call session.run() concurrency, latency boom", "user": {"login": "yjhjstz", "id": 3832082, "node_id": "MDQ6VXNlcjM4MzIwODI=", "avatar_url": "https://avatars3.githubusercontent.com/u/3832082?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yjhjstz", "html_url": "https://github.com/yjhjstz", "followers_url": "https://api.github.com/users/yjhjstz/followers", "following_url": "https://api.github.com/users/yjhjstz/following{/other_user}", "gists_url": "https://api.github.com/users/yjhjstz/gists{/gist_id}", "starred_url": "https://api.github.com/users/yjhjstz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yjhjstz/subscriptions", "organizations_url": "https://api.github.com/users/yjhjstz/orgs", "repos_url": "https://api.github.com/users/yjhjstz/repos", "events_url": "https://api.github.com/users/yjhjstz/events{/privacy}", "received_events_url": "https://api.github.com/users/yjhjstz/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2018-04-16T07:12:12Z", "updated_at": "2018-04-25T16:28:45Z", "closed_at": "2018-04-25T16:28:45Z", "author_association": "NONE", "body_html": "<p>background: serving mnist model using libtensorflow_cc.so and libtensorflow_framework.so gpu(p40) version</p>\n<p>below: limit 3 concurrency to call <code>session.run()</code>, got the latency 508us, very close to serial run.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/3832082/38794426-a9a36dc4-4187-11e8-8aa6-57df4c61578f.png\"><img src=\"https://user-images.githubusercontent.com/3832082/38794426-a9a36dc4-4187-11e8-8aa6-57df4c61578f.png\" alt=\"image\" style=\"max-width:100%;\"></a></p>\n<p>However, expand  concurrency to 24 , <code>session.run()</code> got the latency 1256us<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/3832082/38794599-3c0e1380-4188-11e8-9560-6dd4fd1e9750.png\"><img src=\"https://user-images.githubusercontent.com/3832082/38794599-3c0e1380-4188-11e8-9560-6dd4fd1e9750.png\" alt=\"image\" style=\"max-width:100%;\"></a></p>\n<p>anyone can help ?</p>\n<p>logs\uff1a</p>\n<div class=\"highlight highlight-source-shell\"><pre>[DDL-Serving]$ ./DDL_server --model_config_file=/home/luban/DDL-Serving/config.json\n2018-04-16 14:29:38.599280: I /home/luban/DDL-Serving/core/server_core.cc:91] Loading models:tensorflow\n2018-04-16 14:29:38.599490: I /home/luban/DDL-Serving/core/server_core.cc:98] name:/home/luban/DDL-Serving/mnist_model/3\nI0416 14:29:38.599814 23547 /home/luban/DDL-Serving/core/loader_helper.cc:59] Approving load <span class=\"pl-k\">for</span> servable version { name:mnist ,version:3}\nI0416 14:29:38.599953 23549 /home/luban/DDL-Serving/core/loader_helper.cc:67] Loading servable version { name:mnist ,version:3}\nI0416 14:29:38.600110 23549 /home/luban/DDL-Serving/core/tf_bundle_factory.cc:230] Attempting to load native SavedModelBundle <span class=\"pl-k\">in</span> loader.cc from: /home/luban/DDL-Serving/mnist_model/3\n2018-04-16 14:29:38.600163: I tensorflow/cc/saved_model/loader.cc:242] Loading SavedModel with tags: { serve }<span class=\"pl-k\">;</span> from: /home/luban/DDL-Serving/mnist_model/3\n2018-04-16 14:29:38.910954: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1344] Found device 0 with properties:\nname: Tesla P40 major: 6 minor: 1 memoryClockRate(GHz): 1.531\npciBusID: 0000:02:00.0\ntotalMemory: 22.38GiB freeMemory: 22.21GiB\n2018-04-16 14:29:38.911028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1423] Adding visible gpu devices: 0\n2018-04-16 14:29:39.721881: I tensorflow/core/common_runtime/gpu/gpu_device.cc:911] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-04-16 14:29:39.721955: I tensorflow/core/common_runtime/gpu/gpu_device.cc:917]      0\n2018-04-16 14:29:39.721971: I tensorflow/core/common_runtime/gpu/gpu_device.cc:930] 0:   N\n2018-04-16 14:29:39.722897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21555 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:02:00.0, compute capability: 6.1)\n2018-04-16 14:29:40.028849: I tensorflow/cc/saved_model/loader.cc:161] Restoring SavedModel bundle.\n2018-04-16 14:29:40.034555: I tensorflow/cc/saved_model/loader.cc:196] Running LegacyInitOp on SavedModel bundle.\n2018-04-16 14:29:40.040415: I tensorflow/cc/saved_model/loader.cc:291] SavedModel load <span class=\"pl-k\">for</span> tags { serve }<span class=\"pl-k\">;</span> Status: success. Took 1440252 microseconds.\nI0416 14:29:40.040555 23549 /home/luban/DDL-Serving/core/loader_helper.cc:77] Successfully loaded servable version { name:mnist ,version:3}\n2018-04-16 14:29:40.040656: I /home/luban/DDL-Serving/core/server_core.cc:98] name:/home/luban/DDL-Serving/mnist_model/1\nI0416 14:29:40.040829 23547 /home/luban/DDL-Serving/core/loader_helper.cc:59] Approving load <span class=\"pl-k\">for</span> servable version { name:mnist ,version:1}\nI0416 14:29:40.040890 23549 /home/luban/DDL-Serving/core/loader_helper.cc:67] Loading servable version { name:mnist ,version:1}\nI0416 14:29:40.040937 23549 /home/luban/DDL-Serving/core/tf_bundle_factory.cc:230] Attempting to load native SavedModelBundle <span class=\"pl-k\">in</span> loader.cc from: /home/luban/DDL-Serving/mnist_model/1\n2018-04-16 14:29:40.040966: I tensorflow/cc/saved_model/loader.cc:242] Loading SavedModel with tags: { serve }<span class=\"pl-k\">;</span> from: /home/luban/DDL-Serving/mnist_model/1\n2018-04-16 14:29:40.041996: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1423] Adding visible gpu devices: 0\n2018-04-16 14:29:40.042044: I tensorflow/core/common_runtime/gpu/gpu_device.cc:911] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-04-16 14:29:40.042066: I tensorflow/core/common_runtime/gpu/gpu_device.cc:917]      0\n2018-04-16 14:29:40.042082: I tensorflow/core/common_runtime/gpu/gpu_device.cc:930] 0:   N\n2018-04-16 14:29:40.042318: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21555 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:02:00.0, compute capability: 6.1)\n2018-04-16 14:29:40.044106: I tensorflow/cc/saved_model/loader.cc:161] Restoring SavedModel bundle.\n2018-04-16 14:29:40.048062: I tensorflow/cc/saved_model/loader.cc:196] Running LegacyInitOp on SavedModel bundle.\n2018-04-16 14:29:40.053422: I tensorflow/cc/saved_model/loader.cc:291] SavedModel load <span class=\"pl-k\">for</span> tags { serve }<span class=\"pl-k\">;</span> Status: success. Took 12455 microseconds.\nI0416 14:29:40.053490 23549 /home/luban/DDL-Serving/core/loader_helper.cc:77] Successfully loaded servable version { name:mnist ,version:1}\n2018-04-16 14:29:40.053579: I /home/luban/DDL-Serving/core/server_core.cc:123] Load models Done.\nI0416 14:29:40.061132 23547 /home/luban/DDL-Serving/brpc/src/brpc/server.cpp:984] Server[DDL::serving::PredictionServiceImpl] is serving on port=8002.\nI0416 14:29:40.061608 23547 /home/luban/DDL-Serving/brpc/src/brpc/server.cpp:987] Check out http://dd80f54614c3:8002 <span class=\"pl-k\">in</span> web browser.</pre></div>", "body_text": "background: serving mnist model using libtensorflow_cc.so and libtensorflow_framework.so gpu(p40) version\nbelow: limit 3 concurrency to call session.run(), got the latency 508us, very close to serial run.\n\nHowever, expand  concurrency to 24 , session.run() got the latency 1256us\n\nanyone can help ?\nlogs\uff1a\n[DDL-Serving]$ ./DDL_server --model_config_file=/home/luban/DDL-Serving/config.json\n2018-04-16 14:29:38.599280: I /home/luban/DDL-Serving/core/server_core.cc:91] Loading models:tensorflow\n2018-04-16 14:29:38.599490: I /home/luban/DDL-Serving/core/server_core.cc:98] name:/home/luban/DDL-Serving/mnist_model/3\nI0416 14:29:38.599814 23547 /home/luban/DDL-Serving/core/loader_helper.cc:59] Approving load for servable version { name:mnist ,version:3}\nI0416 14:29:38.599953 23549 /home/luban/DDL-Serving/core/loader_helper.cc:67] Loading servable version { name:mnist ,version:3}\nI0416 14:29:38.600110 23549 /home/luban/DDL-Serving/core/tf_bundle_factory.cc:230] Attempting to load native SavedModelBundle in loader.cc from: /home/luban/DDL-Serving/mnist_model/3\n2018-04-16 14:29:38.600163: I tensorflow/cc/saved_model/loader.cc:242] Loading SavedModel with tags: { serve }; from: /home/luban/DDL-Serving/mnist_model/3\n2018-04-16 14:29:38.910954: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1344] Found device 0 with properties:\nname: Tesla P40 major: 6 minor: 1 memoryClockRate(GHz): 1.531\npciBusID: 0000:02:00.0\ntotalMemory: 22.38GiB freeMemory: 22.21GiB\n2018-04-16 14:29:38.911028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1423] Adding visible gpu devices: 0\n2018-04-16 14:29:39.721881: I tensorflow/core/common_runtime/gpu/gpu_device.cc:911] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-04-16 14:29:39.721955: I tensorflow/core/common_runtime/gpu/gpu_device.cc:917]      0\n2018-04-16 14:29:39.721971: I tensorflow/core/common_runtime/gpu/gpu_device.cc:930] 0:   N\n2018-04-16 14:29:39.722897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21555 MB memory) -> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:02:00.0, compute capability: 6.1)\n2018-04-16 14:29:40.028849: I tensorflow/cc/saved_model/loader.cc:161] Restoring SavedModel bundle.\n2018-04-16 14:29:40.034555: I tensorflow/cc/saved_model/loader.cc:196] Running LegacyInitOp on SavedModel bundle.\n2018-04-16 14:29:40.040415: I tensorflow/cc/saved_model/loader.cc:291] SavedModel load for tags { serve }; Status: success. Took 1440252 microseconds.\nI0416 14:29:40.040555 23549 /home/luban/DDL-Serving/core/loader_helper.cc:77] Successfully loaded servable version { name:mnist ,version:3}\n2018-04-16 14:29:40.040656: I /home/luban/DDL-Serving/core/server_core.cc:98] name:/home/luban/DDL-Serving/mnist_model/1\nI0416 14:29:40.040829 23547 /home/luban/DDL-Serving/core/loader_helper.cc:59] Approving load for servable version { name:mnist ,version:1}\nI0416 14:29:40.040890 23549 /home/luban/DDL-Serving/core/loader_helper.cc:67] Loading servable version { name:mnist ,version:1}\nI0416 14:29:40.040937 23549 /home/luban/DDL-Serving/core/tf_bundle_factory.cc:230] Attempting to load native SavedModelBundle in loader.cc from: /home/luban/DDL-Serving/mnist_model/1\n2018-04-16 14:29:40.040966: I tensorflow/cc/saved_model/loader.cc:242] Loading SavedModel with tags: { serve }; from: /home/luban/DDL-Serving/mnist_model/1\n2018-04-16 14:29:40.041996: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1423] Adding visible gpu devices: 0\n2018-04-16 14:29:40.042044: I tensorflow/core/common_runtime/gpu/gpu_device.cc:911] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-04-16 14:29:40.042066: I tensorflow/core/common_runtime/gpu/gpu_device.cc:917]      0\n2018-04-16 14:29:40.042082: I tensorflow/core/common_runtime/gpu/gpu_device.cc:930] 0:   N\n2018-04-16 14:29:40.042318: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21555 MB memory) -> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:02:00.0, compute capability: 6.1)\n2018-04-16 14:29:40.044106: I tensorflow/cc/saved_model/loader.cc:161] Restoring SavedModel bundle.\n2018-04-16 14:29:40.048062: I tensorflow/cc/saved_model/loader.cc:196] Running LegacyInitOp on SavedModel bundle.\n2018-04-16 14:29:40.053422: I tensorflow/cc/saved_model/loader.cc:291] SavedModel load for tags { serve }; Status: success. Took 12455 microseconds.\nI0416 14:29:40.053490 23549 /home/luban/DDL-Serving/core/loader_helper.cc:77] Successfully loaded servable version { name:mnist ,version:1}\n2018-04-16 14:29:40.053579: I /home/luban/DDL-Serving/core/server_core.cc:123] Load models Done.\nI0416 14:29:40.061132 23547 /home/luban/DDL-Serving/brpc/src/brpc/server.cpp:984] Server[DDL::serving::PredictionServiceImpl] is serving on port=8002.\nI0416 14:29:40.061608 23547 /home/luban/DDL-Serving/brpc/src/brpc/server.cpp:987] Check out http://dd80f54614c3:8002 in web browser.", "body": "background: serving mnist model using libtensorflow_cc.so and libtensorflow_framework.so gpu(p40) version\r\n\r\nbelow: limit 3 concurrency to call `session.run()`, got the latency 508us, very close to serial run.\r\n![image](https://user-images.githubusercontent.com/3832082/38794426-a9a36dc4-4187-11e8-8aa6-57df4c61578f.png)\r\n\r\nHowever, expand  concurrency to 24 , `session.run()` got the latency 1256us\r\n![image](https://user-images.githubusercontent.com/3832082/38794599-3c0e1380-4188-11e8-9560-6dd4fd1e9750.png)\r\n\r\nanyone can help ?\r\n\r\nlogs\uff1a\r\n```shell\r\n[DDL-Serving]$ ./DDL_server --model_config_file=/home/luban/DDL-Serving/config.json\r\n2018-04-16 14:29:38.599280: I /home/luban/DDL-Serving/core/server_core.cc:91] Loading models:tensorflow\r\n2018-04-16 14:29:38.599490: I /home/luban/DDL-Serving/core/server_core.cc:98] name:/home/luban/DDL-Serving/mnist_model/3\r\nI0416 14:29:38.599814 23547 /home/luban/DDL-Serving/core/loader_helper.cc:59] Approving load for servable version { name:mnist ,version:3}\r\nI0416 14:29:38.599953 23549 /home/luban/DDL-Serving/core/loader_helper.cc:67] Loading servable version { name:mnist ,version:3}\r\nI0416 14:29:38.600110 23549 /home/luban/DDL-Serving/core/tf_bundle_factory.cc:230] Attempting to load native SavedModelBundle in loader.cc from: /home/luban/DDL-Serving/mnist_model/3\r\n2018-04-16 14:29:38.600163: I tensorflow/cc/saved_model/loader.cc:242] Loading SavedModel with tags: { serve }; from: /home/luban/DDL-Serving/mnist_model/3\r\n2018-04-16 14:29:38.910954: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1344] Found device 0 with properties:\r\nname: Tesla P40 major: 6 minor: 1 memoryClockRate(GHz): 1.531\r\npciBusID: 0000:02:00.0\r\ntotalMemory: 22.38GiB freeMemory: 22.21GiB\r\n2018-04-16 14:29:38.911028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1423] Adding visible gpu devices: 0\r\n2018-04-16 14:29:39.721881: I tensorflow/core/common_runtime/gpu/gpu_device.cc:911] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-04-16 14:29:39.721955: I tensorflow/core/common_runtime/gpu/gpu_device.cc:917]      0\r\n2018-04-16 14:29:39.721971: I tensorflow/core/common_runtime/gpu/gpu_device.cc:930] 0:   N\r\n2018-04-16 14:29:39.722897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21555 MB memory) -> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:02:00.0, compute capability: 6.1)\r\n2018-04-16 14:29:40.028849: I tensorflow/cc/saved_model/loader.cc:161] Restoring SavedModel bundle.\r\n2018-04-16 14:29:40.034555: I tensorflow/cc/saved_model/loader.cc:196] Running LegacyInitOp on SavedModel bundle.\r\n2018-04-16 14:29:40.040415: I tensorflow/cc/saved_model/loader.cc:291] SavedModel load for tags { serve }; Status: success. Took 1440252 microseconds.\r\nI0416 14:29:40.040555 23549 /home/luban/DDL-Serving/core/loader_helper.cc:77] Successfully loaded servable version { name:mnist ,version:3}\r\n2018-04-16 14:29:40.040656: I /home/luban/DDL-Serving/core/server_core.cc:98] name:/home/luban/DDL-Serving/mnist_model/1\r\nI0416 14:29:40.040829 23547 /home/luban/DDL-Serving/core/loader_helper.cc:59] Approving load for servable version { name:mnist ,version:1}\r\nI0416 14:29:40.040890 23549 /home/luban/DDL-Serving/core/loader_helper.cc:67] Loading servable version { name:mnist ,version:1}\r\nI0416 14:29:40.040937 23549 /home/luban/DDL-Serving/core/tf_bundle_factory.cc:230] Attempting to load native SavedModelBundle in loader.cc from: /home/luban/DDL-Serving/mnist_model/1\r\n2018-04-16 14:29:40.040966: I tensorflow/cc/saved_model/loader.cc:242] Loading SavedModel with tags: { serve }; from: /home/luban/DDL-Serving/mnist_model/1\r\n2018-04-16 14:29:40.041996: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1423] Adding visible gpu devices: 0\r\n2018-04-16 14:29:40.042044: I tensorflow/core/common_runtime/gpu/gpu_device.cc:911] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-04-16 14:29:40.042066: I tensorflow/core/common_runtime/gpu/gpu_device.cc:917]      0\r\n2018-04-16 14:29:40.042082: I tensorflow/core/common_runtime/gpu/gpu_device.cc:930] 0:   N\r\n2018-04-16 14:29:40.042318: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 21555 MB memory) -> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:02:00.0, compute capability: 6.1)\r\n2018-04-16 14:29:40.044106: I tensorflow/cc/saved_model/loader.cc:161] Restoring SavedModel bundle.\r\n2018-04-16 14:29:40.048062: I tensorflow/cc/saved_model/loader.cc:196] Running LegacyInitOp on SavedModel bundle.\r\n2018-04-16 14:29:40.053422: I tensorflow/cc/saved_model/loader.cc:291] SavedModel load for tags { serve }; Status: success. Took 12455 microseconds.\r\nI0416 14:29:40.053490 23549 /home/luban/DDL-Serving/core/loader_helper.cc:77] Successfully loaded servable version { name:mnist ,version:1}\r\n2018-04-16 14:29:40.053579: I /home/luban/DDL-Serving/core/server_core.cc:123] Load models Done.\r\nI0416 14:29:40.061132 23547 /home/luban/DDL-Serving/brpc/src/brpc/server.cpp:984] Server[DDL::serving::PredictionServiceImpl] is serving on port=8002.\r\nI0416 14:29:40.061608 23547 /home/luban/DDL-Serving/brpc/src/brpc/server.cpp:987] Check out http://dd80f54614c3:8002 in web browser.\r\n```\r\n"}