{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23232", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23232/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23232/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23232/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23232", "id": 373709137, "node_id": "MDU6SXNzdWUzNzM3MDkxMzc=", "number": 23232, "title": "Broken distributed training with tf.estimator.Estimator", "user": {"login": "Luonic", "id": 13236173, "node_id": "MDQ6VXNlcjEzMjM2MTcz", "avatar_url": "https://avatars1.githubusercontent.com/u/13236173?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Luonic", "html_url": "https://github.com/Luonic", "followers_url": "https://api.github.com/users/Luonic/followers", "following_url": "https://api.github.com/users/Luonic/following{/other_user}", "gists_url": "https://api.github.com/users/Luonic/gists{/gist_id}", "starred_url": "https://api.github.com/users/Luonic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Luonic/subscriptions", "organizations_url": "https://api.github.com/users/Luonic/orgs", "repos_url": "https://api.github.com/users/Luonic/repos", "events_url": "https://api.github.com/users/Luonic/events{/privacy}", "received_events_url": "https://api.github.com/users/Luonic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-10-24T22:57:28Z", "updated_at": "2018-11-01T23:27:48Z", "closed_at": "2018-11-01T23:27:48Z", "author_association": "NONE", "body_html": "<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes</li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04</li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: None</li>\n<li>TensorFlow installed from (source or binary): Source</li>\n<li>TensorFlow version (use command below): v1.11.0-0-gc19e29306c 1.11.0</li>\n<li>Python version: 3.6.6</li>\n<li>Bazel version (if compiling from source): 0.18.0 (PPA)</li>\n<li>GCC/Compiler version (if compiling from source): gcc (Ubuntu 7.3.0-27ubuntu1~18.04) 7.3.0</li>\n<li>CUDA/cuDNN version: 10.0/7.3.1</li>\n<li>GPU model and memory: 2x1080ti + 2x1070</li>\n</ul>\n<p>When I am trying to train network with Estimator and MirroredStrategy there is naming issue in estimator's code.<br>\nI get following error:</p>\n<pre><code>Traceback (most recent call last):\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1664, in &lt;module&gt;\n    main()\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1658, in main\n    globals = debugger.run(setup['file'], None, None, is_module)\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1068, in run\n    pydev_imports.execfile(file, globals, locals)  # execute the script\n  File \"/snap/pycharm-community/85/helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\n  File \"/home/alexandr/Code/DRIT_Tensorflow/train_est.py\", line 102, in &lt;module&gt;\n    tf.app.run(main)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 125, in run\n    _sys.exit(main(argv))\n  File \"/home/alexandr/Code/DRIT_Tensorflow/train_est.py\", line 79, in main\n    estimator.train(train_input_fn)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1179, in _train_model\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1309, in _train_model_distributed\n    grouped_estimator_spec.training_hooks)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1305, in get_hooks_from_the_first_device\n    for per_device_hook in per_device_hooks\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1305, in &lt;listcomp&gt;\n    for per_device_hook in per_device_hooks\nAttributeError: 'Estimator' object has no attribute '_distribution'\n</code></pre>\n<p>Problem occurs here:</p>\n<pre><code>        def get_hooks_from_the_first_device(per_device_hooks):\n          return [\n              self._distribution.unwrap(per_device_hook)[0]\n              for per_device_hook in per_device_hooks\n          ]\n</code></pre>\n<p>when estimator tries to call <code>unwrap()</code> method of <code>_distribution</code> but distribution strategy is stored in <code>_train_distribution</code> field.</p>\n<p>This is from PyCharm's debugger:</p>\n<pre><code>per_device_hooks = {tuple} &lt;class 'tuple'&gt;: (PerDevice({'/replica:0/task:0/device:GPU:0': &lt;model.model_fn.&lt;locals&gt;.TrainOpSelectorHook object at 0x7f0189a444e0&gt;, '/replica:0/task:0/device:GPU:1': &lt;model.model_fn.&lt;locals&gt;.TrainOpSelectorHook object at 0x7f01c3331d68&gt;, '/replica:0/tas\nself = {Estimator} &lt;tensorflow.python.estimator.estimator.Estimator object at 0x7f0c3f44f4a8&gt;\n _config = {RunConfig} &lt;tensorflow.python.estimator.run_config.RunConfig object at 0x7f0c3f44f4e0&gt;\n _device_fn = {NoneType} None\n _estimator_api_names = {tuple} &lt;class 'tuple'&gt;: ('estimator.Estimator',)\n _estimator_api_names_v1 = {tuple} &lt;class 'tuple'&gt;: ('estimator.Estimator',)\n _eval_distribution = {NoneType} None\n _model_dir = {str} 'train_logs/37/checkpoints'\n _params = {dict} {'batch_size': 1, 'image_size': [216, 216], 'float_type': tf.float32, 'gradient_scale': 1.0, 'leaky_relu_alpha': 0.2, 'attribute_tensor_depth': 32, 'attribute_subsample_factor': 4, 'attribute_tensor_global_pooling': False, 'remap_attribute_with_content': True, 'weight_decay': 1e-05, 'learning_rate': 1e-05, 'content_discriminator_lr_multiplier': 0.4, 'attribute_discriminator_lr_multiplier': 0.4, 'quantize': False, 'content_discriminator_steps': 1, 'domain_discriminator_steps': 1, 'num_steps_start_lr_decay': 100000, 'max_iter': 250000}\n _session_config = {ConfigProto} \nLOOK HERE ==&gt; _train_distribution = {MirroredStrategy} &lt;tensorflow.contrib.distribute.python.mirrored_strategy.MirroredStrategy object at 0x7f0c3f44f5c0&gt;\n _warm_start_settings = {NoneType} None\n config = {RunConfig} &lt;tensorflow.python.estimator.run_config.RunConfig object at 0x7f017d7b0f98&gt;\n model_dir = {str} 'train_logs/37/checkpoints'\n params = {dict} {'batch_size': 1, 'image_size': [216, 216], 'float_type': tf.float32, 'gradient_scale': 1.0, 'leaky_relu_alpha': 0.2, 'attribute_tensor_depth': 32, 'attribute_subsample_factor': 4, 'attribute_tensor_global_pooling': False, 'remap_attribute_with_content': True, 'weight_decay': 1e-05, 'learning_rate': 1e-05, 'content_discriminator_lr_multiplier': 0.4, 'attribute_discriminator_lr_multiplier': 0.4, 'quantize': False, 'content_discriminator_steps': 1, 'domain_discriminator_steps': 1, 'num_steps_start_lr_decay': 100000, 'max_iter': 250000}\n</code></pre>\n<p><strong>Describe the expected behavior</strong><br>\nWhat I expect? I expect tf.estimator's code to not be broken.</p>\n<p><strong>Code to reproduce the issue</strong><br>\nAny example with MirroredStrategy should be fine.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: None\nTensorFlow installed from (source or binary): Source\nTensorFlow version (use command below): v1.11.0-0-gc19e29306c 1.11.0\nPython version: 3.6.6\nBazel version (if compiling from source): 0.18.0 (PPA)\nGCC/Compiler version (if compiling from source): gcc (Ubuntu 7.3.0-27ubuntu1~18.04) 7.3.0\nCUDA/cuDNN version: 10.0/7.3.1\nGPU model and memory: 2x1080ti + 2x1070\n\nWhen I am trying to train network with Estimator and MirroredStrategy there is naming issue in estimator's code.\nI get following error:\nTraceback (most recent call last):\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1664, in <module>\n    main()\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1658, in main\n    globals = debugger.run(setup['file'], None, None, is_module)\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1068, in run\n    pydev_imports.execfile(file, globals, locals)  # execute the script\n  File \"/snap/pycharm-community/85/helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\n  File \"/home/alexandr/Code/DRIT_Tensorflow/train_est.py\", line 102, in <module>\n    tf.app.run(main)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 125, in run\n    _sys.exit(main(argv))\n  File \"/home/alexandr/Code/DRIT_Tensorflow/train_est.py\", line 79, in main\n    estimator.train(train_input_fn)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1179, in _train_model\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1309, in _train_model_distributed\n    grouped_estimator_spec.training_hooks)\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1305, in get_hooks_from_the_first_device\n    for per_device_hook in per_device_hooks\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1305, in <listcomp>\n    for per_device_hook in per_device_hooks\nAttributeError: 'Estimator' object has no attribute '_distribution'\n\nProblem occurs here:\n        def get_hooks_from_the_first_device(per_device_hooks):\n          return [\n              self._distribution.unwrap(per_device_hook)[0]\n              for per_device_hook in per_device_hooks\n          ]\n\nwhen estimator tries to call unwrap() method of _distribution but distribution strategy is stored in _train_distribution field.\nThis is from PyCharm's debugger:\nper_device_hooks = {tuple} <class 'tuple'>: (PerDevice({'/replica:0/task:0/device:GPU:0': <model.model_fn.<locals>.TrainOpSelectorHook object at 0x7f0189a444e0>, '/replica:0/task:0/device:GPU:1': <model.model_fn.<locals>.TrainOpSelectorHook object at 0x7f01c3331d68>, '/replica:0/tas\nself = {Estimator} <tensorflow.python.estimator.estimator.Estimator object at 0x7f0c3f44f4a8>\n _config = {RunConfig} <tensorflow.python.estimator.run_config.RunConfig object at 0x7f0c3f44f4e0>\n _device_fn = {NoneType} None\n _estimator_api_names = {tuple} <class 'tuple'>: ('estimator.Estimator',)\n _estimator_api_names_v1 = {tuple} <class 'tuple'>: ('estimator.Estimator',)\n _eval_distribution = {NoneType} None\n _model_dir = {str} 'train_logs/37/checkpoints'\n _params = {dict} {'batch_size': 1, 'image_size': [216, 216], 'float_type': tf.float32, 'gradient_scale': 1.0, 'leaky_relu_alpha': 0.2, 'attribute_tensor_depth': 32, 'attribute_subsample_factor': 4, 'attribute_tensor_global_pooling': False, 'remap_attribute_with_content': True, 'weight_decay': 1e-05, 'learning_rate': 1e-05, 'content_discriminator_lr_multiplier': 0.4, 'attribute_discriminator_lr_multiplier': 0.4, 'quantize': False, 'content_discriminator_steps': 1, 'domain_discriminator_steps': 1, 'num_steps_start_lr_decay': 100000, 'max_iter': 250000}\n _session_config = {ConfigProto} \nLOOK HERE ==> _train_distribution = {MirroredStrategy} <tensorflow.contrib.distribute.python.mirrored_strategy.MirroredStrategy object at 0x7f0c3f44f5c0>\n _warm_start_settings = {NoneType} None\n config = {RunConfig} <tensorflow.python.estimator.run_config.RunConfig object at 0x7f017d7b0f98>\n model_dir = {str} 'train_logs/37/checkpoints'\n params = {dict} {'batch_size': 1, 'image_size': [216, 216], 'float_type': tf.float32, 'gradient_scale': 1.0, 'leaky_relu_alpha': 0.2, 'attribute_tensor_depth': 32, 'attribute_subsample_factor': 4, 'attribute_tensor_global_pooling': False, 'remap_attribute_with_content': True, 'weight_decay': 1e-05, 'learning_rate': 1e-05, 'content_discriminator_lr_multiplier': 0.4, 'attribute_discriminator_lr_multiplier': 0.4, 'quantize': False, 'content_discriminator_steps': 1, 'domain_discriminator_steps': 1, 'num_steps_start_lr_decay': 100000, 'max_iter': 250000}\n\nDescribe the expected behavior\nWhat I expect? I expect tf.estimator's code to not be broken.\nCode to reproduce the issue\nAny example with MirroredStrategy should be fine.", "body": "**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: None\r\n- TensorFlow installed from (source or binary): Source\r\n- TensorFlow version (use command below): v1.11.0-0-gc19e29306c 1.11.0\r\n- Python version: 3.6.6\r\n- Bazel version (if compiling from source): 0.18.0 (PPA)\r\n- GCC/Compiler version (if compiling from source): gcc (Ubuntu 7.3.0-27ubuntu1~18.04) 7.3.0\r\n- CUDA/cuDNN version: 10.0/7.3.1\r\n- GPU model and memory: 2x1080ti + 2x1070\r\n\r\nWhen I am trying to train network with Estimator and MirroredStrategy there is naming issue in estimator's code.\r\nI get following error:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1664, in <module>\r\n    main()\r\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1658, in main\r\n    globals = debugger.run(setup['file'], None, None, is_module)\r\n  File \"/snap/pycharm-community/85/helpers/pydev/pydevd.py\", line 1068, in run\r\n    pydev_imports.execfile(file, globals, locals)  # execute the script\r\n  File \"/snap/pycharm-community/85/helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"/home/alexandr/Code/DRIT_Tensorflow/train_est.py\", line 102, in <module>\r\n    tf.app.run(main)\r\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 125, in run\r\n    _sys.exit(main(argv))\r\n  File \"/home/alexandr/Code/DRIT_Tensorflow/train_est.py\", line 79, in main\r\n    estimator.train(train_input_fn)\r\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1179, in _train_model\r\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\r\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1309, in _train_model_distributed\r\n    grouped_estimator_spec.training_hooks)\r\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1305, in get_hooks_from_the_first_device\r\n    for per_device_hook in per_device_hooks\r\n  File \"/home/alexandr/.local/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1305, in <listcomp>\r\n    for per_device_hook in per_device_hooks\r\nAttributeError: 'Estimator' object has no attribute '_distribution'\r\n```\r\n\r\nProblem occurs here:\r\n```\r\n        def get_hooks_from_the_first_device(per_device_hooks):\r\n          return [\r\n              self._distribution.unwrap(per_device_hook)[0]\r\n              for per_device_hook in per_device_hooks\r\n          ]\r\n```\r\nwhen estimator tries to call `unwrap()` method of `_distribution` but distribution strategy is stored in `_train_distribution` field.\r\n\r\nThis is from PyCharm's debugger:\r\n```\r\nper_device_hooks = {tuple} <class 'tuple'>: (PerDevice({'/replica:0/task:0/device:GPU:0': <model.model_fn.<locals>.TrainOpSelectorHook object at 0x7f0189a444e0>, '/replica:0/task:0/device:GPU:1': <model.model_fn.<locals>.TrainOpSelectorHook object at 0x7f01c3331d68>, '/replica:0/tas\r\nself = {Estimator} <tensorflow.python.estimator.estimator.Estimator object at 0x7f0c3f44f4a8>\r\n _config = {RunConfig} <tensorflow.python.estimator.run_config.RunConfig object at 0x7f0c3f44f4e0>\r\n _device_fn = {NoneType} None\r\n _estimator_api_names = {tuple} <class 'tuple'>: ('estimator.Estimator',)\r\n _estimator_api_names_v1 = {tuple} <class 'tuple'>: ('estimator.Estimator',)\r\n _eval_distribution = {NoneType} None\r\n _model_dir = {str} 'train_logs/37/checkpoints'\r\n _params = {dict} {'batch_size': 1, 'image_size': [216, 216], 'float_type': tf.float32, 'gradient_scale': 1.0, 'leaky_relu_alpha': 0.2, 'attribute_tensor_depth': 32, 'attribute_subsample_factor': 4, 'attribute_tensor_global_pooling': False, 'remap_attribute_with_content': True, 'weight_decay': 1e-05, 'learning_rate': 1e-05, 'content_discriminator_lr_multiplier': 0.4, 'attribute_discriminator_lr_multiplier': 0.4, 'quantize': False, 'content_discriminator_steps': 1, 'domain_discriminator_steps': 1, 'num_steps_start_lr_decay': 100000, 'max_iter': 250000}\r\n _session_config = {ConfigProto} \r\nLOOK HERE ==> _train_distribution = {MirroredStrategy} <tensorflow.contrib.distribute.python.mirrored_strategy.MirroredStrategy object at 0x7f0c3f44f5c0>\r\n _warm_start_settings = {NoneType} None\r\n config = {RunConfig} <tensorflow.python.estimator.run_config.RunConfig object at 0x7f017d7b0f98>\r\n model_dir = {str} 'train_logs/37/checkpoints'\r\n params = {dict} {'batch_size': 1, 'image_size': [216, 216], 'float_type': tf.float32, 'gradient_scale': 1.0, 'leaky_relu_alpha': 0.2, 'attribute_tensor_depth': 32, 'attribute_subsample_factor': 4, 'attribute_tensor_global_pooling': False, 'remap_attribute_with_content': True, 'weight_decay': 1e-05, 'learning_rate': 1e-05, 'content_discriminator_lr_multiplier': 0.4, 'attribute_discriminator_lr_multiplier': 0.4, 'quantize': False, 'content_discriminator_steps': 1, 'domain_discriminator_steps': 1, 'num_steps_start_lr_decay': 100000, 'max_iter': 250000}\r\n```\r\n\r\n\r\n**Describe the expected behavior**\r\nWhat I expect? I expect tf.estimator's code to not be broken.\r\n\r\n**Code to reproduce the issue**\r\nAny example with MirroredStrategy should be fine.\r\n\r\n"}