{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22145", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22145/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22145/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22145/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22145", "id": 358097865, "node_id": "MDU6SXNzdWUzNTgwOTc4NjU=", "number": 22145, "title": "Depthwise convolution inside Dataset API throws data_format error", "user": {"login": "Talmaj", "id": 5983634, "node_id": "MDQ6VXNlcjU5ODM2MzQ=", "avatar_url": "https://avatars0.githubusercontent.com/u/5983634?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Talmaj", "html_url": "https://github.com/Talmaj", "followers_url": "https://api.github.com/users/Talmaj/followers", "following_url": "https://api.github.com/users/Talmaj/following{/other_user}", "gists_url": "https://api.github.com/users/Talmaj/gists{/gist_id}", "starred_url": "https://api.github.com/users/Talmaj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Talmaj/subscriptions", "organizations_url": "https://api.github.com/users/Talmaj/orgs", "repos_url": "https://api.github.com/users/Talmaj/repos", "events_url": "https://api.github.com/users/Talmaj/events{/privacy}", "received_events_url": "https://api.github.com/users/Talmaj/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "open", "locked": false, "assignee": {"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 12, "created_at": "2018-09-07T14:49:17Z", "updated_at": "2018-11-15T19:04:25Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>Linux Ubuntu 16.04</li>\n<li>TensorFlow installed using: pip</li>\n<li>TensorFlow version: 1.10</li>\n<li>Python version: 3.6</li>\n<li>CUDA/cuDNN version: 9.0/7.2</li>\n<li>GPU model and memory: GeForce GTX 1080 ti</li>\n</ul>\n<p>I tried to reproduce the error in a simpler fashion but couldn't manage it. Basically I use dataset API to load some patches from tfrecords and apply a synthethic blur on it (loaded from another tfrrecords) similar to this:</p>\n<pre><code>import tensorflow as tf\nimport numpy as np\n\ndef apply_blur(img):\n    blur = np.random.rand(3,3,1,1)\n    img = tf.nn.depthwise_conv2d(img[None], blur, [1,1,1,1], 'VALID')\n    return img\n\ntf.reset_default_graph()\ndataset = tf.data.Dataset.from_tensor_slices(np.ones((10, 128, 128, 1)))\ndataset = dataset.map(apply_blur, 2)\n\niterator = dataset.make_one_shot_iterator()\nbatch = iterator.get_next()\n\nconfig = tf.ConfigProto()\nconfig.gpu_options.allow_growth = True\nwith tf.Session(config=config) as sess:\n    out = sess.run(batch)\n</code></pre>\n<p>My code is still working with tf v1.8, but not in higher versions. It says the data_format should be \"NCHW\" for<br>\nDepthwise convolution on CPU, while in fact the data_format is \"NCHW\".</p>\n<h3>Source code / logs</h3>\n<pre><code>Traceback (most recent call last):\n  File \"cli_deblurring.py\", line 95, in &lt;module&gt;\n    cli()\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 722, in __call__\n    return self.main(*args, **kwargs)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 697, in main\n    rv = self.invoke(ctx)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\n    return callback(*args, **kwargs)\n  File \"cli_deblurring.py\", line 90, in cli\n    model.train()\n  File \"/home/user/Project/model/__init__.py\", line 159, in train\n    self._train(sess)\n  File \"/home/user/Project/model/deblurring.py\", line 318, in _train\n    epoch, global_step = self._train_epoch(sess)\n  File \"/home/user/Project/model/deblurring.py\", line 291, in _train_epoch\n    sess.run(light_fetches, feed_dict=self.train_feed_dict)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 900, in run\n    run_metadata_ptr)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\n    run_metadata)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.UnimplementedError: Depthwise convolution on CPU is only supported for NHWC format\n         [[Node: depthwise_3 = DepthwiseConv2dNative[T=DT_FLOAT, data_format=\"NCHW\", dilations=[1, 1, 1, 1], padding=\"VALID\", strides=[1, 1, 1, 1]](depthwise-0-TransposeNHWCToNCHW-LayoutOptimizer, strided_slice_4)]]\n         [[Node: load_data/IteratorGetNext = IteratorGetNext[output_shapes=[[?,8,128,128,1], [?,128,128,1]], output_types=[DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](load_data/Iterator)]]\n         [[Node: load_data/IteratorGetNext/_671 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device_incarnation=1, tensor_name=\"edge_64_load_data/IteratorGetNext\"\n, tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"]()]]\n</code></pre>\n<p>Any idea why this error could happen in higher versions?</p>", "body_text": "System information\n\nLinux Ubuntu 16.04\nTensorFlow installed using: pip\nTensorFlow version: 1.10\nPython version: 3.6\nCUDA/cuDNN version: 9.0/7.2\nGPU model and memory: GeForce GTX 1080 ti\n\nI tried to reproduce the error in a simpler fashion but couldn't manage it. Basically I use dataset API to load some patches from tfrecords and apply a synthethic blur on it (loaded from another tfrrecords) similar to this:\nimport tensorflow as tf\nimport numpy as np\n\ndef apply_blur(img):\n    blur = np.random.rand(3,3,1,1)\n    img = tf.nn.depthwise_conv2d(img[None], blur, [1,1,1,1], 'VALID')\n    return img\n\ntf.reset_default_graph()\ndataset = tf.data.Dataset.from_tensor_slices(np.ones((10, 128, 128, 1)))\ndataset = dataset.map(apply_blur, 2)\n\niterator = dataset.make_one_shot_iterator()\nbatch = iterator.get_next()\n\nconfig = tf.ConfigProto()\nconfig.gpu_options.allow_growth = True\nwith tf.Session(config=config) as sess:\n    out = sess.run(batch)\n\nMy code is still working with tf v1.8, but not in higher versions. It says the data_format should be \"NCHW\" for\nDepthwise convolution on CPU, while in fact the data_format is \"NCHW\".\nSource code / logs\nTraceback (most recent call last):\n  File \"cli_deblurring.py\", line 95, in <module>\n    cli()\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 722, in __call__\n    return self.main(*args, **kwargs)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 697, in main\n    rv = self.invoke(ctx)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\n    return callback(*args, **kwargs)\n  File \"cli_deblurring.py\", line 90, in cli\n    model.train()\n  File \"/home/user/Project/model/__init__.py\", line 159, in train\n    self._train(sess)\n  File \"/home/user/Project/model/deblurring.py\", line 318, in _train\n    epoch, global_step = self._train_epoch(sess)\n  File \"/home/user/Project/model/deblurring.py\", line 291, in _train_epoch\n    sess.run(light_fetches, feed_dict=self.train_feed_dict)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 900, in run\n    run_metadata_ptr)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\n    run_metadata)\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.UnimplementedError: Depthwise convolution on CPU is only supported for NHWC format\n         [[Node: depthwise_3 = DepthwiseConv2dNative[T=DT_FLOAT, data_format=\"NCHW\", dilations=[1, 1, 1, 1], padding=\"VALID\", strides=[1, 1, 1, 1]](depthwise-0-TransposeNHWCToNCHW-LayoutOptimizer, strided_slice_4)]]\n         [[Node: load_data/IteratorGetNext = IteratorGetNext[output_shapes=[[?,8,128,128,1], [?,128,128,1]], output_types=[DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](load_data/Iterator)]]\n         [[Node: load_data/IteratorGetNext/_671 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device_incarnation=1, tensor_name=\"edge_64_load_data/IteratorGetNext\"\n, tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"]()]]\n\nAny idea why this error could happen in higher versions?", "body": "### System information\r\n-  Linux Ubuntu 16.04\r\n- TensorFlow installed using: pip\r\n- TensorFlow version: 1.10\r\n- Python version: 3.6\r\n- CUDA/cuDNN version: 9.0/7.2\r\n- GPU model and memory: GeForce GTX 1080 ti\r\n\r\nI tried to reproduce the error in a simpler fashion but couldn't manage it. Basically I use dataset API to load some patches from tfrecords and apply a synthethic blur on it (loaded from another tfrrecords) similar to this:\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\n\r\ndef apply_blur(img):\r\n    blur = np.random.rand(3,3,1,1)\r\n    img = tf.nn.depthwise_conv2d(img[None], blur, [1,1,1,1], 'VALID')\r\n    return img\r\n\r\ntf.reset_default_graph()\r\ndataset = tf.data.Dataset.from_tensor_slices(np.ones((10, 128, 128, 1)))\r\ndataset = dataset.map(apply_blur, 2)\r\n\r\niterator = dataset.make_one_shot_iterator()\r\nbatch = iterator.get_next()\r\n\r\nconfig = tf.ConfigProto()\r\nconfig.gpu_options.allow_growth = True\r\nwith tf.Session(config=config) as sess:\r\n    out = sess.run(batch)\r\n```\r\n\r\nMy code is still working with tf v1.8, but not in higher versions. It says the data_format should be \"NCHW\" for \r\nDepthwise convolution on CPU, while in fact the data_format is \"NCHW\".\r\n\r\n### Source code / logs\r\n```\r\nTraceback (most recent call last):\r\n  File \"cli_deblurring.py\", line 95, in <module>\r\n    cli()\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 722, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 697, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"cli_deblurring.py\", line 90, in cli\r\n    model.train()\r\n  File \"/home/user/Project/model/__init__.py\", line 159, in train\r\n    self._train(sess)\r\n  File \"/home/user/Project/model/deblurring.py\", line 318, in _train\r\n    epoch, global_step = self._train_epoch(sess)\r\n  File \"/home/user/Project/model/deblurring.py\", line 291, in _train_epoch\r\n    sess.run(light_fetches, feed_dict=self.train_feed_dict)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 900, in run\r\n    run_metadata_ptr)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\r\n    run_metadata)\r\n  File \"/home/user/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.UnimplementedError: Depthwise convolution on CPU is only supported for NHWC format\r\n         [[Node: depthwise_3 = DepthwiseConv2dNative[T=DT_FLOAT, data_format=\"NCHW\", dilations=[1, 1, 1, 1], padding=\"VALID\", strides=[1, 1, 1, 1]](depthwise-0-TransposeNHWCToNCHW-LayoutOptimizer, strided_slice_4)]]\r\n         [[Node: load_data/IteratorGetNext = IteratorGetNext[output_shapes=[[?,8,128,128,1], [?,128,128,1]], output_types=[DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](load_data/Iterator)]]\r\n         [[Node: load_data/IteratorGetNext/_671 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device_incarnation=1, tensor_name=\"edge_64_load_data/IteratorGetNext\"\r\n, tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"]()]]\r\n```\r\nAny idea why this error could happen in higher versions?\r\n"}