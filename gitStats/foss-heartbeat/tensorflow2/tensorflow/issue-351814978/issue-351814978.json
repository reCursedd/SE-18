{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21704", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21704/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21704/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21704/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21704", "id": 351814978, "node_id": "MDU6SXNzdWUzNTE4MTQ5Nzg=", "number": 21704, "title": "[cmake] deduplicate symbols in libtensorflow.so and pywrap_tensorflow_internal.so", "user": {"login": "cdluminate", "id": 5723047, "node_id": "MDQ6VXNlcjU3MjMwNDc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5723047?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cdluminate", "html_url": "https://github.com/cdluminate", "followers_url": "https://api.github.com/users/cdluminate/followers", "following_url": "https://api.github.com/users/cdluminate/following{/other_user}", "gists_url": "https://api.github.com/users/cdluminate/gists{/gist_id}", "starred_url": "https://api.github.com/users/cdluminate/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cdluminate/subscriptions", "organizations_url": "https://api.github.com/users/cdluminate/orgs", "repos_url": "https://api.github.com/users/cdluminate/repos", "events_url": "https://api.github.com/users/cdluminate/events{/privacy}", "received_events_url": "https://api.github.com/users/cdluminate/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "tatatodd", "id": 5453737, "node_id": "MDQ6VXNlcjU0NTM3Mzc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5453737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatatodd", "html_url": "https://github.com/tatatodd", "followers_url": "https://api.github.com/users/tatatodd/followers", "following_url": "https://api.github.com/users/tatatodd/following{/other_user}", "gists_url": "https://api.github.com/users/tatatodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatatodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatatodd/subscriptions", "organizations_url": "https://api.github.com/users/tatatodd/orgs", "repos_url": "https://api.github.com/users/tatatodd/repos", "events_url": "https://api.github.com/users/tatatodd/events{/privacy}", "received_events_url": "https://api.github.com/users/tatatodd/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "tatatodd", "id": 5453737, "node_id": "MDQ6VXNlcjU0NTM3Mzc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5453737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatatodd", "html_url": "https://github.com/tatatodd", "followers_url": "https://api.github.com/users/tatatodd/followers", "following_url": "https://api.github.com/users/tatatodd/following{/other_user}", "gists_url": "https://api.github.com/users/tatatodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatatodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatatodd/subscriptions", "organizations_url": "https://api.github.com/users/tatatodd/orgs", "repos_url": "https://api.github.com/users/tatatodd/repos", "events_url": "https://api.github.com/users/tatatodd/events{/privacy}", "received_events_url": "https://api.github.com/users/tatatodd/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-08-18T11:55:57Z", "updated_at": "2018-09-19T01:07:57Z", "closed_at": "2018-09-19T01:07:57Z", "author_association": "NONE", "body_html": "<p>They contained nearly the same symbols. We can build another shared object shipping common symbols, and the common shared object can be used for both libtensorflow.so and pywrap_tensorflow_internal.so .</p>\n<p>This is an example patch, which produces <code>libtensorflow_.so</code> as the common shared object. (maybe better named <code>libtensorflow_internal.so</code>)</p>\n<div class=\"highlight highlight-source-diff\"><pre><span class=\"pl-c1\">diff --git a/tensorflow/contrib/cmake/tf_python.cmake b/tensorflow/contrib/cmake/tf_python.cmake</span>\nindex 6d86daf5f1..ad180396c5 100755\n<span class=\"pl-md\">--- a/tensorflow/contrib/cmake/tf_python.cmake</span>\n<span class=\"pl-mi1\">+++ b/tensorflow/contrib/cmake/tf_python.cmake</span>\n<span class=\"pl-mdr\">@@ -577,13 +577,8 @@</span> if(WIN32)\n     )\n endif(WIN32)\n \n<span class=\"pl-md\"><span class=\"pl-md\">-</span># pywrap_tensorflow_internal is a shared library containing all of the</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span># TensorFlow runtime and the standard ops and kernels. These are installed into</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span># tf_python/tensorflow/python/.</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>add_library(pywrap_tensorflow_internal SHARED</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    ${pywrap_tensorflow_internal_src}</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>add_library(tensorflow_ SHARED</span>\n     $&lt;TARGET_OBJECTS:tf_c&gt;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    $&lt;TARGET_OBJECTS:tf_c_python_api&gt;</span>\n     $&lt;TARGET_OBJECTS:tf_core_lib&gt;\n     $&lt;TARGET_OBJECTS:tf_core_cpu&gt;\n     $&lt;TARGET_OBJECTS:tf_core_framework&gt;\n<span class=\"pl-mdr\">@@ -601,6 +596,21 @@</span> add_library(pywrap_tensorflow_internal SHARED\n     $&lt;$&lt;BOOL:${tensorflow_ENABLE_GPU}&gt;:$&lt;TARGET_OBJECTS:tf_stream_executor&gt;&gt;\n     ${pywrap_tensorflow_deffile}\n )\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>target_link_libraries(tensorflow_ PRIVATE</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    ${tf_core_gpu_kernels_lib}</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    ${tensorflow_EXTERNAL_LIBRARIES}</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    tf_protos_cc</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>)</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>set_target_properties(tensorflow_ PROPERTIES VERSION \"1.10.0\" SOVERSION \"1.10\")</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># pywrap_tensorflow_internal is a shared library containing all of the</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># TensorFlow runtime and the standard ops and kernels. These are installed into</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># tf_python/tensorflow/python/.</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>add_library(pywrap_tensorflow_internal SHARED</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    ${pywrap_tensorflow_internal_src}</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    $&lt;TARGET_OBJECTS:tf_c_python_api&gt;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    ${pywrap_tensorflow_deffile}</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>)</span>\n \n # There is a bug in GCC 5 resulting in undefined reference to a __cpu_model function when\n # linking to the tensorflow library. Adding the following libraries fixes it.\n<span class=\"pl-mdr\">@@ -618,6 +628,7 @@</span> target_include_directories(pywrap_tensorflow_internal PUBLIC\n )\n \n target_link_libraries(pywrap_tensorflow_internal PRIVATE\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    tensorflow_</span>\n     ${tf_core_gpu_kernels_lib}\n     ${tensorflow_EXTERNAL_LIBRARIES}\n     tf_protos_cc</pre></div>\n<p>By using the resulting shared object I can build the <code>libtensorflow.so</code> in the build directory with this command</p>\n<pre><code>g++ ../../../cc/framework/ops.cc ../../../cc/framework/scope.cc -I ../../../../ -I ./eigen/src/eigen -I . -o x -ltensorflow_ -L. -shared -fPIC\n</code></pre>\n<p>and the resulting shared object only takes 1mb of disk space.</p>\n<pre><code>ls -lh x libtensorflow_.so* libpywrap_tensorflow_internal.so                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n-rwxr-xr-x 1 lumin lumin 5.5M Aug 18 11:37 libpywrap_tensorflow_internal.so\nlrwxrwxrwx 1 lumin lumin   22 Aug 18 11:36 libtensorflow_.so -&gt; libtensorflow_.so.1.10\nlrwxrwxrwx 1 lumin lumin   24 Aug 18 11:36 libtensorflow_.so.1.10 -&gt; libtensorflow_.so.1.10.0\n-rwxr-xr-x 1 lumin lumin 674M Aug 18 11:36 libtensorflow_.so.1.10.0\n-rwxr-xr-x 1 lumin lumin 648K Aug 18 11:48 x\n</code></pre>\n<p>Is my understanding correct? I can sumbit a PR for this symbol deduplication.</p>\n<hr>\n<pre><code>readelf -d x                                                                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n\nDynamic section at offset 0x68d58 contains 28 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libtensorflow_.so.1.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n</code></pre>\n<pre><code>readelf -d libpywrap_tensorflow_internal.so                                  ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n\nDynamic section at offset 0x3a4790 contains 51 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libtensorflow_.so.1.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libgif.so.7]\n 0x0000000000000001 (NEEDED)             Shared library: [libpng16.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libjpeg.so.9]\n 0x0000000000000001 (NEEDED)             Shared library: [liblmdb.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libjsoncpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libfarmhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libhighwayhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync_cpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libprotobuf.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libre2.so.4]\n 0x0000000000000001 (NEEDED)             Shared library: [libsqlite3.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libz.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc++.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libsnappy.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython3.6m.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]\n 0x000000000000000e (SONAME)             Library soname: [libpywrap_tensorflow_internal.so]\n</code></pre>\n<pre><code>readelf -d libtensorflow_.so                                                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n\nDynamic section at offset 0x1a5a5ff8 contains 48 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libgif.so.7]\n 0x0000000000000001 (NEEDED)             Shared library: [libpng16.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libjpeg.so.9]\n 0x0000000000000001 (NEEDED)             Shared library: [liblmdb.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libjsoncpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libfarmhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libhighwayhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync_cpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libprotobuf.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libre2.so.4]\n 0x0000000000000001 (NEEDED)             Shared library: [libsqlite3.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libz.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc++.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libsnappy.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]\n 0x000000000000000e (SONAME)             Library soname: [libtensorflow_.so.1.10]\n</code></pre>", "body_text": "They contained nearly the same symbols. We can build another shared object shipping common symbols, and the common shared object can be used for both libtensorflow.so and pywrap_tensorflow_internal.so .\nThis is an example patch, which produces libtensorflow_.so as the common shared object. (maybe better named libtensorflow_internal.so)\ndiff --git a/tensorflow/contrib/cmake/tf_python.cmake b/tensorflow/contrib/cmake/tf_python.cmake\nindex 6d86daf5f1..ad180396c5 100755\n--- a/tensorflow/contrib/cmake/tf_python.cmake\n+++ b/tensorflow/contrib/cmake/tf_python.cmake\n@@ -577,13 +577,8 @@ if(WIN32)\n     )\n endif(WIN32)\n \n-# pywrap_tensorflow_internal is a shared library containing all of the\n-# TensorFlow runtime and the standard ops and kernels. These are installed into\n-# tf_python/tensorflow/python/.\n-add_library(pywrap_tensorflow_internal SHARED\n-    ${pywrap_tensorflow_internal_src}\n+add_library(tensorflow_ SHARED\n     $<TARGET_OBJECTS:tf_c>\n-    $<TARGET_OBJECTS:tf_c_python_api>\n     $<TARGET_OBJECTS:tf_core_lib>\n     $<TARGET_OBJECTS:tf_core_cpu>\n     $<TARGET_OBJECTS:tf_core_framework>\n@@ -601,6 +596,21 @@ add_library(pywrap_tensorflow_internal SHARED\n     $<$<BOOL:${tensorflow_ENABLE_GPU}>:$<TARGET_OBJECTS:tf_stream_executor>>\n     ${pywrap_tensorflow_deffile}\n )\n+target_link_libraries(tensorflow_ PRIVATE\n+    ${tf_core_gpu_kernels_lib}\n+    ${tensorflow_EXTERNAL_LIBRARIES}\n+    tf_protos_cc\n+)\n+set_target_properties(tensorflow_ PROPERTIES VERSION \"1.10.0\" SOVERSION \"1.10\")\n+\n+# pywrap_tensorflow_internal is a shared library containing all of the\n+# TensorFlow runtime and the standard ops and kernels. These are installed into\n+# tf_python/tensorflow/python/.\n+add_library(pywrap_tensorflow_internal SHARED\n+    ${pywrap_tensorflow_internal_src}\n+    $<TARGET_OBJECTS:tf_c_python_api>\n+    ${pywrap_tensorflow_deffile}\n+)\n \n # There is a bug in GCC 5 resulting in undefined reference to a __cpu_model function when\n # linking to the tensorflow library. Adding the following libraries fixes it.\n@@ -618,6 +628,7 @@ target_include_directories(pywrap_tensorflow_internal PUBLIC\n )\n \n target_link_libraries(pywrap_tensorflow_internal PRIVATE\n+    tensorflow_\n     ${tf_core_gpu_kernels_lib}\n     ${tensorflow_EXTERNAL_LIBRARIES}\n     tf_protos_cc\nBy using the resulting shared object I can build the libtensorflow.so in the build directory with this command\ng++ ../../../cc/framework/ops.cc ../../../cc/framework/scope.cc -I ../../../../ -I ./eigen/src/eigen -I . -o x -ltensorflow_ -L. -shared -fPIC\n\nand the resulting shared object only takes 1mb of disk space.\nls -lh x libtensorflow_.so* libpywrap_tensorflow_internal.so                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n-rwxr-xr-x 1 lumin lumin 5.5M Aug 18 11:37 libpywrap_tensorflow_internal.so\nlrwxrwxrwx 1 lumin lumin   22 Aug 18 11:36 libtensorflow_.so -> libtensorflow_.so.1.10\nlrwxrwxrwx 1 lumin lumin   24 Aug 18 11:36 libtensorflow_.so.1.10 -> libtensorflow_.so.1.10.0\n-rwxr-xr-x 1 lumin lumin 674M Aug 18 11:36 libtensorflow_.so.1.10.0\n-rwxr-xr-x 1 lumin lumin 648K Aug 18 11:48 x\n\nIs my understanding correct? I can sumbit a PR for this symbol deduplication.\n\nreadelf -d x                                                                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n\nDynamic section at offset 0x68d58 contains 28 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libtensorflow_.so.1.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n\nreadelf -d libpywrap_tensorflow_internal.so                                  ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n\nDynamic section at offset 0x3a4790 contains 51 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libtensorflow_.so.1.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libgif.so.7]\n 0x0000000000000001 (NEEDED)             Shared library: [libpng16.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libjpeg.so.9]\n 0x0000000000000001 (NEEDED)             Shared library: [liblmdb.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libjsoncpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libfarmhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libhighwayhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync_cpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libprotobuf.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libre2.so.4]\n 0x0000000000000001 (NEEDED)             Shared library: [libsqlite3.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libz.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc++.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libsnappy.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython3.6m.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]\n 0x000000000000000e (SONAME)             Library soname: [libpywrap_tensorflow_internal.so]\n\nreadelf -d libtensorflow_.so                                                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\n\nDynamic section at offset 0x1a5a5ff8 contains 48 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libgif.so.7]\n 0x0000000000000001 (NEEDED)             Shared library: [libpng16.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libjpeg.so.9]\n 0x0000000000000001 (NEEDED)             Shared library: [liblmdb.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libjsoncpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libfarmhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libhighwayhash.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync_cpp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libprotobuf.so.16]\n 0x0000000000000001 (NEEDED)             Shared library: [libre2.so.4]\n 0x0000000000000001 (NEEDED)             Shared library: [libsqlite3.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libz.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc++.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libsnappy.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]\n 0x000000000000000e (SONAME)             Library soname: [libtensorflow_.so.1.10]", "body": "They contained nearly the same symbols. We can build another shared object shipping common symbols, and the common shared object can be used for both libtensorflow.so and pywrap_tensorflow_internal.so .\r\n\r\nThis is an example patch, which produces `libtensorflow_.so` as the common shared object. (maybe better named `libtensorflow_internal.so`)\r\n\r\n```patch\r\ndiff --git a/tensorflow/contrib/cmake/tf_python.cmake b/tensorflow/contrib/cmake/tf_python.cmake\r\nindex 6d86daf5f1..ad180396c5 100755\r\n--- a/tensorflow/contrib/cmake/tf_python.cmake\r\n+++ b/tensorflow/contrib/cmake/tf_python.cmake\r\n@@ -577,13 +577,8 @@ if(WIN32)\r\n     )\r\n endif(WIN32)\r\n \r\n-# pywrap_tensorflow_internal is a shared library containing all of the\r\n-# TensorFlow runtime and the standard ops and kernels. These are installed into\r\n-# tf_python/tensorflow/python/.\r\n-add_library(pywrap_tensorflow_internal SHARED\r\n-    ${pywrap_tensorflow_internal_src}\r\n+add_library(tensorflow_ SHARED\r\n     $<TARGET_OBJECTS:tf_c>\r\n-    $<TARGET_OBJECTS:tf_c_python_api>\r\n     $<TARGET_OBJECTS:tf_core_lib>\r\n     $<TARGET_OBJECTS:tf_core_cpu>\r\n     $<TARGET_OBJECTS:tf_core_framework>\r\n@@ -601,6 +596,21 @@ add_library(pywrap_tensorflow_internal SHARED\r\n     $<$<BOOL:${tensorflow_ENABLE_GPU}>:$<TARGET_OBJECTS:tf_stream_executor>>\r\n     ${pywrap_tensorflow_deffile}\r\n )\r\n+target_link_libraries(tensorflow_ PRIVATE\r\n+    ${tf_core_gpu_kernels_lib}\r\n+    ${tensorflow_EXTERNAL_LIBRARIES}\r\n+    tf_protos_cc\r\n+)\r\n+set_target_properties(tensorflow_ PROPERTIES VERSION \"1.10.0\" SOVERSION \"1.10\")\r\n+\r\n+# pywrap_tensorflow_internal is a shared library containing all of the\r\n+# TensorFlow runtime and the standard ops and kernels. These are installed into\r\n+# tf_python/tensorflow/python/.\r\n+add_library(pywrap_tensorflow_internal SHARED\r\n+    ${pywrap_tensorflow_internal_src}\r\n+    $<TARGET_OBJECTS:tf_c_python_api>\r\n+    ${pywrap_tensorflow_deffile}\r\n+)\r\n \r\n # There is a bug in GCC 5 resulting in undefined reference to a __cpu_model function when\r\n # linking to the tensorflow library. Adding the following libraries fixes it.\r\n@@ -618,6 +628,7 @@ target_include_directories(pywrap_tensorflow_internal PUBLIC\r\n )\r\n \r\n target_link_libraries(pywrap_tensorflow_internal PRIVATE\r\n+    tensorflow_\r\n     ${tf_core_gpu_kernels_lib}\r\n     ${tensorflow_EXTERNAL_LIBRARIES}\r\n     tf_protos_cc\r\n```\r\n\r\nBy using the resulting shared object I can build the `libtensorflow.so` in the build directory with this command\r\n```\r\ng++ ../../../cc/framework/ops.cc ../../../cc/framework/scope.cc -I ../../../../ -I ./eigen/src/eigen -I . -o x -ltensorflow_ -L. -shared -fPIC\r\n```\r\nand the resulting shared object only takes 1mb of disk space.\r\n\r\n```\r\nls -lh x libtensorflow_.so* libpywrap_tensorflow_internal.so                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\r\n-rwxr-xr-x 1 lumin lumin 5.5M Aug 18 11:37 libpywrap_tensorflow_internal.so\r\nlrwxrwxrwx 1 lumin lumin   22 Aug 18 11:36 libtensorflow_.so -> libtensorflow_.so.1.10\r\nlrwxrwxrwx 1 lumin lumin   24 Aug 18 11:36 libtensorflow_.so.1.10 -> libtensorflow_.so.1.10.0\r\n-rwxr-xr-x 1 lumin lumin 674M Aug 18 11:36 libtensorflow_.so.1.10.0\r\n-rwxr-xr-x 1 lumin lumin 648K Aug 18 11:48 x\r\n```\r\n\r\nIs my understanding correct? I can sumbit a PR for this symbol deduplication.\r\n\r\n---\r\n\r\n```\r\nreadelf -d x                                                                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\r\n\r\nDynamic section at offset 0x68d58 contains 28 entries:\r\n  Tag        Type                         Name/Value\r\n 0x0000000000000001 (NEEDED)             Shared library: [libtensorflow_.so.1.10]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\r\n```\r\n\r\n```\r\nreadelf -d libpywrap_tensorflow_internal.so                                  ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\r\n\r\nDynamic section at offset 0x3a4790 contains 51 entries:\r\n  Tag        Type                         Name/Value\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libtensorflow_.so.1.10]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgif.so.7]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libpng16.so.16]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libjpeg.so.9]\r\n 0x0000000000000001 (NEEDED)             Shared library: [liblmdb.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libjsoncpp.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libfarmhash.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libhighwayhash.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync_cpp.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libprotobuf.so.16]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libre2.so.4]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libsqlite3.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libz.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc++.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libsnappy.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libpython3.6m.so.1.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]\r\n 0x000000000000000e (SONAME)             Library soname: [libpywrap_tensorflow_internal.so]\r\n```\r\n\r\n```\r\nreadelf -d libtensorflow_.so                                                 ~/tensorflow.pkg/tensorflow.orig/tensorflow/contrib/cmake/x\r\n\r\nDynamic section at offset 0x1a5a5ff8 contains 48 entries:\r\n  Tag        Type                         Name/Value\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgif.so.7]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libpng16.so.16]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libjpeg.so.9]\r\n 0x0000000000000001 (NEEDED)             Shared library: [liblmdb.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libjsoncpp.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libfarmhash.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libhighwayhash.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libnsync_cpp.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libprotobuf.so.16]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libre2.so.4]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libsqlite3.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libz.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc++.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgrpc.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libsnappy.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\r\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\r\n 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]\r\n 0x000000000000000e (SONAME)             Library soname: [libtensorflow_.so.1.10]\r\n```"}