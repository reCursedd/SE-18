{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/415715941", "html_url": "https://github.com/tensorflow/tensorflow/issues/21778#issuecomment-415715941", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21778", "id": 415715941, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTcxNTk0MQ==", "user": {"login": "artkorenev", "id": 5678669, "node_id": "MDQ6VXNlcjU2Nzg2Njk=", "avatar_url": "https://avatars0.githubusercontent.com/u/5678669?v=4", "gravatar_id": "", "url": "https://api.github.com/users/artkorenev", "html_url": "https://github.com/artkorenev", "followers_url": "https://api.github.com/users/artkorenev/followers", "following_url": "https://api.github.com/users/artkorenev/following{/other_user}", "gists_url": "https://api.github.com/users/artkorenev/gists{/gist_id}", "starred_url": "https://api.github.com/users/artkorenev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/artkorenev/subscriptions", "organizations_url": "https://api.github.com/users/artkorenev/orgs", "repos_url": "https://api.github.com/users/artkorenev/repos", "events_url": "https://api.github.com/users/artkorenev/events{/privacy}", "received_events_url": "https://api.github.com/users/artkorenev/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-24T10:10:39Z", "updated_at": "2018-08-24T10:10:39Z", "author_association": "NONE", "body_html": "<p>I used the build <code>1.11.0-dev20180824</code> and now creating the estimator doesn't produce any errors.<br>\nHowever, if I run <code>estimator.train</code> (or <code>estimator.predict</code>) then the underlying <code>model_fn</code> function fails.</p>\n<p><strong>The exception:</strong></p>\n<pre><code>Traceback (most recent call last):\n  File \"~/my_custom_script.py\", line 26, in &lt;module&gt;\n    print(estimator.train(input_fn=input_fn, steps=1))\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1183, in _train_model\n    return self._train_model_default(input_fn, hooks, saving_listeners)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1213, in _train_model_default\n    features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1171, in _call_model_fn\n    model_fn_results = self._model_fn(features=features, **kwargs)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/keras.py\", line 213, in model_fn\n    labels)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/keras.py\", line 188, in _clone_and_build_model\n    in_place_reset=(not keras_model._is_graph_network))\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/keras/models.py\", line 441, in clone_and_build_model\n    _in_place_subclassed_model_reset(clone)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/keras/models.py\", line 316, in _in_place_subclassed_model_reset\n    name = layers_to_names[layer]\nKeyError: &lt;tensorflow.python.keras.layers.pooling.MaxPooling2D object at 0x7fae4b685c88&gt;\n</code></pre>\n<p><strong>The slightly updated code example to reproduce the bug:</strong></p>\n<pre><code>import tensorflow as tf\nimport numpy as np\n\nmax_pool = tf.keras.layers.MaxPooling2D(2)\nmodel = tf.keras.Sequential([\n    max_pool,\n    max_pool,\n    tf.keras.layers.Flatten(),\n    tf.keras.layers.Dense(1, activation='sigmoid')\n])\nmodel.compile(optimizer=tf.train.AdamOptimizer(), loss='binary_crossentropy')\n\nX, y = np.zeros((32, 8, 8, 1)), np.ones((32, 1))\nmodel.fit(X, y)\n\nestimator = tf.keras.estimator.model_to_estimator(keras_model=model)\n\ninput_fn = tf.estimator.inputs.numpy_input_fn(\n    x=X,\n    y=y,\n    batch_size=32,\n    num_epochs=1,\n    shuffle=False\n)\n\nestimator.train(input_fn=input_fn, steps=1)\n</code></pre>\n<p>I also tried this on a model created from Functional API and it works fine without any errors</p>", "body_text": "I used the build 1.11.0-dev20180824 and now creating the estimator doesn't produce any errors.\nHowever, if I run estimator.train (or estimator.predict) then the underlying model_fn function fails.\nThe exception:\nTraceback (most recent call last):\n  File \"~/my_custom_script.py\", line 26, in <module>\n    print(estimator.train(input_fn=input_fn, steps=1))\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1183, in _train_model\n    return self._train_model_default(input_fn, hooks, saving_listeners)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1213, in _train_model_default\n    features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1171, in _call_model_fn\n    model_fn_results = self._model_fn(features=features, **kwargs)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/keras.py\", line 213, in model_fn\n    labels)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/keras.py\", line 188, in _clone_and_build_model\n    in_place_reset=(not keras_model._is_graph_network))\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/keras/models.py\", line 441, in clone_and_build_model\n    _in_place_subclassed_model_reset(clone)\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/keras/models.py\", line 316, in _in_place_subclassed_model_reset\n    name = layers_to_names[layer]\nKeyError: <tensorflow.python.keras.layers.pooling.MaxPooling2D object at 0x7fae4b685c88>\n\nThe slightly updated code example to reproduce the bug:\nimport tensorflow as tf\nimport numpy as np\n\nmax_pool = tf.keras.layers.MaxPooling2D(2)\nmodel = tf.keras.Sequential([\n    max_pool,\n    max_pool,\n    tf.keras.layers.Flatten(),\n    tf.keras.layers.Dense(1, activation='sigmoid')\n])\nmodel.compile(optimizer=tf.train.AdamOptimizer(), loss='binary_crossentropy')\n\nX, y = np.zeros((32, 8, 8, 1)), np.ones((32, 1))\nmodel.fit(X, y)\n\nestimator = tf.keras.estimator.model_to_estimator(keras_model=model)\n\ninput_fn = tf.estimator.inputs.numpy_input_fn(\n    x=X,\n    y=y,\n    batch_size=32,\n    num_epochs=1,\n    shuffle=False\n)\n\nestimator.train(input_fn=input_fn, steps=1)\n\nI also tried this on a model created from Functional API and it works fine without any errors", "body": "I used the build `1.11.0-dev20180824` and now creating the estimator doesn't produce any errors.\r\nHowever, if I run `estimator.train` (or `estimator.predict`) then the underlying `model_fn` function fails.\r\n\r\n**The exception:** \r\n```\r\nTraceback (most recent call last):\r\n  File \"~/my_custom_script.py\", line 26, in <module>\r\n    print(estimator.train(input_fn=input_fn, steps=1))\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1183, in _train_model\r\n    return self._train_model_default(input_fn, hooks, saving_listeners)\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1213, in _train_model_default\r\n    features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1171, in _call_model_fn\r\n    model_fn_results = self._model_fn(features=features, **kwargs)\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/keras.py\", line 213, in model_fn\r\n    labels)\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/estimator/keras.py\", line 188, in _clone_and_build_model\r\n    in_place_reset=(not keras_model._is_graph_network))\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/keras/models.py\", line 441, in clone_and_build_model\r\n    _in_place_subclassed_model_reset(clone)\r\n  File \"~/miniconda3/lib/python3.6/site-packages/tensorflow/python/keras/models.py\", line 316, in _in_place_subclassed_model_reset\r\n    name = layers_to_names[layer]\r\nKeyError: <tensorflow.python.keras.layers.pooling.MaxPooling2D object at 0x7fae4b685c88>\r\n```\r\n\r\n**The slightly updated code example to reproduce the bug:**\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\n\r\nmax_pool = tf.keras.layers.MaxPooling2D(2)\r\nmodel = tf.keras.Sequential([\r\n    max_pool,\r\n    max_pool,\r\n    tf.keras.layers.Flatten(),\r\n    tf.keras.layers.Dense(1, activation='sigmoid')\r\n])\r\nmodel.compile(optimizer=tf.train.AdamOptimizer(), loss='binary_crossentropy')\r\n\r\nX, y = np.zeros((32, 8, 8, 1)), np.ones((32, 1))\r\nmodel.fit(X, y)\r\n\r\nestimator = tf.keras.estimator.model_to_estimator(keras_model=model)\r\n\r\ninput_fn = tf.estimator.inputs.numpy_input_fn(\r\n    x=X,\r\n    y=y,\r\n    batch_size=32,\r\n    num_epochs=1,\r\n    shuffle=False\r\n)\r\n\r\nestimator.train(input_fn=input_fn, steps=1)\r\n```\r\n\r\nI also tried this on a model created from Functional API and it works fine without any errors"}