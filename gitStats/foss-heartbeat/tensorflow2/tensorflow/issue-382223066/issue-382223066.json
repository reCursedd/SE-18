{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23854", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23854/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23854/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23854/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23854", "id": 382223066, "node_id": "MDU6SXNzdWUzODIyMjMwNjY=", "number": 23854, "title": "Error using Estimator export_saved_model (Not found: Key global_step not found in checkpoint)", "user": {"login": "burhanbvk", "id": 3274975, "node_id": "MDQ6VXNlcjMyNzQ5NzU=", "avatar_url": "https://avatars3.githubusercontent.com/u/3274975?v=4", "gravatar_id": "", "url": "https://api.github.com/users/burhanbvk", "html_url": "https://github.com/burhanbvk", "followers_url": "https://api.github.com/users/burhanbvk/followers", "following_url": "https://api.github.com/users/burhanbvk/following{/other_user}", "gists_url": "https://api.github.com/users/burhanbvk/gists{/gist_id}", "starred_url": "https://api.github.com/users/burhanbvk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/burhanbvk/subscriptions", "organizations_url": "https://api.github.com/users/burhanbvk/orgs", "repos_url": "https://api.github.com/users/burhanbvk/repos", "events_url": "https://api.github.com/users/burhanbvk/events{/privacy}", "received_events_url": "https://api.github.com/users/burhanbvk/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-11-19T13:49:18Z", "updated_at": "2018-11-21T13:44:21Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>Hello,</p>\n<p>I am trying to prepare a pre-trained model for google cloud ML. I am trying to use an estimator to export the model. During the loading of the checkpoints by the estimator I get the following error:</p>\n<pre><code>2018-11-19 13:28:57.526564: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at save_restore_v2_ops.cc:184 : Not found: Key global_step not found in checkpoint\nTraceback (most recent call last):\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1334, in _do_call\n    return fn(*args)\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1319, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1407, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.NotFoundError: Key global_step not found in checkpoint\n         [[{{node save_1/RestoreV2}} = RestoreV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, ..., DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save_1/Const_0_0, save_1/RestoreV2/tensor_names, save_1/RestoreV2/shape_and_slices)]]\n</code></pre>\n<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes</li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows</li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:</li>\n<li>TensorFlow installed from (source or binary): Binary</li>\n<li>TensorFlow version (use command below): 1.12.0</li>\n<li>Python version: 3.6</li>\n<li>Bazel version (if compiling from source):</li>\n<li>GCC/Compiler version (if compiling from source):</li>\n<li>CUDA/cuDNN version:</li>\n<li>GPU model and memory: Tesla K80</li>\n</ul>\n<p><strong>Code to reproduce the issue</strong></p>\n<pre><code>MODEL_DIR='model/'\ndef decode_image(image_bytes):\n    image = tf.image.decode_image(image_bytes)\n    image = tf.cast(image, dtype=tf.uint8)\n    return image\n\ndef serving_input_fn():\n    createmodel()\n    inputs = {'image_bytes': tf.placeholder(tf.string, shape=(), name=\"image_bytes\")}\n    imagebytes = tf.squeeze(inputs['image_bytes']) # make it a scalar\n    image = decode_image(imagebytes)\n    # make the outer dimension unknown (and not 1)\n    image = tf.placeholder_with_default(image, shape=[None, None, None, 3])\n\n    features = {'image_bytes' : image}\n    return tf.estimator.export.ServingInputReceiver(features, inputs)\n\ndef model_fn(features, labels, mode, params):\n    pred = tf.get_default_graph().get_tensor_by_name(\"fc1_voc12:0\")\n    return tf.estimator.EstimatorSpec(\n        mode=tf.estimator.ModeKeys.PREDICT,\n        predictions=pred,\n        export_outputs={'pred':tf.estimator.export.PredictOutput(pred)}\n        )\n\nestimator = tf.estimator.Estimator(\n    model_fn=model_fn,\n    model_dir=MODEL_DIR)\n\nestimator.export_savedmodel('deployment_gcp_1', serving_input_fn, strip_default_attrs=True)\n</code></pre>\n<p>I have searched this issue quite a bit. There was one bug report for an older version of tensorflow (I think 1.2.0 but I am not sure now). I am able to load and save this model using tf.saved_model.simple_save, and it works when I run predictions on it.</p>\n<p>I am not sure if this is a bug or if I am missing something really simple.</p>", "body_text": "Hello,\nI am trying to prepare a pre-trained model for google cloud ML. I am trying to use an estimator to export the model. During the loading of the checkpoints by the estimator I get the following error:\n2018-11-19 13:28:57.526564: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at save_restore_v2_ops.cc:184 : Not found: Key global_step not found in checkpoint\nTraceback (most recent call last):\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1334, in _do_call\n    return fn(*args)\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1319, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1407, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.NotFoundError: Key global_step not found in checkpoint\n         [[{{node save_1/RestoreV2}} = RestoreV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, ..., DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save_1/Const_0_0, save_1/RestoreV2/tensor_names, save_1/RestoreV2/shape_and_slices)]]\n\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\nTensorFlow installed from (source or binary): Binary\nTensorFlow version (use command below): 1.12.0\nPython version: 3.6\nBazel version (if compiling from source):\nGCC/Compiler version (if compiling from source):\nCUDA/cuDNN version:\nGPU model and memory: Tesla K80\n\nCode to reproduce the issue\nMODEL_DIR='model/'\ndef decode_image(image_bytes):\n    image = tf.image.decode_image(image_bytes)\n    image = tf.cast(image, dtype=tf.uint8)\n    return image\n\ndef serving_input_fn():\n    createmodel()\n    inputs = {'image_bytes': tf.placeholder(tf.string, shape=(), name=\"image_bytes\")}\n    imagebytes = tf.squeeze(inputs['image_bytes']) # make it a scalar\n    image = decode_image(imagebytes)\n    # make the outer dimension unknown (and not 1)\n    image = tf.placeholder_with_default(image, shape=[None, None, None, 3])\n\n    features = {'image_bytes' : image}\n    return tf.estimator.export.ServingInputReceiver(features, inputs)\n\ndef model_fn(features, labels, mode, params):\n    pred = tf.get_default_graph().get_tensor_by_name(\"fc1_voc12:0\")\n    return tf.estimator.EstimatorSpec(\n        mode=tf.estimator.ModeKeys.PREDICT,\n        predictions=pred,\n        export_outputs={'pred':tf.estimator.export.PredictOutput(pred)}\n        )\n\nestimator = tf.estimator.Estimator(\n    model_fn=model_fn,\n    model_dir=MODEL_DIR)\n\nestimator.export_savedmodel('deployment_gcp_1', serving_input_fn, strip_default_attrs=True)\n\nI have searched this issue quite a bit. There was one bug report for an older version of tensorflow (I think 1.2.0 but I am not sure now). I am able to load and save this model using tf.saved_model.simple_save, and it works when I run predictions on it.\nI am not sure if this is a bug or if I am missing something really simple.", "body": "Hello,\r\n\r\nI am trying to prepare a pre-trained model for google cloud ML. I am trying to use an estimator to export the model. During the loading of the checkpoints by the estimator I get the following error:\r\n\r\n```\r\n2018-11-19 13:28:57.526564: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at save_restore_v2_ops.cc:184 : Not found: Key global_step not found in checkpoint\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1334, in _do_call\r\n    return fn(*args)\r\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1319, in _run_fn\r\n    options, feed_dict, fetch_list, target_list, run_metadata)\r\n  File \"C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1407, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.NotFoundError: Key global_step not found in checkpoint\r\n         [[{{node save_1/RestoreV2}} = RestoreV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, ..., DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save_1/Const_0_0, save_1/RestoreV2/tensor_names, save_1/RestoreV2/shape_and_slices)]]\r\n```\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\r\n- TensorFlow installed from (source or binary): Binary\r\n- TensorFlow version (use command below): 1.12.0\r\n- Python version: 3.6\r\n- Bazel version (if compiling from source):\r\n- GCC/Compiler version (if compiling from source):\r\n- CUDA/cuDNN version:\r\n- GPU model and memory: Tesla K80\r\n\r\n**Code to reproduce the issue**\r\n\r\n```\r\nMODEL_DIR='model/'\r\ndef decode_image(image_bytes):\r\n    image = tf.image.decode_image(image_bytes)\r\n    image = tf.cast(image, dtype=tf.uint8)\r\n    return image\r\n\r\ndef serving_input_fn():\r\n    createmodel()\r\n    inputs = {'image_bytes': tf.placeholder(tf.string, shape=(), name=\"image_bytes\")}\r\n    imagebytes = tf.squeeze(inputs['image_bytes']) # make it a scalar\r\n    image = decode_image(imagebytes)\r\n    # make the outer dimension unknown (and not 1)\r\n    image = tf.placeholder_with_default(image, shape=[None, None, None, 3])\r\n\r\n    features = {'image_bytes' : image}\r\n    return tf.estimator.export.ServingInputReceiver(features, inputs)\r\n\r\ndef model_fn(features, labels, mode, params):\r\n    pred = tf.get_default_graph().get_tensor_by_name(\"fc1_voc12:0\")\r\n    return tf.estimator.EstimatorSpec(\r\n        mode=tf.estimator.ModeKeys.PREDICT,\r\n        predictions=pred,\r\n        export_outputs={'pred':tf.estimator.export.PredictOutput(pred)}\r\n        )\r\n\r\nestimator = tf.estimator.Estimator(\r\n    model_fn=model_fn,\r\n    model_dir=MODEL_DIR)\r\n\r\nestimator.export_savedmodel('deployment_gcp_1', serving_input_fn, strip_default_attrs=True)\r\n```\r\n\r\nI have searched this issue quite a bit. There was one bug report for an older version of tensorflow (I think 1.2.0 but I am not sure now). I am able to load and save this model using tf.saved_model.simple_save, and it works when I run predictions on it.\r\n\r\nI am not sure if this is a bug or if I am missing something really simple.\r\n"}