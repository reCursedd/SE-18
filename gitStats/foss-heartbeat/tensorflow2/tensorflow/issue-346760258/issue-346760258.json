{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21317", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21317/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21317/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21317/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21317", "id": 346760258, "node_id": "MDU6SXNzdWUzNDY3NjAyNTg=", "number": 21317, "title": "bfloat16 training with GPUs", "user": {"login": "ranjeethks", "id": 32025394, "node_id": "MDQ6VXNlcjMyMDI1Mzk0", "avatar_url": "https://avatars2.githubusercontent.com/u/32025394?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ranjeethks", "html_url": "https://github.com/ranjeethks", "followers_url": "https://api.github.com/users/ranjeethks/followers", "following_url": "https://api.github.com/users/ranjeethks/following{/other_user}", "gists_url": "https://api.github.com/users/ranjeethks/gists{/gist_id}", "starred_url": "https://api.github.com/users/ranjeethks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ranjeethks/subscriptions", "organizations_url": "https://api.github.com/users/ranjeethks/orgs", "repos_url": "https://api.github.com/users/ranjeethks/repos", "events_url": "https://api.github.com/users/ranjeethks/events{/privacy}", "received_events_url": "https://api.github.com/users/ranjeethks/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "tatatodd", "id": 5453737, "node_id": "MDQ6VXNlcjU0NTM3Mzc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5453737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatatodd", "html_url": "https://github.com/tatatodd", "followers_url": "https://api.github.com/users/tatatodd/followers", "following_url": "https://api.github.com/users/tatatodd/following{/other_user}", "gists_url": "https://api.github.com/users/tatatodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatatodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatatodd/subscriptions", "organizations_url": "https://api.github.com/users/tatatodd/orgs", "repos_url": "https://api.github.com/users/tatatodd/repos", "events_url": "https://api.github.com/users/tatatodd/events{/privacy}", "received_events_url": "https://api.github.com/users/tatatodd/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "tatatodd", "id": 5453737, "node_id": "MDQ6VXNlcjU0NTM3Mzc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5453737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatatodd", "html_url": "https://github.com/tatatodd", "followers_url": "https://api.github.com/users/tatatodd/followers", "following_url": "https://api.github.com/users/tatatodd/following{/other_user}", "gists_url": "https://api.github.com/users/tatatodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatatodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatatodd/subscriptions", "organizations_url": "https://api.github.com/users/tatatodd/orgs", "repos_url": "https://api.github.com/users/tatatodd/repos", "events_url": "https://api.github.com/users/tatatodd/events{/privacy}", "received_events_url": "https://api.github.com/users/tatatodd/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2018-08-01T20:40:49Z", "updated_at": "2018-08-23T03:45:24Z", "closed_at": "2018-08-15T22:58:57Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: No</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>:</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.8.0</li>\n<li><strong>Python version</strong>: 2.7</li>\n<li><strong>Bazel version (if compiling from source)</strong>: NA</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: NA</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.1/7.1.1</li>\n<li><strong>GPU model and memory</strong>: NVIDIA GTX 1080 Ti</li>\n<li><strong>Exact command to reproduce</strong>: shown below</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>Describe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.<br>\nI have two issues, one could be feature request, and the other could be seeking confirmation from the Tensorflow team<br>\nI am trying to execute the language model training - <a href=\"https://github.com/okuchaiev/f-lm\">https://github.com/okuchaiev/f-lm</a><br>\nthe model runs fine with the tf.float16 or tf.float32 datatypes for trainable variables.<br>\nHowever, if the trainable variables are tf.bfloat16 type, I am getting the errors (shown below for two separate cases).<br>\n(line 22 and 24 of <a href=\"https://github.com/okuchaiev/f-lm/blob/master/model_utils.py\">https://github.com/okuchaiev/f-lm/blob/master/model_utils.py</a> can affect the datatype of varibles. To define dtype as bfloat16, I changed tf.float16 in line 22 and 24 to tf.bfloat16)</p>\n<p>Case 1: Looks are bfloat16 not supported for moving_averages:</p>\n<p>Error:</p>\n<p>File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in <br>\ntf.app.run()<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run<br>\n_sys.exit(main(argv))<br>\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main<br>\nrun_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")<br>\nFile \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 14, in run_train<br>\nmodel = LM(hps, \"train\", ps_device)<br>\nFile \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 62, in <strong>init</strong><br>\nself.train_op = tf.group(*[self.train_op, ema.apply(variables_to_average)])<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/moving_averages.py\", line 386, in apply<br>\nvar.name)<br>\nTypeError: The variables must be half, float, or double: model/lstm_0/lstm_cell/kernel:0</p>\n<p>To get this error in executed the code as follows:<br>\nexport CUDA_VISIBLE_DEVICES=1<br>\nSECONDS=604800<br>\nLOGSUFFIX=bigLSTM<br>\npython /home/ranjeeths/langModel/f-lm/single_lm_train.py --logdir=/home/ranjeeths/langModel/f-lm/log/bigLSTM/$LOGSUFFIX/ --num_gpus=1 --datadir=/home/ranjeeths/langModel/lm/data/lm1b/1-billion-word-language-modeling-benchmark-r13output/ --hpconfig run_profiler=False,max_time=$SECONDS,num_steps=20,num_shards=8,num_layers=2,learning_rate=0.2,max_grad_norm=1,keep_prob=0.9,emb_size=1024,projected_size=1024,state_size=8192,num_sampled=8192,batch_size=256,float16_rnn=True,float16_non_rnn=False,loss_scale=1.0</p>\n<p>(with float16_rnn=True, float16_non_rnn=False, the lstm related variables will all be tf.bfloat16 and remaining variables will be tf.float32)</p>\n<p>Case 2: Looks like bfloat16 is not supported for 'Floor' operation (and probably many more)?</p>\n<p>Error:</p>\n<p>Traceback (most recent call last):<br>\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in <br>\ntf.app.run()<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run<br>\n_sys.exit(main(argv))<br>\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main<br>\nrun_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")<br>\nFile \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 40, in run_train<br>\nwith sv.managed_session(master, config=config) as sess:<br>\nFile \"/usr/lib64/python2.7/contextlib.py\", line 17, in <strong>enter</strong><br>\nreturn self.gen.next()<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 1000, in managed_session<br>\nself.stop(close_summary_writer=close_summary_writer)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 828, in stop<br>\nignore_live_threads=ignore_live_threads)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/coordinator.py\", line 389, in join<br>\nsix.reraise(*self._exc_info_to_raise)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 989, in managed_session<br>\nstart_standard_services=start_standard_services)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 726, in prepare_or_wait_for_session<br>\ninit_feed_dict=self._init_feed_dict, init_fn=self._init_fn)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/session_manager.py\", line 285, in prepare_session<br>\nsess.run(init_op, feed_dict=init_feed_dict)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 900, in run<br>\nrun_metadata_ptr)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1135, in _run<br>\nfeed_dict_tensor, options, run_metadata)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run<br>\nrun_metadata)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call<br>\nraise type(e)(node_def, op, message)<br>\ntensorflow.python.framework.errors_impl.InvalidArgumentError: No OpKernel was registered to support Op 'Floor' with these attrs.  Registered devices: [CPU,GPU], Registered kernels:<br>\ndevice='CPU'; T in [DT_DOUBLE]<br>\ndevice='CPU'; T in [DT_HALF]<br>\ndevice='CPU'; T in [DT_FLOAT]<br>\ndevice='GPU'; T in [DT_DOUBLE]<br>\ndevice='GPU'; T in [DT_HALF]<br>\ndevice='GPU'; T in [DT_FLOAT]</p>\n<pre><code>     [[Node: model/model/dropout/Floor = Floor[T=DT_BFLOAT16, _device=\"/gpu:0\"](model/model/dropout/add)]]\n</code></pre>\n<p>Caused by op u'model/model/dropout/Floor', defined at:<br>\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in <br>\ntf.app.run()<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run<br>\n_sys.exit(main(argv))<br>\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main<br>\nrun_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")<br>\nFile \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 14, in run_train<br>\nmodel = LM(hps, \"train\", ps_device)<br>\nFile \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 29, in <strong>init</strong><br>\nloss = self._forward(i, xs[i], ys[i])<br>\nFile \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 87, in _forward<br>\nx = tf.nn.dropout(x, hps.keep_prob)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/ops/nn_ops.py\", line 2318, in dropout<br>\nbinary_tensor = math_ops.floor(random_tensor)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 2811, in floor<br>\n\"Floor\", x=x, name=name)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper<br>\nop_def=op_def)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op<br>\nop_def=op_def)<br>\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in <strong>init</strong><br>\nself._traceback = self._graph._extract_stack()  # pylint: disable=protected-access</p>\n<p>InvalidArgumentError (see above for traceback): No OpKernel was registered to support Op 'Floor' with these attrs.  Registered devices: [CPU,GPU], Registered kernels:<br>\ndevice='CPU'; T in [DT_DOUBLE]<br>\ndevice='CPU'; T in [DT_HALF]<br>\ndevice='CPU'; T in [DT_FLOAT]<br>\ndevice='GPU'; T in [DT_DOUBLE]<br>\ndevice='GPU'; T in [DT_HALF]<br>\ndevice='GPU'; T in [DT_FLOAT]</p>\n<pre><code>     [[Node: model/model/dropout/Floor = Floor[T=DT_BFLOAT16, _device=\"/gpu:0\"](model/model/dropout/add)]]\n</code></pre>\n<p>To get this error in executed the code as follows:<br>\nexport CUDA_VISIBLE_DEVICES=1<br>\nSECONDS=604800<br>\nLOGSUFFIX=bigLSTM<br>\npython /home/ranjeeths/langModel/f-lm/single_lm_train.py --logdir=/home/ranjeeths/langModel/f-lm/log/bigLSTM/$LOGSUFFIX/ --num_gpus=1 --datadir=/home/ranjeeths/langModel/lm/data/lm1b/1-billion-word-language-modeling-benchmark-r13output/ --hpconfig run_profiler=False,max_time=$SECONDS,num_steps=20,num_shards=8,num_layers=2,learning_rate=0.2,max_grad_norm=1,keep_prob=0.9,emb_size=1024,projected_size=1024,state_size=8192,num_sampled=8192,batch_size=256,float16_rnn=False,float16_non_rnn=True,loss_scale=1.0</p>\n<p>(with float16_rnn=False, float16_non_rnn=True, the lstm related variables will all be tf.float32 and remaining variables will be tf.bfloat16)</p>\n<p>I am not sure if bfloat16 is supported for all operations (not just the ones mentioned above), or whether these errors are due to the fact that I am not using a TPU (I am using a GPU GTX 1080 now). If I use run the above code on a TPU do you think I wont be getting any more errors?</p>\n<h3>Source code / logs</h3>\n<p>Include any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): No\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.8.0\nPython version: 2.7\nBazel version (if compiling from source): NA\nGCC/Compiler version (if compiling from source): NA\nCUDA/cuDNN version: 9.1/7.1.1\nGPU model and memory: NVIDIA GTX 1080 Ti\nExact command to reproduce: shown below\n\nDescribe the problem\nDescribe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.\nI have two issues, one could be feature request, and the other could be seeking confirmation from the Tensorflow team\nI am trying to execute the language model training - https://github.com/okuchaiev/f-lm\nthe model runs fine with the tf.float16 or tf.float32 datatypes for trainable variables.\nHowever, if the trainable variables are tf.bfloat16 type, I am getting the errors (shown below for two separate cases).\n(line 22 and 24 of https://github.com/okuchaiev/f-lm/blob/master/model_utils.py can affect the datatype of varibles. To define dtype as bfloat16, I changed tf.float16 in line 22 and 24 to tf.bfloat16)\nCase 1: Looks are bfloat16 not supported for moving_averages:\nError:\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in \ntf.app.run()\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run\n_sys.exit(main(argv))\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main\nrun_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")\nFile \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 14, in run_train\nmodel = LM(hps, \"train\", ps_device)\nFile \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 62, in init\nself.train_op = tf.group(*[self.train_op, ema.apply(variables_to_average)])\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/moving_averages.py\", line 386, in apply\nvar.name)\nTypeError: The variables must be half, float, or double: model/lstm_0/lstm_cell/kernel:0\nTo get this error in executed the code as follows:\nexport CUDA_VISIBLE_DEVICES=1\nSECONDS=604800\nLOGSUFFIX=bigLSTM\npython /home/ranjeeths/langModel/f-lm/single_lm_train.py --logdir=/home/ranjeeths/langModel/f-lm/log/bigLSTM/$LOGSUFFIX/ --num_gpus=1 --datadir=/home/ranjeeths/langModel/lm/data/lm1b/1-billion-word-language-modeling-benchmark-r13output/ --hpconfig run_profiler=False,max_time=$SECONDS,num_steps=20,num_shards=8,num_layers=2,learning_rate=0.2,max_grad_norm=1,keep_prob=0.9,emb_size=1024,projected_size=1024,state_size=8192,num_sampled=8192,batch_size=256,float16_rnn=True,float16_non_rnn=False,loss_scale=1.0\n(with float16_rnn=True, float16_non_rnn=False, the lstm related variables will all be tf.bfloat16 and remaining variables will be tf.float32)\nCase 2: Looks like bfloat16 is not supported for 'Floor' operation (and probably many more)?\nError:\nTraceback (most recent call last):\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in \ntf.app.run()\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run\n_sys.exit(main(argv))\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main\nrun_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")\nFile \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 40, in run_train\nwith sv.managed_session(master, config=config) as sess:\nFile \"/usr/lib64/python2.7/contextlib.py\", line 17, in enter\nreturn self.gen.next()\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 1000, in managed_session\nself.stop(close_summary_writer=close_summary_writer)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 828, in stop\nignore_live_threads=ignore_live_threads)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/coordinator.py\", line 389, in join\nsix.reraise(*self._exc_info_to_raise)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 989, in managed_session\nstart_standard_services=start_standard_services)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 726, in prepare_or_wait_for_session\ninit_feed_dict=self._init_feed_dict, init_fn=self._init_fn)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/session_manager.py\", line 285, in prepare_session\nsess.run(init_op, feed_dict=init_feed_dict)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 900, in run\nrun_metadata_ptr)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\nfeed_dict_tensor, options, run_metadata)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\nrun_metadata)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\nraise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: No OpKernel was registered to support Op 'Floor' with these attrs.  Registered devices: [CPU,GPU], Registered kernels:\ndevice='CPU'; T in [DT_DOUBLE]\ndevice='CPU'; T in [DT_HALF]\ndevice='CPU'; T in [DT_FLOAT]\ndevice='GPU'; T in [DT_DOUBLE]\ndevice='GPU'; T in [DT_HALF]\ndevice='GPU'; T in [DT_FLOAT]\n     [[Node: model/model/dropout/Floor = Floor[T=DT_BFLOAT16, _device=\"/gpu:0\"](model/model/dropout/add)]]\n\nCaused by op u'model/model/dropout/Floor', defined at:\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in \ntf.app.run()\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run\n_sys.exit(main(argv))\nFile \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main\nrun_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")\nFile \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 14, in run_train\nmodel = LM(hps, \"train\", ps_device)\nFile \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 29, in init\nloss = self._forward(i, xs[i], ys[i])\nFile \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 87, in _forward\nx = tf.nn.dropout(x, hps.keep_prob)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/ops/nn_ops.py\", line 2318, in dropout\nbinary_tensor = math_ops.floor(random_tensor)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 2811, in floor\n\"Floor\", x=x, name=name)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\nop_def=op_def)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\nop_def=op_def)\nFile \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in init\nself._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\nInvalidArgumentError (see above for traceback): No OpKernel was registered to support Op 'Floor' with these attrs.  Registered devices: [CPU,GPU], Registered kernels:\ndevice='CPU'; T in [DT_DOUBLE]\ndevice='CPU'; T in [DT_HALF]\ndevice='CPU'; T in [DT_FLOAT]\ndevice='GPU'; T in [DT_DOUBLE]\ndevice='GPU'; T in [DT_HALF]\ndevice='GPU'; T in [DT_FLOAT]\n     [[Node: model/model/dropout/Floor = Floor[T=DT_BFLOAT16, _device=\"/gpu:0\"](model/model/dropout/add)]]\n\nTo get this error in executed the code as follows:\nexport CUDA_VISIBLE_DEVICES=1\nSECONDS=604800\nLOGSUFFIX=bigLSTM\npython /home/ranjeeths/langModel/f-lm/single_lm_train.py --logdir=/home/ranjeeths/langModel/f-lm/log/bigLSTM/$LOGSUFFIX/ --num_gpus=1 --datadir=/home/ranjeeths/langModel/lm/data/lm1b/1-billion-word-language-modeling-benchmark-r13output/ --hpconfig run_profiler=False,max_time=$SECONDS,num_steps=20,num_shards=8,num_layers=2,learning_rate=0.2,max_grad_norm=1,keep_prob=0.9,emb_size=1024,projected_size=1024,state_size=8192,num_sampled=8192,batch_size=256,float16_rnn=False,float16_non_rnn=True,loss_scale=1.0\n(with float16_rnn=False, float16_non_rnn=True, the lstm related variables will all be tf.float32 and remaining variables will be tf.bfloat16)\nI am not sure if bfloat16 is supported for all operations (not just the ones mentioned above), or whether these errors are due to the fact that I am not using a TPU (I am using a GPU GTX 1080 now). If I use run the above code on a TPU do you think I wont be getting any more errors?\nSource code / logs\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.", "body": "\r\n\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: No\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**:\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: 1.8.0\r\n- **Python version**: 2.7\r\n- **Bazel version (if compiling from source)**: NA\r\n- **GCC/Compiler version (if compiling from source)**: NA\r\n- **CUDA/cuDNN version**: 9.1/7.1.1\r\n- **GPU model and memory**: NVIDIA GTX 1080 Ti\r\n- **Exact command to reproduce**: shown below\r\n\r\n### Describe the problem\r\nDescribe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.\r\nI have two issues, one could be feature request, and the other could be seeking confirmation from the Tensorflow team\r\nI am trying to execute the language model training - https://github.com/okuchaiev/f-lm\r\nthe model runs fine with the tf.float16 or tf.float32 datatypes for trainable variables.\r\nHowever, if the trainable variables are tf.bfloat16 type, I am getting the errors (shown below for two separate cases). \r\n(line 22 and 24 of https://github.com/okuchaiev/f-lm/blob/master/model_utils.py can affect the datatype of varibles. To define dtype as bfloat16, I changed tf.float16 in line 22 and 24 to tf.bfloat16)\r\n\r\nCase 1: Looks are bfloat16 not supported for moving_averages:\r\n\r\nError:\r\n\r\n File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in <module>\r\n    tf.app.run()\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run\r\n    _sys.exit(main(argv))\r\n  File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main\r\n    run_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")\r\n  File \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 14, in run_train\r\n    model = LM(hps, \"train\", ps_device)\r\n  File \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 62, in __init__\r\n    self.train_op = tf.group(*[self.train_op, ema.apply(variables_to_average)])\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/moving_averages.py\", line 386, in apply\r\n    var.name)\r\nTypeError: The variables must be half, float, or double: model/lstm_0/lstm_cell/kernel:0\r\n\r\nTo get this error in executed the code as follows:\r\nexport CUDA_VISIBLE_DEVICES=1\r\nSECONDS=604800\r\nLOGSUFFIX=bigLSTM\r\npython /home/ranjeeths/langModel/f-lm/single_lm_train.py --logdir=/home/ranjeeths/langModel/f-lm/log/bigLSTM/$LOGSUFFIX/ --num_gpus=1 --datadir=/home/ranjeeths/langModel/lm/data/lm1b/1-billion-word-language-modeling-benchmark-r13output/ --hpconfig run_profiler=False,max_time=$SECONDS,num_steps=20,num_shards=8,num_layers=2,learning_rate=0.2,max_grad_norm=1,keep_prob=0.9,emb_size=1024,projected_size=1024,state_size=8192,num_sampled=8192,batch_size=256,float16_rnn=True,float16_non_rnn=False,loss_scale=1.0\r\n\r\n(with float16_rnn=True, float16_non_rnn=False, the lstm related variables will all be tf.bfloat16 and remaining variables will be tf.float32)\r\n\r\nCase 2: Looks like bfloat16 is not supported for 'Floor' operation (and probably many more)?\r\n\r\nError:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in <module>\r\n    tf.app.run()\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run\r\n    _sys.exit(main(argv))\r\n  File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main\r\n    run_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")\r\n  File \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 40, in run_train\r\n    with sv.managed_session(master, config=config) as sess:\r\n  File \"/usr/lib64/python2.7/contextlib.py\", line 17, in __enter__\r\n    return self.gen.next()\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 1000, in managed_session\r\n    self.stop(close_summary_writer=close_summary_writer)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 828, in stop\r\n    ignore_live_threads=ignore_live_threads)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/coordinator.py\", line 389, in join\r\n    six.reraise(*self._exc_info_to_raise)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 989, in managed_session\r\n    start_standard_services=start_standard_services)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/supervisor.py\", line 726, in prepare_or_wait_for_session\r\n    init_feed_dict=self._init_feed_dict, init_fn=self._init_fn)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/training/session_manager.py\", line 285, in prepare_session\r\n    sess.run(init_op, feed_dict=init_feed_dict)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 900, in run\r\n    run_metadata_ptr)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\r\n    run_metadata)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: No OpKernel was registered to support Op 'Floor' with these attrs.  Registered devices: [CPU,GPU], Registered kernels:\r\n  device='CPU'; T in [DT_DOUBLE]\r\n  device='CPU'; T in [DT_HALF]\r\n  device='CPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_DOUBLE]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_FLOAT]\r\n\r\n         [[Node: model/model/dropout/Floor = Floor[T=DT_BFLOAT16, _device=\"/gpu:0\"](model/model/dropout/add)]]\r\n\r\nCaused by op u'model/model/dropout/Floor', defined at:\r\n  File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 54, in <module>\r\n    tf.app.run()\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 126, in run\r\n    _sys.exit(main(argv))\r\n  File \"/home/ranjeeths/langModel/f-lm/single_lm_train.py\", line 37, in main\r\n    run_train(dataset, hps, os.path.join(FLAGS.logdir, \"train\"), ps_device=\"/gpu:0\")\r\n  File \"/home/ranjeeths/langModel/f-lm/run_utils.py\", line 14, in run_train\r\n    model = LM(hps, \"train\", ps_device)\r\n  File \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 29, in __init__\r\n    loss = self._forward(i, xs[i], ys[i])\r\n  File \"/home/ranjeeths/langModel/f-lm/language_model.py\", line 87, in _forward\r\n    x = tf.nn.dropout(x, hps.keep_prob)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/ops/nn_ops.py\", line 2318, in dropout\r\n    binary_tensor = math_ops.floor(random_tensor)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 2811, in floor\r\n    \"Floor\", x=x, name=name)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\r\n    op_def=op_def)\r\n  File \"/home/ranjeeths/MLProj/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): No OpKernel was registered to support Op 'Floor' with these attrs.  Registered devices: [CPU,GPU], Registered kernels:\r\n  device='CPU'; T in [DT_DOUBLE]\r\n  device='CPU'; T in [DT_HALF]\r\n  device='CPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_DOUBLE]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_FLOAT]\r\n\r\n         [[Node: model/model/dropout/Floor = Floor[T=DT_BFLOAT16, _device=\"/gpu:0\"](model/model/dropout/add)]]\r\n\r\nTo get this error in executed the code as follows:\r\nexport CUDA_VISIBLE_DEVICES=1\r\nSECONDS=604800\r\nLOGSUFFIX=bigLSTM\r\npython /home/ranjeeths/langModel/f-lm/single_lm_train.py --logdir=/home/ranjeeths/langModel/f-lm/log/bigLSTM/$LOGSUFFIX/ --num_gpus=1 --datadir=/home/ranjeeths/langModel/lm/data/lm1b/1-billion-word-language-modeling-benchmark-r13output/ --hpconfig run_profiler=False,max_time=$SECONDS,num_steps=20,num_shards=8,num_layers=2,learning_rate=0.2,max_grad_norm=1,keep_prob=0.9,emb_size=1024,projected_size=1024,state_size=8192,num_sampled=8192,batch_size=256,float16_rnn=False,float16_non_rnn=True,loss_scale=1.0\r\n\r\n(with float16_rnn=False, float16_non_rnn=True, the lstm related variables will all be tf.float32 and remaining variables will be tf.bfloat16)\r\n\r\n\r\nI am not sure if bfloat16 is supported for all operations (not just the ones mentioned above), or whether these errors are due to the fact that I am not using a TPU (I am using a GPU GTX 1080 now). If I use run the above code on a TPU do you think I wont be getting any more errors?\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Source code / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n"}