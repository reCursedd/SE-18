{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22326", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22326/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22326/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22326/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22326", "id": 361019301, "node_id": "MDU6SXNzdWUzNjEwMTkzMDE=", "number": 22326, "title": "CollectiveAllReduceStrategy errors with official models", "user": {"login": "nvcastet", "id": 26874160, "node_id": "MDQ6VXNlcjI2ODc0MTYw", "avatar_url": "https://avatars2.githubusercontent.com/u/26874160?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nvcastet", "html_url": "https://github.com/nvcastet", "followers_url": "https://api.github.com/users/nvcastet/followers", "following_url": "https://api.github.com/users/nvcastet/following{/other_user}", "gists_url": "https://api.github.com/users/nvcastet/gists{/gist_id}", "starred_url": "https://api.github.com/users/nvcastet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nvcastet/subscriptions", "organizations_url": "https://api.github.com/users/nvcastet/orgs", "repos_url": "https://api.github.com/users/nvcastet/repos", "events_url": "https://api.github.com/users/nvcastet/events{/privacy}", "received_events_url": "https://api.github.com/users/nvcastet/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "yuefengz", "id": 1647833, "node_id": "MDQ6VXNlcjE2NDc4MzM=", "avatar_url": "https://avatars0.githubusercontent.com/u/1647833?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yuefengz", "html_url": "https://github.com/yuefengz", "followers_url": "https://api.github.com/users/yuefengz/followers", "following_url": "https://api.github.com/users/yuefengz/following{/other_user}", "gists_url": "https://api.github.com/users/yuefengz/gists{/gist_id}", "starred_url": "https://api.github.com/users/yuefengz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yuefengz/subscriptions", "organizations_url": "https://api.github.com/users/yuefengz/orgs", "repos_url": "https://api.github.com/users/yuefengz/repos", "events_url": "https://api.github.com/users/yuefengz/events{/privacy}", "received_events_url": "https://api.github.com/users/yuefengz/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "yuefengz", "id": 1647833, "node_id": "MDQ6VXNlcjE2NDc4MzM=", "avatar_url": "https://avatars0.githubusercontent.com/u/1647833?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yuefengz", "html_url": "https://github.com/yuefengz", "followers_url": "https://api.github.com/users/yuefengz/followers", "following_url": "https://api.github.com/users/yuefengz/following{/other_user}", "gists_url": "https://api.github.com/users/yuefengz/gists{/gist_id}", "starred_url": "https://api.github.com/users/yuefengz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yuefengz/subscriptions", "organizations_url": "https://api.github.com/users/yuefengz/orgs", "repos_url": "https://api.github.com/users/yuefengz/repos", "events_url": "https://api.github.com/users/yuefengz/events{/privacy}", "received_events_url": "https://api.github.com/users/yuefengz/received_events", "type": "User", "site_admin": false}, {"login": "poxvoculi", "id": 15676913, "node_id": "MDQ6VXNlcjE1Njc2OTEz", "avatar_url": "https://avatars2.githubusercontent.com/u/15676913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/poxvoculi", "html_url": "https://github.com/poxvoculi", "followers_url": "https://api.github.com/users/poxvoculi/followers", "following_url": "https://api.github.com/users/poxvoculi/following{/other_user}", "gists_url": "https://api.github.com/users/poxvoculi/gists{/gist_id}", "starred_url": "https://api.github.com/users/poxvoculi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/poxvoculi/subscriptions", "organizations_url": "https://api.github.com/users/poxvoculi/orgs", "repos_url": "https://api.github.com/users/poxvoculi/repos", "events_url": "https://api.github.com/users/poxvoculi/events{/privacy}", "received_events_url": "https://api.github.com/users/poxvoculi/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 17, "created_at": "2018-09-17T19:56:33Z", "updated_at": "2018-09-24T13:36:15Z", "closed_at": "2018-09-22T16:23:14Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nI modified the tensorflow/models repo utility function to use CollectiveAllReduceStrategy instead of MirroredStrategy. See the one-line change at: <a href=\"https://gist.github.com/nvcastet/60b8c0c66da4cf2949e38fc790208a1c#file-distribution_utils-py-L47\">https://gist.github.com/nvcastet/60b8c0c66da4cf2949e38fc790208a1c#file-distribution_utils-py-L47</a></li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nUbuntu 16.04.4 ppc64le</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<br>\nsource</li>\n<li><strong>TensorFlow version (use command below)</strong>:<br>\n1.11</li>\n<li><strong>Python version</strong>: Python 2.7.15</li>\n<li><strong>CUDA/cuDNN version</strong>: Cuda 9.2 CuDNN 7.2.1</li>\n<li><strong>GPU model and memory</strong>: V100 16GB</li>\n<li><strong>Exact command to reproduce</strong>: ~/models/official/mnist$ python mnist.py --num_gpus 2</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>Using the MNIST model script from the tensorflow/models repo after modifying the distribution_utils.py utility file to use CollectiveAllReduceStrategy (see modification above).<br>\n<code>python mnist.py --num_gpus 2</code> crashes with</p>\n<pre><code>2018-09-17 19:28:36.648966: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at collective_ops.cc:210 : Internal: Second consumer arrived for key 10003:0:0:0:0:1\n         [[{{node conv2d_1/bias/replica_1/Initializer/CollectiveBcastRecv}} = CollectiveBcastRecv[T=DT_FLOAT, _class=[\"loc:@conv2d_1/bias/replica_1/Assign\"], group_key=1, group_size=2, instance_key=10003, shape=[64], _device=\"/job:localhost/replica:0/task:0/device:GPU:1\"]()]]\n         [[{{node GroupCrossDeviceControlEdges_0/group_deps_27/_2}} = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:1\", send_device_incarnation=1, tensor_name=\"edge_238_GroupCrossDeviceControlEdges_0/group_deps_27\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"]()]]\n</code></pre>\n<p>Full log of the run with stack trace: <a href=\"https://github.com/tensorflow/tensorflow/files/2390053/run.log\">run.log</a></p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nI modified the tensorflow/models repo utility function to use CollectiveAllReduceStrategy instead of MirroredStrategy. See the one-line change at: https://gist.github.com/nvcastet/60b8c0c66da4cf2949e38fc790208a1c#file-distribution_utils-py-L47\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nUbuntu 16.04.4 ppc64le\nTensorFlow installed from (source or binary):\nsource\nTensorFlow version (use command below):\n1.11\nPython version: Python 2.7.15\nCUDA/cuDNN version: Cuda 9.2 CuDNN 7.2.1\nGPU model and memory: V100 16GB\nExact command to reproduce: ~/models/official/mnist$ python mnist.py --num_gpus 2\n\nDescribe the problem\nUsing the MNIST model script from the tensorflow/models repo after modifying the distribution_utils.py utility file to use CollectiveAllReduceStrategy (see modification above).\npython mnist.py --num_gpus 2 crashes with\n2018-09-17 19:28:36.648966: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at collective_ops.cc:210 : Internal: Second consumer arrived for key 10003:0:0:0:0:1\n         [[{{node conv2d_1/bias/replica_1/Initializer/CollectiveBcastRecv}} = CollectiveBcastRecv[T=DT_FLOAT, _class=[\"loc:@conv2d_1/bias/replica_1/Assign\"], group_key=1, group_size=2, instance_key=10003, shape=[64], _device=\"/job:localhost/replica:0/task:0/device:GPU:1\"]()]]\n         [[{{node GroupCrossDeviceControlEdges_0/group_deps_27/_2}} = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:1\", send_device_incarnation=1, tensor_name=\"edge_238_GroupCrossDeviceControlEdges_0/group_deps_27\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"]()]]\n\nFull log of the run with stack trace: run.log", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nI modified the tensorflow/models repo utility function to use CollectiveAllReduceStrategy instead of MirroredStrategy. See the one-line change at: https://gist.github.com/nvcastet/60b8c0c66da4cf2949e38fc790208a1c#file-distribution_utils-py-L47\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nUbuntu 16.04.4 ppc64le\r\n- **TensorFlow installed from (source or binary)**:\r\nsource\r\n- **TensorFlow version (use command below)**:\r\n1.11\r\n- **Python version**: Python 2.7.15\r\n- **CUDA/cuDNN version**: Cuda 9.2 CuDNN 7.2.1\r\n- **GPU model and memory**: V100 16GB \r\n- **Exact command to reproduce**: ~/models/official/mnist$ python mnist.py --num_gpus 2\r\n### Describe the problem\r\nUsing the MNIST model script from the tensorflow/models repo after modifying the distribution_utils.py utility file to use CollectiveAllReduceStrategy (see modification above).\r\n`python mnist.py --num_gpus 2` crashes with\r\n```\r\n2018-09-17 19:28:36.648966: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at collective_ops.cc:210 : Internal: Second consumer arrived for key 10003:0:0:0:0:1\r\n         [[{{node conv2d_1/bias/replica_1/Initializer/CollectiveBcastRecv}} = CollectiveBcastRecv[T=DT_FLOAT, _class=[\"loc:@conv2d_1/bias/replica_1/Assign\"], group_key=1, group_size=2, instance_key=10003, shape=[64], _device=\"/job:localhost/replica:0/task:0/device:GPU:1\"]()]]\r\n         [[{{node GroupCrossDeviceControlEdges_0/group_deps_27/_2}} = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:1\", send_device_incarnation=1, tensor_name=\"edge_238_GroupCrossDeviceControlEdges_0/group_deps_27\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"]()]]\r\n```\r\nFull log of the run with stack trace: [run.log](https://github.com/tensorflow/tensorflow/files/2390053/run.log)"}