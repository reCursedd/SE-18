{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/161830988", "pull_request_review_id": 89183036, "id": 161830988, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE2MTgzMDk4OA==", "diff_hunk": "@@ -445,15 +518,62 @@ def _maybe_merge_batch_beams(self, t, s):\n       A reshaped version of t with shape `[batch_size, beam_width] + s`.\n \n     Raises:\n-      TypeError: If `t` is an instance of `TensorArray`.\n       ValueError:  If the rank of `t` is not statically known.\n     \"\"\"\n+    if isinstance(t, tensor_array_ops.TensorArray):\n+      return t\n     _check_maybe(t)\n     if t.shape.ndims >= 2:\n       return self._merge_batch_beams(t, s)\n     else:\n       return t\n \n+  def _maybe_sort_array_beams(self, t, parent_ids, sequence_length):\n+    \"\"\"Maybe sorts beams within a `TensorArray`.\n+\n+    Args:\n+      t: A `TensorArray` of size `max_time` that contains `Tensor`s of shape\n+        `[batch_size, beam_width, s]` or `[batch_size * beam_width, s]` where\n+        `s` is the depth shape.\n+      parent_ids: The parent ids of shape `[max_time, batch_size, beam_width]`.\n+      sequence_length: The sequence length of shape `[batch_size, beam_width]`.\n+\n+    Returns:\n+      A `TensorArray` where beams are sorted in each `Tensor` or `t` itself if it\n+      is not a `TensorArray` or does not meet shape requirements.\n+    \"\"\"\n+    if not isinstance(t, tensor_array_ops.TensorArray):\n+      return t\n+    # pylint: disable=protected-access\n+    if (not t._infer_shape or not t._element_shape\n+        or t._element_shape[0].ndims is None\n+        or t._element_shape[0].ndims < 1):\n+      shape = (\n+          t._element_shape[0] if t._infer_shape and t._element_shape\n+          else tensor_shape.TensorShape(None))\n+      tf_logging.warn(\"The TensorArray %s in the cell state is not amenable to \"\n+                      \"sorting based on the beam search result. For a \"\n+                      \"TensorArray to be sorted, its elements shape must be \"\n+                      \"defined and have at least a rank of 1, but saw shape: %s\"\n+                      % (t.handle.name, shape))\n+      return t\n+    shape = t._element_shape[0]\n+    # pylint: enable=protected-access\n+    batch_size = tensor_util.constant_value(self._batch_size)\n+    reshaped_shape = tensor_shape.TensorShape(\n+        [batch_size, self._beam_width, None])\n+    if (shape.ndims >= 1 and shape[0] == batch_size * self._beam_width", "path": "tensorflow/contrib/seq2seq/python/ops/beam_search_decoder.py", "position": null, "original_position": 184, "commit_id": "d3eb228f1db2d60caf380833684944ce12203634", "original_commit_id": "f45bcc56cb45a426555a74a7c9c6867749a9c6e2", "user": {"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}, "body": "tensor_util.constant_value can return `None` here, in which case this line will fail because `None` cannot be multiplied with `self._beam_width`.  a unit test with placeholders as inputs would have caught this, I think.", "created_at": "2018-01-16T17:34:30Z", "updated_at": "2018-03-17T07:09:51Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/13312#discussion_r161830988", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13312", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/161830988"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/13312#discussion_r161830988"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/13312"}}, "body_html": "<p>tensor_util.constant_value can return <code>None</code> here, in which case this line will fail because <code>None</code> cannot be multiplied with <code>self._beam_width</code>.  a unit test with placeholders as inputs would have caught this, I think.</p>", "body_text": "tensor_util.constant_value can return None here, in which case this line will fail because None cannot be multiplied with self._beam_width.  a unit test with placeholders as inputs would have caught this, I think."}