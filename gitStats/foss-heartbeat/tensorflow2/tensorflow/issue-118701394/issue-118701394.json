{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/344", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/344/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/344/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/344/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/344", "id": 118701394, "node_id": "MDU6SXNzdWUxMTg3MDEzOTQ=", "number": 344, "title": "Dropout Appears to Lose Tensor Shape", "user": {"login": "JosephCatrambone", "id": 2160055, "node_id": "MDQ6VXNlcjIxNjAwNTU=", "avatar_url": "https://avatars1.githubusercontent.com/u/2160055?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JosephCatrambone", "html_url": "https://github.com/JosephCatrambone", "followers_url": "https://api.github.com/users/JosephCatrambone/followers", "following_url": "https://api.github.com/users/JosephCatrambone/following{/other_user}", "gists_url": "https://api.github.com/users/JosephCatrambone/gists{/gist_id}", "starred_url": "https://api.github.com/users/JosephCatrambone/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JosephCatrambone/subscriptions", "organizations_url": "https://api.github.com/users/JosephCatrambone/orgs", "repos_url": "https://api.github.com/users/JosephCatrambone/repos", "events_url": "https://api.github.com/users/JosephCatrambone/events{/privacy}", "received_events_url": "https://api.github.com/users/JosephCatrambone/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2015-11-24T20:58:17Z", "updated_at": "2015-12-25T04:46:47Z", "closed_at": "2015-11-24T21:01:05Z", "author_association": "NONE", "body_html": "<p>While training a model, I encountered a strange issue around dropout.  I can't yet rule out user error and haven't yet produced the minimum viable product, but I wanted to get this on the board before I forgot.</p>\n<pre><code># With dropout...\n        wc1 = tf.Variable(tf.random_normal([1, sample_vec_len, 1, 64]))\n        bc1 = tf.Variable(tf.random_normal([64,]))\n        conv1 = tf.nn.conv2d(inputs, wc1, strides=[1, 1, 1, 1], padding='SAME') + bc1\n        act1 = tf.nn.relu(conv1)\n        drop1 = tf.nn.dropout(act1, keep_prob=dropout_toggle)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(64)])\n\n        wc2 = tf.Variable(tf.random_normal([1, char_sample_size, 64, 32]))\n        bc2 = tf.Variable(tf.random_normal([32,]))\n        conv2 = tf.nn.conv2d(drop1, wc2, strides=[1, 1, 1, 1], padding='SAME') + bc2\n        act2 = tf.nn.relu(conv2)\n        norm2 = tf.nn.lrn(act2, bitreader.get_sentence_vector_length(1), bias=1.0, alpha=0.001, beta=0.75)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(32)])\n\n        # Conv -&gt; FC\n        dims = act2.get_shape()\n        shape = [dims[0].value, dims[1].value, dims[2].value, dims[3].value] # dims[0].value -&gt; None\n        c_fc = tf.reshape(act2, [-1, shape[1]*shape[2]*shape[3]])\n</code></pre>\n<p>(venv)jcatrambone-osx:nlp jcatrambone$ python ./nlp_tensorflow.py ../wikipedia_utf8_filtered_20pageviews.csv.gz 1<br>\nBuilding model.<br>\nTraceback (most recent call last):<br>\nFile \"./nlp_tensorflow.py\", line 92, in <br>\nencoder, decoder, weights, biases = build_model(\"ConvNLP\", x, keep_prob)<br>\nFile \"./nlp_tensorflow.py\", line 56, in build_model<br>\nc_fc = tf.reshape(act2, [-1, shape[1]_shape[2]_shape[3]])<br>\nTypeError: unsupported operand type(s) for *: 'NoneType' and 'NoneType'</p>\n<pre><code># Remove dropout...\n        wc1 = tf.Variable(tf.random_normal([1, sample_vec_len, 1, 64]))\n        bc1 = tf.Variable(tf.random_normal([64,]))\n        conv1 = tf.nn.conv2d(inputs, wc1, strides=[1, 1, 1, 1], padding='SAME') + bc1\n        act1 = tf.nn.relu(conv1)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(64)])\n\n        wc2 = tf.Variable(tf.random_normal([1, char_sample_size, 64, 32]))\n        bc2 = tf.Variable(tf.random_normal([32,]))\n        conv2 = tf.nn.conv2d(act1, wc2, strides=[1, 1, 1, 1], padding='SAME') + bc2\n        act2 = tf.nn.relu(conv2)\n        norm2 = tf.nn.lrn(act2, bitreader.get_sentence_vector_length(1), bias=1.0, alpha=0.001, beta=0.75)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(32)])\n\n        # Conv -&gt; FC\n        dims = act2.get_shape()\n        shape = [dims[0].value, dims[1].value, dims[2].value, dims[3].value] # dims[0].value -&gt; None\n        c_fc = tf.reshape(act2, [-1, shape[1]*shape[2]*shape[3]])\n</code></pre>\n<p>(venv)jcatrambone-osx:nlp jcatrambone$ python ./nlp_tensorflow.py ../wikipedia_utf8_filtered_20pageviews.csv.gz 1<br>\nBuilding model.<br>\nDefining loss functions and optimizer.<br>\nGathering variables.<br>\nBeginning training session.<br>\ncan't determine number of CPU cores: assuming 4<br>\nI tensorflow/core/common_runtime/local_device.cc:25] Local device intra op parallelism threads: 4<br>\ncan't determine number of CPU cores: assuming 4<br>\nI tensorflow/core/common_runtime/local_session.cc:45] Local session inter op parallelism threads: 4<br>\nInitializing variables.<br>\nSession, variables, and generator initialized.  Training.</p>\n<p>Runs fine...</p>", "body_text": "While training a model, I encountered a strange issue around dropout.  I can't yet rule out user error and haven't yet produced the minimum viable product, but I wanted to get this on the board before I forgot.\n# With dropout...\n        wc1 = tf.Variable(tf.random_normal([1, sample_vec_len, 1, 64]))\n        bc1 = tf.Variable(tf.random_normal([64,]))\n        conv1 = tf.nn.conv2d(inputs, wc1, strides=[1, 1, 1, 1], padding='SAME') + bc1\n        act1 = tf.nn.relu(conv1)\n        drop1 = tf.nn.dropout(act1, keep_prob=dropout_toggle)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(64)])\n\n        wc2 = tf.Variable(tf.random_normal([1, char_sample_size, 64, 32]))\n        bc2 = tf.Variable(tf.random_normal([32,]))\n        conv2 = tf.nn.conv2d(drop1, wc2, strides=[1, 1, 1, 1], padding='SAME') + bc2\n        act2 = tf.nn.relu(conv2)\n        norm2 = tf.nn.lrn(act2, bitreader.get_sentence_vector_length(1), bias=1.0, alpha=0.001, beta=0.75)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(32)])\n\n        # Conv -> FC\n        dims = act2.get_shape()\n        shape = [dims[0].value, dims[1].value, dims[2].value, dims[3].value] # dims[0].value -> None\n        c_fc = tf.reshape(act2, [-1, shape[1]*shape[2]*shape[3]])\n\n(venv)jcatrambone-osx:nlp jcatrambone$ python ./nlp_tensorflow.py ../wikipedia_utf8_filtered_20pageviews.csv.gz 1\nBuilding model.\nTraceback (most recent call last):\nFile \"./nlp_tensorflow.py\", line 92, in \nencoder, decoder, weights, biases = build_model(\"ConvNLP\", x, keep_prob)\nFile \"./nlp_tensorflow.py\", line 56, in build_model\nc_fc = tf.reshape(act2, [-1, shape[1]_shape[2]_shape[3]])\nTypeError: unsupported operand type(s) for *: 'NoneType' and 'NoneType'\n# Remove dropout...\n        wc1 = tf.Variable(tf.random_normal([1, sample_vec_len, 1, 64]))\n        bc1 = tf.Variable(tf.random_normal([64,]))\n        conv1 = tf.nn.conv2d(inputs, wc1, strides=[1, 1, 1, 1], padding='SAME') + bc1\n        act1 = tf.nn.relu(conv1)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(64)])\n\n        wc2 = tf.Variable(tf.random_normal([1, char_sample_size, 64, 32]))\n        bc2 = tf.Variable(tf.random_normal([32,]))\n        conv2 = tf.nn.conv2d(act1, wc2, strides=[1, 1, 1, 1], padding='SAME') + bc2\n        act2 = tf.nn.relu(conv2)\n        norm2 = tf.nn.lrn(act2, bitreader.get_sentence_vector_length(1), bias=1.0, alpha=0.001, beta=0.75)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(32)])\n\n        # Conv -> FC\n        dims = act2.get_shape()\n        shape = [dims[0].value, dims[1].value, dims[2].value, dims[3].value] # dims[0].value -> None\n        c_fc = tf.reshape(act2, [-1, shape[1]*shape[2]*shape[3]])\n\n(venv)jcatrambone-osx:nlp jcatrambone$ python ./nlp_tensorflow.py ../wikipedia_utf8_filtered_20pageviews.csv.gz 1\nBuilding model.\nDefining loss functions and optimizer.\nGathering variables.\nBeginning training session.\ncan't determine number of CPU cores: assuming 4\nI tensorflow/core/common_runtime/local_device.cc:25] Local device intra op parallelism threads: 4\ncan't determine number of CPU cores: assuming 4\nI tensorflow/core/common_runtime/local_session.cc:45] Local session inter op parallelism threads: 4\nInitializing variables.\nSession, variables, and generator initialized.  Training.\nRuns fine...", "body": "While training a model, I encountered a strange issue around dropout.  I can't yet rule out user error and haven't yet produced the minimum viable product, but I wanted to get this on the board before I forgot.\n\n```\n# With dropout...\n        wc1 = tf.Variable(tf.random_normal([1, sample_vec_len, 1, 64]))\n        bc1 = tf.Variable(tf.random_normal([64,]))\n        conv1 = tf.nn.conv2d(inputs, wc1, strides=[1, 1, 1, 1], padding='SAME') + bc1\n        act1 = tf.nn.relu(conv1)\n        drop1 = tf.nn.dropout(act1, keep_prob=dropout_toggle)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(64)])\n\n        wc2 = tf.Variable(tf.random_normal([1, char_sample_size, 64, 32]))\n        bc2 = tf.Variable(tf.random_normal([32,]))\n        conv2 = tf.nn.conv2d(drop1, wc2, strides=[1, 1, 1, 1], padding='SAME') + bc2\n        act2 = tf.nn.relu(conv2)\n        norm2 = tf.nn.lrn(act2, bitreader.get_sentence_vector_length(1), bias=1.0, alpha=0.001, beta=0.75)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(32)])\n\n        # Conv -> FC\n        dims = act2.get_shape()\n        shape = [dims[0].value, dims[1].value, dims[2].value, dims[3].value] # dims[0].value -> None\n        c_fc = tf.reshape(act2, [-1, shape[1]*shape[2]*shape[3]])\n```\n\n(venv)jcatrambone-osx:nlp jcatrambone$ python ./nlp_tensorflow.py ../wikipedia_utf8_filtered_20pageviews.csv.gz 1\nBuilding model.\nTraceback (most recent call last):\n  File \"./nlp_tensorflow.py\", line 92, in <module>\n    encoder, decoder, weights, biases = build_model(\"ConvNLP\", x, keep_prob)\n  File \"./nlp_tensorflow.py\", line 56, in build_model\n    c_fc = tf.reshape(act2, [-1, shape[1]_shape[2]_shape[3]])\nTypeError: unsupported operand type(s) for *: 'NoneType' and 'NoneType'\n\n```\n# Remove dropout...\n        wc1 = tf.Variable(tf.random_normal([1, sample_vec_len, 1, 64]))\n        bc1 = tf.Variable(tf.random_normal([64,]))\n        conv1 = tf.nn.conv2d(inputs, wc1, strides=[1, 1, 1, 1], padding='SAME') + bc1\n        act1 = tf.nn.relu(conv1)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(64)])\n\n        wc2 = tf.Variable(tf.random_normal([1, char_sample_size, 64, 32]))\n        bc2 = tf.Variable(tf.random_normal([32,]))\n        conv2 = tf.nn.conv2d(act1, wc2, strides=[1, 1, 1, 1], padding='SAME') + bc2\n        act2 = tf.nn.relu(conv2)\n        norm2 = tf.nn.lrn(act2, bitreader.get_sentence_vector_length(1), bias=1.0, alpha=0.001, beta=0.75)\n        # TensorShape([Dimension(None), Dimension(1), Dimension(4620), Dimension(32)])\n\n        # Conv -> FC\n        dims = act2.get_shape()\n        shape = [dims[0].value, dims[1].value, dims[2].value, dims[3].value] # dims[0].value -> None\n        c_fc = tf.reshape(act2, [-1, shape[1]*shape[2]*shape[3]])\n```\n\n(venv)jcatrambone-osx:nlp jcatrambone$ python ./nlp_tensorflow.py ../wikipedia_utf8_filtered_20pageviews.csv.gz 1\nBuilding model.\nDefining loss functions and optimizer.\nGathering variables.\nBeginning training session.\ncan't determine number of CPU cores: assuming 4\nI tensorflow/core/common_runtime/local_device.cc:25] Local device intra op parallelism threads: 4\ncan't determine number of CPU cores: assuming 4\nI tensorflow/core/common_runtime/local_session.cc:45] Local session inter op parallelism threads: 4\nInitializing variables.\nSession, variables, and generator initialized.  Training.\n\nRuns fine...\n"}