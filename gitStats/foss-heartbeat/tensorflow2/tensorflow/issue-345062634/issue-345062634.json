{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21178", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21178/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21178/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21178/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21178", "id": 345062634, "node_id": "MDU6SXNzdWUzNDUwNjI2MzQ=", "number": 21178, "title": "Support placeholders without shape in build_raw_serving_input_receiver_fn", "user": {"login": "martis-chromium", "id": 37162146, "node_id": "MDQ6VXNlcjM3MTYyMTQ2", "avatar_url": "https://avatars0.githubusercontent.com/u/37162146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/martis-chromium", "html_url": "https://github.com/martis-chromium", "followers_url": "https://api.github.com/users/martis-chromium/followers", "following_url": "https://api.github.com/users/martis-chromium/following{/other_user}", "gists_url": "https://api.github.com/users/martis-chromium/gists{/gist_id}", "starred_url": "https://api.github.com/users/martis-chromium/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/martis-chromium/subscriptions", "organizations_url": "https://api.github.com/users/martis-chromium/orgs", "repos_url": "https://api.github.com/users/martis-chromium/repos", "events_url": "https://api.github.com/users/martis-chromium/events{/privacy}", "received_events_url": "https://api.github.com/users/martis-chromium/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "jart", "id": 49262, "node_id": "MDQ6VXNlcjQ5MjYy", "avatar_url": "https://avatars1.githubusercontent.com/u/49262?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jart", "html_url": "https://github.com/jart", "followers_url": "https://api.github.com/users/jart/followers", "following_url": "https://api.github.com/users/jart/following{/other_user}", "gists_url": "https://api.github.com/users/jart/gists{/gist_id}", "starred_url": "https://api.github.com/users/jart/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jart/subscriptions", "organizations_url": "https://api.github.com/users/jart/orgs", "repos_url": "https://api.github.com/users/jart/repos", "events_url": "https://api.github.com/users/jart/events{/privacy}", "received_events_url": "https://api.github.com/users/jart/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "jart", "id": 49262, "node_id": "MDQ6VXNlcjQ5MjYy", "avatar_url": "https://avatars1.githubusercontent.com/u/49262?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jart", "html_url": "https://github.com/jart", "followers_url": "https://api.github.com/users/jart/followers", "following_url": "https://api.github.com/users/jart/following{/other_user}", "gists_url": "https://api.github.com/users/jart/gists{/gist_id}", "starred_url": "https://api.github.com/users/jart/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jart/subscriptions", "organizations_url": "https://api.github.com/users/jart/orgs", "repos_url": "https://api.github.com/users/jart/repos", "events_url": "https://api.github.com/users/jart/events{/privacy}", "received_events_url": "https://api.github.com/users/jart/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-07-27T01:51:45Z", "updated_at": "2018-08-11T00:19:44Z", "closed_at": "2018-08-11T00:19:44Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes, a small demo.</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Debian-based Linux distribution.</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>: N/A</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: Binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: v1.9.0-0-g25c197e023 1.9.0</li>\n<li><strong>Python version</strong>: 3.5.3</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A</li>\n<li><strong>Exact command to reproduce</strong>: N/A</li>\n</ul>\n<h3>Describe the problem</h3>\n<p><code>tf.estimator.export.build_raw_serving_input_receiver_fn</code> crashes on <code>tf.placeholder</code>s that do not have a shape specified.</p>\n<h3>Source code / logs</h3>\n<p>Below is a minimal demo that causes the crash:</p>\n<pre><code># Attempts to learn x+y.\n\nimport tensorflow as tf\n\ndef input_fn():\n  x = tf.random_uniform(shape=[1])\n  y = tf.random_uniform(shape=[1])\n  return {'x': x, 'y': y}, tf.add(x, y)\n\n\ndef main(_):\n  estimator = tf.estimator.LinearRegressor([\n      tf.contrib.layers.real_valued_column('x'),\n      tf.contrib.layers.real_valued_column('y'),\n  ])\n\n  train_spec = tf.estimator.TrainSpec(input_fn)\n\n  phs = { 'x': tf.placeholder(tf.float32), 'y': tf.placeholder(tf.float32) }\n  #receiver_fn = lambda: tf.estimator.export.ServingInputReceiver(phs, phs)\n  receiver_fn = tf.estimator.export.build_raw_serving_input_receiver_fn(phs)\n\n  eval_spec = tf.estimator.EvalSpec(\n      input_fn,\n      exporters=[tf.estimator.LatestExporter('latest', receiver_fn)]\n  )\n\n  tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n\n\nif __name__ == \"__main__\":\n  tf.app.run()\n</code></pre>\n<p>Attempting to execute this code produces the following error and stacktrace (after 10mins, when model export is attempted):</p>\n<pre><code>  File \"bug_demo.py\", line 26, in main\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 447, in train_and_evaluate\n    return executor.run()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 531, in run\n    return self.run_local()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 681, in run_local\n    eval_result, export_results = evaluator.evaluate_and_export()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 898, in evaluate_and_export\n    is_the_final_export)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 931, in _export_eval_result\n    is_the_final_export=is_the_final_export))\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/exporter.py\", line 472, in export\n    is_the_final_export)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/exporter.py\", line 126, in export\n    strip_default_attrs=self._strip_default_attrs)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 650, in export_savedmodel\n    mode=model_fn_lib.ModeKeys.PREDICT)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 703, in _export_saved_model_for_mode\n    strip_default_attrs=strip_default_attrs)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 811, in _export_all_saved_models\n    mode=model_fn_lib.ModeKeys.PREDICT)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 872, in _add_meta_graph_for_mode\n    input_receiver = input_receiver_fn()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 335, in serving_input_receiver_fn\n    features, default_batch_size)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 312, in _placeholders_from_receiver_tensors_dict\n    for name, t in input_vals.items()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 312, in &lt;dictcomp&gt;\n    for name, t in input_vals.items()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 298, in _placeholder_from_tensor\n    shape_list = t.get_shape().as_list()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/framework/tensor_shape.py\", line 903, in as_list\n    raise ValueError(\"as_list() is not defined on an unknown TensorShape.\")\n</code></pre>\n<p>Replacing <code>receiver_fn</code> as per the commented-out line or adding shape parameters to <code>tf.placeholder</code> prevents this crash.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes, a small demo.\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Debian-based Linux distribution.\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: N/A\nTensorFlow installed from (source or binary): Binary\nTensorFlow version (use command below): v1.9.0-0-g25c197e023 1.9.0\nPython version: 3.5.3\nBazel version (if compiling from source): N/A\nGCC/Compiler version (if compiling from source): N/A\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A\nExact command to reproduce: N/A\n\nDescribe the problem\ntf.estimator.export.build_raw_serving_input_receiver_fn crashes on tf.placeholders that do not have a shape specified.\nSource code / logs\nBelow is a minimal demo that causes the crash:\n# Attempts to learn x+y.\n\nimport tensorflow as tf\n\ndef input_fn():\n  x = tf.random_uniform(shape=[1])\n  y = tf.random_uniform(shape=[1])\n  return {'x': x, 'y': y}, tf.add(x, y)\n\n\ndef main(_):\n  estimator = tf.estimator.LinearRegressor([\n      tf.contrib.layers.real_valued_column('x'),\n      tf.contrib.layers.real_valued_column('y'),\n  ])\n\n  train_spec = tf.estimator.TrainSpec(input_fn)\n\n  phs = { 'x': tf.placeholder(tf.float32), 'y': tf.placeholder(tf.float32) }\n  #receiver_fn = lambda: tf.estimator.export.ServingInputReceiver(phs, phs)\n  receiver_fn = tf.estimator.export.build_raw_serving_input_receiver_fn(phs)\n\n  eval_spec = tf.estimator.EvalSpec(\n      input_fn,\n      exporters=[tf.estimator.LatestExporter('latest', receiver_fn)]\n  )\n\n  tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n\n\nif __name__ == \"__main__\":\n  tf.app.run()\n\nAttempting to execute this code produces the following error and stacktrace (after 10mins, when model export is attempted):\n  File \"bug_demo.py\", line 26, in main\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 447, in train_and_evaluate\n    return executor.run()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 531, in run\n    return self.run_local()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 681, in run_local\n    eval_result, export_results = evaluator.evaluate_and_export()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 898, in evaluate_and_export\n    is_the_final_export)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 931, in _export_eval_result\n    is_the_final_export=is_the_final_export))\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/exporter.py\", line 472, in export\n    is_the_final_export)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/exporter.py\", line 126, in export\n    strip_default_attrs=self._strip_default_attrs)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 650, in export_savedmodel\n    mode=model_fn_lib.ModeKeys.PREDICT)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 703, in _export_saved_model_for_mode\n    strip_default_attrs=strip_default_attrs)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 811, in _export_all_saved_models\n    mode=model_fn_lib.ModeKeys.PREDICT)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 872, in _add_meta_graph_for_mode\n    input_receiver = input_receiver_fn()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 335, in serving_input_receiver_fn\n    features, default_batch_size)\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 312, in _placeholders_from_receiver_tensors_dict\n    for name, t in input_vals.items()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 312, in <dictcomp>\n    for name, t in input_vals.items()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 298, in _placeholder_from_tensor\n    shape_list = t.get_shape().as_list()\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/framework/tensor_shape.py\", line 903, in as_list\n    raise ValueError(\"as_list() is not defined on an unknown TensorShape.\")\n\nReplacing receiver_fn as per the commented-out line or adding shape parameters to tf.placeholder prevents this crash.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes, a small demo.\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Debian-based Linux distribution.\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**: N/A\r\n- **TensorFlow installed from (source or binary)**: Binary\r\n- **TensorFlow version (use command below)**: v1.9.0-0-g25c197e023 1.9.0\r\n- **Python version**: 3.5.3\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **GCC/Compiler version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Exact command to reproduce**: N/A\r\n\r\n\r\n### Describe the problem\r\n```tf.estimator.export.build_raw_serving_input_receiver_fn``` crashes on ```tf.placeholder```s that do not have a shape specified.\r\n\r\n### Source code / logs\r\nBelow is a minimal demo that causes the crash:\r\n```\r\n# Attempts to learn x+y.\r\n\r\nimport tensorflow as tf\r\n\r\ndef input_fn():\r\n  x = tf.random_uniform(shape=[1])\r\n  y = tf.random_uniform(shape=[1])\r\n  return {'x': x, 'y': y}, tf.add(x, y)\r\n\r\n\r\ndef main(_):\r\n  estimator = tf.estimator.LinearRegressor([\r\n      tf.contrib.layers.real_valued_column('x'),\r\n      tf.contrib.layers.real_valued_column('y'),\r\n  ])\r\n\r\n  train_spec = tf.estimator.TrainSpec(input_fn)\r\n\r\n  phs = { 'x': tf.placeholder(tf.float32), 'y': tf.placeholder(tf.float32) }\r\n  #receiver_fn = lambda: tf.estimator.export.ServingInputReceiver(phs, phs)\r\n  receiver_fn = tf.estimator.export.build_raw_serving_input_receiver_fn(phs)\r\n\r\n  eval_spec = tf.estimator.EvalSpec(\r\n      input_fn,\r\n      exporters=[tf.estimator.LatestExporter('latest', receiver_fn)]\r\n  )\r\n\r\n  tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n  tf.app.run()\r\n```\r\n\r\nAttempting to execute this code produces the following error and stacktrace (after 10mins, when model export is attempted):\r\n```\r\n  File \"bug_demo.py\", line 26, in main\r\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 447, in train_and_evaluate\r\n    return executor.run()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 531, in run\r\n    return self.run_local()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 681, in run_local\r\n    eval_result, export_results = evaluator.evaluate_and_export()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 898, in evaluate_and_export\r\n    is_the_final_export)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/training.py\", line 931, in _export_eval_result\r\n    is_the_final_export=is_the_final_export))\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/exporter.py\", line 472, in export\r\n    is_the_final_export)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/exporter.py\", line 126, in export\r\n    strip_default_attrs=self._strip_default_attrs)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 650, in export_savedmodel\r\n    mode=model_fn_lib.ModeKeys.PREDICT)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 703, in _export_saved_model_for_mode\r\n    strip_default_attrs=strip_default_attrs)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 811, in _export_all_saved_models\r\n    mode=model_fn_lib.ModeKeys.PREDICT)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/estimator.py\", line 872, in _add_meta_graph_for_mode\r\n    input_receiver = input_receiver_fn()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 335, in serving_input_receiver_fn\r\n    features, default_batch_size)\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 312, in _placeholders_from_receiver_tensors_dict\r\n    for name, t in input_vals.items()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 312, in <dictcomp>\r\n    for name, t in input_vals.items()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/estimator/export/export.py\", line 298, in _placeholder_from_tensor\r\n    shape_list = t.get_shape().as_list()\r\n  File \"tf_public/lib/python3.5/site-packages/tensorflow/python/framework/tensor_shape.py\", line 903, in as_list\r\n    raise ValueError(\"as_list() is not defined on an unknown TensorShape.\")\r\n```\r\n\r\nReplacing ```receiver_fn``` as per the commented-out line or adding shape parameters to ```tf.placeholder``` prevents this crash. "}