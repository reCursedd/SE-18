{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6294", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6294/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6294/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6294/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6294", "id": 195371843, "node_id": "MDU6SXNzdWUxOTUzNzE4NDM=", "number": 6294, "title": "feature request: MaxPool gradient of a gradient", "user": {"login": "ahundt", "id": 55744, "node_id": "MDQ6VXNlcjU1NzQ0", "avatar_url": "https://avatars1.githubusercontent.com/u/55744?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahundt", "html_url": "https://github.com/ahundt", "followers_url": "https://api.github.com/users/ahundt/followers", "following_url": "https://api.github.com/users/ahundt/following{/other_user}", "gists_url": "https://api.github.com/users/ahundt/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahundt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahundt/subscriptions", "organizations_url": "https://api.github.com/users/ahundt/orgs", "repos_url": "https://api.github.com/users/ahundt/repos", "events_url": "https://api.github.com/users/ahundt/events{/privacy}", "received_events_url": "https://api.github.com/users/ahundt/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473173272, "node_id": "MDU6TGFiZWw0NzMxNzMyNzI=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:feature", "name": "type:feature", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-12-13T21:21:01Z", "updated_at": "2017-02-23T22:41:22Z", "closed_at": "2017-01-11T05:56:13Z", "author_association": "NONE", "body_html": "<p>MaxPool gradient of a gradient is not supported as determined in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"195147813\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/keras-team/keras/issues/4694\" data-hovercard-type=\"issue\" data-hovercard-url=\"/keras-team/keras/issues/4694/hovercard\" href=\"https://github.com/keras-team/keras/issues/4694\">keras-team/keras#4694</a>, which means that examples work in keras with the theano backend but not with the TensorFlow backend. I believe the relevant place where the op is registered is at <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/ops/nn_grad.cc#L153\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/ops/nn_grad.cc#L153</a>.</p>\n<p>From the keras issue:</p>\n<p>I successfully ran <code>python mnist_cnn.py</code> from <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/keras-team/keras/commit/7e2e7a5e5a43443122df0b497f88dd77fd3bfc7c/hovercard\" href=\"https://github.com/keras-team/keras/commit/7e2e7a5e5a43443122df0b497f88dd77fd3bfc7c\">keras-team/keras@<tt>7e2e7a5</tt></a> on my GTX1080 with a TensorFlow R0.12rc0 backend. I then ran python <a href=\"https://github.com/fchollet/keras/blob/7e2e7a5e5a43443122df0b497f88dd77fd3bfc7c/examples/mnist_swwae.py\">mnist_swwae.py</a>  and got the following failure:</p>\n<div class=\"highlight highlight-source-shell\"><pre><span class=\"pl-k\">~</span>/src/keras/examples on master\n\u00b1 python mnist_swwae.py\nUsing TensorFlow backend.\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so.5 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so.8.0 locally\nX_train shape: (60000, 1, 28, 28)\n60000 train samples\n10000 <span class=\"pl-c1\">test</span> samples\nTraceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>mnist_swwae.py<span class=\"pl-pds\">\"</span></span>, line 136, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    y = MaxPooling2D(pool_size=(pool_sizes[i], pool_sizes[i]))(y_prepool)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py<span class=\"pl-pds\">\"</span></span>, line 517, <span class=\"pl-k\">in</span> __call__\n    self.add_inbound_node(inbound_layers, node_indices, tensor_indices)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py<span class=\"pl-pds\">\"</span></span>, line 571, <span class=\"pl-k\">in</span> add_inbound_node\n    Node.create_node(self, inbound_layers, node_indices, tensor_indices)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py<span class=\"pl-pds\">\"</span></span>, line 155, <span class=\"pl-k\">in</span> create_node\n    output_tensors = to_list(outbound_layer.call(input_tensors[0], mask=input_masks[0]))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/layers/pooling.py<span class=\"pl-pds\">\"</span></span>, line 158, <span class=\"pl-k\">in</span> call\n    dim_ordering=self.dim_ordering)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/layers/pooling.py<span class=\"pl-pds\">\"</span></span>, line 207, <span class=\"pl-k\">in</span> _pooling_function\n    border_mode, dim_ordering, pool_mode=<span class=\"pl-s\"><span class=\"pl-pds\">'</span>max<span class=\"pl-pds\">'</span></span>)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/backend/tensorflow_backend.py<span class=\"pl-pds\">\"</span></span>, line 1853, <span class=\"pl-k\">in</span> pool2d\n    x = tf.nn.max_pool(x, pool_size, strides, padding=padding)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn_ops.py<span class=\"pl-pds\">\"</span></span>, line 1617, <span class=\"pl-k\">in</span> max_pool\n    name=name)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_nn_ops.py<span class=\"pl-pds\">\"</span></span>, line 1598, <span class=\"pl-k\">in</span> _max_pool\n    data_format=data_format, name=name)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py<span class=\"pl-pds\">\"</span></span>, line 759, <span class=\"pl-k\">in</span> apply_op\n    op_def=op_def)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line 2242, <span class=\"pl-k\">in</span> create_op\n    set_shapes_for_outputs(ret)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line 1617, <span class=\"pl-k\">in</span> set_shapes_for_outputs\n    shapes = shape_func(op)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line 1568, <span class=\"pl-k\">in</span> call_with_requiring\n    <span class=\"pl-k\">return</span> call_cpp_shape_fn(op, require_shape_fn=True)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py<span class=\"pl-pds\">\"</span></span>, line 610, <span class=\"pl-k\">in</span> call_cpp_shape_fn\n    debug_python_shape_fn, require_shape_fn)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py<span class=\"pl-pds\">\"</span></span>, line 675, <span class=\"pl-k\">in</span> _call_cpp_shape_fn_impl\n    raise ValueError(err.message)\nValueError: Negative dimension size caused by subtracting 2 from 1 <span class=\"pl-k\">for</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>MaxPool<span class=\"pl-pds\">'</span></span> (op: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>MaxPool<span class=\"pl-pds\">'</span></span>) with input shapes: [<span class=\"pl-k\">?</span>,1,32,8].\n-<span class=\"pl-k\">&gt;</span> [1]</pre></div>", "body_text": "MaxPool gradient of a gradient is not supported as determined in keras-team/keras#4694, which means that examples work in keras with the theano backend but not with the TensorFlow backend. I believe the relevant place where the op is registered is at https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/ops/nn_grad.cc#L153.\nFrom the keras issue:\nI successfully ran python mnist_cnn.py from keras-team/keras@7e2e7a5 on my GTX1080 with a TensorFlow R0.12rc0 backend. I then ran python mnist_swwae.py  and got the following failure:\n~/src/keras/examples on master\n\u00b1 python mnist_swwae.py\nUsing TensorFlow backend.\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so.5 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so.8.0 locally\nX_train shape: (60000, 1, 28, 28)\n60000 train samples\n10000 test samples\nTraceback (most recent call last):\n  File \"mnist_swwae.py\", line 136, in <module>\n    y = MaxPooling2D(pool_size=(pool_sizes[i], pool_sizes[i]))(y_prepool)\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py\", line 517, in __call__\n    self.add_inbound_node(inbound_layers, node_indices, tensor_indices)\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py\", line 571, in add_inbound_node\n    Node.create_node(self, inbound_layers, node_indices, tensor_indices)\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py\", line 155, in create_node\n    output_tensors = to_list(outbound_layer.call(input_tensors[0], mask=input_masks[0]))\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/layers/pooling.py\", line 158, in call\n    dim_ordering=self.dim_ordering)\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/layers/pooling.py\", line 207, in _pooling_function\n    border_mode, dim_ordering, pool_mode='max')\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/backend/tensorflow_backend.py\", line 1853, in pool2d\n    x = tf.nn.max_pool(x, pool_size, strides, padding=padding)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn_ops.py\", line 1617, in max_pool\n    name=name)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_nn_ops.py\", line 1598, in _max_pool\n    data_format=data_format, name=name)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 759, in apply_op\n    op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2242, in create_op\n    set_shapes_for_outputs(ret)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1617, in set_shapes_for_outputs\n    shapes = shape_func(op)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1568, in call_with_requiring\n    return call_cpp_shape_fn(op, require_shape_fn=True)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py\", line 610, in call_cpp_shape_fn\n    debug_python_shape_fn, require_shape_fn)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py\", line 675, in _call_cpp_shape_fn_impl\n    raise ValueError(err.message)\nValueError: Negative dimension size caused by subtracting 2 from 1 for 'MaxPool' (op: 'MaxPool') with input shapes: [?,1,32,8].\n-> [1]", "body": "MaxPool gradient of a gradient is not supported as determined in https://github.com/fchollet/keras/issues/4694, which means that examples work in keras with the theano backend but not with the TensorFlow backend. I believe the relevant place where the op is registered is at https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/ops/nn_grad.cc#L153.\r\n\r\nFrom the keras issue:\r\n\r\nI successfully ran `python mnist_cnn.py` from https://github.com/fchollet/keras/commit/7e2e7a5e5a43443122df0b497f88dd77fd3bfc7c on my GTX1080 with a TensorFlow R0.12rc0 backend. I then ran python [mnist_swwae.py](https://github.com/fchollet/keras/blob/7e2e7a5e5a43443122df0b497f88dd77fd3bfc7c/examples/mnist_swwae.py)  and got the following failure:\r\n\r\n```bash\r\n~/src/keras/examples on master\r\n\u00b1 python mnist_swwae.py\r\nUsing TensorFlow backend.\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so.8.0 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so.5 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so.8.0 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so.8.0 locally\r\nX_train shape: (60000, 1, 28, 28)\r\n60000 train samples\r\n10000 test samples\r\nTraceback (most recent call last):\r\n  File \"mnist_swwae.py\", line 136, in <module>\r\n    y = MaxPooling2D(pool_size=(pool_sizes[i], pool_sizes[i]))(y_prepool)\r\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py\", line 517, in __call__\r\n    self.add_inbound_node(inbound_layers, node_indices, tensor_indices)\r\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py\", line 571, in add_inbound_node\r\n    Node.create_node(self, inbound_layers, node_indices, tensor_indices)\r\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/engine/topology.py\", line 155, in create_node\r\n    output_tensors = to_list(outbound_layer.call(input_tensors[0], mask=input_masks[0]))\r\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/layers/pooling.py\", line 158, in call\r\n    dim_ordering=self.dim_ordering)\r\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/layers/pooling.py\", line 207, in _pooling_function\r\n    border_mode, dim_ordering, pool_mode='max')\r\n  File \"/usr/local/lib/python2.7/dist-packages/Keras-1.1.2-py2.7.egg/keras/backend/tensorflow_backend.py\", line 1853, in pool2d\r\n    x = tf.nn.max_pool(x, pool_size, strides, padding=padding)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn_ops.py\", line 1617, in max_pool\r\n    name=name)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_nn_ops.py\", line 1598, in _max_pool\r\n    data_format=data_format, name=name)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 759, in apply_op\r\n    op_def=op_def)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2242, in create_op\r\n    set_shapes_for_outputs(ret)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1617, in set_shapes_for_outputs\r\n    shapes = shape_func(op)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1568, in call_with_requiring\r\n    return call_cpp_shape_fn(op, require_shape_fn=True)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py\", line 610, in call_cpp_shape_fn\r\n    debug_python_shape_fn, require_shape_fn)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py\", line 675, in _call_cpp_shape_fn_impl\r\n    raise ValueError(err.message)\r\nValueError: Negative dimension size caused by subtracting 2 from 1 for 'MaxPool' (op: 'MaxPool') with input shapes: [?,1,32,8].\r\n-> [1]\r\n```"}