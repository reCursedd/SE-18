{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/171640964", "html_url": "https://github.com/tensorflow/tensorflow/pull/764#issuecomment-171640964", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/764", "id": 171640964, "node_id": "MDEyOklzc3VlQ29tbWVudDE3MTY0MDk2NA==", "user": {"login": "jfsantos", "id": 5733, "node_id": "MDQ6VXNlcjU3MzM=", "avatar_url": "https://avatars1.githubusercontent.com/u/5733?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jfsantos", "html_url": "https://github.com/jfsantos", "followers_url": "https://api.github.com/users/jfsantos/followers", "following_url": "https://api.github.com/users/jfsantos/following{/other_user}", "gists_url": "https://api.github.com/users/jfsantos/gists{/gist_id}", "starred_url": "https://api.github.com/users/jfsantos/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jfsantos/subscriptions", "organizations_url": "https://api.github.com/users/jfsantos/orgs", "repos_url": "https://api.github.com/users/jfsantos/repos", "events_url": "https://api.github.com/users/jfsantos/events{/privacy}", "received_events_url": "https://api.github.com/users/jfsantos/received_events", "type": "User", "site_admin": false}, "created_at": "2016-01-14T13:12:53Z", "updated_at": "2016-01-14T13:14:44Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I guess I was too tired and did not see <code>PyString_FromStringAndSize</code> was missing, sorry!</p>\n<p>My Linux box is on Ubuntu 14.04, which ships SWIG 2.0.11, but with SWIG 3.0.8 on my Mac I got the same auto-generated macros. However, SWIG's at fault: if you check line 208 on <code>tensorflow/python/client/tf_session.i</code>, we added a SWIG typemap which uses an <code>#if PY_MAJOR_VERSION</code>. This is what gets translated into the broken code, since the SWIG-generated file has a similar call with blank lines in the places the branched-out <code>#if</code> lines are.</p>\n<p>Code in <code>tf_session.i</code>:</p>\n<pre><code>%typemap(out) TF_Buffer TF_GetOpList {\n#if PY_MAJOR_VERSION &lt; 3\n  $result = PyString_FromStringAndSize(\n#else\n  $result = PyUnicode_FromStringAndSize(\n#endif\n      reinterpret_cast&lt;const char*&gt;($1.data), $1.length);\n}\n</code></pre>\n<p>Code in <code>pywrap_tensorflow.cc</code>:</p>\n<pre><code>  {\n    resultobj = PyString_FromStringAndSize(\n\n\n\n      reinterpret_cast&lt;const char*&gt;((&amp;result)-&gt;data), (&amp;result)-&gt;length);\n  }\n</code></pre>\n<p>Turns out <a href=\"http://www.swig.org/Doc1.3/Preprocessor.html#Preprocessor_nn9\" rel=\"nofollow\">SWIG was preprocessing</a> the <code>#if PY_MAJOR_VERSION</code> as you suspected, and you have to use <code>%#</code> instead of <code>#</code> to make it forward preprocessing directives to the generated code. This is fixed in the last commit and the code now compiles successfully on OS X and Linux.</p>", "body_text": "I guess I was too tired and did not see PyString_FromStringAndSize was missing, sorry!\nMy Linux box is on Ubuntu 14.04, which ships SWIG 2.0.11, but with SWIG 3.0.8 on my Mac I got the same auto-generated macros. However, SWIG's at fault: if you check line 208 on tensorflow/python/client/tf_session.i, we added a SWIG typemap which uses an #if PY_MAJOR_VERSION. This is what gets translated into the broken code, since the SWIG-generated file has a similar call with blank lines in the places the branched-out #if lines are.\nCode in tf_session.i:\n%typemap(out) TF_Buffer TF_GetOpList {\n#if PY_MAJOR_VERSION < 3\n  $result = PyString_FromStringAndSize(\n#else\n  $result = PyUnicode_FromStringAndSize(\n#endif\n      reinterpret_cast<const char*>($1.data), $1.length);\n}\n\nCode in pywrap_tensorflow.cc:\n  {\n    resultobj = PyString_FromStringAndSize(\n\n\n\n      reinterpret_cast<const char*>((&result)->data), (&result)->length);\n  }\n\nTurns out SWIG was preprocessing the #if PY_MAJOR_VERSION as you suspected, and you have to use %# instead of # to make it forward preprocessing directives to the generated code. This is fixed in the last commit and the code now compiles successfully on OS X and Linux.", "body": "I guess I was too tired and did not see `PyString_FromStringAndSize` was missing, sorry!\n\nMy Linux box is on Ubuntu 14.04, which ships SWIG 2.0.11, but with SWIG 3.0.8 on my Mac I got the same auto-generated macros. However, SWIG's at fault: if you check line 208 on `tensorflow/python/client/tf_session.i`, we added a SWIG typemap which uses an `#if PY_MAJOR_VERSION`. This is what gets translated into the broken code, since the SWIG-generated file has a similar call with blank lines in the places the branched-out `#if` lines are.\n\nCode in `tf_session.i`:\n\n```\n%typemap(out) TF_Buffer TF_GetOpList {\n#if PY_MAJOR_VERSION < 3\n  $result = PyString_FromStringAndSize(\n#else\n  $result = PyUnicode_FromStringAndSize(\n#endif\n      reinterpret_cast<const char*>($1.data), $1.length);\n}\n```\n\nCode in `pywrap_tensorflow.cc`:\n\n```\n  {\n    resultobj = PyString_FromStringAndSize(\n\n\n\n      reinterpret_cast<const char*>((&result)->data), (&result)->length);\n  }\n```\n\nTurns out [SWIG was preprocessing](http://www.swig.org/Doc1.3/Preprocessor.html#Preprocessor_nn9) the `#if PY_MAJOR_VERSION` as you suspected, and you have to use `%#` instead of `#` to make it forward preprocessing directives to the generated code. This is fixed in the last commit and the code now compiles successfully on OS X and Linux. \n"}