{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22997", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22997/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22997/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22997/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22997", "id": 370354986, "node_id": "MDU6SXNzdWUzNzAzNTQ5ODY=", "number": 22997, "title": "Undefined reference to stream_executor::Stream::ThenBlasGemm in _gru_ops.so", "user": {"login": "momeara", "id": 129072, "node_id": "MDQ6VXNlcjEyOTA3Mg==", "avatar_url": "https://avatars0.githubusercontent.com/u/129072?v=4", "gravatar_id": "", "url": "https://api.github.com/users/momeara", "html_url": "https://github.com/momeara", "followers_url": "https://api.github.com/users/momeara/followers", "following_url": "https://api.github.com/users/momeara/following{/other_user}", "gists_url": "https://api.github.com/users/momeara/gists{/gist_id}", "starred_url": "https://api.github.com/users/momeara/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/momeara/subscriptions", "organizations_url": "https://api.github.com/users/momeara/orgs", "repos_url": "https://api.github.com/users/momeara/repos", "events_url": "https://api.github.com/users/momeara/events{/privacy}", "received_events_url": "https://api.github.com/users/momeara/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2018-10-15T21:40:38Z", "updated_at": "2018-10-30T22:14:51Z", "closed_at": "2018-10-30T22:14:51Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Adjustments for build</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux  2.6.32-573.7.1.el6.centos.plus.x86_64 <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP Wed Sep 23 03:02:55 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>:</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: source git rev: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/ac7b84de8803edbb2d4da573b3f8704e9fad8fa8/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/ac7b84de8803edbb2d4da573b3f8704e9fad8fa8\"><tt>ac7b84d</tt></a></li>\n<li><strong>TensorFlow version (use command below)</strong>: b'v1.9.0-rc2-5328-gac7b84d' 1.11.0-rc1</li>\n<li><strong>Python version</strong>: Python 3.6.6 :: Anaconda, Inc.</li>\n<li><strong>Bazel version (if compiling from source)</strong>: bazel-0.17.1</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: gcc version 4.9.3 (GCC)</li>\n<li><strong>CUDA/cuDNN version</strong>: cuda-9.0, libcudnn.so.7.3.1</li>\n<li><strong>GPU model and memory</strong>:</li>\n<li><strong>Exact command to reproduce</strong>: <code>python -c \"import tensorflow.contrib</code></li>\n</ul>\n<h3>Describe the problem</h3>\n<p>Problem seems similar to the now closed <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"330383219\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/19840\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/19840/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/19840\">#19840</a></p>\n<h4>Modifications to Tensorflow source</h4>\n<p>From the checked out source I made the following modifications:</p>\n<ul>\n<li>\n<p>added <code>-lrt</code> to linkopts  in <code>tensorflow.bzl</code> for compatibility with CentOS following <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"279391392\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/15129\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/15129/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/15129\">#15129</a></p>\n</li>\n<li>\n<p>Added <code>use_default_shell_env = True to </code>ctx.action()<code>in  in</code>tensorflow.bzl` for problems with swig following <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/aiqu/devsetting/commit/f927890e05e06382ef1606decf38f192a75bac71/hovercard\" href=\"https://github.com/aiqu/devsetting/commit/f927890e05e06382ef1606decf38f192a75bac71\">aiqu/devsetting@<tt>f927890</tt></a></p>\n</li>\n<li>\n<p>compiled with --monolithic because of an issue with <code>load_library</code> throwing a <code>ByteSizeConsistencyError</code> when serializing <code>_bigtable.so</code> perhaps among others when running on my compute cluster vs. workstation where tensorflow is compiled.</p>\n</li>\n<li>\n<p>changed the paths for <code>gcc</code> to point to <code>v4.9</code> installed in <code>~/opt</code> in various <code>CROSSTOOL</code> config files.</p>\n</li>\n</ul>\n<p>Here is a <a href=\"https://gist.github.com/momeara/2edb2d606ea9490d3bbb358ed2b57855\">gist</a> of the diffs.</p>\n<h4>Set up the environment</h4>\n<pre><code>export CC=/mnt/nfs/home/momeara/opt/bin/gcc\nexport CXX=/mnt/nfs/home/momeara/opt/bin/g++\nexport PYTHON_BIN_PATH=/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/bin/python\nexport PYTHON_LIB_PATH=/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages\nexport TF_NEED_AWS=0\nexport TF_NEED_KAFKA=0\nexport TF_NEED_NGRAPH=0\nexport TF_NEED_IGNITE=0\nexport TF_NEED_ROCM=0\nexport TF_NEED_TENSORRT=0\nexport TF_NEED_JEMALLOC=0\nexport TF_NEED_GCP=0\nexport TF_NEED_HDFS=0\nexport TF_NEED_S3=0\nexport TF_ENABLE_XLA=0\nexport TF_NEED_GDR=0\nexport TF_NEED_VERBS=0\nexport TF_NEED_OPENCL=0\nexport TF_NEED_OPENCL_SYCL=0\nexport TF_NCCL_VERSION=\"2.3\"\nexport NCCL_INSTALL_PATH=/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/nccl/nccl_2.3.5-2+cuda9.0_x86_64\nexport TF_SET_ANDROID_WORKSPACE=0\nexport TF_NEED_CUDA=1\nexport TF_CUDA_VERSION=10.0\nexport CUDA_TOOLKIT_PATH=/nfs/soft/cuda-10.0\nexport CUDA_HOME=/nfs/soft/cuda-10.0\nexport TF_CUDNN_VERSION=7.3.1\nexport CUDNN_INSTALL_PATH=/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/cuda\nexport TF_CUDA_COMPUTE_CAPABILITIES=5.2\nexport TF_CUDA_CLANG=0\nexport TF_NEED_MPI=0\nexport GCC_HOST_COMPILER_PATH=/mnt/nfs/home/momeara/opt/bin/gcc\nexport CC_OPT_FLAGS='-march=native'\n# path to /nfs/soft is for /nfs/soft/cuda/include/cudnn.h\nexport CPLUS_INCLUDE_PATH=/mnt/nfs/home/momeara/opt/include:/nfs/soft:/nfs/soft/cuda/include\nexport C_INCLUDE_PATH=/mnt/nfs/home/momeara/opt/include:/nfs/soft:/nfs/soft/cuda/include\nexport LIBRARY_PATH=/nfs/soft/cuda-10.0/lib64:/nfs/soft/cuda-10.0/extras/CUPTI/lib64:/mnt/nfs/home/momeara/opt/lib:/mnt/nfs/home/momeara/opt/lib64:/nfs/soft/cuda/nfs/soft/cuda/lib64\nexport LD_LIBRARY_PATH=/nfs/soft/cuda-10.0/lib64:/nfs/ex9/work/momeara/collaborations/DeepSEA/cuda/lib64:/nfs/soft/cuda-10.0/extras/CUPTI/lib64:/mnt/nfs/home/momeara/opt/lib:/mnt/nfs/home/momeara/opt/lib64:/nfs/soft/cuda/nfs/soft/cuda/lib64\nexport PATH=/nfs/soft/cuda-10.0/bin:/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/tensorflow/bazel-0.17.1/output:/nfs/home/momeara/opt/ncbi-blast-2.2.30+/bin:/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/bin:/nfs/ex9/work/momeara/tools/anaconda3/bin:/mnt/nfs/home/momeara/.local/bin:/mnt/nfs/home/momeara/opt/node-v4.5.0-linux-x64/bin:/mnt/nfs/home/momeara/opt/bin:/usr/lib64/qt-3.3/bin:/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/bin:/bin:/usr/bin\n</code></pre>\n<h4>Build and install <code>tensorflow</code></h4>\n<pre><code>./configure\nbazel \\\n  --output_user_root=/nfs/ex9/work/momeara/collaborations/DeepSEA/tensorflow/.cache \\\n  build \\\n  --config=cuda \\\n  --config=opt \\\n  --config=monolithic \\\n  //tensorflow/tools/pip_package:build_pip_package\n\n./bazel-bin/tensorflow/tools/pip_package/build_pip_package \\\n  --src /scratch/momeara/tensorflow_pkg_dbg_monolithic_src \\\n  /scratch/momeara/tensorflow_pkg_dbg_monolithic\npip install --upgrade /scratch/momeara/tensorflow_pkg_dbg_monolithic/tensorflow-*.whl\n\npython -c \"import tensorflow.contrib\"\n</code></pre>\n<p>gives this error (see below for full backtrace)</p>\n<pre><code>tensorflow.python.framework.errors_impl.NotFoundError: /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so: undefined symbol: _ZN15stream_executor6Stream12ThenBlasGemmENS_4blas9TransposeES2_yyyfRKNS_12DeviceMemoryIfEEiS6_ifPS4_i\n</code></pre>\n<h4>Differential testing</h4>\n<ul>\n<li>The same problem only arises with the <code>--config=monolithic</code> flags.</li>\n<li>Including debug flags <code>-c dbg --copt=-DNDEBUG --strip=never</code> makes no difference.</li>\n</ul>\n<h3>Source code / logs</h3>\n<pre><code>python -c \"import tensorflow.contrib\"\n# ...generic warnings...\nTraceback (most recent call last):\n  File \"&lt;stdin&gt;\", line 1, in &lt;module&gt;\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/__init__.py\", line 45, in &lt;module&gt;\n    from tensorflow.contrib import cudnn_rnn\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/__init__.py\", line 34, in &lt;module&gt;\n    from tensorflow.contrib.cudnn_rnn.python.layers import *\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/layers/__init__.py\", line 23, in &lt;module&gt;\n    from tensorflow.contrib.cudnn_rnn.python.layers.cudnn_rnn import *\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/layers/cudnn_rnn.py\", line 20, in &lt;module&gt;\n    from tensorflow.contrib.cudnn_rnn.python.ops import cudnn_rnn_ops\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/ops/cudnn_rnn_ops.py\", line 22, in &lt;module&gt;\n    from tensorflow.contrib.rnn.python.ops import lstm_ops\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/__init__.py\", line 92, in &lt;module&gt;\n    from tensorflow.contrib.rnn.python.ops.gru_ops import *\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/gru_ops.py\", line 33, in &lt;module&gt;\n    resource_loader.get_path_to_datafile(\"_gru_ops.so\"))\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/util/loader.py\", line 56, in load_op_library\n    ret = load_library.load_op_library(path)\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/python/framework/load_library.py\", line 60, in load_op_library\n    lib_handle = py_tf.TF_LoadLibrary(library_filename)\ntensorflow.python.framework.errors_impl.NotFoundError: /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so: undefined symbol: _ZN15stream_executor6Stream12ThenBlasGemmENS_4blas9TransposeES2_yyyfRKNS_12DeviceMemoryIfEEiS6_ifPS4_i\n</code></pre>\n<p>For what it's worth here the symbols in <code>_gru_ops.so</code> missing containing <code>stream_executor</code>:</p>\n<pre><code>nm -C -u /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so | grep stream_executor                                                                                                \n                 U stream_executor::Stream::ThenBlasGemm(stream_executor::blas::Transpose, stream_executor::blas::Transpose, unsigned long long, unsigned long long, unsigned long long, double, stream_executor::DeviceMemory&lt;double&gt; const&amp;, int, stream_executor::DeviceMemory&lt;double&gt; const&amp;, int, double, stream_executor::DeviceMemory&lt;double&gt;*, int)\n                 U stream_executor::Stream::ThenBlasGemm(stream_executor::blas::Transpose, stream_executor::blas::Transpose, unsigned long long, unsigned long long, unsigned long long, float, stream_executor::DeviceMemory&lt;float&gt; const&amp;, int, stream_executor::DeviceMemory&lt;float&gt; const&amp;, int, float, stream_executor::DeviceMemory&lt;float&gt;*, int)\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Adjustments for build\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux  2.6.32-573.7.1.el6.centos.plus.x86_64 #1 SMP Wed Sep 23 03:02:55 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\nTensorFlow installed from (source or binary): source git rev: ac7b84d\nTensorFlow version (use command below): b'v1.9.0-rc2-5328-gac7b84d' 1.11.0-rc1\nPython version: Python 3.6.6 :: Anaconda, Inc.\nBazel version (if compiling from source): bazel-0.17.1\nGCC/Compiler version (if compiling from source): gcc version 4.9.3 (GCC)\nCUDA/cuDNN version: cuda-9.0, libcudnn.so.7.3.1\nGPU model and memory:\nExact command to reproduce: python -c \"import tensorflow.contrib\n\nDescribe the problem\nProblem seems similar to the now closed #19840\nModifications to Tensorflow source\nFrom the checked out source I made the following modifications:\n\n\nadded -lrt to linkopts  in tensorflow.bzl for compatibility with CentOS following #15129\n\n\nAdded use_default_shell_env = True to ctx.action()in  intensorflow.bzl` for problems with swig following aiqu/devsetting@f927890\n\n\ncompiled with --monolithic because of an issue with load_library throwing a ByteSizeConsistencyError when serializing _bigtable.so perhaps among others when running on my compute cluster vs. workstation where tensorflow is compiled.\n\n\nchanged the paths for gcc to point to v4.9 installed in ~/opt in various CROSSTOOL config files.\n\n\nHere is a gist of the diffs.\nSet up the environment\nexport CC=/mnt/nfs/home/momeara/opt/bin/gcc\nexport CXX=/mnt/nfs/home/momeara/opt/bin/g++\nexport PYTHON_BIN_PATH=/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/bin/python\nexport PYTHON_LIB_PATH=/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages\nexport TF_NEED_AWS=0\nexport TF_NEED_KAFKA=0\nexport TF_NEED_NGRAPH=0\nexport TF_NEED_IGNITE=0\nexport TF_NEED_ROCM=0\nexport TF_NEED_TENSORRT=0\nexport TF_NEED_JEMALLOC=0\nexport TF_NEED_GCP=0\nexport TF_NEED_HDFS=0\nexport TF_NEED_S3=0\nexport TF_ENABLE_XLA=0\nexport TF_NEED_GDR=0\nexport TF_NEED_VERBS=0\nexport TF_NEED_OPENCL=0\nexport TF_NEED_OPENCL_SYCL=0\nexport TF_NCCL_VERSION=\"2.3\"\nexport NCCL_INSTALL_PATH=/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/nccl/nccl_2.3.5-2+cuda9.0_x86_64\nexport TF_SET_ANDROID_WORKSPACE=0\nexport TF_NEED_CUDA=1\nexport TF_CUDA_VERSION=10.0\nexport CUDA_TOOLKIT_PATH=/nfs/soft/cuda-10.0\nexport CUDA_HOME=/nfs/soft/cuda-10.0\nexport TF_CUDNN_VERSION=7.3.1\nexport CUDNN_INSTALL_PATH=/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/cuda\nexport TF_CUDA_COMPUTE_CAPABILITIES=5.2\nexport TF_CUDA_CLANG=0\nexport TF_NEED_MPI=0\nexport GCC_HOST_COMPILER_PATH=/mnt/nfs/home/momeara/opt/bin/gcc\nexport CC_OPT_FLAGS='-march=native'\n# path to /nfs/soft is for /nfs/soft/cuda/include/cudnn.h\nexport CPLUS_INCLUDE_PATH=/mnt/nfs/home/momeara/opt/include:/nfs/soft:/nfs/soft/cuda/include\nexport C_INCLUDE_PATH=/mnt/nfs/home/momeara/opt/include:/nfs/soft:/nfs/soft/cuda/include\nexport LIBRARY_PATH=/nfs/soft/cuda-10.0/lib64:/nfs/soft/cuda-10.0/extras/CUPTI/lib64:/mnt/nfs/home/momeara/opt/lib:/mnt/nfs/home/momeara/opt/lib64:/nfs/soft/cuda/nfs/soft/cuda/lib64\nexport LD_LIBRARY_PATH=/nfs/soft/cuda-10.0/lib64:/nfs/ex9/work/momeara/collaborations/DeepSEA/cuda/lib64:/nfs/soft/cuda-10.0/extras/CUPTI/lib64:/mnt/nfs/home/momeara/opt/lib:/mnt/nfs/home/momeara/opt/lib64:/nfs/soft/cuda/nfs/soft/cuda/lib64\nexport PATH=/nfs/soft/cuda-10.0/bin:/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/tensorflow/bazel-0.17.1/output:/nfs/home/momeara/opt/ncbi-blast-2.2.30+/bin:/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/bin:/nfs/ex9/work/momeara/tools/anaconda3/bin:/mnt/nfs/home/momeara/.local/bin:/mnt/nfs/home/momeara/opt/node-v4.5.0-linux-x64/bin:/mnt/nfs/home/momeara/opt/bin:/usr/lib64/qt-3.3/bin:/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/bin:/bin:/usr/bin\n\nBuild and install tensorflow\n./configure\nbazel \\\n  --output_user_root=/nfs/ex9/work/momeara/collaborations/DeepSEA/tensorflow/.cache \\\n  build \\\n  --config=cuda \\\n  --config=opt \\\n  --config=monolithic \\\n  //tensorflow/tools/pip_package:build_pip_package\n\n./bazel-bin/tensorflow/tools/pip_package/build_pip_package \\\n  --src /scratch/momeara/tensorflow_pkg_dbg_monolithic_src \\\n  /scratch/momeara/tensorflow_pkg_dbg_monolithic\npip install --upgrade /scratch/momeara/tensorflow_pkg_dbg_monolithic/tensorflow-*.whl\n\npython -c \"import tensorflow.contrib\"\n\ngives this error (see below for full backtrace)\ntensorflow.python.framework.errors_impl.NotFoundError: /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so: undefined symbol: _ZN15stream_executor6Stream12ThenBlasGemmENS_4blas9TransposeES2_yyyfRKNS_12DeviceMemoryIfEEiS6_ifPS4_i\n\nDifferential testing\n\nThe same problem only arises with the --config=monolithic flags.\nIncluding debug flags -c dbg --copt=-DNDEBUG --strip=never makes no difference.\n\nSource code / logs\npython -c \"import tensorflow.contrib\"\n# ...generic warnings...\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/__init__.py\", line 45, in <module>\n    from tensorflow.contrib import cudnn_rnn\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/__init__.py\", line 34, in <module>\n    from tensorflow.contrib.cudnn_rnn.python.layers import *\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/layers/__init__.py\", line 23, in <module>\n    from tensorflow.contrib.cudnn_rnn.python.layers.cudnn_rnn import *\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/layers/cudnn_rnn.py\", line 20, in <module>\n    from tensorflow.contrib.cudnn_rnn.python.ops import cudnn_rnn_ops\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/ops/cudnn_rnn_ops.py\", line 22, in <module>\n    from tensorflow.contrib.rnn.python.ops import lstm_ops\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/__init__.py\", line 92, in <module>\n    from tensorflow.contrib.rnn.python.ops.gru_ops import *\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/gru_ops.py\", line 33, in <module>\n    resource_loader.get_path_to_datafile(\"_gru_ops.so\"))\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/util/loader.py\", line 56, in load_op_library\n    ret = load_library.load_op_library(path)\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/python/framework/load_library.py\", line 60, in load_op_library\n    lib_handle = py_tf.TF_LoadLibrary(library_filename)\ntensorflow.python.framework.errors_impl.NotFoundError: /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so: undefined symbol: _ZN15stream_executor6Stream12ThenBlasGemmENS_4blas9TransposeES2_yyyfRKNS_12DeviceMemoryIfEEiS6_ifPS4_i\n\nFor what it's worth here the symbols in _gru_ops.so missing containing stream_executor:\nnm -C -u /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so | grep stream_executor                                                                                                \n                 U stream_executor::Stream::ThenBlasGemm(stream_executor::blas::Transpose, stream_executor::blas::Transpose, unsigned long long, unsigned long long, unsigned long long, double, stream_executor::DeviceMemory<double> const&, int, stream_executor::DeviceMemory<double> const&, int, double, stream_executor::DeviceMemory<double>*, int)\n                 U stream_executor::Stream::ThenBlasGemm(stream_executor::blas::Transpose, stream_executor::blas::Transpose, unsigned long long, unsigned long long, unsigned long long, float, stream_executor::DeviceMemory<float> const&, int, stream_executor::DeviceMemory<float> const&, int, float, stream_executor::DeviceMemory<float>*, int)", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Adjustments for build\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux <HOST> 2.6.32-573.7.1.el6.centos.plus.x86_64 #1 SMP Wed Sep 23 03:02:55 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**:\r\n- **TensorFlow installed from (source or binary)**: source git rev: ac7b84de8803edbb2d4da573b3f8704e9fad8fa8\r\n- **TensorFlow version (use command below)**: b'v1.9.0-rc2-5328-gac7b84d' 1.11.0-rc1\r\n- **Python version**: Python 3.6.6 :: Anaconda, Inc.\r\n- **Bazel version (if compiling from source)**: bazel-0.17.1\r\n- **GCC/Compiler version (if compiling from source)**: gcc version 4.9.3 (GCC)\r\n- **CUDA/cuDNN version**: cuda-9.0, libcudnn.so.7.3.1\r\n- **GPU model and memory**:\r\n- **Exact command to reproduce**: `python -c \"import tensorflow.contrib`\r\n\r\n\r\n\r\n### Describe the problem\r\n\r\nProblem seems similar to the now closed #19840\r\n\r\n#### Modifications to Tensorflow source\r\nFrom the checked out source I made the following modifications:\r\n\r\n- added `-lrt` to linkopts  in `tensorflow.bzl` for compatibility with CentOS following https://github.com/tensorflow/tensorflow/issues/15129\r\n\r\n- Added `use_default_shell_env = True to `ctx.action()` in  in `tensorflow.bzl` for problems with swig following https://github.com/aiqu/devsetting/commit/f927890e05e06382ef1606decf38f192a75bac71\r\n\r\n- compiled with --monolithic because of an issue with `load_library` throwing a `ByteSizeConsistencyError` when serializing `_bigtable.so` perhaps among others when running on my compute cluster vs. workstation where tensorflow is compiled.\r\n\r\n- changed the paths for `gcc` to point to `v4.9` installed in `~/opt` in various `CROSSTOOL` config files.\r\n\r\nHere is a [gist](https://gist.github.com/momeara/2edb2d606ea9490d3bbb358ed2b57855) of the diffs.\r\n\r\n\r\n#### Set up the environment\r\n```\r\nexport CC=/mnt/nfs/home/momeara/opt/bin/gcc\r\nexport CXX=/mnt/nfs/home/momeara/opt/bin/g++\r\nexport PYTHON_BIN_PATH=/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/bin/python\r\nexport PYTHON_LIB_PATH=/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages\r\nexport TF_NEED_AWS=0\r\nexport TF_NEED_KAFKA=0\r\nexport TF_NEED_NGRAPH=0\r\nexport TF_NEED_IGNITE=0\r\nexport TF_NEED_ROCM=0\r\nexport TF_NEED_TENSORRT=0\r\nexport TF_NEED_JEMALLOC=0\r\nexport TF_NEED_GCP=0\r\nexport TF_NEED_HDFS=0\r\nexport TF_NEED_S3=0\r\nexport TF_ENABLE_XLA=0\r\nexport TF_NEED_GDR=0\r\nexport TF_NEED_VERBS=0\r\nexport TF_NEED_OPENCL=0\r\nexport TF_NEED_OPENCL_SYCL=0\r\nexport TF_NCCL_VERSION=\"2.3\"\r\nexport NCCL_INSTALL_PATH=/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/nccl/nccl_2.3.5-2+cuda9.0_x86_64\r\nexport TF_SET_ANDROID_WORKSPACE=0\r\nexport TF_NEED_CUDA=1\r\nexport TF_CUDA_VERSION=10.0\r\nexport CUDA_TOOLKIT_PATH=/nfs/soft/cuda-10.0\r\nexport CUDA_HOME=/nfs/soft/cuda-10.0\r\nexport TF_CUDNN_VERSION=7.3.1\r\nexport CUDNN_INSTALL_PATH=/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/cuda\r\nexport TF_CUDA_COMPUTE_CAPABILITIES=5.2\r\nexport TF_CUDA_CLANG=0\r\nexport TF_NEED_MPI=0\r\nexport GCC_HOST_COMPILER_PATH=/mnt/nfs/home/momeara/opt/bin/gcc\r\nexport CC_OPT_FLAGS='-march=native'\r\n# path to /nfs/soft is for /nfs/soft/cuda/include/cudnn.h\r\nexport CPLUS_INCLUDE_PATH=/mnt/nfs/home/momeara/opt/include:/nfs/soft:/nfs/soft/cuda/include\r\nexport C_INCLUDE_PATH=/mnt/nfs/home/momeara/opt/include:/nfs/soft:/nfs/soft/cuda/include\r\nexport LIBRARY_PATH=/nfs/soft/cuda-10.0/lib64:/nfs/soft/cuda-10.0/extras/CUPTI/lib64:/mnt/nfs/home/momeara/opt/lib:/mnt/nfs/home/momeara/opt/lib64:/nfs/soft/cuda/nfs/soft/cuda/lib64\r\nexport LD_LIBRARY_PATH=/nfs/soft/cuda-10.0/lib64:/nfs/ex9/work/momeara/collaborations/DeepSEA/cuda/lib64:/nfs/soft/cuda-10.0/extras/CUPTI/lib64:/mnt/nfs/home/momeara/opt/lib:/mnt/nfs/home/momeara/opt/lib64:/nfs/soft/cuda/nfs/soft/cuda/lib64\r\nexport PATH=/nfs/soft/cuda-10.0/bin:/mnt/nfs/ex9/work/momeara/collaborations/DeepSEA/tensorflow/bazel-0.17.1/output:/nfs/home/momeara/opt/ncbi-blast-2.2.30+/bin:/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/bin:/nfs/ex9/work/momeara/tools/anaconda3/bin:/mnt/nfs/home/momeara/.local/bin:/mnt/nfs/home/momeara/opt/node-v4.5.0-linux-x64/bin:/mnt/nfs/home/momeara/opt/bin:/usr/lib64/qt-3.3/bin:/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/bin:/bin:/usr/bin\r\n```\r\n\r\n\r\n#### Build and install `tensorflow`\r\n```\r\n./configure\r\nbazel \\\r\n  --output_user_root=/nfs/ex9/work/momeara/collaborations/DeepSEA/tensorflow/.cache \\\r\n  build \\\r\n  --config=cuda \\\r\n  --config=opt \\\r\n  --config=monolithic \\\r\n  //tensorflow/tools/pip_package:build_pip_package\r\n\r\n./bazel-bin/tensorflow/tools/pip_package/build_pip_package \\\r\n  --src /scratch/momeara/tensorflow_pkg_dbg_monolithic_src \\\r\n  /scratch/momeara/tensorflow_pkg_dbg_monolithic\r\npip install --upgrade /scratch/momeara/tensorflow_pkg_dbg_monolithic/tensorflow-*.whl\r\n\r\npython -c \"import tensorflow.contrib\"\r\n```\r\ngives this error (see below for full backtrace)\r\n\r\n```\r\ntensorflow.python.framework.errors_impl.NotFoundError: /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so: undefined symbol: _ZN15stream_executor6Stream12ThenBlasGemmENS_4blas9TransposeES2_yyyfRKNS_12DeviceMemoryIfEEiS6_ifPS4_i\r\n```\r\n\r\n#### Differential testing\r\n- The same problem only arises with the `--config=monolithic` flags.\r\n- Including debug flags `-c dbg --copt=-DNDEBUG --strip=never` makes no difference.\r\n\r\n### Source code / logs\r\n\r\n```\r\npython -c \"import tensorflow.contrib\"\r\n# ...generic warnings...\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/__init__.py\", line 45, in <module>\r\n    from tensorflow.contrib import cudnn_rnn\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/__init__.py\", line 34, in <module>\r\n    from tensorflow.contrib.cudnn_rnn.python.layers import *\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/layers/__init__.py\", line 23, in <module>\r\n    from tensorflow.contrib.cudnn_rnn.python.layers.cudnn_rnn import *\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/layers/cudnn_rnn.py\", line 20, in <module>\r\n    from tensorflow.contrib.cudnn_rnn.python.ops import cudnn_rnn_ops\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/cudnn_rnn/python/ops/cudnn_rnn_ops.py\", line 22, in <module>\r\n    from tensorflow.contrib.rnn.python.ops import lstm_ops\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/__init__.py\", line 92, in <module>\r\n    from tensorflow.contrib.rnn.python.ops.gru_ops import *\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/gru_ops.py\", line 33, in <module>\r\n    resource_loader.get_path_to_datafile(\"_gru_ops.so\"))\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/util/loader.py\", line 56, in load_op_library\r\n    ret = load_library.load_op_library(path)\r\n  File \"/nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/python/framework/load_library.py\", line 60, in load_op_library\r\n    lib_handle = py_tf.TF_LoadLibrary(library_filename)\r\ntensorflow.python.framework.errors_impl.NotFoundError: /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so: undefined symbol: _ZN15stream_executor6Stream12ThenBlasGemmENS_4blas9TransposeES2_yyyfRKNS_12DeviceMemoryIfEEiS6_ifPS4_i\r\n```\r\n\r\nFor what it's worth here the symbols in `_gru_ops.so` missing containing `stream_executor`:\r\n\r\n```\r\nnm -C -u /nfs/ex9/work/momeara/tools/anaconda3/envs/DeepSEA/lib/python3.6/site-packages/tensorflow/contrib/rnn/python/ops/_gru_ops.so | grep stream_executor                                                                                                \r\n                 U stream_executor::Stream::ThenBlasGemm(stream_executor::blas::Transpose, stream_executor::blas::Transpose, unsigned long long, unsigned long long, unsigned long long, double, stream_executor::DeviceMemory<double> const&, int, stream_executor::DeviceMemory<double> const&, int, double, stream_executor::DeviceMemory<double>*, int)\r\n                 U stream_executor::Stream::ThenBlasGemm(stream_executor::blas::Transpose, stream_executor::blas::Transpose, unsigned long long, unsigned long long, unsigned long long, float, stream_executor::DeviceMemory<float> const&, int, stream_executor::DeviceMemory<float> const&, int, float, stream_executor::DeviceMemory<float>*, int)\r\n```\r\n"}