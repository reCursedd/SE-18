{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13437", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13437/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13437/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13437/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13437", "id": 261954178, "node_id": "MDU6SXNzdWUyNjE5NTQxNzg=", "number": 13437, "title": "Sin family identities for y=x yield bad gradients", "user": {"login": "TylerBalsam", "id": 6165535, "node_id": "MDQ6VXNlcjYxNjU1MzU=", "avatar_url": "https://avatars1.githubusercontent.com/u/6165535?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TylerBalsam", "html_url": "https://github.com/TylerBalsam", "followers_url": "https://api.github.com/users/TylerBalsam/followers", "following_url": "https://api.github.com/users/TylerBalsam/following{/other_user}", "gists_url": "https://api.github.com/users/TylerBalsam/gists{/gist_id}", "starred_url": "https://api.github.com/users/TylerBalsam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TylerBalsam/subscriptions", "organizations_url": "https://api.github.com/users/TylerBalsam/orgs", "repos_url": "https://api.github.com/users/TylerBalsam/repos", "events_url": "https://api.github.com/users/TylerBalsam/events{/privacy}", "received_events_url": "https://api.github.com/users/TylerBalsam/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-10-01T23:07:50Z", "updated_at": "2017-12-20T19:16:01Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>I'm writing a custom continuous piecewise function. At some point the function becomes an identity of f(x) = x, but while the loss decreases, the accuracy does not improve. Simply swapping in an \"x\" in the below code does cause everything to work smoothly.</p>\n<p>Originally suspected tf.where as that has NaN gradient troubles, so I rewrote an equivalent function using boolean_mask. Still the same issue. I also attempted to trim values to prevent NaN propagation. A simplified version of the code is below (the troublesome statement in question being tf.cos(i*tf.acos(x)), which equals x):</p>\n<pre><code>i = 1\n\nlocation_value = tf.stack([\n    tf.less_equal(tf.abs(x), 1), # between_neg_1_and_1\n    tf.greater(x, 1), # greater_than_1\n    tf.less(x, -1), # less_than_neg_1\n    tf.is_nan(x)] \n, -1)\n\nres = tf.stack([\n    tf.cos(i*tf.acos(tf.minimum(tf.maximum(x, -1), 1))),\n    x,\n    x,\n    0*x]\n, -1)\n\nout_shape = x.get_shape().as_list()\nout_shape[0] = batch_size\n\nres = tf.reshape(tf.boolean_mask(res, location_value), out_shape)\n</code></pre>\n<hr>\n<p>== cat /etc/issue ===============================================<br>\nLinux tyler-desktop 4.2.0-42-generic <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115994238\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/49\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/49/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/49\">#49</a>~14.04.1-Ubuntu SMP Wed Jun 29 20:22:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux<br>\nVERSION=\"14.04.5 LTS, Trusty Tahr\"<br>\nVERSION_ID=\"14.04\"</p>\n<p>== are we in docker =============================================<br>\nNo</p>\n<p>== compiler =====================================================<br>\nc++ (Ubuntu 4.8.5-2ubuntu1~14.04.1) 4.8.5<br>\nCopyright (C) 2015 Free Software Foundation, Inc.<br>\nThis is free software; see the source for copying conditions.  There is NO<br>\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</p>\n<p>== uname -a =====================================================<br>\nLinux tyler-desktop 4.2.0-42-generic <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115994238\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/49\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/49/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/49\">#49</a>~14.04.1-Ubuntu SMP Wed Jun 29 20:22:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</p>\n<p>== check pips ===================================================<br>\nnumpy (1.12.0)<br>\nprotobuf (3.1.0.post1)<br>\ntensorflow-gpu (0.12.1)</p>\n<p>== check for virtualenv =========================================<br>\nFalse</p>\n<p>== tensorflow import ============================================<br>\ntf.VERSION = 0.12.1<br>\ntf.GIT_VERSION = v0.12.0-10-g4d924e7-dirty<br>\ntf.COMPILER_VERSION = v0.12.0-10-g4d924e7-dirty<br>\nSanity check: array([1], dtype=int32)<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally</p>\n<p>== env ==========================================================<br>\nLD_LIBRARY_PATH /root/torch/install/lib:/root/torch/install/lib:/usr/local/cuda-8.0/lib64:/usr/lib:/usr/openwin/lib:/usr/dt/lib:/X11.6/lib:/X11.5/lib:/uva/lib:/gnu/lib:/usr/local/cuda/lib64:/usr/local/cuda:/usr/bin/g++<br>\nDYLD_LIBRARY_PATH /root/torch/install/lib:/root/torch/install/lib:</p>\n<p>== nvidia-smi ===================================================<br>\nSun Oct  1 18:05:01 2017<br>\n+-----------------------------------------------------------------------------+<br>\n| NVIDIA-SMI 367.48                 Driver Version: 367.48                    |<br>\n|-------------------------------+----------------------+----------------------+<br>\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br>\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br>\n|===============================+======================+======================|<br>\n|   0  GeForce GTX 1070    Off  | 0000:01:00.0      On |                  N/A |<br>\n|  0%   37C    P0    40W / 230W |    728MiB /  8110MiB |      0%      Default |<br>\n+-------------------------------+----------------------+----------------------+</p>\n<p>+-----------------------------------------------------------------------------+<br>\n| Processes:                                                       GPU Memory |<br>\n|  GPU       PID  Type  Process name                               Usage      |<br>\n|=============================================================================|<br>\n|    0      1137    G   /usr/bin/X                                     370MiB |<br>\n|    0      1761    G   compiz                                         243MiB |<br>\n|    0      2645    G   /usr/lib/firefox/firefox                         1MiB |<br>\n|    0      3024    G   ...ble-features=DocumentWriteEvaluator&lt;Disal   111MiB |<br>\n+-----------------------------------------------------------------------------+</p>\n<p>== cuda libs  ===================================================<br>\n/usr/local/cuda-8.0/doc/man/man7/libcudart.so.7<br>\n/usr/local/cuda-8.0/doc/man/man7/libcudart.7<br>\n/usr/local/cuda-8.0/lib64/libcudart.so.8.0.44<br>\n/usr/local/cuda-8.0/lib64/libcudart_static.a</p>", "body_text": "I'm writing a custom continuous piecewise function. At some point the function becomes an identity of f(x) = x, but while the loss decreases, the accuracy does not improve. Simply swapping in an \"x\" in the below code does cause everything to work smoothly.\nOriginally suspected tf.where as that has NaN gradient troubles, so I rewrote an equivalent function using boolean_mask. Still the same issue. I also attempted to trim values to prevent NaN propagation. A simplified version of the code is below (the troublesome statement in question being tf.cos(i*tf.acos(x)), which equals x):\ni = 1\n\nlocation_value = tf.stack([\n    tf.less_equal(tf.abs(x), 1), # between_neg_1_and_1\n    tf.greater(x, 1), # greater_than_1\n    tf.less(x, -1), # less_than_neg_1\n    tf.is_nan(x)] \n, -1)\n\nres = tf.stack([\n    tf.cos(i*tf.acos(tf.minimum(tf.maximum(x, -1), 1))),\n    x,\n    x,\n    0*x]\n, -1)\n\nout_shape = x.get_shape().as_list()\nout_shape[0] = batch_size\n\nres = tf.reshape(tf.boolean_mask(res, location_value), out_shape)\n\n\n== cat /etc/issue ===============================================\nLinux tyler-desktop 4.2.0-42-generic #49~14.04.1-Ubuntu SMP Wed Jun 29 20:22:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\nVERSION=\"14.04.5 LTS, Trusty Tahr\"\nVERSION_ID=\"14.04\"\n== are we in docker =============================================\nNo\n== compiler =====================================================\nc++ (Ubuntu 4.8.5-2ubuntu1~14.04.1) 4.8.5\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n== uname -a =====================================================\nLinux tyler-desktop 4.2.0-42-generic #49~14.04.1-Ubuntu SMP Wed Jun 29 20:22:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\n== check pips ===================================================\nnumpy (1.12.0)\nprotobuf (3.1.0.post1)\ntensorflow-gpu (0.12.1)\n== check for virtualenv =========================================\nFalse\n== tensorflow import ============================================\ntf.VERSION = 0.12.1\ntf.GIT_VERSION = v0.12.0-10-g4d924e7-dirty\ntf.COMPILER_VERSION = v0.12.0-10-g4d924e7-dirty\nSanity check: array([1], dtype=int32)\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\n== env ==========================================================\nLD_LIBRARY_PATH /root/torch/install/lib:/root/torch/install/lib:/usr/local/cuda-8.0/lib64:/usr/lib:/usr/openwin/lib:/usr/dt/lib:/X11.6/lib:/X11.5/lib:/uva/lib:/gnu/lib:/usr/local/cuda/lib64:/usr/local/cuda:/usr/bin/g++\nDYLD_LIBRARY_PATH /root/torch/install/lib:/root/torch/install/lib:\n== nvidia-smi ===================================================\nSun Oct  1 18:05:01 2017\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 367.48                 Driver Version: 367.48                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GTX 1070    Off  | 0000:01:00.0      On |                  N/A |\n|  0%   37C    P0    40W / 230W |    728MiB /  8110MiB |      0%      Default |\n+-------------------------------+----------------------+----------------------+\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|    0      1137    G   /usr/bin/X                                     370MiB |\n|    0      1761    G   compiz                                         243MiB |\n|    0      2645    G   /usr/lib/firefox/firefox                         1MiB |\n|    0      3024    G   ...ble-features=DocumentWriteEvaluator<Disal   111MiB |\n+-----------------------------------------------------------------------------+\n== cuda libs  ===================================================\n/usr/local/cuda-8.0/doc/man/man7/libcudart.so.7\n/usr/local/cuda-8.0/doc/man/man7/libcudart.7\n/usr/local/cuda-8.0/lib64/libcudart.so.8.0.44\n/usr/local/cuda-8.0/lib64/libcudart_static.a", "body": "I'm writing a custom continuous piecewise function. At some point the function becomes an identity of f(x) = x, but while the loss decreases, the accuracy does not improve. Simply swapping in an \"x\" in the below code does cause everything to work smoothly.\r\n\r\nOriginally suspected tf.where as that has NaN gradient troubles, so I rewrote an equivalent function using boolean_mask. Still the same issue. I also attempted to trim values to prevent NaN propagation. A simplified version of the code is below (the troublesome statement in question being tf.cos(i*tf.acos(x)), which equals x):\r\n\r\n    i = 1\r\n\r\n    location_value = tf.stack([\r\n        tf.less_equal(tf.abs(x), 1), # between_neg_1_and_1\r\n        tf.greater(x, 1), # greater_than_1\r\n        tf.less(x, -1), # less_than_neg_1\r\n        tf.is_nan(x)] \r\n    , -1)\r\n\r\n    res = tf.stack([\r\n        tf.cos(i*tf.acos(tf.minimum(tf.maximum(x, -1), 1))),\r\n        x,\r\n        x,\r\n        0*x]\r\n    , -1)\r\n\r\n    out_shape = x.get_shape().as_list()\r\n    out_shape[0] = batch_size\r\n\r\n    res = tf.reshape(tf.boolean_mask(res, location_value), out_shape)\r\n\r\n\r\n\r\n------------------------\r\n\r\n== cat /etc/issue ===============================================\r\nLinux tyler-desktop 4.2.0-42-generic #49~14.04.1-Ubuntu SMP Wed Jun 29 20:22:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\nVERSION=\"14.04.5 LTS, Trusty Tahr\"\r\nVERSION_ID=\"14.04\"\r\n\r\n== are we in docker =============================================\r\nNo\r\n\r\n== compiler =====================================================\r\nc++ (Ubuntu 4.8.5-2ubuntu1~14.04.1) 4.8.5\r\nCopyright (C) 2015 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n\r\n\r\n== uname -a =====================================================\r\nLinux tyler-desktop 4.2.0-42-generic #49~14.04.1-Ubuntu SMP Wed Jun 29 20:22:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n== check pips ===================================================\r\nnumpy (1.12.0)\r\nprotobuf (3.1.0.post1)\r\ntensorflow-gpu (0.12.1)\r\n\r\n== check for virtualenv =========================================\r\nFalse\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 0.12.1\r\ntf.GIT_VERSION = v0.12.0-10-g4d924e7-dirty\r\ntf.COMPILER_VERSION = v0.12.0-10-g4d924e7-dirty\r\nSanity check: array([1], dtype=int32)\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\r\n\r\n== env ==========================================================\r\nLD_LIBRARY_PATH /root/torch/install/lib:/root/torch/install/lib:/usr/local/cuda-8.0/lib64:/usr/lib:/usr/openwin/lib:/usr/dt/lib:/X11.6/lib:/X11.5/lib:/uva/lib:/gnu/lib:/usr/local/cuda/lib64:/usr/local/cuda:/usr/bin/g++\r\nDYLD_LIBRARY_PATH /root/torch/install/lib:/root/torch/install/lib:\r\n\r\n== nvidia-smi ===================================================\r\nSun Oct  1 18:05:01 2017       \r\n+-----------------------------------------------------------------------------+\r\n| NVIDIA-SMI 367.48                 Driver Version: 367.48                    |\r\n|-------------------------------+----------------------+----------------------+\r\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\r\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\r\n|===============================+======================+======================|\r\n|   0  GeForce GTX 1070    Off  | 0000:01:00.0      On |                  N/A |\r\n|  0%   37C    P0    40W / 230W |    728MiB /  8110MiB |      0%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n                                                                               \r\n+-----------------------------------------------------------------------------+\r\n| Processes:                                                       GPU Memory |\r\n|  GPU       PID  Type  Process name                               Usage      |\r\n|=============================================================================|\r\n|    0      1137    G   /usr/bin/X                                     370MiB |\r\n|    0      1761    G   compiz                                         243MiB |\r\n|    0      2645    G   /usr/lib/firefox/firefox                         1MiB |\r\n|    0      3024    G   ...ble-features=DocumentWriteEvaluator<Disal   111MiB |\r\n+-----------------------------------------------------------------------------+\r\n\r\n== cuda libs  ===================================================\r\n/usr/local/cuda-8.0/doc/man/man7/libcudart.so.7\r\n/usr/local/cuda-8.0/doc/man/man7/libcudart.7\r\n/usr/local/cuda-8.0/lib64/libcudart.so.8.0.44\r\n/usr/local/cuda-8.0/lib64/libcudart_static.a\r\n"}