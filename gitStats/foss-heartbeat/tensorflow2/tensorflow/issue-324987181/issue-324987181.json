{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19440", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19440/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19440/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19440/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19440", "id": 324987181, "node_id": "MDU6SXNzdWUzMjQ5ODcxODE=", "number": 19440, "title": "Race codition during updating of checkpoint file on samba file share", "user": {"login": "AlexanderYukhanov", "id": 29782957, "node_id": "MDQ6VXNlcjI5NzgyOTU3", "avatar_url": "https://avatars2.githubusercontent.com/u/29782957?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AlexanderYukhanov", "html_url": "https://github.com/AlexanderYukhanov", "followers_url": "https://api.github.com/users/AlexanderYukhanov/followers", "following_url": "https://api.github.com/users/AlexanderYukhanov/following{/other_user}", "gists_url": "https://api.github.com/users/AlexanderYukhanov/gists{/gist_id}", "starred_url": "https://api.github.com/users/AlexanderYukhanov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AlexanderYukhanov/subscriptions", "organizations_url": "https://api.github.com/users/AlexanderYukhanov/orgs", "repos_url": "https://api.github.com/users/AlexanderYukhanov/repos", "events_url": "https://api.github.com/users/AlexanderYukhanov/events{/privacy}", "received_events_url": "https://api.github.com/users/AlexanderYukhanov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": {"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2018-05-21T16:55:45Z", "updated_at": "2018-11-20T13:27:57Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>Have I written custom code: No. Any code generating checkpoints on Azure File Share seems to be affected.<br>\nOS Platform and Distribution: Ubuntu 16.04<br>\nTensorFlow installed from: NA (doesn't matter)<br>\nTensorFlow version: 1.6 (but seems to be the case for other versions as well)<br>\nBazel version: NA<br>\nCUDA/cuDNN version: 9.0 (doesn't matter)<br>\nGPU model and memory: K80<br>\nExact command to reproduce: launch long running training job which generates checkpoints on Azure File Share or just simulate race conditions in atomic_write_string_to_file when the target file is opened by other thread or process (see Describe the problem below).</p>\n<h3>Describe the problem</h3>\n<p>I am observing a race condition while writing checkpoint file into Azure File Share directory - atomic_write_string_to_file sometimes (after multiple hours of training) crashes with \"Permission denied\" error. This race condition seems to be the same as being fixed by <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/3758878728710801f681afba39e145df4ddb8bf1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/3758878728710801f681afba39e145df4ddb8bf1\"><tt>3758878</tt></a>. Unfortunately, this fix doesn't work on Azure file share (and, probably, on cifs in general) because of a fancy samba behavior - rename of a file fails if the target file is currently opened. Here is a simple repro for this behavior:</p>\n<pre><code>import os\nf = open('target.txt', 'r')\nos.rename('source.txt', 'target.txt')\n\nTraceback (most recent call last):\nPermissionError: [Errno 13] Permission denied: 'source.txt' -&gt; 'target.txt'\n</code></pre>", "body_text": "Have I written custom code: No. Any code generating checkpoints on Azure File Share seems to be affected.\nOS Platform and Distribution: Ubuntu 16.04\nTensorFlow installed from: NA (doesn't matter)\nTensorFlow version: 1.6 (but seems to be the case for other versions as well)\nBazel version: NA\nCUDA/cuDNN version: 9.0 (doesn't matter)\nGPU model and memory: K80\nExact command to reproduce: launch long running training job which generates checkpoints on Azure File Share or just simulate race conditions in atomic_write_string_to_file when the target file is opened by other thread or process (see Describe the problem below).\nDescribe the problem\nI am observing a race condition while writing checkpoint file into Azure File Share directory - atomic_write_string_to_file sometimes (after multiple hours of training) crashes with \"Permission denied\" error. This race condition seems to be the same as being fixed by 3758878. Unfortunately, this fix doesn't work on Azure file share (and, probably, on cifs in general) because of a fancy samba behavior - rename of a file fails if the target file is currently opened. Here is a simple repro for this behavior:\nimport os\nf = open('target.txt', 'r')\nos.rename('source.txt', 'target.txt')\n\nTraceback (most recent call last):\nPermissionError: [Errno 13] Permission denied: 'source.txt' -> 'target.txt'", "body": "Have I written custom code: No. Any code generating checkpoints on Azure File Share seems to be affected.\r\nOS Platform and Distribution: Ubuntu 16.04\r\nTensorFlow installed from: NA (doesn't matter)\r\nTensorFlow version: 1.6 (but seems to be the case for other versions as well)\r\nBazel version: NA\r\nCUDA/cuDNN version: 9.0 (doesn't matter)\r\nGPU model and memory: K80\r\nExact command to reproduce: launch long running training job which generates checkpoints on Azure File Share or just simulate race conditions in atomic_write_string_to_file when the target file is opened by other thread or process (see Describe the problem below).\r\n\r\n### Describe the problem\r\nI am observing a race condition while writing checkpoint file into Azure File Share directory - atomic_write_string_to_file sometimes (after multiple hours of training) crashes with \"Permission denied\" error. This race condition seems to be the same as being fixed by 3758878728710801f681afba39e145df4ddb8bf1. Unfortunately, this fix doesn't work on Azure file share (and, probably, on cifs in general) because of a fancy samba behavior - rename of a file fails if the target file is currently opened. Here is a simple repro for this behavior:\r\n\r\n    import os\r\n    f = open('target.txt', 'r')\r\n    os.rename('source.txt', 'target.txt')\r\n\r\n    Traceback (most recent call last):\r\n    PermissionError: [Errno 13] Permission denied: 'source.txt' -> 'target.txt'\r\n\r\n"}