{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/151276813", "pull_request_review_id": 76957269, "id": 151276813, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1MTI3NjgxMw==", "diff_hunk": "@@ -0,0 +1,195 @@\n+/* Copyright 2017 The TensorFlow Authors. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+// See docs in ../ops/math_ops.cc.\n+\n+// This file uses MKL CBLAS batched xGEMM for acceleration of TF Batch\n+// Matrix-Matrix Multiplication (MatMul) operations.\n+// We currently register this kernel only for MKL supported data\n+// types (float, double, complex64, complex128). The macro INTEL_MKL is defined\n+// by the build system only when MKL is chosen as an option at configure stage\n+// and when it is undefined at build time, this file becomes an empty\n+// compilation unit\n+\n+#define EIGEN_USE_THREADS\n+\n+#if defined(INTEL_MKL)\n+#include <vector>\n+#include \"mkl_cblas.h\"\n+#include \"tensorflow/core/framework/op.h\"\n+#include \"tensorflow/core/framework/op_kernel.h\"\n+#include \"tensorflow/core/framework/register_types.h\"\n+#include \"tensorflow/core/framework/tensor.h\"\n+#include \"tensorflow/core/framework/tensor_shape.h\"\n+#include \"tensorflow/core/framework/type_traits.h\"\n+#include \"tensorflow/core/framework/types.h\"\n+#include \"tensorflow/core/kernels/fill_functor.h\"\n+#include \"tensorflow/core/platform/logging.h\"\n+#include \"tensorflow/core/platform/types.h\"\n+#include \"third_party/eigen3/unsupported/Eigen/CXX11/Tensor\"\n+\n+namespace tensorflow {\n+\n+typedef Eigen::ThreadPoolDevice CPUDevice;\n+\n+template <typename Device, typename Scalar>\n+class BatchMatMulMkl : public OpKernel {\n+ public:\n+  explicit BatchMatMulMkl(OpKernelConstruction *context) : OpKernel(context) {\n+    OP_REQUIRES_OK(context, context->GetAttr(\"adj_x\", &adj_x_));\n+    OP_REQUIRES_OK(context, context->GetAttr(\"adj_y\", &adj_y_));\n+  }\n+\n+  virtual ~BatchMatMulMkl() {}\n+\n+  void Compute(OpKernelContext *ctx) override {\n+    const Tensor &in0 = ctx->input(0);\n+    const Tensor &in1 = ctx->input(1);\n+    OP_REQUIRES(ctx, in0.dims() == in1.dims(),\n+                errors::InvalidArgument(\"In[0] and In[1] has different ndims: \",\n+                                        in0.shape().DebugString(), \" vs. \",\n+                                        in1.shape().DebugString()));\n+    const int ndims = in0.dims();\n+    OP_REQUIRES(\n+        ctx, ndims >= 2,\n+        errors::InvalidArgument(\"In[0] and In[1] ndims must be >= 2: \", ndims));\n+    TensorShape out_shape;\n+    for (int i = 0; i < ndims - 2; ++i) {\n+      OP_REQUIRES(ctx, in0.dim_size(i) == in1.dim_size(i),\n+                  errors::InvalidArgument(\"In[0].dim(\", i, \") and In[1].dim(\",\n+                                          i, \") must be the same: \",\n+                                          in0.shape().DebugString(), \" vs \",\n+                                          in1.shape().DebugString()));\n+      out_shape.AddDim(in0.dim_size(i));\n+    }\n+    auto n = (ndims == 2) ? 1 : out_shape.num_elements();\n+    auto d0 = in0.dim_size(ndims - 2);", "path": "tensorflow/core/kernels/mkl_batch_matmul_op.cc", "position": null, "original_position": 78, "commit_id": "582822d5596985b4b6497acec2850a71b5e4239f", "original_commit_id": "83d8cd8624598b4f61a03f7bcc68949e263411dd", "user": {"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}, "body": "s/d0/lhs_rows/\r\ns/d0/rhs_cols/", "created_at": "2017-11-15T22:55:25Z", "updated_at": "2017-11-17T22:14:29Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/14335#discussion_r151276813", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/14335", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/151276813"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/14335#discussion_r151276813"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/14335"}}, "body_html": "<p>s/d0/lhs_rows/<br>\ns/d0/rhs_cols/</p>", "body_text": "s/d0/lhs_rows/\ns/d0/rhs_cols/"}