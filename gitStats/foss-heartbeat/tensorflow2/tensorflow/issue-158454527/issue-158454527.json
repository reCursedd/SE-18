{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/2646", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/2646/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/2646/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/2646/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/2646", "id": 158454527, "node_id": "MDU6SXNzdWUxNTg0NTQ1Mjc=", "number": 2646, "title": "Segfaults due to protobuf -std=c++11 mismatch", "user": {"login": "llchan", "id": 51099, "node_id": "MDQ6VXNlcjUxMDk5", "avatar_url": "https://avatars2.githubusercontent.com/u/51099?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llchan", "html_url": "https://github.com/llchan", "followers_url": "https://api.github.com/users/llchan/followers", "following_url": "https://api.github.com/users/llchan/following{/other_user}", "gists_url": "https://api.github.com/users/llchan/gists{/gist_id}", "starred_url": "https://api.github.com/users/llchan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llchan/subscriptions", "organizations_url": "https://api.github.com/users/llchan/orgs", "repos_url": "https://api.github.com/users/llchan/repos", "events_url": "https://api.github.com/users/llchan/events{/privacy}", "received_events_url": "https://api.github.com/users/llchan/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "keveman", "id": 229914, "node_id": "MDQ6VXNlcjIyOTkxNA==", "avatar_url": "https://avatars1.githubusercontent.com/u/229914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/keveman", "html_url": "https://github.com/keveman", "followers_url": "https://api.github.com/users/keveman/followers", "following_url": "https://api.github.com/users/keveman/following{/other_user}", "gists_url": "https://api.github.com/users/keveman/gists{/gist_id}", "starred_url": "https://api.github.com/users/keveman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/keveman/subscriptions", "organizations_url": "https://api.github.com/users/keveman/orgs", "repos_url": "https://api.github.com/users/keveman/repos", "events_url": "https://api.github.com/users/keveman/events{/privacy}", "received_events_url": "https://api.github.com/users/keveman/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "keveman", "id": 229914, "node_id": "MDQ6VXNlcjIyOTkxNA==", "avatar_url": "https://avatars1.githubusercontent.com/u/229914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/keveman", "html_url": "https://github.com/keveman", "followers_url": "https://api.github.com/users/keveman/followers", "following_url": "https://api.github.com/users/keveman/following{/other_user}", "gists_url": "https://api.github.com/users/keveman/gists{/gist_id}", "starred_url": "https://api.github.com/users/keveman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/keveman/subscriptions", "organizations_url": "https://api.github.com/users/keveman/orgs", "repos_url": "https://api.github.com/users/keveman/repos", "events_url": "https://api.github.com/users/keveman/events{/privacy}", "received_events_url": "https://api.github.com/users/keveman/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 12, "created_at": "2016-06-03T21:04:57Z", "updated_at": "2016-06-09T17:03:50Z", "closed_at": "2016-06-09T17:03:49Z", "author_association": "NONE", "body_html": "<p>I was seeing segfaults in <code>std::unordered_map</code>, and the symptoms looked like potential memory corruption.  Took a fair amount of digging in gdb to figure out that it wasn't that, but was just a build/library version issue:</p>\n<ul>\n<li>tensorflow's embedded protobuf is built with <code>-std=c++11</code></li>\n<li>a default protobuf build is built without <code>-std=c++11</code></li>\n</ul>\n<p>I'm not super familar with the details of dlopen and symbol resolution, but the <code>RTLD_GLOBAL</code> when it loads <code>_pywrap_tensorflow.so</code> might be causing it to shadow the symbols in <code>libprotobuf.so</code> (for the cpp-enabled protobuf python package).  The C++11 vs non-C++11 libraries use different headers for <code>std::unordered_map</code> (in bits vs tr1), and things blow up when they start using the wrong library's version of the code.  (Correct me if my understanding of RTLD_GLOBAL is wrong and that's irrelevant).</p>\n<p>In any case, building protobuf with C++11 fixed the segfaults I was seeing.</p>\n<p>Now as for solutions, here are some ideas:</p>\n<ul>\n<li>Allow tensorflow to link to an external libprotobuf.so.  This is probably the best solution, since then only one protobuf library is loaded at runtime, and a version check is probably simple to add.</li>\n<li>If RTLD_GLOBAL is a relevant factor, maybe _pywrap_tensorflow.so can be split up and only the parts that actually need to be global can be global.  Or maybe some gcc attributes to control visibility can do the trick.</li>\n<li>Maybe we can shove the embedded protobuf into a namespace so the symbols don't collide</li>\n</ul>\n<p>Possibly useful info to reproduce:</p>\n<ul>\n<li>gcc-4.8.x</li>\n<li>libstdc++.so.6.0.19</li>\n<li>r0.8 branch</li>\n</ul>\n<p>I've seen some other people post about similar segfault issues and I suspect many of them might be related to this.</p>\n<p>Also now that I've found the issue, it seems obvious in retrospect, and a related issue on the protobuf issues is <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"108989001\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/protocolbuffers/protobuf/issues/839\" data-hovercard-type=\"issue\" data-hovercard-url=\"/protocolbuffers/protobuf/issues/839/hovercard\" href=\"https://github.com/protocolbuffers/protobuf/issues/839\">protocolbuffers/protobuf#839</a>.</p>", "body_text": "I was seeing segfaults in std::unordered_map, and the symptoms looked like potential memory corruption.  Took a fair amount of digging in gdb to figure out that it wasn't that, but was just a build/library version issue:\n\ntensorflow's embedded protobuf is built with -std=c++11\na default protobuf build is built without -std=c++11\n\nI'm not super familar with the details of dlopen and symbol resolution, but the RTLD_GLOBAL when it loads _pywrap_tensorflow.so might be causing it to shadow the symbols in libprotobuf.so (for the cpp-enabled protobuf python package).  The C++11 vs non-C++11 libraries use different headers for std::unordered_map (in bits vs tr1), and things blow up when they start using the wrong library's version of the code.  (Correct me if my understanding of RTLD_GLOBAL is wrong and that's irrelevant).\nIn any case, building protobuf with C++11 fixed the segfaults I was seeing.\nNow as for solutions, here are some ideas:\n\nAllow tensorflow to link to an external libprotobuf.so.  This is probably the best solution, since then only one protobuf library is loaded at runtime, and a version check is probably simple to add.\nIf RTLD_GLOBAL is a relevant factor, maybe _pywrap_tensorflow.so can be split up and only the parts that actually need to be global can be global.  Or maybe some gcc attributes to control visibility can do the trick.\nMaybe we can shove the embedded protobuf into a namespace so the symbols don't collide\n\nPossibly useful info to reproduce:\n\ngcc-4.8.x\nlibstdc++.so.6.0.19\nr0.8 branch\n\nI've seen some other people post about similar segfault issues and I suspect many of them might be related to this.\nAlso now that I've found the issue, it seems obvious in retrospect, and a related issue on the protobuf issues is protocolbuffers/protobuf#839.", "body": "I was seeing segfaults in `std::unordered_map`, and the symptoms looked like potential memory corruption.  Took a fair amount of digging in gdb to figure out that it wasn't that, but was just a build/library version issue:\n- tensorflow's embedded protobuf is built with `-std=c++11`\n- a default protobuf build is built without `-std=c++11`\n\nI'm not super familar with the details of dlopen and symbol resolution, but the `RTLD_GLOBAL` when it loads `_pywrap_tensorflow.so` might be causing it to shadow the symbols in `libprotobuf.so` (for the cpp-enabled protobuf python package).  The C++11 vs non-C++11 libraries use different headers for `std::unordered_map` (in bits vs tr1), and things blow up when they start using the wrong library's version of the code.  (Correct me if my understanding of RTLD_GLOBAL is wrong and that's irrelevant).\n\nIn any case, building protobuf with C++11 fixed the segfaults I was seeing.\n\nNow as for solutions, here are some ideas:\n- Allow tensorflow to link to an external libprotobuf.so.  This is probably the best solution, since then only one protobuf library is loaded at runtime, and a version check is probably simple to add.\n- If RTLD_GLOBAL is a relevant factor, maybe _pywrap_tensorflow.so can be split up and only the parts that actually need to be global can be global.  Or maybe some gcc attributes to control visibility can do the trick.\n- Maybe we can shove the embedded protobuf into a namespace so the symbols don't collide\n\nPossibly useful info to reproduce:\n- gcc-4.8.x\n- libstdc++.so.6.0.19\n- r0.8 branch\n\nI've seen some other people post about similar segfault issues and I suspect many of them might be related to this.\n\nAlso now that I've found the issue, it seems obvious in retrospect, and a related issue on the protobuf issues is https://github.com/google/protobuf/issues/839.\n"}