{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21337", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21337/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21337/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21337/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21337", "id": 346934352, "node_id": "MDU6SXNzdWUzNDY5MzQzNTI=", "number": 21337, "title": "Problem with softmax on Windows OS", "user": {"login": "Windaway", "id": 4530735, "node_id": "MDQ6VXNlcjQ1MzA3MzU=", "avatar_url": "https://avatars0.githubusercontent.com/u/4530735?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Windaway", "html_url": "https://github.com/Windaway", "followers_url": "https://api.github.com/users/Windaway/followers", "following_url": "https://api.github.com/users/Windaway/following{/other_user}", "gists_url": "https://api.github.com/users/Windaway/gists{/gist_id}", "starred_url": "https://api.github.com/users/Windaway/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Windaway/subscriptions", "organizations_url": "https://api.github.com/users/Windaway/orgs", "repos_url": "https://api.github.com/users/Windaway/repos", "events_url": "https://api.github.com/users/Windaway/events{/privacy}", "received_events_url": "https://api.github.com/users/Windaway/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": {"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-08-02T09:36:48Z", "updated_at": "2018-11-20T13:29:44Z", "closed_at": null, "author_association": "NONE", "body_html": "<hr>\n<h3>System information</h3>\n<p>Windows 10 x64 pro 17314.365, i5 6600k, Z170(clevo), GTX1070(notebook), 16G DDR4 2400 Dual Channel .<br>\nTensorflow 1.9.0 with AVX2 simd, CUDA9.2.148, Cudnn7.1.4, py3.6.6 , VS2017 15.7(with cmake), CP/SM6.1<br>\nTensorflow 1.9.0 offical, CUDA9.0, Cudnn7.05, py3.6.6</p>\n<h3>Describe the problem</h3>\n<p>softmax_cross_entropy_with_logits or softmax_cross_entropy_with_logits_v2 can not be computed on GPU, but sparse_softmax_cross_entropy_with_logits can be computed on GPU. I could add with device cpu to solve the problem. But it seems simlar to <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"274206483\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/models/issues/2803\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/models/issues/2803/hovercard\" href=\"https://github.com/tensorflow/models/issues/2803\">tensorflow/models#2803</a>.<br>\nThe problem may be with softmax kernel, and allow_soft_placement will also solve?</p>\n<h3>Source code / logs</h3>\n<p><a href=\"https://github.com/golbin/TensorFlow-Multi-GPUs/blob/master/many-GPUs-MNIST.py\">https://github.com/golbin/TensorFlow-Multi-GPUs/blob/master/many-GPUs-MNIST.py</a><br>\n`import datetime</p>\n<p>import tensorflow as tf<br>\nfrom tensorflow.examples.tutorials.mnist import input_data<br>\nfrom tensorflow.python.client import device_lib</p>\n<p>def check_available_gpus():<br>\nlocal_devices = device_lib.list_local_devices()<br>\ngpu_names = [x.name for x in local_devices if x.device_type == 'GPU']<br>\ngpu_num = len(gpu_names)</p>\n<pre><code>print('{0} GPUs are detected : {1}'.format(gpu_num, gpu_names))\n\nreturn gpu_num\n</code></pre>\n<p>def model(X, reuse=False):<br>\nwith tf.variable_scope('L1', reuse=reuse):<br>\nL1 = tf.layers.conv2d(X, 64, [3, 3], reuse=reuse)<br>\nL1 = tf.layers.max_pooling2d(L1, [2, 2], [2, 2])<br>\nL1 = tf.layers.dropout(L1, 0.7, True)</p>\n<pre><code>with tf.variable_scope('L2', reuse=reuse):\n    L2 = tf.layers.conv2d(L1, 128, [3, 3], reuse=reuse)\n    L2 = tf.layers.max_pooling2d(L2, [2, 2], [2, 2])\n    L2 = tf.layers.dropout(L2, 0.7, True)\n\nwith tf.variable_scope('L2-1', reuse=reuse):\n    L2_1 = tf.layers.conv2d(L2, 128, [3, 3], reuse=reuse)\n    L2_1 = tf.layers.max_pooling2d(L2_1, [2, 2], [2, 2])\n    L2_1 = tf.layers.dropout(L2_1, 0.7, True)\n\nwith tf.variable_scope('L3', reuse=reuse):\n    L3 = tf.contrib.layers.flatten(L2_1)\n    L3 = tf.layers.dense(L3, 1024, activation=tf.nn.relu)\n    L3 = tf.layers.dropout(L3, 0.5, True)\n\nwith tf.variable_scope('L4', reuse=reuse):\n    L4 = tf.layers.dense(L3, 256, activation=tf.nn.relu)\n\nwith tf.variable_scope('LF', reuse=reuse):\n    LF = tf.layers.dense(L4, 10, activation=None)\n\nreturn LF\n</code></pre>\n<p>if <strong>name</strong> == '<strong>main</strong>':<br>\n# need to change learning rates and batch size by number of GPU<br>\nbatch_size = 10000<br>\nlearning_rate = 0.001<br>\ntotal_epoch = 10</p>\n<pre><code>gpu_num = check_available_gpus()\n\nX = tf.placeholder(tf.float32, [None, 28, 28, 1])\nY = tf.placeholder(tf.float32, [None, 10])\n\nlosses = []\nX_A = tf.split(X, int(gpu_num))\nY_A = tf.split(Y, int(gpu_num))\n\n'''\nMulti GPUs Usage\nResults on P40\n * Single GPU computation time: 0:00:22.252533\n * 2 GPU computation time: 0:00:12.632623\n * 4 GPU computation time: 0:00:11.083071\n * 8 GPU computation time: 0:00:11.990167\n \nNeed to change batch size and learning rates\n     for training more efficiently\n\nReference: https://research.fb.com/wp-content/uploads/2017/06/imagenet1kin1h5.pdf\n'''\nfor gpu_id in range(int(gpu_num)):\n    with tf.device(tf.DeviceSpec(device_type=\"GPU\", device_index=gpu_id)):\n        with tf.variable_scope(tf.get_variable_scope(), reuse=(gpu_id &gt; 0)):\n            cost = tf.nn.softmax_cross_entropy_with_logits(\n                            logits=model(X_A[gpu_id], gpu_id &gt; 0),\n                            labels=Y_A[gpu_id])\n            losses.append(cost)\n\nloss = tf.reduce_mean(tf.concat(losses, axis=0))\n\noptimizer = tf.train.AdamOptimizer(learning_rate).minimize(\n    loss, colocate_gradients_with_ops=True)  # Important!\n\ninit = tf.global_variables_initializer()\nsess = tf.Session(config=tf.ConfigProto(log_device_placement=False))\nsess.run(init)\n\nmnist = input_data.read_data_sets('/tmp/tensorflow/mnist/input_data', one_hot=True)\ntotal_batch = int(mnist.train.num_examples/batch_size)\nprint(\"total: %s, %s, %s\" % (mnist.train.num_examples, total_batch, batch_size))\n\nstart_time = datetime.datetime.now()\n\nfor epoch in range(total_epoch):\n    total_cost = 0\n\n    for i in range(total_batch):\n        batch_xs, batch_ys = mnist.train.next_batch(batch_size)\n        batch_xs = batch_xs.reshape(-1, 28, 28, 1)\n        _, cost_val = sess.run([optimizer, loss],\n                               feed_dict={X: batch_xs,\n                                          Y: batch_ys})\n        total_cost += cost_val\n\n    print(\"total cost : %s\" % total_cost)\n\nprint(\"--- Training time : {0} seconds /w {1} GPUs ---\".format(\n    datetime.datetime.now() - start_time, gpu_num))`\n</code></pre>\n<p>Logs:</p>\n<p>`F:\\Anaconda3\\envs\\tf\\python.exe F:/ODT/Leaf/leafmg.py<br>\n1.9.0<br>\n2018-08-02 17:25:58.253241: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1392] Found device 0 with properties:<br>\nname: GeForce GTX 1070 major: 6 minor: 1 memoryClockRate(GHz): 1.645<br>\npciBusID: 0000:01:00.0<br>\ntotalMemory: 8.00GiB freeMemory: 6.62GiB<br>\n2018-08-02 17:25:58.253526: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1471] Adding visible gpu devices: 0<br>\n2018-08-02 17:26:43.721732: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:952] Device interconnect StreamExecutor with strength 1 edge matrix:<br>\n2018-08-02 17:26:43.721924: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:958]      0<br>\n2018-08-02 17:26:43.722057: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:971] 0:   N<br>\n2018-08-02 17:26:43.722281: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1084] Created TensorFlow device (/device:GPU:0 with 6394 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)<br>\n1 GPUs are detected : ['/device:GPU:0']<br>\nWARNING:tensorflow:From F:/ODT/Leaf/leafmg.py:81: softmax_cross_entropy_with_logits (from tensorflow.python.ops.nn_ops) is deprecated and will be removed in a future version.<br>\nInstructions for updating:</p>\n<p>Future major versions of TensorFlow will allow gradients to flow<br>\ninto the labels input on backprop by default.</p>\n<p>See @{tf.nn.softmax_cross_entropy_with_logits_v2}.</p>\n<p>2018-08-02 17:26:44.358873: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1471] Adding visible gpu devices: 0<br>\n2018-08-02 17:26:44.359084: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:952] Device interconnect StreamExecutor with strength 1 edge matrix:<br>\n2018-08-02 17:26:44.359266: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:958]      0<br>\n2018-08-02 17:26:44.359392: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:971] 0:   N<br>\n2018-08-02 17:26:44.359563: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1084] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 6394 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)<br>\nTraceback (most recent call last):<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1322, in _do_call<br>\nreturn fn(*args)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1305, in _run_fn<br>\nself._extend_graph()<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1340, in _extend_graph<br>\ntf_session.ExtendSession(self._session)<br>\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.<br>\nColocation Debug Info:<br>\nColocation group had the following types and devices:<br>\nSoftmaxCrossEntropyWithLogits: GPU CPU<br>\nIdentity: GPU CPU<br>\nZerosLike: CPU<br>\nConst: GPU CPU<br>\nExpandDims: GPU CPU<br>\nNeg: GPU CPU<br>\nMul: GPU CPU<br>\nLogSoftmax: CPU</p>\n<p>Colocation members and user-requested devices:<br>\nsoftmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0<br>\ngradients/zeros_like (ZerosLike) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0</p>\n<p>Registered kernels:<br>\ndevice='CPU'; T in [DT_HALF]<br>\ndevice='CPU'; T in [DT_FLOAT]<br>\ndevice='CPU'; T in [DT_DOUBLE]<br>\ndevice='GPU'; T in [DT_HALF]<br>\ndevice='GPU'; T in [DT_FLOAT]<br>\ndevice='GPU'; T in [DT_DOUBLE]</p>\n<pre><code> [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\n</code></pre>\n<p>During handling of the above exception, another exception occurred:</p>\n<p>Traceback (most recent call last):<br>\nFile \"F:/ODT/Leaf/leafmg.py\", line 91, in <br>\nsess.run(init)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 900, in run<br>\nrun_metadata_ptr)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1135, in _run<br>\nfeed_dict_tensor, options, run_metadata)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1316, in _do_run<br>\nrun_metadata)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1335, in _do_call<br>\nraise type(e)(node_def, op, message)<br>\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.<br>\nColocation Debug Info:<br>\nColocation group had the following types and devices:<br>\nSoftmaxCrossEntropyWithLogits: GPU CPU<br>\nIdentity: GPU CPU<br>\nZerosLike: CPU<br>\nConst: GPU CPU<br>\nExpandDims: GPU CPU<br>\nNeg: GPU CPU<br>\nMul: GPU CPU<br>\nLogSoftmax: CPU</p>\n<p>Colocation members and user-requested devices:<br>\nsoftmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0<br>\ngradients/zeros_like (ZerosLike) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0</p>\n<p>Registered kernels:<br>\ndevice='CPU'; T in [DT_HALF]<br>\ndevice='CPU'; T in [DT_FLOAT]<br>\ndevice='CPU'; T in [DT_DOUBLE]<br>\ndevice='GPU'; T in [DT_HALF]<br>\ndevice='GPU'; T in [DT_FLOAT]<br>\ndevice='GPU'; T in [DT_DOUBLE]</p>\n<pre><code> [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\n</code></pre>\n<p>Caused by op 'softmax_cross_entropy_with_logits_sg', defined at:<br>\nFile \"F:/ODT/Leaf/leafmg.py\", line 81, in <br>\nlabels=Y_A[gpu_id])<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\util\\deprecation.py\", line 250, in new_func<br>\nreturn func(*args, **kwargs)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 1968, in softmax_cross_entropy_with_logits<br>\nlabels=labels, logits=logits, dim=dim, name=name)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 1879, in softmax_cross_entropy_with_logits_v2<br>\nprecise_logits, labels, name=name)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\gen_nn_ops.py\", line 7738, in softmax_cross_entropy_with_logits<br>\nname=name)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 787, in _apply_op_helper<br>\nop_def=op_def)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3414, in create_op<br>\nop_def=op_def)<br>\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1740, in <strong>init</strong><br>\nself._traceback = self._graph._extract_stack()  # pylint: disable=protected-access</p>\n<p>InvalidArgumentError (see above for traceback): Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.<br>\nColocation Debug Info:<br>\nColocation group had the following types and devices:<br>\nSoftmaxCrossEntropyWithLogits: GPU CPU<br>\nIdentity: GPU CPU<br>\nZerosLike: CPU<br>\nConst: GPU CPU<br>\nExpandDims: GPU CPU<br>\nNeg: GPU CPU<br>\nMul: GPU CPU<br>\nLogSoftmax: CPU</p>\n<p>Colocation members and user-requested devices:<br>\nsoftmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0<br>\ngradients/zeros_like (ZerosLike) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0<br>\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0</p>\n<p>Registered kernels:<br>\ndevice='CPU'; T in [DT_HALF]<br>\ndevice='CPU'; T in [DT_FLOAT]<br>\ndevice='CPU'; T in [DT_DOUBLE]<br>\ndevice='GPU'; T in [DT_HALF]<br>\ndevice='GPU'; T in [DT_FLOAT]<br>\ndevice='GPU'; T in [DT_DOUBLE]</p>\n<pre><code> [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\n</code></pre>\n<p>Process finished with exit code 1<br>\n`</p>", "body_text": "System information\nWindows 10 x64 pro 17314.365, i5 6600k, Z170(clevo), GTX1070(notebook), 16G DDR4 2400 Dual Channel .\nTensorflow 1.9.0 with AVX2 simd, CUDA9.2.148, Cudnn7.1.4, py3.6.6 , VS2017 15.7(with cmake), CP/SM6.1\nTensorflow 1.9.0 offical, CUDA9.0, Cudnn7.05, py3.6.6\nDescribe the problem\nsoftmax_cross_entropy_with_logits or softmax_cross_entropy_with_logits_v2 can not be computed on GPU, but sparse_softmax_cross_entropy_with_logits can be computed on GPU. I could add with device cpu to solve the problem. But it seems simlar to tensorflow/models#2803.\nThe problem may be with softmax kernel, and allow_soft_placement will also solve?\nSource code / logs\nhttps://github.com/golbin/TensorFlow-Multi-GPUs/blob/master/many-GPUs-MNIST.py\n`import datetime\nimport tensorflow as tf\nfrom tensorflow.examples.tutorials.mnist import input_data\nfrom tensorflow.python.client import device_lib\ndef check_available_gpus():\nlocal_devices = device_lib.list_local_devices()\ngpu_names = [x.name for x in local_devices if x.device_type == 'GPU']\ngpu_num = len(gpu_names)\nprint('{0} GPUs are detected : {1}'.format(gpu_num, gpu_names))\n\nreturn gpu_num\n\ndef model(X, reuse=False):\nwith tf.variable_scope('L1', reuse=reuse):\nL1 = tf.layers.conv2d(X, 64, [3, 3], reuse=reuse)\nL1 = tf.layers.max_pooling2d(L1, [2, 2], [2, 2])\nL1 = tf.layers.dropout(L1, 0.7, True)\nwith tf.variable_scope('L2', reuse=reuse):\n    L2 = tf.layers.conv2d(L1, 128, [3, 3], reuse=reuse)\n    L2 = tf.layers.max_pooling2d(L2, [2, 2], [2, 2])\n    L2 = tf.layers.dropout(L2, 0.7, True)\n\nwith tf.variable_scope('L2-1', reuse=reuse):\n    L2_1 = tf.layers.conv2d(L2, 128, [3, 3], reuse=reuse)\n    L2_1 = tf.layers.max_pooling2d(L2_1, [2, 2], [2, 2])\n    L2_1 = tf.layers.dropout(L2_1, 0.7, True)\n\nwith tf.variable_scope('L3', reuse=reuse):\n    L3 = tf.contrib.layers.flatten(L2_1)\n    L3 = tf.layers.dense(L3, 1024, activation=tf.nn.relu)\n    L3 = tf.layers.dropout(L3, 0.5, True)\n\nwith tf.variable_scope('L4', reuse=reuse):\n    L4 = tf.layers.dense(L3, 256, activation=tf.nn.relu)\n\nwith tf.variable_scope('LF', reuse=reuse):\n    LF = tf.layers.dense(L4, 10, activation=None)\n\nreturn LF\n\nif name == 'main':\n# need to change learning rates and batch size by number of GPU\nbatch_size = 10000\nlearning_rate = 0.001\ntotal_epoch = 10\ngpu_num = check_available_gpus()\n\nX = tf.placeholder(tf.float32, [None, 28, 28, 1])\nY = tf.placeholder(tf.float32, [None, 10])\n\nlosses = []\nX_A = tf.split(X, int(gpu_num))\nY_A = tf.split(Y, int(gpu_num))\n\n'''\nMulti GPUs Usage\nResults on P40\n * Single GPU computation time: 0:00:22.252533\n * 2 GPU computation time: 0:00:12.632623\n * 4 GPU computation time: 0:00:11.083071\n * 8 GPU computation time: 0:00:11.990167\n \nNeed to change batch size and learning rates\n     for training more efficiently\n\nReference: https://research.fb.com/wp-content/uploads/2017/06/imagenet1kin1h5.pdf\n'''\nfor gpu_id in range(int(gpu_num)):\n    with tf.device(tf.DeviceSpec(device_type=\"GPU\", device_index=gpu_id)):\n        with tf.variable_scope(tf.get_variable_scope(), reuse=(gpu_id > 0)):\n            cost = tf.nn.softmax_cross_entropy_with_logits(\n                            logits=model(X_A[gpu_id], gpu_id > 0),\n                            labels=Y_A[gpu_id])\n            losses.append(cost)\n\nloss = tf.reduce_mean(tf.concat(losses, axis=0))\n\noptimizer = tf.train.AdamOptimizer(learning_rate).minimize(\n    loss, colocate_gradients_with_ops=True)  # Important!\n\ninit = tf.global_variables_initializer()\nsess = tf.Session(config=tf.ConfigProto(log_device_placement=False))\nsess.run(init)\n\nmnist = input_data.read_data_sets('/tmp/tensorflow/mnist/input_data', one_hot=True)\ntotal_batch = int(mnist.train.num_examples/batch_size)\nprint(\"total: %s, %s, %s\" % (mnist.train.num_examples, total_batch, batch_size))\n\nstart_time = datetime.datetime.now()\n\nfor epoch in range(total_epoch):\n    total_cost = 0\n\n    for i in range(total_batch):\n        batch_xs, batch_ys = mnist.train.next_batch(batch_size)\n        batch_xs = batch_xs.reshape(-1, 28, 28, 1)\n        _, cost_val = sess.run([optimizer, loss],\n                               feed_dict={X: batch_xs,\n                                          Y: batch_ys})\n        total_cost += cost_val\n\n    print(\"total cost : %s\" % total_cost)\n\nprint(\"--- Training time : {0} seconds /w {1} GPUs ---\".format(\n    datetime.datetime.now() - start_time, gpu_num))`\n\nLogs:\n`F:\\Anaconda3\\envs\\tf\\python.exe F:/ODT/Leaf/leafmg.py\n1.9.0\n2018-08-02 17:25:58.253241: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1392] Found device 0 with properties:\nname: GeForce GTX 1070 major: 6 minor: 1 memoryClockRate(GHz): 1.645\npciBusID: 0000:01:00.0\ntotalMemory: 8.00GiB freeMemory: 6.62GiB\n2018-08-02 17:25:58.253526: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1471] Adding visible gpu devices: 0\n2018-08-02 17:26:43.721732: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:952] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-02 17:26:43.721924: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:958]      0\n2018-08-02 17:26:43.722057: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:971] 0:   N\n2018-08-02 17:26:43.722281: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1084] Created TensorFlow device (/device:GPU:0 with 6394 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)\n1 GPUs are detected : ['/device:GPU:0']\nWARNING:tensorflow:From F:/ODT/Leaf/leafmg.py:81: softmax_cross_entropy_with_logits (from tensorflow.python.ops.nn_ops) is deprecated and will be removed in a future version.\nInstructions for updating:\nFuture major versions of TensorFlow will allow gradients to flow\ninto the labels input on backprop by default.\nSee @{tf.nn.softmax_cross_entropy_with_logits_v2}.\n2018-08-02 17:26:44.358873: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1471] Adding visible gpu devices: 0\n2018-08-02 17:26:44.359084: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:952] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-02 17:26:44.359266: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:958]      0\n2018-08-02 17:26:44.359392: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:971] 0:   N\n2018-08-02 17:26:44.359563: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1084] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 6394 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)\nTraceback (most recent call last):\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1322, in _do_call\nreturn fn(*args)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1305, in _run_fn\nself._extend_graph()\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1340, in _extend_graph\ntf_session.ExtendSession(self._session)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices:\nSoftmaxCrossEntropyWithLogits: GPU CPU\nIdentity: GPU CPU\nZerosLike: CPU\nConst: GPU CPU\nExpandDims: GPU CPU\nNeg: GPU CPU\nMul: GPU CPU\nLogSoftmax: CPU\nColocation members and user-requested devices:\nsoftmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0\ngradients/zeros_like (ZerosLike) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0\nRegistered kernels:\ndevice='CPU'; T in [DT_HALF]\ndevice='CPU'; T in [DT_FLOAT]\ndevice='CPU'; T in [DT_DOUBLE]\ndevice='GPU'; T in [DT_HALF]\ndevice='GPU'; T in [DT_FLOAT]\ndevice='GPU'; T in [DT_DOUBLE]\n [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\n\nDuring handling of the above exception, another exception occurred:\nTraceback (most recent call last):\nFile \"F:/ODT/Leaf/leafmg.py\", line 91, in \nsess.run(init)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 900, in run\nrun_metadata_ptr)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1135, in _run\nfeed_dict_tensor, options, run_metadata)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1316, in _do_run\nrun_metadata)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1335, in _do_call\nraise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices:\nSoftmaxCrossEntropyWithLogits: GPU CPU\nIdentity: GPU CPU\nZerosLike: CPU\nConst: GPU CPU\nExpandDims: GPU CPU\nNeg: GPU CPU\nMul: GPU CPU\nLogSoftmax: CPU\nColocation members and user-requested devices:\nsoftmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0\ngradients/zeros_like (ZerosLike) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0\nRegistered kernels:\ndevice='CPU'; T in [DT_HALF]\ndevice='CPU'; T in [DT_FLOAT]\ndevice='CPU'; T in [DT_DOUBLE]\ndevice='GPU'; T in [DT_HALF]\ndevice='GPU'; T in [DT_FLOAT]\ndevice='GPU'; T in [DT_DOUBLE]\n [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\n\nCaused by op 'softmax_cross_entropy_with_logits_sg', defined at:\nFile \"F:/ODT/Leaf/leafmg.py\", line 81, in \nlabels=Y_A[gpu_id])\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\util\\deprecation.py\", line 250, in new_func\nreturn func(*args, **kwargs)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 1968, in softmax_cross_entropy_with_logits\nlabels=labels, logits=logits, dim=dim, name=name)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 1879, in softmax_cross_entropy_with_logits_v2\nprecise_logits, labels, name=name)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\gen_nn_ops.py\", line 7738, in softmax_cross_entropy_with_logits\nname=name)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 787, in _apply_op_helper\nop_def=op_def)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3414, in create_op\nop_def=op_def)\nFile \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1740, in init\nself._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\nInvalidArgumentError (see above for traceback): Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices:\nSoftmaxCrossEntropyWithLogits: GPU CPU\nIdentity: GPU CPU\nZerosLike: CPU\nConst: GPU CPU\nExpandDims: GPU CPU\nNeg: GPU CPU\nMul: GPU CPU\nLogSoftmax: CPU\nColocation members and user-requested devices:\nsoftmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0\ngradients/zeros_like (ZerosLike) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0\ngradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0\nRegistered kernels:\ndevice='CPU'; T in [DT_HALF]\ndevice='CPU'; T in [DT_FLOAT]\ndevice='CPU'; T in [DT_DOUBLE]\ndevice='GPU'; T in [DT_HALF]\ndevice='GPU'; T in [DT_FLOAT]\ndevice='GPU'; T in [DT_DOUBLE]\n [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\n\nProcess finished with exit code 1\n`", "body": "------------------------\r\n### System information\r\nWindows 10 x64 pro 17314.365, i5 6600k, Z170(clevo), GTX1070(notebook), 16G DDR4 2400 Dual Channel .\r\nTensorflow 1.9.0 with AVX2 simd, CUDA9.2.148, Cudnn7.1.4, py3.6.6 , VS2017 15.7(with cmake), CP/SM6.1\r\nTensorflow 1.9.0 offical, CUDA9.0, Cudnn7.05, py3.6.6\r\n\r\n### Describe the problem\r\nsoftmax_cross_entropy_with_logits or softmax_cross_entropy_with_logits_v2 can not be computed on GPU, but sparse_softmax_cross_entropy_with_logits can be computed on GPU. I could add with device cpu to solve the problem. But it seems simlar to https://github.com/tensorflow/models/issues/2803.\r\nThe problem may be with softmax kernel, and allow_soft_placement will also solve? \r\n\r\n\r\n### Source code / logs\r\nhttps://github.com/golbin/TensorFlow-Multi-GPUs/blob/master/many-GPUs-MNIST.py\r\n`import datetime\r\n\r\nimport tensorflow as tf\r\nfrom tensorflow.examples.tutorials.mnist import input_data\r\nfrom tensorflow.python.client import device_lib\r\n\r\n\r\ndef check_available_gpus():\r\n    local_devices = device_lib.list_local_devices()\r\n    gpu_names = [x.name for x in local_devices if x.device_type == 'GPU']\r\n    gpu_num = len(gpu_names)\r\n\r\n    print('{0} GPUs are detected : {1}'.format(gpu_num, gpu_names))\r\n\r\n    return gpu_num\r\n\r\n\r\ndef model(X, reuse=False):\r\n    with tf.variable_scope('L1', reuse=reuse):\r\n        L1 = tf.layers.conv2d(X, 64, [3, 3], reuse=reuse)\r\n        L1 = tf.layers.max_pooling2d(L1, [2, 2], [2, 2])\r\n        L1 = tf.layers.dropout(L1, 0.7, True)\r\n\r\n    with tf.variable_scope('L2', reuse=reuse):\r\n        L2 = tf.layers.conv2d(L1, 128, [3, 3], reuse=reuse)\r\n        L2 = tf.layers.max_pooling2d(L2, [2, 2], [2, 2])\r\n        L2 = tf.layers.dropout(L2, 0.7, True)\r\n\r\n    with tf.variable_scope('L2-1', reuse=reuse):\r\n        L2_1 = tf.layers.conv2d(L2, 128, [3, 3], reuse=reuse)\r\n        L2_1 = tf.layers.max_pooling2d(L2_1, [2, 2], [2, 2])\r\n        L2_1 = tf.layers.dropout(L2_1, 0.7, True)\r\n\r\n    with tf.variable_scope('L3', reuse=reuse):\r\n        L3 = tf.contrib.layers.flatten(L2_1)\r\n        L3 = tf.layers.dense(L3, 1024, activation=tf.nn.relu)\r\n        L3 = tf.layers.dropout(L3, 0.5, True)\r\n\r\n    with tf.variable_scope('L4', reuse=reuse):\r\n        L4 = tf.layers.dense(L3, 256, activation=tf.nn.relu)\r\n\r\n    with tf.variable_scope('LF', reuse=reuse):\r\n        LF = tf.layers.dense(L4, 10, activation=None)\r\n\r\n    return LF\r\n\r\n\r\nif __name__ == '__main__':\r\n    # need to change learning rates and batch size by number of GPU\r\n    batch_size = 10000\r\n    learning_rate = 0.001\r\n    total_epoch = 10\r\n\r\n    gpu_num = check_available_gpus()\r\n\r\n    X = tf.placeholder(tf.float32, [None, 28, 28, 1])\r\n    Y = tf.placeholder(tf.float32, [None, 10])\r\n\r\n    losses = []\r\n    X_A = tf.split(X, int(gpu_num))\r\n    Y_A = tf.split(Y, int(gpu_num))\r\n\r\n    '''\r\n    Multi GPUs Usage\r\n    Results on P40\r\n     * Single GPU computation time: 0:00:22.252533\r\n     * 2 GPU computation time: 0:00:12.632623\r\n     * 4 GPU computation time: 0:00:11.083071\r\n     * 8 GPU computation time: 0:00:11.990167\r\n     \r\n    Need to change batch size and learning rates\r\n         for training more efficiently\r\n    \r\n    Reference: https://research.fb.com/wp-content/uploads/2017/06/imagenet1kin1h5.pdf\r\n    '''\r\n    for gpu_id in range(int(gpu_num)):\r\n        with tf.device(tf.DeviceSpec(device_type=\"GPU\", device_index=gpu_id)):\r\n            with tf.variable_scope(tf.get_variable_scope(), reuse=(gpu_id > 0)):\r\n                cost = tf.nn.softmax_cross_entropy_with_logits(\r\n                                logits=model(X_A[gpu_id], gpu_id > 0),\r\n                                labels=Y_A[gpu_id])\r\n                losses.append(cost)\r\n\r\n    loss = tf.reduce_mean(tf.concat(losses, axis=0))\r\n\r\n    optimizer = tf.train.AdamOptimizer(learning_rate).minimize(\r\n        loss, colocate_gradients_with_ops=True)  # Important!\r\n\r\n    init = tf.global_variables_initializer()\r\n    sess = tf.Session(config=tf.ConfigProto(log_device_placement=False))\r\n    sess.run(init)\r\n\r\n    mnist = input_data.read_data_sets('/tmp/tensorflow/mnist/input_data', one_hot=True)\r\n    total_batch = int(mnist.train.num_examples/batch_size)\r\n    print(\"total: %s, %s, %s\" % (mnist.train.num_examples, total_batch, batch_size))\r\n\r\n    start_time = datetime.datetime.now()\r\n\r\n    for epoch in range(total_epoch):\r\n        total_cost = 0\r\n\r\n        for i in range(total_batch):\r\n            batch_xs, batch_ys = mnist.train.next_batch(batch_size)\r\n            batch_xs = batch_xs.reshape(-1, 28, 28, 1)\r\n            _, cost_val = sess.run([optimizer, loss],\r\n                                   feed_dict={X: batch_xs,\r\n                                              Y: batch_ys})\r\n            total_cost += cost_val\r\n\r\n        print(\"total cost : %s\" % total_cost)\r\n\r\n    print(\"--- Training time : {0} seconds /w {1} GPUs ---\".format(\r\n        datetime.datetime.now() - start_time, gpu_num))`\r\n\r\nLogs:\r\n\r\n`F:\\Anaconda3\\envs\\tf\\python.exe F:/ODT/Leaf/leafmg.py\r\n1.9.0\r\n2018-08-02 17:25:58.253241: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1392] Found device 0 with properties: \r\nname: GeForce GTX 1070 major: 6 minor: 1 memoryClockRate(GHz): 1.645\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 8.00GiB freeMemory: 6.62GiB\r\n2018-08-02 17:25:58.253526: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1471] Adding visible gpu devices: 0\r\n2018-08-02 17:26:43.721732: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:952] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-02 17:26:43.721924: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:958]      0 \r\n2018-08-02 17:26:43.722057: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:971] 0:   N \r\n2018-08-02 17:26:43.722281: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1084] Created TensorFlow device (/device:GPU:0 with 6394 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\n1 GPUs are detected : ['/device:GPU:0']\r\nWARNING:tensorflow:From F:/ODT/Leaf/leafmg.py:81: softmax_cross_entropy_with_logits (from tensorflow.python.ops.nn_ops) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\n\r\nFuture major versions of TensorFlow will allow gradients to flow\r\ninto the labels input on backprop by default.\r\n\r\nSee @{tf.nn.softmax_cross_entropy_with_logits_v2}.\r\n\r\n2018-08-02 17:26:44.358873: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1471] Adding visible gpu devices: 0\r\n2018-08-02 17:26:44.359084: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:952] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-02 17:26:44.359266: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:958]      0 \r\n2018-08-02 17:26:44.359392: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:971] 0:   N \r\n2018-08-02 17:26:44.359563: I c:\\users\\user\\source\\repos\\tensorflow\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1084] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 6394 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nTraceback (most recent call last):\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1322, in _do_call\r\n    return fn(*args)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1305, in _run_fn\r\n    self._extend_graph()\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1340, in _extend_graph\r\n    tf_session.ExtendSession(self._session)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nColocation Debug Info:\r\nColocation group had the following types and devices: \r\nSoftmaxCrossEntropyWithLogits: GPU CPU \r\nIdentity: GPU CPU \r\nZerosLike: CPU \r\nConst: GPU CPU \r\nExpandDims: GPU CPU \r\nNeg: GPU CPU \r\nMul: GPU CPU \r\nLogSoftmax: CPU \r\n\r\nColocation members and user-requested devices:\r\n  softmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0\r\n  gradients/zeros_like (ZerosLike) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0\r\n\r\nRegistered kernels:\r\n  device='CPU'; T in [DT_HALF]\r\n  device='CPU'; T in [DT_FLOAT]\r\n  device='CPU'; T in [DT_DOUBLE]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_DOUBLE]\r\n\r\n\t [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"F:/ODT/Leaf/leafmg.py\", line 91, in <module>\r\n    sess.run(init)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 900, in run\r\n    run_metadata_ptr)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1135, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1316, in _do_run\r\n    run_metadata)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1335, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nColocation Debug Info:\r\nColocation group had the following types and devices: \r\nSoftmaxCrossEntropyWithLogits: GPU CPU \r\nIdentity: GPU CPU \r\nZerosLike: CPU \r\nConst: GPU CPU \r\nExpandDims: GPU CPU \r\nNeg: GPU CPU \r\nMul: GPU CPU \r\nLogSoftmax: CPU \r\n\r\nColocation members and user-requested devices:\r\n  softmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0\r\n  gradients/zeros_like (ZerosLike) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0\r\n\r\nRegistered kernels:\r\n  device='CPU'; T in [DT_HALF]\r\n  device='CPU'; T in [DT_FLOAT]\r\n  device='CPU'; T in [DT_DOUBLE]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_DOUBLE]\r\n\r\n\t [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\r\n\r\nCaused by op 'softmax_cross_entropy_with_logits_sg', defined at:\r\n  File \"F:/ODT/Leaf/leafmg.py\", line 81, in <module>\r\n    labels=Y_A[gpu_id])\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\util\\deprecation.py\", line 250, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 1968, in softmax_cross_entropy_with_logits\r\n    labels=labels, logits=logits, dim=dim, name=name)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\nn_ops.py\", line 1879, in softmax_cross_entropy_with_logits_v2\r\n    precise_logits, labels, name=name)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\ops\\gen_nn_ops.py\", line 7738, in softmax_cross_entropy_with_logits\r\n    name=name)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 3414, in create_op\r\n    op_def=op_def)\r\n  File \"F:\\Anaconda3\\envs\\tf\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 1740, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): Cannot assign a device for operation 'softmax_cross_entropy_with_logits_sg': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nColocation Debug Info:\r\nColocation group had the following types and devices: \r\nSoftmaxCrossEntropyWithLogits: GPU CPU \r\nIdentity: GPU CPU \r\nZerosLike: CPU \r\nConst: GPU CPU \r\nExpandDims: GPU CPU \r\nNeg: GPU CPU \r\nMul: GPU CPU \r\nLogSoftmax: CPU \r\n\r\nColocation members and user-requested devices:\r\n  softmax_cross_entropy_with_logits_sg (SoftmaxCrossEntropyWithLogits) /device:GPU:0\r\n  gradients/zeros_like (ZerosLike) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims/dim (Const) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims (ExpandDims) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/mul (Mul) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/LogSoftmax (LogSoftmax) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/Neg (Neg) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1/dim (Const) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/ExpandDims_1 (ExpandDims) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/mul_1 (Mul) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency (Identity) /device:GPU:0\r\n  gradients/softmax_cross_entropy_with_logits_sg_grad/tuple/control_dependency_1 (Identity) /device:GPU:0\r\n\r\nRegistered kernels:\r\n  device='CPU'; T in [DT_HALF]\r\n  device='CPU'; T in [DT_FLOAT]\r\n  device='CPU'; T in [DT_DOUBLE]\r\n  device='GPU'; T in [DT_HALF]\r\n  device='GPU'; T in [DT_FLOAT]\r\n  device='GPU'; T in [DT_DOUBLE]\r\n\r\n\t [[Node: softmax_cross_entropy_with_logits_sg = SoftmaxCrossEntropyWithLogits[T=DT_FLOAT, _device=\"/device:GPU:0\"](softmax_cross_entropy_with_logits_sg/Reshape, softmax_cross_entropy_with_logits_sg/Reshape_1)]]\r\n\r\n\r\nProcess finished with exit code 1\r\n`\r\n"}