{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4906", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4906/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4906/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4906/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/4906", "id": 182453741, "node_id": "MDU6SXNzdWUxODI0NTM3NDE=", "number": 4906, "title": "The \"cos\" merge mode when using tf as backend cann't get the expect result", "user": {"login": "KaidongYu", "id": 16697337, "node_id": "MDQ6VXNlcjE2Njk3MzM3", "avatar_url": "https://avatars2.githubusercontent.com/u/16697337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/KaidongYu", "html_url": "https://github.com/KaidongYu", "followers_url": "https://api.github.com/users/KaidongYu/followers", "following_url": "https://api.github.com/users/KaidongYu/following{/other_user}", "gists_url": "https://api.github.com/users/KaidongYu/gists{/gist_id}", "starred_url": "https://api.github.com/users/KaidongYu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/KaidongYu/subscriptions", "organizations_url": "https://api.github.com/users/KaidongYu/orgs", "repos_url": "https://api.github.com/users/KaidongYu/repos", "events_url": "https://api.github.com/users/KaidongYu/events{/privacy}", "received_events_url": "https://api.github.com/users/KaidongYu/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2016-10-12T07:24:53Z", "updated_at": "2016-10-12T07:33:42Z", "closed_at": "2016-10-12T07:33:01Z", "author_association": "NONE", "body_html": "<p>I have two batch of sentences as inputs, like:</p>\n<pre><code>a = np.array([[0, 1, 2, 3, 4], [0,1,0,0,0]], dtype='int32')\nb = np.array([[0, 1, 2, 3, 4], [0,0,2,0,0]], dtype='int32')\nvec = model.predict([a, b])\n</code></pre>\n<p>In my model, I trying to get the cos score between two vector, so I use 'cos' model in merge<br>\n<code>cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=1)</code><br>\nWhen I use theano as backend, it works fine, but when I use tf as backend, the output_shape=[batch_size, batch_size]</p>\n<p>The result by 'tf' backend:</p>\n<pre><code>[[ 0.99999994  0.97052568]\n [ 1.0303694   0.80238068]]\n</code></pre>\n<p>The result by 'theano' backend:</p>\n<pre><code>[[ 1.        ]\n [ 0.80238068]]\n</code></pre>\n<p>This is caused by <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/g3doc/api_docs/python/functions_and_classes/shard5/tf.batch_matmul.md\">tf.batch_matmul</a>,</p>\n<blockquote>\n<p>The input tensors x and y are 3-D or higher</p>\n</blockquote>\n<p>But I just input 2-D vectors. I think it have to be expanded when the input shape is 2-D</p>\n<p>BTW, My solution is:</p>\n<pre><code>if (keras.backend.backend() == \"theano\"):\n    cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=1)\nelse:\n    vec_a = RepeatVector(1)(vec_a)\n    vec_b = RepeatVector(1)(vec_b)\n    cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=2)\n    cos_score = Flatten()(cos_score)\n</code></pre>\n<p>Sorry about my English <g-emoji class=\"g-emoji\" alias=\"smiley\" fallback-src=\"https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png\">\ud83d\ude03</g-emoji></p>", "body_text": "I have two batch of sentences as inputs, like:\na = np.array([[0, 1, 2, 3, 4], [0,1,0,0,0]], dtype='int32')\nb = np.array([[0, 1, 2, 3, 4], [0,0,2,0,0]], dtype='int32')\nvec = model.predict([a, b])\n\nIn my model, I trying to get the cos score between two vector, so I use 'cos' model in merge\ncos_score = merge([vec_a, vec_b], mode='cos', dot_axes=1)\nWhen I use theano as backend, it works fine, but when I use tf as backend, the output_shape=[batch_size, batch_size]\nThe result by 'tf' backend:\n[[ 0.99999994  0.97052568]\n [ 1.0303694   0.80238068]]\n\nThe result by 'theano' backend:\n[[ 1.        ]\n [ 0.80238068]]\n\nThis is caused by tf.batch_matmul,\n\nThe input tensors x and y are 3-D or higher\n\nBut I just input 2-D vectors. I think it have to be expanded when the input shape is 2-D\nBTW, My solution is:\nif (keras.backend.backend() == \"theano\"):\n    cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=1)\nelse:\n    vec_a = RepeatVector(1)(vec_a)\n    vec_b = RepeatVector(1)(vec_b)\n    cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=2)\n    cos_score = Flatten()(cos_score)\n\nSorry about my English \ud83d\ude03", "body": "I have two batch of sentences as inputs, like:\n\n```\na = np.array([[0, 1, 2, 3, 4], [0,1,0,0,0]], dtype='int32')\nb = np.array([[0, 1, 2, 3, 4], [0,0,2,0,0]], dtype='int32')\nvec = model.predict([a, b])\n```\n\nIn my model, I trying to get the cos score between two vector, so I use 'cos' model in merge\n`cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=1)`\nWhen I use theano as backend, it works fine, but when I use tf as backend, the output_shape=[batch_size, batch_size]\n\nThe result by 'tf' backend:\n\n```\n[[ 0.99999994  0.97052568]\n [ 1.0303694   0.80238068]]\n```\n\nThe result by 'theano' backend:\n\n```\n[[ 1.        ]\n [ 0.80238068]]\n```\n\nThis is caused by [tf.batch_matmul](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/g3doc/api_docs/python/functions_and_classes/shard5/tf.batch_matmul.md), \n\n> The input tensors x and y are 3-D or higher\n\nBut I just input 2-D vectors. I think it have to be expanded when the input shape is 2-D\n\nBTW, My solution is:\n\n```\nif (keras.backend.backend() == \"theano\"):\n    cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=1)\nelse:\n    vec_a = RepeatVector(1)(vec_a)\n    vec_b = RepeatVector(1)(vec_b)\n    cos_score = merge([vec_a, vec_b], mode='cos', dot_axes=2)\n    cos_score = Flatten()(cos_score)\n```\n\nSorry about my English \ud83d\ude03 \n"}