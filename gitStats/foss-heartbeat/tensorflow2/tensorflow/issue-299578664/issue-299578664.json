{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17206", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17206/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17206/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17206/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17206", "id": 299578664, "node_id": "MDU6SXNzdWUyOTk1Nzg2NjQ=", "number": 17206, "title": "CPU restrictions do not reduce thread count", "user": {"login": "vlad17", "id": 5834964, "node_id": "MDQ6VXNlcjU4MzQ5NjQ=", "avatar_url": "https://avatars0.githubusercontent.com/u/5834964?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vlad17", "html_url": "https://github.com/vlad17", "followers_url": "https://api.github.com/users/vlad17/followers", "following_url": "https://api.github.com/users/vlad17/following{/other_user}", "gists_url": "https://api.github.com/users/vlad17/gists{/gist_id}", "starred_url": "https://api.github.com/users/vlad17/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vlad17/subscriptions", "organizations_url": "https://api.github.com/users/vlad17/orgs", "repos_url": "https://api.github.com/users/vlad17/repos", "events_url": "https://api.github.com/users/vlad17/events{/privacy}", "received_events_url": "https://api.github.com/users/vlad17/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "michaelisard", "id": 5376757, "node_id": "MDQ6VXNlcjUzNzY3NTc=", "avatar_url": "https://avatars1.githubusercontent.com/u/5376757?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelisard", "html_url": "https://github.com/michaelisard", "followers_url": "https://api.github.com/users/michaelisard/followers", "following_url": "https://api.github.com/users/michaelisard/following{/other_user}", "gists_url": "https://api.github.com/users/michaelisard/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelisard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelisard/subscriptions", "organizations_url": "https://api.github.com/users/michaelisard/orgs", "repos_url": "https://api.github.com/users/michaelisard/repos", "events_url": "https://api.github.com/users/michaelisard/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelisard/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "michaelisard", "id": 5376757, "node_id": "MDQ6VXNlcjUzNzY3NTc=", "avatar_url": "https://avatars1.githubusercontent.com/u/5376757?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelisard", "html_url": "https://github.com/michaelisard", "followers_url": "https://api.github.com/users/michaelisard/followers", "following_url": "https://api.github.com/users/michaelisard/following{/other_user}", "gists_url": "https://api.github.com/users/michaelisard/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelisard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelisard/subscriptions", "organizations_url": "https://api.github.com/users/michaelisard/orgs", "repos_url": "https://api.github.com/users/michaelisard/repos", "events_url": "https://api.github.com/users/michaelisard/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelisard/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-02-23T02:28:17Z", "updated_at": "2018-04-10T23:24:15Z", "closed_at": "2018-04-10T23:24:15Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>\n<p><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: no</p>\n</li>\n<li>\n<p><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux c72 4.13.0-17-generic <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115927762\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/20\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/20/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/20\">#20</a>~16.04.1-Ubuntu SMP Mon Nov 6 14:18:00 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>\n</li>\n<li>\n<p><strong>TensorFlow installed from (source or binary)</strong>: source</p>\n</li>\n<li>\n<p><strong>TensorFlow version (use command below)</strong>: b'v1.4.1-5-gabf3c6d' 1.4.1</p>\n</li>\n<li>\n<p><strong>Python version</strong>: 3.5</p>\n</li>\n<li>\n<p><strong>Bazel version (if compiling from source)</strong>: N/A</p>\n</li>\n<li>\n<p><strong>GCC/Compiler version (if compiling from source)</strong>: N/A</p>\n</li>\n<li>\n<p><strong>CUDA/cuDNN version</strong>: N/A</p>\n</li>\n<li>\n<p><strong>GPU model and memory</strong>: N/A</p>\n</li>\n<li>\n<p><strong>Exact command to reproduce</strong>: please see below</p>\n</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>It seems that the tensorflow configuration proto lets you specify the number of CPUs TF should use, but this does not limit the default number of threads TF creates in its thread pools. This seems like unexpected behavior to me. The default number of threads created by TF when no options are specified at all is equal to the number of cores TF detects on the machine it's running on. However, even when limiting the number of CPUs the thread count goes up. On a machine with many CPUs, I expected limiting to work, but it did not, until I limited the thread pool size explicitly.</p>\n<p>This isn't a big deal but seemed like it could be a bug, or at least makes the CPU device count option a bit unintuitive.</p>\n<pre><code>(cpuc-3.5) 18:21:27 vladf@c72:~$ python -c \"import tensorflow as tf\n&gt; tf.Session(config=tf.ConfigProto())\n&gt; import os\n&gt; pid = os.getpid()\n&gt; os.system('ps -o nlwp {}'.format(pid))\"\nNLWP\n 144\n(cpuc-3.5) 18:21:30 vladf@c72:~$ python -c \"import tensorflow as tf\n&gt; tf.Session(config=tf.ConfigProto(device_count={'CPU': 4}))\n&gt; import os\n&gt; pid = os.getpid()\n&gt; os.system('ps -o nlwp {}'.format(pid))\"\nNLWP\n 144\n(cpuc-3.5) 18:22:35 vladf@c72:~$ python -c \"import tensorflow as tf\n&gt; tf.Session(config=tf.ConfigProto(device_count={'CPU': 4},inter_op_parallelism_threads=4,intra_op_parallelism_threads=4))\n&gt; import os\n&gt; pid = os.getpid()\n&gt; os.system('ps -o nlwp {}'.format(pid))\"\nNLWP\n  56\n</code></pre>", "body_text": "System information\n\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): no\n\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux c72 4.13.0-17-generic #20~16.04.1-Ubuntu SMP Mon Nov 6 14:18:00 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\n\n\nTensorFlow installed from (source or binary): source\n\n\nTensorFlow version (use command below): b'v1.4.1-5-gabf3c6d' 1.4.1\n\n\nPython version: 3.5\n\n\nBazel version (if compiling from source): N/A\n\n\nGCC/Compiler version (if compiling from source): N/A\n\n\nCUDA/cuDNN version: N/A\n\n\nGPU model and memory: N/A\n\n\nExact command to reproduce: please see below\n\n\nDescribe the problem\nIt seems that the tensorflow configuration proto lets you specify the number of CPUs TF should use, but this does not limit the default number of threads TF creates in its thread pools. This seems like unexpected behavior to me. The default number of threads created by TF when no options are specified at all is equal to the number of cores TF detects on the machine it's running on. However, even when limiting the number of CPUs the thread count goes up. On a machine with many CPUs, I expected limiting to work, but it did not, until I limited the thread pool size explicitly.\nThis isn't a big deal but seemed like it could be a bug, or at least makes the CPU device count option a bit unintuitive.\n(cpuc-3.5) 18:21:27 vladf@c72:~$ python -c \"import tensorflow as tf\n> tf.Session(config=tf.ConfigProto())\n> import os\n> pid = os.getpid()\n> os.system('ps -o nlwp {}'.format(pid))\"\nNLWP\n 144\n(cpuc-3.5) 18:21:30 vladf@c72:~$ python -c \"import tensorflow as tf\n> tf.Session(config=tf.ConfigProto(device_count={'CPU': 4}))\n> import os\n> pid = os.getpid()\n> os.system('ps -o nlwp {}'.format(pid))\"\nNLWP\n 144\n(cpuc-3.5) 18:22:35 vladf@c72:~$ python -c \"import tensorflow as tf\n> tf.Session(config=tf.ConfigProto(device_count={'CPU': 4},inter_op_parallelism_threads=4,intra_op_parallelism_threads=4))\n> import os\n> pid = os.getpid()\n> os.system('ps -o nlwp {}'.format(pid))\"\nNLWP\n  56", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: no\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux c72 4.13.0-17-generic #20~16.04.1-Ubuntu SMP Mon Nov 6 14:18:00 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n- **TensorFlow installed from (source or binary)**: source\r\n- **TensorFlow version (use command below)**: b'v1.4.1-5-gabf3c6d' 1.4.1\r\n\r\n- **Python version**: 3.5\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **GCC/Compiler version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Exact command to reproduce**: please see below\r\n\r\n### Describe the problem\r\n\r\nIt seems that the tensorflow configuration proto lets you specify the number of CPUs TF should use, but this does not limit the default number of threads TF creates in its thread pools. This seems like unexpected behavior to me. The default number of threads created by TF when no options are specified at all is equal to the number of cores TF detects on the machine it's running on. However, even when limiting the number of CPUs the thread count goes up. On a machine with many CPUs, I expected limiting to work, but it did not, until I limited the thread pool size explicitly.\r\n\r\nThis isn't a big deal but seemed like it could be a bug, or at least makes the CPU device count option a bit unintuitive.\r\n\r\n```\r\n(cpuc-3.5) 18:21:27 vladf@c72:~$ python -c \"import tensorflow as tf\r\n> tf.Session(config=tf.ConfigProto())\r\n> import os\r\n> pid = os.getpid()\r\n> os.system('ps -o nlwp {}'.format(pid))\"\r\nNLWP\r\n 144\r\n(cpuc-3.5) 18:21:30 vladf@c72:~$ python -c \"import tensorflow as tf\r\n> tf.Session(config=tf.ConfigProto(device_count={'CPU': 4}))\r\n> import os\r\n> pid = os.getpid()\r\n> os.system('ps -o nlwp {}'.format(pid))\"\r\nNLWP\r\n 144\r\n(cpuc-3.5) 18:22:35 vladf@c72:~$ python -c \"import tensorflow as tf\r\n> tf.Session(config=tf.ConfigProto(device_count={'CPU': 4},inter_op_parallelism_threads=4,intra_op_parallelism_threads=4))\r\n> import os\r\n> pid = os.getpid()\r\n> os.system('ps -o nlwp {}'.format(pid))\"\r\nNLWP\r\n  56\r\n```\r\n"}