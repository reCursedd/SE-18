{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/56044589", "pull_request_review_id": null, "id": 56044589, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ0NTg5", "diff_hunk": "@@ -0,0 +1,115 @@\n+//Copyright (c) 2016, Alexander G. de G. Matthews and James Hensman. All rights reserved.\n+\n+//Based on code for blocked Cholesky reference mode differentiation by Iain Murray.\n+//For an explanation see \"Differentiation of the Cholesky algorithm\" by Iain Murray http://arxiv.org/abs/1602.07527.\n+\n+#include \"tensorflow/core/framework/op.h\"\n+#include \"third_party/eigen3/Eigen/Core\"\n+\n+REGISTER_OP(\"CholeskyGrad\").Input(\"l: T\").Input(\"l_bar: T\").Output(\"a_bar: T\").Attr( \"T: {float, double}\").Doc(\"Cholesky backpropagation where l is output of Cholesky algorithm and f is gradient of some loss wrt l\");\n+\n+#include \"tensorflow/core/framework/op_kernel.h\"\n+\n+#include \"third_party/eigen3/unsupported/Eigen/CXX11/Tensor\"\n+#include \"tensorflow/core/framework/tensor_types.h\"\n+#include \"tensorflow/core/framework/types.h\"\n+\n+using namespace tensorflow;\n+\n+template <typename T>\n+class CholeskyGrad : public OpKernel {\n+    public:\n+    \n+    explicit CholeskyGrad(OpKernelConstruction* context) : OpKernel(context) {}\n+\n+    using Matrix = Eigen::Matrix<T, Eigen::Dynamic, Eigen::Dynamic, Eigen::RowMajor>;\n+    using ConstMatrixMap = Eigen::Map<const Matrix>;\n+    using MatrixMap = Eigen::Map<Matrix>;\n+    using ConstRef = Eigen::Ref<const Matrix>;\n+    using Ref = Eigen::Ref<Matrix>;\n+    using lcl_size_t = int;\n+\n+    void Compute(OpKernelContext* context) override {\n+\n+    const Tensor& input_tensor_l = context->input(0); ;\n+    const Tensor& input_tensor_l_bar = context->input(1); \n+\n+    //Check that input tensors represent a matrix.\n+    OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_tensor_l.shape()), errors::InvalidArgument(\"In[0] is not a matrix\"));\n+    OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_tensor_l_bar.shape()), errors::InvalidArgument(\"In[1] is not a matrix\"));\n+\n+    //Check that input tensors are square.\n+    OP_REQUIRES(context, input_tensor_l.dim_size(0) == input_tensor_l.dim_size(1), errors::InvalidArgument(\"Input matrix must be square.\"));\n+    OP_REQUIRES(context, input_tensor_l_bar.dim_size(0) == input_tensor_l_bar.dim_size(1), errors::InvalidArgument(\"Input matrix must be square.\"));\n+\n+    //Check that input tensors are of same size.\n+    OP_REQUIRES(context, input_tensor_l.dim_size(0) == input_tensor_l_bar.dim_size(0), errors::InvalidArgument(\"Input matrices must be of same size.\"));    \n+\n+    // Create an output tensor\n+    Tensor* output_tensor = NULL;\n+    \n+    OP_REQUIRES_OK(context, context->allocate_output(0, input_tensor_l_bar.shape(), &output_tensor));\n+\n+    if (output_tensor->NumElements() == 0) {\n+      // the output shape is a 0-element matrix, so there is nothing to do.\n+      return;\n+    }\n+    \n+    //The next three lines are necessary to get Eigen matrix behaviour.\n+    const ConstMatrixMap input_matrix_l(input_tensor_l.flat<T>().data(), input_tensor_l.dim_size(0), input_tensor_l.dim_size(1));\n+    const ConstMatrixMap input_matrix_l_bar(input_tensor_l_bar.flat<T>().data(), input_tensor_l_bar.dim_size(0), input_tensor_l_bar.dim_size(1));\n+    MatrixMap output_matrix(output_tensor->template flat<T>().data(), input_tensor_l.dim_size(0), input_tensor_l.dim_size(1) );    \n+\n+    const lcl_size_t N = input_matrix_l.rows();\n+    const lcl_size_t NB = 32;\n+\n+    output_matrix = input_matrix_l_bar.template triangularView<Eigen::Lower>();\n+\n+    \n+    for ( lcl_size_t Ji = (N-NB+1) ; Ji>(1-NB); Ji-= NB )   ", "path": "tensorflow/core/user_ops/chol_grad.cc", "position": null, "original_position": 69, "commit_id": "175ba60ec638665b1165b7e9e806c59a4ed5b8d1", "original_commit_id": "441d2f116f12f064676ace93a34ceed6a8d9a9d1", "user": {"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}, "body": "A few general code style guidelines:\n- no space inside parens. \n- space after comma and on both sides of binary operators. \n- curly braces at the end of line,\n- use descriptive variable names.\n\nYou can see the full set of guidelines here: http://google.github.io/styleguide/cppguide.html\n\nI would change the variable names to:\n\nNB -> kMaxBlockSize\nJi ->  block_end (and redefined to point at the first element to the right of the current panel as is common with iterators in C++)\nJ -> block_begin\nJB -> block_size\n\nI guess this was \"translated\" from one-based to zero-based indexing and the subtraction of 1 everywhere makes the code harder to read. To improve readability I would suggest using something like the following:\n\nfor (int64 block_end = n; block_end > 0; block_end -= kMaxBlockSize) {\n  const int64 block_begin = std::max(0ll, block_end - kMaxBlockSize);\n  const int64 block_size = block_end - block_begin;\n  const int64 trailing_size = n - block_end;\n  output_matrix.block(block_end, block_begin, trailing_size, block_size) = ...\n  output_matrix.block(block_begin, block_begin, block_size, block_size) = ...\n  etc.\n", "created_at": "2016-03-14T17:51:56Z", "updated_at": "2016-04-07T16:48:06Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/1465#discussion_r56044589", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/1465", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/56044589"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/1465#discussion_r56044589"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/1465"}}, "body_html": "<p>A few general code style guidelines:</p>\n<ul>\n<li>no space inside parens.</li>\n<li>space after comma and on both sides of binary operators.</li>\n<li>curly braces at the end of line,</li>\n<li>use descriptive variable names.</li>\n</ul>\n<p>You can see the full set of guidelines here: <a href=\"http://google.github.io/styleguide/cppguide.html\" rel=\"nofollow\">http://google.github.io/styleguide/cppguide.html</a></p>\n<p>I would change the variable names to:</p>\n<p>NB -&gt; kMaxBlockSize<br>\nJi -&gt;  block_end (and redefined to point at the first element to the right of the current panel as is common with iterators in C++)<br>\nJ -&gt; block_begin<br>\nJB -&gt; block_size</p>\n<p>I guess this was \"translated\" from one-based to zero-based indexing and the subtraction of 1 everywhere makes the code harder to read. To improve readability I would suggest using something like the following:</p>\n<p>for (int64 block_end = n; block_end &gt; 0; block_end -= kMaxBlockSize) {<br>\nconst int64 block_begin = std::max(0ll, block_end - kMaxBlockSize);<br>\nconst int64 block_size = block_end - block_begin;<br>\nconst int64 trailing_size = n - block_end;<br>\noutput_matrix.block(block_end, block_begin, trailing_size, block_size) = ...<br>\noutput_matrix.block(block_begin, block_begin, block_size, block_size) = ...<br>\netc.</p>", "body_text": "A few general code style guidelines:\n\nno space inside parens.\nspace after comma and on both sides of binary operators.\ncurly braces at the end of line,\nuse descriptive variable names.\n\nYou can see the full set of guidelines here: http://google.github.io/styleguide/cppguide.html\nI would change the variable names to:\nNB -> kMaxBlockSize\nJi ->  block_end (and redefined to point at the first element to the right of the current panel as is common with iterators in C++)\nJ -> block_begin\nJB -> block_size\nI guess this was \"translated\" from one-based to zero-based indexing and the subtraction of 1 everywhere makes the code harder to read. To improve readability I would suggest using something like the following:\nfor (int64 block_end = n; block_end > 0; block_end -= kMaxBlockSize) {\nconst int64 block_begin = std::max(0ll, block_end - kMaxBlockSize);\nconst int64 block_size = block_end - block_begin;\nconst int64 trailing_size = n - block_end;\noutput_matrix.block(block_end, block_begin, trailing_size, block_size) = ...\noutput_matrix.block(block_begin, block_begin, block_size, block_size) = ...\netc."}