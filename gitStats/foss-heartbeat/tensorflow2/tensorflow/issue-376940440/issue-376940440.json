{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23464", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23464/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23464/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23464/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23464", "id": 376940440, "node_id": "MDU6SXNzdWUzNzY5NDA0NDA=", "number": 23464, "title": "tf.keras with tf.dataset takes longer per epoch eventually and sometimes errors out", "user": {"login": "Nithanaroy", "id": 670556, "node_id": "MDQ6VXNlcjY3MDU1Ng==", "avatar_url": "https://avatars1.githubusercontent.com/u/670556?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nithanaroy", "html_url": "https://github.com/Nithanaroy", "followers_url": "https://api.github.com/users/Nithanaroy/followers", "following_url": "https://api.github.com/users/Nithanaroy/following{/other_user}", "gists_url": "https://api.github.com/users/Nithanaroy/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nithanaroy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nithanaroy/subscriptions", "organizations_url": "https://api.github.com/users/Nithanaroy/orgs", "repos_url": "https://api.github.com/users/Nithanaroy/repos", "events_url": "https://api.github.com/users/Nithanaroy/events{/privacy}", "received_events_url": "https://api.github.com/users/Nithanaroy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1097545817, "node_id": "MDU6TGFiZWwxMDk3NTQ1ODE3", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:apis", "name": "comp:apis", "color": "0052cc", "default": false}], "state": "open", "locked": false, "assignee": {"login": "fchollet", "id": 710255, "node_id": "MDQ6VXNlcjcxMDI1NQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/710255?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fchollet", "html_url": "https://github.com/fchollet", "followers_url": "https://api.github.com/users/fchollet/followers", "following_url": "https://api.github.com/users/fchollet/following{/other_user}", "gists_url": "https://api.github.com/users/fchollet/gists{/gist_id}", "starred_url": "https://api.github.com/users/fchollet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fchollet/subscriptions", "organizations_url": "https://api.github.com/users/fchollet/orgs", "repos_url": "https://api.github.com/users/fchollet/repos", "events_url": "https://api.github.com/users/fchollet/events{/privacy}", "received_events_url": "https://api.github.com/users/fchollet/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "fchollet", "id": 710255, "node_id": "MDQ6VXNlcjcxMDI1NQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/710255?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fchollet", "html_url": "https://github.com/fchollet", "followers_url": "https://api.github.com/users/fchollet/followers", "following_url": "https://api.github.com/users/fchollet/following{/other_user}", "gists_url": "https://api.github.com/users/fchollet/gists{/gist_id}", "starred_url": "https://api.github.com/users/fchollet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fchollet/subscriptions", "organizations_url": "https://api.github.com/users/fchollet/orgs", "repos_url": "https://api.github.com/users/fchollet/repos", "events_url": "https://api.github.com/users/fchollet/events{/privacy}", "received_events_url": "https://api.github.com/users/fchollet/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2018-11-02T19:30:31Z", "updated_at": "2018-11-13T15:27:22Z", "closed_at": null, "author_association": "NONE", "body_html": "<p><em>Performance Issue</em></p>\n<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): No</li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04): RHEL6</li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:NA</li>\n<li>TensorFlow installed from (source or binary):No</li>\n<li>TensorFlow version (use command below):1.10.1</li>\n<li>Python version:2.7</li>\n<li>Bazel version (if compiling from source):NA</li>\n<li>GCC/Compiler version (if compiling from source):NA</li>\n<li>CUDA/cuDNN version:9.1.85</li>\n<li>GPU model and memory: Tesla P4, 7GB</li>\n</ul>\n<p><strong>Describe the current behavior</strong><br>\nThe time taken per epoch hugely varies from 10 min to 2 hours from 1st epoch to 2nd. Below are the accurate arguments used in <code>tf.dataset</code> creation and its consumption by <code>tf.keras.model</code>.</p>\n<p><strong>Describe the expected behavior</strong><br>\nEvery epoch should roughly take the same time</p>\n<p><strong>Code to reproduce the issue</strong><br>\nIts a little complicated to share ready to run code due to privacy. But here is crux of it,</p>\n<div class=\"highlight highlight-source-python\"><pre>dataset <span class=\"pl-k\">=</span> tf.data.TFRecordDataset(data_files, <span class=\"pl-v\">num_parallel_reads</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">79</span>)\n\n<span class=\"pl-k\">if</span> is_training:\n    dataset <span class=\"pl-k\">=</span> dataset.apply(tf.contrib.data.shuffle_and_repeat(<span class=\"pl-c1\">1743</span>, <span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">42</span>))\n\ndataset <span class=\"pl-k\">=</span> dataset.apply(tf.contrib.data.map_and_batch(decode, <span class=\"pl-c1\">128</span>,\n                                                        <span class=\"pl-v\">num_parallel_batches</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">58</span>,\n                                                        <span class=\"pl-v\">drop_remainder</span><span class=\"pl-k\">=</span>is_training)\n                        )\ndataset <span class=\"pl-k\">=</span> dataset.prefetch(<span class=\"pl-c1\">1064</span>)</pre></div>\n<p>and fit a <code>tf.keras.model</code> like so,</p>\n<div class=\"highlight highlight-source-python\"><pre>model.fit(\n    dataset.make_one_shot_iterator(),\n    <span class=\"pl-v\">steps_per_epoch</span><span class=\"pl-k\">=</span>model_meta.train_records <span class=\"pl-k\">//</span> <span class=\"pl-c1\">128</span>,\n    <span class=\"pl-v\">epochs</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">2</span>,\n    <span class=\"pl-v\">validation_data</span><span class=\"pl-k\">=</span>test_dataset.make_one_shot_iterator(),\n    <span class=\"pl-v\">validation_steps</span><span class=\"pl-k\">=</span>test_records <span class=\"pl-k\">//</span> <span class=\"pl-c1\">128</span>\n)</pre></div>\n<p><strong>Question 2</strong>: It also errors out almost at the end of the 2nd epoch with <code>tensorflow.python.framework.errors_impl.OutOfRangeError: End of sequence</code>. Not sure why it did not fail in the first epoch.</p>", "body_text": "Performance Issue\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): No\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): RHEL6\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:NA\nTensorFlow installed from (source or binary):No\nTensorFlow version (use command below):1.10.1\nPython version:2.7\nBazel version (if compiling from source):NA\nGCC/Compiler version (if compiling from source):NA\nCUDA/cuDNN version:9.1.85\nGPU model and memory: Tesla P4, 7GB\n\nDescribe the current behavior\nThe time taken per epoch hugely varies from 10 min to 2 hours from 1st epoch to 2nd. Below are the accurate arguments used in tf.dataset creation and its consumption by tf.keras.model.\nDescribe the expected behavior\nEvery epoch should roughly take the same time\nCode to reproduce the issue\nIts a little complicated to share ready to run code due to privacy. But here is crux of it,\ndataset = tf.data.TFRecordDataset(data_files, num_parallel_reads=79)\n\nif is_training:\n    dataset = dataset.apply(tf.contrib.data.shuffle_and_repeat(1743, -1, 42))\n\ndataset = dataset.apply(tf.contrib.data.map_and_batch(decode, 128,\n                                                        num_parallel_batches=58,\n                                                        drop_remainder=is_training)\n                        )\ndataset = dataset.prefetch(1064)\nand fit a tf.keras.model like so,\nmodel.fit(\n    dataset.make_one_shot_iterator(),\n    steps_per_epoch=model_meta.train_records // 128,\n    epochs=2,\n    validation_data=test_dataset.make_one_shot_iterator(),\n    validation_steps=test_records // 128\n)\nQuestion 2: It also errors out almost at the end of the 2nd epoch with tensorflow.python.framework.errors_impl.OutOfRangeError: End of sequence. Not sure why it did not fail in the first epoch.", "body": "<em>Performance Issue</em>\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): No\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): RHEL6\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:NA\r\n- TensorFlow installed from (source or binary):No\r\n- TensorFlow version (use command below):1.10.1\r\n- Python version:2.7\r\n- Bazel version (if compiling from source):NA\r\n- GCC/Compiler version (if compiling from source):NA\r\n- CUDA/cuDNN version:9.1.85\r\n- GPU model and memory: Tesla P4, 7GB\r\n\r\n**Describe the current behavior**\r\nThe time taken per epoch hugely varies from 10 min to 2 hours from 1st epoch to 2nd. Below are the accurate arguments used in `tf.dataset` creation and its consumption by `tf.keras.model`.\r\n\r\n**Describe the expected behavior**\r\nEvery epoch should roughly take the same time\r\n\r\n**Code to reproduce the issue**\r\nIts a little complicated to share ready to run code due to privacy. But here is crux of it,\r\n\r\n```python\r\ndataset = tf.data.TFRecordDataset(data_files, num_parallel_reads=79)\r\n\r\nif is_training:\r\n    dataset = dataset.apply(tf.contrib.data.shuffle_and_repeat(1743, -1, 42))\r\n\r\ndataset = dataset.apply(tf.contrib.data.map_and_batch(decode, 128,\r\n                                                        num_parallel_batches=58,\r\n                                                        drop_remainder=is_training)\r\n                        )\r\ndataset = dataset.prefetch(1064)\r\n```\r\nand fit a `tf.keras.model` like so,\r\n```python\r\nmodel.fit(\r\n    dataset.make_one_shot_iterator(),\r\n    steps_per_epoch=model_meta.train_records // 128,\r\n    epochs=2,\r\n    validation_data=test_dataset.make_one_shot_iterator(),\r\n    validation_steps=test_records // 128\r\n)\r\n```\r\n\r\n**Question 2**: It also errors out almost at the end of the 2nd epoch with `tensorflow.python.framework.errors_impl.OutOfRangeError: End of sequence`. Not sure why it did not fail in the first epoch."}