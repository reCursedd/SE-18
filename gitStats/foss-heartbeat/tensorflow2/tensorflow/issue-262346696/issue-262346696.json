{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13461", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13461/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13461/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13461/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13461", "id": 262346696, "node_id": "MDU6SXNzdWUyNjIzNDY2OTY=", "number": 13461, "title": "using ExponentialMovingAverage differs in CPU & GPU", "user": {"login": "DarcyCode", "id": 22005397, "node_id": "MDQ6VXNlcjIyMDA1Mzk3", "avatar_url": "https://avatars3.githubusercontent.com/u/22005397?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DarcyCode", "html_url": "https://github.com/DarcyCode", "followers_url": "https://api.github.com/users/DarcyCode/followers", "following_url": "https://api.github.com/users/DarcyCode/following{/other_user}", "gists_url": "https://api.github.com/users/DarcyCode/gists{/gist_id}", "starred_url": "https://api.github.com/users/DarcyCode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DarcyCode/subscriptions", "organizations_url": "https://api.github.com/users/DarcyCode/orgs", "repos_url": "https://api.github.com/users/DarcyCode/repos", "events_url": "https://api.github.com/users/DarcyCode/events{/privacy}", "received_events_url": "https://api.github.com/users/DarcyCode/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-10-03T08:38:20Z", "updated_at": "2017-12-11T21:23:50Z", "closed_at": "2017-12-11T21:23:32Z", "author_association": "NONE", "body_html": "<p>I use BN in cnn,here is the code</p>\n<pre><code>def batch_norm(x, beta, gamma, train_phase, scope='bn', decay=0.9, eps=1e-5):\n\n    with tf.variable_scope(scope):        \n        batch_mean, batch_var = tf.nn.moments(x, [0, 1, 2], name='moments')\n        ema = tf.train.ExponentialMovingAverage(decay=decay)\n\n        def mean_var_with_update():\n            ema_apply_op = ema.apply([batch_mean, batch_var])\n            with tf.control_dependencies([ema_apply_op]):\n                return tf.identity(batch_mean), tf.identity(batch_var)\n\n        mean, var = tf.cond(train_phase, mean_var_with_update, lambda: (ema.average(batch_mean), ema.average(batch_var)))\n        normed = tf.nn.batch_normalization(x, mean, var, beta, gamma, eps)\n    return normed\n</code></pre>\n<p>when i print variables in CPU &amp; GPU, it differs:<br>\nIn CPU it shows:<br>\n<code>bn_1/bn_1/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [32] bn_1/bn_1/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [32] bn_2/bn_2/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64] bn_2/bn_2/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64]</code><br>\nwhile in GPU it shows:<br>\n<code>bn_1/bn_1/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [32] bn_1/bn_1/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [32] bn_2/bn_2/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64] bn_2/bn_2/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64]</code></p>\n<p>therefore, when i load a CPU-trainned ckeckpoint in GPU, it turns out some errors like \"variables not found in file\" etc. Can someone solve this problem? thanks a lot.</p>", "body_text": "I use BN in cnn,here is the code\ndef batch_norm(x, beta, gamma, train_phase, scope='bn', decay=0.9, eps=1e-5):\n\n    with tf.variable_scope(scope):        \n        batch_mean, batch_var = tf.nn.moments(x, [0, 1, 2], name='moments')\n        ema = tf.train.ExponentialMovingAverage(decay=decay)\n\n        def mean_var_with_update():\n            ema_apply_op = ema.apply([batch_mean, batch_var])\n            with tf.control_dependencies([ema_apply_op]):\n                return tf.identity(batch_mean), tf.identity(batch_var)\n\n        mean, var = tf.cond(train_phase, mean_var_with_update, lambda: (ema.average(batch_mean), ema.average(batch_var)))\n        normed = tf.nn.batch_normalization(x, mean, var, beta, gamma, eps)\n    return normed\n\nwhen i print variables in CPU & GPU, it differs:\nIn CPU it shows:\nbn_1/bn_1/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [32] bn_1/bn_1/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [32] bn_2/bn_2/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64] bn_2/bn_2/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64]\nwhile in GPU it shows:\nbn_1/bn_1/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [32] bn_1/bn_1/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [32] bn_2/bn_2/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64] bn_2/bn_2/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64] bn_3/bn_3/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64] bn_4/bn_4/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64]\ntherefore, when i load a CPU-trainned ckeckpoint in GPU, it turns out some errors like \"variables not found in file\" etc. Can someone solve this problem? thanks a lot.", "body": "I use BN in cnn,here is the code\r\n\r\n```\r\ndef batch_norm(x, beta, gamma, train_phase, scope='bn', decay=0.9, eps=1e-5):\r\n\r\n    with tf.variable_scope(scope):        \r\n        batch_mean, batch_var = tf.nn.moments(x, [0, 1, 2], name='moments')\r\n        ema = tf.train.ExponentialMovingAverage(decay=decay)\r\n\r\n        def mean_var_with_update():\r\n            ema_apply_op = ema.apply([batch_mean, batch_var])\r\n            with tf.control_dependencies([ema_apply_op]):\r\n                return tf.identity(batch_mean), tf.identity(batch_var)\r\n\r\n        mean, var = tf.cond(train_phase, mean_var_with_update, lambda: (ema.average(batch_mean), ema.average(batch_var)))\r\n        normed = tf.nn.batch_normalization(x, mean, var, beta, gamma, eps)\r\n    return normed\r\n```\r\n\r\nwhen i print variables in CPU & GPU, it differs:\r\nIn CPU it shows:\r\n`bn_1/bn_1/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [32]\r\nbn_1/bn_1/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [32]\r\nbn_2/bn_2/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_2/bn_2/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_3/bn_3/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_3/bn_3/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_4/bn_4/moments/Squeeze/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_4/bn_4/moments/Squeeze_1/ExponentialMovingAverage (DT_FLOAT) [64]`\r\nwhile in GPU it shows:\r\n`bn_1/bn_1/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [32]\r\nbn_1/bn_1/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [32]\r\nbn_2/bn_2/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_2/bn_2/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_3/bn_3/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_3/bn_3/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_4/bn_4/moments/moments_1/mean/ExponentialMovingAverage (DT_FLOAT) [64]\r\nbn_4/bn_4/moments/moments_1/variance/ExponentialMovingAverage (DT_FLOAT) [64]`\r\n\r\ntherefore, when i load a CPU-trainned ckeckpoint in GPU, it turns out some errors like \"variables not found in file\" etc. Can someone solve this problem? thanks a lot."}