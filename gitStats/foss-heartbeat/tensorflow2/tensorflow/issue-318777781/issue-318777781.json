{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18971", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18971/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18971/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18971/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/18971", "id": 318777781, "node_id": "MDU6SXNzdWUzMTg3Nzc3ODE=", "number": 18971, "title": "Problems about loading SavedModelBundle", "user": {"login": "gypleon", "id": 22216143, "node_id": "MDQ6VXNlcjIyMjE2MTQz", "avatar_url": "https://avatars1.githubusercontent.com/u/22216143?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gypleon", "html_url": "https://github.com/gypleon", "followers_url": "https://api.github.com/users/gypleon/followers", "following_url": "https://api.github.com/users/gypleon/following{/other_user}", "gists_url": "https://api.github.com/users/gypleon/gists{/gist_id}", "starred_url": "https://api.github.com/users/gypleon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gypleon/subscriptions", "organizations_url": "https://api.github.com/users/gypleon/orgs", "repos_url": "https://api.github.com/users/gypleon/repos", "events_url": "https://api.github.com/users/gypleon/events{/privacy}", "received_events_url": "https://api.github.com/users/gypleon/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}, {"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 9, "created_at": "2018-04-30T03:25:35Z", "updated_at": "2018-08-14T08:31:23Z", "closed_at": "2018-08-14T08:31:22Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nNo</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nUbuntu 16.04.3 LTS</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<br>\nbinary</li>\n<li><strong>TensorFlow version (use command below)</strong>:<br>\n1.6</li>\n<li><strong>Python version</strong>:<br>\n2.7.12</li>\n<li><strong>Bazel version (if compiling from source)</strong>:</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:</li>\n<li><strong>CUDA/cuDNN version</strong>:<br>\nCUDA Version 9.0.176</li>\n<li><strong>GPU model and memory</strong>:<br>\nTesla K80, total memory 11.17GiB</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<ul>\n<li>\n<p><strong>Definitions</strong>:<br>\n<strong>Update N</strong> - Update status of proposed issues.<br>\n<strong>Additional N</strong> - New relevant issues met during development.</p>\n</li>\n<li>\n<p><strong>Background</strong>:<br>\nI saved a trained model under Tensorflow 1.0 using Saver.save(), then updated some variables and loaded it into Tensorflow 1.6. Now I saved it again using SavedModelBundle APIs and want to load it in Java.</p>\n</li>\n<li>\n<p><strong>Current Status</strong>:<br>\nThe model has been exported as .pb and variables files, with tags and SignatureDefs. But when I tried to SavedModelBundle.load() it in Java, it seemed to be blocked until manually terminated. Prompts after termination was like:<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/22216143/39414218-aaa3f24e-4c67-11e8-802a-93900c7b173a.jpg\"><img src=\"https://user-images.githubusercontent.com/22216143/39414218-aaa3f24e-4c67-11e8-802a-93900c7b173a.jpg\" alt=\"error screenshot - github\" style=\"max-width:100%;\"></a><br>\n<strong>Update 1</strong>: (transfer the import procedure from Win to Ubuntu)<br>\nException in thread \"main\" java.lang.IllegalArgumentException: Cannot assign a device for operation ... : Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.<br>\nRegistered kernels:<br>\ndevice='CPU'</p>\n</li>\n<li>\n<p><strong>Further Description</strong>:<br>\nWhat I want to emphasize is that, speaking of the SignatureDef settings, I attempted to give several inputs and outputs at one time, in which case some outputs may also be inputs again.<br>\nMore clearly in Seq2Seq model, I have outputs from the encoder which may also be inputs to the decoder. It also means that I want to fetch, modify and feed some intermediate variables of the model instead of playing with a simple model just with 1 input and 1 output. Hence the situation now is a little complex.<br>\nI read the documents but still have not found information describing this situation. Also searching the community gave no suitable answer. Therefore, could you help me to figure out if my implementation is right? or how to use the APIs to serve this situation?<br>\nThank you!<br>\n<strong>Update 1</strong>:<br>\nIt seems like SavedModelBundle failed to register GPU device for operations? or there are some configurations I should do before using it?<br>\nBesides, I have set \"<strong>tf.ConfigProto(allow_soft_placement=True)</strong>\".<br>\nThanks.</p>\n</li>\n</ul>\n<h3>Source code / logs</h3>\n<p>Python codes:</p>\n<div class=\"highlight highlight-source-python\"><pre>saved_model_builder <span class=\"pl-k\">=</span> tf.saved_model.builder.SavedModelBuilder(export_dir)\na <span class=\"pl-k\">=</span> tf.saved_model.utils.build_tensor_info(model.a)\nb <span class=\"pl-k\">=</span> tf.saved_model.utils.build_tensor_info(model.b)\nc <span class=\"pl-k\">=</span> tf.saved_model.utils.build_tensor_info(model.c)\nd <span class=\"pl-k\">=</span> tf.saved_model.utils.build_tensor_info(model.d)\ne <span class=\"pl-k\">=</span> tf.saved_model.utils.build_tensor_info(model.e)\nsignature <span class=\"pl-k\">=</span> tf.saved_model.signature_def_utils.build_signature_def(\n        <span class=\"pl-v\">inputs</span> <span class=\"pl-k\">=</span> {\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>a<span class=\"pl-pds\">\"</span></span>: a,\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>b<span class=\"pl-pds\">\"</span></span>: b,\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>c<span class=\"pl-pds\">\"</span></span>: c},\n        <span class=\"pl-v\">outputs</span> <span class=\"pl-k\">=</span> {\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>d<span class=\"pl-pds\">\"</span></span>: d,\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>e<span class=\"pl-pds\">\"</span></span>: e,\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>a<span class=\"pl-pds\">\"</span></span>: a,\n            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>b<span class=\"pl-pds\">\"</span></span>: b},\n        <span class=\"pl-v\">method_name</span> <span class=\"pl-k\">=</span> tf.saved_model.signature_constants.<span class=\"pl-c1\">PREDICT_METHOD_NAME</span>)\nasset_file <span class=\"pl-k\">=</span> tf.constant(<span class=\"pl-c1\">FLAGS</span>.vocab_path, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Vocabulary<span class=\"pl-pds\">\"</span></span>)\ntf.add_to_collection(tf.GraphKeys.<span class=\"pl-c1\">ASSET_FILEPATHS</span>, asset_file)\nsaved_model_builder.add_meta_graph_and_variables(\n        <span class=\"pl-c1\">self</span>._sess, [tf.saved_model.tag_constants.<span class=\"pl-c1\">SERVING</span>],\n        <span class=\"pl-v\">signature_def_map</span> <span class=\"pl-k\">=</span> {tf.saved_model.signature_constants.<span class=\"pl-c1\">DEFAULT_SERVING_SIGNATURE_DEF_KEY</span>: signature},\n            <span class=\"pl-v\">assets_collection</span> <span class=\"pl-k\">=</span> tf.get_collection(tf.GraphKeys.<span class=\"pl-c1\">ASSET_FILEPATHS</span>))\nsaved_model_builder.save()</pre></div>\n<p>Java code:</p>\n<div class=\"highlight highlight-source-java\"><pre><span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1\">MODEL_TAG</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>serve<span class=\"pl-pds\">\"</span></span>;\n<span class=\"pl-smi\">SavedModelBundle</span> model <span class=\"pl-k\">=</span> <span class=\"pl-smi\">SavedModelBundle</span><span class=\"pl-k\">.</span>load(modelDir, <span class=\"pl-c1\">MODEL_TAG</span>);</pre></div>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nNo\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nUbuntu 16.04.3 LTS\nTensorFlow installed from (source or binary):\nbinary\nTensorFlow version (use command below):\n1.6\nPython version:\n2.7.12\nBazel version (if compiling from source):\nGCC/Compiler version (if compiling from source):\nCUDA/cuDNN version:\nCUDA Version 9.0.176\nGPU model and memory:\nTesla K80, total memory 11.17GiB\nExact command to reproduce:\n\nDescribe the problem\n\n\nDefinitions:\nUpdate N - Update status of proposed issues.\nAdditional N - New relevant issues met during development.\n\n\nBackground:\nI saved a trained model under Tensorflow 1.0 using Saver.save(), then updated some variables and loaded it into Tensorflow 1.6. Now I saved it again using SavedModelBundle APIs and want to load it in Java.\n\n\nCurrent Status:\nThe model has been exported as .pb and variables files, with tags and SignatureDefs. But when I tried to SavedModelBundle.load() it in Java, it seemed to be blocked until manually terminated. Prompts after termination was like:\n\nUpdate 1: (transfer the import procedure from Win to Ubuntu)\nException in thread \"main\" java.lang.IllegalArgumentException: Cannot assign a device for operation ... : Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nRegistered kernels:\ndevice='CPU'\n\n\nFurther Description:\nWhat I want to emphasize is that, speaking of the SignatureDef settings, I attempted to give several inputs and outputs at one time, in which case some outputs may also be inputs again.\nMore clearly in Seq2Seq model, I have outputs from the encoder which may also be inputs to the decoder. It also means that I want to fetch, modify and feed some intermediate variables of the model instead of playing with a simple model just with 1 input and 1 output. Hence the situation now is a little complex.\nI read the documents but still have not found information describing this situation. Also searching the community gave no suitable answer. Therefore, could you help me to figure out if my implementation is right? or how to use the APIs to serve this situation?\nThank you!\nUpdate 1:\nIt seems like SavedModelBundle failed to register GPU device for operations? or there are some configurations I should do before using it?\nBesides, I have set \"tf.ConfigProto(allow_soft_placement=True)\".\nThanks.\n\n\nSource code / logs\nPython codes:\nsaved_model_builder = tf.saved_model.builder.SavedModelBuilder(export_dir)\na = tf.saved_model.utils.build_tensor_info(model.a)\nb = tf.saved_model.utils.build_tensor_info(model.b)\nc = tf.saved_model.utils.build_tensor_info(model.c)\nd = tf.saved_model.utils.build_tensor_info(model.d)\ne = tf.saved_model.utils.build_tensor_info(model.e)\nsignature = tf.saved_model.signature_def_utils.build_signature_def(\n        inputs = {\n            \"a\": a,\n            \"b\": b,\n            \"c\": c},\n        outputs = {\n            \"d\": d,\n            \"e\": e,\n            \"a\": a,\n            \"b\": b},\n        method_name = tf.saved_model.signature_constants.PREDICT_METHOD_NAME)\nasset_file = tf.constant(FLAGS.vocab_path, name=\"Vocabulary\")\ntf.add_to_collection(tf.GraphKeys.ASSET_FILEPATHS, asset_file)\nsaved_model_builder.add_meta_graph_and_variables(\n        self._sess, [tf.saved_model.tag_constants.SERVING],\n        signature_def_map = {tf.saved_model.signature_constants.DEFAULT_SERVING_SIGNATURE_DEF_KEY: signature},\n            assets_collection = tf.get_collection(tf.GraphKeys.ASSET_FILEPATHS))\nsaved_model_builder.save()\nJava code:\nprivate static final String MODEL_TAG = \"serve\";\nSavedModelBundle model = SavedModelBundle.load(modelDir, MODEL_TAG);", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nNo\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nUbuntu 16.04.3 LTS\r\n- **TensorFlow installed from (source or binary)**:\r\nbinary\r\n- **TensorFlow version (use command below)**:\r\n1.6\r\n- **Python version**: \r\n2.7.12\r\n- **Bazel version (if compiling from source)**:\r\n- **GCC/Compiler version (if compiling from source)**:\r\n- **CUDA/cuDNN version**:\r\nCUDA Version 9.0.176\r\n- **GPU model and memory**:\r\nTesla K80, total memory 11.17GiB\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\n- **Definitions**:\r\n**Update N** - Update status of proposed issues.\r\n**Additional N** - New relevant issues met during development.\r\n- **Background**: \r\nI saved a trained model under Tensorflow 1.0 using Saver.save(), then updated some variables and loaded it into Tensorflow 1.6. Now I saved it again using SavedModelBundle APIs and want to load it in Java. \r\n- **Current Status**: \r\nThe model has been exported as .pb and variables files, with tags and SignatureDefs. But when I tried to SavedModelBundle.load() it in Java, it seemed to be blocked until manually terminated. Prompts after termination was like:\r\n![error screenshot - github](https://user-images.githubusercontent.com/22216143/39414218-aaa3f24e-4c67-11e8-802a-93900c7b173a.jpg)\r\n**Update 1**: (transfer the import procedure from Win to Ubuntu)\r\nException in thread \"main\" java.lang.IllegalArgumentException: Cannot assign a device for operation ... : Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nRegistered kernels:\r\n  device='CPU'\r\n\r\n- **Further Description**: \r\nWhat I want to emphasize is that, speaking of the SignatureDef settings, I attempted to give several inputs and outputs at one time, in which case some outputs may also be inputs again.\r\nMore clearly in Seq2Seq model, I have outputs from the encoder which may also be inputs to the decoder. It also means that I want to fetch, modify and feed some intermediate variables of the model instead of playing with a simple model just with 1 input and 1 output. Hence the situation now is a little complex.\r\nI read the documents but still have not found information describing this situation. Also searching the community gave no suitable answer. Therefore, could you help me to figure out if my implementation is right? or how to use the APIs to serve this situation?\r\nThank you!\r\n**Update 1**: \r\nIt seems like SavedModelBundle failed to register GPU device for operations? or there are some configurations I should do before using it? \r\nBesides, I have set \"**tf.ConfigProto(allow_soft_placement=True)**\".\r\nThanks.\r\n\r\n### Source code / logs\r\nPython codes:\r\n``` python\r\nsaved_model_builder = tf.saved_model.builder.SavedModelBuilder(export_dir)\r\na = tf.saved_model.utils.build_tensor_info(model.a)\r\nb = tf.saved_model.utils.build_tensor_info(model.b)\r\nc = tf.saved_model.utils.build_tensor_info(model.c)\r\nd = tf.saved_model.utils.build_tensor_info(model.d)\r\ne = tf.saved_model.utils.build_tensor_info(model.e)\r\nsignature = tf.saved_model.signature_def_utils.build_signature_def(\r\n        inputs = {\r\n            \"a\": a,\r\n            \"b\": b,\r\n            \"c\": c},\r\n        outputs = {\r\n            \"d\": d,\r\n            \"e\": e,\r\n            \"a\": a,\r\n            \"b\": b},\r\n        method_name = tf.saved_model.signature_constants.PREDICT_METHOD_NAME)\r\nasset_file = tf.constant(FLAGS.vocab_path, name=\"Vocabulary\")\r\ntf.add_to_collection(tf.GraphKeys.ASSET_FILEPATHS, asset_file)\r\nsaved_model_builder.add_meta_graph_and_variables(\r\n        self._sess, [tf.saved_model.tag_constants.SERVING],\r\n        signature_def_map = {tf.saved_model.signature_constants.DEFAULT_SERVING_SIGNATURE_DEF_KEY: signature},\r\n            assets_collection = tf.get_collection(tf.GraphKeys.ASSET_FILEPATHS))\r\nsaved_model_builder.save()\r\n```\r\nJava code:\r\n``` java\r\nprivate static final String MODEL_TAG = \"serve\";\r\nSavedModelBundle model = SavedModelBundle.load(modelDir, MODEL_TAG);\r\n```"}