{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6336", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6336/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6336/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6336/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6336", "id": 195819010, "node_id": "MDU6SXNzdWUxOTU4MTkwMTA=", "number": 6336, "title": "session_bundle in TensorFlow 0.12.0-rc1 cannot restore v2 checkpoint", "user": {"login": "lienhua34", "id": 1691680, "node_id": "MDQ6VXNlcjE2OTE2ODA=", "avatar_url": "https://avatars2.githubusercontent.com/u/1691680?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lienhua34", "html_url": "https://github.com/lienhua34", "followers_url": "https://api.github.com/users/lienhua34/followers", "following_url": "https://api.github.com/users/lienhua34/following{/other_user}", "gists_url": "https://api.github.com/users/lienhua34/gists{/gist_id}", "starred_url": "https://api.github.com/users/lienhua34/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lienhua34/subscriptions", "organizations_url": "https://api.github.com/users/lienhua34/orgs", "repos_url": "https://api.github.com/users/lienhua34/repos", "events_url": "https://api.github.com/users/lienhua34/events{/privacy}", "received_events_url": "https://api.github.com/users/lienhua34/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "concretevitamin", "id": 592670, "node_id": "MDQ6VXNlcjU5MjY3MA==", "avatar_url": "https://avatars3.githubusercontent.com/u/592670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/concretevitamin", "html_url": "https://github.com/concretevitamin", "followers_url": "https://api.github.com/users/concretevitamin/followers", "following_url": "https://api.github.com/users/concretevitamin/following{/other_user}", "gists_url": "https://api.github.com/users/concretevitamin/gists{/gist_id}", "starred_url": "https://api.github.com/users/concretevitamin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/concretevitamin/subscriptions", "organizations_url": "https://api.github.com/users/concretevitamin/orgs", "repos_url": "https://api.github.com/users/concretevitamin/repos", "events_url": "https://api.github.com/users/concretevitamin/events{/privacy}", "received_events_url": "https://api.github.com/users/concretevitamin/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "concretevitamin", "id": 592670, "node_id": "MDQ6VXNlcjU5MjY3MA==", "avatar_url": "https://avatars3.githubusercontent.com/u/592670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/concretevitamin", "html_url": "https://github.com/concretevitamin", "followers_url": "https://api.github.com/users/concretevitamin/followers", "following_url": "https://api.github.com/users/concretevitamin/following{/other_user}", "gists_url": "https://api.github.com/users/concretevitamin/gists{/gist_id}", "starred_url": "https://api.github.com/users/concretevitamin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/concretevitamin/subscriptions", "organizations_url": "https://api.github.com/users/concretevitamin/orgs", "repos_url": "https://api.github.com/users/concretevitamin/repos", "events_url": "https://api.github.com/users/concretevitamin/events{/privacy}", "received_events_url": "https://api.github.com/users/concretevitamin/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2016-12-15T14:28:39Z", "updated_at": "2017-01-05T23:11:34Z", "closed_at": "2016-12-16T00:00:42Z", "author_association": "NONE", "body_html": "<p>I used <a href=\"https://github.com/tensorflow/tensorflow/blob/r0.12/tensorflow/contrib/session_bundle/example/export_half_plus_two.py\">example/export_half_plus_two.py</a> to test session_bundle. I run the below command to write v2 checkpoint files in export path,</p>\n<div class=\"highlight highlight-source-shell\"><pre>root\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python export_half_plus_two.py --use_checkpoint_v2=True\ncopying asset files to: /tmp/half_plus_two/00000123-tmp/assets\ncopying asset file: hello2.txt\ncopying asset file: hello1.txt</pre></div>\n<p>The export directory is</p>\n<div class=\"highlight highlight-source-shell\"><pre>root@b47d8eea090e:/tmp/half_plus_two/00000123# ls -l\ntotal 32\ndrwxr-xr-x 2 root root  4096 Dec 15 13:59 assets\n-rw-r--r-- 1 root root   133 Dec 15 13:59 checkpoint\n-rw-r--r-- 1 root root     8 Dec 15 13:59 export.data-00000-of-00001\n-rw-r--r-- 1 root root   134 Dec 15 13:59 export.index\n-rw-r--r-- 1 root root 14980 Dec 15 13:59 export.meta</pre></div>\n<p>Then I write a import python file, the content is</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">import</span> numpy <span class=\"pl-k\">as</span> np\n<span class=\"pl-k\">from</span> tensorflow.contrib.session_bundle <span class=\"pl-k\">import</span> session_bundle\n<span class=\"pl-k\">from</span> tensorflow.contrib.session_bundle <span class=\"pl-k\">import</span> constants\n<span class=\"pl-k\">from</span> tensorflow.contrib.session_bundle <span class=\"pl-k\">import</span> manifest_pb2\n\nexport_dir <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/tmp/half_plus_two/00000123<span class=\"pl-pds\">\"</span></span>\n\ntf.reset_default_graph()\n\nsess, meta_graph_def <span class=\"pl-k\">=</span> session_bundle.load_session_bundle_from_path(\n    export_dir, <span class=\"pl-v\">target</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-v\">config</span><span class=\"pl-k\">=</span>tf.ConfigProto(<span class=\"pl-v\">device_count</span><span class=\"pl-k\">=</span>{<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>CPU<span class=\"pl-pds\">\"</span></span>: <span class=\"pl-c1\">2</span>}))\n\n<span class=\"pl-k\">with</span> sess.as_default():\n    collection_def <span class=\"pl-k\">=</span> meta_graph_def.collection_def\n    signatures_any <span class=\"pl-k\">=</span> collection_def[constants.<span class=\"pl-c1\">SIGNATURES_KEY</span>].any_list.value\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>signatures length: <span class=\"pl-c1\">%d</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">%</span> <span class=\"pl-c1\">len</span>(signatures_any))\n\n    signatures <span class=\"pl-k\">=</span> manifest_pb2.Signatures()\n    signatures_any[<span class=\"pl-c1\">0</span>].Unpack(signatures)\n\n    named_signatures <span class=\"pl-k\">=</span> signatures.named_signatures\n    input_name <span class=\"pl-k\">=</span> (named_signatures[<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>inputs<span class=\"pl-pds\">\"</span></span>].generic_signature.map[<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>x<span class=\"pl-pds\">\"</span></span>].tensor_name)\n    output_name <span class=\"pl-k\">=</span> (named_signatures[<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>outputs<span class=\"pl-pds\">\"</span></span>].generic_signature.map[<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>y<span class=\"pl-pds\">\"</span></span>].tensor_name)\n\n    y <span class=\"pl-k\">=</span> sess.run([output_name], {input_name: np.array([[<span class=\"pl-c1\">0</span>], [<span class=\"pl-c1\">1</span>], [<span class=\"pl-c1\">2</span>], [<span class=\"pl-c1\">3</span>]])})\n    <span class=\"pl-c1\">print</span>(y[<span class=\"pl-c1\">0</span>])</pre></div>\n<p>It will tell me the variables are uninitialized,</p>\n<div class=\"highlight highlight-source-shell\"><pre>root\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python import_half_plus_two.py \nsignatures length: 1\n\nTraceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>import_half_plus_two.py<span class=\"pl-pds\">\"</span></span>, line 26, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    y = sess.run(\u00c4output_name\u00dc, \u00e4input_name: np.array(\u00c4\u00c40\u00dc, \u00c41\u00dc, \u00c42\u00dc, \u00c43\u00dc\u00dc)\u00a8)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line 766, <span class=\"pl-k\">in</span> run\n    run_metadata_ptr)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line 964, <span class=\"pl-k\">in</span> _run\n    feed_dict_string, options, run_metadata)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line 1014, <span class=\"pl-k\">in</span> _do_run\n    target_list, options, run_metadata)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line 1034, <span class=\"pl-k\">in</span> _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value b\n\t \u00c4\u00c4Node: b/read = Identity\u00c4T=DT_FLOAT, _class=\u00c4<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>loc:\u00a7b<span class=\"pl-pds\">\"</span></span>\u00dc, _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/cpu:0<span class=\"pl-pds\">\"</span></span>\u00dc(b)\u00dc\u00dc\n\nCaused by op u<span class=\"pl-s\"><span class=\"pl-pds\">'</span>b/read<span class=\"pl-pds\">'</span></span>, defined at:\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>import_half_plus_two.py<span class=\"pl-pds\">\"</span></span>, line 12, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    export_dir, target=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>, config=tf.ConfigProto(device_count=\u00e4<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>CPU<span class=\"pl-pds\">\"</span></span>: 2\u00a8))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/session_bundle/session_bundle.py<span class=\"pl-pds\">\"</span></span>, line 95, <span class=\"pl-k\">in</span> load_session_bundle_from_path\n    saver = tf.train.import_meta_graph(meta_graph_def)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/saver.py<span class=\"pl-pds\">\"</span></span>, line 1526, <span class=\"pl-k\">in</span> import_meta_graph\n    <span class=\"pl-k\">**</span>kwargs)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/meta_graph.py<span class=\"pl-pds\">\"</span></span>, line 502, <span class=\"pl-k\">in</span> import_scoped_meta_graph\n    producer_op_list=producer_op_list)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.py<span class=\"pl-pds\">\"</span></span>, line 285, <span class=\"pl-k\">in</span> import_graph_def\n    op_def=op_def)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line 2240, <span class=\"pl-k\">in</span> create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line 1128, <span class=\"pl-k\">in</span> __init__\n    self._traceback = <span class=\"pl-en\">_extract_stack</span>()\n\nFailedPreconditionError (see above <span class=\"pl-k\">for</span> traceback): Attempting to use uninitialized value b\n\t \u00c4\u00c4Node: b/read = Identity\u00c4T=DT_FLOAT, _class=\u00c4<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>loc:\u00a7b<span class=\"pl-pds\">\"</span></span>\u00dc, _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/cpu:0<span class=\"pl-pds\">\"</span></span>\u00dc(b)\u00dc\u00dc</pre></div>\n<p>If I changed the \"use_checkpoint_v2\" option to \"False\", there would be no error.</p>\n<div class=\"highlight highlight-source-shell\"><pre>root\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python export_half_plus_two.py --use_checkpoint_v2=False\nWARNING:tensorflow:<span class=\"pl-k\">*******************************************************</span>\nWARNING:tensorflow:TensorFlow<span class=\"pl-s\"><span class=\"pl-pds\">'</span>s V1 checkpoint format has been deprecated.</span>\n<span class=\"pl-s\">WARNING:tensorflow:Consider switching to the more efficient V2 format:</span>\n<span class=\"pl-s\">WARNING:tensorflow:   `tf.train.Saver(write_version=tf.train.SaverDef.V2)`</span>\n<span class=\"pl-s\">WARNING:tensorflow:now on by default.</span>\n<span class=\"pl-s\">WARNING:tensorflow:*******************************************************</span>\n<span class=\"pl-s\">copying asset files to: /tmp/half_plus_two/00000123-tmp/assets</span>\n<span class=\"pl-s\">copying asset file: hello2.txt</span>\n<span class=\"pl-s\">copying asset file: hello1.txt</span>\n<span class=\"pl-s\">root\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# </span>\n<span class=\"pl-s\">root\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python import_half_plus_two.py                          </span>\n<span class=\"pl-s\">signatures length: 1</span>\n<span class=\"pl-s\"></span>\n<span class=\"pl-s\">\u00c4\u00c4 2. \u00dc</span>\n<span class=\"pl-s\"> \u00c4 2.5\u00dc</span>\n<span class=\"pl-s\"> \u00c4 3. \u00dc</span>\n<span class=\"pl-s\"> \u00c4 3.5\u00dc\u00dc</span>\n<span class=\"pl-s\">root\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# </span></pre></div>\n<p>At this time, the export directory is</p>\n<div class=\"highlight highlight-source-shell\"><pre>root@b47d8eea090e:/tmp/half_plus_two/00000123# ls -l\ntotal 28\ndrwxr-xr-x 2 root root  4096 Dec 15 14:07 assets\n-rw-r--r-- 1 root root   163 Dec 15 14:07 checkpoint\n-rw-r--r-- 1 root root   169 Dec 15 14:07 export-00000-of-00001\n-rw-r--r-- 1 root root 13740 Dec 15 14:07 export.meta</pre></div>\n<p>I found that the diff between v2 checkpoint file and v1 checkpoint is a substring \".data\" in v2 checkpoint filename. Just see the above example, the v2 checkpoint filename is \"export.data-00000-of-00001\" and the v1 checkpoint filename is \"export-00000-of-00001\".</p>\n<p>So, I moved to read the load function \"load_session_bundle_from_path\", I found a bug at <a href=\"https://github.com/tensorflow/tensorflow/blob/r0.12/tensorflow/contrib/session_bundle/session_bundle.py#L64\">L64</a>. See following code snippet</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">if</span> <span class=\"pl-k\">not</span> file_io.file_exists(variables_filename):\n    variables_filename <span class=\"pl-k\">=</span> os.path.join(\n        export_dir, constants.<span class=\"pl-c1\">VARIABLES_FILENAME_PATTERN</span>)\n    <span class=\"pl-k\">if</span> <span class=\"pl-k\">not</span> file_io.get_matching_files(variables_filename):\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> If graph_util.convert_variables_to_constants() is called on a model</span>\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> it won't have any variables, and that's OK.</span>\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span></span>\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> <span class=\"pl-k\">TODO</span>(yxshi): verify that the graph_def in fact does not have any</span>\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> reachable variables.</span>\n      variables_filename <span class=\"pl-k\">=</span> <span class=\"pl-c1\">None</span></pre></div>\n<p>where the constant \"constants.VARIABLES_FILENAME_PATTERN\"( defined in <a href=\"https://github.com/tensorflow/tensorflow/blob/r0.12/tensorflow/contrib/session_bundle/constants.py#L28\">constant.py</a>) is \"export-????-of-????\". It cannot match the v2 checkpoint filename, so the load function cannot restore the v2 checkpoint file.</p>", "body_text": "I used example/export_half_plus_two.py to test session_bundle. I run the below command to write v2 checkpoint files in export path,\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python export_half_plus_two.py --use_checkpoint_v2=True\ncopying asset files to: /tmp/half_plus_two/00000123-tmp/assets\ncopying asset file: hello2.txt\ncopying asset file: hello1.txt\nThe export directory is\nroot@b47d8eea090e:/tmp/half_plus_two/00000123# ls -l\ntotal 32\ndrwxr-xr-x 2 root root  4096 Dec 15 13:59 assets\n-rw-r--r-- 1 root root   133 Dec 15 13:59 checkpoint\n-rw-r--r-- 1 root root     8 Dec 15 13:59 export.data-00000-of-00001\n-rw-r--r-- 1 root root   134 Dec 15 13:59 export.index\n-rw-r--r-- 1 root root 14980 Dec 15 13:59 export.meta\nThen I write a import python file, the content is\nimport tensorflow as tf\nimport numpy as np\nfrom tensorflow.contrib.session_bundle import session_bundle\nfrom tensorflow.contrib.session_bundle import constants\nfrom tensorflow.contrib.session_bundle import manifest_pb2\n\nexport_dir = \"/tmp/half_plus_two/00000123\"\n\ntf.reset_default_graph()\n\nsess, meta_graph_def = session_bundle.load_session_bundle_from_path(\n    export_dir, target=\"\", config=tf.ConfigProto(device_count={\"CPU\": 2}))\n\nwith sess.as_default():\n    collection_def = meta_graph_def.collection_def\n    signatures_any = collection_def[constants.SIGNATURES_KEY].any_list.value\n    print(\"signatures length: %d\\n\" % len(signatures_any))\n\n    signatures = manifest_pb2.Signatures()\n    signatures_any[0].Unpack(signatures)\n\n    named_signatures = signatures.named_signatures\n    input_name = (named_signatures[\"inputs\"].generic_signature.map[\"x\"].tensor_name)\n    output_name = (named_signatures[\"outputs\"].generic_signature.map[\"y\"].tensor_name)\n\n    y = sess.run([output_name], {input_name: np.array([[0], [1], [2], [3]])})\n    print(y[0])\nIt will tell me the variables are uninitialized,\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python import_half_plus_two.py \nsignatures length: 1\n\nTraceback (most recent call last):\n  File \"import_half_plus_two.py\", line 26, in <module>\n    y = sess.run(\u00c4output_name\u00dc, \u00e4input_name: np.array(\u00c4\u00c40\u00dc, \u00c41\u00dc, \u00c42\u00dc, \u00c43\u00dc\u00dc)\u00a8)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 766, in run\n    run_metadata_ptr)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 964, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 1014, in _do_run\n    target_list, options, run_metadata)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 1034, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value b\n\t \u00c4\u00c4Node: b/read = Identity\u00c4T=DT_FLOAT, _class=\u00c4\"loc:\u00a7b\"\u00dc, _device=\"/job:localhost/replica:0/task:0/cpu:0\"\u00dc(b)\u00dc\u00dc\n\nCaused by op u'b/read', defined at:\n  File \"import_half_plus_two.py\", line 12, in <module>\n    export_dir, target=\"\", config=tf.ConfigProto(device_count=\u00e4\"CPU\": 2\u00a8))\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/session_bundle/session_bundle.py\", line 95, in load_session_bundle_from_path\n    saver = tf.train.import_meta_graph(meta_graph_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/saver.py\", line 1526, in import_meta_graph\n    **kwargs)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/meta_graph.py\", line 502, in import_scoped_meta_graph\n    producer_op_list=producer_op_list)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.py\", line 285, in import_graph_def\n    op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2240, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1128, in __init__\n    self._traceback = _extract_stack()\n\nFailedPreconditionError (see above for traceback): Attempting to use uninitialized value b\n\t \u00c4\u00c4Node: b/read = Identity\u00c4T=DT_FLOAT, _class=\u00c4\"loc:\u00a7b\"\u00dc, _device=\"/job:localhost/replica:0/task:0/cpu:0\"\u00dc(b)\u00dc\u00dc\nIf I changed the \"use_checkpoint_v2\" option to \"False\", there would be no error.\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python export_half_plus_two.py --use_checkpoint_v2=False\nWARNING:tensorflow:*******************************************************\nWARNING:tensorflow:TensorFlow's V1 checkpoint format has been deprecated.\nWARNING:tensorflow:Consider switching to the more efficient V2 format:\nWARNING:tensorflow:   `tf.train.Saver(write_version=tf.train.SaverDef.V2)`\nWARNING:tensorflow:now on by default.\nWARNING:tensorflow:*******************************************************\ncopying asset files to: /tmp/half_plus_two/00000123-tmp/assets\ncopying asset file: hello2.txt\ncopying asset file: hello1.txt\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# \nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python import_half_plus_two.py                          \nsignatures length: 1\n\n\u00c4\u00c4 2. \u00dc\n \u00c4 2.5\u00dc\n \u00c4 3. \u00dc\n \u00c4 3.5\u00dc\u00dc\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# \nAt this time, the export directory is\nroot@b47d8eea090e:/tmp/half_plus_two/00000123# ls -l\ntotal 28\ndrwxr-xr-x 2 root root  4096 Dec 15 14:07 assets\n-rw-r--r-- 1 root root   163 Dec 15 14:07 checkpoint\n-rw-r--r-- 1 root root   169 Dec 15 14:07 export-00000-of-00001\n-rw-r--r-- 1 root root 13740 Dec 15 14:07 export.meta\nI found that the diff between v2 checkpoint file and v1 checkpoint is a substring \".data\" in v2 checkpoint filename. Just see the above example, the v2 checkpoint filename is \"export.data-00000-of-00001\" and the v1 checkpoint filename is \"export-00000-of-00001\".\nSo, I moved to read the load function \"load_session_bundle_from_path\", I found a bug at L64. See following code snippet\nif not file_io.file_exists(variables_filename):\n    variables_filename = os.path.join(\n        export_dir, constants.VARIABLES_FILENAME_PATTERN)\n    if not file_io.get_matching_files(variables_filename):\n      # If graph_util.convert_variables_to_constants() is called on a model\n      # it won't have any variables, and that's OK.\n      #\n      # TODO(yxshi): verify that the graph_def in fact does not have any\n      # reachable variables.\n      variables_filename = None\nwhere the constant \"constants.VARIABLES_FILENAME_PATTERN\"( defined in constant.py) is \"export-????-of-????\". It cannot match the v2 checkpoint filename, so the load function cannot restore the v2 checkpoint file.", "body": "I used [example/export_half_plus_two.py](https://github.com/tensorflow/tensorflow/blob/r0.12/tensorflow/contrib/session_bundle/example/export_half_plus_two.py) to test session_bundle. I run the below command to write v2 checkpoint files in export path,\r\n```shell\r\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python export_half_plus_two.py --use_checkpoint_v2=True\r\ncopying asset files to: /tmp/half_plus_two/00000123-tmp/assets\r\ncopying asset file: hello2.txt\r\ncopying asset file: hello1.txt\r\n```\r\n\r\nThe export directory is \r\n```shell\r\nroot@b47d8eea090e:/tmp/half_plus_two/00000123# ls -l\r\ntotal 32\r\ndrwxr-xr-x 2 root root  4096 Dec 15 13:59 assets\r\n-rw-r--r-- 1 root root   133 Dec 15 13:59 checkpoint\r\n-rw-r--r-- 1 root root     8 Dec 15 13:59 export.data-00000-of-00001\r\n-rw-r--r-- 1 root root   134 Dec 15 13:59 export.index\r\n-rw-r--r-- 1 root root 14980 Dec 15 13:59 export.meta\r\n```\r\n\r\nThen I write a import python file, the content is\r\n```python\r\nimport tensorflow as tf\r\nimport numpy as np\r\nfrom tensorflow.contrib.session_bundle import session_bundle\r\nfrom tensorflow.contrib.session_bundle import constants\r\nfrom tensorflow.contrib.session_bundle import manifest_pb2\r\n\r\nexport_dir = \"/tmp/half_plus_two/00000123\"\r\n\r\ntf.reset_default_graph()\r\n\r\nsess, meta_graph_def = session_bundle.load_session_bundle_from_path(\r\n    export_dir, target=\"\", config=tf.ConfigProto(device_count={\"CPU\": 2}))\r\n\r\nwith sess.as_default():\r\n    collection_def = meta_graph_def.collection_def\r\n    signatures_any = collection_def[constants.SIGNATURES_KEY].any_list.value\r\n    print(\"signatures length: %d\\n\" % len(signatures_any))\r\n\r\n    signatures = manifest_pb2.Signatures()\r\n    signatures_any[0].Unpack(signatures)\r\n\r\n    named_signatures = signatures.named_signatures\r\n    input_name = (named_signatures[\"inputs\"].generic_signature.map[\"x\"].tensor_name)\r\n    output_name = (named_signatures[\"outputs\"].generic_signature.map[\"y\"].tensor_name)\r\n\r\n    y = sess.run([output_name], {input_name: np.array([[0], [1], [2], [3]])})\r\n    print(y[0])\r\n```\r\n\r\nIt will tell me the variables are uninitialized,\r\n```shell\r\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python import_half_plus_two.py \r\nsignatures length: 1\r\n\r\nTraceback (most recent call last):\r\n  File \"import_half_plus_two.py\", line 26, in <module>\r\n    y = sess.run(\u00c4output_name\u00dc, \u00e4input_name: np.array(\u00c4\u00c40\u00dc, \u00c41\u00dc, \u00c42\u00dc, \u00c43\u00dc\u00dc)\u00a8)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 766, in run\r\n    run_metadata_ptr)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 964, in _run\r\n    feed_dict_string, options, run_metadata)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 1014, in _do_run\r\n    target_list, options, run_metadata)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 1034, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value b\r\n\t \u00c4\u00c4Node: b/read = Identity\u00c4T=DT_FLOAT, _class=\u00c4\"loc:\u00a7b\"\u00dc, _device=\"/job:localhost/replica:0/task:0/cpu:0\"\u00dc(b)\u00dc\u00dc\r\n\r\nCaused by op u'b/read', defined at:\r\n  File \"import_half_plus_two.py\", line 12, in <module>\r\n    export_dir, target=\"\", config=tf.ConfigProto(device_count=\u00e4\"CPU\": 2\u00a8))\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/session_bundle/session_bundle.py\", line 95, in load_session_bundle_from_path\r\n    saver = tf.train.import_meta_graph(meta_graph_def)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/saver.py\", line 1526, in import_meta_graph\r\n    **kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/meta_graph.py\", line 502, in import_scoped_meta_graph\r\n    producer_op_list=producer_op_list)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.py\", line 285, in import_graph_def\r\n    op_def=op_def)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2240, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1128, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\nFailedPreconditionError (see above for traceback): Attempting to use uninitialized value b\r\n\t \u00c4\u00c4Node: b/read = Identity\u00c4T=DT_FLOAT, _class=\u00c4\"loc:\u00a7b\"\u00dc, _device=\"/job:localhost/replica:0/task:0/cpu:0\"\u00dc(b)\u00dc\u00dc\r\n```\r\n\r\nIf I changed the \"use_checkpoint_v2\" option to \"False\", there would be no error.\r\n\r\n```shell\r\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python export_half_plus_two.py --use_checkpoint_v2=False\r\nWARNING:tensorflow:*******************************************************\r\nWARNING:tensorflow:TensorFlow's V1 checkpoint format has been deprecated.\r\nWARNING:tensorflow:Consider switching to the more efficient V2 format:\r\nWARNING:tensorflow:   `tf.train.Saver(write_version=tf.train.SaverDef.V2)`\r\nWARNING:tensorflow:now on by default.\r\nWARNING:tensorflow:*******************************************************\r\ncopying asset files to: /tmp/half_plus_two/00000123-tmp/assets\r\ncopying asset file: hello2.txt\r\ncopying asset file: hello1.txt\r\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# \r\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# python import_half_plus_two.py                          \r\nsignatures length: 1\r\n\r\n\u00c4\u00c4 2. \u00dc\r\n \u00c4 2.5\u00dc\r\n \u00c4 3. \u00dc\r\n \u00c4 3.5\u00dc\u00dc\r\nroot\u00a7b47d8eea090e:/tensorflow/model-export/session_bundle# \r\n```\r\n\r\nAt this time, the export directory is\r\n\r\n```shell\r\nroot@b47d8eea090e:/tmp/half_plus_two/00000123# ls -l\r\ntotal 28\r\ndrwxr-xr-x 2 root root  4096 Dec 15 14:07 assets\r\n-rw-r--r-- 1 root root   163 Dec 15 14:07 checkpoint\r\n-rw-r--r-- 1 root root   169 Dec 15 14:07 export-00000-of-00001\r\n-rw-r--r-- 1 root root 13740 Dec 15 14:07 export.meta\r\n```\r\n\r\nI found that the diff between v2 checkpoint file and v1 checkpoint is a substring \".data\" in v2 checkpoint filename. Just see the above example, the v2 checkpoint filename is \"export.data-00000-of-00001\" and the v1 checkpoint filename is \"export-00000-of-00001\". \r\n\r\nSo, I moved to read the load function \"load_session_bundle_from_path\", I found a bug at [L64](https://github.com/tensorflow/tensorflow/blob/r0.12/tensorflow/contrib/session_bundle/session_bundle.py#L64). See following code snippet\r\n\r\n```python\r\nif not file_io.file_exists(variables_filename):\r\n    variables_filename = os.path.join(\r\n        export_dir, constants.VARIABLES_FILENAME_PATTERN)\r\n    if not file_io.get_matching_files(variables_filename):\r\n      # If graph_util.convert_variables_to_constants() is called on a model\r\n      # it won't have any variables, and that's OK.\r\n      #\r\n      # TODO(yxshi): verify that the graph_def in fact does not have any\r\n      # reachable variables.\r\n      variables_filename = None\r\n```\r\n\r\nwhere the constant \"constants.VARIABLES_FILENAME_PATTERN\"( defined in [constant.py](https://github.com/tensorflow/tensorflow/blob/r0.12/tensorflow/contrib/session_bundle/constants.py#L28)) is \"export-????-of-????\". It cannot match the v2 checkpoint filename, so the load function cannot restore the v2 checkpoint file.\r\n"}