{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/66242610", "pull_request_review_id": null, "id": 66242610, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjQyNjEw", "diff_hunk": "@@ -54,22 +54,31 @@ def batch_normalize(tensor_in,\n         initializer=init_ops.random_normal_initializer(1., 0.02))\n     beta = vs.get_variable(\"beta\", [shape[-1]],\n                            initializer=init_ops.constant_initializer(0.))\n-    ema = moving_averages.ExponentialMovingAverage(decay=decay)\n-    if convnet:\n-      assign_mean, assign_var = nn.moments(tensor_in, [0, 1, 2])\n-    else:\n-      assign_mean, assign_var = nn.moments(tensor_in, [0])\n-    ema_assign_op = ema.apply([assign_mean, assign_var])\n-    ema_mean, ema_var = ema.average(assign_mean), ema.average(assign_var)\n+    moving_mean = vs.get_variable(\n+        'moving_mean',\n+        shape=[shape[-1]],\n+        initializer=init_ops.zeros_initializer,\n+        trainable=False)\n+    moving_var = vs.get_variable(\n+        'moving_var',\n+        shape=[shape[-1]],\n+        initializer=init_ops.ones_initializer,\n+        trainable=False)\n \n     def _update_mean_var():\n       \"\"\"Internal function that updates mean and variance during training.\"\"\"\n-      with ops.control_dependencies([ema_assign_op]):\n-        return array_ops_.identity(assign_mean), array_ops_.identity(assign_var)\n+      axis = [0, 1, 2] if convnet else [0]\n+      mean, var = nn.moments(tensor_in, axis)\n+      update_moving_mean = moving_averages.assign_moving_average(\n+          moving_mean, mean, decay)\n+      update_moving_var = moving_averages.assign_moving_average(\n+          moving_var, var, decay)\n+      with ops.control_dependencies([update_moving_mean, update_moving_var]):\n+        return array_ops_.identity(mean), array_ops_.identity(var)\n \n     is_training = array_ops_.squeeze(ops.get_collection(\"IS_TRAINING\"))\n     mean, variance = control_flow_ops.cond(is_training, _update_mean_var,\n-                                           lambda: (ema_mean, ema_var))\n+                                           lambda: (moving_mean, moving_var))\n     return nn.batch_norm_with_global_normalization(", "path": "tensorflow/contrib/learn/python/learn/ops/batch_norm_ops.py", "position": 39, "original_position": 39, "commit_id": "a4e3317d1475481cb945b6685c0c0d4f48cfd3a3", "original_commit_id": "a4e3317d1475481cb945b6685c0c0d4f48cfd3a3", "user": {"login": "fwalch", "id": 339435, "node_id": "MDQ6VXNlcjMzOTQzNQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/339435?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fwalch", "html_url": "https://github.com/fwalch", "followers_url": "https://api.github.com/users/fwalch/followers", "following_url": "https://api.github.com/users/fwalch/following{/other_user}", "gists_url": "https://api.github.com/users/fwalch/gists{/gist_id}", "starred_url": "https://api.github.com/users/fwalch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fwalch/subscriptions", "organizations_url": "https://api.github.com/users/fwalch/orgs", "repos_url": "https://api.github.com/users/fwalch/repos", "events_url": "https://api.github.com/users/fwalch/events{/privacy}", "received_events_url": "https://api.github.com/users/fwalch/received_events", "type": "User", "site_admin": false}, "body": "Since you're already touching this function, you could change this to `nn.batch_normalization` (`nn.batch_norm_with_global_normalization` is deprecated).\n", "created_at": "2016-06-08T12:05:56Z", "updated_at": "2016-06-08T12:05:56Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/2104#discussion_r66242610", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/2104", "author_association": "NONE", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/66242610"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/2104#discussion_r66242610"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/2104"}}, "body_html": "<p>Since you're already touching this function, you could change this to <code>nn.batch_normalization</code> (<code>nn.batch_norm_with_global_normalization</code> is deprecated).</p>", "body_text": "Since you're already touching this function, you could change this to nn.batch_normalization (nn.batch_norm_with_global_normalization is deprecated)."}