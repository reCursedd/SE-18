{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9210", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9210/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9210/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9210/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/9210", "id": 221742880, "node_id": "MDU6SXNzdWUyMjE3NDI4ODA=", "number": 9210, "title": "Feature: Sparse matrix multiplications for Tensors with rank > 2", "user": {"login": "supercoderhawk", "id": 10846896, "node_id": "MDQ6VXNlcjEwODQ2ODk2", "avatar_url": "https://avatars3.githubusercontent.com/u/10846896?v=4", "gravatar_id": "", "url": "https://api.github.com/users/supercoderhawk", "html_url": "https://github.com/supercoderhawk", "followers_url": "https://api.github.com/users/supercoderhawk/followers", "following_url": "https://api.github.com/users/supercoderhawk/following{/other_user}", "gists_url": "https://api.github.com/users/supercoderhawk/gists{/gist_id}", "starred_url": "https://api.github.com/users/supercoderhawk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/supercoderhawk/subscriptions", "organizations_url": "https://api.github.com/users/supercoderhawk/orgs", "repos_url": "https://api.github.com/users/supercoderhawk/repos", "events_url": "https://api.github.com/users/supercoderhawk/events{/privacy}", "received_events_url": "https://api.github.com/users/supercoderhawk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473173272, "node_id": "MDU6TGFiZWw0NzMxNzMyNzI=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:feature", "name": "type:feature", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-04-14T05:08:38Z", "updated_at": "2018-05-25T16:26:01Z", "closed_at": null, "author_association": "NONE", "body_html": "<h2>System Information:</h2>\n<p>Windows 10, x64, Tensorflow 1.1.0.rc1</p>\n<h2>Description:</h2>\n<p>The 3-D sparse tensor (placeholder) multiply with 3-D dense tensor has bug, the operation will failed.</p>\n<div class=\"highlight highlight-source-python\"><pre>x <span class=\"pl-k\">=</span> tf.sparse_placeholder(tf.float32, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[<span class=\"pl-c1\">None</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>])\ny <span class=\"pl-k\">=</span> tf.constant(np.ones([<span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">1</span>]), <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.float32)\nz <span class=\"pl-k\">=</span> tf.matmul(x, y, <span class=\"pl-v\">a_is_sparse</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)\n\nindices <span class=\"pl-k\">=</span> [[<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">1</span>], [<span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>], [<span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">1</span>]]\nvalues <span class=\"pl-k\">=</span> [<span class=\"pl-c1\">1.0</span>, <span class=\"pl-c1\">2.0</span>, <span class=\"pl-c1\">3.0</span>]\ndense_shape <span class=\"pl-k\">=</span> [<span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>]\nx_val <span class=\"pl-k\">=</span> tf.SparseTensorValue(indices, values, dense_shape)\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n  res <span class=\"pl-k\">=</span> sess.run(z, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{x: x_val})\n  <span class=\"pl-c1\">print</span>(res)</pre></div>\n<p>expected result(3x2x1):</p>\n<pre><code>[[[ 0.][ 1.]]\n [[ 1.][ 0.]]\n [[ 1.][ 0.]]]\n</code></pre>\n<p>but output some errors actually :</p>\n<div class=\"highlight highlight-source-python\"><pre>Traceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>D:/Learning/master_project/clinicalText/SourceCode/Python/DNN_CWS/seg_dnn.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">369</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    cws <span class=\"pl-k\">=</span> SegDNN(constant.<span class=\"pl-c1\">VOCAB_SIZE</span>, embed_size, constant.<span class=\"pl-c1\">DNN_SKIP_WINDOW</span>)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>D:/Learning/master_project/clinicalText/SourceCode/Python/DNN_CWS/seg_dnn.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">76</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__init__</span>\n    <span class=\"pl-c1\">self</span>.loss <span class=\"pl-k\">=</span> tf.reduce_sum(tf.matmul(<span class=\"pl-c1\">self</span>.slim_map_matrix,tf.expand_dims(tf.transpose(<span class=\"pl-c1\">self</span>.word_score),<span class=\"pl-c1\">2</span>),<span class=\"pl-v\">a_is_sparse</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python\\ops\\math_ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1755</span>, <span class=\"pl-k\">in</span> matmul\n    a <span class=\"pl-k\">=</span> ops.convert_to_tensor(a, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>a<span class=\"pl-pds\">\"</span></span>)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python<span class=\"pl-cce\">\\f</span>ramework\\ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">639</span>, <span class=\"pl-k\">in</span> convert_to_tensor\n    as_ref<span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python<span class=\"pl-cce\">\\f</span>ramework\\ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">704</span>, <span class=\"pl-k\">in</span> internal_convert_to_tensor\n    ret <span class=\"pl-k\">=</span> conversion_func(value, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>dtype, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span>name, <span class=\"pl-v\">as_ref</span><span class=\"pl-k\">=</span>as_ref)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python<span class=\"pl-cce\">\\f</span>ramework\\constant_op.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">113</span>, <span class=\"pl-k\">in</span> _constant_tensor_conversion_function\n    <span class=\"pl-k\">return</span> constant(v, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>dtype, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span>name)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python<span class=\"pl-cce\">\\f</span>ramework\\constant_op.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">102</span>, <span class=\"pl-k\">in</span> constant\n    tensor_util.make_tensor_proto(value, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>dtype, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>shape, <span class=\"pl-v\">verify_shape</span><span class=\"pl-k\">=</span>verify_shape))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python<span class=\"pl-cce\">\\f</span>ramework<span class=\"pl-cce\">\\t</span>ensor_util.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">444</span>, <span class=\"pl-k\">in</span> make_tensor_proto\n    tensor_proto.string_val.extend([compat.as_bytes(x) <span class=\"pl-k\">for</span> x <span class=\"pl-k\">in</span> proto_values])\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python<span class=\"pl-cce\">\\f</span>ramework<span class=\"pl-cce\">\\t</span>ensor_util.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">444</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>listcomp<span class=\"pl-k\">&gt;</span>\n    tensor_proto.string_val.extend([compat.as_bytes(x) <span class=\"pl-k\">for</span> x <span class=\"pl-k\">in</span> proto_values])\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>E:\\IntelPython35\\envs<span class=\"pl-cce\">\\t</span>ensorflow-intel\\lib\\site-packages<span class=\"pl-cce\">\\t</span>ensorflow\\python\\util\\compat.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">65</span>, <span class=\"pl-k\">in</span> as_bytes\n    (bytes_or_text,))\n<span class=\"pl-c1\">TypeError</span>: Expected binary <span class=\"pl-k\">or</span> <span class=\"pl-v\">unicode</span> string, got <span class=\"pl-k\">&lt;</span>tensorflow.python.framework.sparse_tensor.SparseTensor <span class=\"pl-c1\">object</span> at <span class=\"pl-c1\"><span class=\"pl-k\">0x</span>00000195FA86B1D0</span><span class=\"pl-k\">&gt;</span>\n</pre></div>\n<p>change the <code>z</code> to</p>\n<div class=\"highlight highlight-source-python\"><pre>z <span class=\"pl-k\">=</span> tf.sparse_tensor_dense_matmul(x,y)</pre></div>\n<p>also failed because the shape of sparse must 2-D,but <code>x</code>and<code>b</code>has 3-D</p>", "body_text": "System Information:\nWindows 10, x64, Tensorflow 1.1.0.rc1\nDescription:\nThe 3-D sparse tensor (placeholder) multiply with 3-D dense tensor has bug, the operation will failed.\nx = tf.sparse_placeholder(tf.float32, shape=[None, 2, 2])\ny = tf.constant(np.ones([3, 2, 1]), dtype=tf.float32)\nz = tf.matmul(x, y, a_is_sparse=True)\n\nindices = [[1, 1, 1], [2, 0, 0], [3, 0, 1]]\nvalues = [1.0, 2.0, 3.0]\ndense_shape = [3, 2, 2]\nx_val = tf.SparseTensorValue(indices, values, dense_shape)\n\nwith tf.Session() as sess:\n  res = sess.run(z, feed_dict={x: x_val})\n  print(res)\nexpected result(3x2x1):\n[[[ 0.][ 1.]]\n [[ 1.][ 0.]]\n [[ 1.][ 0.]]]\n\nbut output some errors actually :\nTraceback (most recent call last):\n  File \"D:/Learning/master_project/clinicalText/SourceCode/Python/DNN_CWS/seg_dnn.py\", line 369, in <module>\n    cws = SegDNN(constant.VOCAB_SIZE, embed_size, constant.DNN_SKIP_WINDOW)\n  File \"D:/Learning/master_project/clinicalText/SourceCode/Python/DNN_CWS/seg_dnn.py\", line 76, in __init__\n    self.loss = tf.reduce_sum(tf.matmul(self.slim_map_matrix,tf.expand_dims(tf.transpose(self.word_score),2),a_is_sparse=True))\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\ops\\math_ops.py\", line 1755, in matmul\n    a = ops.convert_to_tensor(a, name=\"a\")\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 639, in convert_to_tensor\n    as_ref=False)\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 704, in internal_convert_to_tensor\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\constant_op.py\", line 113, in _constant_tensor_conversion_function\n    return constant(v, dtype=dtype, name=name)\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\constant_op.py\", line 102, in constant\n    tensor_util.make_tensor_proto(value, dtype=dtype, shape=shape, verify_shape=verify_shape))\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\tensor_util.py\", line 444, in make_tensor_proto\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\tensor_util.py\", line 444, in <listcomp>\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\util\\compat.py\", line 65, in as_bytes\n    (bytes_or_text,))\nTypeError: Expected binary or unicode string, got <tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x00000195FA86B1D0>\n\nchange the z to\nz = tf.sparse_tensor_dense_matmul(x,y)\nalso failed because the shape of sparse must 2-D,but xandbhas 3-D", "body": "## System Information:\r\nWindows 10, x64, Tensorflow 1.1.0.rc1\r\n\r\n## Description:\r\nThe 3-D sparse tensor (placeholder) multiply with 3-D dense tensor has bug, the operation will failed.\r\n\r\n```python\r\nx = tf.sparse_placeholder(tf.float32, shape=[None, 2, 2])\r\ny = tf.constant(np.ones([3, 2, 1]), dtype=tf.float32)\r\nz = tf.matmul(x, y, a_is_sparse=True)\r\n\r\nindices = [[1, 1, 1], [2, 0, 0], [3, 0, 1]]\r\nvalues = [1.0, 2.0, 3.0]\r\ndense_shape = [3, 2, 2]\r\nx_val = tf.SparseTensorValue(indices, values, dense_shape)\r\n\r\nwith tf.Session() as sess:\r\n  res = sess.run(z, feed_dict={x: x_val})\r\n  print(res)\r\n```\r\nexpected result(3x2x1):\r\n```\r\n[[[ 0.][ 1.]]\r\n [[ 1.][ 0.]]\r\n [[ 1.][ 0.]]]\r\n```\r\nbut output some errors actually :\r\n\r\n```python\r\nTraceback (most recent call last):\r\n  File \"D:/Learning/master_project/clinicalText/SourceCode/Python/DNN_CWS/seg_dnn.py\", line 369, in <module>\r\n    cws = SegDNN(constant.VOCAB_SIZE, embed_size, constant.DNN_SKIP_WINDOW)\r\n  File \"D:/Learning/master_project/clinicalText/SourceCode/Python/DNN_CWS/seg_dnn.py\", line 76, in __init__\r\n    self.loss = tf.reduce_sum(tf.matmul(self.slim_map_matrix,tf.expand_dims(tf.transpose(self.word_score),2),a_is_sparse=True))\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\ops\\math_ops.py\", line 1755, in matmul\r\n    a = ops.convert_to_tensor(a, name=\"a\")\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 639, in convert_to_tensor\r\n    as_ref=False)\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 704, in internal_convert_to_tensor\r\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\constant_op.py\", line 113, in _constant_tensor_conversion_function\r\n    return constant(v, dtype=dtype, name=name)\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\constant_op.py\", line 102, in constant\r\n    tensor_util.make_tensor_proto(value, dtype=dtype, shape=shape, verify_shape=verify_shape))\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\tensor_util.py\", line 444, in make_tensor_proto\r\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\framework\\tensor_util.py\", line 444, in <listcomp>\r\n    tensor_proto.string_val.extend([compat.as_bytes(x) for x in proto_values])\r\n  File \"E:\\IntelPython35\\envs\\tensorflow-intel\\lib\\site-packages\\tensorflow\\python\\util\\compat.py\", line 65, in as_bytes\r\n    (bytes_or_text,))\r\nTypeError: Expected binary or unicode string, got <tensorflow.python.framework.sparse_tensor.SparseTensor object at 0x00000195FA86B1D0>\r\n\r\n```\r\n\r\nchange the `z` to \r\n```python\r\nz = tf.sparse_tensor_dense_matmul(x,y)\r\n```\r\nalso failed because the shape of sparse must 2-D,but `x`and`b`has 3-D"}