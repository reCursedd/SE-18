{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/256124328", "html_url": "https://github.com/tensorflow/tensorflow/issues/5117#issuecomment-256124328", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5117", "id": 256124328, "node_id": "MDEyOklzc3VlQ29tbWVudDI1NjEyNDMyOA==", "user": {"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}, "created_at": "2016-10-25T18:24:00Z", "updated_at": "2016-10-25T18:24:00Z", "author_association": "CONTRIBUTOR", "body_html": "<p>When you call tf.gradiwnts, there's an option collocate_with_...  Do you<br>\nenable it?</p>\n<p>On Oct 21, 2016 8:24 AM, \"yhg0112\" <a href=\"mailto:notifications@github.com\">notifications@github.com</a> wrote:</p>\n<blockquote>\n<p>Environment info</p>\n<p>tensorflow branch : 0.11.0rc0<br>\nCUDA version : 7.0<br>\ncuDNN version : 6.5.48<br>\nOS version : Ubuntu 14.04.5 LTS<br>\nGPU : GPU0 titan x(maxwell), GPU1 Tesla K20c(not using in this code)<br>\n(Also using anaconda2 environment and Jupyter with tf.InteractiveSession())<br>\nThe bug (or is this intended error?)</p>\n<p>I was using tf.scan() and tf.map() to code seq-2-seq encoder decoder<br>\nstructure with attention mechanism.<br>\nWhen i tried to put scanned tensor in map_fn() inside another scan(), the<br>\ngraph is drawn as normally and i even can evaluate the value of output<br>\ntensor.</p>\n<p>However when i try to optimize, or get gradient of that tensor, the bug<br>\npops up saying InvalidArgumentError: Cannot assign a device to node<br>\n'gradients/scan_1/while/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc':<br>\nCould not satisfy explicit device specification '' because the node was<br>\ncolocated with a group of nodes that required incompatible device<br>\n'/job:localhost/replica:0/task:0/GPU:0.</p>\n<p>I tried config.allow_soft_placement = True, but it only changed the error<br>\nlog and didn't work.<br>\nIt was really awkward that the error log complains about AttrValue must<br>\nnot be the value of DT_STRING_REF when i set config.allow_soft_placement<br>\n= True</p>\n<p>My code is like ,in simplified version ,following : (i wrote a<br>\nbug-reproducing example code at the bottom)<br>\nencoder_states = tf.scan(_encoder_step, encoder_inputs,<br>\ninitializer=encoder_initial_states)<br>\ndecoder_states = tf.scan(_decoder_step, decoder_inputs,<br>\ninitializer=encoder_states[-1]</p>\n<p>, and in def _decoder_step(prev_h, inputs): i used tf.map_fn() to get<br>\naligned context of encoder states as attention mechanism in<br>\n<a href=\"https://arxiv.org/abs/1409.0473\" rel=\"nofollow\">https://arxiv.org/abs/1409.0473</a>.</p>\n<p>It looks like following :<br>\nin _decoder_step(prev_h, inputs):</p>\n<pre><code>def alignment_model(inputs):\n    # prev_h has the shape of [num_layer, num_batch, num_hidden]; prev_h[0] is the value of the first layer in decoder.\n    alignment_state = tf.nn.tanh(_linear([inputs, prev_h[0], output_dim=num_slot, bias=False))\n    return _linear([alignment_state], output_dim=1, bias=False)\nalignment = tf.map_fn(alignment_model, encoder_states) # and here the bug comes.\n</code></pre>\n<p>error message</p>\n<p>with config.allow_soft_placement = False :</p>\n<p>InvalidArgumentError: Cannot assign a device to node 'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'<br>\nColocation Debug Info:<br>\nColocation group had the following types and devices:<br>\nTensorArrayWrite: GPU CPU<br>\nTensorArray: GPU CPU<br>\nStackPush: GPU CPU<br>\nTensorArrayRead: GPU CPU<br>\nRange: GPU CPU<br>\nStack: GPU CPU<br>\nStackPop: GPU CPU<br>\nConst: GPU CPU<br>\nTensorArrayScatter: GPU CPU<br>\nRefEnter: GPU CPU<br>\nEnter: GPU CPU<br>\nTensorArrayGather: GPU CPU<br>\nStridedSlice: GPU CPU<br>\nTensorArrayGrad: GPU CPU<br>\nIdentity: GPU CPU<br>\nShape: GPU CPU<br>\n[[Node: gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc = Stack<a href=\"\">_class=[\"loc:@Decoder/scan/while/Attention/map/TensorArray\"], elem_type=DT_INT32, stack_name=\"\"</a>]]</p>\n<p>Caused by op u'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc', defined at:<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 162, in _run_module_as_main<br>\n\"<strong>main</strong>\", fname, loader, pkg_name)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 72, in _run_code<br>\nexec code in run_globals<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/<strong>main</strong>.py\", line 3, in <br>\napp.launch_new_instance()<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/traitlets/config/application.py\", line 596, in launch_instance<br>\napp.start()<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 442, in start<br>\nioloop.IOLoop.instance().start()<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 162, in start<br>\nsuper(ZMQIOLoop, self).start()<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/ioloop.py\", line 883, in start<br>\nhandler_func(fd_obj, events)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/stack_context.py\", line 275, in null_wrapper<br>\nreturn fn(_args, *_kwargs)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events<br>\nself._handle_recv()<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv<br>\nself._run_callback(callback, msg)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback<br>\ncallback(_args, *_kwargs)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/stack_context.py\", line 275, in null_wrapper<br>\nreturn fn(_args, *_kwargs)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher<br>\nreturn self.dispatch_shell(stream, msg)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell<br>\nhandler(stream, idents, msg)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 391, in execute_request<br>\nuser_expressions, allow_stdin)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 199, in do_execute<br>\nshell.run_cell(code, store_history=store_history, silent=silent)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2723, in run_cell<br>\ninteractivity=interactivity, compiler=compiler, result=result)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2825, in run_ast_nodes<br>\nif self.run_code(code, result):<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code<br>\nexec(code_obj, self.user_global_ns, self.user_ns)<br>\nFile \"\", line 3, in <br>\ngrads, _ = tf.clip_by_global_norm(tf.gradients(model.loss, tvars, aggregation_method=tf.AggregationMethod.ADD_N), 1)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gradients.py\", line 469, in gradients<br>\nin_grads = _AsList(grad_fn(op, *out_grads))<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_grad.py\", line 213, in _TensorArrayScatterGrad<br>\ngrad = g.gather(indices)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 301, in gather<br>\nelement_shape=element_shape)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1302, in _tensor_array_gather<br>\nelement_shape=element_shape, name=name)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op<br>\nop_def=op_def)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op<br>\noriginal_op=self._default_original_op, op_def=op_def)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1302, in <strong>init</strong><br>\nself._control_flow_context.AddOp(self)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1941, in AddOp<br>\nself._AddOpInternal(op)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1965, in _AddOpInternal<br>\nself.AddValue(x)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1900, in AddValue<br>\nreal_val = grad_ctxt.grad_state.GetRealValue(val)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 987, in GetRealValue<br>\nhistory_value = cur_grad_state.AddForwardAccumulator(cur_value)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 861, in AddForwardAccumulator<br>\nacc = gen_data_flow_ops._stack(value.dtype.base_dtype, name=\"f_acc\")<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1104, in _stack<br>\nstack_name=stack_name, name=name)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op<br>\nop_def=op_def)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op<br>\noriginal_op=self._default_original_op, op_def=op_def)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1298, in <strong>init</strong><br>\nself._traceback = _extract_stack()</p>\n<p>...which was originally created as op u'Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter', defined at:<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 162, in _run_module_as_main<br>\n\"<strong>main</strong>\", fname, loader, pkg_name)<br>\n[elided 17 identical lines from previous traceback]<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code<br>\nexec(code_obj, self.user_global_ns, self.user_ns)<br>\nFile \"\", line 6, in <br>\nnum_slot=_num_slot)<br>\nFile \"\", line 34, in <strong>init</strong><br>\ninitializer=self.decoder_initial_states) # shape of [time, num_layer, batch, num_hidden]<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 563, in scan<br>\nback_prop=back_prop, swap_memory=swap_memory)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2518, in while_loop<br>\nresult = context.BuildLoop(cond, body, loop_vars, shape_invariants)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2356, in BuildLoop<br>\npred, body, original_loop_vars, loop_vars, shape_invariants)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2306, in _BuildLoop<br>\nbody_result = body(*packed_vars_for_body)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 553, in compute<br>\na_out = fn(packed_a, packed_elems)<br>\nFile \"\", line 98, in _decoder_step<br>\ncontext = self._get_context(encoder_last_states, states[0])<br>\nFile \"\", line 81, in _get_context<br>\nalignment = tf.map_fn(alignment_hidden_layer, encoder_states) # shape of [time, batch, 1]<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 333, in map_fn<br>\nelem_ta.unpack(elem) for elem_ta, elem in zip(elems_ta, elems_flat)]<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 391, in unpack<br>\nindices=math_ops.range(0, num_elements), value=value, name=name)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 412, in scatter<br>\nname=name)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1447, in _tensor_array_scatter<br>\nname=name)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op<br>\nop_def=op_def)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op<br>\noriginal_op=self._default_original_op, op_def=op_def)<br>\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1298, in <strong>init</strong><br>\nself._traceback = _extract_stack()</p>\n<p>InvalidArgumentError (see above for traceback): Cannot assign a device to node 'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'<br>\nColocation Debug Info:<br>\nColocation group had the following types and devices:<br>\nTensorArrayWrite: GPU CPU<br>\nTensorArray: GPU CPU<br>\nStackPush: GPU CPU<br>\nTensorArrayRead: GPU CPU<br>\nRange: GPU CPU<br>\nStack: GPU CPU<br>\nStackPop: GPU CPU<br>\nConst: GPU CPU<br>\nTensorArrayScatter: GPU CPU<br>\nRefEnter: GPU CPU<br>\nEnter: GPU CPU<br>\nTensorArrayGather: GPU CPU<br>\nStridedSlice: GPU CPU<br>\nTensorArrayGrad: GPU CPU<br>\nIdentity: GPU CPU<br>\nShape: GPU CPU<br>\n[[Node: gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc = Stack<a href=\"\">_class=[\"loc:@Decoder/scan/while/Attention/map/TensorArray\"], elem_type=DT_INT32, stack_name=\"\"</a>]]</p>\n<p>with config.allow_soft_placement = True:</p>\n<p>InvalidArgumentError: AttrValue must not have reference type value of string_ref<br>\nfor attr 'tensor_type'<br>\n; NodeDef: scan_1/while/map/TensorArray/_211 = _Recv<a href=\"%5E_cloopscan_1/while/map/TensorArrayPack_1/range/delta/_37\">_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_666_scan_1/while/map/TensorArray\", tensor_type=DT_STRING_REF, _device=\"/job:localhost/replica:0/task:0/cpu:0\"</a>; Op&lt;name=_Recv; signature= -&gt; tensor:tensor_type; attr=tensor_type:type; attr=tensor_name:string; attr=send_device:string; attr=send_device_incarnation:int; attr=recv_device:string; attr=client_terminated:bool,default=false; is_stateful=true&gt;<br>\n[[Node: scan_1/while/map/TensorArray/_211 = _Recv<a href=\"%5E_cloopscan_1/while/map/TensorArrayPack_1/range/delta/_37\">_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_666_scan_1/while/map/TensorArray\", tensor_type=DT_STRING_REF, _device=\"/job:localhost/replica:0/task:0/cpu:0\"</a>]]</p>\n<p>reproducible example code</p>\n<p>import tensorflow as tf<br>\nimport numpy as np</p>\n<p>in_data_for_pre_scan = np.ones(shape=[2, 8, 5], dtype=np.float64)<br>\nin_data_for_post_scan = np.ones(shape=[2, 8, 5], dtype=np.float64)<br>\ninitial_state_data_for_pre_scan = np.zeros(shape=[8, 5], dtype=np.float64)<br>\ninitials_state_data_for_post_scan = np.zeros(shape=[8, 5], dtype=np.float64)</p>\n<p>inputs_for_pre_scan = tf.placeholder(shape=[None, None, 5], dtype=tf.float64)<br>\ninputs_for_post_scan = tf.placeholder(shape=[None, None, 5], dtype=tf.float64)<br>\ninitial_state_for_pre_scan = tf.placeholder(shape=[None, 5], dtype=tf.float64)<br>\ninitial_state_for_post_scan = tf.placeholder(shape=[None, 5], dtype=tf.float64)</p>\n<p>weight = tf.get_variable('W', [5, 5], dtype=tf.float64)</p>\n<p>def pre_scan(states, inputs):<br>\nreturn states + tf.matmul(inputs, weight)</p>\n<p>def post_scan(states, inputs):<br>\ndef inner_map(inputs):<br>\nreturn inputs<br>\nloop_output = tf.map_fn(inner_map, pre_scanned[0])</p>\n<pre><code>return states + loop_output + inputs\n</code></pre>\n<p>pre_scanned = tf.scan(pre_scan, inputs_for_pre_scan, initializer=initial_state_for_pre_scan)<br>\nres = tf.scan(post_scan, inputs_for_post_scan, initializer=initial_state_for_post_scan)</p>\n<p>opt_func = tf.train.AdamOptimizer()<br>\ntvars = tf.trainable_variables()<br>\ngrads, _ = tf.clip_by_global_norm(tf.gradients(tf.reduce_mean(tf.square(res)), tvars, aggregation_method=tf.AggregationMethod.ADD_N), 1)<br>\noptimizer = opt_func.apply_gradients(zip(grads, tvars))</p>\n<p>config = tf.ConfigProto()<br>\nconfig.gpu_options.allow_growth = True<br>\n#config.allow_soft_placement = True<br>\nsess = tf.InteractiveSession(config=config)<br>\nsess.run(tf.initialize_all_variables())</p>\n<p>sess.run(res, feed_dict={inputs_for_pre_scan:in_data_for_pre_scan,<br>\ninitial_state_for_pre_scan:initial_state_data_for_pre_scan,<br>\ninputs_for_post_scan:in_data_for_post_scan,<br>\ninitial_state_for_post_scan:initials_state_data_for_post_scan}) # this runs as just fine.</p>\n<p>sess.run(optimizer, feed_dict={inputs_for_pre_scan:in_data_for_pre_scan,<br>\ninitial_state_for_pre_scan:initial_state_data_for_pre_scan,<br>\ninputs_for_post_scan:in_data_for_post_scan,<br>\ninitial_state_for_post_scan:initials_state_data_for_post_scan}) # this doesn't work.</p>\n<p>The log says about 'scatter()' in 'ops/tensor_array_ops.py' and _tensor_array_scatter'<br>\ninops/gen_data_flow_ops.py`, which is written in this branch.</p>\n<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1794715\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ebrevdo\">@ebrevdo</a> <a href=\"https://github.com/ebrevdo\">https://github.com/ebrevdo</a> would you get me some hints about<br>\nthis?</p>\n<p>\u2014<br>\nYou are receiving this because you were mentioned.<br>\nReply to this email directly, view it on GitHub<br>\n<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"184513162\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/5117\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/5117/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/5117\">#5117</a>, or mute the thread<br>\n<a href=\"https://github.com/notifications/unsubscribe-auth/ABtim8SbUObZ5JPp0bRIVlbjfFw2UlLHks5q2NlBgaJpZM4KdWKH\">https://github.com/notifications/unsubscribe-auth/ABtim8SbUObZ5JPp0bRIVlbjfFw2UlLHks5q2NlBgaJpZM4KdWKH</a><br>\n.</p>\n</blockquote>", "body_text": "When you call tf.gradiwnts, there's an option collocate_with_...  Do you\nenable it?\nOn Oct 21, 2016 8:24 AM, \"yhg0112\" notifications@github.com wrote:\n\nEnvironment info\ntensorflow branch : 0.11.0rc0\nCUDA version : 7.0\ncuDNN version : 6.5.48\nOS version : Ubuntu 14.04.5 LTS\nGPU : GPU0 titan x(maxwell), GPU1 Tesla K20c(not using in this code)\n(Also using anaconda2 environment and Jupyter with tf.InteractiveSession())\nThe bug (or is this intended error?)\nI was using tf.scan() and tf.map() to code seq-2-seq encoder decoder\nstructure with attention mechanism.\nWhen i tried to put scanned tensor in map_fn() inside another scan(), the\ngraph is drawn as normally and i even can evaluate the value of output\ntensor.\nHowever when i try to optimize, or get gradient of that tensor, the bug\npops up saying InvalidArgumentError: Cannot assign a device to node\n'gradients/scan_1/while/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc':\nCould not satisfy explicit device specification '' because the node was\ncolocated with a group of nodes that required incompatible device\n'/job:localhost/replica:0/task:0/GPU:0.\nI tried config.allow_soft_placement = True, but it only changed the error\nlog and didn't work.\nIt was really awkward that the error log complains about AttrValue must\nnot be the value of DT_STRING_REF when i set config.allow_soft_placement\n= True\nMy code is like ,in simplified version ,following : (i wrote a\nbug-reproducing example code at the bottom)\nencoder_states = tf.scan(_encoder_step, encoder_inputs,\ninitializer=encoder_initial_states)\ndecoder_states = tf.scan(_decoder_step, decoder_inputs,\ninitializer=encoder_states[-1]\n, and in def _decoder_step(prev_h, inputs): i used tf.map_fn() to get\naligned context of encoder states as attention mechanism in\nhttps://arxiv.org/abs/1409.0473.\nIt looks like following :\nin _decoder_step(prev_h, inputs):\ndef alignment_model(inputs):\n    # prev_h has the shape of [num_layer, num_batch, num_hidden]; prev_h[0] is the value of the first layer in decoder.\n    alignment_state = tf.nn.tanh(_linear([inputs, prev_h[0], output_dim=num_slot, bias=False))\n    return _linear([alignment_state], output_dim=1, bias=False)\nalignment = tf.map_fn(alignment_model, encoder_states) # and here the bug comes.\n\nerror message\nwith config.allow_soft_placement = False :\nInvalidArgumentError: Cannot assign a device to node 'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'\nColocation Debug Info:\nColocation group had the following types and devices:\nTensorArrayWrite: GPU CPU\nTensorArray: GPU CPU\nStackPush: GPU CPU\nTensorArrayRead: GPU CPU\nRange: GPU CPU\nStack: GPU CPU\nStackPop: GPU CPU\nConst: GPU CPU\nTensorArrayScatter: GPU CPU\nRefEnter: GPU CPU\nEnter: GPU CPU\nTensorArrayGather: GPU CPU\nStridedSlice: GPU CPU\nTensorArrayGrad: GPU CPU\nIdentity: GPU CPU\nShape: GPU CPU\n[[Node: gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc = Stack_class=[\"loc:@Decoder/scan/while/Attention/map/TensorArray\"], elem_type=DT_INT32, stack_name=\"\"]]\nCaused by op u'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc', defined at:\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n\"main\", fname, loader, pkg_name)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 72, in _run_code\nexec code in run_globals\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/main.py\", line 3, in \napp.launch_new_instance()\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/traitlets/config/application.py\", line 596, in launch_instance\napp.start()\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 442, in start\nioloop.IOLoop.instance().start()\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 162, in start\nsuper(ZMQIOLoop, self).start()\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/ioloop.py\", line 883, in start\nhandler_func(fd_obj, events)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\nreturn fn(_args, *_kwargs)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\nself._handle_recv()\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\nself._run_callback(callback, msg)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\ncallback(_args, *_kwargs)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\nreturn fn(_args, *_kwargs)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\nreturn self.dispatch_shell(stream, msg)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\nhandler(stream, idents, msg)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 391, in execute_request\nuser_expressions, allow_stdin)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 199, in do_execute\nshell.run_cell(code, store_history=store_history, silent=silent)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2723, in run_cell\ninteractivity=interactivity, compiler=compiler, result=result)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2825, in run_ast_nodes\nif self.run_code(code, result):\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code\nexec(code_obj, self.user_global_ns, self.user_ns)\nFile \"\", line 3, in \ngrads, _ = tf.clip_by_global_norm(tf.gradients(model.loss, tvars, aggregation_method=tf.AggregationMethod.ADD_N), 1)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gradients.py\", line 469, in gradients\nin_grads = _AsList(grad_fn(op, *out_grads))\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_grad.py\", line 213, in _TensorArrayScatterGrad\ngrad = g.gather(indices)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 301, in gather\nelement_shape=element_shape)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1302, in _tensor_array_gather\nelement_shape=element_shape, name=name)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\nop_def=op_def)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\noriginal_op=self._default_original_op, op_def=op_def)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1302, in init\nself._control_flow_context.AddOp(self)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1941, in AddOp\nself._AddOpInternal(op)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1965, in _AddOpInternal\nself.AddValue(x)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1900, in AddValue\nreal_val = grad_ctxt.grad_state.GetRealValue(val)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 987, in GetRealValue\nhistory_value = cur_grad_state.AddForwardAccumulator(cur_value)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 861, in AddForwardAccumulator\nacc = gen_data_flow_ops._stack(value.dtype.base_dtype, name=\"f_acc\")\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1104, in _stack\nstack_name=stack_name, name=name)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\nop_def=op_def)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\noriginal_op=self._default_original_op, op_def=op_def)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1298, in init\nself._traceback = _extract_stack()\n...which was originally created as op u'Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter', defined at:\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n\"main\", fname, loader, pkg_name)\n[elided 17 identical lines from previous traceback]\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code\nexec(code_obj, self.user_global_ns, self.user_ns)\nFile \"\", line 6, in \nnum_slot=_num_slot)\nFile \"\", line 34, in init\ninitializer=self.decoder_initial_states) # shape of [time, num_layer, batch, num_hidden]\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 563, in scan\nback_prop=back_prop, swap_memory=swap_memory)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2518, in while_loop\nresult = context.BuildLoop(cond, body, loop_vars, shape_invariants)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2356, in BuildLoop\npred, body, original_loop_vars, loop_vars, shape_invariants)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2306, in _BuildLoop\nbody_result = body(*packed_vars_for_body)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 553, in compute\na_out = fn(packed_a, packed_elems)\nFile \"\", line 98, in _decoder_step\ncontext = self._get_context(encoder_last_states, states[0])\nFile \"\", line 81, in _get_context\nalignment = tf.map_fn(alignment_hidden_layer, encoder_states) # shape of [time, batch, 1]\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 333, in map_fn\nelem_ta.unpack(elem) for elem_ta, elem in zip(elems_ta, elems_flat)]\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 391, in unpack\nindices=math_ops.range(0, num_elements), value=value, name=name)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 412, in scatter\nname=name)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1447, in _tensor_array_scatter\nname=name)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\nop_def=op_def)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\noriginal_op=self._default_original_op, op_def=op_def)\nFile \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1298, in init\nself._traceback = _extract_stack()\nInvalidArgumentError (see above for traceback): Cannot assign a device to node 'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'\nColocation Debug Info:\nColocation group had the following types and devices:\nTensorArrayWrite: GPU CPU\nTensorArray: GPU CPU\nStackPush: GPU CPU\nTensorArrayRead: GPU CPU\nRange: GPU CPU\nStack: GPU CPU\nStackPop: GPU CPU\nConst: GPU CPU\nTensorArrayScatter: GPU CPU\nRefEnter: GPU CPU\nEnter: GPU CPU\nTensorArrayGather: GPU CPU\nStridedSlice: GPU CPU\nTensorArrayGrad: GPU CPU\nIdentity: GPU CPU\nShape: GPU CPU\n[[Node: gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc = Stack_class=[\"loc:@Decoder/scan/while/Attention/map/TensorArray\"], elem_type=DT_INT32, stack_name=\"\"]]\nwith config.allow_soft_placement = True:\nInvalidArgumentError: AttrValue must not have reference type value of string_ref\nfor attr 'tensor_type'\n; NodeDef: scan_1/while/map/TensorArray/_211 = _Recv_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_666_scan_1/while/map/TensorArray\", tensor_type=DT_STRING_REF, _device=\"/job:localhost/replica:0/task:0/cpu:0\"; Op<name=_Recv; signature= -> tensor:tensor_type; attr=tensor_type:type; attr=tensor_name:string; attr=send_device:string; attr=send_device_incarnation:int; attr=recv_device:string; attr=client_terminated:bool,default=false; is_stateful=true>\n[[Node: scan_1/while/map/TensorArray/_211 = _Recv_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_666_scan_1/while/map/TensorArray\", tensor_type=DT_STRING_REF, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]]\nreproducible example code\nimport tensorflow as tf\nimport numpy as np\nin_data_for_pre_scan = np.ones(shape=[2, 8, 5], dtype=np.float64)\nin_data_for_post_scan = np.ones(shape=[2, 8, 5], dtype=np.float64)\ninitial_state_data_for_pre_scan = np.zeros(shape=[8, 5], dtype=np.float64)\ninitials_state_data_for_post_scan = np.zeros(shape=[8, 5], dtype=np.float64)\ninputs_for_pre_scan = tf.placeholder(shape=[None, None, 5], dtype=tf.float64)\ninputs_for_post_scan = tf.placeholder(shape=[None, None, 5], dtype=tf.float64)\ninitial_state_for_pre_scan = tf.placeholder(shape=[None, 5], dtype=tf.float64)\ninitial_state_for_post_scan = tf.placeholder(shape=[None, 5], dtype=tf.float64)\nweight = tf.get_variable('W', [5, 5], dtype=tf.float64)\ndef pre_scan(states, inputs):\nreturn states + tf.matmul(inputs, weight)\ndef post_scan(states, inputs):\ndef inner_map(inputs):\nreturn inputs\nloop_output = tf.map_fn(inner_map, pre_scanned[0])\nreturn states + loop_output + inputs\n\npre_scanned = tf.scan(pre_scan, inputs_for_pre_scan, initializer=initial_state_for_pre_scan)\nres = tf.scan(post_scan, inputs_for_post_scan, initializer=initial_state_for_post_scan)\nopt_func = tf.train.AdamOptimizer()\ntvars = tf.trainable_variables()\ngrads, _ = tf.clip_by_global_norm(tf.gradients(tf.reduce_mean(tf.square(res)), tvars, aggregation_method=tf.AggregationMethod.ADD_N), 1)\noptimizer = opt_func.apply_gradients(zip(grads, tvars))\nconfig = tf.ConfigProto()\nconfig.gpu_options.allow_growth = True\n#config.allow_soft_placement = True\nsess = tf.InteractiveSession(config=config)\nsess.run(tf.initialize_all_variables())\nsess.run(res, feed_dict={inputs_for_pre_scan:in_data_for_pre_scan,\ninitial_state_for_pre_scan:initial_state_data_for_pre_scan,\ninputs_for_post_scan:in_data_for_post_scan,\ninitial_state_for_post_scan:initials_state_data_for_post_scan}) # this runs as just fine.\nsess.run(optimizer, feed_dict={inputs_for_pre_scan:in_data_for_pre_scan,\ninitial_state_for_pre_scan:initial_state_data_for_pre_scan,\ninputs_for_post_scan:in_data_for_post_scan,\ninitial_state_for_post_scan:initials_state_data_for_post_scan}) # this doesn't work.\nThe log says about 'scatter()' in 'ops/tensor_array_ops.py' and _tensor_array_scatter'\ninops/gen_data_flow_ops.py`, which is written in this branch.\n@ebrevdo https://github.com/ebrevdo would you get me some hints about\nthis?\n\u2014\nYou are receiving this because you were mentioned.\nReply to this email directly, view it on GitHub\n#5117, or mute the thread\nhttps://github.com/notifications/unsubscribe-auth/ABtim8SbUObZ5JPp0bRIVlbjfFw2UlLHks5q2NlBgaJpZM4KdWKH\n.", "body": "When you call tf.gradiwnts, there's an option collocate_with_...  Do you\nenable it?\n\nOn Oct 21, 2016 8:24 AM, \"yhg0112\" notifications@github.com wrote:\n\n> Environment info\n> \n> tensorflow branch : 0.11.0rc0\n> CUDA version : 7.0\n> cuDNN version : 6.5.48\n> OS version : Ubuntu 14.04.5 LTS\n> GPU : GPU0 titan x(maxwell), GPU1 Tesla K20c(not using in this code)\n> (Also using anaconda2 environment and Jupyter with tf.InteractiveSession())\n> The bug (or is this intended error?)\n> \n> I was using tf.scan() and tf.map() to code seq-2-seq encoder decoder\n> structure with attention mechanism.\n> When i tried to put scanned tensor in map_fn() inside another scan(), the\n> graph is drawn as normally and i even can evaluate the value of output\n> tensor.\n> \n> However when i try to optimize, or get gradient of that tensor, the bug\n> pops up saying InvalidArgumentError: Cannot assign a device to node\n> 'gradients/scan_1/while/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc':\n> Could not satisfy explicit device specification '' because the node was\n> colocated with a group of nodes that required incompatible device\n> '/job:localhost/replica:0/task:0/GPU:0.\n> \n> I tried config.allow_soft_placement = True, but it only changed the error\n> log and didn't work.\n> It was really awkward that the error log complains about AttrValue must\n> not be the value of DT_STRING_REF when i set config.allow_soft_placement\n> = True\n> \n> My code is like ,in simplified version ,following : (i wrote a\n> bug-reproducing example code at the bottom)\n> encoder_states = tf.scan(_encoder_step, encoder_inputs,\n> initializer=encoder_initial_states)\n> decoder_states = tf.scan(_decoder_step, decoder_inputs,\n> initializer=encoder_states[-1]\n> \n> , and in def _decoder_step(prev_h, inputs): i used tf.map_fn() to get\n> aligned context of encoder states as attention mechanism in\n> https://arxiv.org/abs/1409.0473.\n> \n> It looks like following :\n> in _decoder_step(prev_h, inputs):\n> \n> ```\n> def alignment_model(inputs):\n>     # prev_h has the shape of [num_layer, num_batch, num_hidden]; prev_h[0] is the value of the first layer in decoder.\n>     alignment_state = tf.nn.tanh(_linear([inputs, prev_h[0], output_dim=num_slot, bias=False))\n>     return _linear([alignment_state], output_dim=1, bias=False)\n> alignment = tf.map_fn(alignment_model, encoder_states) # and here the bug comes.\n> ```\n> \n> error message\n> \n> with config.allow_soft_placement = False :\n> \n> InvalidArgumentError: Cannot assign a device to node 'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'\n> Colocation Debug Info:\n> Colocation group had the following types and devices:\n> TensorArrayWrite: GPU CPU\n> TensorArray: GPU CPU\n> StackPush: GPU CPU\n> TensorArrayRead: GPU CPU\n> Range: GPU CPU\n> Stack: GPU CPU\n> StackPop: GPU CPU\n> Const: GPU CPU\n> TensorArrayScatter: GPU CPU\n> RefEnter: GPU CPU\n> Enter: GPU CPU\n> TensorArrayGather: GPU CPU\n> StridedSlice: GPU CPU\n> TensorArrayGrad: GPU CPU\n> Identity: GPU CPU\n> Shape: GPU CPU\n>      [[Node: gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc = Stack[_class=[\"loc:@Decoder/scan/while/Attention/map/TensorArray\"], elem_type=DT_INT32, stack_name=\"\"]()]]\n> \n> Caused by op u'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc', defined at:\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n>     \"__main__\", fname, loader, pkg_name)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 72, in _run_code\n>     exec code in run_globals\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/__main__.py\", line 3, in <module>\n>     app.launch_new_instance()\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/traitlets/config/application.py\", line 596, in launch_instance\n>     app.start()\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelapp.py\", line 442, in start\n>     ioloop.IOLoop.instance().start()\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/ioloop.py\", line 162, in start\n>     super(ZMQIOLoop, self).start()\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/ioloop.py\", line 883, in start\n>     handler_func(fd_obj, events)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n>     return fn(_args, *_kwargs)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\n>     self._handle_recv()\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\n>     self._run_callback(callback, msg)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\n>     callback(_args, *_kwargs)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n>     return fn(_args, *_kwargs)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n>     return self.dispatch_shell(stream, msg)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n>     handler(stream, idents, msg)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/kernelbase.py\", line 391, in execute_request\n>     user_expressions, allow_stdin)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/ipykernel/ipkernel.py\", line 199, in do_execute\n>     shell.run_cell(code, store_history=store_history, silent=silent)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2723, in run_cell\n>     interactivity=interactivity, compiler=compiler, result=result)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2825, in run_ast_nodes\n>     if self.run_code(code, result):\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code\n>     exec(code_obj, self.user_global_ns, self.user_ns)\n>   File \"<ipython-input-16-940fe231159a>\", line 3, in <module>\n>     grads, _ = tf.clip_by_global_norm(tf.gradients(model.loss, tvars, aggregation_method=tf.AggregationMethod.ADD_N), 1)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gradients.py\", line 469, in gradients\n>     in_grads = _AsList(grad_fn(op, *out_grads))\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_grad.py\", line 213, in _TensorArrayScatterGrad\n>     grad = g.gather(indices)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 301, in gather\n>     element_shape=element_shape)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1302, in _tensor_array_gather\n>     element_shape=element_shape, name=name)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n>     op_def=op_def)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n>     original_op=self._default_original_op, op_def=op_def)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1302, in __init__\n>     self._control_flow_context.AddOp(self)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1941, in AddOp\n>     self._AddOpInternal(op)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1965, in _AddOpInternal\n>     self.AddValue(x)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1900, in AddValue\n>     real_val = grad_ctxt.grad_state.GetRealValue(val)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 987, in GetRealValue\n>     history_value = cur_grad_state.AddForwardAccumulator(cur_value)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 861, in AddForwardAccumulator\n>     acc = gen_data_flow_ops._stack(value.dtype.base_dtype, name=\"f_acc\")\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1104, in _stack\n>     stack_name=stack_name, name=name)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n>     op_def=op_def)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n>     original_op=self._default_original_op, op_def=op_def)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n>     self._traceback = _extract_stack()\n> \n> ...which was originally created as op u'Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter', defined at:\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/runpy.py\", line 162, in _run_module_as_main\n>     \"__main__\", fname, loader, pkg_name)\n> [elided 17 identical lines from previous traceback]\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code\n>     exec(code_obj, self.user_global_ns, self.user_ns)\n>   File \"<ipython-input-15-153e1e7c7c3b>\", line 6, in <module>\n>     num_slot=_num_slot)\n>   File \"<ipython-input-13-1ccd26e81475>\", line 34, in __init__\n>     initializer=self.decoder_initial_states) # shape of [time, num_layer, batch, num_hidden]\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 563, in scan\n>     back_prop=back_prop, swap_memory=swap_memory)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2518, in while_loop\n>     result = context.BuildLoop(cond, body, loop_vars, shape_invariants)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2356, in BuildLoop\n>     pred, body, original_loop_vars, loop_vars, shape_invariants)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2306, in _BuildLoop\n>     body_result = body(*packed_vars_for_body)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 553, in compute\n>     a_out = fn(packed_a, packed_elems)\n>   File \"<ipython-input-13-1ccd26e81475>\", line 98, in _decoder_step\n>     context = self._get_context(encoder_last_states, states[0])\n>   File \"<ipython-input-13-1ccd26e81475>\", line 81, in _get_context\n>     alignment = tf.map_fn(alignment_hidden_layer, encoder_states) # shape of [time, batch, 1]\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/functional_ops.py\", line 333, in map_fn\n>     elem_ta.unpack(elem) for elem_ta, elem in zip(elems_ta, elems_flat)]\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 391, in unpack\n>     indices=math_ops.range(0, num_elements), value=value, name=name)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 412, in scatter\n>     name=name)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 1447, in _tensor_array_scatter\n>     name=name)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n>     op_def=op_def)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n>     original_op=self._default_original_op, op_def=op_def)\n>   File \"/home/youaredeadl/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n>     self._traceback = _extract_stack()\n> \n> InvalidArgumentError (see above for traceback): Cannot assign a device to node 'gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'\n> Colocation Debug Info:\n> Colocation group had the following types and devices:\n> TensorArrayWrite: GPU CPU\n> TensorArray: GPU CPU\n> StackPush: GPU CPU\n> TensorArrayRead: GPU CPU\n> Range: GPU CPU\n> Stack: GPU CPU\n> StackPop: GPU CPU\n> Const: GPU CPU\n> TensorArrayScatter: GPU CPU\n> RefEnter: GPU CPU\n> Enter: GPU CPU\n> TensorArrayGather: GPU CPU\n> StridedSlice: GPU CPU\n> TensorArrayGrad: GPU CPU\n> Identity: GPU CPU\n> Shape: GPU CPU\n>      [[Node: gradients/Decoder/scan/while/Attention/map/TensorArrayPack/TensorArrayScatter_grad/TensorArrayGather/f_acc = Stack[_class=[\"loc:@Decoder/scan/while/Attention/map/TensorArray\"], elem_type=DT_INT32, stack_name=\"\"]()]]\n> \n> with config.allow_soft_placement = True:\n> \n> InvalidArgumentError: AttrValue must not have reference type value of string_ref\n>      for attr 'tensor_type'\n>     ; NodeDef: scan_1/while/map/TensorArray/_211 = _Recv[_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_666_scan_1/while/map/TensorArray\", tensor_type=DT_STRING_REF, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](^_cloopscan_1/while/map/TensorArrayPack_1/range/delta/_37); Op<name=_Recv; signature= -> tensor:tensor_type; attr=tensor_type:type; attr=tensor_name:string; attr=send_device:string; attr=send_device_incarnation:int; attr=recv_device:string; attr=client_terminated:bool,default=false; is_stateful=true>\n>      [[Node: scan_1/while/map/TensorArray/_211 = _Recv[_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_666_scan_1/while/map/TensorArray\", tensor_type=DT_STRING_REF, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](^_cloopscan_1/while/map/TensorArrayPack_1/range/delta/_37)]]\n> \n> reproducible example code\n> \n> import tensorflow as tf\n> import numpy as np\n> \n> in_data_for_pre_scan = np.ones(shape=[2, 8, 5], dtype=np.float64)\n> in_data_for_post_scan = np.ones(shape=[2, 8, 5], dtype=np.float64)\n> initial_state_data_for_pre_scan = np.zeros(shape=[8, 5], dtype=np.float64)\n> initials_state_data_for_post_scan = np.zeros(shape=[8, 5], dtype=np.float64)\n> \n> inputs_for_pre_scan = tf.placeholder(shape=[None, None, 5], dtype=tf.float64)\n> inputs_for_post_scan = tf.placeholder(shape=[None, None, 5], dtype=tf.float64)\n> initial_state_for_pre_scan = tf.placeholder(shape=[None, 5], dtype=tf.float64)\n> initial_state_for_post_scan = tf.placeholder(shape=[None, 5], dtype=tf.float64)\n> \n> weight = tf.get_variable('W', [5, 5], dtype=tf.float64)\n> \n> def pre_scan(states, inputs):\n>     return states + tf.matmul(inputs, weight)\n> \n> def post_scan(states, inputs):\n>     def inner_map(inputs):\n>         return inputs\n>     loop_output = tf.map_fn(inner_map, pre_scanned[0])\n> \n> ```\n> return states + loop_output + inputs\n> ```\n> \n> pre_scanned = tf.scan(pre_scan, inputs_for_pre_scan, initializer=initial_state_for_pre_scan)\n> res = tf.scan(post_scan, inputs_for_post_scan, initializer=initial_state_for_post_scan)\n> \n> opt_func = tf.train.AdamOptimizer()\n> tvars = tf.trainable_variables()\n> grads, _ = tf.clip_by_global_norm(tf.gradients(tf.reduce_mean(tf.square(res)), tvars, aggregation_method=tf.AggregationMethod.ADD_N), 1)\n> optimizer = opt_func.apply_gradients(zip(grads, tvars))\n> \n> config = tf.ConfigProto()\n> config.gpu_options.allow_growth = True\n> #config.allow_soft_placement = True\n> sess = tf.InteractiveSession(config=config)\n> sess.run(tf.initialize_all_variables())\n> \n> sess.run(res, feed_dict={inputs_for_pre_scan:in_data_for_pre_scan,\n>                          initial_state_for_pre_scan:initial_state_data_for_pre_scan,\n>                          inputs_for_post_scan:in_data_for_post_scan,\n>                          initial_state_for_post_scan:initials_state_data_for_post_scan}) # this runs as just fine.\n> \n> sess.run(optimizer, feed_dict={inputs_for_pre_scan:in_data_for_pre_scan,\n>                                initial_state_for_pre_scan:initial_state_data_for_pre_scan,\n>                                inputs_for_post_scan:in_data_for_post_scan,\n>                                initial_state_for_post_scan:initials_state_data_for_post_scan}) # this doesn't work.\n> \n> The log says about 'scatter()' in 'ops/tensor_array_ops.py' and _tensor_array_scatter'\n> inops/gen_data_flow_ops.py`, which is written in this branch.\n> \n> @ebrevdo https://github.com/ebrevdo would you get me some hints about\n> this?\n> \n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> https://github.com/tensorflow/tensorflow/issues/5117, or mute the thread\n> https://github.com/notifications/unsubscribe-auth/ABtim8SbUObZ5JPp0bRIVlbjfFw2UlLHks5q2NlBgaJpZM4KdWKH\n> .\n"}