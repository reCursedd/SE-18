{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/151311193", "pull_request_review_id": 76998307, "id": 151311193, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1MTMxMTE5Mw==", "diff_hunk": "@@ -115,6 +115,57 @@ void RdmaMgr::SetupChannels() {\n   }\n }\n \n+// Check connectivity by pinging every channel\n+bool RdmaMgr::ConnectivityCheck() {\n+  int i, rcnt = 0, scnt = 0;\n+\n+  for (const auto& p : channel_table_) {\n+    string worker_name = p.first;\n+    RdmaChannel* rc = p.second;\n+\n+    VLOG(2) << \"Ping to \" << worker_name;\n+    CHECK(rc->PingPostSend() == 0) << \"Couldn't post send  to \" << worker_name\n+                                   << \" with error: \" << std::strerror(errno);\n+    for (i = 0; i < rc->adapter_->params_.queue_depth - 1; i++) {\n+      rc->Recv();\n+    }\n+  }\n+\n+  while (rcnt < num_remote_workers_ || scnt < num_remote_workers_) {\n+    int ne;\n+    do {\n+      ne = ibv_poll_cq(rdma_adapter_->cq_, 2 * num_remote_workers_,\n+                       rdma_adapter_->wc_);\n+      CHECK(ne >= 0) << \"poll CQ failed \" << ne << \"with error\"\n+                     << std::strerror(errno);\n+    } while (ne < 1);\n+\n+    for (i = 0; i < ne; ++i) {\n+      ibv_wc_status s = rdma_adapter_->wc_[i].status;\n+      // recv complete\n+      if ((int)rdma_adapter_->wc_[i].wr_id == RdmaChannel::PingRecvWrid) {\n+        CHECK(s == IBV_WC_SUCCESS) << \": \" << ibv_wc_status_str(\n+                                                  rdma_adapter_->wc_[i].status)\n+                                   << \"(\" << rdma_adapter_->wc_[i].status\n+                                   << \") for PING_RECV_WRID\";\n+        ++rcnt;\n+        // send complete\n+      } else {\n+        RdmaChannel* rc =\n+            reinterpret_cast<RdmaChannel*>(rdma_adapter_->wc_[i].wr_id);\n+        CHECK(s == IBV_WC_SUCCESS) << \": \" << ibv_wc_status_str(\n+                                                  rdma_adapter_->wc_[i].status)\n+                                   << \"(\" << rdma_adapter_->wc_[i].status\n+                                   << \") to \" << rc->remote_name_;\n+        ++scnt;\n+      }\n+    }  // for\n+  }    // while", "path": "tensorflow/contrib/verbs/rdma_mgr.cc", "position": 49, "original_position": 49, "commit_id": "d43d00be13ff271eb8a2e6a14eb7ac01a51934ff", "original_commit_id": "d6b267ac78fcb6a3250c24d466e8aa478c1fc783", "user": {"login": "junshi15", "id": 12075848, "node_id": "MDQ6VXNlcjEyMDc1ODQ4", "avatar_url": "https://avatars3.githubusercontent.com/u/12075848?v=4", "gravatar_id": "", "url": "https://api.github.com/users/junshi15", "html_url": "https://github.com/junshi15", "followers_url": "https://api.github.com/users/junshi15/followers", "following_url": "https://api.github.com/users/junshi15/following{/other_user}", "gists_url": "https://api.github.com/users/junshi15/gists{/gist_id}", "starred_url": "https://api.github.com/users/junshi15/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/junshi15/subscriptions", "organizations_url": "https://api.github.com/users/junshi15/orgs", "repos_url": "https://api.github.com/users/junshi15/repos", "events_url": "https://api.github.com/users/junshi15/events{/privacy}", "received_events_url": "https://api.github.com/users/junshi15/received_events", "type": "User", "site_admin": false}, "body": "Can this while loop hang if one of the remote nodes is down?", "created_at": "2017-11-16T03:00:36Z", "updated_at": "2017-11-16T15:16:33Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/14290#discussion_r151311193", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/14290", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/151311193"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/14290#discussion_r151311193"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/14290"}}, "body_html": "<p>Can this while loop hang if one of the remote nodes is down?</p>", "body_text": "Can this while loop hang if one of the remote nodes is down?"}