{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/290405247", "html_url": "https://github.com/tensorflow/tensorflow/issues/3397#issuecomment-290405247", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3397", "id": 290405247, "node_id": "MDEyOklzc3VlQ29tbWVudDI5MDQwNTI0Nw==", "user": {"login": "Namnamseo", "id": 12743061, "node_id": "MDQ6VXNlcjEyNzQzMDYx", "avatar_url": "https://avatars1.githubusercontent.com/u/12743061?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Namnamseo", "html_url": "https://github.com/Namnamseo", "followers_url": "https://api.github.com/users/Namnamseo/followers", "following_url": "https://api.github.com/users/Namnamseo/following{/other_user}", "gists_url": "https://api.github.com/users/Namnamseo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Namnamseo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Namnamseo/subscriptions", "organizations_url": "https://api.github.com/users/Namnamseo/orgs", "repos_url": "https://api.github.com/users/Namnamseo/repos", "events_url": "https://api.github.com/users/Namnamseo/events{/privacy}", "received_events_url": "https://api.github.com/users/Namnamseo/received_events", "type": "User", "site_admin": false}, "created_at": "2017-03-30T13:08:15Z", "updated_at": "2017-03-30T13:13:54Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I think the issue is unresolved. I thought it would be better to post here, continuing the discussion.<br>\nTake this toy example:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">with</span> tf.device(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>/gpu:2<span class=\"pl-pds\">'</span></span>):\n    x <span class=\"pl-k\">=</span> tf.placeholder(tf.float32, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[<span class=\"pl-c1\">None</span>, <span class=\"pl-c1\">100</span>])\n    weight_dense_1 <span class=\"pl-k\">=</span> tf.Variable(tf.zeros([<span class=\"pl-c1\">100</span>, <span class=\"pl-c1\">10</span>]))\n    dense_1_out <span class=\"pl-k\">=</span> tf.matmul(x, weight_dense_1)\n    mean, var <span class=\"pl-k\">=</span> tf.nn.moments(dense_1_out, [<span class=\"pl-c1\">0</span>], <span class=\"pl-v\">shift</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">None</span>, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">None</span>, <span class=\"pl-v\">keep_dims</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>)\n    coeff <span class=\"pl-k\">=</span> tf.rsqrt(var <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1e-8</span>)\n    y <span class=\"pl-k\">=</span> dense_1_out <span class=\"pl-k\">*</span> coeff <span class=\"pl-k\">-</span> mean <span class=\"pl-k\">*</span> coeff\n    grad <span class=\"pl-k\">=</span> tf.gradients(y, [weight_dense_1], <span class=\"pl-v\">colocate_gradients_with_ops</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)</pre></div>\n<p>This immediately shows up some warnings:</p>\n<pre><code>WARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Rank with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1/start with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1/delta with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/ListDiff with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/concat/axis with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/concat with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Gather with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Const with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Prod with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Gather_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Const_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Prod_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\n</code></pre>\n<p>And if I force it to run(by setting <code>allow_soft_placement=False</code>), an error is occured:</p>\n<pre><code>InvalidArgumentError: Cannot colocate nodes 'gradients/moments/sufficient_statistics/count_grad/Const_1' and 'gradients/moments/sufficient_statistics/count_grad/Cumprod_1/axis: Cannot merge devices with incompatible types: '/GPU:2' and '/CPU:0'\n\t [[Node: gradients/moments/sufficient_statistics/count_grad/Const_1 = Const[_class=[\"loc:@moments/sufficient_statistics/count\"], dtype=DT_INT32, value=Tensor&lt;type: int32 shape: [1] values: 0&gt;, _device=\"/device:CPU:0\"]()]]\n</code></pre>\n<p>When setting the placeholder's batch size explicitly, or using CPU, the warning is gone.</p>\n<p>I'm using pip3-installed <code>tensorflow-gpu==1.0.1</code>, with Python 3.5.2.<br>\nCUDA 8.0.61, cuDNN 5.1.10 is installed on Ubuntu 16.04.</p>", "body_text": "I think the issue is unresolved. I thought it would be better to post here, continuing the discussion.\nTake this toy example:\nwith tf.device('/gpu:2'):\n    x = tf.placeholder(tf.float32, shape=[None, 100])\n    weight_dense_1 = tf.Variable(tf.zeros([100, 10]))\n    dense_1_out = tf.matmul(x, weight_dense_1)\n    mean, var = tf.nn.moments(dense_1_out, [0], shift=None, name=None, keep_dims=False)\n    coeff = tf.rsqrt(var + 1e-8)\n    y = dense_1_out * coeff - mean * coeff\n    grad = tf.gradients(y, [weight_dense_1], colocate_gradients_with_ops=True)\nThis immediately shows up some warnings:\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Rank with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1/start with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1/delta with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/ListDiff with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/concat/axis with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/concat with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Gather with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Const with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Prod with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Gather_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Const_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Prod_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\n\nAnd if I force it to run(by setting allow_soft_placement=False), an error is occured:\nInvalidArgumentError: Cannot colocate nodes 'gradients/moments/sufficient_statistics/count_grad/Const_1' and 'gradients/moments/sufficient_statistics/count_grad/Cumprod_1/axis: Cannot merge devices with incompatible types: '/GPU:2' and '/CPU:0'\n\t [[Node: gradients/moments/sufficient_statistics/count_grad/Const_1 = Const[_class=[\"loc:@moments/sufficient_statistics/count\"], dtype=DT_INT32, value=Tensor<type: int32 shape: [1] values: 0>, _device=\"/device:CPU:0\"]()]]\n\nWhen setting the placeholder's batch size explicitly, or using CPU, the warning is gone.\nI'm using pip3-installed tensorflow-gpu==1.0.1, with Python 3.5.2.\nCUDA 8.0.61, cuDNN 5.1.10 is installed on Ubuntu 16.04.", "body": "I think the issue is unresolved. I thought it would be better to post here, continuing the discussion.\r\nTake this toy example:\r\n\r\n```python\r\nwith tf.device('/gpu:2'):\r\n    x = tf.placeholder(tf.float32, shape=[None, 100])\r\n    weight_dense_1 = tf.Variable(tf.zeros([100, 10]))\r\n    dense_1_out = tf.matmul(x, weight_dense_1)\r\n    mean, var = tf.nn.moments(dense_1_out, [0], shift=None, name=None, keep_dims=False)\r\n    coeff = tf.rsqrt(var + 1e-8)\r\n    y = dense_1_out * coeff - mean * coeff\r\n    grad = tf.gradients(y, [weight_dense_1], colocate_gradients_with_ops=True)\r\n```\r\n\r\nThis immediately shows up some warnings:\r\n```\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Rank with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1/start with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1/delta with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/range_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/ListDiff with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/concat/axis with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/concat with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Gather with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Const with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Prod with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Gather_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Const_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\nWARNING:tensorflow:Tried to colocate gradients/moments/sufficient_statistics/count_grad/Prod_1 with an op moments/sufficient_statistics/count that had a different device: /device:CPU:0 vs /device:GPU:2. Ignoring colocation property.\r\n```\r\n\r\nAnd if I force it to run(by setting `allow_soft_placement=False`), an error is occured:\r\n```\r\nInvalidArgumentError: Cannot colocate nodes 'gradients/moments/sufficient_statistics/count_grad/Const_1' and 'gradients/moments/sufficient_statistics/count_grad/Cumprod_1/axis: Cannot merge devices with incompatible types: '/GPU:2' and '/CPU:0'\r\n\t [[Node: gradients/moments/sufficient_statistics/count_grad/Const_1 = Const[_class=[\"loc:@moments/sufficient_statistics/count\"], dtype=DT_INT32, value=Tensor<type: int32 shape: [1] values: 0>, _device=\"/device:CPU:0\"]()]]\r\n```\r\n\r\nWhen setting the placeholder's batch size explicitly, or using CPU, the warning is gone.\r\n\r\nI'm using pip3-installed `tensorflow-gpu==1.0.1`, with Python 3.5.2.\r\nCUDA 8.0.61, cuDNN 5.1.10 is installed on Ubuntu 16.04."}