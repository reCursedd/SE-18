{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22146", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22146/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22146/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22146/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22146", "id": 358108690, "node_id": "MDU6SXNzdWUzNTgxMDg2OTA=", "number": 22146, "title": "TOCO fails to handle Dilated Convolution properly", "user": {"login": "gashmish", "id": 673872, "node_id": "MDQ6VXNlcjY3Mzg3Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/673872?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gashmish", "html_url": "https://github.com/gashmish", "followers_url": "https://api.github.com/users/gashmish/followers", "following_url": "https://api.github.com/users/gashmish/following{/other_user}", "gists_url": "https://api.github.com/users/gashmish/gists{/gist_id}", "starred_url": "https://api.github.com/users/gashmish/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gashmish/subscriptions", "organizations_url": "https://api.github.com/users/gashmish/orgs", "repos_url": "https://api.github.com/users/gashmish/repos", "events_url": "https://api.github.com/users/gashmish/events{/privacy}", "received_events_url": "https://api.github.com/users/gashmish/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 750616506, "node_id": "MDU6TGFiZWw3NTA2MTY1MDY=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:lite", "name": "comp:lite", "color": "0052cc", "default": false}], "state": "open", "locked": false, "assignee": {"login": "suharshs", "id": 1450614, "node_id": "MDQ6VXNlcjE0NTA2MTQ=", "avatar_url": "https://avatars1.githubusercontent.com/u/1450614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/suharshs", "html_url": "https://github.com/suharshs", "followers_url": "https://api.github.com/users/suharshs/followers", "following_url": "https://api.github.com/users/suharshs/following{/other_user}", "gists_url": "https://api.github.com/users/suharshs/gists{/gist_id}", "starred_url": "https://api.github.com/users/suharshs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/suharshs/subscriptions", "organizations_url": "https://api.github.com/users/suharshs/orgs", "repos_url": "https://api.github.com/users/suharshs/repos", "events_url": "https://api.github.com/users/suharshs/events{/privacy}", "received_events_url": "https://api.github.com/users/suharshs/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "suharshs", "id": 1450614, "node_id": "MDQ6VXNlcjE0NTA2MTQ=", "avatar_url": "https://avatars1.githubusercontent.com/u/1450614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/suharshs", "html_url": "https://github.com/suharshs", "followers_url": "https://api.github.com/users/suharshs/followers", "following_url": "https://api.github.com/users/suharshs/following{/other_user}", "gists_url": "https://api.github.com/users/suharshs/gists{/gist_id}", "starred_url": "https://api.github.com/users/suharshs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/suharshs/subscriptions", "organizations_url": "https://api.github.com/users/suharshs/orgs", "repos_url": "https://api.github.com/users/suharshs/repos", "events_url": "https://api.github.com/users/suharshs/events{/privacy}", "received_events_url": "https://api.github.com/users/suharshs/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-09-07T15:17:34Z", "updated_at": "2018-11-21T19:01:49Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<p>Have I written custom code (as opposed to using a stock example script provided in TensorFlow):N/A<br>\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):Linux Ubuntu 16.04<br>\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:N/A<br>\nTensorFlow installed from (source or binary):source<br>\nTensorFlow version (use command below):1.10.0<br>\nPython version: 2.7.12<br>\nBazel version (if compiling from source):0.15.0<br>\nGCC/Compiler version (if compiling from source):5.4.0<br>\nCUDA/cuDNN version:N/A<br>\nGPU model and memory:N/A<br>\nExact command to reproduce:N/A</p>\n<h3>Problem description</h3>\n<p>I have frozen_model.pb which works well.</p>\n<p>I build toco with command:<br>\n<code>bazel build -c opt //tensorflow/contrib/lite/toco:toco</code></p>\n<p>Then i'm trying to convert model to TfLite:<br>\n<code>toco --allow_custom_ops --input_file='frozen_model.pb'  --output_file='wavenet.tflite' --input_arrays='original_input' --input_shapes='1,48000,1' --output_arrays='activation_2/Softmax' --dump_graphviz=graph --dump_graphviz_video=true </code></p>\n<p>and geting error:<br>\n<code>2018-09-07 17:45:53.870648: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 412 operators, 674 arrays (0 quantized) 2018-09-07 17:45:53.876846: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 412 operators, 674 arrays (0 quantized) 2018-09-07 17:45:53.877237: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:161] Identified sub-network emulating dilated convolution. 2018-09-07 17:45:53.877266: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:209] Replaced with Dilated Conv2D op outputting \"dilated_conv_2_tanh/convolution/Conv2D\". 2018-09-07 17:45:53.877487: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:161] Identified sub-network emulating dilated convolution. 2018-09-07 17:45:53.877512: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:209] Replaced with Dilated Conv2D op outputting \"dilated_conv_2_sigm/convolution/Conv2D\". 2018-09-07 17:45:53.877852: F tensorflow/contrib/lite/toco/graph_transformations/propagate_fixed_sizes.cc:116] Check failed: dim_x == dim_y (48002 vs. 48000)Dimensions must match</code></p>\n<p>This is Dilated Convolution block in original frozen_model.pb visualized in tensorboard, it has input and output shape [?, 48000, 40]:</p>\n<p>[?, 48000, 40] -&gt;Pad-&gt;[?, 48002, 40]-&gt;SpaceToBatchND -&gt; ExpandDims -&gt; Conv2D -&gt; Squeeze -&gt; BatchToSpaceND-&gt;[?, 48000, 40]</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/673872/45226776-67d4c200-b2c8-11e8-9886-1aa498559a00.png\"><img src=\"https://user-images.githubusercontent.com/673872/45226776-67d4c200-b2c8-11e8-9886-1aa498559a00.png\" alt=\"img2\" style=\"max-width:100%;\"></a></p>\n<p>TOCO tries to substitute with<br>\n[?, 48000, 40] -&gt;Pad-&gt;[?, 48002, 40]-&gt;Reshape -&gt; Conv1x1/S -&gt; Squeze-&gt;[?, 48002, 40]<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/673872/45227203-cf8b0d00-b2c8-11e8-9092-7a4a94a731c0.png\"><img src=\"https://user-images.githubusercontent.com/673872/45227203-cf8b0d00-b2c8-11e8-9092-7a4a94a731c0.png\" alt=\"img3\" style=\"max-width:100%;\"></a></p>\n<p>so ouput of resulted block is [?, 48002, 40] instead of [?, 48000, 40], it causes error in subsequent operations.</p>\n<p>I managed to avoid this issue by removing line<br>\n102   transformations-&gt;Add(new IdentifyDilatedConv);<br>\nfrom tensorflow/contrib/lite/toco/toco_tooling.cc and rebuilding TOCO,<br>\nbut unfortunately this causes new problems, because some operations like SpaceToBatchND and BatchToSpaceND don't support 3D tensors in current TfLite verison.</p>", "body_text": "System information\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):N/A\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):Linux Ubuntu 16.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:N/A\nTensorFlow installed from (source or binary):source\nTensorFlow version (use command below):1.10.0\nPython version: 2.7.12\nBazel version (if compiling from source):0.15.0\nGCC/Compiler version (if compiling from source):5.4.0\nCUDA/cuDNN version:N/A\nGPU model and memory:N/A\nExact command to reproduce:N/A\nProblem description\nI have frozen_model.pb which works well.\nI build toco with command:\nbazel build -c opt //tensorflow/contrib/lite/toco:toco\nThen i'm trying to convert model to TfLite:\ntoco --allow_custom_ops --input_file='frozen_model.pb'  --output_file='wavenet.tflite' --input_arrays='original_input' --input_shapes='1,48000,1' --output_arrays='activation_2/Softmax' --dump_graphviz=graph --dump_graphviz_video=true \nand geting error:\n2018-09-07 17:45:53.870648: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 412 operators, 674 arrays (0 quantized) 2018-09-07 17:45:53.876846: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 412 operators, 674 arrays (0 quantized) 2018-09-07 17:45:53.877237: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:161] Identified sub-network emulating dilated convolution. 2018-09-07 17:45:53.877266: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:209] Replaced with Dilated Conv2D op outputting \"dilated_conv_2_tanh/convolution/Conv2D\". 2018-09-07 17:45:53.877487: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:161] Identified sub-network emulating dilated convolution. 2018-09-07 17:45:53.877512: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:209] Replaced with Dilated Conv2D op outputting \"dilated_conv_2_sigm/convolution/Conv2D\". 2018-09-07 17:45:53.877852: F tensorflow/contrib/lite/toco/graph_transformations/propagate_fixed_sizes.cc:116] Check failed: dim_x == dim_y (48002 vs. 48000)Dimensions must match\nThis is Dilated Convolution block in original frozen_model.pb visualized in tensorboard, it has input and output shape [?, 48000, 40]:\n[?, 48000, 40] ->Pad->[?, 48002, 40]->SpaceToBatchND -> ExpandDims -> Conv2D -> Squeeze -> BatchToSpaceND->[?, 48000, 40]\n\nTOCO tries to substitute with\n[?, 48000, 40] ->Pad->[?, 48002, 40]->Reshape -> Conv1x1/S -> Squeze->[?, 48002, 40]\n\nso ouput of resulted block is [?, 48002, 40] instead of [?, 48000, 40], it causes error in subsequent operations.\nI managed to avoid this issue by removing line\n102   transformations->Add(new IdentifyDilatedConv);\nfrom tensorflow/contrib/lite/toco/toco_tooling.cc and rebuilding TOCO,\nbut unfortunately this causes new problems, because some operations like SpaceToBatchND and BatchToSpaceND don't support 3D tensors in current TfLite verison.", "body": "### System information\r\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):N/A\r\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):Linux Ubuntu 16.04\r\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:N/A\r\nTensorFlow installed from (source or binary):source\r\nTensorFlow version (use command below):1.10.0\r\nPython version: 2.7.12\r\nBazel version (if compiling from source):0.15.0\r\nGCC/Compiler version (if compiling from source):5.4.0\r\nCUDA/cuDNN version:N/A\r\nGPU model and memory:N/A\r\nExact command to reproduce:N/A\r\n\r\n### Problem description\r\nI have frozen_model.pb which works well.\r\n\r\nI build toco with command:\r\n`bazel build -c opt //tensorflow/contrib/lite/toco:toco`\r\n \r\nThen i'm trying to convert model to TfLite:\r\n`toco --allow_custom_ops --input_file='frozen_model.pb'  --output_file='wavenet.tflite' --input_arrays='original_input' --input_shapes='1,48000,1' --output_arrays='activation_2/Softmax' --dump_graphviz=graph --dump_graphviz_video=true\r\n`\r\n\r\nand geting error:\r\n`\r\n2018-09-07 17:45:53.870648: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 412 operators, 674 arrays (0 quantized)\r\n2018-09-07 17:45:53.876846: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 412 operators, 674 arrays (0 quantized)\r\n2018-09-07 17:45:53.877237: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:161] Identified sub-network emulating dilated convolution.\r\n2018-09-07 17:45:53.877266: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:209] Replaced with Dilated Conv2D op outputting \"dilated_conv_2_tanh/convolution/Conv2D\".\r\n2018-09-07 17:45:53.877487: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:161] Identified sub-network emulating dilated convolution.\r\n2018-09-07 17:45:53.877512: I tensorflow/contrib/lite/toco/graph_transformations/identify_dilated_conv.cc:209] Replaced with Dilated Conv2D op outputting \"dilated_conv_2_sigm/convolution/Conv2D\".\r\n2018-09-07 17:45:53.877852: F tensorflow/contrib/lite/toco/graph_transformations/propagate_fixed_sizes.cc:116] Check failed: dim_x == dim_y (48002 vs. 48000)Dimensions must match\r\n`\r\n\r\nThis is Dilated Convolution block in original frozen_model.pb visualized in tensorboard, it has input and output shape [?, 48000, 40]:\r\n\r\n[?, 48000, 40] ->Pad->[?, 48002, 40]->SpaceToBatchND -> ExpandDims -> Conv2D -> Squeeze -> BatchToSpaceND->[?, 48000, 40]\r\n\r\n![img2](https://user-images.githubusercontent.com/673872/45226776-67d4c200-b2c8-11e8-9886-1aa498559a00.png)\r\n\r\n\r\nTOCO tries to substitute with\r\n[?, 48000, 40] ->Pad->[?, 48002, 40]->Reshape -> Conv1x1/S -> Squeze->[?, 48002, 40]\r\n![img3](https://user-images.githubusercontent.com/673872/45227203-cf8b0d00-b2c8-11e8-9092-7a4a94a731c0.png)\r\n\r\nso ouput of resulted block is [?, 48002, 40] instead of [?, 48000, 40], it causes error in subsequent operations.\r\n\r\nI managed to avoid this issue by removing line\r\n102   transformations->Add(new IdentifyDilatedConv);\r\nfrom tensorflow/contrib/lite/toco/toco_tooling.cc and rebuilding TOCO,\r\nbut unfortunately this causes new problems, because some operations like SpaceToBatchND and BatchToSpaceND don't support 3D tensors in current TfLite verison.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"}