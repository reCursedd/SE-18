{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/390427344", "html_url": "https://github.com/tensorflow/tensorflow/issues/19407#issuecomment-390427344", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19407", "id": 390427344, "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDQyNzM0NA==", "user": {"login": "Dref360", "id": 8976546, "node_id": "MDQ6VXNlcjg5NzY1NDY=", "avatar_url": "https://avatars3.githubusercontent.com/u/8976546?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dref360", "html_url": "https://github.com/Dref360", "followers_url": "https://api.github.com/users/Dref360/followers", "following_url": "https://api.github.com/users/Dref360/following{/other_user}", "gists_url": "https://api.github.com/users/Dref360/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dref360/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dref360/subscriptions", "organizations_url": "https://api.github.com/users/Dref360/orgs", "repos_url": "https://api.github.com/users/Dref360/repos", "events_url": "https://api.github.com/users/Dref360/events{/privacy}", "received_events_url": "https://api.github.com/users/Dref360/received_events", "type": "User", "site_admin": false}, "created_at": "2018-05-19T19:32:36Z", "updated_at": "2018-05-19T19:49:14Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I found that adding :</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">class</span> <span class=\"pl-en\">MemoryLogHook</span>(<span class=\"pl-e\">tf</span>.<span class=\"pl-e\">train</span>.<span class=\"pl-e\">SessionRunHook</span>):\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">begin</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>):\n        K.<span class=\"pl-c1\">_GRAPH_LEARNING_PHASES</span> <span class=\"pl-k\">=</span> {}\n        K.<span class=\"pl-c1\">_GRAPH_UID_DICTS</span> <span class=\"pl-k\">=</span> {}</pre></div>\n<p>fixes the issue. (will stabilize around 1.35e+9) We probably need to clear those before calling the model_fn. <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/estimator/keras.py#L339\">Here</a></p>\n<div class=\"highlight highlight-source-python\"><pre>  <span class=\"pl-k\">def</span> <span class=\"pl-en\">model_fn</span>(<span class=\"pl-smi\">features</span>, <span class=\"pl-smi\">labels</span>, <span class=\"pl-smi\">mode</span>):\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"\"\"</span>model_fn for keras Estimator.<span class=\"pl-pds\">\"\"\"</span></span>\n\n    <span class=\"pl-c\"><span class=\"pl-c\">#</span> Clear graphs before doing anything.</span>\n    <span class=\"pl-c\"><span class=\"pl-c\">#</span> Cannot call K.clear_session because the graph is read_only.</span>\n    K.<span class=\"pl-c1\">_GRAPH_LEARNING_PHASES</span> <span class=\"pl-k\">=</span> {}\n    K.<span class=\"pl-c1\">_GRAPH_UID_DICTS</span> <span class=\"pl-k\">=</span> {}</pre></div>", "body_text": "I found that adding :\nclass MemoryLogHook(tf.train.SessionRunHook):\n    def begin(self):\n        K._GRAPH_LEARNING_PHASES = {}\n        K._GRAPH_UID_DICTS = {}\nfixes the issue. (will stabilize around 1.35e+9) We probably need to clear those before calling the model_fn. Here\n  def model_fn(features, labels, mode):\n    \"\"\"model_fn for keras Estimator.\"\"\"\n\n    # Clear graphs before doing anything.\n    # Cannot call K.clear_session because the graph is read_only.\n    K._GRAPH_LEARNING_PHASES = {}\n    K._GRAPH_UID_DICTS = {}", "body": "I found that adding : \r\n\r\n```python\r\nclass MemoryLogHook(tf.train.SessionRunHook):\r\n    def begin(self):\r\n        K._GRAPH_LEARNING_PHASES = {}\r\n        K._GRAPH_UID_DICTS = {}\r\n```\r\n\r\nfixes the issue. (will stabilize around 1.35e+9) We probably need to clear those before calling the model_fn. [Here](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/estimator/keras.py#L339)\r\n\r\n```python\r\n  def model_fn(features, labels, mode):\r\n    \"\"\"model_fn for keras Estimator.\"\"\"\r\n\r\n    # Clear graphs before doing anything.\r\n    # Cannot call K.clear_session because the graph is read_only.\r\n    K._GRAPH_LEARNING_PHASES = {}\r\n    K._GRAPH_UID_DICTS = {}\r\n```\r\n"}