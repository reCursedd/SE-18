{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/204939334", "pull_request_review_id": 140112433, "id": 204939334, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwNDkzOTMzNA==", "diff_hunk": "@@ -121,41 +116,41 @@ def py3string(inp):\n     to_bytes = py3bytes\n     to_string = py3string\n \n-  out_names = []\n-  for i in outputs:\n-    if isinstance(i, ops.Tensor):\n-      out_names.append(to_bytes(i.name))\n-    else:\n-      out_names.append(to_bytes(i))\n-\n-  input_graph_def_str = input_graph_def.SerializeToString()\n-\n-  # TODO(sami): Fix this when we can return status from C++ library\n-  # There is a problem with the TF internal library setup that doesn't\n-  # allow us to return a status object from C++.  Thus we return a\n-  # pair or strings where first one is encoded status and the second\n-  # one is the transformed graphs protobuf string.\n-  out = trt_convert(input_graph_def_str, out_names, max_batch_size,\n-                    max_workspace_size_bytes, mode, minimum_segment_size,\n-                    is_dynamic_op, maximum_cached_engines,\n-                    cached_engine_batches)\n-  status = to_string(out[0])\n-  output_graph_def_string = out[1]\n-  del input_graph_def_str  # Save some memory\n-  if len(status) < 2:\n-    raise _impl.UnknownError(None, None, status)\n-  if status[:2] != \"OK\":\n-    msg = status.split(\";\")\n-    if len(msg) == 1:\n-      raise RuntimeError(\"Status message is malformed {}\".format(status))\n-    # pylint: disable=protected-access\n-    raise _impl._make_specific_exception(None, None, \";\".join(msg[1:]),\n-                                         int(msg[0]))\n-    # pylint: enable=protected-access\n-  output_graph_def = graph_pb2.GraphDef()\n-  output_graph_def.ParseFromString(output_graph_def_string)\n-  del output_graph_def_string  # Save some memory\n-  return output_graph_def\n+  # Create MetaGraphDef\n+  graph = ops.Graph()\n+  with graph.as_default():\n+    importer.import_graph_def(input_graph_def, name=\"\")\n+  meta_graph = saver.export_meta_graph(\n+      graph_def=graph.as_graph_def(), graph=graph)\n+  if outputs:\n+    output_collection = meta_graph_pb2.CollectionDef()\n+    output_list = output_collection.node_list.value\n+    for i in outputs:\n+      if isinstance(i, ops.Tensor):\n+        output_list.append(to_bytes(i.name))\n+      else:\n+        output_list.append(to_bytes(i))\n+    meta_graph.collection_def[\"train_op\"].CopyFrom(output_collection)\n+\n+  # Create RewriterConfig.\n+  rewriter_cfg = rewriter_config_pb2.RewriterConfig()\n+  rewriter_cfg.optimizers.extend([\"constfold\", \"layout\"])\n+  optimizer = rewriter_cfg.custom_optimizers.add()\n+  optimizer.name = \"TensorRTOptimizer\"", "path": "tensorflow/contrib/tensorrt/python/trt_convert.py", "position": 104, "original_position": 104, "commit_id": "e6012bd6b2cb9f65d25d02c1661cb2bac1689da8", "original_commit_id": "e6012bd6b2cb9f65d25d02c1661cb2bac1689da8", "user": {"login": "aaroey", "id": 31743510, "node_id": "MDQ6VXNlcjMxNzQzNTEw", "avatar_url": "https://avatars0.githubusercontent.com/u/31743510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aaroey", "html_url": "https://github.com/aaroey", "followers_url": "https://api.github.com/users/aaroey/followers", "following_url": "https://api.github.com/users/aaroey/following{/other_user}", "gists_url": "https://api.github.com/users/aaroey/gists{/gist_id}", "starred_url": "https://api.github.com/users/aaroey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aaroey/subscriptions", "organizations_url": "https://api.github.com/users/aaroey/orgs", "repos_url": "https://api.github.com/users/aaroey/repos", "events_url": "https://api.github.com/users/aaroey/events{/privacy}", "received_events_url": "https://api.github.com/users/aaroey/received_events", "type": "User", "site_admin": false}, "body": "Yes, I tested that this works on both py2 and py3.", "created_at": "2018-07-24T23:08:53Z", "updated_at": "2018-07-24T23:08:53Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/20318#discussion_r204939334", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/20318", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/204939334"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/20318#discussion_r204939334"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/20318"}}, "body_html": "<p>Yes, I tested that this works on both py2 and py3.</p>", "body_text": "Yes, I tested that this works on both py2 and py3.", "in_reply_to_id": 204922244}