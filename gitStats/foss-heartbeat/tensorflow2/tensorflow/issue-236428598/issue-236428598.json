{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10757", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10757/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10757/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10757/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/10757", "id": 236428598, "node_id": "MDU6SXNzdWUyMzY0Mjg1OTg=", "number": 10757, "title": " SparseMatmulOpTest.BroadcastPacketTest is failing on ppc64le", "user": {"login": "sandipmgiri", "id": 16284232, "node_id": "MDQ6VXNlcjE2Mjg0MjMy", "avatar_url": "https://avatars0.githubusercontent.com/u/16284232?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sandipmgiri", "html_url": "https://github.com/sandipmgiri", "followers_url": "https://api.github.com/users/sandipmgiri/followers", "following_url": "https://api.github.com/users/sandipmgiri/following{/other_user}", "gists_url": "https://api.github.com/users/sandipmgiri/gists{/gist_id}", "starred_url": "https://api.github.com/users/sandipmgiri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sandipmgiri/subscriptions", "organizations_url": "https://api.github.com/users/sandipmgiri/orgs", "repos_url": "https://api.github.com/users/sandipmgiri/repos", "events_url": "https://api.github.com/users/sandipmgiri/events{/privacy}", "received_events_url": "https://api.github.com/users/sandipmgiri/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586558, "node_id": "MDU6TGFiZWw0MDQ1ODY1NTg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:community%20support", "name": "stat:community support", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-06-16T09:25:26Z", "updated_at": "2017-08-10T06:09:03Z", "closed_at": "2017-06-17T06:11:58Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nUbuntu 16.04 (ppc64le)</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<br>\nInstalled from source (v1.0.1)</li>\n<li><strong>TensorFlow version (use command below)</strong>:<br>\n('v1.0.1-0-ge895d5c-dirty', '1.0.1')</li>\n<li><strong>Bazel version (if compiling from source)</strong>:<br>\n0.4.4-2017-05-26 (@80a07b5)</li>\n<li><strong>CUDA/cuDNN version</strong>:<br>\nCUDA = 8.0 and cuDNN = 5.1</li>\n<li><strong>GPU model and memory</strong>:<br>\nGPU 0: Tesla P100-SXM2-16GB<br>\nGPU 1: Tesla P100-SXM2-16GB</li>\n<li><strong>Exact command to reproduce</strong>:<br>\nbazel test --config=opt --config=cuda //tensorflow/core/kernels:sparse_matmul_op_test_gpu</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>This is regarding failure of test case <code>SparseMatmulOpTest.BroadcastPacketTest</code> in <code>tensorflow/core/kernels/sparse_matmul_op_test.cc</code> file.While executing this test case on ppc64le, it was observed that following line returns unexpected results:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op_test.cc#L255\">https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op_test.cc#L255</a></p>\n<pre><code>internal::pstoreu(data2, internal::pbroadcast_first&lt;Packet&gt;(\n                              internal::ploadu&lt;Packet&gt;(data1)));\n\n</code></pre>\n<p>Here we are getting expected result on <code>x86</code> for data2 array = <code>[0.170094 0.170094 0.170094 0.170094]</code>, however on <code>ppc64le</code> getting incorrect result i.e. <code>[  0.170094    0.14922 -0.0823886   0.026985]</code></p>\n<p>I have done some investigation around this - using <code>print/cout</code> statement I tried to understand the code flow on <code>ppc64le </code>as well as on <code>X86 </code>platform.<br>\nHere I found that for <code>internal::pbroadcast_first&lt;Packet&gt;</code> line ,on both the platform executed different functions, see below-<br>\nOn x86 executed <code>EIGEN_STRONG_INLINE Packet4f pbroadcast_first&lt;Packet4f&gt;(const Packet4f&amp; a) </code> function(<a href=\"https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L197\">https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L197</a>)<br>\nAnd on ppc64le executed some different function i.e. <code>EIGEN_DEVICE_FUNC inline Packet pbroadcast_first(const Packet&amp; a)</code> (<a href=\"https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L92\">https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L92</a>)</p>\n<p>That is why we are getting incorrect result on ppc64le for data2 array and test fails.<br>\nI have done some debugging on this but couldn't find the reason - why control is going to different functions on both the platform for <code>internal::pbroadcast_first&lt;Packet&gt;</code> ?</p>\n<p>If could get any suggestions/pointers to why this is happening that would be great!<br>\n(I am new to tensorflow code but interested/would-like-to debug &amp; help)</p>\n<p>Thanks!</p>\n<h3>Source code / logs</h3>\n<pre><code>$  bazel test --config=opt --config=cuda //tensorflow/core/kernels:sparse_matmul_op_test_gpu\n\nexec ${PAGER:-/usr/bin/less} \"$0\" || exit 1\n-----------------------------------------------------------------------------\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcublas.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcudnn.so.5 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcufft.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcurand.so.8.0 locally\nRunning main() from test_main.cc\n[==========] Running 4 tests from 1 test case.\n[----------] Global test environment set-up.\n[----------] 4 tests from SparseMatmulOpTest\n[ RUN      ] SparseMatmulOpTest.BroadcastPacketTest\n[0.170094 0.170094 0.170094 0.170094] != [  0.170094    0.14922 -0.0823886   0.026985], differences: [         0 -0.0208738  -0.252482  -0.143109]\ntensorflow/core/kernels/sparse_matmul_op_test.cc:257: Failure\nValue of: areApprox(ref, data2, PacketSize)\n  Actual: false\nExpected: true\n[  FAILED  ] SparseMatmulOpTest.BroadcastPacketTest (0 ms)\n[ RUN      ] SparseMatmulOpTest.InterleavePacketTest\n[       OK ] SparseMatmulOpTest.InterleavePacketTest (0 ms)\n[ RUN      ] SparseMatmulOpTest.Bfloat16ExpandTest\n[       OK ] SparseMatmulOpTest.Bfloat16ExpandTest (0 ms)\n[ RUN      ] SparseMatmulOpTest.Bfloat16LoadTest\n[       OK ] SparseMatmulOpTest.Bfloat16LoadTest (0 ms)\n[----------] 4 tests from SparseMatmulOpTest (0 ms total)\n\n[----------] Global test environment tear-down\n[==========] 4 tests from 1 test case ran. (0 ms total)\n[  PASSED  ] 3 tests.\n[  FAILED  ] 1 test, listed below:\n[  FAILED  ] SparseMatmulOpTest.BroadcastPacketTest\n\n 1 FAILED TEST\n\n</code></pre>", "body_text": "System information\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nUbuntu 16.04 (ppc64le)\nTensorFlow installed from (source or binary):\nInstalled from source (v1.0.1)\nTensorFlow version (use command below):\n('v1.0.1-0-ge895d5c-dirty', '1.0.1')\nBazel version (if compiling from source):\n0.4.4-2017-05-26 (@80a07b5)\nCUDA/cuDNN version:\nCUDA = 8.0 and cuDNN = 5.1\nGPU model and memory:\nGPU 0: Tesla P100-SXM2-16GB\nGPU 1: Tesla P100-SXM2-16GB\nExact command to reproduce:\nbazel test --config=opt --config=cuda //tensorflow/core/kernels:sparse_matmul_op_test_gpu\n\nDescribe the problem\nThis is regarding failure of test case SparseMatmulOpTest.BroadcastPacketTest in tensorflow/core/kernels/sparse_matmul_op_test.cc file.While executing this test case on ppc64le, it was observed that following line returns unexpected results:\nhttps://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op_test.cc#L255\ninternal::pstoreu(data2, internal::pbroadcast_first<Packet>(\n                              internal::ploadu<Packet>(data1)));\n\n\nHere we are getting expected result on x86 for data2 array = [0.170094 0.170094 0.170094 0.170094], however on ppc64le getting incorrect result i.e. [  0.170094    0.14922 -0.0823886   0.026985]\nI have done some investigation around this - using print/cout statement I tried to understand the code flow on ppc64le as well as on X86 platform.\nHere I found that for internal::pbroadcast_first<Packet> line ,on both the platform executed different functions, see below-\nOn x86 executed EIGEN_STRONG_INLINE Packet4f pbroadcast_first<Packet4f>(const Packet4f& a)  function(https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L197)\nAnd on ppc64le executed some different function i.e. EIGEN_DEVICE_FUNC inline Packet pbroadcast_first(const Packet& a) (https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L92)\nThat is why we are getting incorrect result on ppc64le for data2 array and test fails.\nI have done some debugging on this but couldn't find the reason - why control is going to different functions on both the platform for internal::pbroadcast_first<Packet> ?\nIf could get any suggestions/pointers to why this is happening that would be great!\n(I am new to tensorflow code but interested/would-like-to debug & help)\nThanks!\nSource code / logs\n$  bazel test --config=opt --config=cuda //tensorflow/core/kernels:sparse_matmul_op_test_gpu\n\nexec ${PAGER:-/usr/bin/less} \"$0\" || exit 1\n-----------------------------------------------------------------------------\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcublas.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcudnn.so.5 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcufft.so.8.0 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcurand.so.8.0 locally\nRunning main() from test_main.cc\n[==========] Running 4 tests from 1 test case.\n[----------] Global test environment set-up.\n[----------] 4 tests from SparseMatmulOpTest\n[ RUN      ] SparseMatmulOpTest.BroadcastPacketTest\n[0.170094 0.170094 0.170094 0.170094] != [  0.170094    0.14922 -0.0823886   0.026985], differences: [         0 -0.0208738  -0.252482  -0.143109]\ntensorflow/core/kernels/sparse_matmul_op_test.cc:257: Failure\nValue of: areApprox(ref, data2, PacketSize)\n  Actual: false\nExpected: true\n[  FAILED  ] SparseMatmulOpTest.BroadcastPacketTest (0 ms)\n[ RUN      ] SparseMatmulOpTest.InterleavePacketTest\n[       OK ] SparseMatmulOpTest.InterleavePacketTest (0 ms)\n[ RUN      ] SparseMatmulOpTest.Bfloat16ExpandTest\n[       OK ] SparseMatmulOpTest.Bfloat16ExpandTest (0 ms)\n[ RUN      ] SparseMatmulOpTest.Bfloat16LoadTest\n[       OK ] SparseMatmulOpTest.Bfloat16LoadTest (0 ms)\n[----------] 4 tests from SparseMatmulOpTest (0 ms total)\n\n[----------] Global test environment tear-down\n[==========] 4 tests from 1 test case ran. (0 ms total)\n[  PASSED  ] 3 tests.\n[  FAILED  ] 1 test, listed below:\n[  FAILED  ] SparseMatmulOpTest.BroadcastPacketTest\n\n 1 FAILED TEST", "body": "### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\n     Ubuntu 16.04 (ppc64le)\r\n- **TensorFlow installed from (source or binary)**:\r\n      Installed from source (v1.0.1)\r\n- **TensorFlow version (use command below)**:\r\n     ('v1.0.1-0-ge895d5c-dirty', '1.0.1')\r\n- **Bazel version (if compiling from source)**:\r\n     0.4.4-2017-05-26 (@80a07b5)\r\n- **CUDA/cuDNN version**:\r\n      CUDA = 8.0 and cuDNN = 5.1\r\n- **GPU model and memory**:\r\n      GPU 0: Tesla P100-SXM2-16GB\r\n      GPU 1: Tesla P100-SXM2-16GB\r\n- **Exact command to reproduce**:\r\n      bazel test --config=opt --config=cuda //tensorflow/core/kernels:sparse_matmul_op_test_gpu\r\n\r\n### Describe the problem\r\nThis is regarding failure of test case `SparseMatmulOpTest.BroadcastPacketTest` in `tensorflow/core/kernels/sparse_matmul_op_test.cc` file.While executing this test case on ppc64le, it was observed that following line returns unexpected results:\r\nhttps://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op_test.cc#L255\r\n```\r\ninternal::pstoreu(data2, internal::pbroadcast_first<Packet>(\r\n                              internal::ploadu<Packet>(data1)));\r\n\r\n```\r\nHere we are getting expected result on `x86` for data2 array = `[0.170094 0.170094 0.170094 0.170094]`, however on `ppc64le` getting incorrect result i.e. `[  0.170094    0.14922 -0.0823886   0.026985]`\r\n\r\nI have done some investigation around this - using `print/cout` statement I tried to understand the code flow on `ppc64le `as well as on `X86 `platform.\r\nHere I found that for `internal::pbroadcast_first<Packet>` line ,on both the platform executed different functions, see below-\r\nOn x86 executed `EIGEN_STRONG_INLINE Packet4f pbroadcast_first<Packet4f>(const Packet4f& a) ` function(https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L197)\r\nAnd on ppc64le executed some different function i.e. `EIGEN_DEVICE_FUNC inline Packet pbroadcast_first(const Packet& a)` (https://github.com/tensorflow/tensorflow/blob/v1.0.1/tensorflow/core/kernels/sparse_matmul_op.h#L92)\r\n\r\nThat is why we are getting incorrect result on ppc64le for data2 array and test fails.\r\nI have done some debugging on this but couldn't find the reason - why control is going to different functions on both the platform for `internal::pbroadcast_first<Packet>` ?\r\n\r\nIf could get any suggestions/pointers to why this is happening that would be great! \r\n(I am new to tensorflow code but interested/would-like-to debug & help)\r\n\r\nThanks!\r\n\r\n### Source code / logs\r\n```\r\n$  bazel test --config=opt --config=cuda //tensorflow/core/kernels:sparse_matmul_op_test_gpu\r\n\r\nexec ${PAGER:-/usr/bin/less} \"$0\" || exit 1\r\n-----------------------------------------------------------------------------\r\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcublas.so.8.0 locally\r\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcudnn.so.5 locally\r\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcufft.so.8.0 locally\r\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcuda.so.1 locally\r\nI tensorflow/stream_executor/dso_loader.cc:135] successfully opened CUDA library libcurand.so.8.0 locally\r\nRunning main() from test_main.cc\r\n[==========] Running 4 tests from 1 test case.\r\n[----------] Global test environment set-up.\r\n[----------] 4 tests from SparseMatmulOpTest\r\n[ RUN      ] SparseMatmulOpTest.BroadcastPacketTest\r\n[0.170094 0.170094 0.170094 0.170094] != [  0.170094    0.14922 -0.0823886   0.026985], differences: [         0 -0.0208738  -0.252482  -0.143109]\r\ntensorflow/core/kernels/sparse_matmul_op_test.cc:257: Failure\r\nValue of: areApprox(ref, data2, PacketSize)\r\n  Actual: false\r\nExpected: true\r\n[  FAILED  ] SparseMatmulOpTest.BroadcastPacketTest (0 ms)\r\n[ RUN      ] SparseMatmulOpTest.InterleavePacketTest\r\n[       OK ] SparseMatmulOpTest.InterleavePacketTest (0 ms)\r\n[ RUN      ] SparseMatmulOpTest.Bfloat16ExpandTest\r\n[       OK ] SparseMatmulOpTest.Bfloat16ExpandTest (0 ms)\r\n[ RUN      ] SparseMatmulOpTest.Bfloat16LoadTest\r\n[       OK ] SparseMatmulOpTest.Bfloat16LoadTest (0 ms)\r\n[----------] 4 tests from SparseMatmulOpTest (0 ms total)\r\n\r\n[----------] Global test environment tear-down\r\n[==========] 4 tests from 1 test case ran. (0 ms total)\r\n[  PASSED  ] 3 tests.\r\n[  FAILED  ] 1 test, listed below:\r\n[  FAILED  ] SparseMatmulOpTest.BroadcastPacketTest\r\n\r\n 1 FAILED TEST\r\n\r\n```"}