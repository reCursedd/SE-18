{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18501", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18501/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18501/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18501/events", "html_url": "https://github.com/tensorflow/tensorflow/pull/18501", "id": 314200438, "node_id": "MDExOlB1bGxSZXF1ZXN0MTgxNTU4MTEx", "number": 18501, "title": "Enable mobile libtensorflow_cc.so", "user": {"login": "linusmartensson", "id": 452169, "node_id": "MDQ6VXNlcjQ1MjE2OQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/452169?v=4", "gravatar_id": "", "url": "https://api.github.com/users/linusmartensson", "html_url": "https://github.com/linusmartensson", "followers_url": "https://api.github.com/users/linusmartensson/followers", "following_url": "https://api.github.com/users/linusmartensson/following{/other_user}", "gists_url": "https://api.github.com/users/linusmartensson/gists{/gist_id}", "starred_url": "https://api.github.com/users/linusmartensson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/linusmartensson/subscriptions", "organizations_url": "https://api.github.com/users/linusmartensson/orgs", "repos_url": "https://api.github.com/users/linusmartensson/repos", "events_url": "https://api.github.com/users/linusmartensson/events{/privacy}", "received_events_url": "https://api.github.com/users/linusmartensson/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 300136587, "node_id": "MDU6TGFiZWwzMDAxMzY1ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/cla:%20yes", "name": "cla: yes", "color": "009800", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "jhseu", "id": 170179, "node_id": "MDQ6VXNlcjE3MDE3OQ==", "avatar_url": "https://avatars1.githubusercontent.com/u/170179?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhseu", "html_url": "https://github.com/jhseu", "followers_url": "https://api.github.com/users/jhseu/followers", "following_url": "https://api.github.com/users/jhseu/following{/other_user}", "gists_url": "https://api.github.com/users/jhseu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhseu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhseu/subscriptions", "organizations_url": "https://api.github.com/users/jhseu/orgs", "repos_url": "https://api.github.com/users/jhseu/repos", "events_url": "https://api.github.com/users/jhseu/events{/privacy}", "received_events_url": "https://api.github.com/users/jhseu/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "jhseu", "id": 170179, "node_id": "MDQ6VXNlcjE3MDE3OQ==", "avatar_url": "https://avatars1.githubusercontent.com/u/170179?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhseu", "html_url": "https://github.com/jhseu", "followers_url": "https://api.github.com/users/jhseu/followers", "following_url": "https://api.github.com/users/jhseu/following{/other_user}", "gists_url": "https://api.github.com/users/jhseu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhseu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhseu/subscriptions", "organizations_url": "https://api.github.com/users/jhseu/orgs", "repos_url": "https://api.github.com/users/jhseu/repos", "events_url": "https://api.github.com/users/jhseu/events{/privacy}", "received_events_url": "https://api.github.com/users/jhseu/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 12, "created_at": "2018-04-13T18:04:15Z", "updated_at": "2018-06-14T21:52:42Z", "closed_at": "2018-06-14T21:25:37Z", "author_association": "NONE", "pull_request": {"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/18501", "html_url": "https://github.com/tensorflow/tensorflow/pull/18501", "diff_url": "https://github.com/tensorflow/tensorflow/pull/18501.diff", "patch_url": "https://github.com/tensorflow/tensorflow/pull/18501.patch"}, "body_html": "<p>Hey team TF!<br>\nI'm not expecting a merge on this, but wanted to submit it for posterity. I've been working for a few years on a project where we use tensorflow as part of a C++ application running simultaneously on armv7, arm64, and ubuntu x64, additionally utilizing ceres, protobuf, opencv and eigen in our pipeline.</p>\n<p>There seems to be a throng of different versions of tensorflow within the same build system, all with different capabilities, APIs and build instructions; so my recurring torment has been attempting to update tensorflow and consolidate those versions and dependencies into something that works seamlessly for our application. I had hope TF Lite would help solve this, but since upsampling ops seem to be missing still, its impossible for me to use as of yet, though I do have hope for the future. :)</p>\n<p>During my previous endavour, I ended up customizing //tensorflow/contrib/makefile, which combined with android-ndk-r11 and a bunch of skitty rules was made to work for all three platforms. Unfortunately, this meant a mess of a build system that wasn't always up to date with the bazel core, and no chance of reliable optimized builds.</p>\n<p>So for this time around, I decided to update to NDKr15 and look into all the various errors preventing the full libtensorflow_cc.so from building, resolving them to the best of my efforts, while caring little for breaking the lackluster libtensorflow_inference.so adaptation, which to my despair seemed to have no C++ API and zero documentation for native usage.</p>\n<p>This PR resolves all build- and link-preventing issues in libtensorflow_cc.so and all of its dependencies in r1.7, whilst breaking and removing all android build graph branches to force a full build as close to ubuntu libtensorflow_cc.so as possible.</p>\n<p>The majority of all incompatibilities with android seem to be related to android STL library issues, especially with functions from STL math libraries like std::asinh, which for android are placed in a global namespace (::asinh). I tried to resolve these with solutions that would work equally well on all platforms.</p>\n<p>The remainder are discrepancies with ubuntu, e.g. pthread which is included implicitly in android, missing string functions and lack of bfloat16-support. These were resolved while making an effort to maintain multi-platform support.</p>\n<p>I'll also add that I have not yet had a chance to test this on a physical mobile device, but it seems promising and compiles on armv7 thus far.</p>\n<p>The build command I'm using contains additional flags necessary for android compatibility, and may be somewhat daunting:<br>\nbazel build --config=monolithic --crosstool_top=//external:android/crosstool --host_crosstool_top=@bazel_tools//tools/cpp:toolchain --cpu=TARGET_PLATFORM //tensorflow:libtensorflow_cc.so --cxxopt=\"-std=c++11\" --copt=\"-DMDB_USE_ROBUST=0\" --cxxopt=\"-DTENSORFLOW_DISABLE_META\" --cxxopt=\"-DEIGEN_HAS_C99_MATH\" --cxxopt=\"-Wno-c++11-narrowing\"</p>\n<p>Notes on this command:<br>\nlmdb attempts to use an (on android) undefined PTHREAD_MUTEX_ROBUST, so disable that.<br>\nTENSORFLOW_DISABLE_META seems to resolve some build issues for android inside tensorflow and was cut from a filed issue.<br>\nauto detecting EIGEN_HAS_C99_MATH seems to fail on android, so enable it manually to overcome static asserts for missing functions.<br>\nDisabling the warning for c++11-narrowing is required for \"Eigen::DSizes&lt;Eigen::DenseIndex, 2&gt; slice_indices{position, 0};\" to compile in batch_kernels.cc - since the Concat operation calling it is templated with long long, and Eigen seems to expect a signed int in some circumstances. This may be a cause for concern.</p>\n<p>I'm hoping some parts of this can be useful either for team TF, or for external developers who like me need to integrate on android within a modern C++ environment, and for various reasons cannot use TF Lite.</p>", "body_text": "Hey team TF!\nI'm not expecting a merge on this, but wanted to submit it for posterity. I've been working for a few years on a project where we use tensorflow as part of a C++ application running simultaneously on armv7, arm64, and ubuntu x64, additionally utilizing ceres, protobuf, opencv and eigen in our pipeline.\nThere seems to be a throng of different versions of tensorflow within the same build system, all with different capabilities, APIs and build instructions; so my recurring torment has been attempting to update tensorflow and consolidate those versions and dependencies into something that works seamlessly for our application. I had hope TF Lite would help solve this, but since upsampling ops seem to be missing still, its impossible for me to use as of yet, though I do have hope for the future. :)\nDuring my previous endavour, I ended up customizing //tensorflow/contrib/makefile, which combined with android-ndk-r11 and a bunch of skitty rules was made to work for all three platforms. Unfortunately, this meant a mess of a build system that wasn't always up to date with the bazel core, and no chance of reliable optimized builds.\nSo for this time around, I decided to update to NDKr15 and look into all the various errors preventing the full libtensorflow_cc.so from building, resolving them to the best of my efforts, while caring little for breaking the lackluster libtensorflow_inference.so adaptation, which to my despair seemed to have no C++ API and zero documentation for native usage.\nThis PR resolves all build- and link-preventing issues in libtensorflow_cc.so and all of its dependencies in r1.7, whilst breaking and removing all android build graph branches to force a full build as close to ubuntu libtensorflow_cc.so as possible.\nThe majority of all incompatibilities with android seem to be related to android STL library issues, especially with functions from STL math libraries like std::asinh, which for android are placed in a global namespace (::asinh). I tried to resolve these with solutions that would work equally well on all platforms.\nThe remainder are discrepancies with ubuntu, e.g. pthread which is included implicitly in android, missing string functions and lack of bfloat16-support. These were resolved while making an effort to maintain multi-platform support.\nI'll also add that I have not yet had a chance to test this on a physical mobile device, but it seems promising and compiles on armv7 thus far.\nThe build command I'm using contains additional flags necessary for android compatibility, and may be somewhat daunting:\nbazel build --config=monolithic --crosstool_top=//external:android/crosstool --host_crosstool_top=@bazel_tools//tools/cpp:toolchain --cpu=TARGET_PLATFORM //tensorflow:libtensorflow_cc.so --cxxopt=\"-std=c++11\" --copt=\"-DMDB_USE_ROBUST=0\" --cxxopt=\"-DTENSORFLOW_DISABLE_META\" --cxxopt=\"-DEIGEN_HAS_C99_MATH\" --cxxopt=\"-Wno-c++11-narrowing\"\nNotes on this command:\nlmdb attempts to use an (on android) undefined PTHREAD_MUTEX_ROBUST, so disable that.\nTENSORFLOW_DISABLE_META seems to resolve some build issues for android inside tensorflow and was cut from a filed issue.\nauto detecting EIGEN_HAS_C99_MATH seems to fail on android, so enable it manually to overcome static asserts for missing functions.\nDisabling the warning for c++11-narrowing is required for \"Eigen::DSizes<Eigen::DenseIndex, 2> slice_indices{position, 0};\" to compile in batch_kernels.cc - since the Concat operation calling it is templated with long long, and Eigen seems to expect a signed int in some circumstances. This may be a cause for concern.\nI'm hoping some parts of this can be useful either for team TF, or for external developers who like me need to integrate on android within a modern C++ environment, and for various reasons cannot use TF Lite.", "body": "Hey team TF!\r\nI'm not expecting a merge on this, but wanted to submit it for posterity. I've been working for a few years on a project where we use tensorflow as part of a C++ application running simultaneously on armv7, arm64, and ubuntu x64, additionally utilizing ceres, protobuf, opencv and eigen in our pipeline.\r\n\r\nThere seems to be a throng of different versions of tensorflow within the same build system, all with different capabilities, APIs and build instructions; so my recurring torment has been attempting to update tensorflow and consolidate those versions and dependencies into something that works seamlessly for our application. I had hope TF Lite would help solve this, but since upsampling ops seem to be missing still, its impossible for me to use as of yet, though I do have hope for the future. :) \r\n\r\nDuring my previous endavour, I ended up customizing //tensorflow/contrib/makefile, which combined with android-ndk-r11 and a bunch of skitty rules was made to work for all three platforms. Unfortunately, this meant a mess of a build system that wasn't always up to date with the bazel core, and no chance of reliable optimized builds.\r\n\r\nSo for this time around, I decided to update to NDKr15 and look into all the various errors preventing the full libtensorflow_cc.so from building, resolving them to the best of my efforts, while caring little for breaking the lackluster libtensorflow_inference.so adaptation, which to my despair seemed to have no C++ API and zero documentation for native usage.\r\n\r\nThis PR resolves all build- and link-preventing issues in libtensorflow_cc.so and all of its dependencies in r1.7, whilst breaking and removing all android build graph branches to force a full build as close to ubuntu libtensorflow_cc.so as possible.\r\n\r\nThe majority of all incompatibilities with android seem to be related to android STL library issues, especially with functions from STL math libraries like std::asinh, which for android are placed in a global namespace (::asinh). I tried to resolve these with solutions that would work equally well on all platforms.\r\n\r\nThe remainder are discrepancies with ubuntu, e.g. pthread which is included implicitly in android, missing string functions and lack of bfloat16-support. These were resolved while making an effort to maintain multi-platform support. \r\n\r\nI'll also add that I have not yet had a chance to test this on a physical mobile device, but it seems promising and compiles on armv7 thus far. \r\n\r\nThe build command I'm using contains additional flags necessary for android compatibility, and may be somewhat daunting:\r\nbazel build --config=monolithic --crosstool_top=//external:android/crosstool --host_crosstool_top=@bazel_tools//tools/cpp:toolchain --cpu=TARGET_PLATFORM //tensorflow:libtensorflow_cc.so --cxxopt=\"-std=c++11\" --copt=\"-DMDB_USE_ROBUST=0\" --cxxopt=\"-DTENSORFLOW_DISABLE_META\" --cxxopt=\"-DEIGEN_HAS_C99_MATH\" --cxxopt=\"-Wno-c++11-narrowing\"\r\n\r\nNotes on this command:\r\nlmdb attempts to use an (on android) undefined PTHREAD_MUTEX_ROBUST, so disable that.\r\nTENSORFLOW_DISABLE_META seems to resolve some build issues for android inside tensorflow and was cut from a filed issue.\r\nauto detecting EIGEN_HAS_C99_MATH seems to fail on android, so enable it manually to overcome static asserts for missing functions.\r\nDisabling the warning for c++11-narrowing is required for \"Eigen::DSizes<Eigen::DenseIndex, 2> slice_indices{position, 0};\" to compile in batch_kernels.cc - since the Concat operation calling it is templated with long long, and Eigen seems to expect a signed int in some circumstances. This may be a cause for concern.\r\n\r\nI'm hoping some parts of this can be useful either for team TF, or for external developers who like me need to integrate on android within a modern C++ environment, and for various reasons cannot use TF Lite."}