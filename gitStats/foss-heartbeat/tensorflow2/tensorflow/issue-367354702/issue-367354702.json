{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22780", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22780/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22780/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22780/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22780", "id": 367354702, "node_id": "MDU6SXNzdWUzNjczNTQ3MDI=", "number": 22780, "title": "tf.keras doesn't work with tensorflow optimizer when using TFOptimizer", "user": {"login": "lminer", "id": 5126549, "node_id": "MDQ6VXNlcjUxMjY1NDk=", "avatar_url": "https://avatars2.githubusercontent.com/u/5126549?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lminer", "html_url": "https://github.com/lminer", "followers_url": "https://api.github.com/users/lminer/followers", "following_url": "https://api.github.com/users/lminer/following{/other_user}", "gists_url": "https://api.github.com/users/lminer/gists{/gist_id}", "starred_url": "https://api.github.com/users/lminer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lminer/subscriptions", "organizations_url": "https://api.github.com/users/lminer/orgs", "repos_url": "https://api.github.com/users/lminer/repos", "events_url": "https://api.github.com/users/lminer/events{/privacy}", "received_events_url": "https://api.github.com/users/lminer/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "ymodak", "id": 42785357, "node_id": "MDQ6VXNlcjQyNzg1MzU3", "avatar_url": "https://avatars1.githubusercontent.com/u/42785357?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ymodak", "html_url": "https://github.com/ymodak", "followers_url": "https://api.github.com/users/ymodak/followers", "following_url": "https://api.github.com/users/ymodak/following{/other_user}", "gists_url": "https://api.github.com/users/ymodak/gists{/gist_id}", "starred_url": "https://api.github.com/users/ymodak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ymodak/subscriptions", "organizations_url": "https://api.github.com/users/ymodak/orgs", "repos_url": "https://api.github.com/users/ymodak/repos", "events_url": "https://api.github.com/users/ymodak/events{/privacy}", "received_events_url": "https://api.github.com/users/ymodak/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "ymodak", "id": 42785357, "node_id": "MDQ6VXNlcjQyNzg1MzU3", "avatar_url": "https://avatars1.githubusercontent.com/u/42785357?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ymodak", "html_url": "https://github.com/ymodak", "followers_url": "https://api.github.com/users/ymodak/followers", "following_url": "https://api.github.com/users/ymodak/following{/other_user}", "gists_url": "https://api.github.com/users/ymodak/gists{/gist_id}", "starred_url": "https://api.github.com/users/ymodak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ymodak/subscriptions", "organizations_url": "https://api.github.com/users/ymodak/orgs", "repos_url": "https://api.github.com/users/ymodak/repos", "events_url": "https://api.github.com/users/ymodak/events{/privacy}", "received_events_url": "https://api.github.com/users/ymodak/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 10, "created_at": "2018-10-05T20:19:01Z", "updated_at": "2018-10-17T22:21:25Z", "closed_at": "2018-10-17T22:21:25Z", "author_association": "NONE", "body_html": "<p>I'm trying to use tf.keras with the new AdamW optimizer in tensorflow and am running into issues. A toy version of the code is as follows:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">from</span> tensorflow.contrib.opt <span class=\"pl-k\">import</span> AdamWOptimizer\n<span class=\"pl-k\">from</span> tensorflow.python.keras.optimizers <span class=\"pl-k\">import</span> TFOptimizer\n<span class=\"pl-k\">from</span> tensorflow.python.keras.layers <span class=\"pl-k\">import</span> Dense\n<span class=\"pl-k\">from</span> tensorflow.python.keras.models <span class=\"pl-k\">import</span> Sequential\n\nmodel <span class=\"pl-k\">=</span> Sequential()\nmodel.add(Dense(<span class=\"pl-c1\">2</span>, <span class=\"pl-v\">activation</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>tanh<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-v\">input_shape</span><span class=\"pl-k\">=</span>(<span class=\"pl-c1\">3</span>,)))\n\ntfopt <span class=\"pl-k\">=</span> AdamWOptimizer(<span class=\"pl-v\">weight_decay</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">0.1</span>, <span class=\"pl-v\">learning_rate</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">.004</span>)\noptimizer <span class=\"pl-k\">=</span> TFOptimizer(tfopt)\n\nmodel.compile(<span class=\"pl-v\">optimizer</span><span class=\"pl-k\">=</span>optimizer, <span class=\"pl-v\">loss</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>mean_squared_error<span class=\"pl-pds\">'</span></span>)\nmodel.fit(np.random.random((<span class=\"pl-c1\">5</span>, <span class=\"pl-c1\">3</span>)),\n          np.random.random((<span class=\"pl-c1\">5</span>, <span class=\"pl-c1\">2</span>)),\n          <span class=\"pl-v\">epochs</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">5</span>, <span class=\"pl-v\">batch_size</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">5</span>)</pre></div>\n<p>Error is as follows:</p>\n<div class=\"highlight highlight-source-python\"><pre>..<span class=\"pl-k\">/</span>python3.6<span class=\"pl-k\">/</span>site<span class=\"pl-k\">-</span>packages<span class=\"pl-k\">/</span>tensorflow<span class=\"pl-k\">/</span>python<span class=\"pl-k\">/</span>keras<span class=\"pl-k\">/</span>engine<span class=\"pl-k\">/</span>training.py:<span class=\"pl-c1\">1605</span>: <span class=\"pl-k\">in</span> fit\n    validation_steps<span class=\"pl-k\">=</span>validation_steps)\n..<span class=\"pl-k\">/</span>python3.6<span class=\"pl-k\">/</span>site<span class=\"pl-k\">-</span>packages<span class=\"pl-k\">/</span>tensorflow<span class=\"pl-k\">/</span>python<span class=\"pl-k\">/</span>keras<span class=\"pl-k\">/</span>engine<span class=\"pl-k\">/</span>training_arrays.py:<span class=\"pl-c1\">153</span>: <span class=\"pl-k\">in</span> fit_loop\n    outs <span class=\"pl-k\">=</span> f(ins)\n..<span class=\"pl-k\">/</span>python3.6<span class=\"pl-k\">/</span>site<span class=\"pl-k\">-</span>packages<span class=\"pl-k\">/</span>tensorflow<span class=\"pl-k\">/</span>python<span class=\"pl-k\">/</span>keras<span class=\"pl-k\">/</span>backend.py:<span class=\"pl-c1\">2978</span>: <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__call__</span>\n    run_metadata<span class=\"pl-k\">=</span><span class=\"pl-c1\">self</span>.run_metadata)\n..<span class=\"pl-k\">/</span>python3.6<span class=\"pl-k\">/</span>site<span class=\"pl-k\">-</span>packages<span class=\"pl-k\">/</span>tensorflow<span class=\"pl-k\">/</span>python<span class=\"pl-k\">/</span>client<span class=\"pl-k\">/</span>session.py:<span class=\"pl-c1\">1399</span>: <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__call__</span>\n    run_metadata_ptr)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\n<span class=\"pl-c1\">self</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">&lt;</span>tensorflow.python.framework.errors_impl.raise_exception_on_not_ok_status <span class=\"pl-c1\">object</span> at <span class=\"pl-c1\"><span class=\"pl-k\">0x</span>11ecde550</span><span class=\"pl-k\">&gt;</span>\ntype_arg <span class=\"pl-k\">=</span> <span class=\"pl-c1\">None</span>, value_arg <span class=\"pl-k\">=</span> <span class=\"pl-c1\">None</span>, traceback_arg <span class=\"pl-k\">=</span> <span class=\"pl-c1\">None</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-c1\">__exit__</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>, <span class=\"pl-smi\">type_arg</span>, <span class=\"pl-smi\">value_arg</span>, <span class=\"pl-smi\">traceback_arg</span>):\n      <span class=\"pl-k\">try</span>:\n        <span class=\"pl-k\">if</span> c_api.TF_GetCode(<span class=\"pl-c1\">self</span>.status.status) <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">0</span>:\n          <span class=\"pl-k\">raise</span> _make_specific_exception(\n              <span class=\"pl-c1\">None</span>, <span class=\"pl-c1\">None</span>,\n              compat.as_text(c_api.TF_Message(<span class=\"pl-c1\">self</span>.status.status)),\n<span class=\"pl-k\">&gt;</span>             c_api.TF_GetCode(<span class=\"pl-c1\">self</span>.status.status))\nE             tensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value training<span class=\"pl-k\">/</span>TFOptimizer<span class=\"pl-k\">/</span>beta2_power\nE                [[{{node training<span class=\"pl-k\">/</span>TFOptimizer<span class=\"pl-k\">/</span>beta2_power<span class=\"pl-k\">/</span>read}} = Identity[T=<span class=\"pl-c1\">DT_FLOAT</span>, _class=[<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>loc:@training/TFOptimizer/AdamW/Assign<span class=\"pl-pds\">\"</span></span>], _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/device:CPU:0<span class=\"pl-pds\">\"</span></span>](training<span class=\"pl-k\">/</span>TFOptimizer<span class=\"pl-k\">/</span>beta2_power)]]\n\n..<span class=\"pl-k\">/</span>python3.6<span class=\"pl-k\">/</span>site<span class=\"pl-k\">-</span>packages<span class=\"pl-k\">/</span>tensorflow<span class=\"pl-k\">/</span>python<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>errors_impl.py:<span class=\"pl-c1\">526</span>: FailedPre</pre></div>\n<h3>System information</h3>\n<ul>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: MacOS Mojave</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.10.0</li>\n<li><strong>Python version</strong>: 3.6</li>\n<li><strong>Exact command to reproduce</strong>: See above</li>\n<li><strong>Have I written custom code</strong>: N/A</li>\n<li><strong>Bazel version</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A</li>\n<li><strong>Mobile device</strong>: N/A</li>\n</ul>", "body_text": "I'm trying to use tf.keras with the new AdamW optimizer in tensorflow and am running into issues. A toy version of the code is as follows:\nfrom tensorflow.contrib.opt import AdamWOptimizer\nfrom tensorflow.python.keras.optimizers import TFOptimizer\nfrom tensorflow.python.keras.layers import Dense\nfrom tensorflow.python.keras.models import Sequential\n\nmodel = Sequential()\nmodel.add(Dense(2, activation=\"tanh\", input_shape=(3,)))\n\ntfopt = AdamWOptimizer(weight_decay=0.1, learning_rate=.004)\noptimizer = TFOptimizer(tfopt)\n\nmodel.compile(optimizer=optimizer, loss='mean_squared_error')\nmodel.fit(np.random.random((5, 3)),\n          np.random.random((5, 2)),\n          epochs=5, batch_size=5)\nError is as follows:\n../python3.6/site-packages/tensorflow/python/keras/engine/training.py:1605: in fit\n    validation_steps=validation_steps)\n../python3.6/site-packages/tensorflow/python/keras/engine/training_arrays.py:153: in fit_loop\n    outs = f(ins)\n../python3.6/site-packages/tensorflow/python/keras/backend.py:2978: in __call__\n    run_metadata=self.run_metadata)\n../python3.6/site-packages/tensorflow/python/client/session.py:1399: in __call__\n    run_metadata_ptr)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <tensorflow.python.framework.errors_impl.raise_exception_on_not_ok_status object at 0x11ecde550>\ntype_arg = None, value_arg = None, traceback_arg = None\n\n    def __exit__(self, type_arg, value_arg, traceback_arg):\n      try:\n        if c_api.TF_GetCode(self.status.status) != 0:\n          raise _make_specific_exception(\n              None, None,\n              compat.as_text(c_api.TF_Message(self.status.status)),\n>             c_api.TF_GetCode(self.status.status))\nE             tensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value training/TFOptimizer/beta2_power\nE                [[{{node training/TFOptimizer/beta2_power/read}} = Identity[T=DT_FLOAT, _class=[\"loc:@training/TFOptimizer/AdamW/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](training/TFOptimizer/beta2_power)]]\n\n../python3.6/site-packages/tensorflow/python/framework/errors_impl.py:526: FailedPre\nSystem information\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): MacOS Mojave\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.10.0\nPython version: 3.6\nExact command to reproduce: See above\nHave I written custom code: N/A\nBazel version: N/A\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A\nMobile device: N/A", "body": "I'm trying to use tf.keras with the new AdamW optimizer in tensorflow and am running into issues. A toy version of the code is as follows:\r\n\r\n```python\r\nfrom tensorflow.contrib.opt import AdamWOptimizer\r\nfrom tensorflow.python.keras.optimizers import TFOptimizer\r\nfrom tensorflow.python.keras.layers import Dense\r\nfrom tensorflow.python.keras.models import Sequential\r\n\r\nmodel = Sequential()\r\nmodel.add(Dense(2, activation=\"tanh\", input_shape=(3,)))\r\n\r\ntfopt = AdamWOptimizer(weight_decay=0.1, learning_rate=.004)\r\noptimizer = TFOptimizer(tfopt)\r\n\r\nmodel.compile(optimizer=optimizer, loss='mean_squared_error')\r\nmodel.fit(np.random.random((5, 3)),\r\n          np.random.random((5, 2)),\r\n          epochs=5, batch_size=5)\r\n```\r\n\r\nError is as follows:\r\n\r\n```python\r\n../python3.6/site-packages/tensorflow/python/keras/engine/training.py:1605: in fit\r\n    validation_steps=validation_steps)\r\n../python3.6/site-packages/tensorflow/python/keras/engine/training_arrays.py:153: in fit_loop\r\n    outs = f(ins)\r\n../python3.6/site-packages/tensorflow/python/keras/backend.py:2978: in __call__\r\n    run_metadata=self.run_metadata)\r\n../python3.6/site-packages/tensorflow/python/client/session.py:1399: in __call__\r\n    run_metadata_ptr)\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n\r\nself = <tensorflow.python.framework.errors_impl.raise_exception_on_not_ok_status object at 0x11ecde550>\r\ntype_arg = None, value_arg = None, traceback_arg = None\r\n\r\n    def __exit__(self, type_arg, value_arg, traceback_arg):\r\n      try:\r\n        if c_api.TF_GetCode(self.status.status) != 0:\r\n          raise _make_specific_exception(\r\n              None, None,\r\n              compat.as_text(c_api.TF_Message(self.status.status)),\r\n>             c_api.TF_GetCode(self.status.status))\r\nE             tensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value training/TFOptimizer/beta2_power\r\nE                [[{{node training/TFOptimizer/beta2_power/read}} = Identity[T=DT_FLOAT, _class=[\"loc:@training/TFOptimizer/AdamW/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](training/TFOptimizer/beta2_power)]]\r\n\r\n../python3.6/site-packages/tensorflow/python/framework/errors_impl.py:526: FailedPre\r\n```\r\n\r\n### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: MacOS Mojave\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: 1.10.0\r\n- **Python version**: 3.6\r\n- **Exact command to reproduce**: See above\r\n- **Have I written custom code**: N/A\r\n- **Bazel version**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Mobile device**: N/A\r\n"}