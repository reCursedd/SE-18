{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13172", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13172/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13172/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13172/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13172", "id": 259009772, "node_id": "MDU6SXNzdWUyNTkwMDk3NzI=", "number": 13172, "title": "send/recv operators bug in constructing the graph.", "user": {"login": "dzhwinter", "id": 6687176, "node_id": "MDQ6VXNlcjY2ODcxNzY=", "avatar_url": "https://avatars2.githubusercontent.com/u/6687176?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dzhwinter", "html_url": "https://github.com/dzhwinter", "followers_url": "https://api.github.com/users/dzhwinter/followers", "following_url": "https://api.github.com/users/dzhwinter/following{/other_user}", "gists_url": "https://api.github.com/users/dzhwinter/gists{/gist_id}", "starred_url": "https://api.github.com/users/dzhwinter/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dzhwinter/subscriptions", "organizations_url": "https://api.github.com/users/dzhwinter/orgs", "repos_url": "https://api.github.com/users/dzhwinter/repos", "events_url": "https://api.github.com/users/dzhwinter/events{/privacy}", "received_events_url": "https://api.github.com/users/dzhwinter/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-09-20T01:09:58Z", "updated_at": "2017-09-20T16:10:51Z", "closed_at": "2017-09-20T16:10:51Z", "author_association": "NONE", "body_html": "<p>Running the following snippet several times shows some weird operator in the graph.</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\n<span class=\"pl-k\">with</span> tf.device(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/gpu:0<span class=\"pl-pds\">\"</span></span>):\n    x <span class=\"pl-k\">=</span> tf.constant(<span class=\"pl-c1\">1.0</span>)\n\ngraph_def <span class=\"pl-k\">=</span> tf.get_default_graph().as_graph_def()\noptions <span class=\"pl-k\">=</span> tf.RunOptions(<span class=\"pl-v\">output_partition_graphs</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)\nmetadata <span class=\"pl-k\">=</span> tf.RunMetadata()\nconfig <span class=\"pl-k\">=</span> tf.ConfigProto(<span class=\"pl-v\">device_count</span><span class=\"pl-k\">=</span>{<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>CPU<span class=\"pl-pds\">\"</span></span>: <span class=\"pl-c1\">8</span>},\n                        <span class=\"pl-v\">inter_op_parallelism_threads</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>,\n                        <span class=\"pl-v\">intra_op_parallelism_threads</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>)\nsess <span class=\"pl-k\">=</span> tf.Session(<span class=\"pl-v\">config</span><span class=\"pl-k\">=</span>config)\nsess.run(x, <span class=\"pl-v\">options</span><span class=\"pl-k\">=</span>options, <span class=\"pl-v\">run_metadata</span><span class=\"pl-k\">=</span>metadata)\n<span class=\"pl-k\">for</span> partition_graph_def <span class=\"pl-k\">in</span> metadata.partition_graphs:\n   <span class=\"pl-c1\">print</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">*</span> <span class=\"pl-c1\">5</span>\n   <span class=\"pl-c1\">print</span> partition_graph_def</pre></div>\n<p>in the cpu part of graph, it shows</p>\n<pre lang=\"text\"><code>node {\n  name: \"Const/_1\"\n  op: \"_Recv\"\n  device: \"/job:localhost/replica:0/task:0/cpu:0\"\n  attr {\n    key: \"client_terminated\"\n    value {\n      b: false\n    }\n  }\n  attr {\n    key: \"recv_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/gpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device_incarnation\"\n    value {\n      i: 1\n    }\n  }\n  attr {\n    key: \"tensor_name\"\n    value {\n      s: \"edge_5_Const\"\n    }\n  }\n  attr {\n    key: \"tensor_type\"\n    value {\n      type: DT_FLOAT\n    }\n  }\n}\nnode {\n  name: \"_send_Const_0\"\n  op: \"_Send\"\n  input: \"Const/_1\"\n  device: \"/job:localhost/replica:0/task:0/cpu:0\"\n  attr {\n    key: \"T\"\n    value {\n      type: DT_FLOAT\n    }\n  }\n  attr {\n    key: \"client_terminated\"\n    value {\n      b: true\n    }\n  }\n  attr {\n    key: \"recv_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device_incarnation\"\n    value {\n      i: -3155862594799619836\n    }\n  }\n  attr {\n    key: \"tensor_name\"\n    value {\n      s: \"Const:0\"\n    }\n  }\n}\nversions {\n  producer: 21\n}\n</code></pre>\n<p>There is a weird operator in it. <code> name: \"_send_Const_0\"</code> just send tensor from cpu0 to cpu0. This device already has the right result of <code>Add</code> operator.<br>\nAnd I notice the <code>send_device_incarnation</code> is a random number, which generates by <a href=\"https://github.com/tensorflow/tensorflow/blob/754048a0453a04a761e112ae5d99c149eb9910dd/tensorflow/core/common_runtime/device.cc#L43\">New64</a>.</p>\n<p>The whole log of this snippet available in <a href=\"https://gist.github.com/dzhwinter/3c2257351774260382dd3e130aaa072b\">https://gist.github.com/dzhwinter/3c2257351774260382dd3e130aaa072b</a>. Thanks.</p>", "body_text": "Running the following snippet several times shows some weird operator in the graph.\nimport tensorflow as tf\n\nwith tf.device(\"/gpu:0\"):\n    x = tf.constant(1.0)\n\ngraph_def = tf.get_default_graph().as_graph_def()\noptions = tf.RunOptions(output_partition_graphs=True)\nmetadata = tf.RunMetadata()\nconfig = tf.ConfigProto(device_count={\"CPU\": 8},\n                        inter_op_parallelism_threads=1,\n                        intra_op_parallelism_threads=1)\nsess = tf.Session(config=config)\nsess.run(x, options=options, run_metadata=metadata)\nfor partition_graph_def in metadata.partition_graphs:\n   print \"\\n\" * 5\n   print partition_graph_def\nin the cpu part of graph, it shows\nnode {\n  name: \"Const/_1\"\n  op: \"_Recv\"\n  device: \"/job:localhost/replica:0/task:0/cpu:0\"\n  attr {\n    key: \"client_terminated\"\n    value {\n      b: false\n    }\n  }\n  attr {\n    key: \"recv_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/gpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device_incarnation\"\n    value {\n      i: 1\n    }\n  }\n  attr {\n    key: \"tensor_name\"\n    value {\n      s: \"edge_5_Const\"\n    }\n  }\n  attr {\n    key: \"tensor_type\"\n    value {\n      type: DT_FLOAT\n    }\n  }\n}\nnode {\n  name: \"_send_Const_0\"\n  op: \"_Send\"\n  input: \"Const/_1\"\n  device: \"/job:localhost/replica:0/task:0/cpu:0\"\n  attr {\n    key: \"T\"\n    value {\n      type: DT_FLOAT\n    }\n  }\n  attr {\n    key: \"client_terminated\"\n    value {\n      b: true\n    }\n  }\n  attr {\n    key: \"recv_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device\"\n    value {\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\n    }\n  }\n  attr {\n    key: \"send_device_incarnation\"\n    value {\n      i: -3155862594799619836\n    }\n  }\n  attr {\n    key: \"tensor_name\"\n    value {\n      s: \"Const:0\"\n    }\n  }\n}\nversions {\n  producer: 21\n}\n\nThere is a weird operator in it.  name: \"_send_Const_0\" just send tensor from cpu0 to cpu0. This device already has the right result of Add operator.\nAnd I notice the send_device_incarnation is a random number, which generates by New64.\nThe whole log of this snippet available in https://gist.github.com/dzhwinter/3c2257351774260382dd3e130aaa072b. Thanks.", "body": "Running the following snippet several times shows some weird operator in the graph.\r\n```python\r\nimport tensorflow as tf\r\n\r\nwith tf.device(\"/gpu:0\"):\r\n    x = tf.constant(1.0)\r\n\r\ngraph_def = tf.get_default_graph().as_graph_def()\r\noptions = tf.RunOptions(output_partition_graphs=True)\r\nmetadata = tf.RunMetadata()\r\nconfig = tf.ConfigProto(device_count={\"CPU\": 8},\r\n                        inter_op_parallelism_threads=1,\r\n                        intra_op_parallelism_threads=1)\r\nsess = tf.Session(config=config)\r\nsess.run(x, options=options, run_metadata=metadata)\r\nfor partition_graph_def in metadata.partition_graphs:\r\n   print \"\\n\" * 5\r\n   print partition_graph_def\r\n```\r\nin the cpu part of graph, it shows\r\n```text\r\nnode {\r\n  name: \"Const/_1\"\r\n  op: \"_Recv\"\r\n  device: \"/job:localhost/replica:0/task:0/cpu:0\"\r\n  attr {\r\n    key: \"client_terminated\"\r\n    value {\r\n      b: false\r\n    }\r\n  }\r\n  attr {\r\n    key: \"recv_device\"\r\n    value {\r\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\r\n    }\r\n  }\r\n  attr {\r\n    key: \"send_device\"\r\n    value {\r\n      s: \"/job:localhost/replica:0/task:0/gpu:0\"\r\n    }\r\n  }\r\n  attr {\r\n    key: \"send_device_incarnation\"\r\n    value {\r\n      i: 1\r\n    }\r\n  }\r\n  attr {\r\n    key: \"tensor_name\"\r\n    value {\r\n      s: \"edge_5_Const\"\r\n    }\r\n  }\r\n  attr {\r\n    key: \"tensor_type\"\r\n    value {\r\n      type: DT_FLOAT\r\n    }\r\n  }\r\n}\r\nnode {\r\n  name: \"_send_Const_0\"\r\n  op: \"_Send\"\r\n  input: \"Const/_1\"\r\n  device: \"/job:localhost/replica:0/task:0/cpu:0\"\r\n  attr {\r\n    key: \"T\"\r\n    value {\r\n      type: DT_FLOAT\r\n    }\r\n  }\r\n  attr {\r\n    key: \"client_terminated\"\r\n    value {\r\n      b: true\r\n    }\r\n  }\r\n  attr {\r\n    key: \"recv_device\"\r\n    value {\r\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\r\n    }\r\n  }\r\n  attr {\r\n    key: \"send_device\"\r\n    value {\r\n      s: \"/job:localhost/replica:0/task:0/cpu:0\"\r\n    }\r\n  }\r\n  attr {\r\n    key: \"send_device_incarnation\"\r\n    value {\r\n      i: -3155862594799619836\r\n    }\r\n  }\r\n  attr {\r\n    key: \"tensor_name\"\r\n    value {\r\n      s: \"Const:0\"\r\n    }\r\n  }\r\n}\r\nversions {\r\n  producer: 21\r\n}\r\n```\r\nThere is a weird operator in it. ` name: \"_send_Const_0\"` just send tensor from cpu0 to cpu0. This device already has the right result of `Add` operator.\r\nAnd I notice the `send_device_incarnation` is a random number, which generates by [New64](https://github.com/tensorflow/tensorflow/blob/754048a0453a04a761e112ae5d99c149eb9910dd/tensorflow/core/common_runtime/device.cc#L43). \r\n\r\nThe whole log of this snippet available in https://gist.github.com/dzhwinter/3c2257351774260382dd3e130aaa072b. Thanks."}