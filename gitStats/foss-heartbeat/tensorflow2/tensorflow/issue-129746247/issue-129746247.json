{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/929", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/929/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/929/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/929/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/929", "id": 129746247, "node_id": "MDU6SXNzdWUxMjk3NDYyNDc=", "number": 929, "title": "label_image deadlocks", "user": {"login": "dvyukov", "id": 1095328, "node_id": "MDQ6VXNlcjEwOTUzMjg=", "avatar_url": "https://avatars3.githubusercontent.com/u/1095328?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dvyukov", "html_url": "https://github.com/dvyukov", "followers_url": "https://api.github.com/users/dvyukov/followers", "following_url": "https://api.github.com/users/dvyukov/following{/other_user}", "gists_url": "https://api.github.com/users/dvyukov/gists{/gist_id}", "starred_url": "https://api.github.com/users/dvyukov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dvyukov/subscriptions", "organizations_url": "https://api.github.com/users/dvyukov/orgs", "repos_url": "https://api.github.com/users/dvyukov/repos", "events_url": "https://api.github.com/users/dvyukov/events{/privacy}", "received_events_url": "https://api.github.com/users/dvyukov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 8, "created_at": "2016-01-29T11:55:56Z", "updated_at": "2017-02-09T22:02:22Z", "closed_at": "2016-06-07T07:56:31Z", "author_association": "NONE", "body_html": "<p>I am on commit <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/14cd77baeb0ee6f4b40816afc1f8c9c5d186bb8e/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/14cd77baeb0ee6f4b40816afc1f8c9c5d186bb8e\"><tt>14cd77b</tt></a>.</p>\n<p>I've added the following change that randomizes order of execution of tasks in thread pool:</p>\n<pre><code>diff --git a/tensorflow/core/lib/core/threadpool.cc b/tensorflow/core/lib/core/threadpool.cc\nindex 50aec3e..03c4485 100644\n--- a/tensorflow/core/lib/core/threadpool.cc\n+++ b/tensorflow/core/lib/core/threadpool.cc\n@@ -20,6 +20,8 @@ limitations under the License.\n #include \"tensorflow/core/platform/tracing.h\"\n #include \"tensorflow/core/platform/types.h\"\n\n+#include &lt;unistd.h&gt;\n+\n namespace tensorflow {\n namespace thread {\n\n@@ -34,6 +36,7 @@ ThreadPool::ThreadPool(Env* env, const string&amp; name, int num_threads)\n ThreadPool::ThreadPool(Env* env, const ThreadOptions&amp; thread_options,\n                        const string&amp; name, int num_threads)\n     : name_(name) {\n+  rand_ = getpid();\n   CHECK_GE(num_threads, 1);\n   string name_prefix = \"tf_\" + name_;\n   for (int i = 0; i &lt; num_threads; i++) {\n@@ -102,6 +105,7 @@ void ThreadPool::WorkerLoop() {\n         w.cv.wait(l);\n       }\n     }\n+    std::swap(pending_[0], pending_[rand_r(&amp;rand_) % pending_.size()]);\n     // Pick up pending work\n     Item item = pending_.front();\n     pending_.pop_front();\ndiff --git a/tensorflow/core/lib/core/threadpool.h b/tensorflow/core/lib/core/threadpool.h\nindex ef37dcf..ae1eef3 100644\n--- a/tensorflow/core/lib/core/threadpool.h\n+++ b/tensorflow/core/lib/core/threadpool.h\n@@ -66,6 +66,7 @@ class ThreadPool {\n   std::vector&lt;Thread*&gt; threads_;  // All threads\n   std::vector&lt;Waiter*&gt; waiters_;  // Stack of waiting threads.\n   std::deque&lt;Item&gt; pending_;      // Queue of pending work\n+  unsigned rand_;\n\n   TF_DISALLOW_COPY_AND_ASSIGN(ThreadPool);\n };\n</code></pre>\n<p>Then run label_image as:</p>\n<pre><code>while echo OK; do bazel-bin/tensorflow/examples/label_image/label_image; done\n</code></pre>\n<p>after few iterations it deadlocks. All threads are blocked on condition variables, but tasks they are waiting for can't run because all thread pool threads are busy:</p>\n<pre><code>(gdb) info threads\n  Id   Target Id         Frame \n  97   Thread 0x7f0d04038700 (LWP 74836) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  96   Thread 0x7f0d03837700 (LWP 74837) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  95   Thread 0x7f0d03036700 (LWP 74838) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  94   Thread 0x7f0d02835700 (LWP 74839) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  93   Thread 0x7f0d02034700 (LWP 74840) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  92   Thread 0x7f0d01833700 (LWP 74841) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  91   Thread 0x7f0d01032700 (LWP 74842) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  90   Thread 0x7f0d00831700 (LWP 74843) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  89   Thread 0x7f0cf3fff700 (LWP 74844) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  88   Thread 0x7f0cf37fe700 (LWP 74845) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  87   Thread 0x7f0cf2ffd700 (LWP 74846) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  86   Thread 0x7f0cf27fc700 (LWP 74847) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  85   Thread 0x7f0cf1ffb700 (LWP 74848) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  84   Thread 0x7f0cf17fa700 (LWP 74849) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  83   Thread 0x7f0cf0ff9700 (LWP 74850) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  82   Thread 0x7f0ce7fff700 (LWP 74851) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  81   Thread 0x7f0ce77fe700 (LWP 74852) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  80   Thread 0x7f0ce6ffd700 (LWP 74853) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  79   Thread 0x7f0ce67fc700 (LWP 74854) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  78   Thread 0x7f0ce5ffb700 (LWP 74855) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  77   Thread 0x7f0ce57fa700 (LWP 74856) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  76   Thread 0x7f0ce4ff9700 (LWP 74857) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  75   Thread 0x7f0cdffff700 (LWP 74858) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  74   Thread 0x7f0cdf7fe700 (LWP 74859) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  73   Thread 0x7f0cdeffd700 (LWP 74860) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  72   Thread 0x7f0cde7fc700 (LWP 74861) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  71   Thread 0x7f0cddffb700 (LWP 74862) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  70   Thread 0x7f0cdd7fa700 (LWP 74863) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  69   Thread 0x7f0cdcff9700 (LWP 74864) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  68   Thread 0x7f0cdc7f8700 (LWP 74865) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  67   Thread 0x7f0cdbff7700 (LWP 74866) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  66   Thread 0x7f0cdb7f6700 (LWP 74867) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  65   Thread 0x7f0cdaff5700 (LWP 74868) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  64   Thread 0x7f0cda7f4700 (LWP 74869) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  63   Thread 0x7f0cd9ff3700 (LWP 74870) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  62   Thread 0x7f0cd97f2700 (LWP 74871) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  61   Thread 0x7f0cd8ff1700 (LWP 74872) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  60   Thread 0x7f0cd3fff700 (LWP 74873) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  59   Thread 0x7f0cd37fe700 (LWP 74874) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  58   Thread 0x7f0cd2ffd700 (LWP 74875) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  57   Thread 0x7f0cd27fc700 (LWP 74876) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  56   Thread 0x7f0cd1ffb700 (LWP 74877) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  55   Thread 0x7f0cd17fa700 (LWP 74878) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  54   Thread 0x7f0cd0ff9700 (LWP 74879) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  53   Thread 0x7f0cd07f8700 (LWP 74880) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  52   Thread 0x7f0ccfff7700 (LWP 74881) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  51   Thread 0x7f0ccf7f6700 (LWP 74882) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  50   Thread 0x7f0cceff5700 (LWP 74883) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  49   Thread 0x7f0cce7f4700 (LWP 74884) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  48   Thread 0x7f0ccdff3700 (LWP 74885) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  47   Thread 0x7f0ccd7f2700 (LWP 74886) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  46   Thread 0x7f0cccff1700 (LWP 74887) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  45   Thread 0x7f0cc7fff700 (LWP 74888) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  44   Thread 0x7f0cc77fe700 (LWP 74889) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  43   Thread 0x7f0cc6ffd700 (LWP 74890) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  42   Thread 0x7f0cc67fc700 (LWP 74891) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  41   Thread 0x7f0cc5ffb700 (LWP 74892) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  40   Thread 0x7f0cc57fa700 (LWP 74893) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  39   Thread 0x7f0cc4ff9700 (LWP 74894) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  38   Thread 0x7f0cb7fff700 (LWP 74895) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  37   Thread 0x7f0cb77fe700 (LWP 74896) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  36   Thread 0x7f0cb6ffd700 (LWP 74897) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---\n  35   Thread 0x7f0cb67fc700 (LWP 74898) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  34   Thread 0x7f0cb5ffb700 (LWP 74899) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  33   Thread 0x7f0cb57fa700 (LWP 74900) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  32   Thread 0x7f0cb4ff9700 (LWP 74901) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  31   Thread 0x7f0caffff700 (LWP 74902) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  30   Thread 0x7f0caf7fe700 (LWP 74903) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  29   Thread 0x7f0caeffd700 (LWP 74904) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  28   Thread 0x7f0cae7fc700 (LWP 74905) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  27   Thread 0x7f0cadffb700 (LWP 74906) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  26   Thread 0x7f0cad7fa700 (LWP 74907) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  25   Thread 0x7f0cacff9700 (LWP 74908) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  24   Thread 0x7f0ca7fff700 (LWP 74909) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  23   Thread 0x7f0ca77fe700 (LWP 74910) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  22   Thread 0x7f0ca6ffd700 (LWP 74911) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  21   Thread 0x7f0ca67fc700 (LWP 74912) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  20   Thread 0x7f0ca5ffb700 (LWP 74913) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  19   Thread 0x7f0ca57fa700 (LWP 74914) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  18   Thread 0x7f0ca4ff9700 (LWP 74915) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  17   Thread 0x7f0ca47f8700 (LWP 74916) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  16   Thread 0x7f0ca3ff7700 (LWP 74917) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  15   Thread 0x7f0ca37f6700 (LWP 74918) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  14   Thread 0x7f0ca2ff5700 (LWP 74919) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  13   Thread 0x7f0ca27f4700 (LWP 74920) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  12   Thread 0x7f0ca1ff3700 (LWP 74921) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  11   Thread 0x7f0ca17f2700 (LWP 74922) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  10   Thread 0x7f0ca0ff1700 (LWP 74923) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  9    Thread 0x7f0c9bfff700 (LWP 74924) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  8    Thread 0x7f0c9b7fe700 (LWP 74925) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  7    Thread 0x7f0c9affd700 (LWP 74926) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  6    Thread 0x7f0c9a7fc700 (LWP 74927) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  5    Thread 0x7f0c99ffb700 (LWP 74928) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  4    Thread 0x7f0c997fa700 (LWP 74929) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  3    Thread 0x7f0c98ff9700 (LWP 74930) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  2    Thread 0x7f0c987f8700 (LWP 74931) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n* 1    Thread 0x7f0d0ad4c780 (LWP 74835) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n(gdb) thread 53\n[Switching to thread 53 (Thread 0x7f0cd07f8700 (LWP 74880))]\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n185 in ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S\n(gdb) bt\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n#1  0x00007f0d09fb94bc in __gthread_cond_wait (__mutex=&lt;optimized out&gt;, __cond=&lt;optimized out&gt;)\n    at /build/buildd/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/include/x86_64-linux-gnu/bits/gthr-default.h:864\n#2  std::condition_variable::wait (this=&lt;optimized out&gt;, __lock=...) at ../../../../../src/libstdc++-v3/src/c++11/condition_variable.cc:52\n#3  0x00000000004464fc in Eigen::Notification::WaitForNotification() ()\n#4  0x000000000064f49a in void Eigen::TensorEvaluator&lt;Eigen::TensorContractionOp&lt;Eigen::array&lt;Eigen::IndexPair&lt;long&gt;, 1ul&gt; const, Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorImagePatchOp&lt;-1l, -1l, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::ThreadPoolDevice&gt;::packRhsAndKernel&lt;Eigen::internal::packRhsAndKernelArg&lt;float, float, Eigen::internal::TensorContractionInputMapper&lt;float, long, 0, Eigen::TensorEvaluator&lt;Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorImagePatchOp&lt;-1l, -1l, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::ThreadPoolDevice&gt;, Eigen::array&lt;long, 1ul&gt;, Eigen::array&lt;long, 1ul&gt;, 4, true, false, 0&gt;, Eigen::internal::blas_data_mapper&lt;float, long, 0, 0&gt;, long&gt;, Eigen::internal::gemm_pack_rhs&lt;float, long, Eigen::internal::TensorContractionSubMapper&lt;float, long, 0, Eigen::TensorEvaluator&lt;Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorImagePatchOp&lt;-1l, -1l, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::ThreadPoolDevice&gt;, Eigen::array&lt;long, 1ul&gt;, Eigen::array&lt;long, 1ul&gt;, 4, true, false, 0&gt;, 4, 0, false, false&gt;, Eigen::internal::gebp_kernel&lt;float, float, long, Eigen::internal::blas_data_mapper&lt;float, long, 0, 0&gt;, 8, 4, false, false&gt; &gt;(Eigen::internal::packRhsAndKernelArg&lt;float, float, Eigen::internal::TensorContractionInputMapper&lt;float, long, 0, Eigen::TensorEvaluator&lt;Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorImagePatchOp&lt;-1l, -1l, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::ThreadPoolDevice&gt;, Eigen::array&lt;long, 1ul&gt;, Eigen::array&lt;long, 1ul&gt;, 4, true, false, 0&gt;, Eigen::internal::blas_data_mapper&lt;float, long, 0, 0&gt;, long&gt;) ()\n#5  0x0000000000634b1f in std::_Function_handler&lt;void (), std::_Bind&lt;void (*(Eigen::internal::packRhsAndKernelArg&lt;float, float, Eigen::internal::TensorContractionInputMapper&lt;float, long, 0, Eigen::TensorEvaluator&lt;Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorImagePatchOp&lt;-1l, -1l, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::ThreadPoolDevice&gt;, Eigen::array&lt;long, 1ul&gt;, Eigen::array&lt;long, 1ul&gt;, 4, true, false, 0&gt;, Eigen::internal::blas_data_mapper&lt;float, long, 0, 0&gt;, long&gt;))(Eigen::internal::packRhsAndKernelArg&lt;float, float, Eigen::internal::TensorContractionInputMapper&lt;float, long, 0, Eigen::TensorEvaluator&lt;Eigen::TensorReshapingOp&lt;Eigen::DSizes&lt;long, 2&gt; const, Eigen::TensorImagePatchOp&lt;-1l, -1l, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 4, 1, long&gt;, 16&gt; const&gt; const&gt; const, Eigen::ThreadPoolDevice&gt;, Eigen::array&lt;long, 1ul&gt;, Eigen::array&lt;long, 1ul&gt;, 4, true, false, 0&gt;, Eigen::internal::blas_data_mapper&lt;float, long, 0, 0&gt;, long&gt;)&gt; &gt;::_M_invoke(std::_Any_data const&amp;) ()\n#6  0x0000000000e44cef in std::_Function_handler&lt;void (), tensorflow::thread::ThreadPoolDefaultImpl::ThreadPoolDefaultImpl(tensorflow::Env*, tensorflow::ThreadOptions const&amp;, std::string const&amp;, int)::{lambda()#1}&gt;::_M_invoke(std::_Any_data const&amp;) ()\n#7  0x00007f0d09fbca40 in std::(anonymous namespace)::execute_native_thread_routine (__p=&lt;optimized out&gt;) at ../../../../../src/libstdc++-v3/src/c++11/thread.cc:84\n#8  0x00007f0d0a217184 in start_thread (arg=0x7f0cd07f8700) at pthread_create.c:312\n#9  0x00007f0d09a2a34d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111\n</code></pre>\n<p>This come up during testing of a faster thread pool implementation that has distributed queues and so does not preserve FIFO order. But I think it can come up with current pool as well (maybe after some unrelated code changes, or maybe just due to unlucky scheduling order).</p>\n<p>Computational tasks running on a fixed-size thread pool must not ever block. Instead they should schedule continuations. Besides deadlocks blocking leads to serious CPU underutilization. I.e. on my machine label_image utilizes only about half of cores, because half of threads in pool are blocked waiting for other tasks.</p>", "body_text": "I am on commit 14cd77b.\nI've added the following change that randomizes order of execution of tasks in thread pool:\ndiff --git a/tensorflow/core/lib/core/threadpool.cc b/tensorflow/core/lib/core/threadpool.cc\nindex 50aec3e..03c4485 100644\n--- a/tensorflow/core/lib/core/threadpool.cc\n+++ b/tensorflow/core/lib/core/threadpool.cc\n@@ -20,6 +20,8 @@ limitations under the License.\n #include \"tensorflow/core/platform/tracing.h\"\n #include \"tensorflow/core/platform/types.h\"\n\n+#include <unistd.h>\n+\n namespace tensorflow {\n namespace thread {\n\n@@ -34,6 +36,7 @@ ThreadPool::ThreadPool(Env* env, const string& name, int num_threads)\n ThreadPool::ThreadPool(Env* env, const ThreadOptions& thread_options,\n                        const string& name, int num_threads)\n     : name_(name) {\n+  rand_ = getpid();\n   CHECK_GE(num_threads, 1);\n   string name_prefix = \"tf_\" + name_;\n   for (int i = 0; i < num_threads; i++) {\n@@ -102,6 +105,7 @@ void ThreadPool::WorkerLoop() {\n         w.cv.wait(l);\n       }\n     }\n+    std::swap(pending_[0], pending_[rand_r(&rand_) % pending_.size()]);\n     // Pick up pending work\n     Item item = pending_.front();\n     pending_.pop_front();\ndiff --git a/tensorflow/core/lib/core/threadpool.h b/tensorflow/core/lib/core/threadpool.h\nindex ef37dcf..ae1eef3 100644\n--- a/tensorflow/core/lib/core/threadpool.h\n+++ b/tensorflow/core/lib/core/threadpool.h\n@@ -66,6 +66,7 @@ class ThreadPool {\n   std::vector<Thread*> threads_;  // All threads\n   std::vector<Waiter*> waiters_;  // Stack of waiting threads.\n   std::deque<Item> pending_;      // Queue of pending work\n+  unsigned rand_;\n\n   TF_DISALLOW_COPY_AND_ASSIGN(ThreadPool);\n };\n\nThen run label_image as:\nwhile echo OK; do bazel-bin/tensorflow/examples/label_image/label_image; done\n\nafter few iterations it deadlocks. All threads are blocked on condition variables, but tasks they are waiting for can't run because all thread pool threads are busy:\n(gdb) info threads\n  Id   Target Id         Frame \n  97   Thread 0x7f0d04038700 (LWP 74836) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  96   Thread 0x7f0d03837700 (LWP 74837) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  95   Thread 0x7f0d03036700 (LWP 74838) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  94   Thread 0x7f0d02835700 (LWP 74839) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  93   Thread 0x7f0d02034700 (LWP 74840) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  92   Thread 0x7f0d01833700 (LWP 74841) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  91   Thread 0x7f0d01032700 (LWP 74842) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  90   Thread 0x7f0d00831700 (LWP 74843) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  89   Thread 0x7f0cf3fff700 (LWP 74844) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  88   Thread 0x7f0cf37fe700 (LWP 74845) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  87   Thread 0x7f0cf2ffd700 (LWP 74846) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  86   Thread 0x7f0cf27fc700 (LWP 74847) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  85   Thread 0x7f0cf1ffb700 (LWP 74848) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  84   Thread 0x7f0cf17fa700 (LWP 74849) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  83   Thread 0x7f0cf0ff9700 (LWP 74850) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  82   Thread 0x7f0ce7fff700 (LWP 74851) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  81   Thread 0x7f0ce77fe700 (LWP 74852) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  80   Thread 0x7f0ce6ffd700 (LWP 74853) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  79   Thread 0x7f0ce67fc700 (LWP 74854) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  78   Thread 0x7f0ce5ffb700 (LWP 74855) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  77   Thread 0x7f0ce57fa700 (LWP 74856) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  76   Thread 0x7f0ce4ff9700 (LWP 74857) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  75   Thread 0x7f0cdffff700 (LWP 74858) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  74   Thread 0x7f0cdf7fe700 (LWP 74859) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  73   Thread 0x7f0cdeffd700 (LWP 74860) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  72   Thread 0x7f0cde7fc700 (LWP 74861) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  71   Thread 0x7f0cddffb700 (LWP 74862) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  70   Thread 0x7f0cdd7fa700 (LWP 74863) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  69   Thread 0x7f0cdcff9700 (LWP 74864) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  68   Thread 0x7f0cdc7f8700 (LWP 74865) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  67   Thread 0x7f0cdbff7700 (LWP 74866) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  66   Thread 0x7f0cdb7f6700 (LWP 74867) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  65   Thread 0x7f0cdaff5700 (LWP 74868) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  64   Thread 0x7f0cda7f4700 (LWP 74869) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  63   Thread 0x7f0cd9ff3700 (LWP 74870) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  62   Thread 0x7f0cd97f2700 (LWP 74871) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  61   Thread 0x7f0cd8ff1700 (LWP 74872) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  60   Thread 0x7f0cd3fff700 (LWP 74873) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  59   Thread 0x7f0cd37fe700 (LWP 74874) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  58   Thread 0x7f0cd2ffd700 (LWP 74875) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  57   Thread 0x7f0cd27fc700 (LWP 74876) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  56   Thread 0x7f0cd1ffb700 (LWP 74877) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  55   Thread 0x7f0cd17fa700 (LWP 74878) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  54   Thread 0x7f0cd0ff9700 (LWP 74879) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  53   Thread 0x7f0cd07f8700 (LWP 74880) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  52   Thread 0x7f0ccfff7700 (LWP 74881) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  51   Thread 0x7f0ccf7f6700 (LWP 74882) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  50   Thread 0x7f0cceff5700 (LWP 74883) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  49   Thread 0x7f0cce7f4700 (LWP 74884) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  48   Thread 0x7f0ccdff3700 (LWP 74885) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  47   Thread 0x7f0ccd7f2700 (LWP 74886) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  46   Thread 0x7f0cccff1700 (LWP 74887) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  45   Thread 0x7f0cc7fff700 (LWP 74888) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  44   Thread 0x7f0cc77fe700 (LWP 74889) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  43   Thread 0x7f0cc6ffd700 (LWP 74890) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  42   Thread 0x7f0cc67fc700 (LWP 74891) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  41   Thread 0x7f0cc5ffb700 (LWP 74892) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  40   Thread 0x7f0cc57fa700 (LWP 74893) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  39   Thread 0x7f0cc4ff9700 (LWP 74894) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  38   Thread 0x7f0cb7fff700 (LWP 74895) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  37   Thread 0x7f0cb77fe700 (LWP 74896) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  36   Thread 0x7f0cb6ffd700 (LWP 74897) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n---Type <return> to continue, or q <return> to quit---\n  35   Thread 0x7f0cb67fc700 (LWP 74898) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  34   Thread 0x7f0cb5ffb700 (LWP 74899) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  33   Thread 0x7f0cb57fa700 (LWP 74900) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  32   Thread 0x7f0cb4ff9700 (LWP 74901) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  31   Thread 0x7f0caffff700 (LWP 74902) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  30   Thread 0x7f0caf7fe700 (LWP 74903) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  29   Thread 0x7f0caeffd700 (LWP 74904) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  28   Thread 0x7f0cae7fc700 (LWP 74905) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  27   Thread 0x7f0cadffb700 (LWP 74906) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  26   Thread 0x7f0cad7fa700 (LWP 74907) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  25   Thread 0x7f0cacff9700 (LWP 74908) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  24   Thread 0x7f0ca7fff700 (LWP 74909) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  23   Thread 0x7f0ca77fe700 (LWP 74910) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  22   Thread 0x7f0ca6ffd700 (LWP 74911) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  21   Thread 0x7f0ca67fc700 (LWP 74912) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  20   Thread 0x7f0ca5ffb700 (LWP 74913) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  19   Thread 0x7f0ca57fa700 (LWP 74914) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  18   Thread 0x7f0ca4ff9700 (LWP 74915) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  17   Thread 0x7f0ca47f8700 (LWP 74916) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  16   Thread 0x7f0ca3ff7700 (LWP 74917) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  15   Thread 0x7f0ca37f6700 (LWP 74918) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  14   Thread 0x7f0ca2ff5700 (LWP 74919) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  13   Thread 0x7f0ca27f4700 (LWP 74920) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  12   Thread 0x7f0ca1ff3700 (LWP 74921) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  11   Thread 0x7f0ca17f2700 (LWP 74922) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  10   Thread 0x7f0ca0ff1700 (LWP 74923) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  9    Thread 0x7f0c9bfff700 (LWP 74924) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  8    Thread 0x7f0c9b7fe700 (LWP 74925) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  7    Thread 0x7f0c9affd700 (LWP 74926) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  6    Thread 0x7f0c9a7fc700 (LWP 74927) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  5    Thread 0x7f0c99ffb700 (LWP 74928) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  4    Thread 0x7f0c997fa700 (LWP 74929) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  3    Thread 0x7f0c98ff9700 (LWP 74930) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  2    Thread 0x7f0c987f8700 (LWP 74931) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n* 1    Thread 0x7f0d0ad4c780 (LWP 74835) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n(gdb) thread 53\n[Switching to thread 53 (Thread 0x7f0cd07f8700 (LWP 74880))]\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n185 in ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S\n(gdb) bt\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n#1  0x00007f0d09fb94bc in __gthread_cond_wait (__mutex=<optimized out>, __cond=<optimized out>)\n    at /build/buildd/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/include/x86_64-linux-gnu/bits/gthr-default.h:864\n#2  std::condition_variable::wait (this=<optimized out>, __lock=...) at ../../../../../src/libstdc++-v3/src/c++11/condition_variable.cc:52\n#3  0x00000000004464fc in Eigen::Notification::WaitForNotification() ()\n#4  0x000000000064f49a in void Eigen::TensorEvaluator<Eigen::TensorContractionOp<Eigen::array<Eigen::IndexPair<long>, 1ul> const, Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>::packRhsAndKernel<Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>, Eigen::internal::gemm_pack_rhs<float, long, Eigen::internal::TensorContractionSubMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, 4, 0, false, false>, Eigen::internal::gebp_kernel<float, float, long, Eigen::internal::blas_data_mapper<float, long, 0, 0>, 8, 4, false, false> >(Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>) ()\n#5  0x0000000000634b1f in std::_Function_handler<void (), std::_Bind<void (*(Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>))(Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>)> >::_M_invoke(std::_Any_data const&) ()\n#6  0x0000000000e44cef in std::_Function_handler<void (), tensorflow::thread::ThreadPoolDefaultImpl::ThreadPoolDefaultImpl(tensorflow::Env*, tensorflow::ThreadOptions const&, std::string const&, int)::{lambda()#1}>::_M_invoke(std::_Any_data const&) ()\n#7  0x00007f0d09fbca40 in std::(anonymous namespace)::execute_native_thread_routine (__p=<optimized out>) at ../../../../../src/libstdc++-v3/src/c++11/thread.cc:84\n#8  0x00007f0d0a217184 in start_thread (arg=0x7f0cd07f8700) at pthread_create.c:312\n#9  0x00007f0d09a2a34d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111\n\nThis come up during testing of a faster thread pool implementation that has distributed queues and so does not preserve FIFO order. But I think it can come up with current pool as well (maybe after some unrelated code changes, or maybe just due to unlucky scheduling order).\nComputational tasks running on a fixed-size thread pool must not ever block. Instead they should schedule continuations. Besides deadlocks blocking leads to serious CPU underutilization. I.e. on my machine label_image utilizes only about half of cores, because half of threads in pool are blocked waiting for other tasks.", "body": "I am on commit 14cd77baeb0ee6f4b40816afc1f8c9c5d186bb8e.\n\nI've added the following change that randomizes order of execution of tasks in thread pool:\n\n```\ndiff --git a/tensorflow/core/lib/core/threadpool.cc b/tensorflow/core/lib/core/threadpool.cc\nindex 50aec3e..03c4485 100644\n--- a/tensorflow/core/lib/core/threadpool.cc\n+++ b/tensorflow/core/lib/core/threadpool.cc\n@@ -20,6 +20,8 @@ limitations under the License.\n #include \"tensorflow/core/platform/tracing.h\"\n #include \"tensorflow/core/platform/types.h\"\n\n+#include <unistd.h>\n+\n namespace tensorflow {\n namespace thread {\n\n@@ -34,6 +36,7 @@ ThreadPool::ThreadPool(Env* env, const string& name, int num_threads)\n ThreadPool::ThreadPool(Env* env, const ThreadOptions& thread_options,\n                        const string& name, int num_threads)\n     : name_(name) {\n+  rand_ = getpid();\n   CHECK_GE(num_threads, 1);\n   string name_prefix = \"tf_\" + name_;\n   for (int i = 0; i < num_threads; i++) {\n@@ -102,6 +105,7 @@ void ThreadPool::WorkerLoop() {\n         w.cv.wait(l);\n       }\n     }\n+    std::swap(pending_[0], pending_[rand_r(&rand_) % pending_.size()]);\n     // Pick up pending work\n     Item item = pending_.front();\n     pending_.pop_front();\ndiff --git a/tensorflow/core/lib/core/threadpool.h b/tensorflow/core/lib/core/threadpool.h\nindex ef37dcf..ae1eef3 100644\n--- a/tensorflow/core/lib/core/threadpool.h\n+++ b/tensorflow/core/lib/core/threadpool.h\n@@ -66,6 +66,7 @@ class ThreadPool {\n   std::vector<Thread*> threads_;  // All threads\n   std::vector<Waiter*> waiters_;  // Stack of waiting threads.\n   std::deque<Item> pending_;      // Queue of pending work\n+  unsigned rand_;\n\n   TF_DISALLOW_COPY_AND_ASSIGN(ThreadPool);\n };\n```\n\nThen run label_image as:\n\n```\nwhile echo OK; do bazel-bin/tensorflow/examples/label_image/label_image; done\n```\n\nafter few iterations it deadlocks. All threads are blocked on condition variables, but tasks they are waiting for can't run because all thread pool threads are busy:\n\n```\n(gdb) info threads\n  Id   Target Id         Frame \n  97   Thread 0x7f0d04038700 (LWP 74836) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  96   Thread 0x7f0d03837700 (LWP 74837) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  95   Thread 0x7f0d03036700 (LWP 74838) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  94   Thread 0x7f0d02835700 (LWP 74839) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  93   Thread 0x7f0d02034700 (LWP 74840) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  92   Thread 0x7f0d01833700 (LWP 74841) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  91   Thread 0x7f0d01032700 (LWP 74842) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  90   Thread 0x7f0d00831700 (LWP 74843) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  89   Thread 0x7f0cf3fff700 (LWP 74844) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  88   Thread 0x7f0cf37fe700 (LWP 74845) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  87   Thread 0x7f0cf2ffd700 (LWP 74846) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  86   Thread 0x7f0cf27fc700 (LWP 74847) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  85   Thread 0x7f0cf1ffb700 (LWP 74848) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  84   Thread 0x7f0cf17fa700 (LWP 74849) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  83   Thread 0x7f0cf0ff9700 (LWP 74850) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  82   Thread 0x7f0ce7fff700 (LWP 74851) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  81   Thread 0x7f0ce77fe700 (LWP 74852) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  80   Thread 0x7f0ce6ffd700 (LWP 74853) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  79   Thread 0x7f0ce67fc700 (LWP 74854) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  78   Thread 0x7f0ce5ffb700 (LWP 74855) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  77   Thread 0x7f0ce57fa700 (LWP 74856) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  76   Thread 0x7f0ce4ff9700 (LWP 74857) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  75   Thread 0x7f0cdffff700 (LWP 74858) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  74   Thread 0x7f0cdf7fe700 (LWP 74859) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  73   Thread 0x7f0cdeffd700 (LWP 74860) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  72   Thread 0x7f0cde7fc700 (LWP 74861) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  71   Thread 0x7f0cddffb700 (LWP 74862) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  70   Thread 0x7f0cdd7fa700 (LWP 74863) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  69   Thread 0x7f0cdcff9700 (LWP 74864) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  68   Thread 0x7f0cdc7f8700 (LWP 74865) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  67   Thread 0x7f0cdbff7700 (LWP 74866) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  66   Thread 0x7f0cdb7f6700 (LWP 74867) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  65   Thread 0x7f0cdaff5700 (LWP 74868) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  64   Thread 0x7f0cda7f4700 (LWP 74869) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  63   Thread 0x7f0cd9ff3700 (LWP 74870) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  62   Thread 0x7f0cd97f2700 (LWP 74871) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  61   Thread 0x7f0cd8ff1700 (LWP 74872) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  60   Thread 0x7f0cd3fff700 (LWP 74873) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  59   Thread 0x7f0cd37fe700 (LWP 74874) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  58   Thread 0x7f0cd2ffd700 (LWP 74875) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  57   Thread 0x7f0cd27fc700 (LWP 74876) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  56   Thread 0x7f0cd1ffb700 (LWP 74877) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  55   Thread 0x7f0cd17fa700 (LWP 74878) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  54   Thread 0x7f0cd0ff9700 (LWP 74879) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  53   Thread 0x7f0cd07f8700 (LWP 74880) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  52   Thread 0x7f0ccfff7700 (LWP 74881) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  51   Thread 0x7f0ccf7f6700 (LWP 74882) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  50   Thread 0x7f0cceff5700 (LWP 74883) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  49   Thread 0x7f0cce7f4700 (LWP 74884) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  48   Thread 0x7f0ccdff3700 (LWP 74885) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  47   Thread 0x7f0ccd7f2700 (LWP 74886) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  46   Thread 0x7f0cccff1700 (LWP 74887) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  45   Thread 0x7f0cc7fff700 (LWP 74888) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  44   Thread 0x7f0cc77fe700 (LWP 74889) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  43   Thread 0x7f0cc6ffd700 (LWP 74890) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  42   Thread 0x7f0cc67fc700 (LWP 74891) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  41   Thread 0x7f0cc5ffb700 (LWP 74892) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  40   Thread 0x7f0cc57fa700 (LWP 74893) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  39   Thread 0x7f0cc4ff9700 (LWP 74894) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  38   Thread 0x7f0cb7fff700 (LWP 74895) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  37   Thread 0x7f0cb77fe700 (LWP 74896) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  36   Thread 0x7f0cb6ffd700 (LWP 74897) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n---Type <return> to continue, or q <return> to quit---\n  35   Thread 0x7f0cb67fc700 (LWP 74898) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  34   Thread 0x7f0cb5ffb700 (LWP 74899) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  33   Thread 0x7f0cb57fa700 (LWP 74900) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  32   Thread 0x7f0cb4ff9700 (LWP 74901) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  31   Thread 0x7f0caffff700 (LWP 74902) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  30   Thread 0x7f0caf7fe700 (LWP 74903) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  29   Thread 0x7f0caeffd700 (LWP 74904) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  28   Thread 0x7f0cae7fc700 (LWP 74905) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  27   Thread 0x7f0cadffb700 (LWP 74906) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  26   Thread 0x7f0cad7fa700 (LWP 74907) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  25   Thread 0x7f0cacff9700 (LWP 74908) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  24   Thread 0x7f0ca7fff700 (LWP 74909) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  23   Thread 0x7f0ca77fe700 (LWP 74910) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  22   Thread 0x7f0ca6ffd700 (LWP 74911) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  21   Thread 0x7f0ca67fc700 (LWP 74912) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  20   Thread 0x7f0ca5ffb700 (LWP 74913) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  19   Thread 0x7f0ca57fa700 (LWP 74914) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  18   Thread 0x7f0ca4ff9700 (LWP 74915) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  17   Thread 0x7f0ca47f8700 (LWP 74916) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  16   Thread 0x7f0ca3ff7700 (LWP 74917) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  15   Thread 0x7f0ca37f6700 (LWP 74918) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  14   Thread 0x7f0ca2ff5700 (LWP 74919) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  13   Thread 0x7f0ca27f4700 (LWP 74920) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  12   Thread 0x7f0ca1ff3700 (LWP 74921) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  11   Thread 0x7f0ca17f2700 (LWP 74922) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  10   Thread 0x7f0ca0ff1700 (LWP 74923) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  9    Thread 0x7f0c9bfff700 (LWP 74924) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  8    Thread 0x7f0c9b7fe700 (LWP 74925) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  7    Thread 0x7f0c9affd700 (LWP 74926) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  6    Thread 0x7f0c9a7fc700 (LWP 74927) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  5    Thread 0x7f0c99ffb700 (LWP 74928) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  4    Thread 0x7f0c997fa700 (LWP 74929) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  3    Thread 0x7f0c98ff9700 (LWP 74930) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n  2    Thread 0x7f0c987f8700 (LWP 74931) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n* 1    Thread 0x7f0d0ad4c780 (LWP 74835) \"label_image\" pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n(gdb) thread 53\n[Switching to thread 53 (Thread 0x7f0cd07f8700 (LWP 74880))]\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n185 in ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S\n(gdb) bt\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n#1  0x00007f0d09fb94bc in __gthread_cond_wait (__mutex=<optimized out>, __cond=<optimized out>)\n    at /build/buildd/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/include/x86_64-linux-gnu/bits/gthr-default.h:864\n#2  std::condition_variable::wait (this=<optimized out>, __lock=...) at ../../../../../src/libstdc++-v3/src/c++11/condition_variable.cc:52\n#3  0x00000000004464fc in Eigen::Notification::WaitForNotification() ()\n#4  0x000000000064f49a in void Eigen::TensorEvaluator<Eigen::TensorContractionOp<Eigen::array<Eigen::IndexPair<long>, 1ul> const, Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>::packRhsAndKernel<Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>, Eigen::internal::gemm_pack_rhs<float, long, Eigen::internal::TensorContractionSubMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, 4, 0, false, false>, Eigen::internal::gebp_kernel<float, float, long, Eigen::internal::blas_data_mapper<float, long, 0, 0>, 8, 4, false, false> >(Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>) ()\n#5  0x0000000000634b1f in std::_Function_handler<void (), std::_Bind<void (*(Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>))(Eigen::internal::packRhsAndKernelArg<float, float, Eigen::internal::TensorContractionInputMapper<float, long, 0, Eigen::TensorEvaluator<Eigen::TensorReshapingOp<Eigen::DSizes<long, 2> const, Eigen::TensorImagePatchOp<-1l, -1l, Eigen::TensorMap<Eigen::Tensor<float const, 4, 1, long>, 16> const> const> const, Eigen::ThreadPoolDevice>, Eigen::array<long, 1ul>, Eigen::array<long, 1ul>, 4, true, false, 0>, Eigen::internal::blas_data_mapper<float, long, 0, 0>, long>)> >::_M_invoke(std::_Any_data const&) ()\n#6  0x0000000000e44cef in std::_Function_handler<void (), tensorflow::thread::ThreadPoolDefaultImpl::ThreadPoolDefaultImpl(tensorflow::Env*, tensorflow::ThreadOptions const&, std::string const&, int)::{lambda()#1}>::_M_invoke(std::_Any_data const&) ()\n#7  0x00007f0d09fbca40 in std::(anonymous namespace)::execute_native_thread_routine (__p=<optimized out>) at ../../../../../src/libstdc++-v3/src/c++11/thread.cc:84\n#8  0x00007f0d0a217184 in start_thread (arg=0x7f0cd07f8700) at pthread_create.c:312\n#9  0x00007f0d09a2a34d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111\n```\n\nThis come up during testing of a faster thread pool implementation that has distributed queues and so does not preserve FIFO order. But I think it can come up with current pool as well (maybe after some unrelated code changes, or maybe just due to unlucky scheduling order).\n\nComputational tasks running on a fixed-size thread pool must not ever block. Instead they should schedule continuations. Besides deadlocks blocking leads to serious CPU underutilization. I.e. on my machine label_image utilizes only about half of cores, because half of threads in pool are blocked waiting for other tasks.\n"}