{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15564", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15564/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15564/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15564/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/15564", "id": 284010225, "node_id": "MDU6SXNzdWUyODQwMTAyMjU=", "number": 15564, "title": "sparsemax implementation is not infinite-safe", "user": {"login": "gcampax", "id": 876889, "node_id": "MDQ6VXNlcjg3Njg4OQ==", "avatar_url": "https://avatars2.githubusercontent.com/u/876889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gcampax", "html_url": "https://github.com/gcampax", "followers_url": "https://api.github.com/users/gcampax/followers", "following_url": "https://api.github.com/users/gcampax/following{/other_user}", "gists_url": "https://api.github.com/users/gcampax/gists{/gist_id}", "starred_url": "https://api.github.com/users/gcampax/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gcampax/subscriptions", "organizations_url": "https://api.github.com/users/gcampax/orgs", "repos_url": "https://api.github.com/users/gcampax/repos", "events_url": "https://api.github.com/users/gcampax/events{/privacy}", "received_events_url": "https://api.github.com/users/gcampax/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2017-12-21T21:31:31Z", "updated_at": "2018-10-05T23:17:46Z", "closed_at": "2018-10-05T23:17:46Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>\n<p><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nYes, but I have a simple reproducer below</p>\n</li>\n<li>\n<p><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Fedora 27</p>\n</li>\n<li>\n<p><strong>TensorFlow installed from (source or binary)</strong>: pip3 install --user tensorflow</p>\n</li>\n<li>\n<p><strong>TensorFlow version (use command below)</strong>:  1.4.0</p>\n</li>\n<li>\n<p><strong>Python version</strong>: 3.6.3</p>\n</li>\n<li>\n<p><strong>Bazel version (if compiling from source)</strong>: no</p>\n</li>\n<li>\n<p><strong>GCC/Compiler version (if compiling from source)</strong>: no</p>\n</li>\n<li>\n<p><strong>CUDA/cuDNN version</strong>: no</p>\n</li>\n<li>\n<p><strong>GPU model and memory</strong>: no (x86_64 CPU)</p>\n</li>\n<li>\n<p><strong>Exact command to reproduce</strong>:</p>\n</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>tf.contrib.sparsemax.sparsemax does not produce the correctly expected results when infinities are present in the input.</p>\n<p>Mathematically, a negative infinity should be treated the same as a very large negative number, and produce a 0 in the output.</p>\n<p>This is a real-world problem when sparsemax is combined with contrib.seq2seq.LuongAttention (as suggested in its documentation, and also as suggested in the sparsemax paper), because entries past the input length in the batch will have a score of -inf by default.</p>\n<h3>Source code / logs</h3>\n<p>Reproducer (assume tensorflow as tf)</p>\n<pre><code>&gt;&gt;&gt; tf.contrib.sparsemax.sparsemax([[1., -1e+5]]).eval(session=sess)\narray([[ 1.,  0.]], dtype=float32)\n&gt;&gt;&gt; tf.contrib.sparsemax.sparsemax([[1., float('-inf')]]).eval(session=sess)\n2017-12-21 22:13:55.697302: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n2017-12-21 22:13:55.697997: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n2017-12-21 22:13:55.699634: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n2017-12-21 22:13:55.699980: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\nTraceback (most recent call last):\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1323, in _do_call\n    return fn(*args)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1302, in _run_fn\n    status, run_metadata)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 473, in __exit__\n    c_api.TF_GetCode(self.status.status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"&lt;stdin&gt;\", line 1, in &lt;module&gt;\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 570, in eval\n    return _eval_using_default_session(self, feed_dict, self.graph, session)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 4455, in _eval_using_default_session\n    return session.run(tensors, feed_dict)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 889, in run\n    run_metadata_ptr)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1120, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1317, in _do_run\n    options, run_metadata)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1336, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\n\nCaused by op 'sparsemax_7/GatherNd', defined at:\n  File \"&lt;stdin&gt;\", line 1, in &lt;module&gt;\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/contrib/sparsemax/python/ops/sparsemax.py\", line 69, in sparsemax\n    tau_sum = array_ops.gather_nd(z_cumsum, indices)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1971, in gather_nd\n    \"GatherNd\", params=params, indices=indices, name=name)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2956, in create_op\n    op_def=op_def)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1470, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\n</code></pre>", "body_text": "System information\n\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nYes, but I have a simple reproducer below\n\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Fedora 27\n\n\nTensorFlow installed from (source or binary): pip3 install --user tensorflow\n\n\nTensorFlow version (use command below):  1.4.0\n\n\nPython version: 3.6.3\n\n\nBazel version (if compiling from source): no\n\n\nGCC/Compiler version (if compiling from source): no\n\n\nCUDA/cuDNN version: no\n\n\nGPU model and memory: no (x86_64 CPU)\n\n\nExact command to reproduce:\n\n\nDescribe the problem\ntf.contrib.sparsemax.sparsemax does not produce the correctly expected results when infinities are present in the input.\nMathematically, a negative infinity should be treated the same as a very large negative number, and produce a 0 in the output.\nThis is a real-world problem when sparsemax is combined with contrib.seq2seq.LuongAttention (as suggested in its documentation, and also as suggested in the sparsemax paper), because entries past the input length in the batch will have a score of -inf by default.\nSource code / logs\nReproducer (assume tensorflow as tf)\n>>> tf.contrib.sparsemax.sparsemax([[1., -1e+5]]).eval(session=sess)\narray([[ 1.,  0.]], dtype=float32)\n>>> tf.contrib.sparsemax.sparsemax([[1., float('-inf')]]).eval(session=sess)\n2017-12-21 22:13:55.697302: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n2017-12-21 22:13:55.697997: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n2017-12-21 22:13:55.699634: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n2017-12-21 22:13:55.699980: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\nTraceback (most recent call last):\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1323, in _do_call\n    return fn(*args)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1302, in _run_fn\n    status, run_metadata)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 473, in __exit__\n    c_api.TF_GetCode(self.status.status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 570, in eval\n    return _eval_using_default_session(self, feed_dict, self.graph, session)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 4455, in _eval_using_default_session\n    return session.run(tensors, feed_dict)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 889, in run\n    run_metadata_ptr)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1120, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1317, in _do_run\n    options, run_metadata)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1336, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\n\nCaused by op 'sparsemax_7/GatherNd', defined at:\n  File \"<stdin>\", line 1, in <module>\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/contrib/sparsemax/python/ops/sparsemax.py\", line 69, in sparsemax\n    tau_sum = array_ops.gather_nd(z_cumsum, indices)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1971, in gather_nd\n    \"GatherNd\", params=params, indices=indices, name=name)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2956, in create_op\n    op_def=op_def)\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1470, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nYes, but I have a simple reproducer below\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Fedora 27\r\n- **TensorFlow installed from (source or binary)**: pip3 install --user tensorflow\r\n- **TensorFlow version (use command below)**:  1.4.0\r\n- **Python version**: 3.6.3\r\n- **Bazel version (if compiling from source)**: no\r\n- **GCC/Compiler version (if compiling from source)**: no\r\n- **CUDA/cuDNN version**: no\r\n- **GPU model and memory**: no (x86_64 CPU)\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\ntf.contrib.sparsemax.sparsemax does not produce the correctly expected results when infinities are present in the input.\r\n\r\nMathematically, a negative infinity should be treated the same as a very large negative number, and produce a 0 in the output.\r\n\r\nThis is a real-world problem when sparsemax is combined with contrib.seq2seq.LuongAttention (as suggested in its documentation, and also as suggested in the sparsemax paper), because entries past the input length in the batch will have a score of -inf by default.\r\n\r\n### Source code / logs\r\n\r\nReproducer (assume tensorflow as tf)\r\n```\r\n>>> tf.contrib.sparsemax.sparsemax([[1., -1e+5]]).eval(session=sess)\r\narray([[ 1.,  0.]], dtype=float32)\r\n>>> tf.contrib.sparsemax.sparsemax([[1., float('-inf')]]).eval(session=sess)\r\n2017-12-21 22:13:55.697302: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\n2017-12-21 22:13:55.697997: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\n2017-12-21 22:13:55.699634: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\n2017-12-21 22:13:55.699980: W tensorflow/core/framework/op_kernel.cc:1192] Invalid argument: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\nTraceback (most recent call last):\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1323, in _do_call\r\n    return fn(*args)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1302, in _run_fn\r\n    status, run_metadata)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 473, in __exit__\r\n    c_api.TF_GetCode(self.status.status))\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 570, in eval\r\n    return _eval_using_default_session(self, feed_dict, self.graph, session)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 4455, in _eval_using_default_session\r\n    return session.run(tensors, feed_dict)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 889, in run\r\n    run_metadata_ptr)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1120, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1317, in _do_run\r\n    options, run_metadata)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1336, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\r\n\r\nCaused by op 'sparsemax_7/GatherNd', defined at:\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/contrib/sparsemax/python/ops/sparsemax.py\", line 69, in sparsemax\r\n    tau_sum = array_ops.gather_nd(z_cumsum, indices)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1971, in gather_nd\r\n    \"GatherNd\", params=params, indices=indices, name=name)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2956, in create_op\r\n    op_def=op_def)\r\n  File \"/home/redacted/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1470, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): flat indices[0, :] = [0, -1] does not index into param (shape: [1,2]).\r\n\t [[Node: sparsemax_7/GatherNd = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](sparsemax_7/sub, sparsemax_7/stack)]]\r\n```\r\n\r\n"}