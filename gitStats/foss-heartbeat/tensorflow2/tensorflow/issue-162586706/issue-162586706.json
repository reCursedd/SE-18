{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3067", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3067/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3067/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3067/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/3067", "id": 162586706, "node_id": "MDU6SXNzdWUxNjI1ODY3MDY=", "number": 3067, "title": "reshape on bad data: \"segment_ids[0] = -1 is out of range\"", "user": {"login": "MInner", "id": 5229267, "node_id": "MDQ6VXNlcjUyMjkyNjc=", "avatar_url": "https://avatars1.githubusercontent.com/u/5229267?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MInner", "html_url": "https://github.com/MInner", "followers_url": "https://api.github.com/users/MInner/followers", "following_url": "https://api.github.com/users/MInner/following{/other_user}", "gists_url": "https://api.github.com/users/MInner/gists{/gist_id}", "starred_url": "https://api.github.com/users/MInner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MInner/subscriptions", "organizations_url": "https://api.github.com/users/MInner/orgs", "repos_url": "https://api.github.com/users/MInner/repos", "events_url": "https://api.github.com/users/MInner/events{/privacy}", "received_events_url": "https://api.github.com/users/MInner/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-06-28T02:02:34Z", "updated_at": "2017-06-16T17:05:29Z", "closed_at": "2017-06-16T17:05:28Z", "author_association": "NONE", "body_html": "<p>This piece of code fails in <code>unsorted_segment_sum</code> inside <code>Reshape</code> op. It works just fine for a few batches and then fails on one specific batch of data: it just so happened (bug in my code) that the length of one line of the input of rnn turned out to be zero (and <code>length</code> param in <code>dynamic_rnn</code> was also zero), and I was passing the resulting tensor to a reshape, so it gave me this error:</p>\n<pre><code>InvalidArgumentError: segment_ids[0] = -1 is out of range [0, 100100)\n     [[Node: gradients/Reshape_grad/Reshape/tensor = UnsortedSegmentSum[T=DT_FLOAT, Tindices=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/Gather_grad/Reshape/_137, gradients/Gather_grad/Reshape_1/_139, gradients/Reshape_grad/Reshape/Squeeze/_141)]]\n     [[Node: gradients/Reshape_grad/Reshape/tensor/_143 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/gpu:2\", send_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device_incarnation=1, tensor_name=\"edge_31_gradients/Reshape_grad/Reshape/tensor\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:2\"]()]]\n...\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1383, in reshape\n    name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/op_def_library.py\", line 455, in apply_op\n    as_ref=input_arg.is_ref)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 620, in convert_to_tensor\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gradients.py\", line 94, in _IndexedSlicesToTensor\n    name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 2215, in unsorted_segment_sum\n    num_segments=num_segments, name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/op_def_library.py\", line 704, in apply_op\n    op_def=op_def)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2260, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n</code></pre>\n<p>here's the piece of code on which it fails:</p>\n<pre><code>def last_relevant(output, length):\n    batch_size = tf.shape(output)[0]\n    max_length = int(output.get_shape()[1])\n    output_size = int(output.get_shape()[2])\n    index = tf.range(0, batch_size) * max_length + (length - 1)\n    flat = tf.reshape(output, [-1, output_size])\n    relevant = tf.gather(flat, index)\n    return relevant\n</code></pre>\n<p>just wondering if error message could be less obscure.</p>", "body_text": "This piece of code fails in unsorted_segment_sum inside Reshape op. It works just fine for a few batches and then fails on one specific batch of data: it just so happened (bug in my code) that the length of one line of the input of rnn turned out to be zero (and length param in dynamic_rnn was also zero), and I was passing the resulting tensor to a reshape, so it gave me this error:\nInvalidArgumentError: segment_ids[0] = -1 is out of range [0, 100100)\n     [[Node: gradients/Reshape_grad/Reshape/tensor = UnsortedSegmentSum[T=DT_FLOAT, Tindices=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/Gather_grad/Reshape/_137, gradients/Gather_grad/Reshape_1/_139, gradients/Reshape_grad/Reshape/Squeeze/_141)]]\n     [[Node: gradients/Reshape_grad/Reshape/tensor/_143 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/gpu:2\", send_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device_incarnation=1, tensor_name=\"edge_31_gradients/Reshape_grad/Reshape/tensor\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:2\"]()]]\n...\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1383, in reshape\n    name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/op_def_library.py\", line 455, in apply_op\n    as_ref=input_arg.is_ref)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 620, in convert_to_tensor\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gradients.py\", line 94, in _IndexedSlicesToTensor\n    name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 2215, in unsorted_segment_sum\n    num_segments=num_segments, name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/op_def_library.py\", line 704, in apply_op\n    op_def=op_def)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2260, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n\nhere's the piece of code on which it fails:\ndef last_relevant(output, length):\n    batch_size = tf.shape(output)[0]\n    max_length = int(output.get_shape()[1])\n    output_size = int(output.get_shape()[2])\n    index = tf.range(0, batch_size) * max_length + (length - 1)\n    flat = tf.reshape(output, [-1, output_size])\n    relevant = tf.gather(flat, index)\n    return relevant\n\njust wondering if error message could be less obscure.", "body": "This piece of code fails in `unsorted_segment_sum` inside `Reshape` op. It works just fine for a few batches and then fails on one specific batch of data: it just so happened (bug in my code) that the length of one line of the input of rnn turned out to be zero (and `length` param in `dynamic_rnn` was also zero), and I was passing the resulting tensor to a reshape, so it gave me this error:\n\n```\nInvalidArgumentError: segment_ids[0] = -1 is out of range [0, 100100)\n     [[Node: gradients/Reshape_grad/Reshape/tensor = UnsortedSegmentSum[T=DT_FLOAT, Tindices=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/Gather_grad/Reshape/_137, gradients/Gather_grad/Reshape_1/_139, gradients/Reshape_grad/Reshape/Squeeze/_141)]]\n     [[Node: gradients/Reshape_grad/Reshape/tensor/_143 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/gpu:2\", send_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device_incarnation=1, tensor_name=\"edge_31_gradients/Reshape_grad/Reshape/tensor\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:2\"]()]]\n...\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1383, in reshape\n    name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/op_def_library.py\", line 455, in apply_op\n    as_ref=input_arg.is_ref)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 620, in convert_to_tensor\n    ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gradients.py\", line 94, in _IndexedSlicesToTensor\n    name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 2215, in unsorted_segment_sum\n    num_segments=num_segments, name=name)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/ops/op_def_library.py\", line 704, in apply_op\n    op_def=op_def)\n  File \"/home/usman/anaconda2/envs/tfpy3/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2260, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n```\n\nhere's the piece of code on which it fails:\n\n```\ndef last_relevant(output, length):\n    batch_size = tf.shape(output)[0]\n    max_length = int(output.get_shape()[1])\n    output_size = int(output.get_shape()[2])\n    index = tf.range(0, batch_size) * max_length + (length - 1)\n    flat = tf.reshape(output, [-1, output_size])\n    relevant = tf.gather(flat, index)\n    return relevant\n```\n\njust wondering if error message could be less obscure.\n"}