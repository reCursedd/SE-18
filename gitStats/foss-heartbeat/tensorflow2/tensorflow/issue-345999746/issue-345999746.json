{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21259", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21259/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21259/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21259/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21259", "id": 345999746, "node_id": "MDU6SXNzdWUzNDU5OTk3NDY=", "number": 21259, "title": "tf.data.Dataset.padded_batch() doesn't work with dataset.map", "user": {"login": "superhg2012", "id": 8817309, "node_id": "MDQ6VXNlcjg4MTczMDk=", "avatar_url": "https://avatars0.githubusercontent.com/u/8817309?v=4", "gravatar_id": "", "url": "https://api.github.com/users/superhg2012", "html_url": "https://github.com/superhg2012", "followers_url": "https://api.github.com/users/superhg2012/followers", "following_url": "https://api.github.com/users/superhg2012/following{/other_user}", "gists_url": "https://api.github.com/users/superhg2012/gists{/gist_id}", "starred_url": "https://api.github.com/users/superhg2012/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/superhg2012/subscriptions", "organizations_url": "https://api.github.com/users/superhg2012/orgs", "repos_url": "https://api.github.com/users/superhg2012/repos", "events_url": "https://api.github.com/users/superhg2012/events{/privacy}", "received_events_url": "https://api.github.com/users/superhg2012/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2018-07-31T01:20:36Z", "updated_at": "2018-08-03T07:46:39Z", "closed_at": "2018-07-31T03:16:12Z", "author_association": "NONE", "body_html": "<p>System information<br>\nHave I written custom code: yes<br>\nOS Platform and Distribution:  Ubuntu Linux<br>\nTensorFlow installed from: conda<br>\nTensorFlow version (use command below): 1.4.1<br>\nPython version: 3.6.5<br>\nDescribe the problem<br>\nIt's a image classification task to read variable-length images from png files, to map them and to padd them. But Dataset.padded_batch() doesn't work with tf.dataset which uses map</p>\n<pre><code># source codes\ndata.load_data() # load data from disk\nusable_data = data.get_data(use_percent=use_percent, tail=tail)\n# usable_data is a tuple for features and labels\ninit_hook = IteratorInitHook()\n\ndef input_fn():\n    dataset = tf.data.Dataset.from_tensor_slices(usable_data)\n    dataset = dataset.shuffle(params.shuffle_buffer_size)\n    dataset = dataset.map(data.instance_as_tensor) # the instance_as_tensor method transfer an image into feature and label tensors, the shape of feature is (?,?,?) and label shape is ()\n    dataset = dataset.repeat(epochs)\n    dataset = dataset.padded_batch(params.batch_size, padded_shapes=([None, None, None], []))\n\n    iterator = dataset.make_initializable_iterator()\n    init_hook.iterator_init = iterator.initializer\n    next_example, next_label = iterator.get_next()\n    return {'sgram': next_example}, next_label\n</code></pre>\n<p>Exception stack is</p>\n<p>Traceback (most recent call last):<br>\nFile \"main.py\", line 414, in <br>\ntf.app.run(main=train_or_predict)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 48, in run<br>\n_sys.exit(main(_sys.argv[:1] + flags_passthrough))<br>\nFile \"main.py\", line 405, in train_or_predict<br>\nhparams=params,<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/learn_runner.py\", line 218, in run<br>\nreturn _execute_schedule(experiment, schedule)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/learn_runner.py\", line 46, in _execute_schedule<br>\nreturn task()<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 625, in train_and_evaluate<br>\nself.train(delay_secs=0)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 367, in train<br>\nhooks=self._train_monitors + extra_hooks)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 807, in _call_train<br>\nhooks=hooks)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 302, in train<br>\nloss = self._train_model(input_fn, hooks, saving_listeners)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 708, in _train_model<br>\ninput_fn, model_fn_lib.ModeKeys.TRAIN)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 577, in _get_features_and_labels_from_input_fn<br>\nresult = self._call_input_fn(input_fn, mode)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 663, in _call_input_fn<br>\nreturn input_fn(**kwargs)<br>\nFile \"main.py\", line 218, in input_fn<br>\npadded_shapes=([None, None, None],[])<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 695, in padded_batch<br>\nreturn PaddedBatchDataset(self, batch_size, padded_shapes, padding_values)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1292, in <strong>init</strong><br>\ninput_dataset.output_shapes, _partial_shape_to_tensor, padded_shapes)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 512, in map_structure_up_to<br>\nassert_shallow_structure(shallow_tree, input_tree)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 372, in assert_shallow_structure<br>\ncheck_types=check_types)<br>\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 356, in assert_shallow_structure<br>\n\"Input has type: %s.\" % type(input_tree))<br>\nTypeError: If shallow structure is a sequence, input must also be a sequence. Input has type: &lt;class 'list'&gt;.</p>", "body_text": "System information\nHave I written custom code: yes\nOS Platform and Distribution:  Ubuntu Linux\nTensorFlow installed from: conda\nTensorFlow version (use command below): 1.4.1\nPython version: 3.6.5\nDescribe the problem\nIt's a image classification task to read variable-length images from png files, to map them and to padd them. But Dataset.padded_batch() doesn't work with tf.dataset which uses map\n# source codes\ndata.load_data() # load data from disk\nusable_data = data.get_data(use_percent=use_percent, tail=tail)\n# usable_data is a tuple for features and labels\ninit_hook = IteratorInitHook()\n\ndef input_fn():\n    dataset = tf.data.Dataset.from_tensor_slices(usable_data)\n    dataset = dataset.shuffle(params.shuffle_buffer_size)\n    dataset = dataset.map(data.instance_as_tensor) # the instance_as_tensor method transfer an image into feature and label tensors, the shape of feature is (?,?,?) and label shape is ()\n    dataset = dataset.repeat(epochs)\n    dataset = dataset.padded_batch(params.batch_size, padded_shapes=([None, None, None], []))\n\n    iterator = dataset.make_initializable_iterator()\n    init_hook.iterator_init = iterator.initializer\n    next_example, next_label = iterator.get_next()\n    return {'sgram': next_example}, next_label\n\nException stack is\nTraceback (most recent call last):\nFile \"main.py\", line 414, in \ntf.app.run(main=train_or_predict)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 48, in run\n_sys.exit(main(_sys.argv[:1] + flags_passthrough))\nFile \"main.py\", line 405, in train_or_predict\nhparams=params,\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/learn_runner.py\", line 218, in run\nreturn _execute_schedule(experiment, schedule)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/learn_runner.py\", line 46, in _execute_schedule\nreturn task()\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 625, in train_and_evaluate\nself.train(delay_secs=0)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 367, in train\nhooks=self._train_monitors + extra_hooks)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 807, in _call_train\nhooks=hooks)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 302, in train\nloss = self._train_model(input_fn, hooks, saving_listeners)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 708, in _train_model\ninput_fn, model_fn_lib.ModeKeys.TRAIN)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 577, in _get_features_and_labels_from_input_fn\nresult = self._call_input_fn(input_fn, mode)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 663, in _call_input_fn\nreturn input_fn(**kwargs)\nFile \"main.py\", line 218, in input_fn\npadded_shapes=([None, None, None],[])\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 695, in padded_batch\nreturn PaddedBatchDataset(self, batch_size, padded_shapes, padding_values)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1292, in init\ninput_dataset.output_shapes, _partial_shape_to_tensor, padded_shapes)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 512, in map_structure_up_to\nassert_shallow_structure(shallow_tree, input_tree)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 372, in assert_shallow_structure\ncheck_types=check_types)\nFile \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 356, in assert_shallow_structure\n\"Input has type: %s.\" % type(input_tree))\nTypeError: If shallow structure is a sequence, input must also be a sequence. Input has type: <class 'list'>.", "body": "System information\r\nHave I written custom code: yes\r\nOS Platform and Distribution:  Ubuntu Linux \r\nTensorFlow installed from: conda\r\nTensorFlow version (use command below): 1.4.1\r\nPython version: 3.6.5\r\nDescribe the problem\r\nIt's a image classification task to read variable-length images from png files, to map them and to padd them. But Dataset.padded_batch() doesn't work with tf.dataset which uses map \r\n    \r\n    # source codes\r\n    data.load_data() # load data from disk\r\n    usable_data = data.get_data(use_percent=use_percent, tail=tail)\r\n    # usable_data is a tuple for features and labels\r\n    init_hook = IteratorInitHook()\r\n\r\n    def input_fn():\r\n        dataset = tf.data.Dataset.from_tensor_slices(usable_data)\r\n        dataset = dataset.shuffle(params.shuffle_buffer_size)\r\n        dataset = dataset.map(data.instance_as_tensor) # the instance_as_tensor method transfer an image into feature and label tensors, the shape of feature is (?,?,?) and label shape is ()\r\n        dataset = dataset.repeat(epochs)\r\n        dataset = dataset.padded_batch(params.batch_size, padded_shapes=([None, None, None], []))\r\n\r\n        iterator = dataset.make_initializable_iterator()\r\n        init_hook.iterator_init = iterator.initializer\r\n        next_example, next_label = iterator.get_next()\r\n        return {'sgram': next_example}, next_label\r\n\r\nException stack is \r\n\r\nTraceback (most recent call last):\r\n  File \"main.py\", line 414, in <module>\r\n    tf.app.run(main=train_or_predict)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 48, in run\r\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\r\n  File \"main.py\", line 405, in train_or_predict\r\n    hparams=params,\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/learn_runner.py\", line 218, in run\r\n    return _execute_schedule(experiment, schedule)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/learn_runner.py\", line 46, in _execute_schedule\r\n    return task()\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 625, in train_and_evaluate\r\n    self.train(delay_secs=0)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 367, in train\r\n    hooks=self._train_monitors + extra_hooks)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 807, in _call_train\r\n    hooks=hooks)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 302, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 708, in _train_model\r\n    input_fn, model_fn_lib.ModeKeys.TRAIN)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 577, in _get_features_and_labels_from_input_fn\r\n    result = self._call_input_fn(input_fn, mode)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 663, in _call_input_fn\r\n    return input_fn(**kwargs)\r\n  File \"main.py\", line 218, in input_fn\r\n    padded_shapes=([None, None, None],[])\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 695, in padded_batch\r\n    return PaddedBatchDataset(self, batch_size, padded_shapes, padding_values)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1292, in __init__\r\n    input_dataset.output_shapes, _partial_shape_to_tensor, padded_shapes)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 512, in map_structure_up_to\r\n    assert_shallow_structure(shallow_tree, input_tree)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 372, in assert_shallow_structure\r\n    check_types=check_types)\r\n  File \"/data0/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/util/nest.py\", line 356, in assert_shallow_structure\r\n    \"Input has type: %s.\" % type(input_tree))\r\nTypeError: If shallow structure is a sequence, input must also be a sequence. Input has type: <class 'list'>."}