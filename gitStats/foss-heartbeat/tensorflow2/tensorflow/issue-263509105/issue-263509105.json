{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13530", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13530/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13530/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13530/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13530", "id": 263509105, "node_id": "MDU6SXNzdWUyNjM1MDkxMDU=", "number": 13530, "title": "Pandas_input_fn slow, starving CPU/GPU", "user": {"login": "mellvinbaker", "id": 26335535, "node_id": "MDQ6VXNlcjI2MzM1NTM1", "avatar_url": "https://avatars3.githubusercontent.com/u/26335535?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mellvinbaker", "html_url": "https://github.com/mellvinbaker", "followers_url": "https://api.github.com/users/mellvinbaker/followers", "following_url": "https://api.github.com/users/mellvinbaker/following{/other_user}", "gists_url": "https://api.github.com/users/mellvinbaker/gists{/gist_id}", "starred_url": "https://api.github.com/users/mellvinbaker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mellvinbaker/subscriptions", "organizations_url": "https://api.github.com/users/mellvinbaker/orgs", "repos_url": "https://api.github.com/users/mellvinbaker/repos", "events_url": "https://api.github.com/users/mellvinbaker/events{/privacy}", "received_events_url": "https://api.github.com/users/mellvinbaker/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": {"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 16, "created_at": "2017-10-06T16:54:00Z", "updated_at": "2018-11-14T21:58:48Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: It is a customized version of the Deep &amp; Wide example code. Fairly close to original code.</li>\n<li>**OS Platform and Distribution: Windows Server 2012 R2</li>\n<li>**TensorFlow installed from: nightly build WHL through pip (this was tried after numerous other versions, including install through pip)</li>\n<li><strong>TensorFlow version (use command below)</strong>: b'unknown' 1.4.0-dev20170926</li>\n<li><strong>Python version</strong>: 3.5 and 3.6</li>\n<li><strong>Bazel version (if compiling from source)</strong>: Not compiling</li>\n<li><strong>CUDA/cuDNN version</strong>: CUDA 8, CUDnn 6.1</li>\n<li><strong>GPU model and memory</strong>: Tesla M60 GPU 8GB</li>\n<li><strong>Exact command to reproduce</strong>:  See attached Script.<br>\n-For the record, the server vm has 8 xeon physical cores and 240 gb ram allocated. The CPU only machine is a new skylake i7 with 32gb ram.</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>To start, I submitted to stack overflow (<a href=\"https://stackoverflow.com/questions/46457476/tensorflow-pandas-input-fn-slow-starving-cpu-gpu\" rel=\"nofollow\">https://stackoverflow.com/questions/46457476/tensorflow-pandas-input-fn-slow-starving-cpu-gpu</a>) and have not been able to garner assistance after multiple edits to make sure it was framed correctly. I truly believe this is a bug since I am sticking so close to the example code, but if I have made a mistake I am deeply sorry to all of you.</p>\n<p>I am working on a wide and deep model following the framework in the Tensorflow Wide and Deep tutorial (<a href=\"https://www.tensorflow.org/tutorials/wide_and_deep\" rel=\"nofollow\">https://www.tensorflow.org/tutorials/wide_and_deep</a>). Model works fine when built the old way (load entire dataset from pandas, convert to tensors, feed in input_fn) which is ok for running on a CPU.</p>\n<p>However, to make it work on the GPU the dataset is too large to fit into GPU memory, so batching is necessary. I tried using the pandas_input_fn to batch data to the video card and noticed I get spikes of activity followed by long lulls while the next batch is prepared. The odd thing is, this happens even if I run it on a machine with CPU only. The lulls are almost the exact same length, so it isn't simply the video card crushing through a simple model faster than the proc can deliver it. It seems like it is always waiting to begin loading the next batch until the last one is done training.</p>\n<p>(If this function simply cannot be used in this way, can we get an example of Deep and Wide using the dataset API? or a manual build of deep and wide using layers and queues? At the moment, the example code for the dataset api using make_one_shot_iterator for canned estimators doesn't run.)</p>\n<p>I increased the complexity of the model to make sure it wasn't too easy to compute and still have the same issue. I have tried increasing the number of threads allocated to pandas_input_fn, I have tried increasing the queue size to far larger than seems reasonable (10x dataset size) which helps a bit, but not much. I am not sure if the slowdown is when it is queueing or de-queueing, but I have been unable to solve the issue after two weeks of troubleshooting. The data I am working with is 117 columns, 400k rows.</p>\n<p>I have created a generic script that generates fake values to simulate the problem. However, there are far fewer fake columns than real ones, so the gap between steps is not nearly as long, but still noticeable. Code attached.</p>\n<p>--</p>\n<h3>Source code / logs</h3>\n<p>attached<br>\n<a href=\"https://github.com/tensorflow/tensorflow/files/1363335/pandas_input_example.txt\">pandas_input_example.txt</a></p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): It is a customized version of the Deep & Wide example code. Fairly close to original code.\n**OS Platform and Distribution: Windows Server 2012 R2\n**TensorFlow installed from: nightly build WHL through pip (this was tried after numerous other versions, including install through pip)\nTensorFlow version (use command below): b'unknown' 1.4.0-dev20170926\nPython version: 3.5 and 3.6\nBazel version (if compiling from source): Not compiling\nCUDA/cuDNN version: CUDA 8, CUDnn 6.1\nGPU model and memory: Tesla M60 GPU 8GB\nExact command to reproduce:  See attached Script.\n-For the record, the server vm has 8 xeon physical cores and 240 gb ram allocated. The CPU only machine is a new skylake i7 with 32gb ram.\n\nDescribe the problem\nTo start, I submitted to stack overflow (https://stackoverflow.com/questions/46457476/tensorflow-pandas-input-fn-slow-starving-cpu-gpu) and have not been able to garner assistance after multiple edits to make sure it was framed correctly. I truly believe this is a bug since I am sticking so close to the example code, but if I have made a mistake I am deeply sorry to all of you.\nI am working on a wide and deep model following the framework in the Tensorflow Wide and Deep tutorial (https://www.tensorflow.org/tutorials/wide_and_deep). Model works fine when built the old way (load entire dataset from pandas, convert to tensors, feed in input_fn) which is ok for running on a CPU.\nHowever, to make it work on the GPU the dataset is too large to fit into GPU memory, so batching is necessary. I tried using the pandas_input_fn to batch data to the video card and noticed I get spikes of activity followed by long lulls while the next batch is prepared. The odd thing is, this happens even if I run it on a machine with CPU only. The lulls are almost the exact same length, so it isn't simply the video card crushing through a simple model faster than the proc can deliver it. It seems like it is always waiting to begin loading the next batch until the last one is done training.\n(If this function simply cannot be used in this way, can we get an example of Deep and Wide using the dataset API? or a manual build of deep and wide using layers and queues? At the moment, the example code for the dataset api using make_one_shot_iterator for canned estimators doesn't run.)\nI increased the complexity of the model to make sure it wasn't too easy to compute and still have the same issue. I have tried increasing the number of threads allocated to pandas_input_fn, I have tried increasing the queue size to far larger than seems reasonable (10x dataset size) which helps a bit, but not much. I am not sure if the slowdown is when it is queueing or de-queueing, but I have been unable to solve the issue after two weeks of troubleshooting. The data I am working with is 117 columns, 400k rows.\nI have created a generic script that generates fake values to simulate the problem. However, there are far fewer fake columns than real ones, so the gap between steps is not nearly as long, but still noticeable. Code attached.\n--\nSource code / logs\nattached\npandas_input_example.txt", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: It is a customized version of the Deep & Wide example code. Fairly close to original code.\r\n- **OS Platform and Distribution: Windows Server 2012 R2\r\n- **TensorFlow installed from: nightly build WHL through pip (this was tried after numerous other versions, including install through pip)\r\n- **TensorFlow version (use command below)**: b'unknown' 1.4.0-dev20170926\r\n- **Python version**: 3.5 and 3.6\r\n- **Bazel version (if compiling from source)**: Not compiling\r\n- **CUDA/cuDNN version**: CUDA 8, CUDnn 6.1\r\n- **GPU model and memory**: Tesla M60 GPU 8GB\r\n- **Exact command to reproduce**:  See attached Script.\r\n-For the record, the server vm has 8 xeon physical cores and 240 gb ram allocated. The CPU only machine is a new skylake i7 with 32gb ram.\r\n\r\n### Describe the problem\r\nTo start, I submitted to stack overflow (https://stackoverflow.com/questions/46457476/tensorflow-pandas-input-fn-slow-starving-cpu-gpu) and have not been able to garner assistance after multiple edits to make sure it was framed correctly. I truly believe this is a bug since I am sticking so close to the example code, but if I have made a mistake I am deeply sorry to all of you.\r\n\r\nI am working on a wide and deep model following the framework in the Tensorflow Wide and Deep tutorial (https://www.tensorflow.org/tutorials/wide_and_deep). Model works fine when built the old way (load entire dataset from pandas, convert to tensors, feed in input_fn) which is ok for running on a CPU. \r\n\r\nHowever, to make it work on the GPU the dataset is too large to fit into GPU memory, so batching is necessary. I tried using the pandas_input_fn to batch data to the video card and noticed I get spikes of activity followed by long lulls while the next batch is prepared. The odd thing is, this happens even if I run it on a machine with CPU only. The lulls are almost the exact same length, so it isn't simply the video card crushing through a simple model faster than the proc can deliver it. It seems like it is always waiting to begin loading the next batch until the last one is done training. \r\n\r\n(If this function simply cannot be used in this way, can we get an example of Deep and Wide using the dataset API? or a manual build of deep and wide using layers and queues? At the moment, the example code for the dataset api using make_one_shot_iterator for canned estimators doesn't run.)\r\n\r\nI increased the complexity of the model to make sure it wasn't too easy to compute and still have the same issue. I have tried increasing the number of threads allocated to pandas_input_fn, I have tried increasing the queue size to far larger than seems reasonable (10x dataset size) which helps a bit, but not much. I am not sure if the slowdown is when it is queueing or de-queueing, but I have been unable to solve the issue after two weeks of troubleshooting. The data I am working with is 117 columns, 400k rows.\r\n\r\nI have created a generic script that generates fake values to simulate the problem. However, there are far fewer fake columns than real ones, so the gap between steps is not nearly as long, but still noticeable. Code attached.\r\n\r\n\r\n--\r\n\r\n### Source code / logs\r\nattached\r\n[pandas_input_example.txt](https://github.com/tensorflow/tensorflow/files/1363335/pandas_input_example.txt)\r\n"}