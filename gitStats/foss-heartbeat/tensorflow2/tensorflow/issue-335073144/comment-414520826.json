{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/414520826", "html_url": "https://github.com/tensorflow/tensorflow/pull/20239#issuecomment-414520826", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20239", "id": 414520826, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNDUyMDgyNg==", "user": {"login": "pengwa", "id": 10530022, "node_id": "MDQ6VXNlcjEwNTMwMDIy", "avatar_url": "https://avatars1.githubusercontent.com/u/10530022?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pengwa", "html_url": "https://github.com/pengwa", "followers_url": "https://api.github.com/users/pengwa/followers", "following_url": "https://api.github.com/users/pengwa/following{/other_user}", "gists_url": "https://api.github.com/users/pengwa/gists{/gist_id}", "starred_url": "https://api.github.com/users/pengwa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pengwa/subscriptions", "organizations_url": "https://api.github.com/users/pengwa/orgs", "repos_url": "https://api.github.com/users/pengwa/repos", "events_url": "https://api.github.com/users/pengwa/events{/privacy}", "received_events_url": "https://api.github.com/users/pengwa/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-21T01:34:56Z", "updated_at": "2018-08-21T01:40:56Z", "author_association": "CONTRIBUTOR", "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=3731025\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/allenlavoie\">@allenlavoie</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1034716\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/zhangyaobit\">@zhangyaobit</a> Let me recap a bit about the issues, and possible solutions.</p>\n<p><strong>Issues</strong><br>\nIn memory optimizer, when it try to get GPU memory with following code, it get the full GPU memory size, this is not correct when use already set per_process_gpu_memory_fraction.  <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/memory_optimizer.cc#L969\">tensorflow/tensorflow/core/grappler/optimizers/memory_optimizer.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 969\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/575db18083d5437fd7a87ccf3414303498911bb1\">575db18</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L969\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"969\"></td>\n          <td id=\"LC969\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (mem_usage.<span class=\"pl-smi\">used_memory</span> &lt;= prop.<span class=\"pl-c1\">memory_size</span>()) { </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n,</p>\n<p><strong>Analysis</strong></p>\n<ul>\n<li>\n<p>VirtualCluster is used in memoryoptimizer which is called by metaoptimizer (<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/meta_optimizer.cc#L305\">tensorflow/tensorflow/core/grappler/optimizers/meta_optimizer.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 305\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/575db18083d5437fd7a87ccf3414303498911bb1\">575db18</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L305\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"305\"></td>\n          <td id=\"LC305\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> optimizer-&gt;<span class=\"pl-c1\">Optimize</span>(cluster, *optimized_item, optimized_graph); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n).</p>\n</li>\n<li>\n<p>VirtualCluster-&gt;GeDevices() (in <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/memory_optimizer.cc#L949\">tensorflow/tensorflow/core/grappler/optimizers/memory_optimizer.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 949\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/575db18083d5437fd7a87ccf3414303498911bb1\">575db18</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L949\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"949\"></td>\n          <td id=\"LC949\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> cluster-&gt;<span class=\"pl-c1\">GetDevices</span>(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n) return the \"std::unordered_map&lt;string, DeviceProperties&gt; devices_\" defined in VirtualCLuster's base class Cluster.h.</p>\n</li>\n<li>\n<p>devices_ is initialized during VirtualCluster constructors (<a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/virtual_cluster.cc\">https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/virtual_cluster.cc</a>).<br>\nin this usage of memory_optimizer, the consturctor used is the 3rd one: <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/virtual_cluster.cc#L42\">tensorflow/tensorflow/core/grappler/clusters/virtual_cluster.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 42\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/575db18083d5437fd7a87ccf3414303498911bb1\">575db18</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L42\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"42\"></td>\n          <td id=\"LC42\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-en\">VirtualCluster::VirtualCluster</span>(<span class=\"pl-k\">const</span> DeviceSet* device_set) </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n.</p>\n</li>\n<li>\n<p>Once devices_ is set, calling prop.memory_size() in <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/memory_optimizer.cc#L969\">tensorflow/tensorflow/core/grappler/optimizers/memory_optimizer.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 969\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/575db18083d5437fd7a87ccf3414303498911bb1\">575db18</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L969\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"969\"></td>\n          <td id=\"LC969\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (mem_usage.<span class=\"pl-smi\">used_memory</span> &lt;= prop.<span class=\"pl-c1\">memory_size</span>()) { </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n return the total gpu memory (because of <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/utils.cc#L101\">tensorflow/tensorflow/core/grappler/clusters/utils.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 101\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/575db18083d5437fd7a87ccf3414303498911bb1\">575db18</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L101\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"101\"></td>\n          <td id=\"LC101\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> device.<span class=\"pl-c1\">set_memory_size</span>(properties.<span class=\"pl-smi\">totalGlobalMem</span>); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n). It does not care about setting like per_process_gpu_memory_fraction.</p>\n</li>\n</ul>\n<p><strong>On the other hand</strong></p>\n<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=3731025\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/allenlavoie\">@allenlavoie</a> suggests that actually another cluster single_machine.cc is overriding the device property's memory_size (<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/fe12159e60258d0b6cae9b580e248b22e80f3f7b/tensorflow/core/grappler/clusters/single_machine.cc#L108\">tensorflow/tensorflow/core/grappler/clusters/single_machine.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 108\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/fe12159e60258d0b6cae9b580e248b22e80f3f7b\">fe12159</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L108\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"108\"></td>\n          <td id=\"LC108\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-c\"><span class=\"pl-c\">//</span> Overwrite the memory size since users might have requested to use only a</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n) considering about user defined per_process_gpu_memory_fraction. (Though single_machine.cc is initlizing its devices_ in Provision, which is different with VirtualCluster, but I think it's not a big deal.)</p>\n<p>So there seems to be 2 solutions:</p>\n<ul>\n<li>Override the memory_size in VirtualCluster's constructor ( I think only the 3rd constructor should be modified, since the first 2 constructor accept DeviceProperties as input, which should be controlled by caller).</li>\n<li>My current fixing.</li>\n</ul>\n<p>I prefer the 1st one, while still appreciate your comments about this. Thanks a lot!!</p>", "body_text": "@allenlavoie @zhangyaobit Let me recap a bit about the issues, and possible solutions.\nIssues\nIn memory optimizer, when it try to get GPU memory with following code, it get the full GPU memory size, this is not correct when use already set per_process_gpu_memory_fraction.  \n  \n    \n      tensorflow/tensorflow/core/grappler/optimizers/memory_optimizer.cc\n    \n    \n         Line 969\n      in\n      575db18\n    \n    \n    \n    \n\n        \n          \n           if (mem_usage.used_memory <= prop.memory_size()) { \n        \n    \n  \n\n,\nAnalysis\n\n\nVirtualCluster is used in memoryoptimizer which is called by metaoptimizer (\n  \n    \n      tensorflow/tensorflow/core/grappler/optimizers/meta_optimizer.cc\n    \n    \n         Line 305\n      in\n      575db18\n    \n    \n    \n    \n\n        \n          \n           optimizer->Optimize(cluster, *optimized_item, optimized_graph); \n        \n    \n  \n\n).\n\n\nVirtualCluster->GeDevices() (in \n  \n    \n      tensorflow/tensorflow/core/grappler/optimizers/memory_optimizer.cc\n    \n    \n         Line 949\n      in\n      575db18\n    \n    \n    \n    \n\n        \n          \n           cluster->GetDevices(); \n        \n    \n  \n\n) return the \"std::unordered_map<string, DeviceProperties> devices_\" defined in VirtualCLuster's base class Cluster.h.\n\n\ndevices_ is initialized during VirtualCluster constructors (https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/virtual_cluster.cc).\nin this usage of memory_optimizer, the consturctor used is the 3rd one: \n  \n    \n      tensorflow/tensorflow/core/grappler/clusters/virtual_cluster.cc\n    \n    \n         Line 42\n      in\n      575db18\n    \n    \n    \n    \n\n        \n          \n           VirtualCluster::VirtualCluster(const DeviceSet* device_set) \n        \n    \n  \n\n.\n\n\nOnce devices_ is set, calling prop.memory_size() in \n  \n    \n      tensorflow/tensorflow/core/grappler/optimizers/memory_optimizer.cc\n    \n    \n         Line 969\n      in\n      575db18\n    \n    \n    \n    \n\n        \n          \n           if (mem_usage.used_memory <= prop.memory_size()) { \n        \n    \n  \n\n return the total gpu memory (because of \n  \n    \n      tensorflow/tensorflow/core/grappler/clusters/utils.cc\n    \n    \n         Line 101\n      in\n      575db18\n    \n    \n    \n    \n\n        \n          \n           device.set_memory_size(properties.totalGlobalMem); \n        \n    \n  \n\n). It does not care about setting like per_process_gpu_memory_fraction.\n\n\nOn the other hand\n@allenlavoie suggests that actually another cluster single_machine.cc is overriding the device property's memory_size (\n  \n    \n      tensorflow/tensorflow/core/grappler/clusters/single_machine.cc\n    \n    \n         Line 108\n      in\n      fe12159\n    \n    \n    \n    \n\n        \n          \n           // Overwrite the memory size since users might have requested to use only a \n        \n    \n  \n\n) considering about user defined per_process_gpu_memory_fraction. (Though single_machine.cc is initlizing its devices_ in Provision, which is different with VirtualCluster, but I think it's not a big deal.)\nSo there seems to be 2 solutions:\n\nOverride the memory_size in VirtualCluster's constructor ( I think only the 3rd constructor should be modified, since the first 2 constructor accept DeviceProperties as input, which should be controlled by caller).\nMy current fixing.\n\nI prefer the 1st one, while still appreciate your comments about this. Thanks a lot!!", "body": "@allenlavoie @zhangyaobit Let me recap a bit about the issues, and possible solutions. \r\n\r\n**Issues**\r\nIn memory optimizer, when it try to get GPU memory with following code, it get the full GPU memory size, this is not correct when use already set per_process_gpu_memory_fraction.  https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/memory_optimizer.cc#L969, \r\n\r\n\r\n**Analysis**\r\n- VirtualCluster is used in memoryoptimizer which is called by metaoptimizer (https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/meta_optimizer.cc#L305).  \r\n- VirtualCluster->GeDevices() (in https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/memory_optimizer.cc#L949) return the \"std::unordered_map<string, DeviceProperties> devices_\" defined in VirtualCLuster's base class Cluster.h. \r\n- devices_ is initialized during VirtualCluster constructors (https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/virtual_cluster.cc). \r\n in this usage of memory_optimizer, the consturctor used is the 3rd one: https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/virtual_cluster.cc#L42. \r\n\r\n- Once devices_ is set, calling prop.memory_size() in https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/optimizers/memory_optimizer.cc#L969 return the total gpu memory (because of https://github.com/tensorflow/tensorflow/blob/575db18083d5437fd7a87ccf3414303498911bb1/tensorflow/core/grappler/clusters/utils.cc#L101). It does not care about setting like per_process_gpu_memory_fraction.  \r\n\r\n\r\n\r\n**On the other hand**\r\n\r\n @allenlavoie suggests that actually another cluster single_machine.cc is overriding the device property's memory_size (https://github.com/tensorflow/tensorflow/blob/fe12159e60258d0b6cae9b580e248b22e80f3f7b/tensorflow/core/grappler/clusters/single_machine.cc#L108) considering about user defined per_process_gpu_memory_fraction. (Though single_machine.cc is initlizing its devices_ in Provision, which is different with VirtualCluster, but I think it's not a big deal.)\r\n\r\nSo there seems to be 2 solutions:\r\n\r\n- Override the memory_size in VirtualCluster's constructor ( I think only the 3rd constructor should be modified, since the first 2 constructor accept DeviceProperties as input, which should be controlled by caller). \r\n- My current fixing. \r\n\r\nI prefer the 1st one, while still appreciate your comments about this. Thanks a lot!!  "}