{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22364", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22364/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22364/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22364/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22364", "id": 361536469, "node_id": "MDU6SXNzdWUzNjE1MzY0Njk=", "number": 22364, "title": "Estimator with MirroredStrategy on multiple GPUs seems to start with non-initialized weights on one of the GPUs", "user": {"login": "kahkeng", "id": 141746, "node_id": "MDQ6VXNlcjE0MTc0Ng==", "avatar_url": "https://avatars3.githubusercontent.com/u/141746?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kahkeng", "html_url": "https://github.com/kahkeng", "followers_url": "https://api.github.com/users/kahkeng/followers", "following_url": "https://api.github.com/users/kahkeng/following{/other_user}", "gists_url": "https://api.github.com/users/kahkeng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kahkeng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kahkeng/subscriptions", "organizations_url": "https://api.github.com/users/kahkeng/orgs", "repos_url": "https://api.github.com/users/kahkeng/repos", "events_url": "https://api.github.com/users/kahkeng/events{/privacy}", "received_events_url": "https://api.github.com/users/kahkeng/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-09-19T00:53:37Z", "updated_at": "2018-09-24T18:05:18Z", "closed_at": "2018-09-24T18:05:18Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: slightly modified example code</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>: n/a</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary (pip)</li>\n<li><strong>TensorFlow version (use command below)</strong>: ('v1.10.1-0-g4dcfddc5d1', '1.10.1')</li>\n<li><strong>Python version</strong>: 2.7.12</li>\n<li><strong>Bazel version (if compiling from source)</strong>: n/a</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: n/a</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0/7.1.4</li>\n<li><strong>GPU model and memory</strong>: GeForce GTX 1080</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<p>Slightly modified version of <a href=\"https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/distribute#example-with-estimator-api\">https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/distribute#example-with-estimator-api</a> to add some print nodes.</p>\n<pre><code>\n    import tensorflow as tf\n    \n    def build_model_fn_optimizer():\n\n        def model_fn(features, labels, mode):\n            features = tf.Print(features, [features], message=\"features = \")\n            layer = tf.layers.Dense(1, use_bias=True)\n            logits = layer(features)\n            logits = tf.Print(logits, [logits], message=\"logits = \")\n\n            if mode == tf.estimator.ModeKeys.PREDICT:\n                predictions = {\"logits\": logits}\n                return tf.estimator.EstimatorSpec(mode, predictions=predictions)\n\n            loss = tf.losses.mean_squared_error(\n                labels=labels, predictions=tf.reshape(logits, []))\n\n            if mode == tf.estimator.ModeKeys.EVAL:\n                return tf.estimator.EstimatorSpec(mode, loss=loss)\n\n            if mode == tf.estimator.ModeKeys.TRAIN:\n                train_op = tf.train.GradientDescentOptimizer(0.2).minimize(loss)\n                return tf.estimator.EstimatorSpec(mode, loss=loss, train_op=train_op)\n\n        return model_fn\n    \n    def main(_):\n        #distribution = tf.contrib.distribute.OneDeviceStrategy(\"/device:GPU:0\")\n        distribution = tf.contrib.distribute.MirroredStrategy(\n            [\"/device:GPU:0\", \"/device:GPU:1\"]\n        )\n        config = tf.estimator.RunConfig(train_distribute=distribution)\n    \n        def input_fn():\n            features = tf.data.Dataset.from_tensors([[1.]]).repeat(10)\n            labels = tf.data.Dataset.from_tensors(1.).repeat(10)\n            return tf.data.Dataset.zip((features, labels))\n    \n        estimator = tf.estimator.Estimator(\n            model_fn=build_model_fn_optimizer(), config=config)\n        estimator.train(input_fn=input_fn, steps=10)\n    \n        eval_result = estimator.evaluate(input_fn=input_fn, steps=10)\n        print(\"Eval result: {}\".format(eval_result))\n    \n        def predict_input_fn():\n            predict_features = tf.data.Dataset.from_tensors([[1.]]).repeat(10)\n            return predict_features\n    \n        predictions = estimator.predict(input_fn=predict_input_fn)\n        predictions = list(predictions)\n        print(\"Prediction results: {}\".format(predictions))\n    \n    \n    if __name__ == \"__main__\":\n        tf.app.run()\n\n</code></pre>\n<p>The output I get is the following:</p>\n<pre><code>WARNING:tensorflow:Using temporary folder as model directory: /tmp/tmpygBKCI\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': &lt;tensorflow.python.training.server_lib.ClusterSpec object at 0x7f3bd6649b90&gt;, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_device_fn': None, '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': '/tmp/tmpygBKCI', '_train_distribute': &lt;tensorflow.contrib.distribute.python.mirrored_strategy.MirroredStrategy object at 0x7f3bd6649b10&gt;, '_save_summary_steps': 100}\n2018-09-18 23:44:42.051140: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-09-18 23:44:42.244608: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 0 with properties:\nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\npciBusID: 0000:08:00.0\ntotalMemory: 10.92GiB freeMemory: 9.93GiB\n2018-09-18 23:44:42.392404: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-09-18 23:44:42.394060: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 1 with properties:\nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\npciBusID: 0000:42:00.0\ntotalMemory: 10.92GiB freeMemory: 10.76GiB\n2018-09-18 23:44:42.398325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:42.808254: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:42.808317: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:42.808325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:42.808331: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:42.808726: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/device:GPU:0 with 9603 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:42.887416: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/device:GPU:1 with 10403 MB memory) -&gt; physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Device is available but not used by distribute strategy: /device:CPU:0\nINFO:tensorflow:Configured nccl all-reduce.\n2018-09-18 23:44:42.999232: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:42.999351: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:42.999364: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:42.999371: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:42.999379: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:42.999591: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:42.999726: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -&gt; physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:batch_all_reduce invoked for batches size = 2 with algorithm = nccl, num_packs = 1, agg_small_grads_max_bytes = 0 and agg_small_grads_max_group = 10\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-09-18 23:44:43.215770: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:43.215877: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:43.215889: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:43.215897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:43.215904: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:43.216104: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:43.216251: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -&gt; physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 0 into /tmp/tmpygBKCI/model.ckpt.\nfeatures = [[1]]\nlogits = [[0]]\nfeatures = [[1]]\nlogits = [[-0.225562453]]\nINFO:tensorflow:loss = 1.2510016, step = 0\nfeatures = [[1]]\nlogits = [[0]]\nfeatures = [[1]]\nlogits = [[0.6646626]]\nfeatures = [[1]]\nfeatures = [[1]]\nlogits = [[-5.94375372]]\nlogits = [[1.19879758]]\nfeatures = [[1]]\nlogits = [[-23.9573383]]\nfeatures = [[1]]\nlogits = [[3.89678]]\nfeatures = [[1]]\nfeatures = [[1]]\nlogits = [[-82.8739166]]\nlogits = [[12.7210035]]\nINFO:tensorflow:Saving checkpoints for 5 into /tmp/tmpygBKCI/model.ckpt.\nINFO:tensorflow:Loss for final step: 3586.108.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-09-18-23:44:45\nINFO:tensorflow:Graph was finalized.\n2018-09-18 23:44:45.322872: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:45.322972: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:45.322984: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:45.322992: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:45.323000: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:45.323190: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:45.323319: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -&gt; physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from /tmp/tmpygBKCI/model.ckpt-5\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\n</code></pre>\n<p>Notice that the logits comes out printed as zero the first and third time, which suggests the weights for at least one of the GPU towers is all zeroes at the start (or both are all zeros initially but the prints are showing up interwoven between the two towers).</p>\n<p>If I run the code with just a single GPU using OneDeviceStrategy, this does not happen (first logit value printed out is non-zero due to random initial weights).</p>\n<p>This affects training for more complicated scenarios since it could lead to incorrect loss computation.</p>\n<p>Still happens if I upgrade to TensorFlow 1.11.0-rc1 ('v1.11.0-rc1-0-ge4c4b20805').</p>\n<p>I posted on <a href=\"https://stackoverflow.com/questions/52396116/tensorflow-estimator-with-mirroredstrategy-on-multiple-gpus-seems-to-start-with\" rel=\"nofollow\">StackOverflow</a> but also decided to open this issue since it seems somewhat similar to the variable initialization issue reported in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"320065577\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/19069\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/19069/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/19069\">#19069</a> which is supposedly fixed. If this is more appropriate on StackOverflow, I can wait for responses there. Thanks!</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): slightly modified example code\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: n/a\nTensorFlow installed from (source or binary): binary (pip)\nTensorFlow version (use command below): ('v1.10.1-0-g4dcfddc5d1', '1.10.1')\nPython version: 2.7.12\nBazel version (if compiling from source): n/a\nGCC/Compiler version (if compiling from source): n/a\nCUDA/cuDNN version: 9.0/7.1.4\nGPU model and memory: GeForce GTX 1080\nExact command to reproduce:\n\nSlightly modified version of https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/distribute#example-with-estimator-api to add some print nodes.\n\n    import tensorflow as tf\n    \n    def build_model_fn_optimizer():\n\n        def model_fn(features, labels, mode):\n            features = tf.Print(features, [features], message=\"features = \")\n            layer = tf.layers.Dense(1, use_bias=True)\n            logits = layer(features)\n            logits = tf.Print(logits, [logits], message=\"logits = \")\n\n            if mode == tf.estimator.ModeKeys.PREDICT:\n                predictions = {\"logits\": logits}\n                return tf.estimator.EstimatorSpec(mode, predictions=predictions)\n\n            loss = tf.losses.mean_squared_error(\n                labels=labels, predictions=tf.reshape(logits, []))\n\n            if mode == tf.estimator.ModeKeys.EVAL:\n                return tf.estimator.EstimatorSpec(mode, loss=loss)\n\n            if mode == tf.estimator.ModeKeys.TRAIN:\n                train_op = tf.train.GradientDescentOptimizer(0.2).minimize(loss)\n                return tf.estimator.EstimatorSpec(mode, loss=loss, train_op=train_op)\n\n        return model_fn\n    \n    def main(_):\n        #distribution = tf.contrib.distribute.OneDeviceStrategy(\"/device:GPU:0\")\n        distribution = tf.contrib.distribute.MirroredStrategy(\n            [\"/device:GPU:0\", \"/device:GPU:1\"]\n        )\n        config = tf.estimator.RunConfig(train_distribute=distribution)\n    \n        def input_fn():\n            features = tf.data.Dataset.from_tensors([[1.]]).repeat(10)\n            labels = tf.data.Dataset.from_tensors(1.).repeat(10)\n            return tf.data.Dataset.zip((features, labels))\n    \n        estimator = tf.estimator.Estimator(\n            model_fn=build_model_fn_optimizer(), config=config)\n        estimator.train(input_fn=input_fn, steps=10)\n    \n        eval_result = estimator.evaluate(input_fn=input_fn, steps=10)\n        print(\"Eval result: {}\".format(eval_result))\n    \n        def predict_input_fn():\n            predict_features = tf.data.Dataset.from_tensors([[1.]]).repeat(10)\n            return predict_features\n    \n        predictions = estimator.predict(input_fn=predict_input_fn)\n        predictions = list(predictions)\n        print(\"Prediction results: {}\".format(predictions))\n    \n    \n    if __name__ == \"__main__\":\n        tf.app.run()\n\n\nThe output I get is the following:\nWARNING:tensorflow:Using temporary folder as model directory: /tmp/tmpygBKCI\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f3bd6649b90>, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_device_fn': None, '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': '/tmp/tmpygBKCI', '_train_distribute': <tensorflow.contrib.distribute.python.mirrored_strategy.MirroredStrategy object at 0x7f3bd6649b10>, '_save_summary_steps': 100}\n2018-09-18 23:44:42.051140: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-09-18 23:44:42.244608: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 0 with properties:\nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\npciBusID: 0000:08:00.0\ntotalMemory: 10.92GiB freeMemory: 9.93GiB\n2018-09-18 23:44:42.392404: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-09-18 23:44:42.394060: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 1 with properties:\nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\npciBusID: 0000:42:00.0\ntotalMemory: 10.92GiB freeMemory: 10.76GiB\n2018-09-18 23:44:42.398325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:42.808254: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:42.808317: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:42.808325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:42.808331: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:42.808726: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:42.887416: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Device is available but not used by distribute strategy: /device:CPU:0\nINFO:tensorflow:Configured nccl all-reduce.\n2018-09-18 23:44:42.999232: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:42.999351: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:42.999364: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:42.999371: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:42.999379: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:42.999591: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:42.999726: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:batch_all_reduce invoked for batches size = 2 with algorithm = nccl, num_packs = 1, agg_small_grads_max_bytes = 0 and agg_small_grads_max_group = 10\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-09-18 23:44:43.215770: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:43.215877: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:43.215889: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:43.215897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:43.215904: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:43.216104: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:43.216251: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 0 into /tmp/tmpygBKCI/model.ckpt.\nfeatures = [[1]]\nlogits = [[0]]\nfeatures = [[1]]\nlogits = [[-0.225562453]]\nINFO:tensorflow:loss = 1.2510016, step = 0\nfeatures = [[1]]\nlogits = [[0]]\nfeatures = [[1]]\nlogits = [[0.6646626]]\nfeatures = [[1]]\nfeatures = [[1]]\nlogits = [[-5.94375372]]\nlogits = [[1.19879758]]\nfeatures = [[1]]\nlogits = [[-23.9573383]]\nfeatures = [[1]]\nlogits = [[3.89678]]\nfeatures = [[1]]\nfeatures = [[1]]\nlogits = [[-82.8739166]]\nlogits = [[12.7210035]]\nINFO:tensorflow:Saving checkpoints for 5 into /tmp/tmpygBKCI/model.ckpt.\nINFO:tensorflow:Loss for final step: 3586.108.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-09-18-23:44:45\nINFO:tensorflow:Graph was finalized.\n2018-09-18 23:44:45.322872: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\n2018-09-18 23:44:45.322972: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-09-18 23:44:45.322984: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\n2018-09-18 23:44:45.322992: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\n2018-09-18 23:44:45.323000: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\n2018-09-18 23:44:45.323190: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\n2018-09-18 23:44:45.323319: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from /tmp/tmpygBKCI/model.ckpt-5\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\n\nNotice that the logits comes out printed as zero the first and third time, which suggests the weights for at least one of the GPU towers is all zeroes at the start (or both are all zeros initially but the prints are showing up interwoven between the two towers).\nIf I run the code with just a single GPU using OneDeviceStrategy, this does not happen (first logit value printed out is non-zero due to random initial weights).\nThis affects training for more complicated scenarios since it could lead to incorrect loss computation.\nStill happens if I upgrade to TensorFlow 1.11.0-rc1 ('v1.11.0-rc1-0-ge4c4b20805').\nI posted on StackOverflow but also decided to open this issue since it seems somewhat similar to the variable initialization issue reported in #19069 which is supposedly fixed. If this is more appropriate on StackOverflow, I can wait for responses there. Thanks!", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: slightly modified example code\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**: n/a\r\n- **TensorFlow installed from (source or binary)**: binary (pip)\r\n- **TensorFlow version (use command below)**: ('v1.10.1-0-g4dcfddc5d1', '1.10.1')\r\n- **Python version**: 2.7.12\r\n- **Bazel version (if compiling from source)**: n/a\r\n- **GCC/Compiler version (if compiling from source)**: n/a\r\n- **CUDA/cuDNN version**: 9.0/7.1.4\r\n- **GPU model and memory**: GeForce GTX 1080\r\n- **Exact command to reproduce**:\r\n\r\nSlightly modified version of https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/distribute#example-with-estimator-api to add some print nodes.\r\n\r\n```\r\n\r\n    import tensorflow as tf\r\n    \r\n    def build_model_fn_optimizer():\r\n\r\n        def model_fn(features, labels, mode):\r\n            features = tf.Print(features, [features], message=\"features = \")\r\n            layer = tf.layers.Dense(1, use_bias=True)\r\n            logits = layer(features)\r\n            logits = tf.Print(logits, [logits], message=\"logits = \")\r\n\r\n            if mode == tf.estimator.ModeKeys.PREDICT:\r\n                predictions = {\"logits\": logits}\r\n                return tf.estimator.EstimatorSpec(mode, predictions=predictions)\r\n\r\n            loss = tf.losses.mean_squared_error(\r\n                labels=labels, predictions=tf.reshape(logits, []))\r\n\r\n            if mode == tf.estimator.ModeKeys.EVAL:\r\n                return tf.estimator.EstimatorSpec(mode, loss=loss)\r\n\r\n            if mode == tf.estimator.ModeKeys.TRAIN:\r\n                train_op = tf.train.GradientDescentOptimizer(0.2).minimize(loss)\r\n                return tf.estimator.EstimatorSpec(mode, loss=loss, train_op=train_op)\r\n\r\n        return model_fn\r\n    \r\n    def main(_):\r\n        #distribution = tf.contrib.distribute.OneDeviceStrategy(\"/device:GPU:0\")\r\n        distribution = tf.contrib.distribute.MirroredStrategy(\r\n            [\"/device:GPU:0\", \"/device:GPU:1\"]\r\n        )\r\n        config = tf.estimator.RunConfig(train_distribute=distribution)\r\n    \r\n        def input_fn():\r\n            features = tf.data.Dataset.from_tensors([[1.]]).repeat(10)\r\n            labels = tf.data.Dataset.from_tensors(1.).repeat(10)\r\n            return tf.data.Dataset.zip((features, labels))\r\n    \r\n        estimator = tf.estimator.Estimator(\r\n            model_fn=build_model_fn_optimizer(), config=config)\r\n        estimator.train(input_fn=input_fn, steps=10)\r\n    \r\n        eval_result = estimator.evaluate(input_fn=input_fn, steps=10)\r\n        print(\"Eval result: {}\".format(eval_result))\r\n    \r\n        def predict_input_fn():\r\n            predict_features = tf.data.Dataset.from_tensors([[1.]]).repeat(10)\r\n            return predict_features\r\n    \r\n        predictions = estimator.predict(input_fn=predict_input_fn)\r\n        predictions = list(predictions)\r\n        print(\"Prediction results: {}\".format(predictions))\r\n    \r\n    \r\n    if __name__ == \"__main__\":\r\n        tf.app.run()\r\n\r\n```\r\n\r\nThe output I get is the following:\r\n\r\n    WARNING:tensorflow:Using temporary folder as model directory: /tmp/tmpygBKCI\r\n    INFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f3bd6649b90>, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_device_fn': None, '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': '/tmp/tmpygBKCI', '_train_distribute': <tensorflow.contrib.distribute.python.mirrored_strategy.MirroredStrategy object at 0x7f3bd6649b10>, '_save_summary_steps': 100}\r\n    2018-09-18 23:44:42.051140: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\n    2018-09-18 23:44:42.244608: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 0 with properties:\r\n    name: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\r\n    pciBusID: 0000:08:00.0\r\n    totalMemory: 10.92GiB freeMemory: 9.93GiB\r\n    2018-09-18 23:44:42.392404: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\n    2018-09-18 23:44:42.394060: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 1 with properties:\r\n    name: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\r\n    pciBusID: 0000:42:00.0\r\n    totalMemory: 10.92GiB freeMemory: 10.76GiB\r\n    2018-09-18 23:44:42.398325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\r\n    2018-09-18 23:44:42.808254: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n    2018-09-18 23:44:42.808317: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\r\n    2018-09-18 23:44:42.808325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\r\n    2018-09-18 23:44:42.808331: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\r\n    2018-09-18 23:44:42.808726: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\r\n    2018-09-18 23:44:42.887416: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\r\n    INFO:tensorflow:Device is available but not used by distribute strategy: /device:CPU:0\r\n    INFO:tensorflow:Configured nccl all-reduce.\r\n    2018-09-18 23:44:42.999232: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\r\n    2018-09-18 23:44:42.999351: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n    2018-09-18 23:44:42.999364: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\r\n    2018-09-18 23:44:42.999371: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\r\n    2018-09-18 23:44:42.999379: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\r\n    2018-09-18 23:44:42.999591: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\r\n    2018-09-18 23:44:42.999726: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\r\n    INFO:tensorflow:Calling model_fn.\r\n    INFO:tensorflow:Calling model_fn.\r\n    INFO:tensorflow:batch_all_reduce invoked for batches size = 2 with algorithm = nccl, num_packs = 1, agg_small_grads_max_bytes = 0 and agg_small_grads_max_group = 10\r\n    INFO:tensorflow:Done calling model_fn.\r\n    INFO:tensorflow:Done calling model_fn.\r\n    INFO:tensorflow:Create CheckpointSaverHook.\r\n    INFO:tensorflow:Graph was finalized.\r\n    2018-09-18 23:44:43.215770: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\r\n    2018-09-18 23:44:43.215877: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n    2018-09-18 23:44:43.215889: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\r\n    2018-09-18 23:44:43.215897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\r\n    2018-09-18 23:44:43.215904: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\r\n    2018-09-18 23:44:43.216104: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\r\n    2018-09-18 23:44:43.216251: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\r\n    INFO:tensorflow:Running local_init_op.\r\n    INFO:tensorflow:Done running local_init_op.\r\n    INFO:tensorflow:Saving checkpoints for 0 into /tmp/tmpygBKCI/model.ckpt.\r\n    features = [[1]]\r\n    logits = [[0]]\r\n    features = [[1]]\r\n    logits = [[-0.225562453]]\r\n    INFO:tensorflow:loss = 1.2510016, step = 0\r\n    features = [[1]]\r\n    logits = [[0]]\r\n    features = [[1]]\r\n    logits = [[0.6646626]]\r\n    features = [[1]]\r\n    features = [[1]]\r\n    logits = [[-5.94375372]]\r\n    logits = [[1.19879758]]\r\n    features = [[1]]\r\n    logits = [[-23.9573383]]\r\n    features = [[1]]\r\n    logits = [[3.89678]]\r\n    features = [[1]]\r\n    features = [[1]]\r\n    logits = [[-82.8739166]]\r\n    logits = [[12.7210035]]\r\n    INFO:tensorflow:Saving checkpoints for 5 into /tmp/tmpygBKCI/model.ckpt.\r\n    INFO:tensorflow:Loss for final step: 3586.108.\r\n    INFO:tensorflow:Calling model_fn.\r\n    INFO:tensorflow:Done calling model_fn.\r\n    INFO:tensorflow:Starting evaluation at 2018-09-18-23:44:45\r\n    INFO:tensorflow:Graph was finalized.\r\n    2018-09-18 23:44:45.322872: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0, 1\r\n    2018-09-18 23:44:45.322972: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n    2018-09-18 23:44:45.322984: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 1\r\n    2018-09-18 23:44:45.322992: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N Y\r\n    2018-09-18 23:44:45.323000: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 1:   Y N\r\n    2018-09-18 23:44:45.323190: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9603 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:08:00.0, compute capability: 6.1)\r\n    2018-09-18 23:44:45.323319: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 10403 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080 Ti, pci bus id: 0000:42:00.0, compute capability: 6.1)\r\n    INFO:tensorflow:Restoring parameters from /tmp/tmpygBKCI/model.ckpt-5\r\n    INFO:tensorflow:Running local_init_op.\r\n    INFO:tensorflow:Done running local_init_op.\r\n\r\nNotice that the logits comes out printed as zero the first and third time, which suggests the weights for at least one of the GPU towers is all zeroes at the start (or both are all zeros initially but the prints are showing up interwoven between the two towers).\r\n\r\nIf I run the code with just a single GPU using OneDeviceStrategy, this does not happen (first logit value printed out is non-zero due to random initial weights).\r\n\r\nThis affects training for more complicated scenarios since it could lead to incorrect loss computation.\r\n\r\nStill happens if I upgrade to TensorFlow 1.11.0-rc1 ('v1.11.0-rc1-0-ge4c4b20805').\r\n\r\nI posted on [StackOverflow](https://stackoverflow.com/questions/52396116/tensorflow-estimator-with-mirroredstrategy-on-multiple-gpus-seems-to-start-with) but also decided to open this issue since it seems somewhat similar to the variable initialization issue reported in #19069 which is supposedly fixed. If this is more appropriate on StackOverflow, I can wait for responses there. Thanks!\r\n"}