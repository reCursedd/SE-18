{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/246240195", "html_url": "https://github.com/tensorflow/tensorflow/issues/3139#issuecomment-246240195", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3139", "id": 246240195, "node_id": "MDEyOklzc3VlQ29tbWVudDI0NjI0MDE5NQ==", "user": {"login": "normads", "id": 3591654, "node_id": "MDQ6VXNlcjM1OTE2NTQ=", "avatar_url": "https://avatars2.githubusercontent.com/u/3591654?v=4", "gravatar_id": "", "url": "https://api.github.com/users/normads", "html_url": "https://github.com/normads", "followers_url": "https://api.github.com/users/normads/followers", "following_url": "https://api.github.com/users/normads/following{/other_user}", "gists_url": "https://api.github.com/users/normads/gists{/gist_id}", "starred_url": "https://api.github.com/users/normads/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/normads/subscriptions", "organizations_url": "https://api.github.com/users/normads/orgs", "repos_url": "https://api.github.com/users/normads/repos", "events_url": "https://api.github.com/users/normads/events{/privacy}", "received_events_url": "https://api.github.com/users/normads/received_events", "type": "User", "site_admin": false}, "created_at": "2016-09-12T04:20:58Z", "updated_at": "2016-09-14T08:59:25Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Had some time to get to the bottom of this. The problem is with the use of <strong>-Wl,--whole-archive</strong> option without a <strong>-Wl,--no-whole-archive</strong> afterwards.<br>\nEach library after <strong>-Wl,--whole-archive</strong> is included completely until <strong>-Wl,--no-whole-archive</strong> is specified and libgcc is automatically appended to the end of the library list, which means both libm.a and libgcc.a are included as a whole.<br>\nThere are duplicates for a lot of functions between libm and libgcc.<br>\nso when __gnu_h2f_ieee wants to link to __gnu_h2f_internal it has two options from libm and libgcc. This would typically cause the linking to fail, but since <strong>-Wl,--allow-multiple-definitions</strong> is specified the linker would link to the <strong>first</strong> definition. The first definition could be from the other library which would be further away from the program counter than the definition within the same library.<br>\nThis would normally be alright with 64-bit instructions or even 32-bit instructions but with ARM 32-bit THUMB instructions the specific branch instruction only has a 12bit offset range, which is +-2k words. So it would fail trying to fit the offset into those 12bits.<br>\nThe easy fix is to add <strong>-Wl,--no-whole-archive</strong> after libtensorflow-core.a. I believe this also removes the need for <strong>-Wl,--allow-multiple-definitions</strong>.<br>\nOr if you're silly enough you could rebuild libgcc without thumb like i first did :/<br>\nShould i send a PR for this?</p>", "body_text": "Had some time to get to the bottom of this. The problem is with the use of -Wl,--whole-archive option without a -Wl,--no-whole-archive afterwards.\nEach library after -Wl,--whole-archive is included completely until -Wl,--no-whole-archive is specified and libgcc is automatically appended to the end of the library list, which means both libm.a and libgcc.a are included as a whole.\nThere are duplicates for a lot of functions between libm and libgcc.\nso when __gnu_h2f_ieee wants to link to __gnu_h2f_internal it has two options from libm and libgcc. This would typically cause the linking to fail, but since -Wl,--allow-multiple-definitions is specified the linker would link to the first definition. The first definition could be from the other library which would be further away from the program counter than the definition within the same library.\nThis would normally be alright with 64-bit instructions or even 32-bit instructions but with ARM 32-bit THUMB instructions the specific branch instruction only has a 12bit offset range, which is +-2k words. So it would fail trying to fit the offset into those 12bits.\nThe easy fix is to add -Wl,--no-whole-archive after libtensorflow-core.a. I believe this also removes the need for -Wl,--allow-multiple-definitions.\nOr if you're silly enough you could rebuild libgcc without thumb like i first did :/\nShould i send a PR for this?", "body": "Had some time to get to the bottom of this. The problem is with the use of **-Wl,--whole-archive** option without a **-Wl,--no-whole-archive** afterwards. \nEach library after **-Wl,--whole-archive** is included completely until **-Wl,--no-whole-archive** is specified and libgcc is automatically appended to the end of the library list, which means both libm.a and libgcc.a are included as a whole. \nThere are duplicates for a lot of functions between libm and libgcc. \nso when __gnu_h2f_ieee wants to link to __gnu_h2f_internal it has two options from libm and libgcc. This would typically cause the linking to fail, but since **-Wl,--allow-multiple-definitions** is specified the linker would link to the **first** definition. The first definition could be from the other library which would be further away from the program counter than the definition within the same library. \nThis would normally be alright with 64-bit instructions or even 32-bit instructions but with ARM 32-bit THUMB instructions the specific branch instruction only has a 12bit offset range, which is +-2k words. So it would fail trying to fit the offset into those 12bits. \nThe easy fix is to add **-Wl,--no-whole-archive** after libtensorflow-core.a. I believe this also removes the need for **-Wl,--allow-multiple-definitions**.\nOr if you're silly enough you could rebuild libgcc without thumb like i first did :/\nShould i send a PR for this?\n"}