{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/134886949", "pull_request_review_id": 58232691, "id": 134886949, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEzNDg4Njk0OQ==", "diff_hunk": "@@ -140,17 +142,44 @@ struct ScatterFunctorBase {\n     // indices and params sizes were validated in DoCompute().\n     const Index N = static_cast<Index>(indices.size());\n     const Index limit = static_cast<Index>(params.dimension(0));\n-    for (Index i = 0; i < N; i++) {\n-      // Grab the index and check its validity.  An earlier version of the\n-      // code checked it and then grabbed it from memory a second time, which\n-      // was a security risk since it could have changed in between.\n-      const Index index = ::tensorflow::internal::SubtleMustCopy(indices(i));\n-      if (!FastBoundsCheck(index, limit)) return i;\n-      // Copy last Ndim-1 dimensions of updates[i] to params[index]\n-      scatter_op::internal::Assign<op>::Run(params.template chip<0>(index),\n-                                            updates.template chip<0>(i));\n-    }\n-    return -1;\n+    auto worker_threads = c->device()->tensorflow_cpu_worker_threads();\n+\n+    // Calculate the max number of flags.\n+    // Based on the shard strategy in work_sharder.cc to limit the flags' size.\n+    static const int64 maxFactorPerThread = 10000;\n+    Index flags_size = static_cast<Index>(maxFactorPerThread * worker_threads->num_threads);\n+    flags_size = N <= flags_size ? N : flags_size;\n+    // use atomic_flag and spin lock for multiple thread.\n+    auto flags = std::unique_ptr<std::atomic_flag[]>(\n+            new std::atomic_flag[flags_size]{ATOMIC_FLAG_INIT});\n+\n+    // store the result.\n+    mutex mu;\n+    Index result = -1 GUARDED_BY(mu);\n+    auto work = [&params, &updates, &indices, &flags, flags_size, limit, &mu, &result]\n+            (int64 start, int64 end) {\n+      Index flags_idx;\n+      for (Index i = start; i < end; i++) {", "path": "tensorflow/core/kernels/scatter_functor.h", "position": null, "original_position": 50, "commit_id": "de85c9277db85950c8777732067004267a64d884", "original_commit_id": "58078833c9542cf2aeb77a922b26609933df606f", "user": {"login": "ekelsen", "id": 2533174, "node_id": "MDQ6VXNlcjI1MzMxNzQ=", "avatar_url": "https://avatars0.githubusercontent.com/u/2533174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ekelsen", "html_url": "https://github.com/ekelsen", "followers_url": "https://api.github.com/users/ekelsen/followers", "following_url": "https://api.github.com/users/ekelsen/following{/other_user}", "gists_url": "https://api.github.com/users/ekelsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/ekelsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ekelsen/subscriptions", "organizations_url": "https://api.github.com/users/ekelsen/orgs", "repos_url": "https://api.github.com/users/ekelsen/repos", "events_url": "https://api.github.com/users/ekelsen/events{/privacy}", "received_events_url": "https://api.github.com/users/ekelsen/received_events", "type": "User", "site_admin": false}, "body": "There is now a lot of code that gets duplicated, can you factor out the loop since only the function is changed in the three occurrences.  And maybe also the code that creates the flags since it is also duplicated twice.", "created_at": "2017-08-23T22:26:50Z", "updated_at": "2017-10-02T08:59:45Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/12487#discussion_r134886949", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/12487", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/134886949"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/12487#discussion_r134886949"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/12487"}}, "body_html": "<p>There is now a lot of code that gets duplicated, can you factor out the loop since only the function is changed in the three occurrences.  And maybe also the code that creates the flags since it is also duplicated twice.</p>", "body_text": "There is now a lot of code that gets duplicated, can you factor out the loop since only the function is changed in the three occurrences.  And maybe also the code that creates the flags since it is also duplicated twice."}