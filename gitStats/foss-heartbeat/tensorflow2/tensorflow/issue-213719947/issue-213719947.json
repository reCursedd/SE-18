{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8347", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8347/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8347/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8347/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/8347", "id": 213719947, "node_id": "MDU6SXNzdWUyMTM3MTk5NDc=", "number": 8347, "title": "Quantize Neural Networks with TensorFlow doesn't work on my models", "user": {"login": "riless", "id": 1511944, "node_id": "MDQ6VXNlcjE1MTE5NDQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/1511944?v=4", "gravatar_id": "", "url": "https://api.github.com/users/riless", "html_url": "https://github.com/riless", "followers_url": "https://api.github.com/users/riless/followers", "following_url": "https://api.github.com/users/riless/following{/other_user}", "gists_url": "https://api.github.com/users/riless/gists{/gist_id}", "starred_url": "https://api.github.com/users/riless/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/riless/subscriptions", "organizations_url": "https://api.github.com/users/riless/orgs", "repos_url": "https://api.github.com/users/riless/repos", "events_url": "https://api.github.com/users/riless/events{/privacy}", "received_events_url": "https://api.github.com/users/riless/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-03-13T10:00:36Z", "updated_at": "2017-06-16T22:17:33Z", "closed_at": "2017-06-16T22:17:33Z", "author_association": "NONE", "body_html": "<p>I'm following this <a href=\"https://www.tensorflow.org/performance/quantization\" rel=\"nofollow\">tutorial here</a>.</p>\n<p>And this code works fine.</p>\n<pre><code>curl http://download.tensorflow.org/models/image/imagenet/inception-2015-12-05.tgz -o /tmp/inceptionv3.tgz\ntar xzf /tmp/inceptionv3.tgz -C /tmp/\nbazel build tensorflow/tools/quantization/tools:quantize_graph\nbazel-bin/tensorflow/tools/quantization/tools/quantize_graph \\\n  --input=/tmp/classify_image_graph_def.pb \\\n  --output_node_names=\"softmax\" --output=/tmp/quantized_graph.pb \\\n  --mode=eightbit\n</code></pre>\n<p>But when I try with another .pb it does not work, it tells me that the output node does not exist.</p>\n<p><strong>With non frozen .pb</strong></p>\n<pre><code>Traceback (most recent call last):\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1304, in &lt;module&gt;\n    app.run()\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 44, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1271, in main\n    tf_graph.ParseFromString(data)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/message.py\", line 185, in ParseFromString\n    self.MergeFromString(serialized)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/python_message.py\", line 1091, in MergeFromString\n    if self._InternalParse(serialized, 0, length) != length:\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/python_message.py\", line 1117, in InternalParse\n    new_pos = local_SkipField(buffer, new_pos, end, tag_bytes)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/decoder.py\", line 850, in SkipField\n    return WIRETYPE_TO_SKIPPER[wire_type](buffer, pos, end)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/decoder.py\", line 820, in _RaiseInvalidWireType\n    raise _DecodeError('Tag had invalid wire type.')\ngoogle.protobuf.message.DecodeError: Tag had invalid wire type.\n\n</code></pre>\n<p><strong>With frozen .pb</strong></p>\n<pre><code>Traceback (most recent call last):\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1304, in &lt;module&gt;\n    app.run()\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 44, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1295, in main\n    output_graph = rewriter.rewrite(FLAGS.output_node_names.split(\",\"))\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 400, in rewrite\n    for output_node_name in output_node_names\nKeyError: 'my_output_node'\n</code></pre>\n<p>I'm sure the output_node_names is correct.</p>\n<p>Is there any requirements on the .pb file so the tool can quantize it ?</p>\n<p>nb: one should edit the doc because the tool is no longer in <code>tensorflow/tools/quantization/tools:quantize_graph</code> but <code>tensorflow/tools/quantization:quantize_graph</code></p>", "body_text": "I'm following this tutorial here.\nAnd this code works fine.\ncurl http://download.tensorflow.org/models/image/imagenet/inception-2015-12-05.tgz -o /tmp/inceptionv3.tgz\ntar xzf /tmp/inceptionv3.tgz -C /tmp/\nbazel build tensorflow/tools/quantization/tools:quantize_graph\nbazel-bin/tensorflow/tools/quantization/tools/quantize_graph \\\n  --input=/tmp/classify_image_graph_def.pb \\\n  --output_node_names=\"softmax\" --output=/tmp/quantized_graph.pb \\\n  --mode=eightbit\n\nBut when I try with another .pb it does not work, it tells me that the output node does not exist.\nWith non frozen .pb\nTraceback (most recent call last):\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1304, in <module>\n    app.run()\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 44, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1271, in main\n    tf_graph.ParseFromString(data)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/message.py\", line 185, in ParseFromString\n    self.MergeFromString(serialized)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/python_message.py\", line 1091, in MergeFromString\n    if self._InternalParse(serialized, 0, length) != length:\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/python_message.py\", line 1117, in InternalParse\n    new_pos = local_SkipField(buffer, new_pos, end, tag_bytes)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/decoder.py\", line 850, in SkipField\n    return WIRETYPE_TO_SKIPPER[wire_type](buffer, pos, end)\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/decoder.py\", line 820, in _RaiseInvalidWireType\n    raise _DecodeError('Tag had invalid wire type.')\ngoogle.protobuf.message.DecodeError: Tag had invalid wire type.\n\n\nWith frozen .pb\nTraceback (most recent call last):\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1304, in <module>\n    app.run()\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 44, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1295, in main\n    output_graph = rewriter.rewrite(FLAGS.output_node_names.split(\",\"))\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 400, in rewrite\n    for output_node_name in output_node_names\nKeyError: 'my_output_node'\n\nI'm sure the output_node_names is correct.\nIs there any requirements on the .pb file so the tool can quantize it ?\nnb: one should edit the doc because the tool is no longer in tensorflow/tools/quantization/tools:quantize_graph but tensorflow/tools/quantization:quantize_graph", "body": "I'm following this [tutorial here](https://www.tensorflow.org/performance/quantization).\r\n\r\nAnd this code works fine.\r\n```\r\ncurl http://download.tensorflow.org/models/image/imagenet/inception-2015-12-05.tgz -o /tmp/inceptionv3.tgz\r\ntar xzf /tmp/inceptionv3.tgz -C /tmp/\r\nbazel build tensorflow/tools/quantization/tools:quantize_graph\r\nbazel-bin/tensorflow/tools/quantization/tools/quantize_graph \\\r\n  --input=/tmp/classify_image_graph_def.pb \\\r\n  --output_node_names=\"softmax\" --output=/tmp/quantized_graph.pb \\\r\n  --mode=eightbit\r\n```\r\n\r\nBut when I try with another .pb it does not work, it tells me that the output node does not exist.\r\n\r\n**With non frozen .pb**\r\n```\r\nTraceback (most recent call last):\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1304, in <module>\r\n    app.run()\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 44, in run\r\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1271, in main\r\n    tf_graph.ParseFromString(data)\r\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/message.py\", line 185, in ParseFromString\r\n    self.MergeFromString(serialized)\r\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/python_message.py\", line 1091, in MergeFromString\r\n    if self._InternalParse(serialized, 0, length) != length:\r\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/python_message.py\", line 1117, in InternalParse\r\n    new_pos = local_SkipField(buffer, new_pos, end, tag_bytes)\r\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/decoder.py\", line 850, in SkipField\r\n    return WIRETYPE_TO_SKIPPER[wire_type](buffer, pos, end)\r\n  File \"/usr/local/lib/python2.7/dist-packages/google/protobuf/internal/decoder.py\", line 820, in _RaiseInvalidWireType\r\n    raise _DecodeError('Tag had invalid wire type.')\r\ngoogle.protobuf.message.DecodeError: Tag had invalid wire type.\r\n\r\n```\r\n\r\n**With frozen .pb**\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1304, in <module>\r\n    app.run()\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 44, in run\r\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 1295, in main\r\n    output_graph = rewriter.rewrite(FLAGS.output_node_names.split(\",\"))\r\n  File \"/sandbox/tensorflow/bazel-bin/tensorflow/tools/quantization/quantize_graph.runfiles/org_tensorflow/tensorflow/tools/quantization/quantize_graph.py\", line 400, in rewrite\r\n    for output_node_name in output_node_names\r\nKeyError: 'my_output_node'\r\n```\r\n\r\nI'm sure the output_node_names is correct.\r\n\r\nIs there any requirements on the .pb file so the tool can quantize it ?\r\n\r\nnb: one should edit the doc because the tool is no longer in `tensorflow/tools/quantization/tools:quantize_graph` but `tensorflow/tools/quantization:quantize_graph`\r\n\r\n"}