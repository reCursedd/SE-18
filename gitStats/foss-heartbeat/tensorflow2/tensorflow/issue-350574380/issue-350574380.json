{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21614", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21614/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21614/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21614/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21614", "id": 350574380, "node_id": "MDU6SXNzdWUzNTA1NzQzODA=", "number": 21614, "title": "Keras to estimator errors for RNNs", "user": {"login": "jmchen-g", "id": 15792374, "node_id": "MDQ6VXNlcjE1NzkyMzc0", "avatar_url": "https://avatars3.githubusercontent.com/u/15792374?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jmchen-g", "html_url": "https://github.com/jmchen-g", "followers_url": "https://api.github.com/users/jmchen-g/followers", "following_url": "https://api.github.com/users/jmchen-g/following{/other_user}", "gists_url": "https://api.github.com/users/jmchen-g/gists{/gist_id}", "starred_url": "https://api.github.com/users/jmchen-g/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jmchen-g/subscriptions", "organizations_url": "https://api.github.com/users/jmchen-g/orgs", "repos_url": "https://api.github.com/users/jmchen-g/repos", "events_url": "https://api.github.com/users/jmchen-g/events{/privacy}", "received_events_url": "https://api.github.com/users/jmchen-g/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": {"login": "fchollet", "id": 710255, "node_id": "MDQ6VXNlcjcxMDI1NQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/710255?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fchollet", "html_url": "https://github.com/fchollet", "followers_url": "https://api.github.com/users/fchollet/followers", "following_url": "https://api.github.com/users/fchollet/following{/other_user}", "gists_url": "https://api.github.com/users/fchollet/gists{/gist_id}", "starred_url": "https://api.github.com/users/fchollet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fchollet/subscriptions", "organizations_url": "https://api.github.com/users/fchollet/orgs", "repos_url": "https://api.github.com/users/fchollet/repos", "events_url": "https://api.github.com/users/fchollet/events{/privacy}", "received_events_url": "https://api.github.com/users/fchollet/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "fchollet", "id": 710255, "node_id": "MDQ6VXNlcjcxMDI1NQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/710255?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fchollet", "html_url": "https://github.com/fchollet", "followers_url": "https://api.github.com/users/fchollet/followers", "following_url": "https://api.github.com/users/fchollet/following{/other_user}", "gists_url": "https://api.github.com/users/fchollet/gists{/gist_id}", "starred_url": "https://api.github.com/users/fchollet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fchollet/subscriptions", "organizations_url": "https://api.github.com/users/fchollet/orgs", "repos_url": "https://api.github.com/users/fchollet/repos", "events_url": "https://api.github.com/users/fchollet/events{/privacy}", "received_events_url": "https://api.github.com/users/fchollet/received_events", "type": "User", "site_admin": false}, {"login": "tanzhenyu", "id": 15220929, "node_id": "MDQ6VXNlcjE1MjIwOTI5", "avatar_url": "https://avatars3.githubusercontent.com/u/15220929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tanzhenyu", "html_url": "https://github.com/tanzhenyu", "followers_url": "https://api.github.com/users/tanzhenyu/followers", "following_url": "https://api.github.com/users/tanzhenyu/following{/other_user}", "gists_url": "https://api.github.com/users/tanzhenyu/gists{/gist_id}", "starred_url": "https://api.github.com/users/tanzhenyu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tanzhenyu/subscriptions", "organizations_url": "https://api.github.com/users/tanzhenyu/orgs", "repos_url": "https://api.github.com/users/tanzhenyu/repos", "events_url": "https://api.github.com/users/tanzhenyu/events{/privacy}", "received_events_url": "https://api.github.com/users/tanzhenyu/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 11, "created_at": "2018-08-14T19:54:56Z", "updated_at": "2018-11-13T18:56:37Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<p>It seems like a bug that the following model results in the following assert:</p>\n<p>The model (simplified from seq2seq):<br>\nimport tensorflow as tf</p>\n<p>params = {<br>\n'seq_len': 32,<br>\n'vocab_size': 50,<br>\n'emb_act_size': 32,<br>\n'rnn_act_size': 64,<br>\n'out_size': 16<br>\n}</p>\n<p>def mfunc(params):<br>\ninputs = tf.keras.layers.Input(shape=(50, ), dtype='int32')<br>\nemb = tf.keras.layers.Embedding(params[\"vocab_size\"],<br>\nparams[\"emb_act_size\"])(inputs)<br>\nlstm1, s_h, s_c = tf.keras.layers.LSTM(<br>\nparams[\"rnn_act_size\"],<br>\nreturn_sequences=True,<br>\nreturn_state=True,<br>\nimplementation=2)(emb)<br>\nlstm2 = tf.keras.layers.LSTM(<br>\nparams[\"rnn_act_size\"], return_sequences=True)(<br>\nlstm1, initial_state=[s_h, s_c])<br>\ny = tf.keras.layers.Dense(params[\"out_size\"], activation='softmax')(lstm2)<br>\nmodel = tf.keras.Model(inputs, y)<br>\nmodel.compile(optimizer='sgd', loss='categorical_crossentropy')<br>\nreturn model</p>\n<p>x = mfunc(params)<br>\ntf.keras.estimator.model_to_estimator(keras_model=x)</p>\n<p>The assert we are hitting in TF 1.10:<br>\nTraceback (most recent call last):<br>\nFile \"Downloads/tmp.py\", line 30, in <br>\ntf.keras.estimator.model_to_estimator(keras_model=x)<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 548, in model_to_estimator<br>\nkeras_weights)<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 449, in _save_first_checkpoint<br>\ncustom_objects)<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 315, in _clone_and_build_model<br>\nmodel = models.clone_model(keras_model, input_tensors=input_tensors)<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/models.py\", line 263, in clone_model<br>\nreturn _clone_functional_model(model, input_tensors=input_tensors)<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/models.py\", line 168, in _clone_functional_model<br>\n**kwargs))<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/layers/recurrent.py\", line 526, in <strong>call</strong><br>\nself._num_constants)<br>\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/layers/recurrent.py\", line 2590, in _standardize_args<br>\nassert initial_state is None and constants is None<br>\nAssertionError</p>\n<p>Here is the result of the environment capture script:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh\">https://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh</a><br>\n== cat /etc/issue ===============================================<br>\nLinux 97ddc7134519 4.9.93-linuxkit-aufs <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux<br>\nVERSION=\"16.04.5 LTS (Xenial Xerus)\"<br>\nVERSION_ID=\"16.04\"<br>\nVERSION_CODENAME=xenial</p>\n<p>== are we in docker =============================================<br>\nYes</p>\n<p>== compiler =====================================================<br>\nc++ (Ubuntu 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609<br>\nCopyright (C) 2015 Free Software Foundation, Inc.<br>\nThis is free software; see the source for copying conditions.  There is NO<br>\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</p>\n<p>== uname -a =====================================================<br>\nLinux 97ddc7134519 4.9.93-linuxkit-aufs <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</p>\n<p>== check pips ===================================================<br>\nnumpy              1.14.5<br>\nprotobuf           3.6.0<br>\ntensorflow         1.10.0</p>\n<p>== check for virtualenv =========================================<br>\nFalse</p>\n<p>== tensorflow import ============================================<br>\ntf.VERSION = 1.10.0<br>\ntf.GIT_VERSION = v1.10.0-0-g656e7a2b34<br>\ntf.COMPILER_VERSION = v1.10.0-0-g656e7a2b34<br>\nSanity check: array([1], dtype=int32)</p>", "body_text": "It seems like a bug that the following model results in the following assert:\nThe model (simplified from seq2seq):\nimport tensorflow as tf\nparams = {\n'seq_len': 32,\n'vocab_size': 50,\n'emb_act_size': 32,\n'rnn_act_size': 64,\n'out_size': 16\n}\ndef mfunc(params):\ninputs = tf.keras.layers.Input(shape=(50, ), dtype='int32')\nemb = tf.keras.layers.Embedding(params[\"vocab_size\"],\nparams[\"emb_act_size\"])(inputs)\nlstm1, s_h, s_c = tf.keras.layers.LSTM(\nparams[\"rnn_act_size\"],\nreturn_sequences=True,\nreturn_state=True,\nimplementation=2)(emb)\nlstm2 = tf.keras.layers.LSTM(\nparams[\"rnn_act_size\"], return_sequences=True)(\nlstm1, initial_state=[s_h, s_c])\ny = tf.keras.layers.Dense(params[\"out_size\"], activation='softmax')(lstm2)\nmodel = tf.keras.Model(inputs, y)\nmodel.compile(optimizer='sgd', loss='categorical_crossentropy')\nreturn model\nx = mfunc(params)\ntf.keras.estimator.model_to_estimator(keras_model=x)\nThe assert we are hitting in TF 1.10:\nTraceback (most recent call last):\nFile \"Downloads/tmp.py\", line 30, in \ntf.keras.estimator.model_to_estimator(keras_model=x)\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 548, in model_to_estimator\nkeras_weights)\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 449, in _save_first_checkpoint\ncustom_objects)\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 315, in _clone_and_build_model\nmodel = models.clone_model(keras_model, input_tensors=input_tensors)\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/models.py\", line 263, in clone_model\nreturn _clone_functional_model(model, input_tensors=input_tensors)\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/models.py\", line 168, in _clone_functional_model\n**kwargs))\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/layers/recurrent.py\", line 526, in call\nself._num_constants)\nFile \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/layers/recurrent.py\", line 2590, in _standardize_args\nassert initial_state is None and constants is None\nAssertionError\nHere is the result of the environment capture script:\nhttps://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh\n== cat /etc/issue ===============================================\nLinux 97ddc7134519 4.9.93-linuxkit-aufs #1 SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\nVERSION=\"16.04.5 LTS (Xenial Xerus)\"\nVERSION_ID=\"16.04\"\nVERSION_CODENAME=xenial\n== are we in docker =============================================\nYes\n== compiler =====================================================\nc++ (Ubuntu 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n== uname -a =====================================================\nLinux 97ddc7134519 4.9.93-linuxkit-aufs #1 SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n== check pips ===================================================\nnumpy              1.14.5\nprotobuf           3.6.0\ntensorflow         1.10.0\n== check for virtualenv =========================================\nFalse\n== tensorflow import ============================================\ntf.VERSION = 1.10.0\ntf.GIT_VERSION = v1.10.0-0-g656e7a2b34\ntf.COMPILER_VERSION = v1.10.0-0-g656e7a2b34\nSanity check: array([1], dtype=int32)", "body": "It seems like a bug that the following model results in the following assert:\r\n\r\nThe model (simplified from seq2seq):\r\nimport tensorflow as tf\r\n\r\nparams = {\r\n    'seq_len': 32,\r\n    'vocab_size': 50,\r\n    'emb_act_size': 32,\r\n    'rnn_act_size': 64,\r\n    'out_size': 16\r\n}\r\n\r\n\r\ndef mfunc(params):\r\n    inputs = tf.keras.layers.Input(shape=(50, ), dtype='int32')\r\n    emb = tf.keras.layers.Embedding(params[\"vocab_size\"],\r\n                                    params[\"emb_act_size\"])(inputs)\r\n    lstm1, s_h, s_c = tf.keras.layers.LSTM(\r\n        params[\"rnn_act_size\"],\r\n        return_sequences=True,\r\n        return_state=True,\r\n        implementation=2)(emb)\r\n    lstm2 = tf.keras.layers.LSTM(\r\n        params[\"rnn_act_size\"], return_sequences=True)(\r\n            lstm1, initial_state=[s_h, s_c])\r\n    y = tf.keras.layers.Dense(params[\"out_size\"], activation='softmax')(lstm2)\r\n    model = tf.keras.Model(inputs, y)\r\n    model.compile(optimizer='sgd', loss='categorical_crossentropy')\r\n    return model\r\n\r\nx = mfunc(params)\r\ntf.keras.estimator.model_to_estimator(keras_model=x)\r\n\r\nThe assert we are hitting in TF 1.10:\r\nTraceback (most recent call last):\r\n  File \"Downloads/tmp.py\", line 30, in <module>\r\n    tf.keras.estimator.model_to_estimator(keras_model=x)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 548, in model_to_estimator\r\n    keras_weights)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 449, in _save_first_checkpoint\r\n    custom_objects)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/keras.py\", line 315, in _clone_and_build_model\r\n    model = models.clone_model(keras_model, input_tensors=input_tensors)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/models.py\", line 263, in clone_model\r\n    return _clone_functional_model(model, input_tensors=input_tensors)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/models.py\", line 168, in _clone_functional_model\r\n    **kwargs))\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/layers/recurrent.py\", line 526, in __call__\r\n    self._num_constants)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/layers/recurrent.py\", line 2590, in _standardize_args\r\n    assert initial_state is None and constants is None\r\nAssertionError\r\n\r\n\r\nHere is the result of the environment capture script:\r\nhttps://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh\r\n== cat /etc/issue ===============================================\r\nLinux 97ddc7134519 4.9.93-linuxkit-aufs #1 SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\nVERSION=\"16.04.5 LTS (Xenial Xerus)\"\r\nVERSION_ID=\"16.04\"\r\nVERSION_CODENAME=xenial\r\n\r\n== are we in docker =============================================\r\nYes\r\n\r\n== compiler =====================================================\r\nc++ (Ubuntu 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609\r\nCopyright (C) 2015 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n\r\n\r\n== uname -a =====================================================\r\nLinux 97ddc7134519 4.9.93-linuxkit-aufs #1 SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n== check pips ===================================================\r\nnumpy              1.14.5\r\nprotobuf           3.6.0\r\ntensorflow         1.10.0\r\n\r\n== check for virtualenv =========================================\r\nFalse\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 1.10.0\r\ntf.GIT_VERSION = v1.10.0-0-g656e7a2b34\r\ntf.COMPILER_VERSION = v1.10.0-0-g656e7a2b34\r\nSanity check: array([1], dtype=int32)"}