{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7926", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7926/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7926/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7926/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/7926", "id": 210562428, "node_id": "MDU6SXNzdWUyMTA1NjI0Mjg=", "number": 7926, "title": "Freeze graph erroring out claiming there are uninitialized values in embeddings", "user": {"login": "lminer", "id": 5126549, "node_id": "MDQ6VXNlcjUxMjY1NDk=", "avatar_url": "https://avatars2.githubusercontent.com/u/5126549?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lminer", "html_url": "https://github.com/lminer", "followers_url": "https://api.github.com/users/lminer/followers", "following_url": "https://api.github.com/users/lminer/following{/other_user}", "gists_url": "https://api.github.com/users/lminer/gists{/gist_id}", "starred_url": "https://api.github.com/users/lminer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lminer/subscriptions", "organizations_url": "https://api.github.com/users/lminer/orgs", "repos_url": "https://api.github.com/users/lminer/repos", "events_url": "https://api.github.com/users/lminer/events{/privacy}", "received_events_url": "https://api.github.com/users/lminer/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-02-27T18:10:34Z", "updated_at": "2018-10-23T11:47:41Z", "closed_at": "2017-02-28T21:00:04Z", "author_association": "NONE", "body_html": "<p>This is similar to <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"204464520\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/7172\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/7172/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/7172\">#7172</a> but with my own model.</p>\n<p>I'm training a CNN with word embeddings and for some reason I'm getting <code>FailedPreconditionError</code> exception whenever I try to save a frozen version of the model for later use.</p>\n<p>This is despite the fact that I call <code>sess.run(tf.global_variables_initializer())</code> just before training and I have no problem monitoring the training in tensorboard and checkpointing the model at regular intervals.</p>\n<p>The problem occurs when I try to load a model from a checkpoint and save a frozen model. The function I'm using is as follows:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">def</span> <span class=\"pl-en\">freeze_model</span>(<span class=\"pl-smi\">checkpoint_path</span>, <span class=\"pl-smi\">model_save_path</span>, <span class=\"pl-smi\">output_node_names</span>):\n    checkpoint <span class=\"pl-k\">=</span> tf.train.get_checkpoint_state(checkpoint_path)\n    input_checkpoint <span class=\"pl-k\">=</span> checkpoint.model_checkpoint_path\n\n    saver <span class=\"pl-k\">=</span> tf.train.import_meta_graph(input_checkpoint <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>.meta<span class=\"pl-pds\">'</span></span>, <span class=\"pl-v\">clear_devices</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)\n    graph <span class=\"pl-k\">=</span> tf.get_default_graph()\n    input_graph_def <span class=\"pl-k\">=</span> graph.as_graph_def()\n    <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n        saver.restore(sess, input_checkpoint)\n\n        output_graph_def <span class=\"pl-k\">=</span> graph_util.convert_variables_to_constants(\n            sess,\n            input_graph_def,\n            output_node_names\n        )\n\n        <span class=\"pl-k\">with</span> tf.gfile.GFile(model_save_path, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>wb<span class=\"pl-pds\">\"</span></span>) <span class=\"pl-k\">as</span> f:\n            f.write(output_graph_def.SerializeToString())</pre></div>\n<p>The error that I'm getting is as follows. It looks like the problem is with two embeddings coefficients. If I set <code>clear_devices=False</code>, I get the same error but for only one embedding coefficient:</p>\n<div class=\"highlight highlight-source-python\"><pre>Traceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>myproject/train.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">522</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    tf.app.run()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/platform/app.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">44</span>, <span class=\"pl-k\">in</span> run\n    _sys.exit(main(_sys.argv[:<span class=\"pl-c1\">1</span>] <span class=\"pl-k\">+</span> flags_passthrough))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>myproject/train.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">518</span>, <span class=\"pl-k\">in</span> main\n    trainer.save_model(preprocessor)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>myproject/train.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">312</span>, <span class=\"pl-k\">in</span> save_model\n    ut.freeze_model(<span class=\"pl-c1\">self</span>.checkpoint_dir, model_save_path, C.<span class=\"pl-c1\">OUTPUT_NODE_NAMES</span>)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/myproject/utils.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">224</span>, <span class=\"pl-k\">in</span> freeze_model\n    output_node_names\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/graph_util_impl.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">218</span>, <span class=\"pl-k\">in</span> convert_variables_to_constants\n    returned_variables <span class=\"pl-k\">=</span> sess.run(variable_names)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">767</span>, <span class=\"pl-k\">in</span> run\n    run_metadata_ptr)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">965</span>, <span class=\"pl-k\">in</span> _run\n    feed_dict_string, options, run_metadata)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1015</span>, <span class=\"pl-k\">in</span> _do_run\n    target_list, options, run_metadata)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1035</span>, <span class=\"pl-k\">in</span> _do_call\n    <span class=\"pl-k\">raise</span> <span class=\"pl-c1\">type</span>(e)(node_def, op, message)\nFailedPreconditionError: Attempting to use uninitialized value embeddings<span class=\"pl-k\">/</span>W\n\t [[Node: embeddings<span class=\"pl-k\">/</span>W<span class=\"pl-k\">/</span>_20 = _Send[T=<span class=\"pl-c1\">DT_FLOAT</span>, client_terminated=false, recv_device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/cpu:0<span class=\"pl-pds\">\"</span></span>, send_device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/gpu:0<span class=\"pl-pds\">\"</span></span>, send_device_incarnation=<span class=\"pl-c1\">1</span>, tensor_name=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>edge_30_embeddings/W<span class=\"pl-pds\">\"</span></span>, _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/gpu:0<span class=\"pl-pds\">\"</span></span>](embeddings<span class=\"pl-k\">/</span>W)]]\n\t [[Node: embeddings<span class=\"pl-k\">/</span>W<span class=\"pl-k\">/</span>_21 = _Recv[_start_time=<span class=\"pl-c1\">0</span>, client_terminated=false, recv_device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/cpu:0<span class=\"pl-pds\">\"</span></span>, send_device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/gpu:0<span class=\"pl-pds\">\"</span></span>, send_device_incarnation=<span class=\"pl-c1\">1</span>, tensor_name=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>edge_30_embeddings/W<span class=\"pl-pds\">\"</span></span>, tensor_type=<span class=\"pl-c1\">DT_FLOAT</span>, _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/cpu:0<span class=\"pl-pds\">\"</span></span>]()]]</pre></div>\n<h3>Environment info</h3>\n<p>tensorflow-gpu: 1.0.0<br>\nUbuntu 14.0.4.5<br>\nCUDA Version 8.0.44</p>\n<h3>What other attempted solutions have you tried?</h3>\n<p>I am assigning the embeddings pretrained word2vec values after initializing. I have tried running the model without assigning these values and I get the same error.<br>\nI have tried running the training for 70K batches.<br>\nI have tried running <code>tf.report_uninitialized_variables</code> after calling <code>tf.global_variables_initializer()</code> and it has come up empty.</p>", "body_text": "This is similar to #7172 but with my own model.\nI'm training a CNN with word embeddings and for some reason I'm getting FailedPreconditionError exception whenever I try to save a frozen version of the model for later use.\nThis is despite the fact that I call sess.run(tf.global_variables_initializer()) just before training and I have no problem monitoring the training in tensorboard and checkpointing the model at regular intervals.\nThe problem occurs when I try to load a model from a checkpoint and save a frozen model. The function I'm using is as follows:\ndef freeze_model(checkpoint_path, model_save_path, output_node_names):\n    checkpoint = tf.train.get_checkpoint_state(checkpoint_path)\n    input_checkpoint = checkpoint.model_checkpoint_path\n\n    saver = tf.train.import_meta_graph(input_checkpoint + '.meta', clear_devices=True)\n    graph = tf.get_default_graph()\n    input_graph_def = graph.as_graph_def()\n    with tf.Session() as sess:\n        saver.restore(sess, input_checkpoint)\n\n        output_graph_def = graph_util.convert_variables_to_constants(\n            sess,\n            input_graph_def,\n            output_node_names\n        )\n\n        with tf.gfile.GFile(model_save_path, \"wb\") as f:\n            f.write(output_graph_def.SerializeToString())\nThe error that I'm getting is as follows. It looks like the problem is with two embeddings coefficients. If I set clear_devices=False, I get the same error but for only one embedding coefficient:\nTraceback (most recent call last):\n  File \"myproject/train.py\", line 522, in <module>\n    tf.app.run()\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 44, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"myproject/train.py\", line 518, in main\n    trainer.save_model(preprocessor)\n  File \"myproject/train.py\", line 312, in save_model\n    ut.freeze_model(self.checkpoint_dir, model_save_path, C.OUTPUT_NODE_NAMES)\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/myproject/utils.py\", line 224, in freeze_model\n    output_node_names\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/graph_util_impl.py\", line 218, in convert_variables_to_constants\n    returned_variables = sess.run(variable_names)\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 767, in run\n    run_metadata_ptr)\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 965, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1015, in _do_run\n    target_list, options, run_metadata)\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1035, in _do_call\n    raise type(e)(node_def, op, message)\nFailedPreconditionError: Attempting to use uninitialized value embeddings/W\n\t [[Node: embeddings/W/_20 = _Send[T=DT_FLOAT, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_30_embeddings/W\", _device=\"/job:localhost/replica:0/task:0/gpu:0\"](embeddings/W)]]\n\t [[Node: embeddings/W/_21 = _Recv[_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_30_embeddings/W\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\nEnvironment info\ntensorflow-gpu: 1.0.0\nUbuntu 14.0.4.5\nCUDA Version 8.0.44\nWhat other attempted solutions have you tried?\nI am assigning the embeddings pretrained word2vec values after initializing. I have tried running the model without assigning these values and I get the same error.\nI have tried running the training for 70K batches.\nI have tried running tf.report_uninitialized_variables after calling tf.global_variables_initializer() and it has come up empty.", "body": "This is similar to #7172 but with my own model.\r\n\r\nI'm training a CNN with word embeddings and for some reason I'm getting `FailedPreconditionError` exception whenever I try to save a frozen version of the model for later use.\r\n\r\nThis is despite the fact that I call `sess.run(tf.global_variables_initializer())` just before training and I have no problem monitoring the training in tensorboard and checkpointing the model at regular intervals.\r\n\r\nThe problem occurs when I try to load a model from a checkpoint and save a frozen model. The function I'm using is as follows:\r\n\r\n```python\r\ndef freeze_model(checkpoint_path, model_save_path, output_node_names):\r\n    checkpoint = tf.train.get_checkpoint_state(checkpoint_path)\r\n    input_checkpoint = checkpoint.model_checkpoint_path\r\n\r\n    saver = tf.train.import_meta_graph(input_checkpoint + '.meta', clear_devices=True)\r\n    graph = tf.get_default_graph()\r\n    input_graph_def = graph.as_graph_def()\r\n    with tf.Session() as sess:\r\n        saver.restore(sess, input_checkpoint)\r\n\r\n        output_graph_def = graph_util.convert_variables_to_constants(\r\n            sess,\r\n            input_graph_def,\r\n            output_node_names\r\n        )\r\n\r\n        with tf.gfile.GFile(model_save_path, \"wb\") as f:\r\n            f.write(output_graph_def.SerializeToString())\r\n```\r\n\r\nThe error that I'm getting is as follows. It looks like the problem is with two embeddings coefficients. If I set `clear_devices=False`, I get the same error but for only one embedding coefficient:\r\n\r\n```python\r\nTraceback (most recent call last):\r\n  File \"myproject/train.py\", line 522, in <module>\r\n    tf.app.run()\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 44, in run\r\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\r\n  File \"myproject/train.py\", line 518, in main\r\n    trainer.save_model(preprocessor)\r\n  File \"myproject/train.py\", line 312, in save_model\r\n    ut.freeze_model(self.checkpoint_dir, model_save_path, C.OUTPUT_NODE_NAMES)\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/myproject/utils.py\", line 224, in freeze_model\r\n    output_node_names\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/framework/graph_util_impl.py\", line 218, in convert_variables_to_constants\r\n    returned_variables = sess.run(variable_names)\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 767, in run\r\n    run_metadata_ptr)\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 965, in _run\r\n    feed_dict_string, options, run_metadata)\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1015, in _do_run\r\n    target_list, options, run_metadata)\r\n  File \"/home/foo/anaconda2/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1035, in _do_call\r\n    raise type(e)(node_def, op, message)\r\nFailedPreconditionError: Attempting to use uninitialized value embeddings/W\r\n\t [[Node: embeddings/W/_20 = _Send[T=DT_FLOAT, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_30_embeddings/W\", _device=\"/job:localhost/replica:0/task:0/gpu:0\"](embeddings/W)]]\r\n\t [[Node: embeddings/W/_21 = _Recv[_start_time=0, client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_30_embeddings/W\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\r\n```\r\n\r\n### Environment info\r\ntensorflow-gpu: 1.0.0\r\nUbuntu 14.0.4.5\r\nCUDA Version 8.0.44\r\n\r\n\r\n### What other attempted solutions have you tried?\r\nI am assigning the embeddings pretrained word2vec values after initializing. I have tried running the model without assigning these values and I get the same error.\r\nI have tried running the training for 70K batches.\r\nI have tried running `tf.report_uninitialized_variables` after calling `tf.global_variables_initializer()` and it has come up empty.\r\n"}