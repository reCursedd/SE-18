{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/158392284", "pull_request_review_id": 85199064, "id": 158392284, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1ODM5MjI4NA==", "diff_hunk": "@@ -33,26 +21,94 @@ tf_proto_library_cc(\n     ],\n )\n \n-load(\"//tensorflow:tensorflow.bzl\", \"tf_custom_op_library\")\n-load(\"//tensorflow:tensorflow.bzl\", \"tf_py_test\")\n+load(\n+    \"//tensorflow:tensorflow.bzl\",\n+    \"tf_custom_op_py_library\",\n+    \"tf_custom_op_library\",\n+    \"tf_gen_op_wrapper_py\",\n+    \"tf_gen_op_libs\",\n+    \"tf_kernel_library\",\n+    \"tf_py_test\",\n+)\n \n tf_custom_op_library(\n-    name = \"mpi_collectives.so\",\n+    name = \"python/ops/_mpi_ops.so\",\n     srcs = [\n-        \"mpi_ops.cc\",\n-        \"ring.cc\",\n-        \"ring.h\",\n+        \"kernels/mpi_ops.cc\",\n+        \"kernels/ring.cc\",\n+        \"kernels/ring.h\",\n+        \"ops/mpi_ops.cc\",\n     ],\n     gpu_srcs = [\n-        \"ring.cu.cc\",\n-        \"ring.h\",\n+        \"kernels/ring.cu.cc\",\n+        \"kernels/ring.h\",\n     ],\n     deps = [\n         \":mpi_message_proto_cc\",\n+        \"//tensorflow/core:lib_internal\",\n         \"//third_party/mpi\",\n     ],\n )\n \n+tf_kernel_library(\n+    name = \"mpi_ops_kernels\",\n+    srcs = [\n+        \"kernels/mpi_ops.cc\",\n+        \"kernels/ring.cc\",\n+    ],\n+    hdrs = [\n+        \"kernels/ring.h\",\n+    ],\n+    gpu_srcs = [\n+        \"kernels/ring.cu.cc\",\n+    ],\n+    deps = [\n+        \"//tensorflow/core:core_cpu\",\n+        \"//tensorflow/core:framework\",\n+        \"//tensorflow/core:gpu_headers_lib\",\n+        \"//tensorflow/core:lib\",\n+        \"//tensorflow/core:lib_internal\",\n+        \"//tensorflow/core:proto_text\",\n+        \"//tensorflow/core:stream_executor\",\n+    ],\n+    # TODO: Include?    alwayslink = 1,\n+)\n+\n+tf_gen_op_libs(\n+    op_lib_names = [\"mpi_ops\"],\n+)\n+\n+tf_gen_op_wrapper_py(\n+    name = \"mpi_ops\",\n+    deps = [\":mpi_ops_op_lib\"],\n+)\n+\n+tf_custom_op_py_library(\n+    name = \"mpi_collectives_py\",\n+    srcs = [\n+        \"__init__.py\",\n+        \"python/ops/mpi_ops.py\",\n+    ],\n+    dso = [\n+        \":python/ops/_mpi_ops.so\",\n+    ],\n+    kernels = [\n+        \":mpi_ops_kernels\",\n+        \":mpi_ops_op_lib\",\n+    ],\n+    srcs_version = \"PY2AND3\",\n+    visibility = [\"//visibility:public\"],\n+    deps = [\n+        \":mpi_ops\",\n+        \"//tensorflow/contrib/util:util_py\",\n+        \"//tensorflow/python:device\",\n+        \"//tensorflow/python:framework_ops\",\n+        \"//tensorflow/python:platform\",\n+        \"//tensorflow/python:util\",\n+        \"//tensorflow/python/eager:context\",", "path": "tensorflow/contrib/mpi_collectives/BUILD", "position": null, "original_position": 115, "commit_id": "b339eab14fcc6fbb99721b0e55bbf7dc683226ae", "original_commit_id": "4c253207e85027a6fa19d35c11a5eafccda871ee", "user": {"login": "jthestness", "id": 28744304, "node_id": "MDQ6VXNlcjI4NzQ0MzA0", "avatar_url": "https://avatars0.githubusercontent.com/u/28744304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jthestness", "html_url": "https://github.com/jthestness", "followers_url": "https://api.github.com/users/jthestness/followers", "following_url": "https://api.github.com/users/jthestness/following{/other_user}", "gists_url": "https://api.github.com/users/jthestness/gists{/gist_id}", "starred_url": "https://api.github.com/users/jthestness/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jthestness/subscriptions", "organizations_url": "https://api.github.com/users/jthestness/orgs", "repos_url": "https://api.github.com/users/jthestness/repos", "events_url": "https://api.github.com/users/jthestness/events{/privacy}", "received_events_url": "https://api.github.com/users/jthestness/received_events", "type": "User", "site_admin": false}, "body": "Fixed! (forgot to remove when I decided against trying to fix eager behavior)", "created_at": "2017-12-21T22:24:28Z", "updated_at": "2017-12-21T22:24:28Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/15534#discussion_r158392284", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/15534", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/158392284"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/15534#discussion_r158392284"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/15534"}}, "body_html": "<p>Fixed! (forgot to remove when I decided against trying to fix eager behavior)</p>", "body_text": "Fixed! (forgot to remove when I decided against trying to fix eager behavior)", "in_reply_to_id": 158379360}