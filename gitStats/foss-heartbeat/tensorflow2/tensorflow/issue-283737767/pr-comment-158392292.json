{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/158392292", "pull_request_review_id": 85199075, "id": 158392292, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1ODM5MjI5Mg==", "diff_hunk": "@@ -33,26 +21,94 @@ tf_proto_library_cc(\n     ],\n )\n \n-load(\"//tensorflow:tensorflow.bzl\", \"tf_custom_op_library\")\n-load(\"//tensorflow:tensorflow.bzl\", \"tf_py_test\")\n+load(\n+    \"//tensorflow:tensorflow.bzl\",\n+    \"tf_custom_op_py_library\",\n+    \"tf_custom_op_library\",\n+    \"tf_gen_op_wrapper_py\",\n+    \"tf_gen_op_libs\",\n+    \"tf_kernel_library\",\n+    \"tf_py_test\",\n+)\n \n tf_custom_op_library(\n-    name = \"mpi_collectives.so\",\n+    name = \"python/ops/_mpi_ops.so\",\n     srcs = [\n-        \"mpi_ops.cc\",\n-        \"ring.cc\",\n-        \"ring.h\",\n+        \"kernels/mpi_ops.cc\",\n+        \"kernels/ring.cc\",\n+        \"kernels/ring.h\",\n+        \"ops/mpi_ops.cc\",\n     ],\n     gpu_srcs = [\n-        \"ring.cu.cc\",\n-        \"ring.h\",\n+        \"kernels/ring.cu.cc\",\n+        \"kernels/ring.h\",\n     ],\n     deps = [\n         \":mpi_message_proto_cc\",\n+        \"//tensorflow/core:lib_internal\",", "path": "tensorflow/contrib/mpi_collectives/BUILD", "position": null, "original_position": 55, "commit_id": "b339eab14fcc6fbb99721b0e55bbf7dc683226ae", "original_commit_id": "4c253207e85027a6fa19d35c11a5eafccda871ee", "user": {"login": "jthestness", "id": 28744304, "node_id": "MDQ6VXNlcjI4NzQ0MzA0", "avatar_url": "https://avatars0.githubusercontent.com/u/28744304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jthestness", "html_url": "https://github.com/jthestness", "followers_url": "https://api.github.com/users/jthestness/followers", "following_url": "https://api.github.com/users/jthestness/following{/other_user}", "gists_url": "https://api.github.com/users/jthestness/gists{/gist_id}", "starred_url": "https://api.github.com/users/jthestness/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jthestness/subscriptions", "organizations_url": "https://api.github.com/users/jthestness/orgs", "repos_url": "https://api.github.com/users/jthestness/repos", "events_url": "https://api.github.com/users/jthestness/events{/privacy}", "received_events_url": "https://api.github.com/users/jthestness/received_events", "type": "User", "site_admin": false}, "body": "Right, `lib_internal` includes `tf_additional_mpi_lib_defines()` for the preprocessor define `TENSORFLOW_USE_MPI`. This might have been the only issue after RTLD_GLOBAL removal.\r\n\r\nPer your suggestion, I moved the defines over to a `cc_library` target within the `mpi_collectives` BUILD file. That works nicely. Thanks!", "created_at": "2017-12-21T22:24:33Z", "updated_at": "2017-12-21T22:24:34Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/15534#discussion_r158392292", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/15534", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/158392292"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/15534#discussion_r158392292"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/15534"}}, "body_html": "<p>Right, <code>lib_internal</code> includes <code>tf_additional_mpi_lib_defines()</code> for the preprocessor define <code>TENSORFLOW_USE_MPI</code>. This might have been the only issue after RTLD_GLOBAL removal.</p>\n<p>Per your suggestion, I moved the defines over to a <code>cc_library</code> target within the <code>mpi_collectives</code> BUILD file. That works nicely. Thanks!</p>", "body_text": "Right, lib_internal includes tf_additional_mpi_lib_defines() for the preprocessor define TENSORFLOW_USE_MPI. This might have been the only issue after RTLD_GLOBAL removal.\nPer your suggestion, I moved the defines over to a cc_library target within the mpi_collectives BUILD file. That works nicely. Thanks!", "in_reply_to_id": 158384942}