{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21412", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21412/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21412/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/21412/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/21412", "id": 347963530, "node_id": "MDU6SXNzdWUzNDc5NjM1MzA=", "number": 21412, "title": "Error in Distribution Strategy with train_and_evaluate", "user": {"login": "lenlen", "id": 2477675, "node_id": "MDQ6VXNlcjI0Nzc2NzU=", "avatar_url": "https://avatars2.githubusercontent.com/u/2477675?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lenlen", "html_url": "https://github.com/lenlen", "followers_url": "https://api.github.com/users/lenlen/followers", "following_url": "https://api.github.com/users/lenlen/following{/other_user}", "gists_url": "https://api.github.com/users/lenlen/gists{/gist_id}", "starred_url": "https://api.github.com/users/lenlen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lenlen/subscriptions", "organizations_url": "https://api.github.com/users/lenlen/orgs", "repos_url": "https://api.github.com/users/lenlen/repos", "events_url": "https://api.github.com/users/lenlen/events{/privacy}", "received_events_url": "https://api.github.com/users/lenlen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-08-06T15:07:05Z", "updated_at": "2018-08-14T19:37:45Z", "closed_at": "2018-08-14T18:33:37Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04.4 LTS</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>: No</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.10.0-rc1 and nightly</li>\n<li><strong>Python version</strong>: Python 3.5.2</li>\n<li><strong>Bazel version (if compiling from source)</strong>: No</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: No</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0.176</li>\n<li><strong>GPU model and memory</strong>: Tesla V100 16152MiB</li>\n<li><strong>Exact command to reproduce</strong>: Save the snippet in test.py and run \"python test.py\"</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>Using the distribute strategy (OneDeviceStrategy) I have a crash with train_and_evaluate method of the estimator.<br>\nThe code below works with train and evaluate as separeted functions, but it doesn't work with train_and_evaluate.<br>\nI have attached a snipped with train, evaluate and train_and_evaluate methods togheter to gather the behaviour differences. At the end I've put the output error log.<br>\nNote: it works with tensorflow 1.9.0 and codalab</p>\n<pre><code>from tensorflow import keras as ks\nimport numpy as np\nimport tensorflow as tf\nfrom tensorflow.python.estimator import keras as keras_lib\n\n\ntf.logging.set_verbosity(tf.logging.INFO)\n\n\ndef input_fn():\n    x = np.random.random((1024, 10))\n    y = np.random.randint(2, size=(1024, 1))\n    x = tf.cast(x, tf.float32)\n    dataset = tf.data.Dataset.from_tensor_slices((x, y))\n    dataset = dataset.repeat(100)\n    dataset = dataset.batch(1)\n    return dataset\n\n\nmodel = ks.Sequential()\nmodel.add(ks.layers.Dense(16, activation='relu', input_shape=(10,)))\nmodel.add(ks.layers.Dense(1, activation='sigmoid'))\n\noptimizer = tf.train.GradientDescentOptimizer(0.2)\n\nmodel.compile(loss='binary_crossentropy', optimizer=optimizer)\n\nstrategy = tf.contrib.distribute.OneDeviceStrategy(\"device:GPU:0\")\nconfig = tf.estimator.RunConfig(train_distribute=strategy)\n\nkeras_estimator = keras_lib.model_to_estimator(\n  keras_model=model,\n  config=config)\n\nkeras_estimator.train(input_fn=input_fn, steps=10)\nkeras_estimator.evaluate(input_fn=input_fn, steps=3)\n\ntrain_spec = tf.estimator.TrainSpec(\n    input_fn=input_fn,\n    max_steps=20)\neval_spec = tf.estimator.EvalSpec(\n    input_fn=input_fn,\n    steps=3)\n\ntf.estimator.train_and_evaluate(keras_estimator, train_spec, eval_spec)\n</code></pre>\n<h3>Source code / logs</h3>\n<pre><code>INFO:tensorflow:Using the Keras model provided.\nWARNING:tensorflow:Using temporary folder as model directory: /tmp/tmp_xh7nsci\nINFO:tensorflow:Using config: {'_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_keep_checkpoint_every_n_hours': 10000, '_global_id_in_cluster': 0, '_task_type': 'worker', '_session_config': None, '_is_chief': True, '_evaluation_master': '', '_log_step_count_steps': 100, '_model_dir': '/tmp/tmp_xh7nsci', '_save_checkpoints_secs': 600, '_save_summary_steps': 100, '_service': None, '_save_checkpoints_steps': None, '_task_id': 0, '_cluster_spec': &lt;tensorflow.python.training.server_lib.ClusterSpec object at 0x7f9a715b1240&gt;, '_device_fn': None, '_keep_checkpoint_max': 5, '_num_worker_replicas': 1, '_train_distribute': &lt;tensorflow.contrib.distribute.python.one_device_strategy.OneDeviceStrategy object at 0x7f9a630426d8&gt;}\n2018-08-06 11:45:02.557498: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-08-06 11:45:02.679737: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-08-06 11:45:02.680248: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1404] Found device 0 with properties: \nname: Tesla V100-SXM2-16GB major: 7 minor: 0 memoryClockRate(GHz): 1.53\npciBusID: 0000:00:1e.0\ntotalMemory: 15.77GiB freeMemory: 15.36GiB\n2018-08-06 11:45:02.680294: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:03.032268: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:03.032321: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:03.032339: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:03.032678: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -&gt; physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\n2018-08-06 11:45:03.032984: E tensorflow/core/common_runtime/gpu/gpu_device.cc:228] Illegal GPUOptions.experimental.num_dev_to_dev_copy_streams=0 set to 1 instead.\n2018-08-06 11:45:03.353069: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:03.353135: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:03.353154: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:03.353162: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:03.353297: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -&gt; physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-08-06 11:45:04.042046: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:04.042111: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:04.042128: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:04.042148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:04.042305: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -&gt; physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/keras_model.ckpt\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 0 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:loss = 0.6695193, step = 0\nINFO:tensorflow:Saving checkpoints for 10 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:Loss for final step: 0.3536753.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-08-06-11:45:04\nINFO:tensorflow:Graph was finalized.\n2018-08-06 11:45:04.822515: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:04.822570: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:04.822594: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:04.822613: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:04.822780: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -&gt; physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/model.ckpt-10\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Evaluation [1/3]\nINFO:tensorflow:Evaluation [2/3]\nINFO:tensorflow:Evaluation [3/3]\nINFO:tensorflow:Finished evaluation at 2018-08-06-11:45:04\nINFO:tensorflow:Saving dict for global step 10: global_step = 10, loss = 0.1408012\nINFO:tensorflow:Saving 'checkpoint_path' summary for global step 10: /tmp/tmp_xh7nsci/model.ckpt-10\nINFO:tensorflow:Running training and evaluation locally (non-distributed).\nINFO:tensorflow:Start train and evaluate loop. The evaluate will happen after every checkpoint. Checkpoint frequency is determined based on RunConfig arguments: save_checkpoints_steps None or save_checkpoints_secs 600.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-08-06 11:45:05.220540: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:05.220581: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:05.220600: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:05.220615: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:05.220760: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -&gt; physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/model.ckpt-10\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 10 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:loss = 1.5840994, step = 10\nINFO:tensorflow:Saving checkpoints for 20 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nTraceback (most recent call last):\n  File \"test2.py\", line 45, in &lt;module&gt;\n    tf.estimator.train_and_evaluate(keras_estimator, train_spec, eval_spec)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 451, in train_and_evaluate\n    return executor.run()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 590, in run\n    return self.run_local()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 691, in run_local\n    saving_listeners=saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 376, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1143, in _train_model\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1368, in _train_model_distributed\n    saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1451, in _train_with_estimator_spec\n    _, loss = mon_sess.run([estimator_spec.train_op, estimator_spec.loss])\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/monitored_session.py\", line 695, in __exit__\n    self._close_internal(exception_type)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/monitored_session.py\", line 727, in _close_internal\n    h.end(self._coordinated_creator.tf_sess)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 470, in end\n    self._save(session, last_step)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 489, in _save\n    if l.after_save(session, step):\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 497, in after_save\n    self._evaluate(global_step_value)  # updates self.eval_result\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 517, in _evaluate\n    self._evaluator.evaluate_and_export())\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 884, in evaluate_and_export\n    hooks=self._eval_spec.hooks)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 463, in evaluate\n    input_fn, hooks, checkpoint_path)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1474, in _evaluate_build_graph\n    model_fn_lib.LOSS_METRIC_KEY] = metrics_lib.mean(estimator_spec.loss)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/ops/metrics_impl.py\", line 376, in mean\n    mean_t = distribute_lib.get_tower_context().merge_call(\nAttributeError: 'NoneType' object has no attribute 'merge_call'\n\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04.4 LTS\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: No\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.10.0-rc1 and nightly\nPython version: Python 3.5.2\nBazel version (if compiling from source): No\nGCC/Compiler version (if compiling from source): No\nCUDA/cuDNN version: 9.0.176\nGPU model and memory: Tesla V100 16152MiB\nExact command to reproduce: Save the snippet in test.py and run \"python test.py\"\n\nDescribe the problem\nUsing the distribute strategy (OneDeviceStrategy) I have a crash with train_and_evaluate method of the estimator.\nThe code below works with train and evaluate as separeted functions, but it doesn't work with train_and_evaluate.\nI have attached a snipped with train, evaluate and train_and_evaluate methods togheter to gather the behaviour differences. At the end I've put the output error log.\nNote: it works with tensorflow 1.9.0 and codalab\nfrom tensorflow import keras as ks\nimport numpy as np\nimport tensorflow as tf\nfrom tensorflow.python.estimator import keras as keras_lib\n\n\ntf.logging.set_verbosity(tf.logging.INFO)\n\n\ndef input_fn():\n    x = np.random.random((1024, 10))\n    y = np.random.randint(2, size=(1024, 1))\n    x = tf.cast(x, tf.float32)\n    dataset = tf.data.Dataset.from_tensor_slices((x, y))\n    dataset = dataset.repeat(100)\n    dataset = dataset.batch(1)\n    return dataset\n\n\nmodel = ks.Sequential()\nmodel.add(ks.layers.Dense(16, activation='relu', input_shape=(10,)))\nmodel.add(ks.layers.Dense(1, activation='sigmoid'))\n\noptimizer = tf.train.GradientDescentOptimizer(0.2)\n\nmodel.compile(loss='binary_crossentropy', optimizer=optimizer)\n\nstrategy = tf.contrib.distribute.OneDeviceStrategy(\"device:GPU:0\")\nconfig = tf.estimator.RunConfig(train_distribute=strategy)\n\nkeras_estimator = keras_lib.model_to_estimator(\n  keras_model=model,\n  config=config)\n\nkeras_estimator.train(input_fn=input_fn, steps=10)\nkeras_estimator.evaluate(input_fn=input_fn, steps=3)\n\ntrain_spec = tf.estimator.TrainSpec(\n    input_fn=input_fn,\n    max_steps=20)\neval_spec = tf.estimator.EvalSpec(\n    input_fn=input_fn,\n    steps=3)\n\ntf.estimator.train_and_evaluate(keras_estimator, train_spec, eval_spec)\n\nSource code / logs\nINFO:tensorflow:Using the Keras model provided.\nWARNING:tensorflow:Using temporary folder as model directory: /tmp/tmp_xh7nsci\nINFO:tensorflow:Using config: {'_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_keep_checkpoint_every_n_hours': 10000, '_global_id_in_cluster': 0, '_task_type': 'worker', '_session_config': None, '_is_chief': True, '_evaluation_master': '', '_log_step_count_steps': 100, '_model_dir': '/tmp/tmp_xh7nsci', '_save_checkpoints_secs': 600, '_save_summary_steps': 100, '_service': None, '_save_checkpoints_steps': None, '_task_id': 0, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f9a715b1240>, '_device_fn': None, '_keep_checkpoint_max': 5, '_num_worker_replicas': 1, '_train_distribute': <tensorflow.contrib.distribute.python.one_device_strategy.OneDeviceStrategy object at 0x7f9a630426d8>}\n2018-08-06 11:45:02.557498: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-08-06 11:45:02.679737: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-08-06 11:45:02.680248: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1404] Found device 0 with properties: \nname: Tesla V100-SXM2-16GB major: 7 minor: 0 memoryClockRate(GHz): 1.53\npciBusID: 0000:00:1e.0\ntotalMemory: 15.77GiB freeMemory: 15.36GiB\n2018-08-06 11:45:02.680294: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:03.032268: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:03.032321: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:03.032339: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:03.032678: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\n2018-08-06 11:45:03.032984: E tensorflow/core/common_runtime/gpu/gpu_device.cc:228] Illegal GPUOptions.experimental.num_dev_to_dev_copy_streams=0 set to 1 instead.\n2018-08-06 11:45:03.353069: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:03.353135: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:03.353154: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:03.353162: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:03.353297: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-08-06 11:45:04.042046: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:04.042111: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:04.042128: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:04.042148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:04.042305: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/keras_model.ckpt\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 0 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:loss = 0.6695193, step = 0\nINFO:tensorflow:Saving checkpoints for 10 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:Loss for final step: 0.3536753.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-08-06-11:45:04\nINFO:tensorflow:Graph was finalized.\n2018-08-06 11:45:04.822515: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:04.822570: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:04.822594: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:04.822613: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:04.822780: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/model.ckpt-10\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Evaluation [1/3]\nINFO:tensorflow:Evaluation [2/3]\nINFO:tensorflow:Evaluation [3/3]\nINFO:tensorflow:Finished evaluation at 2018-08-06-11:45:04\nINFO:tensorflow:Saving dict for global step 10: global_step = 10, loss = 0.1408012\nINFO:tensorflow:Saving 'checkpoint_path' summary for global step 10: /tmp/tmp_xh7nsci/model.ckpt-10\nINFO:tensorflow:Running training and evaluation locally (non-distributed).\nINFO:tensorflow:Start train and evaluate loop. The evaluate will happen after every checkpoint. Checkpoint frequency is determined based on RunConfig arguments: save_checkpoints_steps None or save_checkpoints_secs 600.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-08-06 11:45:05.220540: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\n2018-08-06 11:45:05.220581: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-08-06 11:45:05.220600: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \n2018-08-06 11:45:05.220615: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \n2018-08-06 11:45:05.220760: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/model.ckpt-10\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 10 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:loss = 1.5840994, step = 10\nINFO:tensorflow:Saving checkpoints for 20 into /tmp/tmp_xh7nsci/model.ckpt.\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nTraceback (most recent call last):\n  File \"test2.py\", line 45, in <module>\n    tf.estimator.train_and_evaluate(keras_estimator, train_spec, eval_spec)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 451, in train_and_evaluate\n    return executor.run()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 590, in run\n    return self.run_local()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 691, in run_local\n    saving_listeners=saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 376, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1143, in _train_model\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1368, in _train_model_distributed\n    saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1451, in _train_with_estimator_spec\n    _, loss = mon_sess.run([estimator_spec.train_op, estimator_spec.loss])\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/monitored_session.py\", line 695, in __exit__\n    self._close_internal(exception_type)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/monitored_session.py\", line 727, in _close_internal\n    h.end(self._coordinated_creator.tf_sess)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 470, in end\n    self._save(session, last_step)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 489, in _save\n    if l.after_save(session, step):\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 497, in after_save\n    self._evaluate(global_step_value)  # updates self.eval_result\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 517, in _evaluate\n    self._evaluator.evaluate_and_export())\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 884, in evaluate_and_export\n    hooks=self._eval_spec.hooks)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 463, in evaluate\n    input_fn, hooks, checkpoint_path)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1474, in _evaluate_build_graph\n    model_fn_lib.LOSS_METRIC_KEY] = metrics_lib.mean(estimator_spec.loss)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/ops/metrics_impl.py\", line 376, in mean\n    mean_t = distribute_lib.get_tower_context().merge_call(\nAttributeError: 'NoneType' object has no attribute 'merge_call'", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes \r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04.4 LTS\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**: No\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: 1.10.0-rc1 and nightly\r\n- **Python version**: Python 3.5.2\r\n- **Bazel version (if compiling from source)**: No\r\n- **GCC/Compiler version (if compiling from source)**: No\r\n- **CUDA/cuDNN version**: 9.0.176\r\n- **GPU model and memory**: Tesla V100 16152MiB\r\n- **Exact command to reproduce**: Save the snippet in test.py and run \"python test.py\"\r\n\r\n\r\n### Describe the problem\r\nUsing the distribute strategy (OneDeviceStrategy) I have a crash with train_and_evaluate method of the estimator.\r\nThe code below works with train and evaluate as separeted functions, but it doesn't work with train_and_evaluate.\r\nI have attached a snipped with train, evaluate and train_and_evaluate methods togheter to gather the behaviour differences. At the end I've put the output error log.\r\nNote: it works with tensorflow 1.9.0 and codalab\r\n```\r\nfrom tensorflow import keras as ks\r\nimport numpy as np\r\nimport tensorflow as tf\r\nfrom tensorflow.python.estimator import keras as keras_lib\r\n\r\n\r\ntf.logging.set_verbosity(tf.logging.INFO)\r\n\r\n\r\ndef input_fn():\r\n    x = np.random.random((1024, 10))\r\n    y = np.random.randint(2, size=(1024, 1))\r\n    x = tf.cast(x, tf.float32)\r\n    dataset = tf.data.Dataset.from_tensor_slices((x, y))\r\n    dataset = dataset.repeat(100)\r\n    dataset = dataset.batch(1)\r\n    return dataset\r\n\r\n\r\nmodel = ks.Sequential()\r\nmodel.add(ks.layers.Dense(16, activation='relu', input_shape=(10,)))\r\nmodel.add(ks.layers.Dense(1, activation='sigmoid'))\r\n\r\noptimizer = tf.train.GradientDescentOptimizer(0.2)\r\n\r\nmodel.compile(loss='binary_crossentropy', optimizer=optimizer)\r\n\r\nstrategy = tf.contrib.distribute.OneDeviceStrategy(\"device:GPU:0\")\r\nconfig = tf.estimator.RunConfig(train_distribute=strategy)\r\n\r\nkeras_estimator = keras_lib.model_to_estimator(\r\n  keras_model=model,\r\n  config=config)\r\n\r\nkeras_estimator.train(input_fn=input_fn, steps=10)\r\nkeras_estimator.evaluate(input_fn=input_fn, steps=3)\r\n\r\ntrain_spec = tf.estimator.TrainSpec(\r\n    input_fn=input_fn,\r\n    max_steps=20)\r\neval_spec = tf.estimator.EvalSpec(\r\n    input_fn=input_fn,\r\n    steps=3)\r\n\r\ntf.estimator.train_and_evaluate(keras_estimator, train_spec, eval_spec)\r\n```\r\n\r\n### Source code / logs\r\n```\r\nINFO:tensorflow:Using the Keras model provided.\r\nWARNING:tensorflow:Using temporary folder as model directory: /tmp/tmp_xh7nsci\r\nINFO:tensorflow:Using config: {'_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_keep_checkpoint_every_n_hours': 10000, '_global_id_in_cluster': 0, '_task_type': 'worker', '_session_config': None, '_is_chief': True, '_evaluation_master': '', '_log_step_count_steps': 100, '_model_dir': '/tmp/tmp_xh7nsci', '_save_checkpoints_secs': 600, '_save_summary_steps': 100, '_service': None, '_save_checkpoints_steps': None, '_task_id': 0, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f9a715b1240>, '_device_fn': None, '_keep_checkpoint_max': 5, '_num_worker_replicas': 1, '_train_distribute': <tensorflow.contrib.distribute.python.one_device_strategy.OneDeviceStrategy object at 0x7f9a630426d8>}\r\n2018-08-06 11:45:02.557498: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\n2018-08-06 11:45:02.679737: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\n2018-08-06 11:45:02.680248: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1404] Found device 0 with properties: \r\nname: Tesla V100-SXM2-16GB major: 7 minor: 0 memoryClockRate(GHz): 1.53\r\npciBusID: 0000:00:1e.0\r\ntotalMemory: 15.77GiB freeMemory: 15.36GiB\r\n2018-08-06 11:45:02.680294: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\r\n2018-08-06 11:45:03.032268: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-06 11:45:03.032321: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \r\n2018-08-06 11:45:03.032339: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \r\n2018-08-06 11:45:03.032678: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\r\n2018-08-06 11:45:03.032984: E tensorflow/core/common_runtime/gpu/gpu_device.cc:228] Illegal GPUOptions.experimental.num_dev_to_dev_copy_streams=0 set to 1 instead.\r\n2018-08-06 11:45:03.353069: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\r\n2018-08-06 11:45:03.353135: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-06 11:45:03.353154: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \r\n2018-08-06 11:45:03.353162: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \r\n2018-08-06 11:45:03.353297: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Create CheckpointSaverHook.\r\nINFO:tensorflow:Graph was finalized.\r\n2018-08-06 11:45:04.042046: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\r\n2018-08-06 11:45:04.042111: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-06 11:45:04.042128: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \r\n2018-08-06 11:45:04.042148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \r\n2018-08-06 11:45:04.042305: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\r\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/keras_model.ckpt\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Saving checkpoints for 0 into /tmp/tmp_xh7nsci/model.ckpt.\r\nINFO:tensorflow:loss = 0.6695193, step = 0\r\nINFO:tensorflow:Saving checkpoints for 10 into /tmp/tmp_xh7nsci/model.ckpt.\r\nINFO:tensorflow:Loss for final step: 0.3536753.\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Starting evaluation at 2018-08-06-11:45:04\r\nINFO:tensorflow:Graph was finalized.\r\n2018-08-06 11:45:04.822515: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\r\n2018-08-06 11:45:04.822570: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-06 11:45:04.822594: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \r\n2018-08-06 11:45:04.822613: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \r\n2018-08-06 11:45:04.822780: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\r\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/model.ckpt-10\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Evaluation [1/3]\r\nINFO:tensorflow:Evaluation [2/3]\r\nINFO:tensorflow:Evaluation [3/3]\r\nINFO:tensorflow:Finished evaluation at 2018-08-06-11:45:04\r\nINFO:tensorflow:Saving dict for global step 10: global_step = 10, loss = 0.1408012\r\nINFO:tensorflow:Saving 'checkpoint_path' summary for global step 10: /tmp/tmp_xh7nsci/model.ckpt-10\r\nINFO:tensorflow:Running training and evaluation locally (non-distributed).\r\nINFO:tensorflow:Start train and evaluate loop. The evaluate will happen after every checkpoint. Checkpoint frequency is determined based on RunConfig arguments: save_checkpoints_steps None or save_checkpoints_secs 600.\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Create CheckpointSaverHook.\r\nINFO:tensorflow:Graph was finalized.\r\n2018-08-06 11:45:05.220540: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1483] Adding visible gpu devices: 0\r\n2018-08-06 11:45:05.220581: I tensorflow/core/common_runtime/gpu/gpu_device.cc:964] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-08-06 11:45:05.220600: I tensorflow/core/common_runtime/gpu/gpu_device.cc:970]      0 \r\n2018-08-06 11:45:05.220615: I tensorflow/core/common_runtime/gpu/gpu_device.cc:983] 0:   N \r\n2018-08-06 11:45:05.220760: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1096] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 14856 MB memory) -> physical GPU (device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:1e.0, compute capability: 7.0)\r\nINFO:tensorflow:Restoring parameters from /tmp/tmp_xh7nsci/model.ckpt-10\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Saving checkpoints for 10 into /tmp/tmp_xh7nsci/model.ckpt.\r\nINFO:tensorflow:loss = 1.5840994, step = 10\r\nINFO:tensorflow:Saving checkpoints for 20 into /tmp/tmp_xh7nsci/model.ckpt.\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nTraceback (most recent call last):\r\n  File \"test2.py\", line 45, in <module>\r\n    tf.estimator.train_and_evaluate(keras_estimator, train_spec, eval_spec)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 451, in train_and_evaluate\r\n    return executor.run()\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 590, in run\r\n    return self.run_local()\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 691, in run_local\r\n    saving_listeners=saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 376, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1143, in _train_model\r\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1368, in _train_model_distributed\r\n    saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1451, in _train_with_estimator_spec\r\n    _, loss = mon_sess.run([estimator_spec.train_op, estimator_spec.loss])\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/monitored_session.py\", line 695, in __exit__\r\n    self._close_internal(exception_type)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/monitored_session.py\", line 727, in _close_internal\r\n    h.end(self._coordinated_creator.tf_sess)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 470, in end\r\n    self._save(session, last_step)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 489, in _save\r\n    if l.after_save(session, step):\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 497, in after_save\r\n    self._evaluate(global_step_value)  # updates self.eval_result\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 517, in _evaluate\r\n    self._evaluator.evaluate_and_export())\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 884, in evaluate_and_export\r\n    hooks=self._eval_spec.hooks)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 463, in evaluate\r\n    input_fn, hooks, checkpoint_path)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 1474, in _evaluate_build_graph\r\n    model_fn_lib.LOSS_METRIC_KEY] = metrics_lib.mean(estimator_spec.loss)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/ops/metrics_impl.py\", line 376, in mean\r\n    mean_t = distribute_lib.get_tower_context().merge_call(\r\nAttributeError: 'NoneType' object has no attribute 'merge_call'\r\n\r\n```\r\n"}