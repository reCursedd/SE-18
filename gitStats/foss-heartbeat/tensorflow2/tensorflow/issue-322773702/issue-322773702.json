{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19265", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19265/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19265/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19265/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19265", "id": 322773702, "node_id": "MDU6SXNzdWUzMjI3NzM3MDI=", "number": 19265, "title": "`tf.nn.embedding_lookup`: unexpected behaviour with sharded `params` in \"div\" mode", "user": {"login": "syltruong", "id": 24707558, "node_id": "MDQ6VXNlcjI0NzA3NTU4", "avatar_url": "https://avatars0.githubusercontent.com/u/24707558?v=4", "gravatar_id": "", "url": "https://api.github.com/users/syltruong", "html_url": "https://github.com/syltruong", "followers_url": "https://api.github.com/users/syltruong/followers", "following_url": "https://api.github.com/users/syltruong/following{/other_user}", "gists_url": "https://api.github.com/users/syltruong/gists{/gist_id}", "starred_url": "https://api.github.com/users/syltruong/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/syltruong/subscriptions", "organizations_url": "https://api.github.com/users/syltruong/orgs", "repos_url": "https://api.github.com/users/syltruong/repos", "events_url": "https://api.github.com/users/syltruong/events{/privacy}", "received_events_url": "https://api.github.com/users/syltruong/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "robieta", "id": 13089297, "node_id": "MDQ6VXNlcjEzMDg5Mjk3", "avatar_url": "https://avatars0.githubusercontent.com/u/13089297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/robieta", "html_url": "https://github.com/robieta", "followers_url": "https://api.github.com/users/robieta/followers", "following_url": "https://api.github.com/users/robieta/following{/other_user}", "gists_url": "https://api.github.com/users/robieta/gists{/gist_id}", "starred_url": "https://api.github.com/users/robieta/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/robieta/subscriptions", "organizations_url": "https://api.github.com/users/robieta/orgs", "repos_url": "https://api.github.com/users/robieta/repos", "events_url": "https://api.github.com/users/robieta/events{/privacy}", "received_events_url": "https://api.github.com/users/robieta/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "robieta", "id": 13089297, "node_id": "MDQ6VXNlcjEzMDg5Mjk3", "avatar_url": "https://avatars0.githubusercontent.com/u/13089297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/robieta", "html_url": "https://github.com/robieta", "followers_url": "https://api.github.com/users/robieta/followers", "following_url": "https://api.github.com/users/robieta/following{/other_user}", "gists_url": "https://api.github.com/users/robieta/gists{/gist_id}", "starred_url": "https://api.github.com/users/robieta/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/robieta/subscriptions", "organizations_url": "https://api.github.com/users/robieta/orgs", "repos_url": "https://api.github.com/users/robieta/repos", "events_url": "https://api.github.com/users/robieta/events{/privacy}", "received_events_url": "https://api.github.com/users/robieta/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2018-05-14T11:18:28Z", "updated_at": "2018-05-24T16:12:55Z", "closed_at": "2018-05-24T16:12:54Z", "author_association": "NONE", "body_html": "<p>The following code shows what appears to be a <a href=\"https://www.tensorflow.org/api_docs/python/tf/nn/embedding_lookup\" rel=\"nofollow\">misbehaviour</a> when trying to lookup sharded embeddings in \"div\" mode:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">def</span> <span class=\"pl-en\">test_shard_embedding_lookup</span>(<span class=\"pl-smi\">index</span>):\n   embeddings_1 <span class=\"pl-k\">=</span> tf.constant([[<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>],[<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">1</span>],[<span class=\"pl-c1\">2</span>,<span class=\"pl-c1\">2</span>,<span class=\"pl-c1\">2</span>],[<span class=\"pl-c1\">3</span>,<span class=\"pl-c1\">3</span>,<span class=\"pl-c1\">3</span>]])\n   embeddings_2 <span class=\"pl-k\">=</span> tf.constant([[<span class=\"pl-c1\">4</span>,<span class=\"pl-c1\">4</span>,<span class=\"pl-c1\">4</span>],[<span class=\"pl-c1\">5</span>,<span class=\"pl-c1\">5</span>,<span class=\"pl-c1\">5</span>]])\n   indices <span class=\"pl-k\">=</span> tf.constant([index])\n    \n   <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n      ret <span class=\"pl-k\">=</span> sess.run(\\\n                  tf.nn.embedding_lookup(\\\n                     [embeddings_1, embeddings_2],\\\n                     indices,\\\n                     <span class=\"pl-v\">partition_strategy</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>div<span class=\"pl-pds\">'</span></span>\\\n                  )\\\n                )\n\n   <span class=\"pl-k\">return</span> ret\n\ntest_shard_embedding_lookup(<span class=\"pl-c1\">2</span>) <span class=\"pl-c\"><span class=\"pl-c\">#</span> [2,2,2]</span>\ntest_shard_embedding_lookup(<span class=\"pl-c1\">3</span>) <span class=\"pl-c\"><span class=\"pl-c\">#</span> [4,4,4] instead of [3,3,3]</span></pre></div>\n<p>Tested with</p>\n<ul>\n<li>Python 3.6.5</li>\n<li>TF 1.8</li>\n</ul>", "body_text": "The following code shows what appears to be a misbehaviour when trying to lookup sharded embeddings in \"div\" mode:\ndef test_shard_embedding_lookup(index):\n   embeddings_1 = tf.constant([[0,0,0],[1,1,1],[2,2,2],[3,3,3]])\n   embeddings_2 = tf.constant([[4,4,4],[5,5,5]])\n   indices = tf.constant([index])\n    \n   with tf.Session() as sess:\n      ret = sess.run(\\\n                  tf.nn.embedding_lookup(\\\n                     [embeddings_1, embeddings_2],\\\n                     indices,\\\n                     partition_strategy='div'\\\n                  )\\\n                )\n\n   return ret\n\ntest_shard_embedding_lookup(2) # [2,2,2]\ntest_shard_embedding_lookup(3) # [4,4,4] instead of [3,3,3]\nTested with\n\nPython 3.6.5\nTF 1.8", "body": "The following code shows what appears to be a [misbehaviour](https://www.tensorflow.org/api_docs/python/tf/nn/embedding_lookup) when trying to lookup sharded embeddings in \"div\" mode:\r\n\r\n```python\r\ndef test_shard_embedding_lookup(index):\r\n   embeddings_1 = tf.constant([[0,0,0],[1,1,1],[2,2,2],[3,3,3]])\r\n   embeddings_2 = tf.constant([[4,4,4],[5,5,5]])\r\n   indices = tf.constant([index])\r\n    \r\n   with tf.Session() as sess:\r\n      ret = sess.run(\\\r\n                  tf.nn.embedding_lookup(\\\r\n                     [embeddings_1, embeddings_2],\\\r\n                     indices,\\\r\n                     partition_strategy='div'\\\r\n                  )\\\r\n                )\r\n\r\n   return ret\r\n\r\ntest_shard_embedding_lookup(2) # [2,2,2]\r\ntest_shard_embedding_lookup(3) # [4,4,4] instead of [3,3,3]\r\n```\r\n\r\nTested with\r\n\r\n- Python 3.6.5\r\n- TF 1.8\r\n\r\n"}