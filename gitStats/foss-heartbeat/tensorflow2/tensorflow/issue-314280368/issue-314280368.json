{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18512", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18512/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18512/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18512/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/18512", "id": 314280368, "node_id": "MDU6SXNzdWUzMTQyODAzNjg=", "number": 18512, "title": "NoOp replacement in DependencyOptimizer misses some control dependency conversions", "user": {"login": "marshall-dw", "id": 1789934, "node_id": "MDQ6VXNlcjE3ODk5MzQ=", "avatar_url": "https://avatars0.githubusercontent.com/u/1789934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marshall-dw", "html_url": "https://github.com/marshall-dw", "followers_url": "https://api.github.com/users/marshall-dw/followers", "following_url": "https://api.github.com/users/marshall-dw/following{/other_user}", "gists_url": "https://api.github.com/users/marshall-dw/gists{/gist_id}", "starred_url": "https://api.github.com/users/marshall-dw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marshall-dw/subscriptions", "organizations_url": "https://api.github.com/users/marshall-dw/orgs", "repos_url": "https://api.github.com/users/marshall-dw/repos", "events_url": "https://api.github.com/users/marshall-dw/events{/privacy}", "received_events_url": "https://api.github.com/users/marshall-dw/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": {"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-04-13T23:58:00Z", "updated_at": "2018-11-20T13:27:10Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nyes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nDebian testing (buster)</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<br>\nbinary</li>\n<li><strong>TensorFlow version (use command below)</strong>:<br>\n('v1.7.0-3-g024aecf414', '1.7.0')</li>\n<li><strong>Python version</strong>:<br>\n2.7.14</li>\n<li><strong>Bazel version (if compiling from source)</strong>:<br>\nN/A</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:<br>\nN/A</li>\n<li><strong>CUDA/cuDNN version</strong>:<br>\nN/A</li>\n<li><strong>GPU model and memory</strong>:<br>\nN/A</li>\n<li><strong>Exact command to reproduce</strong>:<br>\nRun Python code below with environment variable <code>TF_CPP_MIN_VLOG_LEVEL=1</code></li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When <code>DependencyOptimizer::OptimizeNode()</code> converts a node to a NoOp, it only converts the first input from each input node to a control dependencies. Multiple inputs from the same node can cause a NoOp to be created with non-control inputs. In the VLOG output below, the IdentityN node has inputs \"^Placeholder\" and \"Placeholder\". I haven't tried it but perhaps when <a href=\"https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/grappler/optimizers/dependency_optimizer.cc#L214\">this condition</a> is false, the input should be deleted (like in the <a href=\"https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/grappler/optimizers/dependency_optimizer.cc#L204\">control input case</a>). Note that the bad NoOp gets deleted in the small example here (because that was the easiest way to display the problem) but the real code I was running, the NoOp remains in the graph to cause trouble later.</p>\n<p>This bug is pretty sneaky: a NoOp with non-control inputs can cause <code>GraphConstructor</code> methods to fail, which in turn (silently!) prevents graph optimization (<a href=\"https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/common_runtime/graph_execution_state.cc#L396\">see here</a>). The fallback original graph runs fine. I only went investigating because I saw output like this:</p>\n<pre><code>2018-04-12 13:09:26.465603: E tensorflow/core/framework/types.cc:102] Unrecognized DataType enum value 425390044\n</code></pre>\n<p>The cause was an error message from <code>GraphConstructor::MakeEdge()</code>, called <a href=\"https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/graph/graph_constructor.cc#L1008\">here</a>. It appears <code>node</code> and <code>node_def</code> did not agree on how many inputs there were to the node! <code>node</code> thought zero, which is where that strange DataType enum value came from: reading uninitialized memory <a href=\"https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/graph/graph_constructor.cc#L1156\">here</a>. I wasn't able to reproduce that exact failure in a tiny example; I believe the example here causes optimization to fail <a href=\"https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/graph/graph_constructor.cc#L442\">here</a>.</p>\n<p>It would also be nice to see a warning when graph optimization fails.</p>\n<h3>Source code / logs</h3>\n<h4>Code to reproduce the problem</h4>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\n<span class=\"pl-k\">with</span> tf.device(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>/cpu:0<span class=\"pl-pds\">'</span></span>):\n    x <span class=\"pl-k\">=</span> tf.placeholder(<span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.int32, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[])\n    id2 <span class=\"pl-k\">=</span> tf.identity_n([x, x])\n    <span class=\"pl-k\">with</span> tf.control_dependencies(id2):\n        y <span class=\"pl-k\">=</span> x <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    <span class=\"pl-c1\">print</span> sess.run(y, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{x: <span class=\"pl-c1\">5</span>})</pre></div>\n<h4>Relevant log output</h4>\n<pre><code>2018-04-13 15:58:27.870639: I tensorflow/core/grappler/optimizers/dependency_optimizer.cc:194] ***** Replacing  IdentityN (IdentityN) with NoOp.\n2018-04-13 15:58:27.870678: I tensorflow/core/grappler/optimizers/dependency_optimizer.cc:332] ***** Rerouting input around\nname: \"IdentityN\"\nop: \"NoOp\"\ninput: \"^Placeholder\"\ninput: \"Placeholder\"\ndevice: \"/job:localhost/replica:0/task:0/device:CPU:0\"\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nyes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nDebian testing (buster)\nTensorFlow installed from (source or binary):\nbinary\nTensorFlow version (use command below):\n('v1.7.0-3-g024aecf414', '1.7.0')\nPython version:\n2.7.14\nBazel version (if compiling from source):\nN/A\nGCC/Compiler version (if compiling from source):\nN/A\nCUDA/cuDNN version:\nN/A\nGPU model and memory:\nN/A\nExact command to reproduce:\nRun Python code below with environment variable TF_CPP_MIN_VLOG_LEVEL=1\n\nDescribe the problem\nWhen DependencyOptimizer::OptimizeNode() converts a node to a NoOp, it only converts the first input from each input node to a control dependencies. Multiple inputs from the same node can cause a NoOp to be created with non-control inputs. In the VLOG output below, the IdentityN node has inputs \"^Placeholder\" and \"Placeholder\". I haven't tried it but perhaps when this condition is false, the input should be deleted (like in the control input case). Note that the bad NoOp gets deleted in the small example here (because that was the easiest way to display the problem) but the real code I was running, the NoOp remains in the graph to cause trouble later.\nThis bug is pretty sneaky: a NoOp with non-control inputs can cause GraphConstructor methods to fail, which in turn (silently!) prevents graph optimization (see here). The fallback original graph runs fine. I only went investigating because I saw output like this:\n2018-04-12 13:09:26.465603: E tensorflow/core/framework/types.cc:102] Unrecognized DataType enum value 425390044\n\nThe cause was an error message from GraphConstructor::MakeEdge(), called here. It appears node and node_def did not agree on how many inputs there were to the node! node thought zero, which is where that strange DataType enum value came from: reading uninitialized memory here. I wasn't able to reproduce that exact failure in a tiny example; I believe the example here causes optimization to fail here.\nIt would also be nice to see a warning when graph optimization fails.\nSource code / logs\nCode to reproduce the problem\nimport tensorflow as tf\n\nwith tf.device('/cpu:0'):\n    x = tf.placeholder(dtype=tf.int32, shape=[])\n    id2 = tf.identity_n([x, x])\n    with tf.control_dependencies(id2):\n        y = x + 1\n\nwith tf.Session() as sess:\n    print sess.run(y, feed_dict={x: 5})\nRelevant log output\n2018-04-13 15:58:27.870639: I tensorflow/core/grappler/optimizers/dependency_optimizer.cc:194] ***** Replacing  IdentityN (IdentityN) with NoOp.\n2018-04-13 15:58:27.870678: I tensorflow/core/grappler/optimizers/dependency_optimizer.cc:332] ***** Rerouting input around\nname: \"IdentityN\"\nop: \"NoOp\"\ninput: \"^Placeholder\"\ninput: \"Placeholder\"\ndevice: \"/job:localhost/replica:0/task:0/device:CPU:0\"", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nyes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nDebian testing (buster)\r\n- **TensorFlow installed from (source or binary)**:\r\nbinary\r\n- **TensorFlow version (use command below)**:\r\n('v1.7.0-3-g024aecf414', '1.7.0')\r\n- **Python version**: \r\n2.7.14\r\n- **Bazel version (if compiling from source)**:\r\nN/A\r\n- **GCC/Compiler version (if compiling from source)**:\r\nN/A\r\n- **CUDA/cuDNN version**:\r\nN/A\r\n- **GPU model and memory**:\r\nN/A\r\n- **Exact command to reproduce**:\r\nRun Python code below with environment variable `TF_CPP_MIN_VLOG_LEVEL=1`\r\n\r\n### Describe the problem\r\nWhen `DependencyOptimizer::OptimizeNode()` converts a node to a NoOp, it only converts the first input from each input node to a control dependencies. Multiple inputs from the same node can cause a NoOp to be created with non-control inputs. In the VLOG output below, the IdentityN node has inputs \"^Placeholder\" and \"Placeholder\". I haven't tried it but perhaps when [this condition](https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/grappler/optimizers/dependency_optimizer.cc#L214) is false, the input should be deleted (like in the [control input case](https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/grappler/optimizers/dependency_optimizer.cc#L204)). Note that the bad NoOp gets deleted in the small example here (because that was the easiest way to display the problem) but the real code I was running, the NoOp remains in the graph to cause trouble later.\r\n\r\nThis bug is pretty sneaky: a NoOp with non-control inputs can cause `GraphConstructor` methods to fail, which in turn (silently!) prevents graph optimization ([see here](https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/common_runtime/graph_execution_state.cc#L396)). The fallback original graph runs fine. I only went investigating because I saw output like this:\r\n\r\n```\r\n2018-04-12 13:09:26.465603: E tensorflow/core/framework/types.cc:102] Unrecognized DataType enum value 425390044\r\n```\r\n\r\nThe cause was an error message from `GraphConstructor::MakeEdge()`, called [here](https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/graph/graph_constructor.cc#L1008). It appears `node` and `node_def` did not agree on how many inputs there were to the node! `node` thought zero, which is where that strange DataType enum value came from: reading uninitialized memory [here](https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/graph/graph_constructor.cc#L1156). I wasn't able to reproduce that exact failure in a tiny example; I believe the example here causes optimization to fail [here](https://github.com/tensorflow/tensorflow/blob/92e6c3e4f5c1cabfda1e61547a6a1b268ef95fa5/tensorflow/core/graph/graph_constructor.cc#L442).\r\n\r\nIt would also be nice to see a warning when graph optimization fails.\r\n\r\n### Source code / logs\r\n\r\n#### Code to reproduce the problem\r\n```python\r\nimport tensorflow as tf\r\n\r\nwith tf.device('/cpu:0'):\r\n    x = tf.placeholder(dtype=tf.int32, shape=[])\r\n    id2 = tf.identity_n([x, x])\r\n    with tf.control_dependencies(id2):\r\n        y = x + 1\r\n\r\nwith tf.Session() as sess:\r\n    print sess.run(y, feed_dict={x: 5})\r\n```\r\n\r\n#### Relevant log output\r\n```\r\n2018-04-13 15:58:27.870639: I tensorflow/core/grappler/optimizers/dependency_optimizer.cc:194] ***** Replacing  IdentityN (IdentityN) with NoOp.\r\n2018-04-13 15:58:27.870678: I tensorflow/core/grappler/optimizers/dependency_optimizer.cc:332] ***** Rerouting input around\r\nname: \"IdentityN\"\r\nop: \"NoOp\"\r\ninput: \"^Placeholder\"\r\ninput: \"Placeholder\"\r\ndevice: \"/job:localhost/replica:0/task:0/device:CPU:0\"\r\n```"}