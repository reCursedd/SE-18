{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9416", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9416/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9416/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9416/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/9416", "id": 223826222, "node_id": "MDU6SXNzdWUyMjM4MjYyMjI=", "number": 9416, "title": "Android Demo: Rotation on some devices broken.", "user": {"login": "jubjamie", "id": 25011496, "node_id": "MDQ6VXNlcjI1MDExNDk2", "avatar_url": "https://avatars3.githubusercontent.com/u/25011496?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jubjamie", "html_url": "https://github.com/jubjamie", "followers_url": "https://api.github.com/users/jubjamie/followers", "following_url": "https://api.github.com/users/jubjamie/following{/other_user}", "gists_url": "https://api.github.com/users/jubjamie/gists{/gist_id}", "starred_url": "https://api.github.com/users/jubjamie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jubjamie/subscriptions", "organizations_url": "https://api.github.com/users/jubjamie/orgs", "repos_url": "https://api.github.com/users/jubjamie/repos", "events_url": "https://api.github.com/users/jubjamie/events{/privacy}", "received_events_url": "https://api.github.com/users/jubjamie/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2017-04-24T13:48:24Z", "updated_at": "2018-03-20T16:32:56Z", "closed_at": "2017-06-16T21:11:38Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Android</strong>:</li>\n<li><strong>TensorFlow installed from source</strong>:</li>\n<li><strong>TensorFlow version 1.0.0</strong>:<br>\nN/A</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>The Android Demo code seems to be a bit buggy on our Pixel C. I wanted to confirm that this isn't an issue with the TF code but it's a strange one.</p>\n<p>The Rotation in the demo apps on our Pixel C didn't seem to work correctly. It would give the value of 3 when it should have read 90. This meant that the input was basically on it's side. I found that for it to work that this line needed to be set to 0.</p>\n<p><code>sensorOrientation = rotation + screenOrientation;</code> needed to be<br>\n<code>sensorOrientation = 0;</code><br>\nHowever, when used in landscape mode this didn't crop around the centre of the preview image but instead it created a square from the left edge.</p>\n<pre><code>|------------------| ---------|                         \n|                  |          |\n|       CROP       |          |\n|     SQUARE       |          |\n|__________________|__________|\n</code></pre>\n<p>When set to 0.<br>\nThe solution seemed to be to set the Orientation to 360.</p>\n<pre><code>|-----|------------------|----|                         \n|     |                  |    |\n|     |        CROP      |    |\n|     |      SQUARE      |    |\n|_____|__________________|____|\n</code></pre>\n<p>When set to 360.</p>\n<p>At the time (a couple of weeks ago) I recalled that it forced some code to run that would centre it as required for some other operations however going through the code to find it I can't. I think it was related to this but it doesn't make sense as to why 360 solved the issue.</p>\n<pre><code>private void configureTransform(final int viewWidth, final int viewHeight) {\n    final Activity activity = getActivity();\n    if (null == textureView || null == previewSize || null == activity) {\n      return;\n    }\n    final int rotation = activity.getWindowManager().getDefaultDisplay().getRotation();\n    final Matrix matrix = new Matrix();\n    final RectF viewRect = new RectF(0, 0, viewWidth, viewHeight);\n    final RectF bufferRect = new RectF(0, 0, previewSize.getHeight(), previewSize.getWidth());\n    final float centerX = viewRect.centerX();\n    final float centerY = viewRect.centerY();\n    if (Surface.ROTATION_90 == rotation || Surface.ROTATION_270 == rotation) {\n      bufferRect.offset(centerX - bufferRect.centerX(), centerY - bufferRect.centerY());\n      matrix.setRectToRect(viewRect, bufferRect, Matrix.ScaleToFit.FILL);\n      final float scale =\n          Math.max(\n              (float) viewHeight / previewSize.getHeight(),\n              (float) viewWidth / previewSize.getWidth());\n      matrix.postScale(scale, scale, centerX, centerY);\n      matrix.postRotate(90 * (rotation - 2), centerX, centerY);\n    } else if (Surface.ROTATION_180 == rotation) {\n      matrix.postRotate(180, centerX, centerY);\n    }\n    textureView.setTransform(matrix);\n  }\n</code></pre>\n<p>So I guess the question is that is this happening due to some strange hardware bug with the Pixel C or some coding error. I'm leaning towards the former as this is too bizarre to be caused by code but thought i'd open the discussion out as others trying to run the app in landscape may face similar issues.</p>", "body_text": "System information\n\nAndroid:\nTensorFlow installed from source:\nTensorFlow version 1.0.0:\nN/A\n\nDescribe the problem\nThe Android Demo code seems to be a bit buggy on our Pixel C. I wanted to confirm that this isn't an issue with the TF code but it's a strange one.\nThe Rotation in the demo apps on our Pixel C didn't seem to work correctly. It would give the value of 3 when it should have read 90. This meant that the input was basically on it's side. I found that for it to work that this line needed to be set to 0.\nsensorOrientation = rotation + screenOrientation; needed to be\nsensorOrientation = 0;\nHowever, when used in landscape mode this didn't crop around the centre of the preview image but instead it created a square from the left edge.\n|------------------| ---------|                         \n|                  |          |\n|       CROP       |          |\n|     SQUARE       |          |\n|__________________|__________|\n\nWhen set to 0.\nThe solution seemed to be to set the Orientation to 360.\n|-----|------------------|----|                         \n|     |                  |    |\n|     |        CROP      |    |\n|     |      SQUARE      |    |\n|_____|__________________|____|\n\nWhen set to 360.\nAt the time (a couple of weeks ago) I recalled that it forced some code to run that would centre it as required for some other operations however going through the code to find it I can't. I think it was related to this but it doesn't make sense as to why 360 solved the issue.\nprivate void configureTransform(final int viewWidth, final int viewHeight) {\n    final Activity activity = getActivity();\n    if (null == textureView || null == previewSize || null == activity) {\n      return;\n    }\n    final int rotation = activity.getWindowManager().getDefaultDisplay().getRotation();\n    final Matrix matrix = new Matrix();\n    final RectF viewRect = new RectF(0, 0, viewWidth, viewHeight);\n    final RectF bufferRect = new RectF(0, 0, previewSize.getHeight(), previewSize.getWidth());\n    final float centerX = viewRect.centerX();\n    final float centerY = viewRect.centerY();\n    if (Surface.ROTATION_90 == rotation || Surface.ROTATION_270 == rotation) {\n      bufferRect.offset(centerX - bufferRect.centerX(), centerY - bufferRect.centerY());\n      matrix.setRectToRect(viewRect, bufferRect, Matrix.ScaleToFit.FILL);\n      final float scale =\n          Math.max(\n              (float) viewHeight / previewSize.getHeight(),\n              (float) viewWidth / previewSize.getWidth());\n      matrix.postScale(scale, scale, centerX, centerY);\n      matrix.postRotate(90 * (rotation - 2), centerX, centerY);\n    } else if (Surface.ROTATION_180 == rotation) {\n      matrix.postRotate(180, centerX, centerY);\n    }\n    textureView.setTransform(matrix);\n  }\n\nSo I guess the question is that is this happening due to some strange hardware bug with the Pixel C or some coding error. I'm leaning towards the former as this is too bizarre to be caused by code but thought i'd open the discussion out as others trying to run the app in landscape may face similar issues.", "body": "### System information\r\n- **Android**:\r\n- **TensorFlow installed from source**:\r\n- **TensorFlow version 1.0.0**:\r\nN/A\r\n\r\n### Describe the problem\r\nThe Android Demo code seems to be a bit buggy on our Pixel C. I wanted to confirm that this isn't an issue with the TF code but it's a strange one.\r\n\r\nThe Rotation in the demo apps on our Pixel C didn't seem to work correctly. It would give the value of 3 when it should have read 90. This meant that the input was basically on it's side. I found that for it to work that this line needed to be set to 0.\r\n\r\n```sensorOrientation = rotation + screenOrientation;``` needed to be\r\n```sensorOrientation = 0;```\r\nHowever, when used in landscape mode this didn't crop around the centre of the preview image but instead it created a square from the left edge.\r\n\r\n```\r\n|------------------| ---------|                         \r\n|                  |          |\r\n|       CROP       |          |\r\n|     SQUARE       |          |\r\n|__________________|__________|\r\n```\r\nWhen set to 0.\r\nThe solution seemed to be to set the Orientation to 360.  \r\n\r\n```\r\n|-----|------------------|----|                         \r\n|     |                  |    |\r\n|     |        CROP      |    |\r\n|     |      SQUARE      |    |\r\n|_____|__________________|____|\r\n```\r\nWhen set to 360.\r\n\r\nAt the time (a couple of weeks ago) I recalled that it forced some code to run that would centre it as required for some other operations however going through the code to find it I can't. I think it was related to this but it doesn't make sense as to why 360 solved the issue.\r\n```\r\nprivate void configureTransform(final int viewWidth, final int viewHeight) {\r\n    final Activity activity = getActivity();\r\n    if (null == textureView || null == previewSize || null == activity) {\r\n      return;\r\n    }\r\n    final int rotation = activity.getWindowManager().getDefaultDisplay().getRotation();\r\n    final Matrix matrix = new Matrix();\r\n    final RectF viewRect = new RectF(0, 0, viewWidth, viewHeight);\r\n    final RectF bufferRect = new RectF(0, 0, previewSize.getHeight(), previewSize.getWidth());\r\n    final float centerX = viewRect.centerX();\r\n    final float centerY = viewRect.centerY();\r\n    if (Surface.ROTATION_90 == rotation || Surface.ROTATION_270 == rotation) {\r\n      bufferRect.offset(centerX - bufferRect.centerX(), centerY - bufferRect.centerY());\r\n      matrix.setRectToRect(viewRect, bufferRect, Matrix.ScaleToFit.FILL);\r\n      final float scale =\r\n          Math.max(\r\n              (float) viewHeight / previewSize.getHeight(),\r\n              (float) viewWidth / previewSize.getWidth());\r\n      matrix.postScale(scale, scale, centerX, centerY);\r\n      matrix.postRotate(90 * (rotation - 2), centerX, centerY);\r\n    } else if (Surface.ROTATION_180 == rotation) {\r\n      matrix.postRotate(180, centerX, centerY);\r\n    }\r\n    textureView.setTransform(matrix);\r\n  }\r\n```\r\n\r\nSo I guess the question is that is this happening due to some strange hardware bug with the Pixel C or some coding error. I'm leaning towards the former as this is too bizarre to be caused by code but thought i'd open the discussion out as others trying to run the app in landscape may face similar issues."}