{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20916", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20916/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20916/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20916/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/20916", "id": 342266540, "node_id": "MDU6SXNzdWUzNDIyNjY1NDA=", "number": 20916, "title": "tf.contrib.graph_editor.graph_replace is broken for while loops", "user": {"login": "gonnet", "id": 10587723, "node_id": "MDQ6VXNlcjEwNTg3NzIz", "avatar_url": "https://avatars3.githubusercontent.com/u/10587723?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gonnet", "html_url": "https://github.com/gonnet", "followers_url": "https://api.github.com/users/gonnet/followers", "following_url": "https://api.github.com/users/gonnet/following{/other_user}", "gists_url": "https://api.github.com/users/gonnet/gists{/gist_id}", "starred_url": "https://api.github.com/users/gonnet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gonnet/subscriptions", "organizations_url": "https://api.github.com/users/gonnet/orgs", "repos_url": "https://api.github.com/users/gonnet/repos", "events_url": "https://api.github.com/users/gonnet/events{/privacy}", "received_events_url": "https://api.github.com/users/gonnet/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": {"login": "bignamehyp", "id": 3474655, "node_id": "MDQ6VXNlcjM0NzQ2NTU=", "avatar_url": "https://avatars2.githubusercontent.com/u/3474655?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bignamehyp", "html_url": "https://github.com/bignamehyp", "followers_url": "https://api.github.com/users/bignamehyp/followers", "following_url": "https://api.github.com/users/bignamehyp/following{/other_user}", "gists_url": "https://api.github.com/users/bignamehyp/gists{/gist_id}", "starred_url": "https://api.github.com/users/bignamehyp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bignamehyp/subscriptions", "organizations_url": "https://api.github.com/users/bignamehyp/orgs", "repos_url": "https://api.github.com/users/bignamehyp/repos", "events_url": "https://api.github.com/users/bignamehyp/events{/privacy}", "received_events_url": "https://api.github.com/users/bignamehyp/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "bignamehyp", "id": 3474655, "node_id": "MDQ6VXNlcjM0NzQ2NTU=", "avatar_url": "https://avatars2.githubusercontent.com/u/3474655?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bignamehyp", "html_url": "https://github.com/bignamehyp", "followers_url": "https://api.github.com/users/bignamehyp/followers", "following_url": "https://api.github.com/users/bignamehyp/following{/other_user}", "gists_url": "https://api.github.com/users/bignamehyp/gists{/gist_id}", "starred_url": "https://api.github.com/users/bignamehyp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bignamehyp/subscriptions", "organizations_url": "https://api.github.com/users/bignamehyp/orgs", "repos_url": "https://api.github.com/users/bignamehyp/repos", "events_url": "https://api.github.com/users/bignamehyp/events{/privacy}", "received_events_url": "https://api.github.com/users/bignamehyp/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-07-18T10:19:37Z", "updated_at": "2018-11-13T18:56:15Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: source</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.9</li>\n<li><strong>Python version</strong>: 2.7.13</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>tf.contrib.graph_editor.graph_replace is broken for Graphs containing while-loops.</p>\n<h3>Source code / logs</h3>\n<p>I've created a commit (<a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/1b9f2a51206ad1adcc7fa6d6acc8d06fd7efd497/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/1b9f2a51206ad1adcc7fa6d6acc8d06fd7efd497\"><tt>1b9f2a5</tt></a>) which adds a simple test in tensorflow/contrib/graph_editor/tests/transform_test.py, which creates a graph with a while loop and replaces one of the variables therein:</p>\n<div class=\"highlight highlight-source-python\"><pre>  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_graph_replace_while_loop</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>):\n    ops.reset_default_graph()\n    a <span class=\"pl-k\">=</span> constant_op.constant(<span class=\"pl-c1\">1</span>, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>a<span class=\"pl-pds\">\"</span></span>)\n    max_index <span class=\"pl-k\">=</span> constant_op.constant(<span class=\"pl-c1\">10</span>)\n    index_start <span class=\"pl-k\">=</span> constant_op.constant(<span class=\"pl-c1\">1</span>)\n    sum_start <span class=\"pl-k\">=</span> constant_op.constant(<span class=\"pl-c1\">0</span>)\n    _, result <span class=\"pl-k\">=</span> control_flow_ops.while_loop(\n        <span class=\"pl-v\">cond</span><span class=\"pl-k\">=</span><span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">i</span>, <span class=\"pl-smi\">unused_s</span>: i <span class=\"pl-k\">&lt;=</span> max_index,\n        <span class=\"pl-v\">body</span><span class=\"pl-k\">=</span><span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">i</span>, <span class=\"pl-smi\">s</span>: (i <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>, s <span class=\"pl-k\">+</span> a),\n        <span class=\"pl-v\">loop_vars</span><span class=\"pl-k\">=</span>[index_start, sum_start])\n    a_new <span class=\"pl-k\">=</span> constant_op.constant(<span class=\"pl-c1\">2</span>, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>a_new<span class=\"pl-pds\">\"</span></span>)\n    result_new <span class=\"pl-k\">=</span> ge.graph_replace(result, {a: a_new})\n    <span class=\"pl-k\">with</span> session.Session() <span class=\"pl-k\">as</span> sess:\n      sess.run(variables.global_variables_initializer())\n      result_val, result_new_val <span class=\"pl-k\">=</span> sess.run([result, result_new])\n    <span class=\"pl-c1\">self</span>.assertEqual(result_val, <span class=\"pl-c1\">10</span>, <span class=\"pl-c1\">ERROR_TOLERANCE</span>)\n    <span class=\"pl-c1\">self</span>.assertEqual(result_new_val, <span class=\"pl-c1\">20</span>, <span class=\"pl-c1\">ERROR_TOLERANCE</span>)</pre></div>\n<p>The test fails as follows:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c1\">......</span>..I0718 <span class=\"pl-c1\">0<span class=\"pl-ii\">3</span></span>:<span class=\"pl-c1\">0<span class=\"pl-ii\">6</span></span>:<span class=\"pl-c1\">24.128054</span>    <span class=\"pl-c1\">6838</span> control_flow_util.py:<span class=\"pl-c1\">313</span>] Cannot use <span class=\"pl-s\"><span class=\"pl-pds\">'</span>while/LessEqual/Enter<span class=\"pl-pds\">'</span></span> <span class=\"pl-k\">as</span> <span class=\"pl-c1\">input</span> to <span class=\"pl-s\"><span class=\"pl-pds\">'</span>while/LessEqual_1<span class=\"pl-pds\">'</span></span> because <span class=\"pl-s\"><span class=\"pl-pds\">'</span>while/LessEqual/Enter<span class=\"pl-pds\">'</span></span> <span class=\"pl-k\">is</span> <span class=\"pl-k\">in</span> a <span class=\"pl-k\">while</span> loop.\n\n<span class=\"pl-k\">while</span><span class=\"pl-k\">/</span>LessEqual_1 <span class=\"pl-k\">while</span> context: <span class=\"pl-c1\">None</span>\n<span class=\"pl-k\">while</span><span class=\"pl-k\">/</span>LessEqual<span class=\"pl-k\">/</span>Enter <span class=\"pl-k\">while</span> context: <span class=\"pl-k\">while</span><span class=\"pl-k\">/</span>while_context</pre></div>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): 1.9\nPython version: 2.7.13\n\nDescribe the problem\ntf.contrib.graph_editor.graph_replace is broken for Graphs containing while-loops.\nSource code / logs\nI've created a commit (1b9f2a5) which adds a simple test in tensorflow/contrib/graph_editor/tests/transform_test.py, which creates a graph with a while loop and replaces one of the variables therein:\n  def test_graph_replace_while_loop(self):\n    ops.reset_default_graph()\n    a = constant_op.constant(1, name=\"a\")\n    max_index = constant_op.constant(10)\n    index_start = constant_op.constant(1)\n    sum_start = constant_op.constant(0)\n    _, result = control_flow_ops.while_loop(\n        cond=lambda i, unused_s: i <= max_index,\n        body=lambda i, s: (i + 1, s + a),\n        loop_vars=[index_start, sum_start])\n    a_new = constant_op.constant(2, name=\"a_new\")\n    result_new = ge.graph_replace(result, {a: a_new})\n    with session.Session() as sess:\n      sess.run(variables.global_variables_initializer())\n      result_val, result_new_val = sess.run([result, result_new])\n    self.assertEqual(result_val, 10, ERROR_TOLERANCE)\n    self.assertEqual(result_new_val, 20, ERROR_TOLERANCE)\nThe test fails as follows:\n........I0718 03:06:24.128054    6838 control_flow_util.py:313] Cannot use 'while/LessEqual/Enter' as input to 'while/LessEqual_1' because 'while/LessEqual/Enter' is in a while loop.\n\nwhile/LessEqual_1 while context: None\nwhile/LessEqual/Enter while context: while/while_context", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: \r\n- **TensorFlow installed from (source or binary)**: source\r\n- **TensorFlow version (use command below)**: 1.9\r\n- **Python version**: 2.7.13\r\n\r\n### Describe the problem\r\ntf.contrib.graph_editor.graph_replace is broken for Graphs containing while-loops.\r\n\r\n### Source code / logs\r\nI've created a commit (1b9f2a5) which adds a simple test in tensorflow/contrib/graph_editor/tests/transform_test.py, which creates a graph with a while loop and replaces one of the variables therein:\r\n\r\n```python\r\n  def test_graph_replace_while_loop(self):\r\n    ops.reset_default_graph()\r\n    a = constant_op.constant(1, name=\"a\")\r\n    max_index = constant_op.constant(10)\r\n    index_start = constant_op.constant(1)\r\n    sum_start = constant_op.constant(0)\r\n    _, result = control_flow_ops.while_loop(\r\n        cond=lambda i, unused_s: i <= max_index,\r\n        body=lambda i, s: (i + 1, s + a),\r\n        loop_vars=[index_start, sum_start])\r\n    a_new = constant_op.constant(2, name=\"a_new\")\r\n    result_new = ge.graph_replace(result, {a: a_new})\r\n    with session.Session() as sess:\r\n      sess.run(variables.global_variables_initializer())\r\n      result_val, result_new_val = sess.run([result, result_new])\r\n    self.assertEqual(result_val, 10, ERROR_TOLERANCE)\r\n    self.assertEqual(result_new_val, 20, ERROR_TOLERANCE)\r\n```\r\n\r\nThe test fails as follows:\r\n\r\n```python\r\n........I0718 03:06:24.128054    6838 control_flow_util.py:313] Cannot use 'while/LessEqual/Enter' as input to 'while/LessEqual_1' because 'while/LessEqual/Enter' is in a while loop.\r\n\r\nwhile/LessEqual_1 while context: None\r\nwhile/LessEqual/Enter while context: while/while_context\r\n```\r\n\r\n"}