{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17694", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17694/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17694/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17694/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17694", "id": 304954008, "node_id": "MDU6SXNzdWUzMDQ5NTQwMDg=", "number": 17694, "title": "tf.test.TestCase not working properly with tf.map_fn", "user": {"login": "bkungfoo", "id": 3732627, "node_id": "MDQ6VXNlcjM3MzI2Mjc=", "avatar_url": "https://avatars2.githubusercontent.com/u/3732627?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bkungfoo", "html_url": "https://github.com/bkungfoo", "followers_url": "https://api.github.com/users/bkungfoo/followers", "following_url": "https://api.github.com/users/bkungfoo/following{/other_user}", "gists_url": "https://api.github.com/users/bkungfoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/bkungfoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bkungfoo/subscriptions", "organizations_url": "https://api.github.com/users/bkungfoo/orgs", "repos_url": "https://api.github.com/users/bkungfoo/repos", "events_url": "https://api.github.com/users/bkungfoo/events{/privacy}", "received_events_url": "https://api.github.com/users/bkungfoo/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-03-13T22:09:44Z", "updated_at": "2018-04-05T19:15:27Z", "closed_at": "2018-04-05T19:15:27Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: mac OSX</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: source</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.4.0 and 1.5.0</li>\n<li><strong>Python version</strong>: 3.6</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: None</li>\n<li><strong>GPU model and memory</strong>: None</li>\n<li><strong>Exact command to reproduce</strong>: Run the snippet below.</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When trying to run tf.test.TestCase with a tensor of strings, tf.map_fn() throws errors that a normal tf.Session.run() does not encounter.</p>\n<p>I am trying to create unit tests with tf.test.TestCase, but could not find a way to test tf.map_fn without Tensorflow returning an error. (This occurs in both TF 1.4 and 1.5.) My guess is it has to do with how strings are treated by map_fn as tensors...</p>\n<h3>Source code / logs</h3>\n<p>Here is a very simple example:</p>\n<pre><code>    def identity_map(input):\n      return input\n\n    # Using tf.Session() and sess.run(). This runs without errors.\n    input = ['123', 'abc']\n    x = tf.map_fn(identity_map, input_tensor, dtype=tf.string)\n    x = tf.stack(x)\n    x = tf.reshape(tensor=x, shape=[-1])\n\n    with tf.Session() as sess:\n      result = sess.run(x, {input_tensor: input})\n      print(result)\n</code></pre>\n<p>Now I create a unit test and try to run it:</p>\n<pre><code>    class SimpleTest(tf.test.TestCase):\n      def testMapString(self):\n        input = ['123', 'abc']\n        with self.test_session():\n          # Run map function\n          x = tf.map_fn(identity_map, input, dtype=tf.string)\n          x = tf.stack(x)\n          x = tf.reshape(tensor=x, shape=[-1])\n          result = x.eval()\n          print(result)\n</code></pre>\n<p>I get this output. Any idea what went wrong?</p>\n<pre><code>Traceback (most recent call last):\n...\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 344, in map_fn\n    n = array_ops.shape(elems_flat[0])[0]\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 538, in _SliceHelper\n    name=name)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 706, in strided_slice\n    shrink_axis_mask=shrink_axis_mask)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 5430, in strided_slice\n    name=name)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2958, in create_op\n    set_shapes_for_outputs(ret)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2209, in set_shapes_for_outputs\n    shapes = shape_func(op)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2159, in call_with_requiring\n    return call_cpp_shape_fn(op, require_shape_fn=True)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/common_shapes.py\", line 627, in call_cpp_shape_fn\n    require_shape_fn)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/common_shapes.py\", line 691, in _call_cpp_shape_fn_impl\n    raise ValueError(err.message)\nValueError: slice index 0 of dimension 0 out of bounds. for 'map_1/strided_slice' (op: 'StridedSlice') with input shapes: [0], [1], [1], [1] and with computed input tensors: input[1] = &lt;0&gt;, input[2] = &lt;1&gt;, input[3] = &lt;1&gt;.\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): mac OSX\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): 1.4.0 and 1.5.0\nPython version: 3.6\nBazel version (if compiling from source): N/A\nGCC/Compiler version (if compiling from source): N/A\nCUDA/cuDNN version: None\nGPU model and memory: None\nExact command to reproduce: Run the snippet below.\n\nDescribe the problem\nWhen trying to run tf.test.TestCase with a tensor of strings, tf.map_fn() throws errors that a normal tf.Session.run() does not encounter.\nI am trying to create unit tests with tf.test.TestCase, but could not find a way to test tf.map_fn without Tensorflow returning an error. (This occurs in both TF 1.4 and 1.5.) My guess is it has to do with how strings are treated by map_fn as tensors...\nSource code / logs\nHere is a very simple example:\n    def identity_map(input):\n      return input\n\n    # Using tf.Session() and sess.run(). This runs without errors.\n    input = ['123', 'abc']\n    x = tf.map_fn(identity_map, input_tensor, dtype=tf.string)\n    x = tf.stack(x)\n    x = tf.reshape(tensor=x, shape=[-1])\n\n    with tf.Session() as sess:\n      result = sess.run(x, {input_tensor: input})\n      print(result)\n\nNow I create a unit test and try to run it:\n    class SimpleTest(tf.test.TestCase):\n      def testMapString(self):\n        input = ['123', 'abc']\n        with self.test_session():\n          # Run map function\n          x = tf.map_fn(identity_map, input, dtype=tf.string)\n          x = tf.stack(x)\n          x = tf.reshape(tensor=x, shape=[-1])\n          result = x.eval()\n          print(result)\n\nI get this output. Any idea what went wrong?\nTraceback (most recent call last):\n...\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 344, in map_fn\n    n = array_ops.shape(elems_flat[0])[0]\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 538, in _SliceHelper\n    name=name)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 706, in strided_slice\n    shrink_axis_mask=shrink_axis_mask)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 5430, in strided_slice\n    name=name)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2958, in create_op\n    set_shapes_for_outputs(ret)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2209, in set_shapes_for_outputs\n    shapes = shape_func(op)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2159, in call_with_requiring\n    return call_cpp_shape_fn(op, require_shape_fn=True)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/common_shapes.py\", line 627, in call_cpp_shape_fn\n    require_shape_fn)\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/common_shapes.py\", line 691, in _call_cpp_shape_fn_impl\n    raise ValueError(err.message)\nValueError: slice index 0 of dimension 0 out of bounds. for 'map_1/strided_slice' (op: 'StridedSlice') with input shapes: [0], [1], [1], [1] and with computed input tensors: input[1] = <0>, input[2] = <1>, input[3] = <1>.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: mac OSX\r\n- **TensorFlow installed from (source or binary)**: source\r\n- **TensorFlow version (use command below)**: 1.4.0 and 1.5.0\r\n- **Python version**: 3.6\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **GCC/Compiler version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: None\r\n- **GPU model and memory**: None\r\n- **Exact command to reproduce**: Run the snippet below.\r\n\r\n### Describe the problem\r\n\r\nWhen trying to run tf.test.TestCase with a tensor of strings, tf.map_fn() throws errors that a normal tf.Session.run() does not encounter.\r\n\r\nI am trying to create unit tests with tf.test.TestCase, but could not find a way to test tf.map_fn without Tensorflow returning an error. (This occurs in both TF 1.4 and 1.5.) My guess is it has to do with how strings are treated by map_fn as tensors...\r\n\r\n### Source code / logs\r\n\r\nHere is a very simple example:\r\n```\r\n    def identity_map(input):\r\n      return input\r\n\r\n    # Using tf.Session() and sess.run(). This runs without errors.\r\n    input = ['123', 'abc']\r\n    x = tf.map_fn(identity_map, input_tensor, dtype=tf.string)\r\n    x = tf.stack(x)\r\n    x = tf.reshape(tensor=x, shape=[-1])\r\n\r\n    with tf.Session() as sess:\r\n      result = sess.run(x, {input_tensor: input})\r\n      print(result)\r\n```\r\n\r\nNow I create a unit test and try to run it:\r\n\r\n```\r\n    class SimpleTest(tf.test.TestCase):\r\n      def testMapString(self):\r\n        input = ['123', 'abc']\r\n        with self.test_session():\r\n          # Run map function\r\n          x = tf.map_fn(identity_map, input, dtype=tf.string)\r\n          x = tf.stack(x)\r\n          x = tf.reshape(tensor=x, shape=[-1])\r\n          result = x.eval()\r\n          print(result)\r\n```\r\n\r\nI get this output. Any idea what went wrong?\r\n```\r\nTraceback (most recent call last):\r\n...\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 344, in map_fn\r\n    n = array_ops.shape(elems_flat[0])[0]\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 538, in _SliceHelper\r\n    name=name)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 706, in strided_slice\r\n    shrink_axis_mask=shrink_axis_mask)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 5430, in strided_slice\r\n    name=name)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2958, in create_op\r\n    set_shapes_for_outputs(ret)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2209, in set_shapes_for_outputs\r\n    shapes = shape_func(op)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2159, in call_with_requiring\r\n    return call_cpp_shape_fn(op, require_shape_fn=True)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/common_shapes.py\", line 627, in call_cpp_shape_fn\r\n    require_shape_fn)\r\n  File \"/Users/bfoo/venv3/strata/lib/python3.6/site-packages/tensorflow/python/framework/common_shapes.py\", line 691, in _call_cpp_shape_fn_impl\r\n    raise ValueError(err.message)\r\nValueError: slice index 0 of dimension 0 out of bounds. for 'map_1/strided_slice' (op: 'StridedSlice') with input shapes: [0], [1], [1], [1] and with computed input tensors: input[1] = <0>, input[2] = <1>, input[3] = <1>.\r\n```"}