{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/426706706", "html_url": "https://github.com/tensorflow/tensorflow/pull/22429#issuecomment-426706706", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22429", "id": 426706706, "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjcwNjcwNg==", "user": {"login": "jsimsa", "id": 1072079, "node_id": "MDQ6VXNlcjEwNzIwNzk=", "avatar_url": "https://avatars2.githubusercontent.com/u/1072079?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsimsa", "html_url": "https://github.com/jsimsa", "followers_url": "https://api.github.com/users/jsimsa/followers", "following_url": "https://api.github.com/users/jsimsa/following{/other_user}", "gists_url": "https://api.github.com/users/jsimsa/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsimsa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsimsa/subscriptions", "organizations_url": "https://api.github.com/users/jsimsa/orgs", "repos_url": "https://api.github.com/users/jsimsa/repos", "events_url": "https://api.github.com/users/jsimsa/events{/privacy}", "received_events_url": "https://api.github.com/users/jsimsa/received_events", "type": "User", "site_admin": false}, "created_at": "2018-10-03T16:36:09Z", "updated_at": "2018-10-03T16:36:09Z", "author_association": "MEMBER", "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=5057740\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/feihugis\">@feihugis</a> the following comments were raised during an internal review of your PR:</p>\n<pre><code>========================================================================\nFile tensorflow/core/kernels/data/matching_files_dataset_op.cc (snapshot 1)\n------------------------------------\nLine 49 (MatchingFilesDatasetOp.MakeDataset):\n    for (int i = 0; i &lt; num_patterns; i++) {\n\nThis `int` will create compiler warnings on some platforms... `size_t` is recommended here.\n------------------------------------\nLine 103 (Iterator.GetNextInternal):\n        Status ret;\n\nWhat purpose is `ret` serving here? It never seems to be returned, or indeed read.\n\n(This suggests we might be missing some tests for error cases....)\n------------------------------------\nLine 113 (Iterator.GetNextInternal):\n            // We can also use isDectory() here. But IsDirectory call can be\n\ns/isDectory/IsDirectory/\n------------------------------------\nLine 117 (Iterator.GetNextInternal):\n              filepath_tensor.scalar&lt;string&gt;()() = current_file;\n\nOpportunity for a std::move here.\n------------------------------------\nLine 132 (Iterator.GetNextInternal):\n                0, current_pattern_.find_first_of(\"*?[\\\\\"));\n\nThis seems like it could be a string_view.\n------------------------------------\nLine 207 (Iterator.UpdateIterator):\n        string fixed_prefix =\n\nAnother opportunity for string_view?\n------------------------------------\nLine 218 (Iterator.UpdateIterator):\n        // there isn't any point in exploring that child path).\n\nCan this comment move to where children_dir_status is defined?\n------------------------------------\nLine 226 (Iterator.UpdateIterator):\n          ret.Update(s);\n\nShould we just return immediately if GetChildren() fails?\n------------------------------------\nLine 237 (Iterator.UpdateIterator):\n              return ret;\n\nThis seems like it could be a return Status::OK();\n------------------------------------\nLine 254 (Iterator.UpdateIterator):\n              children_dir_status[i] =\n\nuse errors::Cancelled(\"Operation not needed\") instead of Status(...)\n------------------------------------\nLine 268 (Iterator.UpdateIterator):\n          counter.Wait();\n\nApparently we have a new utility method to help with code like this: tensorflow/core/lib/core/threadpool.h?l=62-69\n------------------------------------\nLine 273 (Iterator.UpdateIterator):\n            const Status child_dir_status = children_dir_status[i];\n\nconst Status&amp; to avoid copying the error message.\n------------------------------------\nLine 277 (Iterator.UpdateIterator):\n            }\n\nShould we return child_dir_status? It looks like we swallow it and when we return `ret` on L291 we're returning the status of fs-&gt;GetChildren() (which may well be OK, even though we're \"bailing\" with an error here).\n------------------------------------\nLine 288 (Iterator.UpdateIterator):\n            }\n\nWould it be worth storing a bit in filepath_queue_ that indicates whether a path is known to be a file (the else branch) and thus doesn't need to be re-expanded? IIUC, I think we're doing 2x the necessary RPCs for the leaves on remote file systems.\n------------------------------------\nLine 298 (Dataset.Iterator):\n      string current_pattern_ GUARDED_BY(mu_);\n\nDoes this need to be part of the iterator state? (Instead accessing `dataset()-&gt;patterns_[current_pattern_index_]` would save a copy, and slightly simplify the iterator state.)\n========================================================================\n</code></pre>\n<p>In addition, the Python tests for your implementation are failing. Please check to make sure that you are not assuming that path separators are <code>/</code> in your tests.</p>\n<p>Once these comments are addressed (ideally please address them all in a single commit for ease of review), we will re-run the tests to make sure the Windows issue is fixed and there are no new issues.</p>\n<p>Thanks!</p>", "body_text": "@feihugis the following comments were raised during an internal review of your PR:\n========================================================================\nFile tensorflow/core/kernels/data/matching_files_dataset_op.cc (snapshot 1)\n------------------------------------\nLine 49 (MatchingFilesDatasetOp.MakeDataset):\n    for (int i = 0; i < num_patterns; i++) {\n\nThis `int` will create compiler warnings on some platforms... `size_t` is recommended here.\n------------------------------------\nLine 103 (Iterator.GetNextInternal):\n        Status ret;\n\nWhat purpose is `ret` serving here? It never seems to be returned, or indeed read.\n\n(This suggests we might be missing some tests for error cases....)\n------------------------------------\nLine 113 (Iterator.GetNextInternal):\n            // We can also use isDectory() here. But IsDirectory call can be\n\ns/isDectory/IsDirectory/\n------------------------------------\nLine 117 (Iterator.GetNextInternal):\n              filepath_tensor.scalar<string>()() = current_file;\n\nOpportunity for a std::move here.\n------------------------------------\nLine 132 (Iterator.GetNextInternal):\n                0, current_pattern_.find_first_of(\"*?[\\\\\"));\n\nThis seems like it could be a string_view.\n------------------------------------\nLine 207 (Iterator.UpdateIterator):\n        string fixed_prefix =\n\nAnother opportunity for string_view?\n------------------------------------\nLine 218 (Iterator.UpdateIterator):\n        // there isn't any point in exploring that child path).\n\nCan this comment move to where children_dir_status is defined?\n------------------------------------\nLine 226 (Iterator.UpdateIterator):\n          ret.Update(s);\n\nShould we just return immediately if GetChildren() fails?\n------------------------------------\nLine 237 (Iterator.UpdateIterator):\n              return ret;\n\nThis seems like it could be a return Status::OK();\n------------------------------------\nLine 254 (Iterator.UpdateIterator):\n              children_dir_status[i] =\n\nuse errors::Cancelled(\"Operation not needed\") instead of Status(...)\n------------------------------------\nLine 268 (Iterator.UpdateIterator):\n          counter.Wait();\n\nApparently we have a new utility method to help with code like this: tensorflow/core/lib/core/threadpool.h?l=62-69\n------------------------------------\nLine 273 (Iterator.UpdateIterator):\n            const Status child_dir_status = children_dir_status[i];\n\nconst Status& to avoid copying the error message.\n------------------------------------\nLine 277 (Iterator.UpdateIterator):\n            }\n\nShould we return child_dir_status? It looks like we swallow it and when we return `ret` on L291 we're returning the status of fs->GetChildren() (which may well be OK, even though we're \"bailing\" with an error here).\n------------------------------------\nLine 288 (Iterator.UpdateIterator):\n            }\n\nWould it be worth storing a bit in filepath_queue_ that indicates whether a path is known to be a file (the else branch) and thus doesn't need to be re-expanded? IIUC, I think we're doing 2x the necessary RPCs for the leaves on remote file systems.\n------------------------------------\nLine 298 (Dataset.Iterator):\n      string current_pattern_ GUARDED_BY(mu_);\n\nDoes this need to be part of the iterator state? (Instead accessing `dataset()->patterns_[current_pattern_index_]` would save a copy, and slightly simplify the iterator state.)\n========================================================================\n\nIn addition, the Python tests for your implementation are failing. Please check to make sure that you are not assuming that path separators are / in your tests.\nOnce these comments are addressed (ideally please address them all in a single commit for ease of review), we will re-run the tests to make sure the Windows issue is fixed and there are no new issues.\nThanks!", "body": "@feihugis the following comments were raised during an internal review of your PR:\r\n\r\n```\r\n========================================================================\r\nFile tensorflow/core/kernels/data/matching_files_dataset_op.cc (snapshot 1)\r\n------------------------------------\r\nLine 49 (MatchingFilesDatasetOp.MakeDataset):\r\n    for (int i = 0; i < num_patterns; i++) {\r\n\r\nThis `int` will create compiler warnings on some platforms... `size_t` is recommended here.\r\n------------------------------------\r\nLine 103 (Iterator.GetNextInternal):\r\n        Status ret;\r\n\r\nWhat purpose is `ret` serving here? It never seems to be returned, or indeed read.\r\n\r\n(This suggests we might be missing some tests for error cases....)\r\n------------------------------------\r\nLine 113 (Iterator.GetNextInternal):\r\n            // We can also use isDectory() here. But IsDirectory call can be\r\n\r\ns/isDectory/IsDirectory/\r\n------------------------------------\r\nLine 117 (Iterator.GetNextInternal):\r\n              filepath_tensor.scalar<string>()() = current_file;\r\n\r\nOpportunity for a std::move here.\r\n------------------------------------\r\nLine 132 (Iterator.GetNextInternal):\r\n                0, current_pattern_.find_first_of(\"*?[\\\\\"));\r\n\r\nThis seems like it could be a string_view.\r\n------------------------------------\r\nLine 207 (Iterator.UpdateIterator):\r\n        string fixed_prefix =\r\n\r\nAnother opportunity for string_view?\r\n------------------------------------\r\nLine 218 (Iterator.UpdateIterator):\r\n        // there isn't any point in exploring that child path).\r\n\r\nCan this comment move to where children_dir_status is defined?\r\n------------------------------------\r\nLine 226 (Iterator.UpdateIterator):\r\n          ret.Update(s);\r\n\r\nShould we just return immediately if GetChildren() fails?\r\n------------------------------------\r\nLine 237 (Iterator.UpdateIterator):\r\n              return ret;\r\n\r\nThis seems like it could be a return Status::OK();\r\n------------------------------------\r\nLine 254 (Iterator.UpdateIterator):\r\n              children_dir_status[i] =\r\n\r\nuse errors::Cancelled(\"Operation not needed\") instead of Status(...)\r\n------------------------------------\r\nLine 268 (Iterator.UpdateIterator):\r\n          counter.Wait();\r\n\r\nApparently we have a new utility method to help with code like this: tensorflow/core/lib/core/threadpool.h?l=62-69\r\n------------------------------------\r\nLine 273 (Iterator.UpdateIterator):\r\n            const Status child_dir_status = children_dir_status[i];\r\n\r\nconst Status& to avoid copying the error message.\r\n------------------------------------\r\nLine 277 (Iterator.UpdateIterator):\r\n            }\r\n\r\nShould we return child_dir_status? It looks like we swallow it and when we return `ret` on L291 we're returning the status of fs->GetChildren() (which may well be OK, even though we're \"bailing\" with an error here).\r\n------------------------------------\r\nLine 288 (Iterator.UpdateIterator):\r\n            }\r\n\r\nWould it be worth storing a bit in filepath_queue_ that indicates whether a path is known to be a file (the else branch) and thus doesn't need to be re-expanded? IIUC, I think we're doing 2x the necessary RPCs for the leaves on remote file systems.\r\n------------------------------------\r\nLine 298 (Dataset.Iterator):\r\n      string current_pattern_ GUARDED_BY(mu_);\r\n\r\nDoes this need to be part of the iterator state? (Instead accessing `dataset()->patterns_[current_pattern_index_]` would save a copy, and slightly simplify the iterator state.)\r\n========================================================================\r\n```\r\n\r\nIn addition, the Python tests for your implementation are failing. Please check to make sure that you are not assuming that path separators are `/` in your tests.\r\n\r\nOnce these comments are addressed (ideally please address them all in a single commit for ease of review), we will re-run the tests to make sure the Windows issue is fixed and there are no new issues.\r\n\r\nThanks!"}