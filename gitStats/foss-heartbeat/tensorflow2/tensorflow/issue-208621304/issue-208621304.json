{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7643", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7643/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7643/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7643/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/7643", "id": 208621304, "node_id": "MDU6SXNzdWUyMDg2MjEzMDQ=", "number": 7643, "title": "Interaction between tf.map_fn and tf.gradients", "user": {"login": "daniellevy", "id": 2715912, "node_id": "MDQ6VXNlcjI3MTU5MTI=", "avatar_url": "https://avatars2.githubusercontent.com/u/2715912?v=4", "gravatar_id": "", "url": "https://api.github.com/users/daniellevy", "html_url": "https://github.com/daniellevy", "followers_url": "https://api.github.com/users/daniellevy/followers", "following_url": "https://api.github.com/users/daniellevy/following{/other_user}", "gists_url": "https://api.github.com/users/daniellevy/gists{/gist_id}", "starred_url": "https://api.github.com/users/daniellevy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/daniellevy/subscriptions", "organizations_url": "https://api.github.com/users/daniellevy/orgs", "repos_url": "https://api.github.com/users/daniellevy/repos", "events_url": "https://api.github.com/users/daniellevy/events{/privacy}", "received_events_url": "https://api.github.com/users/daniellevy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2017-02-18T07:17:02Z", "updated_at": "2018-06-10T15:47:45Z", "closed_at": "2017-03-03T23:38:23Z", "author_association": "NONE", "body_html": "<p>Hi,</p>\n<p>I am using Tensorflow v0.11 and I have tried on Mac OS X and Centos 6</p>\n<p>I am running into an error when running the following code:</p>\n<pre><code>W = tf.get_variable('W', (5, 3))\n\nx = tf.placeholder(tf.float32, shape=(None, 5))\n\nh = tf.matmul(x, W)\n\ngrads = tf.map_fn(lambda x: tf.gradients(x, W)[0], h)\n</code></pre>\n<p>I basically want to have the following but without a fixed batch size:<br>\n<code>grads = [tf.gradients(h[t], W)[0] for t in range(batch_size)]</code></p>\n<p>My error is:</p>\n<pre><code>Invalid argument: TensorArray map/TensorArray_1@map/while/gradients: Could not write to TensorArray index 3 because it has already been read.\n[...]\ntensorflow.python.framework.errors.InvalidArgumentError: TensorArray map/TensorArray_1@map/while/gradients: Could not write to TensorArray index 3 because it has already been read.\n\t [[Node: map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayWrite = TensorArrayWrite[T=DT_FLOAT, _class=[\"loc:@map/TensorArray\"], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayGrad/TensorArrayGrad, map/while/Identity, map/while/gradients/Fill, map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayGrad/gradient_flow)]]\n</code></pre>\n<p>I have tried the following workaround using <code>scan</code> instead of <code>map_fn</code> with a zero initializer but to no avail:</p>\n<pre><code>initializer = np.zeros((5, 3)).astype('float32')\ngrads = tf.scan(\n\tlambda a, x: tf.gradients(x, W)[0],\n\th,\n\tinitializer)\n</code></pre>\n<p>Is this a know issue?</p>", "body_text": "Hi,\nI am using Tensorflow v0.11 and I have tried on Mac OS X and Centos 6\nI am running into an error when running the following code:\nW = tf.get_variable('W', (5, 3))\n\nx = tf.placeholder(tf.float32, shape=(None, 5))\n\nh = tf.matmul(x, W)\n\ngrads = tf.map_fn(lambda x: tf.gradients(x, W)[0], h)\n\nI basically want to have the following but without a fixed batch size:\ngrads = [tf.gradients(h[t], W)[0] for t in range(batch_size)]\nMy error is:\nInvalid argument: TensorArray map/TensorArray_1@map/while/gradients: Could not write to TensorArray index 3 because it has already been read.\n[...]\ntensorflow.python.framework.errors.InvalidArgumentError: TensorArray map/TensorArray_1@map/while/gradients: Could not write to TensorArray index 3 because it has already been read.\n\t [[Node: map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayWrite = TensorArrayWrite[T=DT_FLOAT, _class=[\"loc:@map/TensorArray\"], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayGrad/TensorArrayGrad, map/while/Identity, map/while/gradients/Fill, map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayGrad/gradient_flow)]]\n\nI have tried the following workaround using scan instead of map_fn with a zero initializer but to no avail:\ninitializer = np.zeros((5, 3)).astype('float32')\ngrads = tf.scan(\n\tlambda a, x: tf.gradients(x, W)[0],\n\th,\n\tinitializer)\n\nIs this a know issue?", "body": "Hi,\r\n\r\nI am using Tensorflow v0.11 and I have tried on Mac OS X and Centos 6\r\n\r\nI am running into an error when running the following code:\r\n\r\n```\r\nW = tf.get_variable('W', (5, 3))\r\n\r\nx = tf.placeholder(tf.float32, shape=(None, 5))\r\n\r\nh = tf.matmul(x, W)\r\n\r\ngrads = tf.map_fn(lambda x: tf.gradients(x, W)[0], h)\r\n```\r\n\r\nI basically want to have the following but without a fixed batch size:\r\n`grads = [tf.gradients(h[t], W)[0] for t in range(batch_size)]`\r\n\r\nMy error is:\r\n\r\n```\r\nInvalid argument: TensorArray map/TensorArray_1@map/while/gradients: Could not write to TensorArray index 3 because it has already been read.\r\n[...]\r\ntensorflow.python.framework.errors.InvalidArgumentError: TensorArray map/TensorArray_1@map/while/gradients: Could not write to TensorArray index 3 because it has already been read.\r\n\t [[Node: map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayWrite = TensorArrayWrite[T=DT_FLOAT, _class=[\"loc:@map/TensorArray\"], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayGrad/TensorArrayGrad, map/while/Identity, map/while/gradients/Fill, map/while/gradients/map/while/TensorArrayRead_grad/TensorArrayGrad/gradient_flow)]]\r\n```\r\n\r\nI have tried the following workaround using `scan` instead of `map_fn` with a zero initializer but to no avail:\r\n```\r\ninitializer = np.zeros((5, 3)).astype('float32')\r\ngrads = tf.scan(\r\n\tlambda a, x: tf.gradients(x, W)[0],\r\n\th,\r\n\tinitializer)\r\n```\r\n\r\nIs this a know issue? "}