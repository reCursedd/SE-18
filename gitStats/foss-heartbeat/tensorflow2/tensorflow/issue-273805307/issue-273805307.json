{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14550", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14550/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14550/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14550/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/14550", "id": 273805307, "node_id": "MDU6SXNzdWUyNzM4MDUzMDc=", "number": 14550, "title": "Log version of the SoftmaxFunctor implementation is numerically unstable", "user": {"login": "akuz", "id": 2409854, "node_id": "MDQ6VXNlcjI0MDk4NTQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/2409854?v=4", "gravatar_id": "", "url": "https://api.github.com/users/akuz", "html_url": "https://github.com/akuz", "followers_url": "https://api.github.com/users/akuz/followers", "following_url": "https://api.github.com/users/akuz/following{/other_user}", "gists_url": "https://api.github.com/users/akuz/gists{/gist_id}", "starred_url": "https://api.github.com/users/akuz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/akuz/subscriptions", "organizations_url": "https://api.github.com/users/akuz/orgs", "repos_url": "https://api.github.com/users/akuz/repos", "events_url": "https://api.github.com/users/akuz/events{/privacy}", "received_events_url": "https://api.github.com/users/akuz/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-11-14T14:10:16Z", "updated_at": "2017-11-14T14:20:17Z", "closed_at": "2017-11-14T14:20:17Z", "author_association": "NONE", "body_html": "<p>The following code in the log version of SoftmaxFunctor, should use reduce_logsumexp() instead of .exp().sum().log()</p>\n<pre><code>    if (log) {\n      // Calculate the log of the softmax\n      // softmax = logits - max(logits along classes);\n      softmax.device(d) = shifted_logits;\n      // softmax = softmax - log(sum(exp(softmax along classes)));\n      softmax.device(d) = (softmax -\n                           softmax.exp()\n                               .sum(along_class)\n                               .eval()\n                               .reshape(batch_by_one)\n                               .log()\n                               .broadcast(one_by_class));\n\n</code></pre>\n<p>Additionally, the following code in the tests only passes without generating NANs because the data is generated using standard normals, never resulting in the values that are too small to be converted to zeroes when exponentiated:</p>\n<pre><code>class LogSoftmaxTest(test_lib.TestCase):\n\n  def _log_softmax(self, x):\n    assert len(x.shape) == 2\n    m = x.max(1)[:, np.newaxis]\n    u = x - m\n    return u - np.log(np.sum(np.exp(u), 1, keepdims=True))\n</code></pre>", "body_text": "The following code in the log version of SoftmaxFunctor, should use reduce_logsumexp() instead of .exp().sum().log()\n    if (log) {\n      // Calculate the log of the softmax\n      // softmax = logits - max(logits along classes);\n      softmax.device(d) = shifted_logits;\n      // softmax = softmax - log(sum(exp(softmax along classes)));\n      softmax.device(d) = (softmax -\n                           softmax.exp()\n                               .sum(along_class)\n                               .eval()\n                               .reshape(batch_by_one)\n                               .log()\n                               .broadcast(one_by_class));\n\n\nAdditionally, the following code in the tests only passes without generating NANs because the data is generated using standard normals, never resulting in the values that are too small to be converted to zeroes when exponentiated:\nclass LogSoftmaxTest(test_lib.TestCase):\n\n  def _log_softmax(self, x):\n    assert len(x.shape) == 2\n    m = x.max(1)[:, np.newaxis]\n    u = x - m\n    return u - np.log(np.sum(np.exp(u), 1, keepdims=True))", "body": "The following code in the log version of SoftmaxFunctor, should use reduce_logsumexp() instead of .exp().sum().log()\r\n\r\n```\r\n    if (log) {\r\n      // Calculate the log of the softmax\r\n      // softmax = logits - max(logits along classes);\r\n      softmax.device(d) = shifted_logits;\r\n      // softmax = softmax - log(sum(exp(softmax along classes)));\r\n      softmax.device(d) = (softmax -\r\n                           softmax.exp()\r\n                               .sum(along_class)\r\n                               .eval()\r\n                               .reshape(batch_by_one)\r\n                               .log()\r\n                               .broadcast(one_by_class));\r\n\r\n```\r\n\r\nAdditionally, the following code in the tests only passes without generating NANs because the data is generated using standard normals, never resulting in the values that are too small to be converted to zeroes when exponentiated:\r\n\r\n```\r\nclass LogSoftmaxTest(test_lib.TestCase):\r\n\r\n  def _log_softmax(self, x):\r\n    assert len(x.shape) == 2\r\n    m = x.max(1)[:, np.newaxis]\r\n    u = x - m\r\n    return u - np.log(np.sum(np.exp(u), 1, keepdims=True))\r\n```"}