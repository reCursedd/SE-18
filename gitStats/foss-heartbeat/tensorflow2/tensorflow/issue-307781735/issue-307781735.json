{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17932", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17932/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17932/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17932/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17932", "id": 307781735, "node_id": "MDU6SXNzdWUzMDc3ODE3MzU=", "number": 17932, "title": "tf.contrib.data.bucket_by_sequence_length fails for nested Dataset element", "user": {"login": "lhlmgr", "id": 400331, "node_id": "MDQ6VXNlcjQwMDMzMQ==", "avatar_url": "https://avatars2.githubusercontent.com/u/400331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lhlmgr", "html_url": "https://github.com/lhlmgr", "followers_url": "https://api.github.com/users/lhlmgr/followers", "following_url": "https://api.github.com/users/lhlmgr/following{/other_user}", "gists_url": "https://api.github.com/users/lhlmgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lhlmgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lhlmgr/subscriptions", "organizations_url": "https://api.github.com/users/lhlmgr/orgs", "repos_url": "https://api.github.com/users/lhlmgr/repos", "events_url": "https://api.github.com/users/lhlmgr/events{/privacy}", "received_events_url": "https://api.github.com/users/lhlmgr/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "rsepassi", "id": 1115739, "node_id": "MDQ6VXNlcjExMTU3Mzk=", "avatar_url": "https://avatars3.githubusercontent.com/u/1115739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsepassi", "html_url": "https://github.com/rsepassi", "followers_url": "https://api.github.com/users/rsepassi/followers", "following_url": "https://api.github.com/users/rsepassi/following{/other_user}", "gists_url": "https://api.github.com/users/rsepassi/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsepassi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsepassi/subscriptions", "organizations_url": "https://api.github.com/users/rsepassi/orgs", "repos_url": "https://api.github.com/users/rsepassi/repos", "events_url": "https://api.github.com/users/rsepassi/events{/privacy}", "received_events_url": "https://api.github.com/users/rsepassi/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rsepassi", "id": 1115739, "node_id": "MDQ6VXNlcjExMTU3Mzk=", "avatar_url": "https://avatars3.githubusercontent.com/u/1115739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsepassi", "html_url": "https://github.com/rsepassi", "followers_url": "https://api.github.com/users/rsepassi/followers", "following_url": "https://api.github.com/users/rsepassi/following{/other_user}", "gists_url": "https://api.github.com/users/rsepassi/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsepassi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsepassi/subscriptions", "organizations_url": "https://api.github.com/users/rsepassi/orgs", "repos_url": "https://api.github.com/users/rsepassi/repos", "events_url": "https://api.github.com/users/rsepassi/events{/privacy}", "received_events_url": "https://api.github.com/users/rsepassi/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2018-03-22T19:22:53Z", "updated_at": "2018-03-26T18:20:41Z", "closed_at": "2018-03-26T18:20:41Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Hello everyone,</p>\n<p>I just tried the new function to group variable length inputs for the dataset API, namely: <code>tf.contrib.data.bucket_by_sequence_length</code>, for a small Estimator-Model.</p>\n<p>I implemented the <code>input_fn</code> such that it returns a dataset, where each element is a tuple <a href=\"https://www.tensorflow.org/get_started/premade_estimators#create_input_functions\" rel=\"nofollow\">(feature-dict, label)</a>. However, when I run it, I get following exception:</p>\n<blockquote>\n<p>Traceback (most recent call last):<br>\n...<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 960, in apply<br>\ndataset = transformation_func(self)<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 198, in _apply_fn<br>\nwindow_size_func=window_size_fn))<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 960, in apply<br>\ndataset = transformation_func(self)<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 90, in _apply_fn<br>\nwindow_size_func)<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 239, in <strong>init</strong><br>\nself._make_key_func(key_func, input_dataset)<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 289, in _make_key_func<br>\nself._key_func.add_to_graph(ops.get_default_graph())<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 488, in add_to_graph<br>\nself._create_definition_if_needed()<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 321, in _create_definition_if_needed<br>\nself._create_definition_if_needed_impl()<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 338, in _create_definition_if_needed_impl<br>\noutputs = self._func(*inputs)<br>\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 279, in tf_key_func<br>\nret = key_func(*nested_args)<br>\nTypeError: element_to_bucket_id() takes 1 positional argument but 2 were given</p>\n</blockquote>\n<p>Here is a <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/data/python/ops/grouping.py#L143\">link</a> to the function.</p>\n<p>Here is a code snipped to reproduce the error:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">input_fn</span>():\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">generator</span>():\n    text <span class=\"pl-k\">=</span> [[<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">3</span>],\n            [<span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">4</span>, <span class=\"pl-c1\">5</span>, <span class=\"pl-c1\">6</span>, <span class=\"pl-c1\">7</span>],\n            [<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>],\n            [<span class=\"pl-c1\">8</span>, <span class=\"pl-c1\">9</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">3</span>]]\n    label <span class=\"pl-k\">=</span> [<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>]\n\n    <span class=\"pl-k\">for</span> x, y <span class=\"pl-k\">in</span> <span class=\"pl-c1\">zip</span>(text, label):\n      <span class=\"pl-k\">yield</span> (x, y)\n\n  dataset <span class=\"pl-k\">=</span> tf.data.Dataset.from_generator(<span class=\"pl-v\">generator</span><span class=\"pl-k\">=</span>generator,\n                                           <span class=\"pl-v\">output_shapes</span><span class=\"pl-k\">=</span>(tf.TensorShape([<span class=\"pl-c1\">None</span>]), tf.TensorShape([])),\n                                           <span class=\"pl-v\">output_types</span><span class=\"pl-k\">=</span>(tf.int32, tf.int32))\n\n  dataset <span class=\"pl-k\">=</span> dataset.map(parse_example)\n  dataset <span class=\"pl-k\">=</span> dataset.apply(tf.contrib.data.bucket_by_sequence_length(<span class=\"pl-v\">element_length_func</span><span class=\"pl-k\">=</span>element_length_fn,\n                                                                    <span class=\"pl-v\">bucket_batch_sizes</span><span class=\"pl-k\">=</span>[<span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>],\n                                                                    <span class=\"pl-v\">bucket_boundaries</span><span class=\"pl-k\">=</span>[<span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">8</span>],\n                                                                    <span class=\"pl-v\">pad_to_bucket_boundary</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>))\n\n  <span class=\"pl-k\">return</span> dataset\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">parse_example</span>(<span class=\"pl-smi\">x</span>, <span class=\"pl-smi\">y</span>):\n  <span class=\"pl-k\">return</span> <span class=\"pl-c1\">dict</span>(\n    <span class=\"pl-v\">x</span><span class=\"pl-k\">=</span>x\n  ), y\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">element_length_fn</span>(<span class=\"pl-smi\">element</span>):\n  features, label <span class=\"pl-k\">=</span> element\n  <span class=\"pl-k\">return</span> tf.shape(features[<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>x<span class=\"pl-pds\">\"</span></span>])[<span class=\"pl-c1\">0</span>]\n\n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">__name__</span> <span class=\"pl-k\">==</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>__main__<span class=\"pl-pds\">'</span></span>:\n  <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    dataset <span class=\"pl-k\">=</span> input_fn()\n    <span class=\"pl-c1\">iter</span> <span class=\"pl-k\">=</span> dataset.make_one_shot_iterator()\n\n    <span class=\"pl-c1\">print</span>(sess.run(<span class=\"pl-c1\">iter</span>.get_next()))</pre></div>\n<p>My Env-Specs are logged in: <a href=\"https://github.com/tensorflow/tensorflow/files/1838947/tf_env.txt\">tf_env.txt</a></p>\n<p>Thanks in advance!</p>", "body_text": "Hello everyone,\nI just tried the new function to group variable length inputs for the dataset API, namely: tf.contrib.data.bucket_by_sequence_length, for a small Estimator-Model.\nI implemented the input_fn such that it returns a dataset, where each element is a tuple (feature-dict, label). However, when I run it, I get following exception:\n\nTraceback (most recent call last):\n...\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 960, in apply\ndataset = transformation_func(self)\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 198, in _apply_fn\nwindow_size_func=window_size_fn))\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 960, in apply\ndataset = transformation_func(self)\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 90, in _apply_fn\nwindow_size_func)\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 239, in init\nself._make_key_func(key_func, input_dataset)\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 289, in _make_key_func\nself._key_func.add_to_graph(ops.get_default_graph())\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 488, in add_to_graph\nself._create_definition_if_needed()\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 321, in _create_definition_if_needed\nself._create_definition_if_needed_impl()\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 338, in _create_definition_if_needed_impl\noutputs = self._func(*inputs)\nFile \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 279, in tf_key_func\nret = key_func(*nested_args)\nTypeError: element_to_bucket_id() takes 1 positional argument but 2 were given\n\nHere is a link to the function.\nHere is a code snipped to reproduce the error:\nimport tensorflow as tf\n\ndef input_fn():\n  def generator():\n    text = [[1, 2, 3],\n            [3, 4, 5, 6, 7],\n            [1, 2],\n            [8, 9, 0, 2, 3]]\n    label = [1, 2, 1, 2]\n\n    for x, y in zip(text, label):\n      yield (x, y)\n\n  dataset = tf.data.Dataset.from_generator(generator=generator,\n                                           output_shapes=(tf.TensorShape([None]), tf.TensorShape([])),\n                                           output_types=(tf.int32, tf.int32))\n\n  dataset = dataset.map(parse_example)\n  dataset = dataset.apply(tf.contrib.data.bucket_by_sequence_length(element_length_func=element_length_fn,\n                                                                    bucket_batch_sizes=[2, 2, 2],\n                                                                    bucket_boundaries=[0, 8],\n                                                                    pad_to_bucket_boundary=False))\n\n  return dataset\n\ndef parse_example(x, y):\n  return dict(\n    x=x\n  ), y\n\ndef element_length_fn(element):\n  features, label = element\n  return tf.shape(features[\"x\"])[0]\n\nif __name__ == '__main__':\n  with tf.Session() as sess:\n    dataset = input_fn()\n    iter = dataset.make_one_shot_iterator()\n\n    print(sess.run(iter.get_next()))\nMy Env-Specs are logged in: tf_env.txt\nThanks in advance!", "body": "Hello everyone,\r\n\r\nI just tried the new function to group variable length inputs for the dataset API, namely: `tf.contrib.data.bucket_by_sequence_length`, for a small Estimator-Model.\r\n\r\nI implemented the `input_fn` such that it returns a dataset, where each element is a tuple [(feature-dict, label)](https://www.tensorflow.org/get_started/premade_estimators#create_input_functions). However, when I run it, I get following exception:\r\n\r\n> Traceback (most recent call last):\r\n> ... \r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 960, in apply\r\n>     dataset = transformation_func(self)\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 198, in _apply_fn\r\n>     window_size_func=window_size_fn))\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 960, in apply\r\n>     dataset = transformation_func(self)\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 90, in _apply_fn\r\n>     window_size_func)\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 239, in __init__\r\n>     self._make_key_func(key_func, input_dataset)\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 289, in _make_key_func\r\n>     self._key_func.add_to_graph(ops.get_default_graph())\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 488, in add_to_graph\r\n>     self._create_definition_if_needed()\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 321, in _create_definition_if_needed\r\n>     self._create_definition_if_needed_impl()\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/function.py\", line 338, in _create_definition_if_needed_impl\r\n>     outputs = self._func(*inputs)\r\n>   File \"/home/leo/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 279, in tf_key_func\r\n>     ret = key_func(*nested_args)\r\n> TypeError: element_to_bucket_id() takes 1 positional argument but 2 were given\r\n\r\nHere is a [link](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/data/python/ops/grouping.py#L143) to the function.\r\n\r\nHere is a code snipped to reproduce the error:\r\n\r\n```python\r\nimport tensorflow as tf\r\n\r\ndef input_fn():\r\n  def generator():\r\n    text = [[1, 2, 3],\r\n            [3, 4, 5, 6, 7],\r\n            [1, 2],\r\n            [8, 9, 0, 2, 3]]\r\n    label = [1, 2, 1, 2]\r\n\r\n    for x, y in zip(text, label):\r\n      yield (x, y)\r\n\r\n  dataset = tf.data.Dataset.from_generator(generator=generator,\r\n                                           output_shapes=(tf.TensorShape([None]), tf.TensorShape([])),\r\n                                           output_types=(tf.int32, tf.int32))\r\n\r\n  dataset = dataset.map(parse_example)\r\n  dataset = dataset.apply(tf.contrib.data.bucket_by_sequence_length(element_length_func=element_length_fn,\r\n                                                                    bucket_batch_sizes=[2, 2, 2],\r\n                                                                    bucket_boundaries=[0, 8],\r\n                                                                    pad_to_bucket_boundary=False))\r\n\r\n  return dataset\r\n\r\ndef parse_example(x, y):\r\n  return dict(\r\n    x=x\r\n  ), y\r\n\r\ndef element_length_fn(element):\r\n  features, label = element\r\n  return tf.shape(features[\"x\"])[0]\r\n\r\nif __name__ == '__main__':\r\n  with tf.Session() as sess:\r\n    dataset = input_fn()\r\n    iter = dataset.make_one_shot_iterator()\r\n\r\n    print(sess.run(iter.get_next()))\r\n```\r\n\r\nMy Env-Specs are logged in: [tf_env.txt](https://github.com/tensorflow/tensorflow/files/1838947/tf_env.txt)\r\n\r\nThanks in advance!"}