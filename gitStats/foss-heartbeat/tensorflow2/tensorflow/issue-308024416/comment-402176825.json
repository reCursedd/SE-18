{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/402176825", "html_url": "https://github.com/tensorflow/tensorflow/issues/17950#issuecomment-402176825", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17950", "id": 402176825, "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjE3NjgyNQ==", "user": {"login": "tanzhenyu", "id": 15220929, "node_id": "MDQ6VXNlcjE1MjIwOTI5", "avatar_url": "https://avatars3.githubusercontent.com/u/15220929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tanzhenyu", "html_url": "https://github.com/tanzhenyu", "followers_url": "https://api.github.com/users/tanzhenyu/followers", "following_url": "https://api.github.com/users/tanzhenyu/following{/other_user}", "gists_url": "https://api.github.com/users/tanzhenyu/gists{/gist_id}", "starred_url": "https://api.github.com/users/tanzhenyu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tanzhenyu/subscriptions", "organizations_url": "https://api.github.com/users/tanzhenyu/orgs", "repos_url": "https://api.github.com/users/tanzhenyu/repos", "events_url": "https://api.github.com/users/tanzhenyu/events{/privacy}", "received_events_url": "https://api.github.com/users/tanzhenyu/received_events", "type": "User", "site_admin": false}, "created_at": "2018-07-03T14:27:40Z", "updated_at": "2018-07-03T14:27:40Z", "author_association": "CONTRIBUTOR", "body_html": "<p>As I investigate more, here's what I think happens:</p>\n<ol>\n<li>without input tensor, keras will create an InputLayer with is_placeholder being True: <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L115\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L115</a></li>\n<li>with input tensor, keras will create an InputLayer with is_placeholder being False:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L119\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L119</a></li>\n<li>in both scenarios when _init_graph_network is called, depending on if is_placeholder being True or False, the model will or will not add the layer inputs into its _feed_inputs list:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/network.py#L307\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/network.py#L307</a></li>\n<li>later when _make_train_function is called to find all training ops and update ops, it will specifically look for conditional updates relevant to the _feed_inputs:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/training.py#L602\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/training.py#L602</a></li>\n</ol>\n<p>And since _feed_inputs is empty, the update ops from batch norm (or any other layer with updates) will be excluded, i.e., moving mean and moving variance in this case will not be updated.</p>", "body_text": "As I investigate more, here's what I think happens:\n\nwithout input tensor, keras will create an InputLayer with is_placeholder being True: https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L115\nwith input tensor, keras will create an InputLayer with is_placeholder being False:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L119\nin both scenarios when _init_graph_network is called, depending on if is_placeholder being True or False, the model will or will not add the layer inputs into its _feed_inputs list:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/network.py#L307\nlater when _make_train_function is called to find all training ops and update ops, it will specifically look for conditional updates relevant to the _feed_inputs:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/training.py#L602\n\nAnd since _feed_inputs is empty, the update ops from batch norm (or any other layer with updates) will be excluded, i.e., moving mean and moving variance in this case will not be updated.", "body": "As I investigate more, here's what I think happens:\r\n1. without input tensor, keras will create an InputLayer with is_placeholder being True: https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L115\r\n2. with input tensor, keras will create an InputLayer with is_placeholder being False:\r\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/input_layer.py#L119\r\n3. in both scenarios when _init_graph_network is called, depending on if is_placeholder being True or False, the model will or will not add the layer inputs into its _feed_inputs list:\r\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/network.py#L307\r\n4. later when _make_train_function is called to find all training ops and update ops, it will specifically look for conditional updates relevant to the _feed_inputs:\r\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/engine/training.py#L602\r\n\r\nAnd since _feed_inputs is empty, the update ops from batch norm (or any other layer with updates) will be excluded, i.e., moving mean and moving variance in this case will not be updated."}