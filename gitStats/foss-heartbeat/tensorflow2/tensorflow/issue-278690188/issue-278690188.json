{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15057", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15057/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15057/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15057/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/15057", "id": 278690188, "node_id": "MDU6SXNzdWUyNzg2OTAxODg=", "number": 15057, "title": "gpu is slower than cpu", "user": {"login": "WenmuZhou", "id": 12406017, "node_id": "MDQ6VXNlcjEyNDA2MDE3", "avatar_url": "https://avatars2.githubusercontent.com/u/12406017?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WenmuZhou", "html_url": "https://github.com/WenmuZhou", "followers_url": "https://api.github.com/users/WenmuZhou/followers", "following_url": "https://api.github.com/users/WenmuZhou/following{/other_user}", "gists_url": "https://api.github.com/users/WenmuZhou/gists{/gist_id}", "starred_url": "https://api.github.com/users/WenmuZhou/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WenmuZhou/subscriptions", "organizations_url": "https://api.github.com/users/WenmuZhou/orgs", "repos_url": "https://api.github.com/users/WenmuZhou/repos", "events_url": "https://api.github.com/users/WenmuZhou/events{/privacy}", "received_events_url": "https://api.github.com/users/WenmuZhou/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 34, "created_at": "2017-12-02T15:01:13Z", "updated_at": "2018-08-11T02:07:19Z", "closed_at": "2018-08-11T02:07:19Z", "author_association": "NONE", "body_html": "<p>Have I written custom code\uff1aNo<br>\nOS Platform and Distribution: win10<br>\nTensorFlow installed from: pip install tensorflow-gpu or pip install tensorflow<br>\nTensorFlow version: 1.4 and 1.3<br>\nBazel version: None<br>\nCUDA/cuDNN version: cuda8.0 and cudnn 6.0<br>\nGPU model and memory: GTX1050 2GB<br>\nExact command to reproduce: no</p>\n<p>I have trained a cnn+lstm mode, and use the model to predict one image, however, I find the GPU is slowly than CPU. I have test the tensorflow-gpu 1.4, tensorflow-gpu 1.3\uff0c tensorflow 1.4 and tensorflow 1.4<br>\nthe code is</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c\"><span class=\"pl-c\">#</span> -*- coding: utf-8 -*-</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> @Time    : 2017/10/26 14:09</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> @Author  : zhoujun</span>\n\n<span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> scipy.misc <span class=\"pl-k\">import</span> imread\n<span class=\"pl-k\">import</span> time\n<span class=\"pl-k\">import</span> os\n\n<span class=\"pl-k\">class</span> <span class=\"pl-en\">PredictionModel</span>:\n    \n    <span class=\"pl-k\">def</span> <span class=\"pl-c1\">__init__</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>, <span class=\"pl-smi\">model_dir</span>, <span class=\"pl-smi\">session</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">None</span>):\n        <span class=\"pl-k\">if</span> session:\n            <span class=\"pl-c1\">self</span>.session <span class=\"pl-k\">=</span> session\n        <span class=\"pl-k\">else</span>:\n            <span class=\"pl-c1\">self</span>.session <span class=\"pl-k\">=</span> tf.get_default_session()\n        start <span class=\"pl-k\">=</span> time.time()\n        <span class=\"pl-c1\">self</span>.model <span class=\"pl-k\">=</span> tf.saved_model.loader.load(<span class=\"pl-c1\">self</span>.session, [<span class=\"pl-s\"><span class=\"pl-pds\">'</span>serve<span class=\"pl-pds\">'</span></span>], model_dir)\n        <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>load_model_time:<span class=\"pl-pds\">'</span></span>, time.time() <span class=\"pl-k\">-</span> start)\n\n        <span class=\"pl-c1\">self</span>._input_dict, <span class=\"pl-c1\">self</span>._output_dict <span class=\"pl-k\">=</span> _signature_def_to_tensors(<span class=\"pl-c1\">self</span>.model.signature_def[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>predictions<span class=\"pl-pds\">'</span></span>])\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">predict</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>, <span class=\"pl-smi\">image</span>):\n        output <span class=\"pl-k\">=</span> <span class=\"pl-c1\">self</span>._output_dict\n        <span class=\"pl-c\"><span class=\"pl-c\">#</span> \u8fd0\u884cpredict  op</span>\n        start <span class=\"pl-k\">=</span> time.time()\n        result <span class=\"pl-k\">=</span> <span class=\"pl-c1\">self</span>.session.run(output, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{<span class=\"pl-c1\">self</span>._input_dict[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>images<span class=\"pl-pds\">'</span></span>]: image})\n        <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>predict_time:<span class=\"pl-pds\">'</span></span>,time.time()<span class=\"pl-k\">-</span>start)\n        <span class=\"pl-k\">return</span> result\n\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">_signature_def_to_tensors</span>(<span class=\"pl-smi\">signature_def</span>):  <span class=\"pl-c\"><span class=\"pl-c\">#</span> from SeguinBe</span>\n    g <span class=\"pl-k\">=</span> tf.get_default_graph()\n    <span class=\"pl-k\">return</span> {k: g.get_tensor_by_name(v.name) <span class=\"pl-k\">for</span> k, v <span class=\"pl-k\">in</span> signature_def.inputs.items()}, \\\n           {k: g.get_tensor_by_name(v.name) <span class=\"pl-k\">for</span> k, v <span class=\"pl-k\">in</span> signature_def.outputs.items()}\n\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">predict</span>(<span class=\"pl-smi\">model_dir</span>, <span class=\"pl-smi\">image</span>,<span class=\"pl-smi\">gpu_id</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>):\n    os.environ[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>CUDA_VISIBLE_DEVICES<span class=\"pl-pds\">'</span></span>] <span class=\"pl-k\">=</span> <span class=\"pl-c1\">str</span>(gpu_id)\n\n    <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n        start <span class=\"pl-k\">=</span> time.time()\n        model <span class=\"pl-k\">=</span> PredictionModel(model_dir,<span class=\"pl-v\">session</span><span class=\"pl-k\">=</span>sess)\n        predictions <span class=\"pl-k\">=</span> model.predict(image)\n        transcription <span class=\"pl-k\">=</span> predictions[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>words<span class=\"pl-pds\">'</span></span>]\n        score <span class=\"pl-k\">=</span> predictions[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>score<span class=\"pl-pds\">'</span></span>]\n        <span class=\"pl-k\">return</span> [transcription[<span class=\"pl-c1\">0</span>].decode(), score, time.time() <span class=\"pl-k\">-</span> start]\n\n\n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">__name__</span> <span class=\"pl-k\">==</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>__main__<span class=\"pl-pds\">'</span></span>:\n    model_dir <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>model/<span class=\"pl-pds\">'</span></span>\n    image <span class=\"pl-k\">=</span> imread(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>3_song.jpg<span class=\"pl-pds\">'</span></span>, <span class=\"pl-v\">mode</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>L<span class=\"pl-pds\">'</span></span>)[:, :, <span class=\"pl-c1\">None</span>]\n    result <span class=\"pl-k\">=</span> predict(model_dir, image,<span class=\"pl-c1\">0</span>)\n    <span class=\"pl-c1\">print</span>(tf.<span class=\"pl-c1\">__version__</span>)\n    <span class=\"pl-c1\">print</span>(result)</pre></div>\n<p>tensorflow-gpu 1.4 log</p>\n<div class=\"highlight highlight-source-shell\"><pre>2017-12-02 22:30:30.147490: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\p</span>latform<span class=\"pl-cce\">\\c</span>pu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2\n2017-12-02 22:30:31.083045: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\c</span>ommon_runtime<span class=\"pl-cce\">\\g</span>pu<span class=\"pl-cce\">\\g</span>pu_device.cc:1030] Found device 0 with properties:\nname: GeForce GTX 1050 major: 6 minor: 1 memoryClockRate(GHz): 1.493\npciBusID: 0000:01:00.0\ntotalMemory: 2.00GiB freeMemory: 1.62GiB\n2017-12-02 22:30:31.083203: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\c</span>ommon_runtime<span class=\"pl-cce\">\\g</span>pu<span class=\"pl-cce\">\\g</span>pu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -<span class=\"pl-k\">&gt;</span> (device: 0, name: GeForce GTX 1050, pci bus id: 0000:01:00.0, compute capability: 6.1)\nload_model_time: 2.9134938716888428\npredict_time: 4.135322570800781\n1.4.0</pre></div>\n<p>tensorflow-gpu 1.3 log</p>\n<div class=\"highlight highlight-source-shell\"><pre>2017-12-02 22:39:46.346092: W C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\p</span>latform<span class=\"pl-cce\">\\c</span>pu_feature_guard.cc:45] The TensorFlow library wasn<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.</span>\n<span class=\"pl-s\">2017-12-02 22:39:46.346191: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn<span class=\"pl-pds\">'</span></span>t compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\n2017-12-02 22:39:47.187559: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\c</span>ommon_runtime<span class=\"pl-cce\">\\g</span>pu<span class=\"pl-cce\">\\g</span>pu_device.cc:955] Found device 0 with properties:\nname: GeForce GTX 1050\nmajor: 6 minor: 1 memoryClockRate (GHz) 1.493\npciBusID 0000:01:00.0\nTotal memory: 2.00GiB\nFree memory: 1.62GiB\n2017-12-02 22:39:47.187717: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\c</span>ommon_runtime<span class=\"pl-cce\">\\g</span>pu<span class=\"pl-cce\">\\g</span>pu_device.cc:976] DMA: 0\n2017-12-02 22:39:47.188099: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\c</span>ommon_runtime<span class=\"pl-cce\">\\g</span>pu<span class=\"pl-cce\">\\g</span>pu_device.cc:986] 0:   Y\n2017-12-02 22:39:47.188224: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows-gpu<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\c</span>ommon_runtime<span class=\"pl-cce\">\\g</span>pu<span class=\"pl-cce\">\\g</span>pu_device.cc:1045] Creating TensorFlow device (/gpu:0) -<span class=\"pl-k\">&gt;</span> (device: 0, name: GeForce GTX 1050, pci bus id: 0000:01:00.0)\nload_model_time: 2.595602512359619\npredict_time: 1.6665771007537842\n1.3.0</pre></div>\n<p>tensorflow 1.4 log</p>\n<div class=\"highlight highlight-source-shell\"><pre>2017-12-02 22:47:21.368827: I C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\p</span>latform<span class=\"pl-cce\">\\c</span>pu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2\nload_model_time: 2.340376853942871\npredict_time: 3.538094997406006\n1.4.0</pre></div>\n<p>tensorflow 1.3 log</p>\n<div class=\"highlight highlight-source-shell\"><pre>2017-12-02 22:51:33.877932: W C:<span class=\"pl-cce\">\\t</span>f_jenkins<span class=\"pl-cce\">\\h</span>ome<span class=\"pl-cce\">\\w</span>orkspace<span class=\"pl-cce\">\\r</span>el-win<span class=\"pl-cce\">\\M\\w</span>indows<span class=\"pl-cce\">\\P</span>Y<span class=\"pl-cce\">\\3</span>6<span class=\"pl-cce\">\\t</span>ensorflow<span class=\"pl-cce\">\\c</span>ore<span class=\"pl-cce\">\\p</span>latform<span class=\"pl-cce\">\\c</span>pu_feature_guard.cc:45] The TensorFlow library wasn<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.</span>\n<span class=\"pl-s\">2017-12-02 22:51:33.878031: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn<span class=\"pl-pds\">'</span></span>t compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\nload_model_time: 2.2079925537109375\npredict_time: 0.5485155582427979\n1.3.0</pre></div>\n<p>As can be seen from the log, tensorflow1.4 slower than 1.3 <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"277394871\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/14942\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/14942/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/14942\">#14942</a>, and gpu mode slower than cpu. If needed, I can provide models and test images</p>", "body_text": "Have I written custom code\uff1aNo\nOS Platform and Distribution: win10\nTensorFlow installed from: pip install tensorflow-gpu or pip install tensorflow\nTensorFlow version: 1.4 and 1.3\nBazel version: None\nCUDA/cuDNN version: cuda8.0 and cudnn 6.0\nGPU model and memory: GTX1050 2GB\nExact command to reproduce: no\nI have trained a cnn+lstm mode, and use the model to predict one image, however, I find the GPU is slowly than CPU. I have test the tensorflow-gpu 1.4, tensorflow-gpu 1.3\uff0c tensorflow 1.4 and tensorflow 1.4\nthe code is\n# -*- coding: utf-8 -*-\n# @Time    : 2017/10/26 14:09\n# @Author  : zhoujun\n\nimport tensorflow as tf\nfrom scipy.misc import imread\nimport time\nimport os\n\nclass PredictionModel:\n    \n    def __init__(self, model_dir, session=None):\n        if session:\n            self.session = session\n        else:\n            self.session = tf.get_default_session()\n        start = time.time()\n        self.model = tf.saved_model.loader.load(self.session, ['serve'], model_dir)\n        print('load_model_time:', time.time() - start)\n\n        self._input_dict, self._output_dict = _signature_def_to_tensors(self.model.signature_def['predictions'])\n\n    def predict(self, image):\n        output = self._output_dict\n        # \u8fd0\u884cpredict  op\n        start = time.time()\n        result = self.session.run(output, feed_dict={self._input_dict['images']: image})\n        print('predict_time:',time.time()-start)\n        return result\n\n\ndef _signature_def_to_tensors(signature_def):  # from SeguinBe\n    g = tf.get_default_graph()\n    return {k: g.get_tensor_by_name(v.name) for k, v in signature_def.inputs.items()}, \\\n           {k: g.get_tensor_by_name(v.name) for k, v in signature_def.outputs.items()}\n\n\ndef predict(model_dir, image,gpu_id = 0):\n    os.environ['CUDA_VISIBLE_DEVICES'] = str(gpu_id)\n\n    with tf.Session() as sess:\n        start = time.time()\n        model = PredictionModel(model_dir,session=sess)\n        predictions = model.predict(image)\n        transcription = predictions['words']\n        score = predictions['score']\n        return [transcription[0].decode(), score, time.time() - start]\n\n\nif __name__ == '__main__':\n    model_dir = 'model/'\n    image = imread('3_song.jpg', mode='L')[:, :, None]\n    result = predict(model_dir, image,0)\n    print(tf.__version__)\n    print(result)\ntensorflow-gpu 1.4 log\n2017-12-02 22:30:30.147490: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2\n2017-12-02 22:30:31.083045: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1030] Found device 0 with properties:\nname: GeForce GTX 1050 major: 6 minor: 1 memoryClockRate(GHz): 1.493\npciBusID: 0000:01:00.0\ntotalMemory: 2.00GiB freeMemory: 1.62GiB\n2017-12-02 22:30:31.083203: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -> (device: 0, name: GeForce GTX 1050, pci bus id: 0000:01:00.0, compute capability: 6.1)\nload_model_time: 2.9134938716888428\npredict_time: 4.135322570800781\n1.4.0\ntensorflow-gpu 1.3 log\n2017-12-02 22:39:46.346092: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\n2017-12-02 22:39:46.346191: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\n2017-12-02 22:39:47.187559: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:955] Found device 0 with properties:\nname: GeForce GTX 1050\nmajor: 6 minor: 1 memoryClockRate (GHz) 1.493\npciBusID 0000:01:00.0\nTotal memory: 2.00GiB\nFree memory: 1.62GiB\n2017-12-02 22:39:47.187717: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:976] DMA: 0\n2017-12-02 22:39:47.188099: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:986] 0:   Y\n2017-12-02 22:39:47.188224: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1045] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 1050, pci bus id: 0000:01:00.0)\nload_model_time: 2.595602512359619\npredict_time: 1.6665771007537842\n1.3.0\ntensorflow 1.4 log\n2017-12-02 22:47:21.368827: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2\nload_model_time: 2.340376853942871\npredict_time: 3.538094997406006\n1.4.0\ntensorflow 1.3 log\n2017-12-02 22:51:33.877932: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\n2017-12-02 22:51:33.878031: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\nload_model_time: 2.2079925537109375\npredict_time: 0.5485155582427979\n1.3.0\nAs can be seen from the log, tensorflow1.4 slower than 1.3 #14942, and gpu mode slower than cpu. If needed, I can provide models and test images", "body": "Have I written custom code\uff1aNo\r\nOS Platform and Distribution: win10\r\nTensorFlow installed from: pip install tensorflow-gpu or pip install tensorflow\r\nTensorFlow version: 1.4 and 1.3\r\nBazel version: None\r\nCUDA/cuDNN version: cuda8.0 and cudnn 6.0\r\nGPU model and memory: GTX1050 2GB\r\nExact command to reproduce: no\r\n\r\nI have trained a cnn+lstm mode, and use the model to predict one image, however, I find the GPU is slowly than CPU. I have test the tensorflow-gpu 1.4, tensorflow-gpu 1.3\uff0c tensorflow 1.4 and tensorflow 1.4\r\nthe code is \r\n```python\r\n# -*- coding: utf-8 -*-\r\n# @Time    : 2017/10/26 14:09\r\n# @Author  : zhoujun\r\n\r\nimport tensorflow as tf\r\nfrom scipy.misc import imread\r\nimport time\r\nimport os\r\n\r\nclass PredictionModel:\r\n    \r\n    def __init__(self, model_dir, session=None):\r\n        if session:\r\n            self.session = session\r\n        else:\r\n            self.session = tf.get_default_session()\r\n        start = time.time()\r\n        self.model = tf.saved_model.loader.load(self.session, ['serve'], model_dir)\r\n        print('load_model_time:', time.time() - start)\r\n\r\n        self._input_dict, self._output_dict = _signature_def_to_tensors(self.model.signature_def['predictions'])\r\n\r\n    def predict(self, image):\r\n        output = self._output_dict\r\n        # \u8fd0\u884cpredict  op\r\n        start = time.time()\r\n        result = self.session.run(output, feed_dict={self._input_dict['images']: image})\r\n        print('predict_time:',time.time()-start)\r\n        return result\r\n\r\n\r\ndef _signature_def_to_tensors(signature_def):  # from SeguinBe\r\n    g = tf.get_default_graph()\r\n    return {k: g.get_tensor_by_name(v.name) for k, v in signature_def.inputs.items()}, \\\r\n           {k: g.get_tensor_by_name(v.name) for k, v in signature_def.outputs.items()}\r\n\r\n\r\ndef predict(model_dir, image,gpu_id = 0):\r\n    os.environ['CUDA_VISIBLE_DEVICES'] = str(gpu_id)\r\n\r\n    with tf.Session() as sess:\r\n        start = time.time()\r\n        model = PredictionModel(model_dir,session=sess)\r\n        predictions = model.predict(image)\r\n        transcription = predictions['words']\r\n        score = predictions['score']\r\n        return [transcription[0].decode(), score, time.time() - start]\r\n\r\n\r\nif __name__ == '__main__':\r\n    model_dir = 'model/'\r\n    image = imread('3_song.jpg', mode='L')[:, :, None]\r\n    result = predict(model_dir, image,0)\r\n    print(tf.__version__)\r\n    print(result)\r\n```\r\ntensorflow-gpu 1.4 log\r\n```sh\r\n2017-12-02 22:30:30.147490: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2\r\n2017-12-02 22:30:31.083045: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1030] Found device 0 with properties:\r\nname: GeForce GTX 1050 major: 6 minor: 1 memoryClockRate(GHz): 1.493\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 2.00GiB freeMemory: 1.62GiB\r\n2017-12-02 22:30:31.083203: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -> (device: 0, name: GeForce GTX 1050, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nload_model_time: 2.9134938716888428\r\npredict_time: 4.135322570800781\r\n1.4.0\r\n```\r\ntensorflow-gpu 1.3 log\r\n```sh\r\n2017-12-02 22:39:46.346092: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-12-02 22:39:46.346191: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-12-02 22:39:47.187559: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:955] Found device 0 with properties:\r\nname: GeForce GTX 1050\r\nmajor: 6 minor: 1 memoryClockRate (GHz) 1.493\r\npciBusID 0000:01:00.0\r\nTotal memory: 2.00GiB\r\nFree memory: 1.62GiB\r\n2017-12-02 22:39:47.187717: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:976] DMA: 0\r\n2017-12-02 22:39:47.188099: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:986] 0:   Y\r\n2017-12-02 22:39:47.188224: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1045] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 1050, pci bus id: 0000:01:00.0)\r\nload_model_time: 2.595602512359619\r\npredict_time: 1.6665771007537842\r\n1.3.0\r\n```\r\ntensorflow 1.4 log\r\n```sh\r\n2017-12-02 22:47:21.368827: I C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2\r\nload_model_time: 2.340376853942871\r\npredict_time: 3.538094997406006\r\n1.4.0\r\n```\r\ntensorflow 1.3 log\r\n```sh\r\n2017-12-02 22:51:33.877932: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX instructions, but these are available on your machine and could speed up CPU computations.\r\n2017-12-02 22:51:33.878031: W C:\\tf_jenkins\\home\\workspace\\rel-win\\M\\windows\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:45] The TensorFlow library wasn't compiled to use AVX2 instructions, but these are available on your machine and could speed up CPU computations.\r\nload_model_time: 2.2079925537109375\r\npredict_time: 0.5485155582427979\r\n1.3.0\r\n```\r\nAs can be seen from the log, tensorflow1.4 slower than 1.3 #14942, and gpu mode slower than cpu. If needed, I can provide models and test images"}