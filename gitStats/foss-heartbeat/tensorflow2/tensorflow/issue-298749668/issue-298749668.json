{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17159", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17159/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17159/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17159/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17159", "id": 298749668, "node_id": "MDU6SXNzdWUyOTg3NDk2Njg=", "number": 17159, "title": "Estimator WarmStartSettings Cause Extreme Training Slowdown.", "user": {"login": "dacox", "id": 3887682, "node_id": "MDQ6VXNlcjM4ODc2ODI=", "avatar_url": "https://avatars0.githubusercontent.com/u/3887682?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dacox", "html_url": "https://github.com/dacox", "followers_url": "https://api.github.com/users/dacox/followers", "following_url": "https://api.github.com/users/dacox/following{/other_user}", "gists_url": "https://api.github.com/users/dacox/gists{/gist_id}", "starred_url": "https://api.github.com/users/dacox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dacox/subscriptions", "organizations_url": "https://api.github.com/users/dacox/orgs", "repos_url": "https://api.github.com/users/dacox/repos", "events_url": "https://api.github.com/users/dacox/events{/privacy}", "received_events_url": "https://api.github.com/users/dacox/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2018-02-20T21:10:44Z", "updated_at": "2018-03-01T20:53:19Z", "closed_at": "2018-03-01T20:53:19Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary(official docker image)</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.6.0-rc1</li>\n<li><strong>Python version</strong>: 2.7.12</li>\n<li><strong>Bazel version (if compiling from source)</strong>: None</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: None</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0 / 7.0.5.15-1</li>\n<li><strong>GPU model and memory</strong>: GeForce GTX 1060 6GB</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<div class=\"highlight highlight-source-python\"><pre>warm_start_from <span class=\"pl-k\">=</span> <span class=\"pl-c1\">None</span> \n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">FLAGS</span>.warm_start:\n    warm_start_from <span class=\"pl-k\">=</span> tf.estimator.WarmStartSettings(\n        <span class=\"pl-v\">ckpt_to_initialize_from</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">FLAGS</span>.warm_start,\n        <span class=\"pl-c\"><span class=\"pl-c\">#</span> <span class=\"pl-k\">NOTE</span>: attempted with and without `vars_to_warm_start` set</span>\n        <span class=\"pl-c\"><span class=\"pl-c\">#</span> vars_to_warm_start='^(?!.*(RMSProp|global_step))'</span>\n    )\n\nmy_model <span class=\"pl-k\">=</span> tf.estimator.Estimator(\n    <span class=\"pl-v\">model_fn</span><span class=\"pl-k\">=</span>my_model_fn,\n    <span class=\"pl-v\">model_dir</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">FLAGS</span>.model,\n    <span class=\"pl-v\">warm_start_from</span><span class=\"pl-k\">=</span>warm_start_from\n)</pre></div>\n<h3>Describe the problem</h3>\n<p>I am attempting to fine tune a model trained with RMSProp. I only want to load the model weights from the checkpoint, not the RMSProp state. To achieve this, I am using Tensorflow 1.6-rc1's <code>WarmStartSettings</code>.</p>\n<p>When I train the model without <code>WarmStartSettings</code>, each minibatch takes around 0.5 seconds. However, when I attempt to use that checkpoint with <code>WarmStartSettings</code>, each minibatch takes around 1.7 seconds.</p>\n<p>Having inspected the logs to make sure the weights are not being initialised for every batch, It seems like this is a bug in Tensorflow. It should also be noted that I experienced similar problems in Tensorflow 1.5 when using <code>init_from_checkpoint</code> in my <code>model_fn</code> (as seen in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"230989163\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/10155\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/10155/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/10155\">#10155</a>, which led me to discover the <code>WarmStartSettings</code> API).</p>\n<h3>Source code / logs</h3>\n<h4>Without WarmStartSettings (train for one epoch)</h4>\n<div class=\"highlight highlight-source-shell\"><pre>/usr/local/lib/python2.7/dist-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from <span class=\"pl-s\"><span class=\"pl-pds\">`</span>float<span class=\"pl-pds\">`</span></span> to <span class=\"pl-s\"><span class=\"pl-pds\">`</span>np.floating<span class=\"pl-pds\">`</span></span> is deprecated. In future, it will be treated as <span class=\"pl-s\"><span class=\"pl-pds\">`</span>np.float64 == np.dtype(float).type<span class=\"pl-pds\">`</span></span>.\n  from ._conv import register_converters as _register_converters\nTrain data shape...\n(30000, 500)\n(30000, 2048)\nEval data shape...\n(5000, 500)\n(5000, 2048)\nTest data shape...\n(5000, 500)\n(5000, 2048)\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {<span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_secs<span class=\"pl-pds\">'</span></span>: 600, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_session_config<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_max<span class=\"pl-pds\">'</span></span>: 5, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_type<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>worker<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_global_id_in_cluster<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_is_chief<span class=\"pl-pds\">'</span></span>: True, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_cluster_spec<span class=\"pl-pds\">'</span></span>: <span class=\"pl-k\">&lt;</span>tensorflow.python.training.server_lib.ClusterSpec object at 0x7f6243687f<span class=\"pl-k\">90&gt;</span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_evaluation_master<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_steps<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_every_n_hours<span class=\"pl-pds\">'</span></span>: 10000, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_service<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_ps_replicas<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_tf_random_seed<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_master<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_worker_replicas<span class=\"pl-pds\">'</span></span>: 1, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_id<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_log_step_count_steps<span class=\"pl-pds\">'</span></span>: 100, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_model_dir<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>output/my_model<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_summary_steps<span class=\"pl-pds\">'</span></span>: 100}\nTraining Epoch <span class=\"pl-c\"><span class=\"pl-c\">#</span>1...</span>\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:08.668914: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-02-20 20:31:08.767997: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node <span class=\"pl-c1\">read</span> from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-02-20 20:31:08.768353: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1212] Found device 0 with properties: \nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7085\npciBusID: 0000:01:00.0\ntotalMemory: 5.93GiB freeMemory: 3.84GiB\n2018-02-20 20:31:08.768368: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:08.919155: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3579 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints <span class=\"pl-k\">for</span> 1 into output/my_model/model.ckpt.\nINFO:tensorflow:loss = 0.43950942, step = 1\nINFO:tensorflow:global_step/sec: 196.162\nINFO:tensorflow:loss = 0.46729112, step = 101 (0.510 sec)\nINFO:tensorflow:global_step/sec: 205.419\nINFO:tensorflow:loss = 0.35870957, step = 201 (0.487 sec)\nINFO:tensorflow:global_step/sec: 206.952\nINFO:tensorflow:loss = 0.32010338, step = 301 (0.483 sec)\nINFO:tensorflow:global_step/sec: 204.129\nINFO:tensorflow:loss = 0.3345171, step = 401 (0.490 sec)\nINFO:tensorflow:global_step/sec: 209.188\nINFO:tensorflow:loss = 0.34134513, step = 501 (0.478 sec)\nINFO:tensorflow:global_step/sec: 205.325\nINFO:tensorflow:loss = 0.33101806, step = 601 (0.487 sec)\nINFO:tensorflow:global_step/sec: 207.222\nINFO:tensorflow:loss = 0.34841973, step = 701 (0.483 sec)\nINFO:tensorflow:global_step/sec: 206.455\nINFO:tensorflow:loss = 0.33363524, step = 801 (0.484 sec)\nINFO:tensorflow:global_step/sec: 208.705\nINFO:tensorflow:loss = 0.33115995, step = 901 (0.479 sec)\nINFO:tensorflow:global_step/sec: 205.786\nINFO:tensorflow:loss = 0.32718512, step = 1001 (0.486 sec)\nINFO:tensorflow:global_step/sec: 205.812\nINFO:tensorflow:loss = 0.33765212, step = 1101 (0.486 sec)\nINFO:tensorflow:global_step/sec: 205.522\nINFO:tensorflow:loss = 0.33326942, step = 1201 (0.487 sec)\nINFO:tensorflow:global_step/sec: 208.248\nINFO:tensorflow:loss = 0.34017226, step = 1301 (0.480 sec)\nINFO:tensorflow:global_step/sec: 205.824\nINFO:tensorflow:loss = 0.32448825, step = 1401 (0.486 sec)\nINFO:tensorflow:Saving checkpoints <span class=\"pl-k\">for</span> 1500 into output/my_model/model.ckpt.\nINFO:tensorflow:Loss <span class=\"pl-k\">for</span> final step: 0.30791047.\nEvaluating Epoch <span class=\"pl-c\"><span class=\"pl-c\">#</span>5...</span>\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-02-20-20:31:17\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:17.344022: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:17.344148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Finished evaluation at 2018-02-20-20:31:17\nINFO:tensorflow:Saving dict <span class=\"pl-k\">for</span> global step 1500: global_step = 1500, loss = 0.32683796\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:17.575632: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:17.575748: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nWARNING:tensorflow:From scripts/my_model.py:85: calling l2_normalize (from tensorflow.python.ops.nn_impl) with dim is deprecated and will be removed <span class=\"pl-k\">in</span> a future version.\nInstructions <span class=\"pl-k\">for</span> updating:\ndim is deprecated, use axis instead\n2018-02-20 20:31:17.738903: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:17.739028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nR@1: 1.2\nR@5: 2.9\nR@10: 4.7</pre></div>\n<h4>With WarmStartSettings</h4>\n<div class=\"highlight highlight-source-shell\"><pre>/usr/local/lib/python2.7/dist-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from <span class=\"pl-s\"><span class=\"pl-pds\">`</span>float<span class=\"pl-pds\">`</span></span> to <span class=\"pl-s\"><span class=\"pl-pds\">`</span>np.floating<span class=\"pl-pds\">`</span></span> is deprecated. In future, it will be treated as <span class=\"pl-s\"><span class=\"pl-pds\">`</span>np.float64 == np.dtype(float).type<span class=\"pl-pds\">`</span></span>.\n  from ._conv import register_converters as _register_converters\nTrain data shape...\n(30000, 500)\n(30000, 2048)\nEval data shape...\n(5000, 500)\n(5000, 2048)\nTest data shape...\n(5000, 500)\n(5000, 2048)\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {<span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_secs<span class=\"pl-pds\">'</span></span>: 600, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_session_config<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_max<span class=\"pl-pds\">'</span></span>: 5, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_type<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>worker<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_global_id_in_cluster<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_is_chief<span class=\"pl-pds\">'</span></span>: True, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_cluster_spec<span class=\"pl-pds\">'</span></span>: <span class=\"pl-k\">&lt;</span>tensorflow.python.training.server_lib.ClusterSpec object at 0x7fccf90c7f<span class=\"pl-k\">90&gt;</span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_evaluation_master<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_steps<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_every_n_hours<span class=\"pl-pds\">'</span></span>: 10000, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_service<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_ps_replicas<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_tf_random_seed<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_master<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_worker_replicas<span class=\"pl-pds\">'</span></span>: 1, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_id<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_log_step_count_steps<span class=\"pl-pds\">'</span></span>: 100, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_model_dir<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>output/my_model<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_summary_steps<span class=\"pl-pds\">'</span></span>: 100}\nTraining Epoch <span class=\"pl-c\"><span class=\"pl-c\">#</span>1...</span>\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Warm-starting with WarmStartSettings: WarmStartSettings(ckpt_to_initialize_from=<span class=\"pl-s\"><span class=\"pl-pds\">'</span>output/checkpoint/<span class=\"pl-pds\">'</span></span>, vars_to_warm_start=<span class=\"pl-s\"><span class=\"pl-pds\">'</span>^(?!.*(RMSProp|global_step))<span class=\"pl-pds\">'</span></span>, var_name_to_vocab_info={}, var_name_to_prev_var_name={})\nINFO:tensorflow:Warm-starting from: (<span class=\"pl-s\"><span class=\"pl-pds\">'</span>output/checkpoint/<span class=\"pl-pds\">'</span></span>,)\nINFO:tensorflow:Warm-starting variable: my_model/dense_3/kernel<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_3/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_3/kernel\nINFO:tensorflow:Warm-starting variable: my_model/dense_3/bias<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_3/bias:0 from checkpoint output/checkpoint/ with my_model/dense_3/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense_2/bias<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_2/bias:0 from checkpoint output/checkpoint/ with my_model/dense_2/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense_1/kernel<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_1/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_1/kernel\nINFO:tensorflow:Warm-starting variable: my_model/dense_1/bias<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_1/bias:0 from checkpoint output/checkpoint/ with my_model/dense_1/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense/kernel<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense/kernel:0 from checkpoint output/checkpoint/ with my_model/dense/kernel\nINFO:tensorflow:Warm-starting variable: my_model/dense/bias<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense/bias:0 from checkpoint output/checkpoint/ with my_model/dense/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense_2/kernel<span class=\"pl-k\">;</span> prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_2/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_2/kernel\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:44.926116: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-02-20 20:31:45.024835: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node <span class=\"pl-c1\">read</span> from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-02-20 20:31:45.025212: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1212] Found device 0 with properties: \nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7085\npciBusID: 0000:01:00.0\ntotalMemory: 5.93GiB freeMemory: 3.84GiB\n2018-02-20 20:31:45.025242: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:45.174051: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3579 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints <span class=\"pl-k\">for</span> 1 into output/my_model/model.ckpt.\nINFO:tensorflow:loss = 0.32987013, step = 1\nINFO:tensorflow:global_step/sec: 56.8537\nINFO:tensorflow:loss = 0.3100884, step = 101 (1.759 sec)\nINFO:tensorflow:global_step/sec: 57.4584\nINFO:tensorflow:loss = 0.32932568, step = 201 (1.740 sec)\nINFO:tensorflow:global_step/sec: 58.9717\nINFO:tensorflow:loss = 0.30233204, step = 301 (1.696 sec)\nINFO:tensorflow:global_step/sec: 57.5253\nINFO:tensorflow:loss = 0.3428804, step = 401 (1.738 sec)\nINFO:tensorflow:global_step/sec: 57.8845\nINFO:tensorflow:loss = 0.331369, step = 501 (1.728 sec)\nINFO:tensorflow:global_step/sec: 58.2558\nINFO:tensorflow:loss = 0.3059027, step = 601 (1.717 sec)\nINFO:tensorflow:global_step/sec: 58.3863\nINFO:tensorflow:loss = 0.32942265, step = 701 (1.713 sec)\nINFO:tensorflow:global_step/sec: 58.454\nINFO:tensorflow:loss = 0.31594634, step = 801 (1.711 sec)\nINFO:tensorflow:global_step/sec: 58.8543\nINFO:tensorflow:loss = 0.31210855, step = 901 (1.699 sec)\nINFO:tensorflow:global_step/sec: 58.7531\nINFO:tensorflow:loss = 0.33128193, step = 1001 (1.702 sec)\nINFO:tensorflow:global_step/sec: 57.5272\nINFO:tensorflow:loss = 0.31882855, step = 1101 (1.739 sec)\nINFO:tensorflow:global_step/sec: 58.2324\nINFO:tensorflow:loss = 0.32009652, step = 1201 (1.717 sec)\nINFO:tensorflow:global_step/sec: 58.8266\nINFO:tensorflow:loss = 0.31766868, step = 1301 (1.700 sec)\nINFO:tensorflow:global_step/sec: 57.1415\nINFO:tensorflow:loss = 0.304159, step = 1401 (1.750 sec)\nINFO:tensorflow:Saving checkpoints <span class=\"pl-k\">for</span> 1500 into output/my_model/model.ckpt.\nINFO:tensorflow:Loss <span class=\"pl-k\">for</span> final step: 0.30592433.\nEvaluating Epoch <span class=\"pl-c\"><span class=\"pl-c\">#</span>5...</span>\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-02-20-20:32:12\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:32:12.146704: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:32:12.146840: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Finished evaluation at 2018-02-20-20:32:12\nINFO:tensorflow:Saving dict <span class=\"pl-k\">for</span> global step 1500: global_step = 1500, loss = 0.32321918\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:32:12.352526: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:32:12.352642: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nWARNING:tensorflow:From scripts/my_model.py:85: calling l2_normalize (from tensorflow.python.ops.nn_impl) with dim is deprecated and will be removed <span class=\"pl-k\">in</span> a future version.\nInstructions <span class=\"pl-k\">for</span> updating:\ndim is deprecated, use axis instead\n2018-02-20 20:32:12.522432: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:32:12.522561: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -<span class=\"pl-k\">&gt;</span> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nR@1: 1.7\nR@5: 4.3\nR@10: 7.4</pre></div>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\nTensorFlow installed from (source or binary): binary(official docker image)\nTensorFlow version (use command below): 1.6.0-rc1\nPython version: 2.7.12\nBazel version (if compiling from source): None\nGCC/Compiler version (if compiling from source): None\nCUDA/cuDNN version: 9.0 / 7.0.5.15-1\nGPU model and memory: GeForce GTX 1060 6GB\nExact command to reproduce:\n\nwarm_start_from = None \nif FLAGS.warm_start:\n    warm_start_from = tf.estimator.WarmStartSettings(\n        ckpt_to_initialize_from=FLAGS.warm_start,\n        # NOTE: attempted with and without `vars_to_warm_start` set\n        # vars_to_warm_start='^(?!.*(RMSProp|global_step))'\n    )\n\nmy_model = tf.estimator.Estimator(\n    model_fn=my_model_fn,\n    model_dir=FLAGS.model,\n    warm_start_from=warm_start_from\n)\nDescribe the problem\nI am attempting to fine tune a model trained with RMSProp. I only want to load the model weights from the checkpoint, not the RMSProp state. To achieve this, I am using Tensorflow 1.6-rc1's WarmStartSettings.\nWhen I train the model without WarmStartSettings, each minibatch takes around 0.5 seconds. However, when I attempt to use that checkpoint with WarmStartSettings, each minibatch takes around 1.7 seconds.\nHaving inspected the logs to make sure the weights are not being initialised for every batch, It seems like this is a bug in Tensorflow. It should also be noted that I experienced similar problems in Tensorflow 1.5 when using init_from_checkpoint in my model_fn (as seen in #10155, which led me to discover the WarmStartSettings API).\nSource code / logs\nWithout WarmStartSettings (train for one epoch)\n/usr/local/lib/python2.7/dist-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n  from ._conv import register_converters as _register_converters\nTrain data shape...\n(30000, 500)\n(30000, 2048)\nEval data shape...\n(5000, 500)\n(5000, 2048)\nTest data shape...\n(5000, 500)\n(5000, 2048)\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f6243687f90>, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': 'output/my_model', '_save_summary_steps': 100}\nTraining Epoch #1...\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:08.668914: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-02-20 20:31:08.767997: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-02-20 20:31:08.768353: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1212] Found device 0 with properties: \nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7085\npciBusID: 0000:01:00.0\ntotalMemory: 5.93GiB freeMemory: 3.84GiB\n2018-02-20 20:31:08.768368: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:08.919155: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3579 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 1 into output/my_model/model.ckpt.\nINFO:tensorflow:loss = 0.43950942, step = 1\nINFO:tensorflow:global_step/sec: 196.162\nINFO:tensorflow:loss = 0.46729112, step = 101 (0.510 sec)\nINFO:tensorflow:global_step/sec: 205.419\nINFO:tensorflow:loss = 0.35870957, step = 201 (0.487 sec)\nINFO:tensorflow:global_step/sec: 206.952\nINFO:tensorflow:loss = 0.32010338, step = 301 (0.483 sec)\nINFO:tensorflow:global_step/sec: 204.129\nINFO:tensorflow:loss = 0.3345171, step = 401 (0.490 sec)\nINFO:tensorflow:global_step/sec: 209.188\nINFO:tensorflow:loss = 0.34134513, step = 501 (0.478 sec)\nINFO:tensorflow:global_step/sec: 205.325\nINFO:tensorflow:loss = 0.33101806, step = 601 (0.487 sec)\nINFO:tensorflow:global_step/sec: 207.222\nINFO:tensorflow:loss = 0.34841973, step = 701 (0.483 sec)\nINFO:tensorflow:global_step/sec: 206.455\nINFO:tensorflow:loss = 0.33363524, step = 801 (0.484 sec)\nINFO:tensorflow:global_step/sec: 208.705\nINFO:tensorflow:loss = 0.33115995, step = 901 (0.479 sec)\nINFO:tensorflow:global_step/sec: 205.786\nINFO:tensorflow:loss = 0.32718512, step = 1001 (0.486 sec)\nINFO:tensorflow:global_step/sec: 205.812\nINFO:tensorflow:loss = 0.33765212, step = 1101 (0.486 sec)\nINFO:tensorflow:global_step/sec: 205.522\nINFO:tensorflow:loss = 0.33326942, step = 1201 (0.487 sec)\nINFO:tensorflow:global_step/sec: 208.248\nINFO:tensorflow:loss = 0.34017226, step = 1301 (0.480 sec)\nINFO:tensorflow:global_step/sec: 205.824\nINFO:tensorflow:loss = 0.32448825, step = 1401 (0.486 sec)\nINFO:tensorflow:Saving checkpoints for 1500 into output/my_model/model.ckpt.\nINFO:tensorflow:Loss for final step: 0.30791047.\nEvaluating Epoch #5...\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-02-20-20:31:17\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:17.344022: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:17.344148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Finished evaluation at 2018-02-20-20:31:17\nINFO:tensorflow:Saving dict for global step 1500: global_step = 1500, loss = 0.32683796\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:17.575632: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:17.575748: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nWARNING:tensorflow:From scripts/my_model.py:85: calling l2_normalize (from tensorflow.python.ops.nn_impl) with dim is deprecated and will be removed in a future version.\nInstructions for updating:\ndim is deprecated, use axis instead\n2018-02-20 20:31:17.738903: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:17.739028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nR@1: 1.2\nR@5: 2.9\nR@10: 4.7\nWith WarmStartSettings\n/usr/local/lib/python2.7/dist-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n  from ._conv import register_converters as _register_converters\nTrain data shape...\n(30000, 500)\n(30000, 2048)\nEval data shape...\n(5000, 500)\n(5000, 2048)\nTest data shape...\n(5000, 500)\n(5000, 2048)\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7fccf90c7f90>, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': 'output/my_model', '_save_summary_steps': 100}\nTraining Epoch #1...\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Warm-starting with WarmStartSettings: WarmStartSettings(ckpt_to_initialize_from='output/checkpoint/', vars_to_warm_start='^(?!.*(RMSProp|global_step))', var_name_to_vocab_info={}, var_name_to_prev_var_name={})\nINFO:tensorflow:Warm-starting from: ('output/checkpoint/',)\nINFO:tensorflow:Warm-starting variable: my_model/dense_3/kernel; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_3/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_3/kernel\nINFO:tensorflow:Warm-starting variable: my_model/dense_3/bias; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_3/bias:0 from checkpoint output/checkpoint/ with my_model/dense_3/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense_2/bias; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_2/bias:0 from checkpoint output/checkpoint/ with my_model/dense_2/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense_1/kernel; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_1/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_1/kernel\nINFO:tensorflow:Warm-starting variable: my_model/dense_1/bias; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_1/bias:0 from checkpoint output/checkpoint/ with my_model/dense_1/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense/kernel; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense/kernel:0 from checkpoint output/checkpoint/ with my_model/dense/kernel\nINFO:tensorflow:Warm-starting variable: my_model/dense/bias; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense/bias:0 from checkpoint output/checkpoint/ with my_model/dense/bias\nINFO:tensorflow:Warm-starting variable: my_model/dense_2/kernel; prev_var_name: Unchanged\nINFO:tensorflow:Initialize variable my_model/dense_2/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_2/kernel\nINFO:tensorflow:Create CheckpointSaverHook.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:31:44.926116: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-02-20 20:31:45.024835: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-02-20 20:31:45.025212: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1212] Found device 0 with properties: \nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7085\npciBusID: 0000:01:00.0\ntotalMemory: 5.93GiB freeMemory: 3.84GiB\n2018-02-20 20:31:45.025242: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:31:45.174051: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3579 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Saving checkpoints for 1 into output/my_model/model.ckpt.\nINFO:tensorflow:loss = 0.32987013, step = 1\nINFO:tensorflow:global_step/sec: 56.8537\nINFO:tensorflow:loss = 0.3100884, step = 101 (1.759 sec)\nINFO:tensorflow:global_step/sec: 57.4584\nINFO:tensorflow:loss = 0.32932568, step = 201 (1.740 sec)\nINFO:tensorflow:global_step/sec: 58.9717\nINFO:tensorflow:loss = 0.30233204, step = 301 (1.696 sec)\nINFO:tensorflow:global_step/sec: 57.5253\nINFO:tensorflow:loss = 0.3428804, step = 401 (1.738 sec)\nINFO:tensorflow:global_step/sec: 57.8845\nINFO:tensorflow:loss = 0.331369, step = 501 (1.728 sec)\nINFO:tensorflow:global_step/sec: 58.2558\nINFO:tensorflow:loss = 0.3059027, step = 601 (1.717 sec)\nINFO:tensorflow:global_step/sec: 58.3863\nINFO:tensorflow:loss = 0.32942265, step = 701 (1.713 sec)\nINFO:tensorflow:global_step/sec: 58.454\nINFO:tensorflow:loss = 0.31594634, step = 801 (1.711 sec)\nINFO:tensorflow:global_step/sec: 58.8543\nINFO:tensorflow:loss = 0.31210855, step = 901 (1.699 sec)\nINFO:tensorflow:global_step/sec: 58.7531\nINFO:tensorflow:loss = 0.33128193, step = 1001 (1.702 sec)\nINFO:tensorflow:global_step/sec: 57.5272\nINFO:tensorflow:loss = 0.31882855, step = 1101 (1.739 sec)\nINFO:tensorflow:global_step/sec: 58.2324\nINFO:tensorflow:loss = 0.32009652, step = 1201 (1.717 sec)\nINFO:tensorflow:global_step/sec: 58.8266\nINFO:tensorflow:loss = 0.31766868, step = 1301 (1.700 sec)\nINFO:tensorflow:global_step/sec: 57.1415\nINFO:tensorflow:loss = 0.304159, step = 1401 (1.750 sec)\nINFO:tensorflow:Saving checkpoints for 1500 into output/my_model/model.ckpt.\nINFO:tensorflow:Loss for final step: 0.30592433.\nEvaluating Epoch #5...\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Starting evaluation at 2018-02-20-20:32:12\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:32:12.146704: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:32:12.146840: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nINFO:tensorflow:Finished evaluation at 2018-02-20-20:32:12\nINFO:tensorflow:Saving dict for global step 1500: global_step = 1500, loss = 0.32321918\nINFO:tensorflow:Calling model_fn.\nINFO:tensorflow:Done calling model_fn.\nINFO:tensorflow:Graph was finalized.\n2018-02-20 20:32:12.352526: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:32:12.352642: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\nINFO:tensorflow:Running local_init_op.\nINFO:tensorflow:Done running local_init_op.\nWARNING:tensorflow:From scripts/my_model.py:85: calling l2_normalize (from tensorflow.python.ops.nn_impl) with dim is deprecated and will be removed in a future version.\nInstructions for updating:\ndim is deprecated, use axis instead\n2018-02-20 20:32:12.522432: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\n2018-02-20 20:32:12.522561: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\nR@1: 1.7\nR@5: 4.3\nR@10: 7.4", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04\r\n- **TensorFlow installed from (source or binary)**: binary(official docker image)\r\n- **TensorFlow version (use command below)**: 1.6.0-rc1\r\n- **Python version**: 2.7.12\r\n- **Bazel version (if compiling from source)**: None\r\n- **GCC/Compiler version (if compiling from source)**: None\r\n- **CUDA/cuDNN version**: 9.0 / 7.0.5.15-1\r\n- **GPU model and memory**: GeForce GTX 1060 6GB\r\n- **Exact command to reproduce**: \r\n\r\n```py\r\nwarm_start_from = None \r\nif FLAGS.warm_start:\r\n    warm_start_from = tf.estimator.WarmStartSettings(\r\n        ckpt_to_initialize_from=FLAGS.warm_start,\r\n        # NOTE: attempted with and without `vars_to_warm_start` set\r\n        # vars_to_warm_start='^(?!.*(RMSProp|global_step))'\r\n    )\r\n\r\nmy_model = tf.estimator.Estimator(\r\n    model_fn=my_model_fn,\r\n    model_dir=FLAGS.model,\r\n    warm_start_from=warm_start_from\r\n)\r\n```\r\n\r\n### Describe the problem\r\n\r\nI am attempting to fine tune a model trained with RMSProp. I only want to load the model weights from the checkpoint, not the RMSProp state. To achieve this, I am using Tensorflow 1.6-rc1's `WarmStartSettings`.\r\n\r\nWhen I train the model without `WarmStartSettings`, each minibatch takes around 0.5 seconds. However, when I attempt to use that checkpoint with `WarmStartSettings`, each minibatch takes around 1.7 seconds.\r\n\r\nHaving inspected the logs to make sure the weights are not being initialised for every batch, It seems like this is a bug in Tensorflow. It should also be noted that I experienced similar problems in Tensorflow 1.5 when using `init_from_checkpoint` in my `model_fn` (as seen in https://github.com/tensorflow/tensorflow/issues/10155, which led me to discover the `WarmStartSettings` API).\r\n\r\n### Source code / logs\r\n\r\n#### Without WarmStartSettings (train for one epoch)\r\n\r\n```sh\r\n/usr/local/lib/python2.7/dist-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\r\n  from ._conv import register_converters as _register_converters\r\nTrain data shape...\r\n(30000, 500)\r\n(30000, 2048)\r\nEval data shape...\r\n(5000, 500)\r\n(5000, 2048)\r\nTest data shape...\r\n(5000, 500)\r\n(5000, 2048)\r\nINFO:tensorflow:Using default config.\r\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f6243687f90>, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': 'output/my_model', '_save_summary_steps': 100}\r\nTraining Epoch #1...\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Create CheckpointSaverHook.\r\nINFO:tensorflow:Graph was finalized.\r\n2018-02-20 20:31:08.668914: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\n2018-02-20 20:31:08.767997: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\n2018-02-20 20:31:08.768353: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1212] Found device 0 with properties: \r\nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7085\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 5.93GiB freeMemory: 3.84GiB\r\n2018-02-20 20:31:08.768368: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:31:08.919155: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3579 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Saving checkpoints for 1 into output/my_model/model.ckpt.\r\nINFO:tensorflow:loss = 0.43950942, step = 1\r\nINFO:tensorflow:global_step/sec: 196.162\r\nINFO:tensorflow:loss = 0.46729112, step = 101 (0.510 sec)\r\nINFO:tensorflow:global_step/sec: 205.419\r\nINFO:tensorflow:loss = 0.35870957, step = 201 (0.487 sec)\r\nINFO:tensorflow:global_step/sec: 206.952\r\nINFO:tensorflow:loss = 0.32010338, step = 301 (0.483 sec)\r\nINFO:tensorflow:global_step/sec: 204.129\r\nINFO:tensorflow:loss = 0.3345171, step = 401 (0.490 sec)\r\nINFO:tensorflow:global_step/sec: 209.188\r\nINFO:tensorflow:loss = 0.34134513, step = 501 (0.478 sec)\r\nINFO:tensorflow:global_step/sec: 205.325\r\nINFO:tensorflow:loss = 0.33101806, step = 601 (0.487 sec)\r\nINFO:tensorflow:global_step/sec: 207.222\r\nINFO:tensorflow:loss = 0.34841973, step = 701 (0.483 sec)\r\nINFO:tensorflow:global_step/sec: 206.455\r\nINFO:tensorflow:loss = 0.33363524, step = 801 (0.484 sec)\r\nINFO:tensorflow:global_step/sec: 208.705\r\nINFO:tensorflow:loss = 0.33115995, step = 901 (0.479 sec)\r\nINFO:tensorflow:global_step/sec: 205.786\r\nINFO:tensorflow:loss = 0.32718512, step = 1001 (0.486 sec)\r\nINFO:tensorflow:global_step/sec: 205.812\r\nINFO:tensorflow:loss = 0.33765212, step = 1101 (0.486 sec)\r\nINFO:tensorflow:global_step/sec: 205.522\r\nINFO:tensorflow:loss = 0.33326942, step = 1201 (0.487 sec)\r\nINFO:tensorflow:global_step/sec: 208.248\r\nINFO:tensorflow:loss = 0.34017226, step = 1301 (0.480 sec)\r\nINFO:tensorflow:global_step/sec: 205.824\r\nINFO:tensorflow:loss = 0.32448825, step = 1401 (0.486 sec)\r\nINFO:tensorflow:Saving checkpoints for 1500 into output/my_model/model.ckpt.\r\nINFO:tensorflow:Loss for final step: 0.30791047.\r\nEvaluating Epoch #5...\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Starting evaluation at 2018-02-20-20:31:17\r\nINFO:tensorflow:Graph was finalized.\r\n2018-02-20 20:31:17.344022: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:31:17.344148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Finished evaluation at 2018-02-20-20:31:17\r\nINFO:tensorflow:Saving dict for global step 1500: global_step = 1500, loss = 0.32683796\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Graph was finalized.\r\n2018-02-20 20:31:17.575632: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:31:17.575748: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nWARNING:tensorflow:From scripts/my_model.py:85: calling l2_normalize (from tensorflow.python.ops.nn_impl) with dim is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\ndim is deprecated, use axis instead\r\n2018-02-20 20:31:17.738903: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:31:17.739028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 42 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nR@1: 1.2\r\nR@5: 2.9\r\nR@10: 4.7\r\n```\r\n\r\n#### With WarmStartSettings\r\n\r\n```sh\r\n/usr/local/lib/python2.7/dist-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\r\n  from ._conv import register_converters as _register_converters\r\nTrain data shape...\r\n(30000, 500)\r\n(30000, 2048)\r\nEval data shape...\r\n(5000, 500)\r\n(5000, 2048)\r\nTest data shape...\r\n(5000, 500)\r\n(5000, 2048)\r\nINFO:tensorflow:Using default config.\r\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_global_id_in_cluster': 0, '_is_chief': True, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7fccf90c7f90>, '_evaluation_master': '', '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': None, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_dir': 'output/my_model', '_save_summary_steps': 100}\r\nTraining Epoch #1...\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Warm-starting with WarmStartSettings: WarmStartSettings(ckpt_to_initialize_from='output/checkpoint/', vars_to_warm_start='^(?!.*(RMSProp|global_step))', var_name_to_vocab_info={}, var_name_to_prev_var_name={})\r\nINFO:tensorflow:Warm-starting from: ('output/checkpoint/',)\r\nINFO:tensorflow:Warm-starting variable: my_model/dense_3/kernel; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense_3/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_3/kernel\r\nINFO:tensorflow:Warm-starting variable: my_model/dense_3/bias; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense_3/bias:0 from checkpoint output/checkpoint/ with my_model/dense_3/bias\r\nINFO:tensorflow:Warm-starting variable: my_model/dense_2/bias; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense_2/bias:0 from checkpoint output/checkpoint/ with my_model/dense_2/bias\r\nINFO:tensorflow:Warm-starting variable: my_model/dense_1/kernel; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense_1/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_1/kernel\r\nINFO:tensorflow:Warm-starting variable: my_model/dense_1/bias; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense_1/bias:0 from checkpoint output/checkpoint/ with my_model/dense_1/bias\r\nINFO:tensorflow:Warm-starting variable: my_model/dense/kernel; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense/kernel:0 from checkpoint output/checkpoint/ with my_model/dense/kernel\r\nINFO:tensorflow:Warm-starting variable: my_model/dense/bias; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense/bias:0 from checkpoint output/checkpoint/ with my_model/dense/bias\r\nINFO:tensorflow:Warm-starting variable: my_model/dense_2/kernel; prev_var_name: Unchanged\r\nINFO:tensorflow:Initialize variable my_model/dense_2/kernel:0 from checkpoint output/checkpoint/ with my_model/dense_2/kernel\r\nINFO:tensorflow:Create CheckpointSaverHook.\r\nINFO:tensorflow:Graph was finalized.\r\n2018-02-20 20:31:44.926116: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\n2018-02-20 20:31:45.024835: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\n2018-02-20 20:31:45.025212: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1212] Found device 0 with properties: \r\nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7085\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 5.93GiB freeMemory: 3.84GiB\r\n2018-02-20 20:31:45.025242: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:31:45.174051: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3579 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Saving checkpoints for 1 into output/my_model/model.ckpt.\r\nINFO:tensorflow:loss = 0.32987013, step = 1\r\nINFO:tensorflow:global_step/sec: 56.8537\r\nINFO:tensorflow:loss = 0.3100884, step = 101 (1.759 sec)\r\nINFO:tensorflow:global_step/sec: 57.4584\r\nINFO:tensorflow:loss = 0.32932568, step = 201 (1.740 sec)\r\nINFO:tensorflow:global_step/sec: 58.9717\r\nINFO:tensorflow:loss = 0.30233204, step = 301 (1.696 sec)\r\nINFO:tensorflow:global_step/sec: 57.5253\r\nINFO:tensorflow:loss = 0.3428804, step = 401 (1.738 sec)\r\nINFO:tensorflow:global_step/sec: 57.8845\r\nINFO:tensorflow:loss = 0.331369, step = 501 (1.728 sec)\r\nINFO:tensorflow:global_step/sec: 58.2558\r\nINFO:tensorflow:loss = 0.3059027, step = 601 (1.717 sec)\r\nINFO:tensorflow:global_step/sec: 58.3863\r\nINFO:tensorflow:loss = 0.32942265, step = 701 (1.713 sec)\r\nINFO:tensorflow:global_step/sec: 58.454\r\nINFO:tensorflow:loss = 0.31594634, step = 801 (1.711 sec)\r\nINFO:tensorflow:global_step/sec: 58.8543\r\nINFO:tensorflow:loss = 0.31210855, step = 901 (1.699 sec)\r\nINFO:tensorflow:global_step/sec: 58.7531\r\nINFO:tensorflow:loss = 0.33128193, step = 1001 (1.702 sec)\r\nINFO:tensorflow:global_step/sec: 57.5272\r\nINFO:tensorflow:loss = 0.31882855, step = 1101 (1.739 sec)\r\nINFO:tensorflow:global_step/sec: 58.2324\r\nINFO:tensorflow:loss = 0.32009652, step = 1201 (1.717 sec)\r\nINFO:tensorflow:global_step/sec: 58.8266\r\nINFO:tensorflow:loss = 0.31766868, step = 1301 (1.700 sec)\r\nINFO:tensorflow:global_step/sec: 57.1415\r\nINFO:tensorflow:loss = 0.304159, step = 1401 (1.750 sec)\r\nINFO:tensorflow:Saving checkpoints for 1500 into output/my_model/model.ckpt.\r\nINFO:tensorflow:Loss for final step: 0.30592433.\r\nEvaluating Epoch #5...\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Starting evaluation at 2018-02-20-20:32:12\r\nINFO:tensorflow:Graph was finalized.\r\n2018-02-20 20:32:12.146704: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:32:12.146840: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nINFO:tensorflow:Finished evaluation at 2018-02-20-20:32:12\r\nINFO:tensorflow:Saving dict for global step 1500: global_step = 1500, loss = 0.32321918\r\nINFO:tensorflow:Calling model_fn.\r\nINFO:tensorflow:Done calling model_fn.\r\nINFO:tensorflow:Graph was finalized.\r\n2018-02-20 20:32:12.352526: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:32:12.352642: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nINFO:tensorflow:Restoring parameters from output/my_model/model.ckpt-1500\r\nINFO:tensorflow:Running local_init_op.\r\nINFO:tensorflow:Done running local_init_op.\r\nWARNING:tensorflow:From scripts/my_model.py:85: calling l2_normalize (from tensorflow.python.ops.nn_impl) with dim is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\ndim is deprecated, use axis instead\r\n2018-02-20 20:32:12.522432: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1312] Adding visible gpu devices: 0\r\n2018-02-20 20:32:12.522561: I tensorflow/core/common_runtime/gpu/gpu_device.cc:993] Creating TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 45 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nR@1: 1.7\r\nR@5: 4.3\r\nR@10: 7.4\r\n```\r\n"}