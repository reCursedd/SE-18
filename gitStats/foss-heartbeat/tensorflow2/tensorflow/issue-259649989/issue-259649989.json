{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13221", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13221/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13221/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13221/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13221", "id": 259649989, "node_id": "MDU6SXNzdWUyNTk2NDk5ODk=", "number": 13221, "title": "Memory leak in zeros_like/Tile", "user": {"login": "yaroslavvb", "id": 23068, "node_id": "MDQ6VXNlcjIzMDY4", "avatar_url": "https://avatars3.githubusercontent.com/u/23068?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yaroslavvb", "html_url": "https://github.com/yaroslavvb", "followers_url": "https://api.github.com/users/yaroslavvb/followers", "following_url": "https://api.github.com/users/yaroslavvb/following{/other_user}", "gists_url": "https://api.github.com/users/yaroslavvb/gists{/gist_id}", "starred_url": "https://api.github.com/users/yaroslavvb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yaroslavvb/subscriptions", "organizations_url": "https://api.github.com/users/yaroslavvb/orgs", "repos_url": "https://api.github.com/users/yaroslavvb/repos", "events_url": "https://api.github.com/users/yaroslavvb/events{/privacy}", "received_events_url": "https://api.github.com/users/yaroslavvb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 32, "created_at": "2017-09-21T22:22:23Z", "updated_at": "2018-03-02T16:47:27Z", "closed_at": "2018-03-02T16:47:27Z", "author_association": "CONTRIBUTOR", "body_html": "<p>So I'm trying to figure out why my resnets are running out of memory, and it seems that there's a memory leak in Tile and zeros_like operations.</p>\n<p>Those ops have memory allocated during each session run but there's no <code>__LOG_MEMORY__</code> deallocation messages corresponding to them. The sum of missing deallocations matches the amount of memory leaked as reported by allocator as <code>max_bytes_in_use</code> (accessed through <code>tf.contrib.memory_stats.MaxBytesInUse</code> op)</p>\n<p>Here's a simplified repro, at each sess.run, the memory grows by 1.15 GB until it crashes with OOM<br>\n<a href=\"https://github.com/yaroslavvb/stuff/blob/master/resnet_leak_report2.py\">https://github.com/yaroslavvb/stuff/blob/master/resnet_leak_report2.py</a></p>\n<p>When I run it, I see</p>\n<pre><code>Run 0, GBs in use 2.30\nRun 1, GBs in use 3.60\nRun 2, GBs in use 4.75\nRun 3, GBs in use 5.90\n2017-09-21 14:56:31.994302: W tensorflow/core/common_runtime/bfc_allocator.cc:273] Allocator (GPU_0_bfc) ran out of memory trying to allocate 137.33MiB.  Current allocation summary follows....\n</code></pre>\n<p>Offending ops:</p>\n<pre><code>gradients/leaky_relu_grad/zeros_like 576MB\ngradients/Sum_grad/Tile  576MB\n</code></pre>\n<p>Version:<br>\nUbuntu 16:04<br>\nofficial TensorFlow Linux GPU Python 3.5 nightly wheel from <a href=\"https://ci.tensorflow.org/view/tf-nightly/job/tf-nightly-linux/TF_BUILD_IS_OPT=OPT,TF_BUILD_IS_PIP=PIP,TF_BUILD_PYTHON_VERSION=PYTHON3.5,label=gpu-linux/lastSuccessfulBuild/artifact/pip_test/whl/tf_nightly_gpu-1.head-cp35-cp35m-linux_x86_64.whl\" rel=\"nofollow\">today</a></p>\n<pre><code>version: 1.4.0-dev20170921\n__git_version__: v1.3.0-rc1-2408-ge9d5ee1\nCommit https://github.com/tensorflow/tensorflow/commit/e9d5ee1\n\n</code></pre>", "body_text": "So I'm trying to figure out why my resnets are running out of memory, and it seems that there's a memory leak in Tile and zeros_like operations.\nThose ops have memory allocated during each session run but there's no __LOG_MEMORY__ deallocation messages corresponding to them. The sum of missing deallocations matches the amount of memory leaked as reported by allocator as max_bytes_in_use (accessed through tf.contrib.memory_stats.MaxBytesInUse op)\nHere's a simplified repro, at each sess.run, the memory grows by 1.15 GB until it crashes with OOM\nhttps://github.com/yaroslavvb/stuff/blob/master/resnet_leak_report2.py\nWhen I run it, I see\nRun 0, GBs in use 2.30\nRun 1, GBs in use 3.60\nRun 2, GBs in use 4.75\nRun 3, GBs in use 5.90\n2017-09-21 14:56:31.994302: W tensorflow/core/common_runtime/bfc_allocator.cc:273] Allocator (GPU_0_bfc) ran out of memory trying to allocate 137.33MiB.  Current allocation summary follows....\n\nOffending ops:\ngradients/leaky_relu_grad/zeros_like 576MB\ngradients/Sum_grad/Tile  576MB\n\nVersion:\nUbuntu 16:04\nofficial TensorFlow Linux GPU Python 3.5 nightly wheel from today\nversion: 1.4.0-dev20170921\n__git_version__: v1.3.0-rc1-2408-ge9d5ee1\nCommit https://github.com/tensorflow/tensorflow/commit/e9d5ee1", "body": "So I'm trying to figure out why my resnets are running out of memory, and it seems that there's a memory leak in Tile and zeros_like operations.\r\n\r\nThose ops have memory allocated during each session run but there's no `__LOG_MEMORY__` deallocation messages corresponding to them. The sum of missing deallocations matches the amount of memory leaked as reported by allocator as `max_bytes_in_use` (accessed through `tf.contrib.memory_stats.MaxBytesInUse` op)\r\n\r\nHere's a simplified repro, at each sess.run, the memory grows by 1.15 GB until it crashes with OOM\r\nhttps://github.com/yaroslavvb/stuff/blob/master/resnet_leak_report2.py\r\n\r\nWhen I run it, I see\r\n```\r\nRun 0, GBs in use 2.30\r\nRun 1, GBs in use 3.60\r\nRun 2, GBs in use 4.75\r\nRun 3, GBs in use 5.90\r\n2017-09-21 14:56:31.994302: W tensorflow/core/common_runtime/bfc_allocator.cc:273] Allocator (GPU_0_bfc) ran out of memory trying to allocate 137.33MiB.  Current allocation summary follows....\r\n```\r\n\r\nOffending ops:\r\n```\r\ngradients/leaky_relu_grad/zeros_like 576MB\r\ngradients/Sum_grad/Tile  576MB\r\n```\r\nVersion:\r\nUbuntu 16:04\r\nofficial TensorFlow Linux GPU Python 3.5 nightly wheel from [today](https://ci.tensorflow.org/view/tf-nightly/job/tf-nightly-linux/TF_BUILD_IS_OPT=OPT,TF_BUILD_IS_PIP=PIP,TF_BUILD_PYTHON_VERSION=PYTHON3.5,label=gpu-linux/lastSuccessfulBuild/artifact/pip_test/whl/tf_nightly_gpu-1.head-cp35-cp35m-linux_x86_64.whl)\r\n\r\n```\r\nversion: 1.4.0-dev20170921\r\n__git_version__: v1.3.0-rc1-2408-ge9d5ee1\r\nCommit https://github.com/tensorflow/tensorflow/commit/e9d5ee1\r\n\r\n```"}