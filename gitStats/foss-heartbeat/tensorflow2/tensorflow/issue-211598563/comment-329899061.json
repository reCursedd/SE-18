{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/329899061", "html_url": "https://github.com/tensorflow/tensorflow/issues/8043#issuecomment-329899061", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8043", "id": 329899061, "node_id": "MDEyOklzc3VlQ29tbWVudDMyOTg5OTA2MQ==", "user": {"login": "brightbytes-dude", "id": 6979675, "node_id": "MDQ6VXNlcjY5Nzk2NzU=", "avatar_url": "https://avatars2.githubusercontent.com/u/6979675?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brightbytes-dude", "html_url": "https://github.com/brightbytes-dude", "followers_url": "https://api.github.com/users/brightbytes-dude/followers", "following_url": "https://api.github.com/users/brightbytes-dude/following{/other_user}", "gists_url": "https://api.github.com/users/brightbytes-dude/gists{/gist_id}", "starred_url": "https://api.github.com/users/brightbytes-dude/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brightbytes-dude/subscriptions", "organizations_url": "https://api.github.com/users/brightbytes-dude/orgs", "repos_url": "https://api.github.com/users/brightbytes-dude/repos", "events_url": "https://api.github.com/users/brightbytes-dude/events{/privacy}", "received_events_url": "https://api.github.com/users/brightbytes-dude/received_events", "type": "User", "site_admin": false}, "created_at": "2017-09-15T20:55:08Z", "updated_at": "2017-09-15T20:55:08Z", "author_association": "NONE", "body_html": "<p>This is still not fixed in TensorFlow 1.3.0.</p>\n<p>I'm using the high-level API only, and define the weights column in exactly the same fashion as I define other feature columns:</p>\n<p><code>tf.contrib.layers.real_valued_column(self.schema.label_weight_column)</code></p>\n<p>... where I have tests that prove that <code>self.schema.label_weight_column</code> is the string naming my weight column <code>\"outcome_class_weight\"</code></p>\n<p>I then define the model as follows, where <code>deep_feature_columns</code> includes <code>tf.contrib.layers.real_valued_column(self.schema.label_weight_column)</code>:</p>\n<pre><code>tf.contrib.learn.DNNClassifier(\n  model_dir=self.schema.model_dir,\n  feature_columns=deep_feature_columns,\n  weight_column_name=self.schema.label_weight_column,\n  hidden_units=self.schema.hidden_units,\n  activation_fn=self.schema.activation_fn,\n  dropout=self.schema.dropout_probability,\n  gradient_clip_norm=self.schema.gradient_clip_norm_ratio,\n  enable_centered_bias=self.schema.enable_centered_bias,\n  optimizer=optimizer,\n  config=run_config\n)\n</code></pre>\n<p>Finally, upon running, I see the weights broadcast Exception:</p>\n<pre><code>Traceback (most recent call last):\n  File \"runner.py\", line 89, in &lt;module&gt;\n    tf.app.run(main=main, argv=[sys.argv[0]] + unparsed)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 48, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"runner.py\", line 40, in main\n    metrics = trainer.train_and_test()\n  File \"/Users/aaron/git/bb_tensorflow/domain/model_trainer.py\", line 93, in train_and_test\n    monitors=[self.__build_monitor__()]\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 296, in new_func\n    return func(*args, **kwargs)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 458, in fit\n    loss = self._train_model(input_fn=input_fn, hooks=hooks)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 958, in _train_model\n    model_fn_ops = self._get_train_ops(features, labels)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1165, in _get_train_ops\n    return self._call_model_fn(features, labels, model_fn_lib.ModeKeys.TRAIN)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1136, in _call_model_fn\n    model_fn_results = self._model_fn(features, labels, **kwargs)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/dnn.py\", line 209, in _dnn_model_fn\n    logits=logits)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 854, in create_model_fn_ops\n    enable_centered_bias=self._enable_centered_bias)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 651, in _create_model_fn_ops\n    weighted_average_loss, predictions, labels, weight_tensor)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 908, in _metrics\n    _indicator_labels_streaming_mean(labels, weights))\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1937, in _indicator_labels_streaming_mean\n    weights = weights_broadcast_ops.broadcast_weights(weights, labels)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/weights_broadcast_ops.py\", line 167, in broadcast_weights\n    with ops.control_dependencies((assert_broadcastable(weights, values),)):\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/weights_broadcast_ops.py\", line 103, in assert_broadcastable\n    weights_rank_static, values.shape, weights.shape))\nValueError: weights can not be broadcast to values. values.rank=1. weights.rank=2. values.shape=(18018,). weights.shape=(18018, 1).\n</code></pre>\n<p>I'm going to attempt <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=19861701\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/honkentuber\">@honkentuber</a> 's proposed fix, but I strongly suspect I'll encounter <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=13184614\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ntvy95\">@ntvy95</a> 's exception after doing so.  (Will update if not.)</p>\n<p>Also, apologies for being forward, but why was this ticket closed when the exception still occurs in the most recent stable version of TensorFlow?</p>", "body_text": "This is still not fixed in TensorFlow 1.3.0.\nI'm using the high-level API only, and define the weights column in exactly the same fashion as I define other feature columns:\ntf.contrib.layers.real_valued_column(self.schema.label_weight_column)\n... where I have tests that prove that self.schema.label_weight_column is the string naming my weight column \"outcome_class_weight\"\nI then define the model as follows, where deep_feature_columns includes tf.contrib.layers.real_valued_column(self.schema.label_weight_column):\ntf.contrib.learn.DNNClassifier(\n  model_dir=self.schema.model_dir,\n  feature_columns=deep_feature_columns,\n  weight_column_name=self.schema.label_weight_column,\n  hidden_units=self.schema.hidden_units,\n  activation_fn=self.schema.activation_fn,\n  dropout=self.schema.dropout_probability,\n  gradient_clip_norm=self.schema.gradient_clip_norm_ratio,\n  enable_centered_bias=self.schema.enable_centered_bias,\n  optimizer=optimizer,\n  config=run_config\n)\n\nFinally, upon running, I see the weights broadcast Exception:\nTraceback (most recent call last):\n  File \"runner.py\", line 89, in <module>\n    tf.app.run(main=main, argv=[sys.argv[0]] + unparsed)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 48, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"runner.py\", line 40, in main\n    metrics = trainer.train_and_test()\n  File \"/Users/aaron/git/bb_tensorflow/domain/model_trainer.py\", line 93, in train_and_test\n    monitors=[self.__build_monitor__()]\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 296, in new_func\n    return func(*args, **kwargs)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 458, in fit\n    loss = self._train_model(input_fn=input_fn, hooks=hooks)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 958, in _train_model\n    model_fn_ops = self._get_train_ops(features, labels)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1165, in _get_train_ops\n    return self._call_model_fn(features, labels, model_fn_lib.ModeKeys.TRAIN)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1136, in _call_model_fn\n    model_fn_results = self._model_fn(features, labels, **kwargs)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/dnn.py\", line 209, in _dnn_model_fn\n    logits=logits)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 854, in create_model_fn_ops\n    enable_centered_bias=self._enable_centered_bias)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 651, in _create_model_fn_ops\n    weighted_average_loss, predictions, labels, weight_tensor)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 908, in _metrics\n    _indicator_labels_streaming_mean(labels, weights))\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1937, in _indicator_labels_streaming_mean\n    weights = weights_broadcast_ops.broadcast_weights(weights, labels)\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/weights_broadcast_ops.py\", line 167, in broadcast_weights\n    with ops.control_dependencies((assert_broadcastable(weights, values),)):\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/weights_broadcast_ops.py\", line 103, in assert_broadcastable\n    weights_rank_static, values.shape, weights.shape))\nValueError: weights can not be broadcast to values. values.rank=1. weights.rank=2. values.shape=(18018,). weights.shape=(18018, 1).\n\nI'm going to attempt @honkentuber 's proposed fix, but I strongly suspect I'll encounter @ntvy95 's exception after doing so.  (Will update if not.)\nAlso, apologies for being forward, but why was this ticket closed when the exception still occurs in the most recent stable version of TensorFlow?", "body": "This is still not fixed in TensorFlow 1.3.0.\r\n\r\nI'm using the high-level API only, and define the weights column in exactly the same fashion as I define other feature columns:\r\n\r\n`tf.contrib.layers.real_valued_column(self.schema.label_weight_column)`\r\n\r\n... where I have tests that prove that `self.schema.label_weight_column` is the string naming my weight column `\"outcome_class_weight\"`\r\n\r\nI then define the model as follows, where `deep_feature_columns` includes `tf.contrib.layers.real_valued_column(self.schema.label_weight_column)`:\r\n\r\n    tf.contrib.learn.DNNClassifier(\r\n      model_dir=self.schema.model_dir,\r\n      feature_columns=deep_feature_columns,\r\n      weight_column_name=self.schema.label_weight_column,\r\n      hidden_units=self.schema.hidden_units,\r\n      activation_fn=self.schema.activation_fn,\r\n      dropout=self.schema.dropout_probability,\r\n      gradient_clip_norm=self.schema.gradient_clip_norm_ratio,\r\n      enable_centered_bias=self.schema.enable_centered_bias,\r\n      optimizer=optimizer,\r\n      config=run_config\r\n    )\r\n\r\nFinally, upon running, I see the weights broadcast Exception:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"runner.py\", line 89, in <module>\r\n    tf.app.run(main=main, argv=[sys.argv[0]] + unparsed)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/platform/app.py\", line 48, in run\r\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\r\n  File \"runner.py\", line 40, in main\r\n    metrics = trainer.train_and_test()\r\n  File \"/Users/aaron/git/bb_tensorflow/domain/model_trainer.py\", line 93, in train_and_test\r\n    monitors=[self.__build_monitor__()]\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 296, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 458, in fit\r\n    loss = self._train_model(input_fn=input_fn, hooks=hooks)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 958, in _train_model\r\n    model_fn_ops = self._get_train_ops(features, labels)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1165, in _get_train_ops\r\n    return self._call_model_fn(features, labels, model_fn_lib.ModeKeys.TRAIN)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1136, in _call_model_fn\r\n    model_fn_results = self._model_fn(features, labels, **kwargs)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/dnn.py\", line 209, in _dnn_model_fn\r\n    logits=logits)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 854, in create_model_fn_ops\r\n    enable_centered_bias=self._enable_centered_bias)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 651, in _create_model_fn_ops\r\n    weighted_average_loss, predictions, labels, weight_tensor)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 908, in _metrics\r\n    _indicator_labels_streaming_mean(labels, weights))\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1937, in _indicator_labels_streaming_mean\r\n    weights = weights_broadcast_ops.broadcast_weights(weights, labels)\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/weights_broadcast_ops.py\", line 167, in broadcast_weights\r\n    with ops.control_dependencies((assert_broadcastable(weights, values),)):\r\n  File \"/Users/aaron/git/bb_tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/weights_broadcast_ops.py\", line 103, in assert_broadcastable\r\n    weights_rank_static, values.shape, weights.shape))\r\nValueError: weights can not be broadcast to values. values.rank=1. weights.rank=2. values.shape=(18018,). weights.shape=(18018, 1).\r\n```\r\n\r\nI'm going to attempt @honkentuber 's proposed fix, but I strongly suspect I'll encounter @ntvy95 's exception after doing so.  (Will update if not.)\r\n\r\nAlso, apologies for being forward, but why was this ticket closed when the exception still occurs in the most recent stable version of TensorFlow?"}