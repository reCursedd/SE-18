{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/298783900", "html_url": "https://github.com/tensorflow/tensorflow/pull/8999#issuecomment-298783900", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8999", "id": 298783900, "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODc4MzkwMA==", "user": {"login": "samjabrahams", "id": 11607205, "node_id": "MDQ6VXNlcjExNjA3MjA1", "avatar_url": "https://avatars0.githubusercontent.com/u/11607205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/samjabrahams", "html_url": "https://github.com/samjabrahams", "followers_url": "https://api.github.com/users/samjabrahams/followers", "following_url": "https://api.github.com/users/samjabrahams/following{/other_user}", "gists_url": "https://api.github.com/users/samjabrahams/gists{/gist_id}", "starred_url": "https://api.github.com/users/samjabrahams/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/samjabrahams/subscriptions", "organizations_url": "https://api.github.com/users/samjabrahams/orgs", "repos_url": "https://api.github.com/users/samjabrahams/repos", "events_url": "https://api.github.com/users/samjabrahams/events{/privacy}", "received_events_url": "https://api.github.com/users/samjabrahams/received_events", "type": "User", "site_admin": false}, "created_at": "2017-05-02T22:54:31Z", "updated_at": "2017-05-02T22:54:31Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I figured out that some nodes were getting added twice: <a href=\"https://github.com/tensorflow/tensorflow/blob/d57c31661e8f76d6c3d91f3969d4d4219c9ea97c/tensorflow/tools/quantization/quantize_graph.py#L503-L505\">once here</a>, and again <a href=\"https://github.com/tensorflow/tensorflow/blob/d57c31661e8f76d6c3d91f3969d4d4219c9ea97c/tensorflow/tools/quantization/quantize_graph.py#L497-L500\">here</a>. If a node is an input to <code>Conv2D</code>, <code>BiasAdd</code>, or <code>MatMul</code>, both the original and a quantized version of that input is added to the graph, both of which have the same name (leading to the error mentioned above).</p>\n<p>For now, I've removed the loop that adds quantized inputs, and the \"Dequantize Operation expects three inputs\" errors have gone away. However, I'm not sure if this is the correct fix: is the <code>quantize_graph</code> tool supposed to quantize the inputs to <code>Conv2D</code>, <code>BiasAdd</code>, and <code>MatMul</code>? If so, we'll need to rework the algorithm to not double-add operations.</p>\n<p>Additionally, we're getting some numeric failures from converting to/from quantized land. My guess is that these are due to forcing the quantized range to include the number 0, but I figured I would include this just in case something looks screwy.</p>\n<pre><code>2.0000 4.0000 6.0000 8.0000 10.0000 12.0000 8.0000 10.0000 12.0000 14.0000 16.0000 18.0000 \n3.7647 5.5843 7.3412 9.0980 10.9176 12.6745 9.0980 10.9176 12.6745 14.4314 16.2510 18.0078 \nTensors have 5 different values (41.6666666667%), with mean difference -0.896732529004 and mean absolute difference 0.896732529004\n\n2.0078 4.0157 6.0235 7.9686 9.9765 7.0275 8.9725 10.9804 12.9882 14.9961 \n3.7020 5.4588 7.2157 8.9098 10.6667 8.0314 9.7882 11.5451 13.2392 14.9961 \nTensors have 4 different values (40.0%), with mean difference -0.85960791111 and mean absolute difference 0.85960791111\n\n2.0000 4.0000 6.0000 8.0000 10.0000 7.0000 9.0000 11.0000 13.0000 15.0000 \n3.7216 5.4549 7.1882 8.9216 10.6549 8.0549 9.7882 11.5216 13.2549 14.9882 \nTensors have 4 different values (40.0%), with mean difference -0.854902219772 and mean absolute difference 0.857255125046\n\n105.0000 150.0000 183.0000 95.0000 235.0000 312.0000 357.0000 178.0000 187.0000 234.0000 261.0000 121.0000 \n171.5843 204.4628 229.1216 164.3922 267.1373 323.6471 356.5255 225.0118 232.2039 266.1098 285.6314 182.8863 \nTensors have 11 different values (91.6666666667%), with mean difference -40.8928273519 and mean absolute difference 40.9719085693\n\n1.0000 4.0000 9.0000 16.0000 25.0000 36.0000 49.0000 64.0000 81.0000 100.0000 121.0000 144.0000 \n2.2431 5.0471 10.0941 16.8235 25.7961 37.0118 49.9098 64.4902 81.3137 100.3804 121.1294 144.1216 \nTensors have 4 different values (33.3333333333%), with mean difference -0.696733077367 and mean absolute difference 0.696733077367\n\n74.0000 80.0000 86.0000 92.0000 173.0000 188.0000 203.0000 218.0000 \n123.1059 127.0588 131.0118 134.9647 188.0471 198.2118 207.8118 217.9765 \nTensors have 7 different values (87.5%), with mean difference -26.7735290527 and mean absolute difference 26.7794113159\n\n348.0000 252.0000 274.0000 175.0000 \n348.0353 300.5451 311.4000 261.8745 \nTensors have 3 different values (75.0%), with mean difference -43.2137298584 and mean absolute difference 43.2137298584\n</code></pre>", "body_text": "I figured out that some nodes were getting added twice: once here, and again here. If a node is an input to Conv2D, BiasAdd, or MatMul, both the original and a quantized version of that input is added to the graph, both of which have the same name (leading to the error mentioned above).\nFor now, I've removed the loop that adds quantized inputs, and the \"Dequantize Operation expects three inputs\" errors have gone away. However, I'm not sure if this is the correct fix: is the quantize_graph tool supposed to quantize the inputs to Conv2D, BiasAdd, and MatMul? If so, we'll need to rework the algorithm to not double-add operations.\nAdditionally, we're getting some numeric failures from converting to/from quantized land. My guess is that these are due to forcing the quantized range to include the number 0, but I figured I would include this just in case something looks screwy.\n2.0000 4.0000 6.0000 8.0000 10.0000 12.0000 8.0000 10.0000 12.0000 14.0000 16.0000 18.0000 \n3.7647 5.5843 7.3412 9.0980 10.9176 12.6745 9.0980 10.9176 12.6745 14.4314 16.2510 18.0078 \nTensors have 5 different values (41.6666666667%), with mean difference -0.896732529004 and mean absolute difference 0.896732529004\n\n2.0078 4.0157 6.0235 7.9686 9.9765 7.0275 8.9725 10.9804 12.9882 14.9961 \n3.7020 5.4588 7.2157 8.9098 10.6667 8.0314 9.7882 11.5451 13.2392 14.9961 \nTensors have 4 different values (40.0%), with mean difference -0.85960791111 and mean absolute difference 0.85960791111\n\n2.0000 4.0000 6.0000 8.0000 10.0000 7.0000 9.0000 11.0000 13.0000 15.0000 \n3.7216 5.4549 7.1882 8.9216 10.6549 8.0549 9.7882 11.5216 13.2549 14.9882 \nTensors have 4 different values (40.0%), with mean difference -0.854902219772 and mean absolute difference 0.857255125046\n\n105.0000 150.0000 183.0000 95.0000 235.0000 312.0000 357.0000 178.0000 187.0000 234.0000 261.0000 121.0000 \n171.5843 204.4628 229.1216 164.3922 267.1373 323.6471 356.5255 225.0118 232.2039 266.1098 285.6314 182.8863 \nTensors have 11 different values (91.6666666667%), with mean difference -40.8928273519 and mean absolute difference 40.9719085693\n\n1.0000 4.0000 9.0000 16.0000 25.0000 36.0000 49.0000 64.0000 81.0000 100.0000 121.0000 144.0000 \n2.2431 5.0471 10.0941 16.8235 25.7961 37.0118 49.9098 64.4902 81.3137 100.3804 121.1294 144.1216 \nTensors have 4 different values (33.3333333333%), with mean difference -0.696733077367 and mean absolute difference 0.696733077367\n\n74.0000 80.0000 86.0000 92.0000 173.0000 188.0000 203.0000 218.0000 \n123.1059 127.0588 131.0118 134.9647 188.0471 198.2118 207.8118 217.9765 \nTensors have 7 different values (87.5%), with mean difference -26.7735290527 and mean absolute difference 26.7794113159\n\n348.0000 252.0000 274.0000 175.0000 \n348.0353 300.5451 311.4000 261.8745 \nTensors have 3 different values (75.0%), with mean difference -43.2137298584 and mean absolute difference 43.2137298584", "body": "I figured out that some nodes were getting added twice: [once here](https://github.com/tensorflow/tensorflow/blob/d57c31661e8f76d6c3d91f3969d4d4219c9ea97c/tensorflow/tools/quantization/quantize_graph.py#L503-L505), and again [here](https://github.com/tensorflow/tensorflow/blob/d57c31661e8f76d6c3d91f3969d4d4219c9ea97c/tensorflow/tools/quantization/quantize_graph.py#L497-L500). If a node is an input to `Conv2D`, `BiasAdd`, or `MatMul`, both the original and a quantized version of that input is added to the graph, both of which have the same name (leading to the error mentioned above).\r\n\r\nFor now, I've removed the loop that adds quantized inputs, and the \"Dequantize Operation expects three inputs\" errors have gone away. However, I'm not sure if this is the correct fix: is the `quantize_graph` tool supposed to quantize the inputs to `Conv2D`, `BiasAdd`, and `MatMul`? If so, we'll need to rework the algorithm to not double-add operations.\r\n\r\nAdditionally, we're getting some numeric failures from converting to/from quantized land. My guess is that these are due to forcing the quantized range to include the number 0, but I figured I would include this just in case something looks screwy.\r\n\r\n```\r\n2.0000 4.0000 6.0000 8.0000 10.0000 12.0000 8.0000 10.0000 12.0000 14.0000 16.0000 18.0000 \r\n3.7647 5.5843 7.3412 9.0980 10.9176 12.6745 9.0980 10.9176 12.6745 14.4314 16.2510 18.0078 \r\nTensors have 5 different values (41.6666666667%), with mean difference -0.896732529004 and mean absolute difference 0.896732529004\r\n\r\n2.0078 4.0157 6.0235 7.9686 9.9765 7.0275 8.9725 10.9804 12.9882 14.9961 \r\n3.7020 5.4588 7.2157 8.9098 10.6667 8.0314 9.7882 11.5451 13.2392 14.9961 \r\nTensors have 4 different values (40.0%), with mean difference -0.85960791111 and mean absolute difference 0.85960791111\r\n\r\n2.0000 4.0000 6.0000 8.0000 10.0000 7.0000 9.0000 11.0000 13.0000 15.0000 \r\n3.7216 5.4549 7.1882 8.9216 10.6549 8.0549 9.7882 11.5216 13.2549 14.9882 \r\nTensors have 4 different values (40.0%), with mean difference -0.854902219772 and mean absolute difference 0.857255125046\r\n\r\n105.0000 150.0000 183.0000 95.0000 235.0000 312.0000 357.0000 178.0000 187.0000 234.0000 261.0000 121.0000 \r\n171.5843 204.4628 229.1216 164.3922 267.1373 323.6471 356.5255 225.0118 232.2039 266.1098 285.6314 182.8863 \r\nTensors have 11 different values (91.6666666667%), with mean difference -40.8928273519 and mean absolute difference 40.9719085693\r\n\r\n1.0000 4.0000 9.0000 16.0000 25.0000 36.0000 49.0000 64.0000 81.0000 100.0000 121.0000 144.0000 \r\n2.2431 5.0471 10.0941 16.8235 25.7961 37.0118 49.9098 64.4902 81.3137 100.3804 121.1294 144.1216 \r\nTensors have 4 different values (33.3333333333%), with mean difference -0.696733077367 and mean absolute difference 0.696733077367\r\n\r\n74.0000 80.0000 86.0000 92.0000 173.0000 188.0000 203.0000 218.0000 \r\n123.1059 127.0588 131.0118 134.9647 188.0471 198.2118 207.8118 217.9765 \r\nTensors have 7 different values (87.5%), with mean difference -26.7735290527 and mean absolute difference 26.7794113159\r\n\r\n348.0000 252.0000 274.0000 175.0000 \r\n348.0353 300.5451 311.4000 261.8745 \r\nTensors have 3 different values (75.0%), with mean difference -43.2137298584 and mean absolute difference 43.2137298584\r\n```\r\n\r\n"}