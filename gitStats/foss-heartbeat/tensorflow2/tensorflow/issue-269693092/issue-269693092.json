{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14101", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14101/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14101/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14101/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/14101", "id": 269693092, "node_id": "MDU6SXNzdWUyNjk2OTMwOTI=", "number": 14101, "title": "Computing gradients within tf.while_loop", "user": {"login": "pramodkaushik", "id": 27796676, "node_id": "MDQ6VXNlcjI3Nzk2Njc2", "avatar_url": "https://avatars3.githubusercontent.com/u/27796676?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pramodkaushik", "html_url": "https://github.com/pramodkaushik", "followers_url": "https://api.github.com/users/pramodkaushik/followers", "following_url": "https://api.github.com/users/pramodkaushik/following{/other_user}", "gists_url": "https://api.github.com/users/pramodkaushik/gists{/gist_id}", "starred_url": "https://api.github.com/users/pramodkaushik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pramodkaushik/subscriptions", "organizations_url": "https://api.github.com/users/pramodkaushik/orgs", "repos_url": "https://api.github.com/users/pramodkaushik/repos", "events_url": "https://api.github.com/users/pramodkaushik/events{/privacy}", "received_events_url": "https://api.github.com/users/pramodkaushik/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "skye", "id": 88808, "node_id": "MDQ6VXNlcjg4ODA4", "avatar_url": "https://avatars1.githubusercontent.com/u/88808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/skye", "html_url": "https://github.com/skye", "followers_url": "https://api.github.com/users/skye/followers", "following_url": "https://api.github.com/users/skye/following{/other_user}", "gists_url": "https://api.github.com/users/skye/gists{/gist_id}", "starred_url": "https://api.github.com/users/skye/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/skye/subscriptions", "organizations_url": "https://api.github.com/users/skye/orgs", "repos_url": "https://api.github.com/users/skye/repos", "events_url": "https://api.github.com/users/skye/events{/privacy}", "received_events_url": "https://api.github.com/users/skye/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "skye", "id": 88808, "node_id": "MDQ6VXNlcjg4ODA4", "avatar_url": "https://avatars1.githubusercontent.com/u/88808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/skye", "html_url": "https://github.com/skye", "followers_url": "https://api.github.com/users/skye/followers", "following_url": "https://api.github.com/users/skye/following{/other_user}", "gists_url": "https://api.github.com/users/skye/gists{/gist_id}", "starred_url": "https://api.github.com/users/skye/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/skye/subscriptions", "organizations_url": "https://api.github.com/users/skye/orgs", "repos_url": "https://api.github.com/users/skye/repos", "events_url": "https://api.github.com/users/skye/events{/privacy}", "received_events_url": "https://api.github.com/users/skye/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 11, "created_at": "2017-10-30T17:47:44Z", "updated_at": "2018-05-09T05:00:36Z", "closed_at": "2018-05-09T05:00:36Z", "author_association": "NONE", "body_html": "<p>I am posting this here because <a href=\"https://stackoverflow.com/questions/42313788/how-to-do-opt-compute-gradients-multiple-times-in-single-sess-run\" rel=\"nofollow\">a similar question on stackoverflow</a> is still unanswered, so I suspect it might be a bug.</p>\n<p>Adding gradient ops within a tf.while_loop for computing gradients of loop variables w.r.t external variables results in an error.</p>\n<p>Program reproducing the error:</p>\n<pre><code>import numpy as np\nimport tensorflow as tf\ntf.reset_default_graph()\nF = lambda x: tf.cumsum(x)\nG = lambda x: x[-1]\nH = lambda x: x\nencoder_emb_inp = tf.placeholder(dtype=tf.float32, shape=[4])\nencoder_outputs = F(encoder_emb_inp)\ndecoder_initial_state = G(encoder_outputs)\ndecoder_initial_output = H(decoder_initial_state)\ndef cond(time, unused_state, unused_output):\n    return tf.less(time, 3)\n\ndef body(time, state, inputs):\n    step = lambda s, i: (tf.multiply(s,s), tf.multiply(s,i))\n    (next_state, next_output) = step(state, inputs)\n    next_grads = tf.gradients(next_output, decoder_initial_state)\n    tf.Print(next_grads, next_grads)\n    return (time + 1, next_state, next_output)\n\ninitial_time = tf.constant(0, dtype=tf.int32)\n\n\nfinal_time, final_state, final_outputs = tf.while_loop(cond, body, loop_vars = [initial_time, decoder_initial_state, decoder_initial_output])\n</code></pre>\n<p>Error message:</p>\n<pre><code>&lt;ipython-input-126-5205901211cc&gt; in body(time, state, inputs)\n      6     (next_state, next_output) = step(state, inputs)\n      7 #    next_grads = tf.gradients(next_output, state)\n----&gt; 8     next_grads = tf.gradients(next_output, decoder_initial_state)\n      9     tf.Print(next_grads, next_grads)\n     10     return (time + 1, next_state, next_output)\n\n/home/pramodkm/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method, stop_gradients)\n    591                 out_grads[i] = loop_state.ZerosLike(op, i)\n    592               else:\n--&gt; 593                 out_grads[i] = control_flow_ops.ZerosLikeOutsideLoop(op, i)\n    594           with ops.name_scope(op.name + \"_grad\"):\n    595             # pylint: disable=protected-access\n\n/home/pramodkm/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in ZerosLikeOutsideLoop(op, index)\n   1342     if op_ctxt:\n   1343       # We are in a cond context. Use a switch to create zeros only when needed.\n-&gt; 1344       pred = op_ctxt.pred\n   1345       branch = op_ctxt.branch\n   1346       switch_val = switch(op.inputs[0], pred)[1 - branch]\n\nAttributeError: 'WhileContext' object has no attribute 'pred'\n</code></pre>\n<p>I am using tf-nightly-gpu 1.5.0-dev20171026</p>\n<p>Thanks!</p>", "body_text": "I am posting this here because a similar question on stackoverflow is still unanswered, so I suspect it might be a bug.\nAdding gradient ops within a tf.while_loop for computing gradients of loop variables w.r.t external variables results in an error.\nProgram reproducing the error:\nimport numpy as np\nimport tensorflow as tf\ntf.reset_default_graph()\nF = lambda x: tf.cumsum(x)\nG = lambda x: x[-1]\nH = lambda x: x\nencoder_emb_inp = tf.placeholder(dtype=tf.float32, shape=[4])\nencoder_outputs = F(encoder_emb_inp)\ndecoder_initial_state = G(encoder_outputs)\ndecoder_initial_output = H(decoder_initial_state)\ndef cond(time, unused_state, unused_output):\n    return tf.less(time, 3)\n\ndef body(time, state, inputs):\n    step = lambda s, i: (tf.multiply(s,s), tf.multiply(s,i))\n    (next_state, next_output) = step(state, inputs)\n    next_grads = tf.gradients(next_output, decoder_initial_state)\n    tf.Print(next_grads, next_grads)\n    return (time + 1, next_state, next_output)\n\ninitial_time = tf.constant(0, dtype=tf.int32)\n\n\nfinal_time, final_state, final_outputs = tf.while_loop(cond, body, loop_vars = [initial_time, decoder_initial_state, decoder_initial_output])\n\nError message:\n<ipython-input-126-5205901211cc> in body(time, state, inputs)\n      6     (next_state, next_output) = step(state, inputs)\n      7 #    next_grads = tf.gradients(next_output, state)\n----> 8     next_grads = tf.gradients(next_output, decoder_initial_state)\n      9     tf.Print(next_grads, next_grads)\n     10     return (time + 1, next_state, next_output)\n\n/home/pramodkm/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method, stop_gradients)\n    591                 out_grads[i] = loop_state.ZerosLike(op, i)\n    592               else:\n--> 593                 out_grads[i] = control_flow_ops.ZerosLikeOutsideLoop(op, i)\n    594           with ops.name_scope(op.name + \"_grad\"):\n    595             # pylint: disable=protected-access\n\n/home/pramodkm/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in ZerosLikeOutsideLoop(op, index)\n   1342     if op_ctxt:\n   1343       # We are in a cond context. Use a switch to create zeros only when needed.\n-> 1344       pred = op_ctxt.pred\n   1345       branch = op_ctxt.branch\n   1346       switch_val = switch(op.inputs[0], pred)[1 - branch]\n\nAttributeError: 'WhileContext' object has no attribute 'pred'\n\nI am using tf-nightly-gpu 1.5.0-dev20171026\nThanks!", "body": "I am posting this here because [a similar question on stackoverflow](https://stackoverflow.com/questions/42313788/how-to-do-opt-compute-gradients-multiple-times-in-single-sess-run) is still unanswered, so I suspect it might be a bug. \r\n\r\nAdding gradient ops within a tf.while_loop for computing gradients of loop variables w.r.t external variables results in an error. \r\n\r\nProgram reproducing the error:\r\n```\r\nimport numpy as np\r\nimport tensorflow as tf\r\ntf.reset_default_graph()\r\nF = lambda x: tf.cumsum(x)\r\nG = lambda x: x[-1]\r\nH = lambda x: x\r\nencoder_emb_inp = tf.placeholder(dtype=tf.float32, shape=[4])\r\nencoder_outputs = F(encoder_emb_inp)\r\ndecoder_initial_state = G(encoder_outputs)\r\ndecoder_initial_output = H(decoder_initial_state)\r\ndef cond(time, unused_state, unused_output):\r\n    return tf.less(time, 3)\r\n\r\ndef body(time, state, inputs):\r\n    step = lambda s, i: (tf.multiply(s,s), tf.multiply(s,i))\r\n    (next_state, next_output) = step(state, inputs)\r\n    next_grads = tf.gradients(next_output, decoder_initial_state)\r\n    tf.Print(next_grads, next_grads)\r\n    return (time + 1, next_state, next_output)\r\n\r\ninitial_time = tf.constant(0, dtype=tf.int32)\r\n\r\n\r\nfinal_time, final_state, final_outputs = tf.while_loop(cond, body, loop_vars = [initial_time, decoder_initial_state, decoder_initial_output])\r\n```\r\nError message: \r\n```\r\n<ipython-input-126-5205901211cc> in body(time, state, inputs)\r\n      6     (next_state, next_output) = step(state, inputs)\r\n      7 #    next_grads = tf.gradients(next_output, state)\r\n----> 8     next_grads = tf.gradients(next_output, decoder_initial_state)\r\n      9     tf.Print(next_grads, next_grads)\r\n     10     return (time + 1, next_state, next_output)\r\n\r\n/home/pramodkm/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method, stop_gradients)\r\n    591                 out_grads[i] = loop_state.ZerosLike(op, i)\r\n    592               else:\r\n--> 593                 out_grads[i] = control_flow_ops.ZerosLikeOutsideLoop(op, i)\r\n    594           with ops.name_scope(op.name + \"_grad\"):\r\n    595             # pylint: disable=protected-access\r\n\r\n/home/pramodkm/tensorflow/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in ZerosLikeOutsideLoop(op, index)\r\n   1342     if op_ctxt:\r\n   1343       # We are in a cond context. Use a switch to create zeros only when needed.\r\n-> 1344       pred = op_ctxt.pred\r\n   1345       branch = op_ctxt.branch\r\n   1346       switch_val = switch(op.inputs[0], pred)[1 - branch]\r\n\r\nAttributeError: 'WhileContext' object has no attribute 'pred'\r\n```\r\nI am using tf-nightly-gpu 1.5.0-dev20171026\r\n\r\nThanks!"}