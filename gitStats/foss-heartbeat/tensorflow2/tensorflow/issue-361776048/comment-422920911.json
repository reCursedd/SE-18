{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/422920911", "html_url": "https://github.com/tensorflow/tensorflow/issues/22383#issuecomment-422920911", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22383", "id": 422920911, "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjkyMDkxMQ==", "user": {"login": "jhultman", "id": 27909223, "node_id": "MDQ6VXNlcjI3OTA5MjIz", "avatar_url": "https://avatars3.githubusercontent.com/u/27909223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhultman", "html_url": "https://github.com/jhultman", "followers_url": "https://api.github.com/users/jhultman/followers", "following_url": "https://api.github.com/users/jhultman/following{/other_user}", "gists_url": "https://api.github.com/users/jhultman/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhultman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhultman/subscriptions", "organizations_url": "https://api.github.com/users/jhultman/orgs", "repos_url": "https://api.github.com/users/jhultman/repos", "events_url": "https://api.github.com/users/jhultman/events{/privacy}", "received_events_url": "https://api.github.com/users/jhultman/received_events", "type": "User", "site_admin": false}, "created_at": "2018-09-19T19:01:13Z", "updated_at": "2018-09-19T19:21:24Z", "author_association": "NONE", "body_html": "<p>I tried with different device placements and it seems like a GPU-only bug for tf.float32 tensors. Maybe someone else can try with GPU placement and see if they can reproduce the bug. See my updated dummy example below.</p>\n<pre><code>import tensorflow as tf\nimport numpy as np\nimport itertools\ntf.set_random_seed(21)\n\ndef demo_bug(np_dtype, tf_dtype, device):\n    np_arr = np.array([3, 2, 8, 1], np_dtype)\n    arr = tf.convert_to_tensor(np_arr, tf_dtype)\n    \n    with tf.device(device):\n        top_vals, top_inds = tf.nn.top_k(arr, k=3, sorted=False)\n\n    with tf.Session() as sess:\n        vals, inds = sess.run((top_vals, top_inds))\n\n    print('device:     ', device)\n    print('dtype:      ', tf_dtype.__repr__())\n    print('arr:        ', np_arr)\n    print('inds:       ', inds)\n    print('tf_vals:    ', vals)\n    print('np_vals:    ', np_arr[inds], end='\\n\\n')\n\nint_dtypes = (np.int32, tf.int32)\nfloat_dtypes = (np.float32, tf.float32)\n\ndemo_bug(*int_dtypes, '/cpu')\ndemo_bug(*float_dtypes, '/cpu')\ndemo_bug(*int_dtypes, '/gpu')\ndemo_bug(*float_dtypes, '/gpu')\n\n&gt;&gt; device:      /cpu\n&gt;&gt; dtype:       tf.int32\n&gt;&gt; arr:         [3 2 8 1]\n&gt;&gt; inds:        [1 0 2]\n&gt;&gt; tf_vals:     [2 3 8]\n&gt;&gt; np_vals:     [2 3 8]\n \n&gt;&gt; device:      /cpu\n&gt;&gt; dtype:       tf.float32\n&gt;&gt; arr:         [3. 2. 8. 1.]\n&gt;&gt; inds:        [1 0 2]\n&gt;&gt; tf_vals:     [2. 3. 8.]\n&gt;&gt; np_vals:     [2. 3. 8.]\n\n&gt;&gt; device:      /gpu\n&gt;&gt; dtype:       tf.int32\n&gt;&gt; arr:         [3 2 8 1]\n&gt;&gt; inds:        [2 0 1]\n&gt;&gt; tf_vals:     [8 3 2]\n&gt;&gt; np_vals:     [8 3 2]\n\n&gt;&gt; device:      /gpu\n&gt;&gt; dtype:       tf.float32\n&gt;&gt; arr:         [3. 2. 8. 1.]\n&gt;&gt; inds:        [2 0 1]\n&gt;&gt; tf_vals:     [2. 3. 8.]\n&gt;&gt; np_vals:     [8. 3. 2.]\n</code></pre>", "body_text": "I tried with different device placements and it seems like a GPU-only bug for tf.float32 tensors. Maybe someone else can try with GPU placement and see if they can reproduce the bug. See my updated dummy example below.\nimport tensorflow as tf\nimport numpy as np\nimport itertools\ntf.set_random_seed(21)\n\ndef demo_bug(np_dtype, tf_dtype, device):\n    np_arr = np.array([3, 2, 8, 1], np_dtype)\n    arr = tf.convert_to_tensor(np_arr, tf_dtype)\n    \n    with tf.device(device):\n        top_vals, top_inds = tf.nn.top_k(arr, k=3, sorted=False)\n\n    with tf.Session() as sess:\n        vals, inds = sess.run((top_vals, top_inds))\n\n    print('device:     ', device)\n    print('dtype:      ', tf_dtype.__repr__())\n    print('arr:        ', np_arr)\n    print('inds:       ', inds)\n    print('tf_vals:    ', vals)\n    print('np_vals:    ', np_arr[inds], end='\\n\\n')\n\nint_dtypes = (np.int32, tf.int32)\nfloat_dtypes = (np.float32, tf.float32)\n\ndemo_bug(*int_dtypes, '/cpu')\ndemo_bug(*float_dtypes, '/cpu')\ndemo_bug(*int_dtypes, '/gpu')\ndemo_bug(*float_dtypes, '/gpu')\n\n>> device:      /cpu\n>> dtype:       tf.int32\n>> arr:         [3 2 8 1]\n>> inds:        [1 0 2]\n>> tf_vals:     [2 3 8]\n>> np_vals:     [2 3 8]\n \n>> device:      /cpu\n>> dtype:       tf.float32\n>> arr:         [3. 2. 8. 1.]\n>> inds:        [1 0 2]\n>> tf_vals:     [2. 3. 8.]\n>> np_vals:     [2. 3. 8.]\n\n>> device:      /gpu\n>> dtype:       tf.int32\n>> arr:         [3 2 8 1]\n>> inds:        [2 0 1]\n>> tf_vals:     [8 3 2]\n>> np_vals:     [8 3 2]\n\n>> device:      /gpu\n>> dtype:       tf.float32\n>> arr:         [3. 2. 8. 1.]\n>> inds:        [2 0 1]\n>> tf_vals:     [2. 3. 8.]\n>> np_vals:     [8. 3. 2.]", "body": "I tried with different device placements and it seems like a GPU-only bug for tf.float32 tensors. Maybe someone else can try with GPU placement and see if they can reproduce the bug. See my updated dummy example below.\r\n\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\nimport itertools\r\ntf.set_random_seed(21)\r\n\r\ndef demo_bug(np_dtype, tf_dtype, device):\r\n    np_arr = np.array([3, 2, 8, 1], np_dtype)\r\n    arr = tf.convert_to_tensor(np_arr, tf_dtype)\r\n    \r\n    with tf.device(device):\r\n        top_vals, top_inds = tf.nn.top_k(arr, k=3, sorted=False)\r\n\r\n    with tf.Session() as sess:\r\n        vals, inds = sess.run((top_vals, top_inds))\r\n\r\n    print('device:     ', device)\r\n    print('dtype:      ', tf_dtype.__repr__())\r\n    print('arr:        ', np_arr)\r\n    print('inds:       ', inds)\r\n    print('tf_vals:    ', vals)\r\n    print('np_vals:    ', np_arr[inds], end='\\n\\n')\r\n\r\nint_dtypes = (np.int32, tf.int32)\r\nfloat_dtypes = (np.float32, tf.float32)\r\n\r\ndemo_bug(*int_dtypes, '/cpu')\r\ndemo_bug(*float_dtypes, '/cpu')\r\ndemo_bug(*int_dtypes, '/gpu')\r\ndemo_bug(*float_dtypes, '/gpu')\r\n\r\n>> device:      /cpu\r\n>> dtype:       tf.int32\r\n>> arr:         [3 2 8 1]\r\n>> inds:        [1 0 2]\r\n>> tf_vals:     [2 3 8]\r\n>> np_vals:     [2 3 8]\r\n \r\n>> device:      /cpu\r\n>> dtype:       tf.float32\r\n>> arr:         [3. 2. 8. 1.]\r\n>> inds:        [1 0 2]\r\n>> tf_vals:     [2. 3. 8.]\r\n>> np_vals:     [2. 3. 8.]\r\n\r\n>> device:      /gpu\r\n>> dtype:       tf.int32\r\n>> arr:         [3 2 8 1]\r\n>> inds:        [2 0 1]\r\n>> tf_vals:     [8 3 2]\r\n>> np_vals:     [8 3 2]\r\n\r\n>> device:      /gpu\r\n>> dtype:       tf.float32\r\n>> arr:         [3. 2. 8. 1.]\r\n>> inds:        [2 0 1]\r\n>> tf_vals:     [2. 3. 8.]\r\n>> np_vals:     [8. 3. 2.]\r\n```"}