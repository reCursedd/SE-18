{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13201", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13201/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13201/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13201/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13201", "id": 259362181, "node_id": "MDU6SXNzdWUyNTkzNjIxODE=", "number": 13201, "title": "Multiple infiniband cards support in tensorflow with RDMA", "user": {"login": "jiens", "id": 31499678, "node_id": "MDQ6VXNlcjMxNDk5Njc4", "avatar_url": "https://avatars1.githubusercontent.com/u/31499678?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jiens", "html_url": "https://github.com/jiens", "followers_url": "https://api.github.com/users/jiens/followers", "following_url": "https://api.github.com/users/jiens/following{/other_user}", "gists_url": "https://api.github.com/users/jiens/gists{/gist_id}", "starred_url": "https://api.github.com/users/jiens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jiens/subscriptions", "organizations_url": "https://api.github.com/users/jiens/orgs", "repos_url": "https://api.github.com/users/jiens/repos", "events_url": "https://api.github.com/users/jiens/events{/privacy}", "received_events_url": "https://api.github.com/users/jiens/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-09-21T03:06:53Z", "updated_at": "2017-12-12T01:26:47Z", "closed_at": "2017-12-12T01:26:47Z", "author_association": "NONE", "body_html": "<p>It seems that tensorflow with RDMA  doesn't support multiple infiniband cards now.<br>\nIt only uses the first device in the infiniband device list.<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/verbs/rdma.cc\">source rdma.cc</a></p>\n<pre><code>ibv_context* open_default_device() {\n  ibv_device** dev_list;\n  ibv_device* ib_dev;\n  dev_list = ibv_get_device_list(NULL);\n  CHECK(dev_list) &lt;&lt; \"No InfiniBand device found\";\n  ib_dev = dev_list[0];\n  CHECK(ib_dev) &lt;&lt; \"No InfiniBand device found\";\n  ibv_context* context = ibv_open_device(ib_dev);\n  CHECK(context) &lt;&lt; \"Open context failed for \" &lt;&lt; ibv_get_device_name(ib_dev);\n  return context;\n}\n</code></pre>\n<p>This will fail to communicate when there are different type infiniband cards in one node, and the order of infiniband device list is different in every node.<br>\nBesides that, user can't specify one card to use.</p>\n<p>Usually, we will specify the IP:PORT when doing the distributed training.<br>\nI think it's better to use the infiniband device which is corresponding to the IP in multiple infiniband cards environment.</p>\n<pre><code>bazel-bin/inception/imagenet_distributed_train \\\n--batch_size=32 \\\n--data_dir=/test/ILSVRC2012 \\\n--job_name='worker' \\\n--task_id=0 \\\n--ps_hosts='10.0.20.14:2276' \\\n--worker_hosts='10.0.20.15:2276,10.0.20.16:2276' \\\n--protocol='grpc+verbs'\n</code></pre>\n<p>What do you think about this?</p>", "body_text": "It seems that tensorflow with RDMA  doesn't support multiple infiniband cards now.\nIt only uses the first device in the infiniband device list.\nsource rdma.cc\nibv_context* open_default_device() {\n  ibv_device** dev_list;\n  ibv_device* ib_dev;\n  dev_list = ibv_get_device_list(NULL);\n  CHECK(dev_list) << \"No InfiniBand device found\";\n  ib_dev = dev_list[0];\n  CHECK(ib_dev) << \"No InfiniBand device found\";\n  ibv_context* context = ibv_open_device(ib_dev);\n  CHECK(context) << \"Open context failed for \" << ibv_get_device_name(ib_dev);\n  return context;\n}\n\nThis will fail to communicate when there are different type infiniband cards in one node, and the order of infiniband device list is different in every node.\nBesides that, user can't specify one card to use.\nUsually, we will specify the IP:PORT when doing the distributed training.\nI think it's better to use the infiniband device which is corresponding to the IP in multiple infiniband cards environment.\nbazel-bin/inception/imagenet_distributed_train \\\n--batch_size=32 \\\n--data_dir=/test/ILSVRC2012 \\\n--job_name='worker' \\\n--task_id=0 \\\n--ps_hosts='10.0.20.14:2276' \\\n--worker_hosts='10.0.20.15:2276,10.0.20.16:2276' \\\n--protocol='grpc+verbs'\n\nWhat do you think about this?", "body": "It seems that tensorflow with RDMA  doesn't support multiple infiniband cards now.\r\nIt only uses the first device in the infiniband device list.\r\n[source rdma.cc](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/verbs/rdma.cc)\r\n```\r\nibv_context* open_default_device() {\r\n  ibv_device** dev_list;\r\n  ibv_device* ib_dev;\r\n  dev_list = ibv_get_device_list(NULL);\r\n  CHECK(dev_list) << \"No InfiniBand device found\";\r\n  ib_dev = dev_list[0];\r\n  CHECK(ib_dev) << \"No InfiniBand device found\";\r\n  ibv_context* context = ibv_open_device(ib_dev);\r\n  CHECK(context) << \"Open context failed for \" << ibv_get_device_name(ib_dev);\r\n  return context;\r\n}\r\n```\r\nThis will fail to communicate when there are different type infiniband cards in one node, and the order of infiniband device list is different in every node.\r\nBesides that, user can't specify one card to use.\r\n\r\nUsually, we will specify the IP:PORT when doing the distributed training.\r\nI think it's better to use the infiniband device which is corresponding to the IP in multiple infiniband cards environment.\r\n```\r\nbazel-bin/inception/imagenet_distributed_train \\\r\n--batch_size=32 \\\r\n--data_dir=/test/ILSVRC2012 \\\r\n--job_name='worker' \\\r\n--task_id=0 \\\r\n--ps_hosts='10.0.20.14:2276' \\\r\n--worker_hosts='10.0.20.15:2276,10.0.20.16:2276' \\\r\n--protocol='grpc+verbs'\r\n```\r\nWhat do you think about this?"}