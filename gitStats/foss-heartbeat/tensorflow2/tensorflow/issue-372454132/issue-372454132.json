{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23159", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23159/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23159/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23159/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23159", "id": 372454132, "node_id": "MDU6SXNzdWUzNzI0NTQxMzI=", "number": 23159, "title": "Infinite run or optimizer fail", "user": {"login": "dy-octa", "id": 13358837, "node_id": "MDQ6VXNlcjEzMzU4ODM3", "avatar_url": "https://avatars2.githubusercontent.com/u/13358837?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dy-octa", "html_url": "https://github.com/dy-octa", "followers_url": "https://api.github.com/users/dy-octa/followers", "following_url": "https://api.github.com/users/dy-octa/following{/other_user}", "gists_url": "https://api.github.com/users/dy-octa/gists{/gist_id}", "starred_url": "https://api.github.com/users/dy-octa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dy-octa/subscriptions", "organizations_url": "https://api.github.com/users/dy-octa/orgs", "repos_url": "https://api.github.com/users/dy-octa/repos", "events_url": "https://api.github.com/users/dy-octa/events{/privacy}", "received_events_url": "https://api.github.com/users/dy-octa/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1097547538, "node_id": "MDU6TGFiZWwxMDk3NTQ3NTM4", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:gpu", "name": "comp:gpu", "color": "0052cc", "default": false}, {"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "open", "locked": false, "assignee": {"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-10-22T09:39:38Z", "updated_at": "2018-11-12T04:19:43Z", "closed_at": null, "author_association": "NONE", "body_html": "<p><em>Please make sure that this is a bug. As per our <a href=\"https://github.com/tensorflow/tensorflow/blob/master/ISSUES.md\">GitHub Policy</a>, we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template</em></p>\n<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes</li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04):Ubuntu 16.04</li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:N/A</li>\n<li>TensorFlow installed from (source or binary): binary</li>\n<li>TensorFlow version (use command below): 1.9.0</li>\n<li>Python version: 3.6.0</li>\n<li>Bazel version (if compiling from source): N/A</li>\n<li>GCC/Compiler version (if compiling from source): N/A</li>\n<li>CUDA/cuDNN version:9.1</li>\n<li>GPU model and memory: P100 16GB</li>\n</ul>\n<p><strong>Describe the current behavior</strong><br>\nsess.run() executes infinitely and will never return<br>\nIn the alternative version, sess.run() produces expected results but error is produced by the optimizer (see log).</p>\n<p>The bug only occurs when</p>\n<ol>\n<li>On GPU. The code executes properly on CPU.</li>\n<li>The condition of tf.cond holds False, i.e. when tf.gradients is not to be executed. Otherwise correct gradients could be calculated.</li>\n<li>There're loop structures, e.g. RNN.</li>\n</ol>\n<p><strong>Code to reproduce the issue</strong></p>\n<blockquote>\n<p>X = tf.placeholder(shape=[None, None, 10], dtype=tf.float32)<br>\nY, _ = tf.nn.bidirectional_dynamic_rnn(LSTMCell(20), LSTMCell(20), X, dtype=tf.float32)</p>\n<p>loss = tf.reduce_mean(Y)<br>\nvars = tf.trainable_variables()<br>\ngrads = tf.cond(tf.shape(X)[0] &lt; 3, lambda :tf.gradients(loss, vars), lambda :[np.nan] * len(vars))</p>\n<p>sess = tf.Session()<br>\nsess.run(tf.global_variables_initializer())<br>\nprint(sess.run(grads, feed_dict={X: np.random.random([30, 10, 10])}))</p>\n</blockquote>\n<p>Alternative version:</p>\n<blockquote>\n<p>X = tf.constant(np.random.random([30, 10, 10]), dtype=tf.float32)<br>\nY, _ = tf.nn.bidirectional_dynamic_rnn(LSTMCell(20), LSTMCell(20), X, dtype=tf.float32)</p>\n<p>loss = tf.reduce_mean(Y)<br>\nvars = tf.trainable_variables()<br>\ngrads = tf.cond(tf.shape(X)[0] &lt; 3, lambda :tf.gradients(loss, vars), lambda :[np.nan] * len(vars))</p>\n<p>sess = tf.Session()<br>\nsess.run(tf.global_variables_initializer())<br>\nprint(sess.run(grads))</p>\n</blockquote>\n<p><strong>Other info / logs</strong><br>\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.</p>\n<blockquote>\n<p>2018-10-22 17:32:36.399614: E tensorflow/core/grappler/optimizers/dependency_optimizer.cc:581] Iteration = 0, topological sort failed with message: The graph couldn't be sorted in topological order.<br>\n2018-10-22 17:32:36.401378: E tensorflow/core/grappler/optimizers/dependency_optimizer.cc:581] Iteration = 1, topological sort failed with message: The graph couldn't be sorted in topological order.</p>\n</blockquote>", "body_text": "Please make sure that this is a bug. As per our GitHub Policy, we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):Ubuntu 16.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:N/A\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.9.0\nPython version: 3.6.0\nBazel version (if compiling from source): N/A\nGCC/Compiler version (if compiling from source): N/A\nCUDA/cuDNN version:9.1\nGPU model and memory: P100 16GB\n\nDescribe the current behavior\nsess.run() executes infinitely and will never return\nIn the alternative version, sess.run() produces expected results but error is produced by the optimizer (see log).\nThe bug only occurs when\n\nOn GPU. The code executes properly on CPU.\nThe condition of tf.cond holds False, i.e. when tf.gradients is not to be executed. Otherwise correct gradients could be calculated.\nThere're loop structures, e.g. RNN.\n\nCode to reproduce the issue\n\nX = tf.placeholder(shape=[None, None, 10], dtype=tf.float32)\nY, _ = tf.nn.bidirectional_dynamic_rnn(LSTMCell(20), LSTMCell(20), X, dtype=tf.float32)\nloss = tf.reduce_mean(Y)\nvars = tf.trainable_variables()\ngrads = tf.cond(tf.shape(X)[0] < 3, lambda :tf.gradients(loss, vars), lambda :[np.nan] * len(vars))\nsess = tf.Session()\nsess.run(tf.global_variables_initializer())\nprint(sess.run(grads, feed_dict={X: np.random.random([30, 10, 10])}))\n\nAlternative version:\n\nX = tf.constant(np.random.random([30, 10, 10]), dtype=tf.float32)\nY, _ = tf.nn.bidirectional_dynamic_rnn(LSTMCell(20), LSTMCell(20), X, dtype=tf.float32)\nloss = tf.reduce_mean(Y)\nvars = tf.trainable_variables()\ngrads = tf.cond(tf.shape(X)[0] < 3, lambda :tf.gradients(loss, vars), lambda :[np.nan] * len(vars))\nsess = tf.Session()\nsess.run(tf.global_variables_initializer())\nprint(sess.run(grads))\n\nOther info / logs\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\n\n2018-10-22 17:32:36.399614: E tensorflow/core/grappler/optimizers/dependency_optimizer.cc:581] Iteration = 0, topological sort failed with message: The graph couldn't be sorted in topological order.\n2018-10-22 17:32:36.401378: E tensorflow/core/grappler/optimizers/dependency_optimizer.cc:581] Iteration = 1, topological sort failed with message: The graph couldn't be sorted in topological order.", "body": "<em>Please make sure that this is a bug. As per our [GitHub Policy](https://github.com/tensorflow/tensorflow/blob/master/ISSUES.md), we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template</em>\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04):Ubuntu 16.04\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:N/A\r\n- TensorFlow installed from (source or binary): binary\r\n- TensorFlow version (use command below): 1.9.0\r\n- Python version: 3.6.0\r\n- Bazel version (if compiling from source): N/A\r\n- GCC/Compiler version (if compiling from source): N/A\r\n- CUDA/cuDNN version:9.1\r\n- GPU model and memory: P100 16GB\r\n\r\n**Describe the current behavior**\r\nsess.run() executes infinitely and will never return\r\nIn the alternative version, sess.run() produces expected results but error is produced by the optimizer (see log).\r\n\r\nThe bug only occurs when \r\n1. On GPU. The code executes properly on CPU.\r\n2. The condition of tf.cond holds False, i.e. when tf.gradients is not to be executed. Otherwise correct gradients could be calculated.\r\n3. There're loop structures, e.g. RNN.  \r\n\r\n\r\n**Code to reproduce the issue**\r\n\r\n> X = tf.placeholder(shape=[None, None, 10], dtype=tf.float32)\r\n> Y, _ = tf.nn.bidirectional_dynamic_rnn(LSTMCell(20), LSTMCell(20), X, dtype=tf.float32)\r\n> \r\n> loss = tf.reduce_mean(Y)\r\n> vars = tf.trainable_variables()\r\n> grads = tf.cond(tf.shape(X)[0] < 3, lambda :tf.gradients(loss, vars), lambda :[np.nan] * len(vars))\r\n> \r\n> sess = tf.Session()\r\n> sess.run(tf.global_variables_initializer())\r\n> print(sess.run(grads, feed_dict={X: np.random.random([30, 10, 10])}))\r\n\r\n\r\nAlternative version:\r\n\r\n> X = tf.constant(np.random.random([30, 10, 10]), dtype=tf.float32)\r\n> Y, _ = tf.nn.bidirectional_dynamic_rnn(LSTMCell(20), LSTMCell(20), X, dtype=tf.float32)\r\n> \r\n> loss = tf.reduce_mean(Y)\r\n> vars = tf.trainable_variables()\r\n> grads = tf.cond(tf.shape(X)[0] < 3, lambda :tf.gradients(loss, vars), lambda :[np.nan] * len(vars))\r\n> \r\n> sess = tf.Session()\r\n> sess.run(tf.global_variables_initializer())\r\n> print(sess.run(grads))\r\n\r\n\r\n**Other info / logs**\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\n> 2018-10-22 17:32:36.399614: E tensorflow/core/grappler/optimizers/dependency_optimizer.cc:581] Iteration = 0, topological sort failed with message: The graph couldn't be sorted in topological order.\r\n> 2018-10-22 17:32:36.401378: E tensorflow/core/grappler/optimizers/dependency_optimizer.cc:581] Iteration = 1, topological sort failed with message: The graph couldn't be sorted in topological order.\r\n> "}