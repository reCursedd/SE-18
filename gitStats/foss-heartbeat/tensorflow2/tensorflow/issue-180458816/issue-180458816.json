{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4705", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4705/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4705/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4705/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/4705", "id": 180458816, "node_id": "MDU6SXNzdWUxODA0NTg4MTY=", "number": 4705, "title": "Error building with cuda after bazel server dies", "user": {"login": "darrengarvey", "id": 260360, "node_id": "MDQ6VXNlcjI2MDM2MA==", "avatar_url": "https://avatars0.githubusercontent.com/u/260360?v=4", "gravatar_id": "", "url": "https://api.github.com/users/darrengarvey", "html_url": "https://github.com/darrengarvey", "followers_url": "https://api.github.com/users/darrengarvey/followers", "following_url": "https://api.github.com/users/darrengarvey/following{/other_user}", "gists_url": "https://api.github.com/users/darrengarvey/gists{/gist_id}", "starred_url": "https://api.github.com/users/darrengarvey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/darrengarvey/subscriptions", "organizations_url": "https://api.github.com/users/darrengarvey/orgs", "repos_url": "https://api.github.com/users/darrengarvey/repos", "events_url": "https://api.github.com/users/darrengarvey/events{/privacy}", "received_events_url": "https://api.github.com/users/darrengarvey/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}, {"id": 284443156, "node_id": "MDU6TGFiZWwyODQ0NDMxNTY=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:docs", "name": "type:docs", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "wolffg", "id": 874510, "node_id": "MDQ6VXNlcjg3NDUxMA==", "avatar_url": "https://avatars2.githubusercontent.com/u/874510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wolffg", "html_url": "https://github.com/wolffg", "followers_url": "https://api.github.com/users/wolffg/followers", "following_url": "https://api.github.com/users/wolffg/following{/other_user}", "gists_url": "https://api.github.com/users/wolffg/gists{/gist_id}", "starred_url": "https://api.github.com/users/wolffg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wolffg/subscriptions", "organizations_url": "https://api.github.com/users/wolffg/orgs", "repos_url": "https://api.github.com/users/wolffg/repos", "events_url": "https://api.github.com/users/wolffg/events{/privacy}", "received_events_url": "https://api.github.com/users/wolffg/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wolffg", "id": 874510, "node_id": "MDQ6VXNlcjg3NDUxMA==", "avatar_url": "https://avatars2.githubusercontent.com/u/874510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wolffg", "html_url": "https://github.com/wolffg", "followers_url": "https://api.github.com/users/wolffg/followers", "following_url": "https://api.github.com/users/wolffg/following{/other_user}", "gists_url": "https://api.github.com/users/wolffg/gists{/gist_id}", "starred_url": "https://api.github.com/users/wolffg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wolffg/subscriptions", "organizations_url": "https://api.github.com/users/wolffg/orgs", "repos_url": "https://api.github.com/users/wolffg/repos", "events_url": "https://api.github.com/users/wolffg/events{/privacy}", "received_events_url": "https://api.github.com/users/wolffg/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 15, "created_at": "2016-10-01T14:18:48Z", "updated_at": "2017-06-16T18:07:28Z", "closed_at": "2017-06-16T18:07:28Z", "author_association": "CONTRIBUTOR", "body_html": "<p>This is effectively reopening <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"174105608\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/4105\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/4105/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/4105\">#4105</a> as this is another way to reproduce the issue that I am seeing repeatedly. The fix for <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"174105608\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/4105\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/4105/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/4105\">#4105</a> was to make sure after running configure clean+fetch is run.</p>\n<p>I see this issue almost every day so I'm not sure if bazel flushes some caches or the daemon is dying, but the issue reliably reproduces by killing the bazel daemon. Having to re-run configure and restart the build from scratch is unreasonable, since there is a workaround that avoids a rebuild so this looks very much like a bug.</p>\n<pre><code>$ bazel version \n.\nBuild label: 0.3.1\nBuild target: bazel-out/local-fastbuild/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar\nBuild time: Fri Jul 29 09:09:52 2016 (1469783392)\nBuild timestamp: 1469783392\nBuild timestamp as int: 1469783392\n</code></pre>\n<p>Steps to reproduce and \"fix\":</p>\n<p><em>NB</em>: $bazel_build_dir is something like <code>~/.cache/bazel/_bazel_foo/6e3dd6b174494dc75d93de11da03e7e7</code></p>\n<pre><code># Run ./configure, enabling GPU support.\n\n# The crosstool BUILD file looks good now and building with --config=cuda works\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\nlicenses([\"restricted\"])```\n\npackage(default_visibility = [\"//visibility:public\"])\n\ncc_toolchain_suite(\n    name = \"toolchain\",\n    toolchains = {\n        \"local|compiler\": \":cc-compiler-local\",\n        \"darwin|compiler\": \":cc-compiler-darwin\",\n    },\n)\n\ncc_toolchain(\n    name = \"cc-compiler-local\",\n    all_files = \":empty\",\n    compiler_files = \":empty\",\n    cpu = \"local\",\n    dwp_files = \":empty\",\n    dynamic_runtime_libs = [\":empty\"],\n    linker_files = \":empty\",\n    objcopy_files = \":empty\",\n    static_runtime_libs = [\":empty\"],\n    strip_files = \":empty\",\n    supports_param_files = 0,\n)\n\ncc_toolchain(\n    name = \"cc-compiler-darwin\",\n    all_files = \":empty\",\n    compiler_files = \":empty\",\n    cpu = \"darwin\",\n    dwp_files = \":empty\",\n    dynamic_runtime_libs = [\":empty\"],\n    linker_files = \":empty\",\n    objcopy_files = \":empty\",\n    static_runtime_libs = [\":empty\"],\n    strip_files = \":empty\",\n    supports_param_files = 0,\n)\n\nfilegroup(\n    name = \"empty\",\n    srcs = [],\n)\n\n# Backup the crosstool directory so it can be restored later\nmkdir -p /tmp/crosstool\ncp -aR $bazel_build_dir/external/local_config_cuda/crosstool/* /tmp/crosstool/\n\n# Kill bazel server.\nkill $(ps aux | awk '/baze[l]/ {print $2; exit}')\ntensorflow$ bazel build -c opt --config=cuda //tensorflow/tools/...\n.\nERROR: $bazel_build_dir/external/local_config_cuda/crosstool/BUILD:4:1: Traceback (most recent call last):\n    File \"$bazel_build_dir/external/local_config_cuda/crosstool/BUILD\", line 4\n        error_gpu_disabled()\n    File \"$bazel_build_dir/external/local_config_cuda/crosstool/error_gpu_disabled.bzl\", line 3, in error_gpu_disabled\n        fail(\"ERROR: Building with --config=c...\")\nERROR: Building with --config=cuda but TensorFlow is not configured to build with GPU support. Please re-run ./configure and enter 'Y' at the prompt to build with GPU support.\nUnhandled exception thrown during build; message: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\nINFO: Elapsed time: 0.543s\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1070)\n    at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:474)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:179)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.findCrosstoolConfiguration(CrosstoolConfigurationLoader.java:239)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.readCrosstool(CrosstoolConfigurationLoader.java:281)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.createParameters(CppConfigurationLoader.java:128)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:73)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:48)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction.compute(ConfigurationFragmentFunction.java:78)\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1016)\n    ... 4 more\nCaused by: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.packages.Package.makeNoSuchTargetException(Package.java:559)\n    at com.google.devtools.build.lib.packages.Package.getTarget(Package.java:543)\n    at com.google.devtools.build.lib.skyframe.SkyframePackageLoaderWithValueEnvironment.getTarget(SkyframePackageLoaderWithValueEnvironment.java:71)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction$ConfigurationBuilderEnvironment.getTarget(ConfigurationFragmentFunction.java:193)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:177)\n    ... 11 more\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1070)\n    at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:474)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:179)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.findCrosstoolConfiguration(CrosstoolConfigurationLoader.java:239)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.readCrosstool(CrosstoolConfigurationLoader.java:281)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.createParameters(CppConfigurationLoader.java:128)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:73)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:48)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction.compute(ConfigurationFragmentFunction.java:78)\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1016)\n    ... 4 more\nCaused by: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.packages.Package.makeNoSuchTargetException(Package.java:559)\n    at com.google.devtools.build.lib.packages.Package.getTarget(Package.java:543)\n    at com.google.devtools.build.lib.skyframe.SkyframePackageLoaderWithValueEnvironment.getTarget(SkyframePackageLoaderWithValueEnvironment.java:71)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction$ConfigurationBuilderEnvironment.getTarget(ConfigurationFragmentFunction.java:193)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:177)\n    ... 11 more\n\n# So now the crosstool dir has been trashed\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n\nload(\"//crosstool:error_gpu_disabled.bzl\", \"error_gpu_disabled\")\n\nerror_gpu_disabled()\n\n# Eh? I didn't disable it! Bazel just died...\n# Let's restore from backup\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n# And restart the bazel server... Almost... Just doing \"bazel version\" isn't enough; the server restarts but at the next build, the same issue occurs and we need to restore the crosstool directory again.\n# Running this seems to do the trick:\ntensorflow$ bazel fetch //tensorflow/...\n# But the crosstool directory has been trashed again\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n\nload(\"//crosstool:error_gpu_disabled.bzl\", \"error_gpu_disabled\")\n\nerror_gpu_disabled()\n\n# Restore once more again\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n# Now we can build fine!\n</code></pre>\n<p>In short, the workaround whenever the bazel server dies is, assuming you've backed up your crosstool directory in /tmp/crosstool/:</p>\n<pre><code>bazel fetch //tensorflow/...\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n</code></pre>\n<p>This looks like a bug to me and the resolution of <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"174105608\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/4105\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/4105/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/4105\">#4105</a> just doesn't seem related to this, it just coincidentally fixes it.</p>", "body_text": "This is effectively reopening #4105 as this is another way to reproduce the issue that I am seeing repeatedly. The fix for #4105 was to make sure after running configure clean+fetch is run.\nI see this issue almost every day so I'm not sure if bazel flushes some caches or the daemon is dying, but the issue reliably reproduces by killing the bazel daemon. Having to re-run configure and restart the build from scratch is unreasonable, since there is a workaround that avoids a rebuild so this looks very much like a bug.\n$ bazel version \n.\nBuild label: 0.3.1\nBuild target: bazel-out/local-fastbuild/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar\nBuild time: Fri Jul 29 09:09:52 2016 (1469783392)\nBuild timestamp: 1469783392\nBuild timestamp as int: 1469783392\n\nSteps to reproduce and \"fix\":\nNB: $bazel_build_dir is something like ~/.cache/bazel/_bazel_foo/6e3dd6b174494dc75d93de11da03e7e7\n# Run ./configure, enabling GPU support.\n\n# The crosstool BUILD file looks good now and building with --config=cuda works\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\nlicenses([\"restricted\"])```\n\npackage(default_visibility = [\"//visibility:public\"])\n\ncc_toolchain_suite(\n    name = \"toolchain\",\n    toolchains = {\n        \"local|compiler\": \":cc-compiler-local\",\n        \"darwin|compiler\": \":cc-compiler-darwin\",\n    },\n)\n\ncc_toolchain(\n    name = \"cc-compiler-local\",\n    all_files = \":empty\",\n    compiler_files = \":empty\",\n    cpu = \"local\",\n    dwp_files = \":empty\",\n    dynamic_runtime_libs = [\":empty\"],\n    linker_files = \":empty\",\n    objcopy_files = \":empty\",\n    static_runtime_libs = [\":empty\"],\n    strip_files = \":empty\",\n    supports_param_files = 0,\n)\n\ncc_toolchain(\n    name = \"cc-compiler-darwin\",\n    all_files = \":empty\",\n    compiler_files = \":empty\",\n    cpu = \"darwin\",\n    dwp_files = \":empty\",\n    dynamic_runtime_libs = [\":empty\"],\n    linker_files = \":empty\",\n    objcopy_files = \":empty\",\n    static_runtime_libs = [\":empty\"],\n    strip_files = \":empty\",\n    supports_param_files = 0,\n)\n\nfilegroup(\n    name = \"empty\",\n    srcs = [],\n)\n\n# Backup the crosstool directory so it can be restored later\nmkdir -p /tmp/crosstool\ncp -aR $bazel_build_dir/external/local_config_cuda/crosstool/* /tmp/crosstool/\n\n# Kill bazel server.\nkill $(ps aux | awk '/baze[l]/ {print $2; exit}')\ntensorflow$ bazel build -c opt --config=cuda //tensorflow/tools/...\n.\nERROR: $bazel_build_dir/external/local_config_cuda/crosstool/BUILD:4:1: Traceback (most recent call last):\n    File \"$bazel_build_dir/external/local_config_cuda/crosstool/BUILD\", line 4\n        error_gpu_disabled()\n    File \"$bazel_build_dir/external/local_config_cuda/crosstool/error_gpu_disabled.bzl\", line 3, in error_gpu_disabled\n        fail(\"ERROR: Building with --config=c...\")\nERROR: Building with --config=cuda but TensorFlow is not configured to build with GPU support. Please re-run ./configure and enter 'Y' at the prompt to build with GPU support.\nUnhandled exception thrown during build; message: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\nINFO: Elapsed time: 0.543s\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1070)\n    at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:474)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:179)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.findCrosstoolConfiguration(CrosstoolConfigurationLoader.java:239)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.readCrosstool(CrosstoolConfigurationLoader.java:281)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.createParameters(CppConfigurationLoader.java:128)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:73)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:48)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction.compute(ConfigurationFragmentFunction.java:78)\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1016)\n    ... 4 more\nCaused by: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.packages.Package.makeNoSuchTargetException(Package.java:559)\n    at com.google.devtools.build.lib.packages.Package.getTarget(Package.java:543)\n    at com.google.devtools.build.lib.skyframe.SkyframePackageLoaderWithValueEnvironment.getTarget(SkyframePackageLoaderWithValueEnvironment.java:71)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction$ConfigurationBuilderEnvironment.getTarget(ConfigurationFragmentFunction.java:193)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:177)\n    ... 11 more\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1070)\n    at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:474)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:179)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.findCrosstoolConfiguration(CrosstoolConfigurationLoader.java:239)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.readCrosstool(CrosstoolConfigurationLoader.java:281)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.createParameters(CppConfigurationLoader.java:128)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:73)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:48)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction.compute(ConfigurationFragmentFunction.java:78)\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1016)\n    ... 4 more\nCaused by: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.packages.Package.makeNoSuchTargetException(Package.java:559)\n    at com.google.devtools.build.lib.packages.Package.getTarget(Package.java:543)\n    at com.google.devtools.build.lib.skyframe.SkyframePackageLoaderWithValueEnvironment.getTarget(SkyframePackageLoaderWithValueEnvironment.java:71)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction$ConfigurationBuilderEnvironment.getTarget(ConfigurationFragmentFunction.java:193)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:177)\n    ... 11 more\n\n# So now the crosstool dir has been trashed\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n\nload(\"//crosstool:error_gpu_disabled.bzl\", \"error_gpu_disabled\")\n\nerror_gpu_disabled()\n\n# Eh? I didn't disable it! Bazel just died...\n# Let's restore from backup\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n# And restart the bazel server... Almost... Just doing \"bazel version\" isn't enough; the server restarts but at the next build, the same issue occurs and we need to restore the crosstool directory again.\n# Running this seems to do the trick:\ntensorflow$ bazel fetch //tensorflow/...\n# But the crosstool directory has been trashed again\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n\nload(\"//crosstool:error_gpu_disabled.bzl\", \"error_gpu_disabled\")\n\nerror_gpu_disabled()\n\n# Restore once more again\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n# Now we can build fine!\n\nIn short, the workaround whenever the bazel server dies is, assuming you've backed up your crosstool directory in /tmp/crosstool/:\nbazel fetch //tensorflow/...\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n\nThis looks like a bug to me and the resolution of #4105 just doesn't seem related to this, it just coincidentally fixes it.", "body": "This is effectively reopening #4105 as this is another way to reproduce the issue that I am seeing repeatedly. The fix for #4105 was to make sure after running configure clean+fetch is run.\n\nI see this issue almost every day so I'm not sure if bazel flushes some caches or the daemon is dying, but the issue reliably reproduces by killing the bazel daemon. Having to re-run configure and restart the build from scratch is unreasonable, since there is a workaround that avoids a rebuild so this looks very much like a bug.\n\n```\n$ bazel version \n.\nBuild label: 0.3.1\nBuild target: bazel-out/local-fastbuild/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar\nBuild time: Fri Jul 29 09:09:52 2016 (1469783392)\nBuild timestamp: 1469783392\nBuild timestamp as int: 1469783392\n```\n\nSteps to reproduce and \"fix\":\n\n_NB_: $bazel_build_dir is something like `~/.cache/bazel/_bazel_foo/6e3dd6b174494dc75d93de11da03e7e7`\n\n``````\n# Run ./configure, enabling GPU support.\n\n# The crosstool BUILD file looks good now and building with --config=cuda works\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\nlicenses([\"restricted\"])```\n\npackage(default_visibility = [\"//visibility:public\"])\n\ncc_toolchain_suite(\n    name = \"toolchain\",\n    toolchains = {\n        \"local|compiler\": \":cc-compiler-local\",\n        \"darwin|compiler\": \":cc-compiler-darwin\",\n    },\n)\n\ncc_toolchain(\n    name = \"cc-compiler-local\",\n    all_files = \":empty\",\n    compiler_files = \":empty\",\n    cpu = \"local\",\n    dwp_files = \":empty\",\n    dynamic_runtime_libs = [\":empty\"],\n    linker_files = \":empty\",\n    objcopy_files = \":empty\",\n    static_runtime_libs = [\":empty\"],\n    strip_files = \":empty\",\n    supports_param_files = 0,\n)\n\ncc_toolchain(\n    name = \"cc-compiler-darwin\",\n    all_files = \":empty\",\n    compiler_files = \":empty\",\n    cpu = \"darwin\",\n    dwp_files = \":empty\",\n    dynamic_runtime_libs = [\":empty\"],\n    linker_files = \":empty\",\n    objcopy_files = \":empty\",\n    static_runtime_libs = [\":empty\"],\n    strip_files = \":empty\",\n    supports_param_files = 0,\n)\n\nfilegroup(\n    name = \"empty\",\n    srcs = [],\n)\n\n# Backup the crosstool directory so it can be restored later\nmkdir -p /tmp/crosstool\ncp -aR $bazel_build_dir/external/local_config_cuda/crosstool/* /tmp/crosstool/\n\n# Kill bazel server.\nkill $(ps aux | awk '/baze[l]/ {print $2; exit}')\ntensorflow$ bazel build -c opt --config=cuda //tensorflow/tools/...\n.\nERROR: $bazel_build_dir/external/local_config_cuda/crosstool/BUILD:4:1: Traceback (most recent call last):\n    File \"$bazel_build_dir/external/local_config_cuda/crosstool/BUILD\", line 4\n        error_gpu_disabled()\n    File \"$bazel_build_dir/external/local_config_cuda/crosstool/error_gpu_disabled.bzl\", line 3, in error_gpu_disabled\n        fail(\"ERROR: Building with --config=c...\")\nERROR: Building with --config=cuda but TensorFlow is not configured to build with GPU support. Please re-run ./configure and enter 'Y' at the prompt to build with GPU support.\nUnhandled exception thrown during build; message: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\nINFO: Elapsed time: 0.543s\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1070)\n    at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:474)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:179)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.findCrosstoolConfiguration(CrosstoolConfigurationLoader.java:239)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.readCrosstool(CrosstoolConfigurationLoader.java:281)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.createParameters(CppConfigurationLoader.java:128)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:73)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:48)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction.compute(ConfigurationFragmentFunction.java:78)\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1016)\n    ... 4 more\nCaused by: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.packages.Package.makeNoSuchTargetException(Package.java:559)\n    at com.google.devtools.build.lib.packages.Package.getTarget(Package.java:543)\n    at com.google.devtools.build.lib.skyframe.SkyframePackageLoaderWithValueEnvironment.getTarget(SkyframePackageLoaderWithValueEnvironment.java:71)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction$ConfigurationBuilderEnvironment.getTarget(ConfigurationFragmentFunction.java:193)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:177)\n    ... 11 more\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@808aaea9' (requested by nodes 'CONFIGURATION_COLLECTION:com.google.devtools.build.lib.skyframe.ConfigurationCollectionValue$ConfigurationCollectionKey@9a9c82e5', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@66ba3b8e', 'CONFIGURATION_FRAGMENT:com.google.devtools.build.lib.skyframe.ConfigurationFragmentValue$ConfigurationFragmentKey@97095481')\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1070)\n    at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:474)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:179)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.findCrosstoolConfiguration(CrosstoolConfigurationLoader.java:239)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.readCrosstool(CrosstoolConfigurationLoader.java:281)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.createParameters(CppConfigurationLoader.java:128)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:73)\n    at com.google.devtools.build.lib.rules.cpp.CppConfigurationLoader.create(CppConfigurationLoader.java:48)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction.compute(ConfigurationFragmentFunction.java:78)\n    at com.google.devtools.build.skyframe.ParallelEvaluator$Evaluate.run(ParallelEvaluator.java:1016)\n    ... 4 more\nCaused by: com.google.devtools.build.lib.packages.NoSuchTargetException: no such target '@local_config_cuda//crosstool:toolchain': target 'toolchain' not declared in package 'crosstool' defined by $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n    at com.google.devtools.build.lib.packages.Package.makeNoSuchTargetException(Package.java:559)\n    at com.google.devtools.build.lib.packages.Package.getTarget(Package.java:543)\n    at com.google.devtools.build.lib.skyframe.SkyframePackageLoaderWithValueEnvironment.getTarget(SkyframePackageLoaderWithValueEnvironment.java:71)\n    at com.google.devtools.build.lib.skyframe.ConfigurationFragmentFunction$ConfigurationBuilderEnvironment.getTarget(ConfigurationFragmentFunction.java:193)\n    at com.google.devtools.build.lib.rules.cpp.CrosstoolConfigurationLoader.getCrosstoolProtofromBuildFile(CrosstoolConfigurationLoader.java:177)\n    ... 11 more\n\n# So now the crosstool dir has been trashed\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n\nload(\"//crosstool:error_gpu_disabled.bzl\", \"error_gpu_disabled\")\n\nerror_gpu_disabled()\n\n# Eh? I didn't disable it! Bazel just died...\n# Let's restore from backup\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n# And restart the bazel server... Almost... Just doing \"bazel version\" isn't enough; the server restarts but at the next build, the same issue occurs and we need to restore the crosstool directory again.\n# Running this seems to do the trick:\ntensorflow$ bazel fetch //tensorflow/...\n# But the crosstool directory has been trashed again\ntensorflow$ cat $bazel_build_dir/external/local_config_cuda/crosstool/BUILD\n\nload(\"//crosstool:error_gpu_disabled.bzl\", \"error_gpu_disabled\")\n\nerror_gpu_disabled()\n\n# Restore once more again\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n# Now we can build fine!\n``````\n\nIn short, the workaround whenever the bazel server dies is, assuming you've backed up your crosstool directory in /tmp/crosstool/:\n\n```\nbazel fetch //tensorflow/...\ncp -aR /tmp/crosstool/* $bazel_build_dir/external/local_config_cuda/crosstool/\n```\n\nThis looks like a bug to me and the resolution of #4105 just doesn't seem related to this, it just coincidentally fixes it.\n"}