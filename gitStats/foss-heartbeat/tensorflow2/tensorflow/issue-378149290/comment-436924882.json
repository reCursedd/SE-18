{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/436924882", "html_url": "https://github.com/tensorflow/tensorflow/issues/23576#issuecomment-436924882", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23576", "id": 436924882, "node_id": "MDEyOklzc3VlQ29tbWVudDQzNjkyNDg4Mg==", "user": {"login": "kamwoh", "id": 17477159, "node_id": "MDQ6VXNlcjE3NDc3MTU5", "avatar_url": "https://avatars0.githubusercontent.com/u/17477159?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kamwoh", "html_url": "https://github.com/kamwoh", "followers_url": "https://api.github.com/users/kamwoh/followers", "following_url": "https://api.github.com/users/kamwoh/following{/other_user}", "gists_url": "https://api.github.com/users/kamwoh/gists{/gist_id}", "starred_url": "https://api.github.com/users/kamwoh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kamwoh/subscriptions", "organizations_url": "https://api.github.com/users/kamwoh/orgs", "repos_url": "https://api.github.com/users/kamwoh/repos", "events_url": "https://api.github.com/users/kamwoh/events{/privacy}", "received_events_url": "https://api.github.com/users/kamwoh/received_events", "type": "User", "site_admin": false}, "created_at": "2018-11-08T09:13:58Z", "updated_at": "2018-11-08T09:14:46Z", "author_association": "NONE", "body_html": "<p>I debug my code one line by one line by checking which tensor have error output, then i found out this</p>\n<pre><code># conf_data is [1, num_priors, 2] -&gt; [1, 42082, 2]\nconf_preds = tf.reshape(conf_data, (num_priors, self.num_classes)) # -&gt; [42082, 2]\nprint(conf_preds)\nconf_preds = tf.transpose(conf_preds, (1, 0)) -&gt; [2, 42082]\nprint(conf_preds)\nconf_preds = tf.nn.softmax(conf_preds, 0) \nreturn tf.identify(conf_preds, name='output')\n# ...more codes...\n</code></pre>\n<p>then i get <code>Check failed: array_copy_size[0] != 0 (0 vs. 0)</code></p>\n<p>when i change axis of softmax to 1 <code>tf.nn.softmax(conf_preds, 1)</code> , then i get <code>Check failed: axis &lt; input_shape.dimensions_count() (97288360 vs. 3)</code></p>\n<p>when i remove the softmax line, then i get <code>axis &lt; input_shape.dimensions_count() (71013160 vs. 3)</code></p>\n<p>I don't really understand why removing softmax will have different dimensions_count (which output is <code>tf.transpose</code>)</p>\n<p>when i remove the transpose line (which output is <code>tf.reshape</code>)</p>\n<p>then tflite convert successful.</p>\n<p>hope my information can help debugging.</p>\n<p>code to reproduce the error</p>\n<pre><code>import tensorflow as tf\nimport numpy as np\n\nclass TestModel(object):\n    def __init__(self):\n        self.conv1 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 32, 32\n        self.maxpool1 = tf.layers.MaxPooling2D(2, 2)  # 16, 16\n\n        self.conv2 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 16, 16\n        self.maxpool2 = tf.layers.MaxPooling2D(2, 2)  # 8, 8\n\n        self.conv3 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 8, 8\n        self.maxpool3 = tf.layers.MaxPooling2D(2, 2)  # 4, 4\n\n        self.flatten = tf.layers.Flatten()\n        self.fc1 = tf.layers.Dense(10)\n\n    def __call__(self, input_placeholder):\n        out = self.conv1(input_placeholder)\n        out = self.maxpool1(out)\n        out = self.conv2(out)\n        out = self.maxpool2(out)\n        out = self.conv3(out)\n        out = self.maxpool3(out)\n        out = self.flatten(out)\n        out = self.fc1(out)\n        out = tf.concat((out, out), 1)\n        print(out)\n        out = tf.reshape(out, (10, 2))\n        print(out)\n        out = tf.transpose(out, (1, 0))\n        print(out)\n        out = tf.nn.softmax(out, 0)\n        print(out)\n        out = tf.identity(out, name='output')\n        return out\n\n\nclass TestRunner(object):\n    def __init__(self):\n        self.graph = tf.Graph()\n        self.sess = tf.Session(graph=self.graph)\n\n        with self.graph.as_default():\n            with self.sess.as_default():\n                self.model = TestModel()\n                self.input_placeholder = tf.placeholder(tf.float32, (1, 32, 32, 3), name='input')\n                self.output_node = self.model(self.input_placeholder)\n\n                self.sess.run(tf.global_variables_initializer())\n\n    def test_convert_tflite(self):\n        print('loading from session')\n        converter = tf.contrib.lite.TocoConverter.from_session(self.sess, [self.input_placeholder], [self.output_node])\n        print('converting to tflite')\n        tflite_model = converter.convert()\n        # print(tflite_model)\n\n\n    def test_run(self):\n        inputs = np.random.randn(1, 32, 32, 3)\n        outputs = self.sess.run(self.output_node, feed_dict={self.input_placeholder: inputs})\n        print(outputs.shape)\n\n\nif __name__ == '__main__':\n    tr = TestRunner()\n    tr.test_run()\n    tr.test_convert_tflite()\n</code></pre>\n<p>output</p>\n<p>RuntimeError: TOCO failed see console for info.<br>\nb'2018-11-08 17:12:34.536423: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 45 operators, 79 arrays (0 quantized)\\n2018-11-08 17:12:34.536829: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 45 operators, 79 arrays (0 quantized)\\n2018-11-08 17:12:34.537445: F tensorflow/contrib/lite/toco/graph_transformations/resolve_constant_concatenation.cc:53] Check failed: array_copy_size[0] != 0 (0 vs. 0)\\nAborted (core dumped)\\n'<br>\nNone</p>", "body_text": "I debug my code one line by one line by checking which tensor have error output, then i found out this\n# conf_data is [1, num_priors, 2] -> [1, 42082, 2]\nconf_preds = tf.reshape(conf_data, (num_priors, self.num_classes)) # -> [42082, 2]\nprint(conf_preds)\nconf_preds = tf.transpose(conf_preds, (1, 0)) -> [2, 42082]\nprint(conf_preds)\nconf_preds = tf.nn.softmax(conf_preds, 0) \nreturn tf.identify(conf_preds, name='output')\n# ...more codes...\n\nthen i get Check failed: array_copy_size[0] != 0 (0 vs. 0)\nwhen i change axis of softmax to 1 tf.nn.softmax(conf_preds, 1) , then i get Check failed: axis < input_shape.dimensions_count() (97288360 vs. 3)\nwhen i remove the softmax line, then i get axis < input_shape.dimensions_count() (71013160 vs. 3)\nI don't really understand why removing softmax will have different dimensions_count (which output is tf.transpose)\nwhen i remove the transpose line (which output is tf.reshape)\nthen tflite convert successful.\nhope my information can help debugging.\ncode to reproduce the error\nimport tensorflow as tf\nimport numpy as np\n\nclass TestModel(object):\n    def __init__(self):\n        self.conv1 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 32, 32\n        self.maxpool1 = tf.layers.MaxPooling2D(2, 2)  # 16, 16\n\n        self.conv2 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 16, 16\n        self.maxpool2 = tf.layers.MaxPooling2D(2, 2)  # 8, 8\n\n        self.conv3 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 8, 8\n        self.maxpool3 = tf.layers.MaxPooling2D(2, 2)  # 4, 4\n\n        self.flatten = tf.layers.Flatten()\n        self.fc1 = tf.layers.Dense(10)\n\n    def __call__(self, input_placeholder):\n        out = self.conv1(input_placeholder)\n        out = self.maxpool1(out)\n        out = self.conv2(out)\n        out = self.maxpool2(out)\n        out = self.conv3(out)\n        out = self.maxpool3(out)\n        out = self.flatten(out)\n        out = self.fc1(out)\n        out = tf.concat((out, out), 1)\n        print(out)\n        out = tf.reshape(out, (10, 2))\n        print(out)\n        out = tf.transpose(out, (1, 0))\n        print(out)\n        out = tf.nn.softmax(out, 0)\n        print(out)\n        out = tf.identity(out, name='output')\n        return out\n\n\nclass TestRunner(object):\n    def __init__(self):\n        self.graph = tf.Graph()\n        self.sess = tf.Session(graph=self.graph)\n\n        with self.graph.as_default():\n            with self.sess.as_default():\n                self.model = TestModel()\n                self.input_placeholder = tf.placeholder(tf.float32, (1, 32, 32, 3), name='input')\n                self.output_node = self.model(self.input_placeholder)\n\n                self.sess.run(tf.global_variables_initializer())\n\n    def test_convert_tflite(self):\n        print('loading from session')\n        converter = tf.contrib.lite.TocoConverter.from_session(self.sess, [self.input_placeholder], [self.output_node])\n        print('converting to tflite')\n        tflite_model = converter.convert()\n        # print(tflite_model)\n\n\n    def test_run(self):\n        inputs = np.random.randn(1, 32, 32, 3)\n        outputs = self.sess.run(self.output_node, feed_dict={self.input_placeholder: inputs})\n        print(outputs.shape)\n\n\nif __name__ == '__main__':\n    tr = TestRunner()\n    tr.test_run()\n    tr.test_convert_tflite()\n\noutput\nRuntimeError: TOCO failed see console for info.\nb'2018-11-08 17:12:34.536423: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 45 operators, 79 arrays (0 quantized)\\n2018-11-08 17:12:34.536829: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 45 operators, 79 arrays (0 quantized)\\n2018-11-08 17:12:34.537445: F tensorflow/contrib/lite/toco/graph_transformations/resolve_constant_concatenation.cc:53] Check failed: array_copy_size[0] != 0 (0 vs. 0)\\nAborted (core dumped)\\n'\nNone", "body": "I debug my code one line by one line by checking which tensor have error output, then i found out this\r\n\r\n```\r\n# conf_data is [1, num_priors, 2] -> [1, 42082, 2]\r\nconf_preds = tf.reshape(conf_data, (num_priors, self.num_classes)) # -> [42082, 2]\r\nprint(conf_preds)\r\nconf_preds = tf.transpose(conf_preds, (1, 0)) -> [2, 42082]\r\nprint(conf_preds)\r\nconf_preds = tf.nn.softmax(conf_preds, 0) \r\nreturn tf.identify(conf_preds, name='output')\r\n# ...more codes...\r\n```\r\nthen i get `Check failed: array_copy_size[0] != 0 (0 vs. 0)`\r\n\r\nwhen i change axis of softmax to 1 `tf.nn.softmax(conf_preds, 1)` , then i get `Check failed: axis < input_shape.dimensions_count() (97288360 vs. 3)`\r\n\r\nwhen i remove the softmax line, then i get `axis < input_shape.dimensions_count() (71013160 vs. 3)`\r\n\r\nI don't really understand why removing softmax will have different dimensions_count (which output is `tf.transpose`)\r\n\r\nwhen i remove the transpose line (which output is `tf.reshape`)\r\n\r\nthen tflite convert successful.\r\n\r\nhope my information can help debugging.\r\n\r\ncode to reproduce the error\r\n\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\n\r\nclass TestModel(object):\r\n    def __init__(self):\r\n        self.conv1 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 32, 32\r\n        self.maxpool1 = tf.layers.MaxPooling2D(2, 2)  # 16, 16\r\n\r\n        self.conv2 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 16, 16\r\n        self.maxpool2 = tf.layers.MaxPooling2D(2, 2)  # 8, 8\r\n\r\n        self.conv3 = tf.layers.Conv2D(64, 3, padding='same', activation='relu')  # 8, 8\r\n        self.maxpool3 = tf.layers.MaxPooling2D(2, 2)  # 4, 4\r\n\r\n        self.flatten = tf.layers.Flatten()\r\n        self.fc1 = tf.layers.Dense(10)\r\n\r\n    def __call__(self, input_placeholder):\r\n        out = self.conv1(input_placeholder)\r\n        out = self.maxpool1(out)\r\n        out = self.conv2(out)\r\n        out = self.maxpool2(out)\r\n        out = self.conv3(out)\r\n        out = self.maxpool3(out)\r\n        out = self.flatten(out)\r\n        out = self.fc1(out)\r\n        out = tf.concat((out, out), 1)\r\n        print(out)\r\n        out = tf.reshape(out, (10, 2))\r\n        print(out)\r\n        out = tf.transpose(out, (1, 0))\r\n        print(out)\r\n        out = tf.nn.softmax(out, 0)\r\n        print(out)\r\n        out = tf.identity(out, name='output')\r\n        return out\r\n\r\n\r\nclass TestRunner(object):\r\n    def __init__(self):\r\n        self.graph = tf.Graph()\r\n        self.sess = tf.Session(graph=self.graph)\r\n\r\n        with self.graph.as_default():\r\n            with self.sess.as_default():\r\n                self.model = TestModel()\r\n                self.input_placeholder = tf.placeholder(tf.float32, (1, 32, 32, 3), name='input')\r\n                self.output_node = self.model(self.input_placeholder)\r\n\r\n                self.sess.run(tf.global_variables_initializer())\r\n\r\n    def test_convert_tflite(self):\r\n        print('loading from session')\r\n        converter = tf.contrib.lite.TocoConverter.from_session(self.sess, [self.input_placeholder], [self.output_node])\r\n        print('converting to tflite')\r\n        tflite_model = converter.convert()\r\n        # print(tflite_model)\r\n\r\n\r\n    def test_run(self):\r\n        inputs = np.random.randn(1, 32, 32, 3)\r\n        outputs = self.sess.run(self.output_node, feed_dict={self.input_placeholder: inputs})\r\n        print(outputs.shape)\r\n\r\n\r\nif __name__ == '__main__':\r\n    tr = TestRunner()\r\n    tr.test_run()\r\n    tr.test_convert_tflite()\r\n```\r\noutput\r\n\r\nRuntimeError: TOCO failed see console for info.\r\nb'2018-11-08 17:12:34.536423: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 45 operators, 79 arrays (0 quantized)\\n2018-11-08 17:12:34.536829: I tensorflow/contrib/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 45 operators, 79 arrays (0 quantized)\\n2018-11-08 17:12:34.537445: F tensorflow/contrib/lite/toco/graph_transformations/resolve_constant_concatenation.cc:53] Check failed: array_copy_size[0] != 0 (0 vs. 0)\\nAborted (core dumped)\\n'\r\nNone\r\n"}