{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7397", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7397/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7397/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7397/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/7397", "id": 206600235, "node_id": "MDU6SXNzdWUyMDY2MDAyMzU=", "number": 7397, "title": "`tf.dynamic_stitch` gradient is incorrect", "user": {"login": "drasmuss", "id": 1952220, "node_id": "MDQ6VXNlcjE5NTIyMjA=", "avatar_url": "https://avatars1.githubusercontent.com/u/1952220?v=4", "gravatar_id": "", "url": "https://api.github.com/users/drasmuss", "html_url": "https://github.com/drasmuss", "followers_url": "https://api.github.com/users/drasmuss/followers", "following_url": "https://api.github.com/users/drasmuss/following{/other_user}", "gists_url": "https://api.github.com/users/drasmuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/drasmuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/drasmuss/subscriptions", "organizations_url": "https://api.github.com/users/drasmuss/orgs", "repos_url": "https://api.github.com/users/drasmuss/repos", "events_url": "https://api.github.com/users/drasmuss/events{/privacy}", "received_events_url": "https://api.github.com/users/drasmuss/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-02-09T19:09:54Z", "updated_at": "2017-03-06T16:22:28Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<h3>If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)</h3>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\nx <span class=\"pl-k\">=</span> tf.zeros((<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>))\ny <span class=\"pl-k\">=</span> tf.dynamic_stitch([[<span class=\"pl-c1\">0</span>], [<span class=\"pl-c1\">0</span>]], [x, tf.ones((<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>))])\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>y<span class=\"pl-pds\">\"</span></span>)\n    <span class=\"pl-c1\">print</span>(sess.run(y))\n\n    analytic, numeric <span class=\"pl-k\">=</span> tf.test.compute_gradient(x, (<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>), y, (<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>))\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>analytic<span class=\"pl-pds\">\"</span></span>)\n    <span class=\"pl-c1\">print</span>(analytic)\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>numeric<span class=\"pl-pds\">\"</span></span>)\n    <span class=\"pl-c1\">print</span>(numeric)</pre></div>\n<p>gives output</p>\n<pre><code>y\n[[ 1.  1.  1.]]\nanalytic\n[[ 1.  0.  0.]\n [ 0.  1.  0.]\n [ 0.  0.  1.]]\nnumeric\n[[ 0.  0.  0.]\n [ 0.  0.  0.]\n [ 0.  0.  0.]]\n</code></pre>\n<p>The numeric gradient correctly shows that <code>x</code> has no impact on <code>y</code> (since the value of <code>x</code> is completely overwritten by a constant in the <code>dynamic_stitch</code>).  The analytic gradient is incorrect; it seems like the gradient calculation in <code>dynamic_stitch</code> does not handle the case where there are duplicate indices being merged.</p>", "body_text": "If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\nimport tensorflow as tf\n\nx = tf.zeros((1, 3))\ny = tf.dynamic_stitch([[0], [0]], [x, tf.ones((1, 3))])\n\nwith tf.Session() as sess:\n    print(\"y\")\n    print(sess.run(y))\n\n    analytic, numeric = tf.test.compute_gradient(x, (1, 3), y, (1, 3))\n    print(\"analytic\")\n    print(analytic)\n    print(\"numeric\")\n    print(numeric)\ngives output\ny\n[[ 1.  1.  1.]]\nanalytic\n[[ 1.  0.  0.]\n [ 0.  1.  0.]\n [ 0.  0.  1.]]\nnumeric\n[[ 0.  0.  0.]\n [ 0.  0.  0.]\n [ 0.  0.  0.]]\n\nThe numeric gradient correctly shows that x has no impact on y (since the value of x is completely overwritten by a constant in the dynamic_stitch).  The analytic gradient is incorrect; it seems like the gradient calculation in dynamic_stitch does not handle the case where there are duplicate indices being merged.", "body": "### If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\r\n``` python\r\nimport tensorflow as tf\r\n\r\nx = tf.zeros((1, 3))\r\ny = tf.dynamic_stitch([[0], [0]], [x, tf.ones((1, 3))])\r\n\r\nwith tf.Session() as sess:\r\n    print(\"y\")\r\n    print(sess.run(y))\r\n\r\n    analytic, numeric = tf.test.compute_gradient(x, (1, 3), y, (1, 3))\r\n    print(\"analytic\")\r\n    print(analytic)\r\n    print(\"numeric\")\r\n    print(numeric)\r\n```\r\n\r\ngives output\r\n```\r\ny\r\n[[ 1.  1.  1.]]\r\nanalytic\r\n[[ 1.  0.  0.]\r\n [ 0.  1.  0.]\r\n [ 0.  0.  1.]]\r\nnumeric\r\n[[ 0.  0.  0.]\r\n [ 0.  0.  0.]\r\n [ 0.  0.  0.]]\r\n```\r\n\r\nThe numeric gradient correctly shows that `x` has no impact on `y` (since the value of `x` is completely overwritten by a constant in the `dynamic_stitch`).  The analytic gradient is incorrect; it seems like the gradient calculation in `dynamic_stitch` does not handle the case where there are duplicate indices being merged.\r\n"}