{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/432947341", "html_url": "https://github.com/tensorflow/tensorflow/issues/23179#issuecomment-432947341", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23179", "id": 432947341, "node_id": "MDEyOklzc3VlQ29tbWVudDQzMjk0NzM0MQ==", "user": {"login": "delock", "id": 19373651, "node_id": "MDQ6VXNlcjE5MzczNjUx", "avatar_url": "https://avatars2.githubusercontent.com/u/19373651?v=4", "gravatar_id": "", "url": "https://api.github.com/users/delock", "html_url": "https://github.com/delock", "followers_url": "https://api.github.com/users/delock/followers", "following_url": "https://api.github.com/users/delock/following{/other_user}", "gists_url": "https://api.github.com/users/delock/gists{/gist_id}", "starred_url": "https://api.github.com/users/delock/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/delock/subscriptions", "organizations_url": "https://api.github.com/users/delock/orgs", "repos_url": "https://api.github.com/users/delock/repos", "events_url": "https://api.github.com/users/delock/events{/privacy}", "received_events_url": "https://api.github.com/users/delock/received_events", "type": "User", "site_admin": false}, "created_at": "2018-10-25T07:40:31Z", "updated_at": "2018-10-25T07:40:31Z", "author_association": "NONE", "body_html": "<p>A more complete test case that use the sampling dataset I implemented locally.  I kinda of magnify the problem by set rate to 0.01, instead of 0.05</p>\n<pre><code>import tensorflow as tf                                                           \nimport time                                                                       \n                                                                                  \nrate = 0.01                                                                       \n                                                                                  \ndatasetS = tf.data.Dataset.range(10000)                                           \ndatasetS = datasetS.repeat()                                                      \ndatasetS = datasetS.sampling(rate)                                                \ndatasetS = datasetS.shuffle(buffer_size=100000)                                   \n                                                                                  \ndatasetF = tf.data.Dataset.range(10000)                                           \ndatasetF = datasetF.repeat()                                                      \ndatasetF = datasetF.filter(lambda x: tf.less(tf.random_uniform([1]), rate)[0])    \ndatasetF = datasetF.shuffle(buffer_size=100000)                                   \n                                                                                  \nwith tf.Session() as sess:                                                        \n    valueS = datasetS.make_one_shot_iterator().get_next()                         \n    valueF = datasetF.make_one_shot_iterator().get_next()                         \n    print (\"run with sampling dataset\")                                           \n    start = time.time()                                                           \n    sess.run(valueS)                                                              \n    end = time.time()                                                             \n    print (\"%f seconds\"%(end-start))                                              \n    start = time.time()                                                           \n    print (\"run with filter dataset\")                                             \n    sess.run(valueF)                                                              \n    end = time.time()                                                             \n    print (\"%f seconds\"%(end-start))                                              \n\n</code></pre>\n<p>The output shows sampling dataset op would be 47x faster than use a filter dataset op to do the job.</p>\n<pre><code>2018-10-25 15:20:41.554439: I tensorflow/core/common_runtime/process_util.cc:69] Creating new thread pool with default inter op setting: 2. Tune using inter_op_parallelism_threads for best performance.        \nrun with sampling dataset\n3.914848 seconds\nrun with filter dataset\n2018-10-25 15:20:55.497627: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 5451 of 100000                                                           \n2018-10-25 15:21:05.498753: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 10959 of 100000                                                          \n2018-10-25 15:21:15.498401: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 16433 of 100000                                                          \n2018-10-25 15:21:25.498502: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 21692 of 100000                                                          \n2018-10-25 15:21:35.497819: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 27089 of 100000                                                          \n2018-10-25 15:21:45.500435: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 32521 of 100000                                                          \n2018-10-25 15:21:55.500459: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 37949 of 100000                                                          \n2018-10-25 15:22:05.499758: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 43421 of 100000                                                          \n2018-10-25 15:22:15.497833: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 48904 of 100000                                                          \n2018-10-25 15:22:25.508743: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 54146 of 100000                                                          \n2018-10-25 15:22:35.500528: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 59416 of 100000                                                          \n2018-10-25 15:22:45.498792: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 64705 of 100000                                                          \n2018-10-25 15:22:55.500804: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 69902 of 100000                                                          \n2018-10-25 15:23:05.498479: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 75305 of 100000                                                          \n2018-10-25 15:23:15.498075: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 80657 of 100000                                                          \n2018-10-25 15:23:25.499887: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 86016 of 100000                                                          \n2018-10-25 15:23:35.500111: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 91404 of 100000                                                          \n2018-10-25 15:23:45.499380: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 96791 of 100000                                                          \n2018-10-25 15:23:51.490890: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:135] Shuffle buffer filled.\n186.004482 seconds\n\n</code></pre>", "body_text": "A more complete test case that use the sampling dataset I implemented locally.  I kinda of magnify the problem by set rate to 0.01, instead of 0.05\nimport tensorflow as tf                                                           \nimport time                                                                       \n                                                                                  \nrate = 0.01                                                                       \n                                                                                  \ndatasetS = tf.data.Dataset.range(10000)                                           \ndatasetS = datasetS.repeat()                                                      \ndatasetS = datasetS.sampling(rate)                                                \ndatasetS = datasetS.shuffle(buffer_size=100000)                                   \n                                                                                  \ndatasetF = tf.data.Dataset.range(10000)                                           \ndatasetF = datasetF.repeat()                                                      \ndatasetF = datasetF.filter(lambda x: tf.less(tf.random_uniform([1]), rate)[0])    \ndatasetF = datasetF.shuffle(buffer_size=100000)                                   \n                                                                                  \nwith tf.Session() as sess:                                                        \n    valueS = datasetS.make_one_shot_iterator().get_next()                         \n    valueF = datasetF.make_one_shot_iterator().get_next()                         \n    print (\"run with sampling dataset\")                                           \n    start = time.time()                                                           \n    sess.run(valueS)                                                              \n    end = time.time()                                                             \n    print (\"%f seconds\"%(end-start))                                              \n    start = time.time()                                                           \n    print (\"run with filter dataset\")                                             \n    sess.run(valueF)                                                              \n    end = time.time()                                                             \n    print (\"%f seconds\"%(end-start))                                              \n\n\nThe output shows sampling dataset op would be 47x faster than use a filter dataset op to do the job.\n2018-10-25 15:20:41.554439: I tensorflow/core/common_runtime/process_util.cc:69] Creating new thread pool with default inter op setting: 2. Tune using inter_op_parallelism_threads for best performance.        \nrun with sampling dataset\n3.914848 seconds\nrun with filter dataset\n2018-10-25 15:20:55.497627: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 5451 of 100000                                                           \n2018-10-25 15:21:05.498753: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 10959 of 100000                                                          \n2018-10-25 15:21:15.498401: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 16433 of 100000                                                          \n2018-10-25 15:21:25.498502: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 21692 of 100000                                                          \n2018-10-25 15:21:35.497819: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 27089 of 100000                                                          \n2018-10-25 15:21:45.500435: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 32521 of 100000                                                          \n2018-10-25 15:21:55.500459: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 37949 of 100000                                                          \n2018-10-25 15:22:05.499758: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 43421 of 100000                                                          \n2018-10-25 15:22:15.497833: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 48904 of 100000                                                          \n2018-10-25 15:22:25.508743: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 54146 of 100000                                                          \n2018-10-25 15:22:35.500528: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 59416 of 100000                                                          \n2018-10-25 15:22:45.498792: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 64705 of 100000                                                          \n2018-10-25 15:22:55.500804: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 69902 of 100000                                                          \n2018-10-25 15:23:05.498479: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 75305 of 100000                                                          \n2018-10-25 15:23:15.498075: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 80657 of 100000                                                          \n2018-10-25 15:23:25.499887: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 86016 of 100000                                                          \n2018-10-25 15:23:35.500111: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 91404 of 100000                                                          \n2018-10-25 15:23:45.499380: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 96791 of 100000                                                          \n2018-10-25 15:23:51.490890: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:135] Shuffle buffer filled.\n186.004482 seconds", "body": "A more complete test case that use the sampling dataset I implemented locally.  I kinda of magnify the problem by set rate to 0.01, instead of 0.05\r\n```\r\nimport tensorflow as tf                                                           \r\nimport time                                                                       \r\n                                                                                  \r\nrate = 0.01                                                                       \r\n                                                                                  \r\ndatasetS = tf.data.Dataset.range(10000)                                           \r\ndatasetS = datasetS.repeat()                                                      \r\ndatasetS = datasetS.sampling(rate)                                                \r\ndatasetS = datasetS.shuffle(buffer_size=100000)                                   \r\n                                                                                  \r\ndatasetF = tf.data.Dataset.range(10000)                                           \r\ndatasetF = datasetF.repeat()                                                      \r\ndatasetF = datasetF.filter(lambda x: tf.less(tf.random_uniform([1]), rate)[0])    \r\ndatasetF = datasetF.shuffle(buffer_size=100000)                                   \r\n                                                                                  \r\nwith tf.Session() as sess:                                                        \r\n    valueS = datasetS.make_one_shot_iterator().get_next()                         \r\n    valueF = datasetF.make_one_shot_iterator().get_next()                         \r\n    print (\"run with sampling dataset\")                                           \r\n    start = time.time()                                                           \r\n    sess.run(valueS)                                                              \r\n    end = time.time()                                                             \r\n    print (\"%f seconds\"%(end-start))                                              \r\n    start = time.time()                                                           \r\n    print (\"run with filter dataset\")                                             \r\n    sess.run(valueF)                                                              \r\n    end = time.time()                                                             \r\n    print (\"%f seconds\"%(end-start))                                              \r\n\r\n```\r\nThe output shows sampling dataset op would be 47x faster than use a filter dataset op to do the job.\r\n```\r\n2018-10-25 15:20:41.554439: I tensorflow/core/common_runtime/process_util.cc:69] Creating new thread pool with default inter op setting: 2. Tune using inter_op_parallelism_threads for best performance.        \r\nrun with sampling dataset\r\n3.914848 seconds\r\nrun with filter dataset\r\n2018-10-25 15:20:55.497627: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 5451 of 100000                                                           \r\n2018-10-25 15:21:05.498753: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 10959 of 100000                                                          \r\n2018-10-25 15:21:15.498401: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 16433 of 100000                                                          \r\n2018-10-25 15:21:25.498502: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 21692 of 100000                                                          \r\n2018-10-25 15:21:35.497819: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 27089 of 100000                                                          \r\n2018-10-25 15:21:45.500435: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 32521 of 100000                                                          \r\n2018-10-25 15:21:55.500459: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 37949 of 100000                                                          \r\n2018-10-25 15:22:05.499758: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 43421 of 100000                                                          \r\n2018-10-25 15:22:15.497833: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 48904 of 100000                                                          \r\n2018-10-25 15:22:25.508743: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 54146 of 100000                                                          \r\n2018-10-25 15:22:35.500528: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 59416 of 100000                                                          \r\n2018-10-25 15:22:45.498792: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 64705 of 100000                                                          \r\n2018-10-25 15:22:55.500804: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 69902 of 100000                                                          \r\n2018-10-25 15:23:05.498479: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 75305 of 100000                                                          \r\n2018-10-25 15:23:15.498075: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 80657 of 100000                                                          \r\n2018-10-25 15:23:25.499887: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 86016 of 100000                                                          \r\n2018-10-25 15:23:35.500111: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 91404 of 100000                                                          \r\n2018-10-25 15:23:45.499380: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:97] Filling up shuffle buffer (this may take a while): 96791 of 100000                                                          \r\n2018-10-25 15:23:51.490890: I tensorflow/core/kernels/data/shuffle_dataset_op.cc:135] Shuffle buffer filled.\r\n186.004482 seconds\r\n\r\n```"}