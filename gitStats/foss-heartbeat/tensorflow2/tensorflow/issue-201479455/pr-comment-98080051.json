{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/98080051", "pull_request_review_id": 18711398, "id": 98080051, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk4MDgwMDUx", "diff_hunk": "@@ -36,6 +36,161 @@ limitations under the License.\n \n namespace tensorflow {\n \n+// How many hops do we search for matching node in the backward dataflow graph?\n+// We use maxhop of 10 based on empirical observations. Also, these are\n+// maxhops in backward data-flow graph. Since input of forward nodes (Conv2D)\n+// directly goes to backward nodes, we do not expect the hop-distance\n+// would be more than few nodes.\n+static size_t kNodeMergeContextMaxDepth = 10;\n+\n+// This optimization pass performs two tasks: merge\n+// nodes in the forward pass, and rewrite the gradient ops\n+// corresponding to merged forward ops.\n+//\n+// Merging nodes in the graph: Currently, it merges Conv2D+AddBias together.\n+//\n+// Rewriting nodes in the graph: This is neded in order to optimize\n+// gradient ops of Conv2D+AddBias. Gradient op of both the Conv2D and\n+// MatMul is BiasAddGrad, and we need to rewrite BiasAddGrad into\n+// Conv2D-specific BiasAddGrad, and MatMul-specific BiasAddGrad.\n+// This is context-specific optimization, where the context is the\n+// forward operator that the BiasAddGrad corresponds to.\n+class NodeMergeRewritePass : public GraphOptimizationPass {\n+ public:\n+  NodeMergeRewritePass() {\n+    csinfo_.conv2d                     = \"Conv2D\";\n+    csinfo_.conv2dwithbias             = \"Conv2DWithBias\";\n+    csinfo_.conv2dwithbiasbackpropbias = \"Conv2DWithBiasBackpropBias\";\n+    csinfo_.biasadd                    = \"BiasAdd\";\n+    csinfo_.matmul                     = \"MatMul\";\n+    csinfo_.biasaddgrad                = \"BiasAddGrad\";\n+\n+    minfo_.push_back({csinfo_.conv2d, csinfo_.biasadd, 0,\n+                      csinfo_.conv2dwithbias});\n+\n+    // We use maxhop of 10 based on emperical observations. Also, these are\n+    // maxhops in backward data-flow graph. Since input of forward nodes\n+    // (Conv2D) directly goes to backward nodes, we do not expect the\n+    // hop-distance would be more than few nodes.\n+    rinfo_.push_back({csinfo_.biasaddgrad, csinfo_.conv2dwithbiasbackpropbias,\n+                  {csinfo_.conv2dwithbias, kNodeMergeContextMaxDepth}});\n+    rinfo_.push_back({csinfo_.biasaddgrad, csinfo_.conv2dwithbiasbackpropbias,\n+                  {csinfo_.conv2d, kNodeMergeContextMaxDepth}});\n+    // For now, we are rewriting BiasAddGrad to BiasAddGrad for MatMul. This is\n+    // because we do not have a separate Op for MatMulwithBias.\n+    rinfo_.push_back({csinfo_.biasaddgrad, csinfo_.biasaddgrad,\n+                      {csinfo_.matmul, kNodeMergeContextMaxDepth}});\n+  }\n+\n+  // Standard interface to run optimization pass\n+  Status Run(const GraphOptimizationPassOptions& options);\n+\n+  // Helper function which does most of heavy lifting for node merge\n+  //\n+  // Extracts common functionality between Run public interface and\n+  // test interface.\n+  //\n+  // @return true, if and only if graph is mutated; false otherwise.\n+  bool RunNodeMergeRewritePass(std::unique_ptr<Graph>* g);", "path": "tensorflow/core/graph/mkl_optimizer_merge.cc", "position": null, "original_position": 68, "commit_id": "59ce7353e2e69a03eb65c7953b0c1e970b1a465b", "original_commit_id": "045e26a166cee9ecdd5232138655cbea876b6096", "user": {"login": "andydavis1", "id": 15696327, "node_id": "MDQ6VXNlcjE1Njk2MzI3", "avatar_url": "https://avatars0.githubusercontent.com/u/15696327?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andydavis1", "html_url": "https://github.com/andydavis1", "followers_url": "https://api.github.com/users/andydavis1/followers", "following_url": "https://api.github.com/users/andydavis1/following{/other_user}", "gists_url": "https://api.github.com/users/andydavis1/gists{/gist_id}", "starred_url": "https://api.github.com/users/andydavis1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andydavis1/subscriptions", "organizations_url": "https://api.github.com/users/andydavis1/orgs", "repos_url": "https://api.github.com/users/andydavis1/repos", "events_url": "https://api.github.com/users/andydavis1/events{/privacy}", "received_events_url": "https://api.github.com/users/andydavis1/received_events", "type": "User", "site_admin": false}, "body": "nit-pick: I think this method name doesn't need to repeat the name of the class. Maybe just \"Run\" or \"RunOnGraph\".", "created_at": "2017-01-26T20:05:14Z", "updated_at": "2017-02-03T22:04:44Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/6921#discussion_r98080051", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/6921", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/98080051"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/6921#discussion_r98080051"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/6921"}}, "body_html": "<p>nit-pick: I think this method name doesn't need to repeat the name of the class. Maybe just \"Run\" or \"RunOnGraph\".</p>", "body_text": "nit-pick: I think this method name doesn't need to repeat the name of the class. Maybe just \"Run\" or \"RunOnGraph\"."}