{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/225777755", "pull_request_review_id": 165451042, "id": 225777755, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNTc3Nzc1NQ==", "diff_hunk": "@@ -2803,4 +2803,43 @@ TF_Buffer* TF_GetRegisteredKernelsForOp(const char* name, TF_Status* status) {\n   }\n   return ret;\n }\n+\n+// TF_Server functions ----------------------------------------------\n+\n+TF_Server::TF_Server(tensorflow::ServerInterface* server) : server(server) {}\n+\n+TF_Server* TF_NewServer(const void* proto, size_t proto_len,\n+                        TF_Status* status) {\n+  tensorflow::ServerDef server_def;\n+  if (!server_def.ParseFromArray(proto, static_cast<int>(proto_len))) {\n+    status->status = InvalidArgument(\"Unparseable ServerDef\");\n+    return nullptr;\n+  }\n+\n+  auto out_server = new std::unique_ptr<tensorflow::ServerInterface>();", "path": "tensorflow/c/c_api.cc", "position": null, "original_position": 17, "commit_id": "41311db125e6b5caf30c88bd3697ac7dd18e94fe", "original_commit_id": "231ef238b5e9047ce85ba30e340e09b1a21a585a", "user": {"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}, "body": "Isn't `out_server` being leaked here since the `std::unique_ptr` is being heap allocated?\r\nSee comment in `c_api_internal.h`, I think we can simplify this to:\r\n\r\n```c++\r\nstd::unique_ptr<TF_Server> ret(new TF_Server);\r\nstatus->status = tensorflow::NewServer(server_def, &ret->server);\r\nif (!status->status.ok()) return nullptr;\r\nreturn ret.release();\r\n```", "created_at": "2018-10-17T04:27:14Z", "updated_at": "2018-11-08T20:31:45Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/23022#discussion_r225777755", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/23022", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/225777755"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/23022#discussion_r225777755"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/23022"}}, "body_html": "<p>Isn't <code>out_server</code> being leaked here since the <code>std::unique_ptr</code> is being heap allocated?<br>\nSee comment in <code>c_api_internal.h</code>, I think we can simplify this to:</p>\n<div class=\"highlight highlight-source-c++\"><pre>std::unique_ptr&lt;TF_Server&gt; <span class=\"pl-en\">ret</span>(<span class=\"pl-k\">new</span> TF_Server);\nstatus-&gt;status = tensorflow::NewServer(server_def, &amp;ret-&gt;server);\n<span class=\"pl-k\">if</span> (!status-&gt;status.ok()) <span class=\"pl-k\">return</span> <span class=\"pl-c1\">nullptr</span>;\n<span class=\"pl-k\">return</span> ret.release();</pre></div>", "body_text": "Isn't out_server being leaked here since the std::unique_ptr is being heap allocated?\nSee comment in c_api_internal.h, I think we can simplify this to:\nstd::unique_ptr<TF_Server> ret(new TF_Server);\nstatus->status = tensorflow::NewServer(server_def, &ret->server);\nif (!status->status.ok()) return nullptr;\nreturn ret.release();"}