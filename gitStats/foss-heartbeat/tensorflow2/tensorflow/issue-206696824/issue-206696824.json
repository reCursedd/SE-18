{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7404", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7404/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7404/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7404/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/7404", "id": 206696824, "node_id": "MDU6SXNzdWUyMDY2OTY4MjQ=", "number": 7404, "title": "No attribute 'outer_context' when calculating gradient from imported graph", "user": {"login": "malmaud", "id": 987837, "node_id": "MDQ6VXNlcjk4NzgzNw==", "avatar_url": "https://avatars1.githubusercontent.com/u/987837?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malmaud", "html_url": "https://github.com/malmaud", "followers_url": "https://api.github.com/users/malmaud/followers", "following_url": "https://api.github.com/users/malmaud/following{/other_user}", "gists_url": "https://api.github.com/users/malmaud/gists{/gist_id}", "starred_url": "https://api.github.com/users/malmaud/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malmaud/subscriptions", "organizations_url": "https://api.github.com/users/malmaud/orgs", "repos_url": "https://api.github.com/users/malmaud/repos", "events_url": "https://api.github.com/users/malmaud/events{/privacy}", "received_events_url": "https://api.github.com/users/malmaud/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 284443156, "node_id": "MDU6TGFiZWwyODQ0NDMxNTY=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:docs", "name": "type:docs", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2017-02-10T03:14:10Z", "updated_at": "2018-06-02T12:42:25Z", "closed_at": "2018-03-29T18:11:56Z", "author_association": "CONTRIBUTOR", "body_html": "<p>It seems when you import a graph with a \"while\" loop, you can't calculate gradients as you could on the original graph. e.g.</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\ni<span class=\"pl-k\">=</span>tf.constant(<span class=\"pl-c1\">0</span>, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>input<span class=\"pl-pds\">\"</span></span>)\nout<span class=\"pl-k\">=</span>tf.while_loop(<span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">i</span>: tf.less(i,<span class=\"pl-c1\">5</span>), <span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">i</span>: [tf.add(i,<span class=\"pl-c1\">1</span>)], [i], <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>output<span class=\"pl-pds\">\"</span></span>)\ngraph_def <span class=\"pl-k\">=</span> tf.get_default_graph().as_graph_def()\n\ng <span class=\"pl-k\">=</span> tf.Graph()\n<span class=\"pl-k\">with</span> g.as_default():\n    tf.import_graph_def(graph_def)\ns <span class=\"pl-k\">=</span> tf.Session(<span class=\"pl-v\">graph</span><span class=\"pl-k\">=</span>g)\ni_imported <span class=\"pl-k\">=</span> g.get_tensor_by_name(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>import/input:0<span class=\"pl-pds\">\"</span></span>)\nout_imported <span class=\"pl-k\">=</span> g.get_tensor_by_name(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>import/output/Exit:0<span class=\"pl-pds\">\"</span></span>)\ntf.gradients(out_imported, i_imported)</pre></div>\n<pre><code>---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n&lt;ipython-input-12-e7e2b78684d3&gt; in &lt;module&gt;()\n----&gt; 1 tf.gradients(out_imported, i_imported)\n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method)\n    439     pending_count, loop_state = _PendingCount(ops.get_default_graph(), to_ops,\n    440                                               from_ops,\n--&gt; 441                                               colocate_gradients_with_ops)\n    442 \n    443     # Iterate over the collected ops.\n\n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in _PendingCount(graph, to_ops, from_ops, colocate_gradients_with_ops)\n    184   # 'loop_state' is None if there are no while loops.\n    185   loop_state = control_flow_ops.MaybeCreateControlFlowState(\n--&gt; 186       between_op_list, between_ops, colocate_gradients_with_ops)\n    187 \n    188   # Initialize pending count for between ops.\n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in MaybeCreateControlFlowState(between_op_list, between_ops, colocate_gradients_with_ops)\n   1293           loop_state.AddWhileContext(op, between_op_list, between_ops)\n   1294       else:\n-&gt; 1295         loop_state.AddWhileContext(op, between_op_list, between_ops)\n   1296   return loop_state\n   1297 \n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in AddWhileContext(self, op, between_op_list, between_ops)\n   1102     if grad_state is None:\n   1103       # This is a new while loop so create a grad state for it.\n-&gt; 1104       outer_forward_ctxt = forward_ctxt.outer_context\n   1105       if outer_forward_ctxt:\n   1106         outer_forward_ctxt = outer_forward_ctxt.GetWhileContext()\n\nAttributeError: 'NoneType' object has no attribute 'outer_context'\n</code></pre>", "body_text": "It seems when you import a graph with a \"while\" loop, you can't calculate gradients as you could on the original graph. e.g.\nimport tensorflow as tf\ni=tf.constant(0, name=\"input\")\nout=tf.while_loop(lambda i: tf.less(i,5), lambda i: [tf.add(i,1)], [i], name=\"output\")\ngraph_def = tf.get_default_graph().as_graph_def()\n\ng = tf.Graph()\nwith g.as_default():\n    tf.import_graph_def(graph_def)\ns = tf.Session(graph=g)\ni_imported = g.get_tensor_by_name(\"import/input:0\")\nout_imported = g.get_tensor_by_name(\"import/output/Exit:0\")\ntf.gradients(out_imported, i_imported)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-12-e7e2b78684d3> in <module>()\n----> 1 tf.gradients(out_imported, i_imported)\n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method)\n    439     pending_count, loop_state = _PendingCount(ops.get_default_graph(), to_ops,\n    440                                               from_ops,\n--> 441                                               colocate_gradients_with_ops)\n    442 \n    443     # Iterate over the collected ops.\n\n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in _PendingCount(graph, to_ops, from_ops, colocate_gradients_with_ops)\n    184   # 'loop_state' is None if there are no while loops.\n    185   loop_state = control_flow_ops.MaybeCreateControlFlowState(\n--> 186       between_op_list, between_ops, colocate_gradients_with_ops)\n    187 \n    188   # Initialize pending count for between ops.\n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in MaybeCreateControlFlowState(between_op_list, between_ops, colocate_gradients_with_ops)\n   1293           loop_state.AddWhileContext(op, between_op_list, between_ops)\n   1294       else:\n-> 1295         loop_state.AddWhileContext(op, between_op_list, between_ops)\n   1296   return loop_state\n   1297 \n\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in AddWhileContext(self, op, between_op_list, between_ops)\n   1102     if grad_state is None:\n   1103       # This is a new while loop so create a grad state for it.\n-> 1104       outer_forward_ctxt = forward_ctxt.outer_context\n   1105       if outer_forward_ctxt:\n   1106         outer_forward_ctxt = outer_forward_ctxt.GetWhileContext()\n\nAttributeError: 'NoneType' object has no attribute 'outer_context'", "body": "It seems when you import a graph with a \"while\" loop, you can't calculate gradients as you could on the original graph. e.g.\r\n\r\n```python\r\nimport tensorflow as tf\r\ni=tf.constant(0, name=\"input\")\r\nout=tf.while_loop(lambda i: tf.less(i,5), lambda i: [tf.add(i,1)], [i], name=\"output\")\r\ngraph_def = tf.get_default_graph().as_graph_def()\r\n\r\ng = tf.Graph()\r\nwith g.as_default():\r\n    tf.import_graph_def(graph_def)\r\ns = tf.Session(graph=g)\r\ni_imported = g.get_tensor_by_name(\"import/input:0\")\r\nout_imported = g.get_tensor_by_name(\"import/output/Exit:0\")\r\ntf.gradients(out_imported, i_imported)\r\n```\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nAttributeError                            Traceback (most recent call last)\r\n<ipython-input-12-e7e2b78684d3> in <module>()\r\n----> 1 tf.gradients(out_imported, i_imported)\r\n\r\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method)\r\n    439     pending_count, loop_state = _PendingCount(ops.get_default_graph(), to_ops,\r\n    440                                               from_ops,\r\n--> 441                                               colocate_gradients_with_ops)\r\n    442 \r\n    443     # Iterate over the collected ops.\r\n\r\n\r\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.pyc in _PendingCount(graph, to_ops, from_ops, colocate_gradients_with_ops)\r\n    184   # 'loop_state' is None if there are no while loops.\r\n    185   loop_state = control_flow_ops.MaybeCreateControlFlowState(\r\n--> 186       between_op_list, between_ops, colocate_gradients_with_ops)\r\n    187 \r\n    188   # Initialize pending count for between ops.\r\n\r\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in MaybeCreateControlFlowState(between_op_list, between_ops, colocate_gradients_with_ops)\r\n   1293           loop_state.AddWhileContext(op, between_op_list, between_ops)\r\n   1294       else:\r\n-> 1295         loop_state.AddWhileContext(op, between_op_list, between_ops)\r\n   1296   return loop_state\r\n   1297 \r\n\r\n/Users/malmaud/anaconda/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.pyc in AddWhileContext(self, op, between_op_list, between_ops)\r\n   1102     if grad_state is None:\r\n   1103       # This is a new while loop so create a grad state for it.\r\n-> 1104       outer_forward_ctxt = forward_ctxt.outer_context\r\n   1105       if outer_forward_ctxt:\r\n   1106         outer_forward_ctxt = outer_forward_ctxt.GetWhileContext()\r\n\r\nAttributeError: 'NoneType' object has no attribute 'outer_context'\r\n```"}