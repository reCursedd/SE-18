{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9842", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9842/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9842/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9842/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/9842", "id": 228068040, "node_id": "MDU6SXNzdWUyMjgwNjgwNDA=", "number": 9842, "title": "Dynamic Library Compilation Error", "user": {"login": "eaplatanios", "id": 1294940, "node_id": "MDQ6VXNlcjEyOTQ5NDA=", "avatar_url": "https://avatars2.githubusercontent.com/u/1294940?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eaplatanios", "html_url": "https://github.com/eaplatanios", "followers_url": "https://api.github.com/users/eaplatanios/followers", "following_url": "https://api.github.com/users/eaplatanios/following{/other_user}", "gists_url": "https://api.github.com/users/eaplatanios/gists{/gist_id}", "starred_url": "https://api.github.com/users/eaplatanios/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eaplatanios/subscriptions", "organizations_url": "https://api.github.com/users/eaplatanios/orgs", "repos_url": "https://api.github.com/users/eaplatanios/repos", "events_url": "https://api.github.com/users/eaplatanios/events{/privacy}", "received_events_url": "https://api.github.com/users/eaplatanios/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-05-11T17:37:28Z", "updated_at": "2017-05-11T19:21:19Z", "closed_at": "2017-05-11T19:20:43Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Hi,</p>\n<p>When I compile the dynamic library without the optimization flag, using the command <code>bazel build //tensorflow:libtensorflow.so</code>, everything works well (i.e., I am able to compile it and load it in the Java API). However, if I compile with some optimization flags, using the command <code>bazel build --config=opt --copt=-mavx --copt=-mavx2 --copt=-mfma --copt=-msse3 --copt=-msse4.1 --copt=-msse4.2 //tensorflow:libtensorflow.so</code>, the library compiles fine (i.e., no errors), but when I try to load it with the Java API, I get the following error:</p>\n<pre lang=\"txt\"><code># A fatal error has been detected by the Java Runtime Environment:\n#\n#  SIGILL (0x4) at pc=0x000000012b7670a8, pid=62398, tid=7171\n#\n# JRE version: Java(TM) SE Runtime Environment (8.0_77-b03) (build 1.8.0_77-b03)\n# Java VM: Java HotSpot(TM) 64-Bit Server VM (25.77-b03 mixed mode bsd-amd64 compressed oops)\n# Problematic frame:\n# C  [libtensorflow.so+0x1bb80a8]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto11TableStruct16InitDefaultsImplEv+0x38\n#\n# Failed to write core dump. Core dumps have been disabled. To enable core dumping, try \"ulimit -c unlimited\" before starting Java again\n#\n# An error report file with more information is saved as:\n# /xxx/tensorflow_scala/hs_err_pid62398.log\n#\n# If you would like to submit a bug report, please visit:\n#   http://bugreport.java.com/bugreport/crash.jsp\n# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.\n</code></pre>\n<p>The relevant part of the error log stack trace is:</p>\n<pre lang=\"txt\"><code>Stack: [0x000070000606e000,0x000070000616e000],  sp=0x0000700006166ad0,  free space=994k\nNative frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)\nC  [libtensorflow.so+0x1bb80a8]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto11TableStruct16InitDefaultsImplEv+0x38\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1bb8124]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1bc9614]  _ZN10tensorflow55protobuf_tensorflow_2fcore_2fframework_2ftensor_2eproto11TableStruct16InitDefaultsImplEv+0x24\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1bc9724]  _ZN10tensorflow55protobuf_tensorflow_2fcore_2fframework_2ftensor_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1b79447]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fattr_5fvalue_2eproto11TableStruct16InitDefaultsImplEv+0x27\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1b795e4]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fattr_5fvalue_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1ba0354]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fkernel_5fdef_2eproto11TableStruct16InitDefaultsImplEv+0x24\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1ba0454]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fkernel_5fdef_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1ba16af]  _ZN10tensorflow9KernelDefC2Ev+0x5f\nC  [libtensorflow.so+0x19793c8]  _ZN10tensorflow16KernelDefBuilderC2EPKc+0x28\nC  [libtensorflow.so+0x10e58e]  _GLOBAL__sub_I_batchtospace_op.cc+0x1e\nC  0x0000000112b39a1b\nC  0x0000000112b39c1e\nC  0x0000000112b354aa\nC  0x0000000112b35441\nC  0x0000000112b34524\nC  0x0000000112b345b9\nC  0x0000000112b297cd\nC  0x0000000112b313ec\nC  [libdyld.dylib+0x2832]  dlopen+0x3b\nV  [libjvm.dylib+0x4820f6]\nV  [libjvm.dylib+0x3456a8]\nC  [libjava.dylib+0x28b0]  Java_java_lang_ClassLoader_00024NativeLibrary_load+0x77\n</code></pre>\n<p>Why is this happening and how could it be fixed?</p>\n<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=5061\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/alextp\">@alextp</a> I think it may have to do with resources / resource-based variables given the error message, and I think you might be knowledgable with respect to that topic. I'm not sure if that's the issue though.</p>\n<p>Thank you!</p>\n<p>P.S. Let me know if the complete error log file would help and I'll post it here. :)</p>", "body_text": "Hi,\nWhen I compile the dynamic library without the optimization flag, using the command bazel build //tensorflow:libtensorflow.so, everything works well (i.e., I am able to compile it and load it in the Java API). However, if I compile with some optimization flags, using the command bazel build --config=opt --copt=-mavx --copt=-mavx2 --copt=-mfma --copt=-msse3 --copt=-msse4.1 --copt=-msse4.2 //tensorflow:libtensorflow.so, the library compiles fine (i.e., no errors), but when I try to load it with the Java API, I get the following error:\n# A fatal error has been detected by the Java Runtime Environment:\n#\n#  SIGILL (0x4) at pc=0x000000012b7670a8, pid=62398, tid=7171\n#\n# JRE version: Java(TM) SE Runtime Environment (8.0_77-b03) (build 1.8.0_77-b03)\n# Java VM: Java HotSpot(TM) 64-Bit Server VM (25.77-b03 mixed mode bsd-amd64 compressed oops)\n# Problematic frame:\n# C  [libtensorflow.so+0x1bb80a8]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto11TableStruct16InitDefaultsImplEv+0x38\n#\n# Failed to write core dump. Core dumps have been disabled. To enable core dumping, try \"ulimit -c unlimited\" before starting Java again\n#\n# An error report file with more information is saved as:\n# /xxx/tensorflow_scala/hs_err_pid62398.log\n#\n# If you would like to submit a bug report, please visit:\n#   http://bugreport.java.com/bugreport/crash.jsp\n# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.\n\nThe relevant part of the error log stack trace is:\nStack: [0x000070000606e000,0x000070000616e000],  sp=0x0000700006166ad0,  free space=994k\nNative frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)\nC  [libtensorflow.so+0x1bb80a8]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto11TableStruct16InitDefaultsImplEv+0x38\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1bb8124]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1bc9614]  _ZN10tensorflow55protobuf_tensorflow_2fcore_2fframework_2ftensor_2eproto11TableStruct16InitDefaultsImplEv+0x24\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1bc9724]  _ZN10tensorflow55protobuf_tensorflow_2fcore_2fframework_2ftensor_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1b79447]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fattr_5fvalue_2eproto11TableStruct16InitDefaultsImplEv+0x27\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1b795e4]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fattr_5fvalue_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1ba0354]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fkernel_5fdef_2eproto11TableStruct16InitDefaultsImplEv+0x24\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\nC  [libtensorflow.so+0x1ba0454]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fkernel_5fdef_2eproto12InitDefaultsEv+0x44\nC  [libtensorflow.so+0x1ba16af]  _ZN10tensorflow9KernelDefC2Ev+0x5f\nC  [libtensorflow.so+0x19793c8]  _ZN10tensorflow16KernelDefBuilderC2EPKc+0x28\nC  [libtensorflow.so+0x10e58e]  _GLOBAL__sub_I_batchtospace_op.cc+0x1e\nC  0x0000000112b39a1b\nC  0x0000000112b39c1e\nC  0x0000000112b354aa\nC  0x0000000112b35441\nC  0x0000000112b34524\nC  0x0000000112b345b9\nC  0x0000000112b297cd\nC  0x0000000112b313ec\nC  [libdyld.dylib+0x2832]  dlopen+0x3b\nV  [libjvm.dylib+0x4820f6]\nV  [libjvm.dylib+0x3456a8]\nC  [libjava.dylib+0x28b0]  Java_java_lang_ClassLoader_00024NativeLibrary_load+0x77\n\nWhy is this happening and how could it be fixed?\n@alextp I think it may have to do with resources / resource-based variables given the error message, and I think you might be knowledgable with respect to that topic. I'm not sure if that's the issue though.\nThank you!\nP.S. Let me know if the complete error log file would help and I'll post it here. :)", "body": "Hi,\r\n\r\nWhen I compile the dynamic library without the optimization flag, using the command `bazel build //tensorflow:libtensorflow.so`, everything works well (i.e., I am able to compile it and load it in the Java API). However, if I compile with some optimization flags, using the command `bazel build --config=opt --copt=-mavx --copt=-mavx2 --copt=-mfma --copt=-msse3 --copt=-msse4.1 --copt=-msse4.2 //tensorflow:libtensorflow.so`, the library compiles fine (i.e., no errors), but when I try to load it with the Java API, I get the following error:\r\n\r\n```txt\r\n# A fatal error has been detected by the Java Runtime Environment:\r\n#\r\n#  SIGILL (0x4) at pc=0x000000012b7670a8, pid=62398, tid=7171\r\n#\r\n# JRE version: Java(TM) SE Runtime Environment (8.0_77-b03) (build 1.8.0_77-b03)\r\n# Java VM: Java HotSpot(TM) 64-Bit Server VM (25.77-b03 mixed mode bsd-amd64 compressed oops)\r\n# Problematic frame:\r\n# C  [libtensorflow.so+0x1bb80a8]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto11TableStruct16InitDefaultsImplEv+0x38\r\n#\r\n# Failed to write core dump. Core dumps have been disabled. To enable core dumping, try \"ulimit -c unlimited\" before starting Java again\r\n#\r\n# An error report file with more information is saved as:\r\n# /xxx/tensorflow_scala/hs_err_pid62398.log\r\n#\r\n# If you would like to submit a bug report, please visit:\r\n#   http://bugreport.java.com/bugreport/crash.jsp\r\n# The crash happened outside the Java Virtual Machine in native code.\r\n# See problematic frame for where to report the bug.\r\n```\r\n\r\nThe relevant part of the error log stack trace is:\r\n\r\n```txt\r\nStack: [0x000070000606e000,0x000070000616e000],  sp=0x0000700006166ad0,  free space=994k\r\nNative frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)\r\nC  [libtensorflow.so+0x1bb80a8]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto11TableStruct16InitDefaultsImplEv+0x38\r\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\r\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\r\nC  [libtensorflow.so+0x1bb8124]  _ZN10tensorflow66protobuf_tensorflow_2fcore_2fframework_2fresource_5fhandle_2eproto12InitDefaultsEv+0x44\r\nC  [libtensorflow.so+0x1bc9614]  _ZN10tensorflow55protobuf_tensorflow_2fcore_2fframework_2ftensor_2eproto11TableStruct16InitDefaultsImplEv+0x24\r\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\r\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\r\nC  [libtensorflow.so+0x1bc9724]  _ZN10tensorflow55protobuf_tensorflow_2fcore_2fframework_2ftensor_2eproto12InitDefaultsEv+0x44\r\nC  [libtensorflow.so+0x1b79447]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fattr_5fvalue_2eproto11TableStruct16InitDefaultsImplEv+0x27\r\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\r\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\r\nC  [libtensorflow.so+0x1b795e4]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fattr_5fvalue_2eproto12InitDefaultsEv+0x44\r\nC  [libtensorflow.so+0x1ba0354]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fkernel_5fdef_2eproto11TableStruct16InitDefaultsImplEv+0x24\r\nC  [libtensorflow.so+0x1d50941]  _ZN6google8protobuf8internal16FunctionClosure03RunEv+0x11\r\nC  [libtensorflow.so+0x1d512eb]  _ZN6google8protobuf18GoogleOnceInitImplEPlPNS0_7ClosureE+0x3b\r\nC  [libtensorflow.so+0x1ba0454]  _ZN10tensorflow61protobuf_tensorflow_2fcore_2fframework_2fkernel_5fdef_2eproto12InitDefaultsEv+0x44\r\nC  [libtensorflow.so+0x1ba16af]  _ZN10tensorflow9KernelDefC2Ev+0x5f\r\nC  [libtensorflow.so+0x19793c8]  _ZN10tensorflow16KernelDefBuilderC2EPKc+0x28\r\nC  [libtensorflow.so+0x10e58e]  _GLOBAL__sub_I_batchtospace_op.cc+0x1e\r\nC  0x0000000112b39a1b\r\nC  0x0000000112b39c1e\r\nC  0x0000000112b354aa\r\nC  0x0000000112b35441\r\nC  0x0000000112b34524\r\nC  0x0000000112b345b9\r\nC  0x0000000112b297cd\r\nC  0x0000000112b313ec\r\nC  [libdyld.dylib+0x2832]  dlopen+0x3b\r\nV  [libjvm.dylib+0x4820f6]\r\nV  [libjvm.dylib+0x3456a8]\r\nC  [libjava.dylib+0x28b0]  Java_java_lang_ClassLoader_00024NativeLibrary_load+0x77\r\n```\r\n\r\nWhy is this happening and how could it be fixed?\r\n\r\n@alextp I think it may have to do with resources / resource-based variables given the error message, and I think you might be knowledgable with respect to that topic. I'm not sure if that's the issue though.\r\n\r\nThank you!\r\n\r\nP.S. Let me know if the complete error log file would help and I'll post it here. :)\r\n"}