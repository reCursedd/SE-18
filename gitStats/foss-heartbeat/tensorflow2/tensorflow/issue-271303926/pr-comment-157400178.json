{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/157400178", "pull_request_review_id": 84034079, "id": 157400178, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1NzQwMDE3OA==", "diff_hunk": "@@ -352,32 +354,45 @@ def _SvdGrad(op, grad_s, grad_u, grad_v):\n             array_ops.expand_dims(s2, -2) - array_ops.expand_dims(s2, -1)),\n         array_ops.zeros_like(s))\n     s_inv_mat = array_ops.matrix_diag(math_ops.reciprocal(s))\n+\n+    v1 = v[..., :, :m]\n+    grad_v1 = grad_v[..., :, :m]\n+\n     u_gu = math_ops.matmul(u, grad_u, adjoint_a=True)\n-    v_gv = math_ops.matmul(v, grad_v, adjoint_a=True)\n+    v_gv = math_ops.matmul(v1, grad_v1, adjoint_a=True)\n \n-    if m == n:\n-      f_u = f * u_gu\n-      f_v = f * v_gv\n-    else:\n-      dv2 = array_ops.matrix_transpose(v_gv[..., m:n, :m]) - v_gv[..., :m, m:n]\n-      f_u = f * u_gu\n-      f_v = f * v_gv[..., :m, :m]\n+    f_u = f * u_gu\n+    f_v = f * v_gv\n \n-    grad_a_nouv = (\n+    term1_nouv = (\n         grad_s_mat + math_ops.matmul(f_u + _linalg.adjoint(f_u), s_mat) +\n         math_ops.matmul(s_mat, f_v + _linalg.adjoint(f_v)))\n \n-    if m != n:\n-      grad_a_nouv = array_ops.concat(\n-          [grad_a_nouv, math_ops.matmul(s_inv_mat, dv2)], -1)\n+    term1 = math_ops.matmul(u, math_ops.matmul(term1_nouv, v1, adjoint_b=True))\n+\n+    if m == n:\n+      grad_a_before_transpose = term1\n+    else:\n+      proj_v1_perp = (linalg_ops.eye(n, dtype=v.dtype)", "path": "tensorflow/python/ops/linalg_grad.py", "position": null, "original_position": 79, "commit_id": "f7a0cc05b4210ae3f1598de619da37f94ff3d2b2", "original_commit_id": "b739ee1734baf437f1925ea09d07647ec7602caf", "user": {"login": "vnavkal", "id": 5924638, "node_id": "MDQ6VXNlcjU5MjQ2Mzg=", "avatar_url": "https://avatars2.githubusercontent.com/u/5924638?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vnavkal", "html_url": "https://github.com/vnavkal", "followers_url": "https://api.github.com/users/vnavkal/followers", "following_url": "https://api.github.com/users/vnavkal/following{/other_user}", "gists_url": "https://api.github.com/users/vnavkal/gists{/gist_id}", "starred_url": "https://api.github.com/users/vnavkal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vnavkal/subscriptions", "organizations_url": "https://api.github.com/users/vnavkal/orgs", "repos_url": "https://api.github.com/users/vnavkal/repos", "events_url": "https://api.github.com/users/vnavkal/events{/privacy}", "received_events_url": "https://api.github.com/users/vnavkal/received_events", "type": "User", "site_admin": false}, "body": "good point.  I updated this part of the calculation so that it doesn't use an `n` by `n` matrix.  (Note that in the formula you wrote, `grad_v1` needs to be replaced by its adjoint.)", "created_at": "2017-12-18T04:40:33Z", "updated_at": "2017-12-18T04:40:33Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/14259#discussion_r157400178", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/14259", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/157400178"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/14259#discussion_r157400178"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/14259"}}, "body_html": "<p>good point.  I updated this part of the calculation so that it doesn't use an <code>n</code> by <code>n</code> matrix.  (Note that in the formula you wrote, <code>grad_v1</code> needs to be replaced by its adjoint.)</p>", "body_text": "good point.  I updated this part of the calculation so that it doesn't use an n by n matrix.  (Note that in the formula you wrote, grad_v1 needs to be replaced by its adjoint.)", "in_reply_to_id": 157068142}