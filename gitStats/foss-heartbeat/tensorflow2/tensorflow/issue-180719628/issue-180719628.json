{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4735", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4735/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4735/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4735/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/4735", "id": 180719628, "node_id": "MDU6SXNzdWUxODA3MTk2Mjg=", "number": 4735, "title": "Resource exhausted error in the middle of training", "user": {"login": "civilman628", "id": 8059551, "node_id": "MDQ6VXNlcjgwNTk1NTE=", "avatar_url": "https://avatars2.githubusercontent.com/u/8059551?v=4", "gravatar_id": "", "url": "https://api.github.com/users/civilman628", "html_url": "https://github.com/civilman628", "followers_url": "https://api.github.com/users/civilman628/followers", "following_url": "https://api.github.com/users/civilman628/following{/other_user}", "gists_url": "https://api.github.com/users/civilman628/gists{/gist_id}", "starred_url": "https://api.github.com/users/civilman628/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/civilman628/subscriptions", "organizations_url": "https://api.github.com/users/civilman628/orgs", "repos_url": "https://api.github.com/users/civilman628/repos", "events_url": "https://api.github.com/users/civilman628/events{/privacy}", "received_events_url": "https://api.github.com/users/civilman628/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 17, "created_at": "2016-10-03T19:04:29Z", "updated_at": "2018-10-07T10:05:41Z", "closed_at": "2017-02-10T21:44:35Z", "author_association": "NONE", "body_html": "<p>I train the inception v1 (slim) model on my own data set. 269 classes total.<br>\nThe max training step is 60435 and batch size is 256 as below<br>\n<strong>--max_number_of_steps=60435<br>\n--batch_size=256</strong><br>\nThe model runs under GPU mode and I have 4 Tian X GPUs, with each has 12G GPU memory.<br>\nThe Resource exhausted error happen after at least 46831 trainning steps, since i can see the last check point file is model.ckpt-46831.</p>\n<p>I do not know why the issue happen in the middle, but not at very beginning of the training process.</p>\n<p>The error log report by Tensor Fow is as below:</p>\n<p>//other lines above.<br>\nI tensorflow/core/common_runtime/bfc_allocator.cc:700] Sum Total of in-use chunks: 11.16GiB<br>\nI tensorflow/core/common_runtime/bfc_allocator.cc:702] Stats:<br>\n<strong>Limit:                 12049707828<br>\nInUse:                 11984328960<br>\nMaxInUse:              12038083584<br>\nNumAllocs:               248036306<br>\nMaxAllocSize:           2831155200</strong></p>\n<p>W tensorflow/core/common_runtime/bfc_allocator.cc:274] ************************************************************************************************<em>_xx<br>\nW tensorflow/core/common_runtime/bfc_allocator.cc:275] <em>_Ran out of memory trying to allocate 39.81MiB.</em></em>  See logs for memory state.<br>\nW tensorflow/core/framework/op_kernel.cc:968] Resource exhausted: OOM when allocating tensor with shape[256,832,7,7]<br>\nINFO:tensorflow:Error reported to Coordinator: &lt;class 'tensorflow.python.framework.errors.ResourceExhaustedError'&gt;, OOM when allocating tensor with shape[256,112,112,64]<br>\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]<br>\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv<a href=\"\">client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"</a>]]</p>\n<p>Caused by op u'InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference', defined at:<br>\nFile \"train_image_classifier.py\", line 585, in <br>\ntf.app.run()<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run<br>\nsys.exit(main(sys.argv[:1] + flags_passthrough))<br>\nFile \"train_image_classifier.py\", line 482, in main<br>\nclones = model_deploy.create_clones(deploy_config, clone_fn, [batch_queue])<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/deployment/model_deploy.py\", line 195, in create_clones<br>\noutputs = model_fn(_args, *_kwargs)<br>\nFile \"train_image_classifier.py\", line 466, in clone_fn<br>\nlogits, end_points = network_fn(images)<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/nets_factory.py\", line 103, in network_fn<br>\nreturn func(images, num_classes, is_training=is_training)<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 288, in inception_v1<br>\nnet, end_points = inception_v1_base(inputs, scope=scope)<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 61, in inception_v1_base<br>\nnet = slim.conv2d(inputs, 64, [7, 7], stride=2, scope=end_point)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args<br>\nreturn func(_args, *_current_args)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 445, in convolution2d<br>\noutputs = normalizer_fn(outputs, *_normalizer_params)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args<br>\nreturn func(_args, **current_args)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 250, in batch_norm<br>\nmean, variance = nn.moments(inputs, axis, shift=shift)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 835, in moments<br>\ny, axes, shift=shift, keep_dims=keep_dims, name=name)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 762, in sufficient_statistics<br>\nv_ss = math_ops.squared_difference(x, shift)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_math_ops.py\", line 2347, in squared_difference<br>\nresult = _op_def_lib.apply_op(\"SquaredDifference\", x=x, y=y, name=name)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op<br>\nop_def=op_def)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2386, in create_op<br>\noriginal_op=self._default_original_op, op_def=op_def)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1298, in <strong>init</strong><br>\nself._traceback = _extract_stack()</p>\n<p>ResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[256,112,112,64]<br>\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]<br>\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv<a href=\"\">client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"</a>]]</p>\n<p>Traceback (most recent call last):<br>\nFile \"train_image_classifier.py\", line 585, in <br>\ntf.app.run()<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run<br>\nsys.exit(main(sys.argv[:1] + flags_passthrough))<br>\nFile \"train_image_classifier.py\", line 581, in main<br>\nsync_optimizer=optimizer if FLAGS.sync_replicas else None)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/slim/python/slim/learning.py\", line 781, in train<br>\nraise<br>\nFile \"/usr/lib/python2.7/contextlib.py\", line 35, in <strong>exit</strong><br>\nself.gen.throw(type, value, traceback)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 969, in managed_session<br>\nself.stop(close_summary_writer=close_summary_writer)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 797, in stop<br>\nstop_grace_period_secs=self._stop_grace_secs)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 386, in join<br>\nsix.reraise(*self._exc_info_to_raise)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 296, in stop_on_exception<br>\nyield<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 481, in run<br>\nself.run_loop()<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 999, in run_loop<br>\nself._sv.global_step])<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 717, in run<br>\nrun_metadata_ptr)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 915, in _run<br>\nfeed_dict_string, options, run_metadata)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 965, in _do_run<br>\ntarget_list, options, run_metadata)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 985, in _do_call<br>\nraise type(e)(node_def, op, message)<br>\ntensorflow.python.framework.errors.ResourceExhaustedError: OOM when allocating tensor with shape[256,112,112,64]<br>\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]<br>\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv<a href=\"\">client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"</a>]]</p>\n<p>Caused by op u'InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference', defined at:<br>\nFile \"train_image_classifier.py\", line 585, in <br>\ntf.app.run()<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run<br>\nsys.exit(main(sys.argv[:1] + flags_passthrough))<br>\nFile \"train_image_classifier.py\", line 482, in main<br>\nclones = model_deploy.create_clones(deploy_config, clone_fn, [batch_queue])<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/deployment/model_deploy.py\", line 195, in create_clones<br>\noutputs = model_fn(_args, *_kwargs)<br>\nFile \"train_image_classifier.py\", line 466, in clone_fn<br>\nlogits, end_points = network_fn(images)<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/nets_factory.py\", line 103, in network_fn<br>\nreturn func(images, num_classes, is_training=is_training)<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 288, in inception_v1<br>\nnet, end_points = inception_v1_base(inputs, scope=scope)<br>\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 61, in inception_v1_base<br>\nnet = slim.conv2d(inputs, 64, [7, 7], stride=2, scope=end_point)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args<br>\nreturn func(_args, *_current_args)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 445, in convolution2d<br>\noutputs = normalizer_fn(outputs, *_normalizer_params)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args<br>\nreturn func(_args, **current_args)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 250, in batch_norm<br>\nmean, variance = nn.moments(inputs, axis, shift=shift)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 835, in moments<br>\ny, axes, shift=shift, keep_dims=keep_dims, name=name)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 762, in sufficient_statistics<br>\nv_ss = math_ops.squared_difference(x, shift)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_math_ops.py\", line 2347, in squared_difference<br>\nresult = _op_def_lib.apply_op(\"SquaredDifference\", x=x, y=y, name=name)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op<br>\nop_def=op_def)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2386, in create_op<br>\noriginal_op=self._default_original_op, op_def=op_def)<br>\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1298, in <strong>init</strong><br>\nself._traceback = _extract_stack()</p>\n<p>ResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[256,112,112,64]<br>\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]<br>\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv<a href=\"\">client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"</a>]]</p>", "body_text": "I train the inception v1 (slim) model on my own data set. 269 classes total.\nThe max training step is 60435 and batch size is 256 as below\n--max_number_of_steps=60435\n--batch_size=256\nThe model runs under GPU mode and I have 4 Tian X GPUs, with each has 12G GPU memory.\nThe Resource exhausted error happen after at least 46831 trainning steps, since i can see the last check point file is model.ckpt-46831.\nI do not know why the issue happen in the middle, but not at very beginning of the training process.\nThe error log report by Tensor Fow is as below:\n//other lines above.\nI tensorflow/core/common_runtime/bfc_allocator.cc:700] Sum Total of in-use chunks: 11.16GiB\nI tensorflow/core/common_runtime/bfc_allocator.cc:702] Stats:\nLimit:                 12049707828\nInUse:                 11984328960\nMaxInUse:              12038083584\nNumAllocs:               248036306\nMaxAllocSize:           2831155200\nW tensorflow/core/common_runtime/bfc_allocator.cc:274] ************************************************************************************************_xx\nW tensorflow/core/common_runtime/bfc_allocator.cc:275] _Ran out of memory trying to allocate 39.81MiB.  See logs for memory state.\nW tensorflow/core/framework/op_kernel.cc:968] Resource exhausted: OOM when allocating tensor with shape[256,832,7,7]\nINFO:tensorflow:Error reported to Coordinator: <class 'tensorflow.python.framework.errors.ResourceExhaustedError'>, OOM when allocating tensor with shape[256,112,112,64]\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recvclient_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]]\nCaused by op u'InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference', defined at:\nFile \"train_image_classifier.py\", line 585, in \ntf.app.run()\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run\nsys.exit(main(sys.argv[:1] + flags_passthrough))\nFile \"train_image_classifier.py\", line 482, in main\nclones = model_deploy.create_clones(deploy_config, clone_fn, [batch_queue])\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/deployment/model_deploy.py\", line 195, in create_clones\noutputs = model_fn(_args, *_kwargs)\nFile \"train_image_classifier.py\", line 466, in clone_fn\nlogits, end_points = network_fn(images)\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/nets_factory.py\", line 103, in network_fn\nreturn func(images, num_classes, is_training=is_training)\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 288, in inception_v1\nnet, end_points = inception_v1_base(inputs, scope=scope)\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 61, in inception_v1_base\nnet = slim.conv2d(inputs, 64, [7, 7], stride=2, scope=end_point)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\nreturn func(_args, *_current_args)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 445, in convolution2d\noutputs = normalizer_fn(outputs, *_normalizer_params)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\nreturn func(_args, **current_args)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 250, in batch_norm\nmean, variance = nn.moments(inputs, axis, shift=shift)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 835, in moments\ny, axes, shift=shift, keep_dims=keep_dims, name=name)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 762, in sufficient_statistics\nv_ss = math_ops.squared_difference(x, shift)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_math_ops.py\", line 2347, in squared_difference\nresult = _op_def_lib.apply_op(\"SquaredDifference\", x=x, y=y, name=name)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\nop_def=op_def)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2386, in create_op\noriginal_op=self._default_original_op, op_def=op_def)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1298, in init\nself._traceback = _extract_stack()\nResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[256,112,112,64]\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recvclient_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]]\nTraceback (most recent call last):\nFile \"train_image_classifier.py\", line 585, in \ntf.app.run()\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run\nsys.exit(main(sys.argv[:1] + flags_passthrough))\nFile \"train_image_classifier.py\", line 581, in main\nsync_optimizer=optimizer if FLAGS.sync_replicas else None)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/slim/python/slim/learning.py\", line 781, in train\nraise\nFile \"/usr/lib/python2.7/contextlib.py\", line 35, in exit\nself.gen.throw(type, value, traceback)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 969, in managed_session\nself.stop(close_summary_writer=close_summary_writer)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 797, in stop\nstop_grace_period_secs=self._stop_grace_secs)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 386, in join\nsix.reraise(*self._exc_info_to_raise)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 296, in stop_on_exception\nyield\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 481, in run\nself.run_loop()\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 999, in run_loop\nself._sv.global_step])\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 717, in run\nrun_metadata_ptr)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 915, in _run\nfeed_dict_string, options, run_metadata)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 965, in _do_run\ntarget_list, options, run_metadata)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 985, in _do_call\nraise type(e)(node_def, op, message)\ntensorflow.python.framework.errors.ResourceExhaustedError: OOM when allocating tensor with shape[256,112,112,64]\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recvclient_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]]\nCaused by op u'InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference', defined at:\nFile \"train_image_classifier.py\", line 585, in \ntf.app.run()\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run\nsys.exit(main(sys.argv[:1] + flags_passthrough))\nFile \"train_image_classifier.py\", line 482, in main\nclones = model_deploy.create_clones(deploy_config, clone_fn, [batch_queue])\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/deployment/model_deploy.py\", line 195, in create_clones\noutputs = model_fn(_args, *_kwargs)\nFile \"train_image_classifier.py\", line 466, in clone_fn\nlogits, end_points = network_fn(images)\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/nets_factory.py\", line 103, in network_fn\nreturn func(images, num_classes, is_training=is_training)\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 288, in inception_v1\nnet, end_points = inception_v1_base(inputs, scope=scope)\nFile \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 61, in inception_v1_base\nnet = slim.conv2d(inputs, 64, [7, 7], stride=2, scope=end_point)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\nreturn func(_args, *_current_args)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 445, in convolution2d\noutputs = normalizer_fn(outputs, *_normalizer_params)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\nreturn func(_args, **current_args)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 250, in batch_norm\nmean, variance = nn.moments(inputs, axis, shift=shift)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 835, in moments\ny, axes, shift=shift, keep_dims=keep_dims, name=name)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 762, in sufficient_statistics\nv_ss = math_ops.squared_difference(x, shift)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_math_ops.py\", line 2347, in squared_difference\nresult = _op_def_lib.apply_op(\"SquaredDifference\", x=x, y=y, name=name)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\nop_def=op_def)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2386, in create_op\noriginal_op=self._default_original_op, op_def=op_def)\nFile \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1298, in init\nself._traceback = _extract_stack()\nResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[256,112,112,64]\n[[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n[[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recvclient_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]]", "body": "I train the inception v1 (slim) model on my own data set. 269 classes total.\nThe max training step is 60435 and batch size is 256 as below\n**--max_number_of_steps=60435\n--batch_size=256**\nThe model runs under GPU mode and I have 4 Tian X GPUs, with each has 12G GPU memory.\nThe Resource exhausted error happen after at least 46831 trainning steps, since i can see the last check point file is model.ckpt-46831.\n\nI do not know why the issue happen in the middle, but not at very beginning of the training process.\n\nThe error log report by Tensor Fow is as below:\n\n//other lines above.\nI tensorflow/core/common_runtime/bfc_allocator.cc:700] Sum Total of in-use chunks: 11.16GiB\nI tensorflow/core/common_runtime/bfc_allocator.cc:702] Stats: \n**Limit:                 12049707828\nInUse:                 11984328960\nMaxInUse:              12038083584\nNumAllocs:               248036306\nMaxAllocSize:           2831155200**\n\nW tensorflow/core/common_runtime/bfc_allocator.cc:274] *************************************************************************************************_xx\nW tensorflow/core/common_runtime/bfc_allocator.cc:275] *_Ran out of memory trying to allocate 39.81MiB.**  See logs for memory state.\nW tensorflow/core/framework/op_kernel.cc:968] Resource exhausted: OOM when allocating tensor with shape[256,832,7,7]\nINFO:tensorflow:Error reported to Coordinator: <class 'tensorflow.python.framework.errors.ResourceExhaustedError'>, OOM when allocating tensor with shape[256,112,112,64]\n     [[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n     [[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nCaused by op u'InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference', defined at:\n  File \"train_image_classifier.py\", line 585, in <module>\n    tf.app.run()\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run\n    sys.exit(main(sys.argv[:1] + flags_passthrough))\n  File \"train_image_classifier.py\", line 482, in main\n    clones = model_deploy.create_clones(deploy_config, clone_fn, [batch_queue])\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/deployment/model_deploy.py\", line 195, in create_clones\n    outputs = model_fn(_args, *_kwargs)\n  File \"train_image_classifier.py\", line 466, in clone_fn\n    logits, end_points = network_fn(images)\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/nets_factory.py\", line 103, in network_fn\n    return func(images, num_classes, is_training=is_training)\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 288, in inception_v1\n    net, end_points = inception_v1_base(inputs, scope=scope)\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 61, in inception_v1_base\n    net = slim.conv2d(inputs, 64, [7, 7], stride=2, scope=end_point)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\n    return func(_args, *_current_args)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 445, in convolution2d\n    outputs = normalizer_fn(outputs, *_normalizer_params)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\n    return func(_args, **current_args)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 250, in batch_norm\n    mean, variance = nn.moments(inputs, axis, shift=shift)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 835, in moments\n    y, axes, shift=shift, keep_dims=keep_dims, name=name)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 762, in sufficient_statistics\n    v_ss = math_ops.squared_difference(x, shift)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_math_ops.py\", line 2347, in squared_difference\n    result = _op_def_lib.apply_op(\"SquaredDifference\", x=x, y=y, name=name)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n    op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2386, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n    self._traceback = _extract_stack()\n\nResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[256,112,112,64]\n     [[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n     [[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nTraceback (most recent call last):\n  File \"train_image_classifier.py\", line 585, in <module>\n    tf.app.run()\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run\n    sys.exit(main(sys.argv[:1] + flags_passthrough))\n  File \"train_image_classifier.py\", line 581, in main\n    sync_optimizer=optimizer if FLAGS.sync_replicas else None)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/slim/python/slim/learning.py\", line 781, in train\n    raise\n  File \"/usr/lib/python2.7/contextlib.py\", line 35, in **exit**\n    self.gen.throw(type, value, traceback)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 969, in managed_session\n    self.stop(close_summary_writer=close_summary_writer)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 797, in stop\n    stop_grace_period_secs=self._stop_grace_secs)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 386, in join\n    six.reraise(*self._exc_info_to_raise)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 296, in stop_on_exception\n    yield\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/coordinator.py\", line 481, in run\n    self.run_loop()\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/training/supervisor.py\", line 999, in run_loop\n    self._sv.global_step])\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 717, in run\n    run_metadata_ptr)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 915, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 965, in _do_run\n    target_list, options, run_metadata)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/client/session.py\", line 985, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors.ResourceExhaustedError: OOM when allocating tensor with shape[256,112,112,64]\n     [[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n     [[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n\nCaused by op u'InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference', defined at:\n  File \"train_image_classifier.py\", line 585, in <module>\n    tf.app.run()\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/platform/app.py\", line 30, in run\n    sys.exit(main(sys.argv[:1] + flags_passthrough))\n  File \"train_image_classifier.py\", line 482, in main\n    clones = model_deploy.create_clones(deploy_config, clone_fn, [batch_queue])\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/deployment/model_deploy.py\", line 195, in create_clones\n    outputs = model_fn(_args, *_kwargs)\n  File \"train_image_classifier.py\", line 466, in clone_fn\n    logits, end_points = network_fn(images)\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/nets_factory.py\", line 103, in network_fn\n    return func(images, num_classes, is_training=is_training)\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 288, in inception_v1\n    net, end_points = inception_v1_base(inputs, scope=scope)\n  File \"/home/scopeserver/RaidDisk/DeepLearning/mwang/tensorflow/tensorflow/models/slim/nets/inception_v1.py\", line 61, in inception_v1_base\n    net = slim.conv2d(inputs, 64, [7, 7], stride=2, scope=end_point)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\n    return func(_args, *_current_args)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 445, in convolution2d\n    outputs = normalizer_fn(outputs, *_normalizer_params)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/framework/python/ops/arg_scope.py\", line 177, in func_with_args\n    return func(_args, **current_args)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/layers/python/layers/layers.py\", line 250, in batch_norm\n    mean, variance = nn.moments(inputs, axis, shift=shift)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 835, in moments\n    y, axes, shift=shift, keep_dims=keep_dims, name=name)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/nn.py\", line 762, in sufficient_statistics\n    v_ss = math_ops.squared_difference(x, shift)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_math_ops.py\", line 2347, in squared_difference\n    result = _op_def_lib.apply_op(\"SquaredDifference\", x=x, y=y, name=name)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n    op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 2386, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n    self._traceback = _extract_stack()\n\nResourceExhaustedError (see above for traceback): OOM when allocating tensor with shape[256,112,112,64]\n     [[Node: InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/moments/sufficient_statistics/SquaredDifference = SquaredDifference[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](InceptionV1/InceptionV1/Conv2d_1a_7x7/Conv2D, InceptionV1/InceptionV1/Conv2d_1a_7x7/BatchNorm/Add)]]\n     [[Node: InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool/_1231 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3156_InceptionV1/InceptionV1/MaxPool_5a_2x2/MaxPool\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n"}