{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11470", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11470/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11470/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11470/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/11470", "id": 242599983, "node_id": "MDU6SXNzdWUyNDI1OTk5ODM=", "number": 11470, "title": "Variable values are not present in Java when saving a model in python and restoring in Java", "user": {"login": "josemlopez", "id": 4112135, "node_id": "MDQ6VXNlcjQxMTIxMzU=", "avatar_url": "https://avatars3.githubusercontent.com/u/4112135?v=4", "gravatar_id": "", "url": "https://api.github.com/users/josemlopez", "html_url": "https://github.com/josemlopez", "followers_url": "https://api.github.com/users/josemlopez/followers", "following_url": "https://api.github.com/users/josemlopez/following{/other_user}", "gists_url": "https://api.github.com/users/josemlopez/gists{/gist_id}", "starred_url": "https://api.github.com/users/josemlopez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/josemlopez/subscriptions", "organizations_url": "https://api.github.com/users/josemlopez/orgs", "repos_url": "https://api.github.com/users/josemlopez/repos", "events_url": "https://api.github.com/users/josemlopez/events{/privacy}", "received_events_url": "https://api.github.com/users/josemlopez/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2017-07-13T06:38:21Z", "updated_at": "2017-07-17T15:09:38Z", "closed_at": "2017-07-17T15:09:38Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nYes. Provided bellow</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Mac OS 10.12.5</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: pip install</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.2.1</li>\n<li><strong>Python version</strong>: 2.7</li>\n<li><strong>Bazel version (if compiling from source)</strong>: No compiled</li>\n<li><strong>CUDA/cuDNN version</strong>: No</li>\n<li><strong>GPU model and memory</strong>: No</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I've a script where a graph and variables are being saved using add_meta_graph_and_variables and tried to load it in Java but the weights seems that not are present.<br>\nI've created two mini-examples of what it seems to me a bug.</p>\n<h3>Source code / logs</h3>\n<p>Here it's how I have saved the things:</p>\n<pre><code>with tf.Session(graph=tf.Graph()) as session:\n    ##HERE IS THE CODE OF MY NETWORK (Very long)\n\n    session.run(tf.global_variables_initializer())\n    #Load\n    saver = tf.train.Saver()\n    saver.restore(session, \"newModel.chkpt\")\n\n    features = loadFeatures([\"cat2.jpg\"])\n    res = predictions.eval(\n            feed_dict={\n                x: features,\n                keep_prob: 1.0, })\n    print('Image {} has a prob {} '.format(image, res))\n\n    b = saved_model_builder.SavedModelBuilder(pathToSaveModel)\n    b.add_meta_graph_and_variables(session, [tf.saved_model.tag_constants.TRAINING])\n    b.save()\n</code></pre>\n<p>And here is how I tried to load in the Java side:</p>\n<pre><code>public static void main(String[] args) throws Exception {\n\n        final int IMG_SIZE = 128;\n        final String value = \"Hello from \" + TensorFlow.version();\n\n        byte[] imageBytes = readAllBytesOrExit(Paths.get(\"./cat1.jpg\"));\n        Tensor image = constructAndExecuteGraphToNormalizeImage(IMG_SIZE, imageBytes);\n\n        SavedModelBundle load = SavedModelBundle.load(\"./tmpTestNew/model\", \"train\");\n\n        long[] sitio2;\n        try (Graph g = load.graph()) {\n            try (Session s = load.session();\n                 Tensor result = s.runner()\n                         .feed(\"keep_prob\", Tensor.create(1.0F))\n                         .feed(\"input_jm\", image)\n                         .fetch(\"predictions\").run().get(0))\n            {\n                sitio2 = result.copyTo(new long[1]);\n                System.out.print(sitio2[0]+\"\\n\");\n            }\n        }\n        load.close();\n    }\n</code></pre>\n<p>I've checked the content of some Tensor variables and in the python side the values are correct but the same variable in the Java side have another values (I can paste the code if needed), as a result the predictions are always wrong.</p>\n<p>I can provide the model saved or any other thing that is needed.</p>\n<p>Thanks.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nYes. Provided bellow\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Mac OS 10.12.5\nTensorFlow installed from (source or binary): pip install\nTensorFlow version (use command below): 1.2.1\nPython version: 2.7\nBazel version (if compiling from source): No compiled\nCUDA/cuDNN version: No\nGPU model and memory: No\nExact command to reproduce:\n\nDescribe the problem\nI've a script where a graph and variables are being saved using add_meta_graph_and_variables and tried to load it in Java but the weights seems that not are present.\nI've created two mini-examples of what it seems to me a bug.\nSource code / logs\nHere it's how I have saved the things:\nwith tf.Session(graph=tf.Graph()) as session:\n    ##HERE IS THE CODE OF MY NETWORK (Very long)\n\n    session.run(tf.global_variables_initializer())\n    #Load\n    saver = tf.train.Saver()\n    saver.restore(session, \"newModel.chkpt\")\n\n    features = loadFeatures([\"cat2.jpg\"])\n    res = predictions.eval(\n            feed_dict={\n                x: features,\n                keep_prob: 1.0, })\n    print('Image {} has a prob {} '.format(image, res))\n\n    b = saved_model_builder.SavedModelBuilder(pathToSaveModel)\n    b.add_meta_graph_and_variables(session, [tf.saved_model.tag_constants.TRAINING])\n    b.save()\n\nAnd here is how I tried to load in the Java side:\npublic static void main(String[] args) throws Exception {\n\n        final int IMG_SIZE = 128;\n        final String value = \"Hello from \" + TensorFlow.version();\n\n        byte[] imageBytes = readAllBytesOrExit(Paths.get(\"./cat1.jpg\"));\n        Tensor image = constructAndExecuteGraphToNormalizeImage(IMG_SIZE, imageBytes);\n\n        SavedModelBundle load = SavedModelBundle.load(\"./tmpTestNew/model\", \"train\");\n\n        long[] sitio2;\n        try (Graph g = load.graph()) {\n            try (Session s = load.session();\n                 Tensor result = s.runner()\n                         .feed(\"keep_prob\", Tensor.create(1.0F))\n                         .feed(\"input_jm\", image)\n                         .fetch(\"predictions\").run().get(0))\n            {\n                sitio2 = result.copyTo(new long[1]);\n                System.out.print(sitio2[0]+\"\\n\");\n            }\n        }\n        load.close();\n    }\n\nI've checked the content of some Tensor variables and in the python side the values are correct but the same variable in the Java side have another values (I can paste the code if needed), as a result the predictions are always wrong.\nI can provide the model saved or any other thing that is needed.\nThanks.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: \r\nYes. Provided bellow\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac OS 10.12.5\r\n- **TensorFlow installed from (source or binary)**: pip install \r\n- **TensorFlow version (use command below)**: 1.2.1\r\n- **Python version**: 2.7\r\n- **Bazel version (if compiling from source)**: No compiled\r\n- **CUDA/cuDNN version**: No\r\n- **GPU model and memory**: No\r\n- **Exact command to reproduce**: \r\n\r\n### Describe the problem\r\nI've a script where a graph and variables are being saved using add_meta_graph_and_variables and tried to load it in Java but the weights seems that not are present. \r\nI've created two mini-examples of what it seems to me a bug.\r\n\r\n### Source code / logs\r\nHere it's how I have saved the things:\r\n\r\n```\r\nwith tf.Session(graph=tf.Graph()) as session:\r\n    ##HERE IS THE CODE OF MY NETWORK (Very long)\r\n\r\n    session.run(tf.global_variables_initializer())\r\n    #Load\r\n    saver = tf.train.Saver()\r\n    saver.restore(session, \"newModel.chkpt\")\r\n\r\n    features = loadFeatures([\"cat2.jpg\"])\r\n    res = predictions.eval(\r\n            feed_dict={\r\n                x: features,\r\n                keep_prob: 1.0, })\r\n    print('Image {} has a prob {} '.format(image, res))\r\n\r\n    b = saved_model_builder.SavedModelBuilder(pathToSaveModel)\r\n    b.add_meta_graph_and_variables(session, [tf.saved_model.tag_constants.TRAINING])\r\n    b.save()\r\n```\r\n\r\nAnd here is how I tried to load in the Java side:\r\n\r\n```\r\npublic static void main(String[] args) throws Exception {\r\n\r\n        final int IMG_SIZE = 128;\r\n        final String value = \"Hello from \" + TensorFlow.version();\r\n\r\n        byte[] imageBytes = readAllBytesOrExit(Paths.get(\"./cat1.jpg\"));\r\n        Tensor image = constructAndExecuteGraphToNormalizeImage(IMG_SIZE, imageBytes);\r\n\r\n        SavedModelBundle load = SavedModelBundle.load(\"./tmpTestNew/model\", \"train\");\r\n\r\n        long[] sitio2;\r\n        try (Graph g = load.graph()) {\r\n            try (Session s = load.session();\r\n                 Tensor result = s.runner()\r\n                         .feed(\"keep_prob\", Tensor.create(1.0F))\r\n                         .feed(\"input_jm\", image)\r\n                         .fetch(\"predictions\").run().get(0))\r\n            {\r\n                sitio2 = result.copyTo(new long[1]);\r\n                System.out.print(sitio2[0]+\"\\n\");\r\n            }\r\n        }\r\n        load.close();\r\n    }\r\n```\r\n\r\nI've checked the content of some Tensor variables and in the python side the values are correct but the same variable in the Java side have another values (I can paste the code if needed), as a result the predictions are always wrong. \r\n\r\nI can provide the model saved or any other thing that is needed.\r\n\r\nThanks. \r\n"}