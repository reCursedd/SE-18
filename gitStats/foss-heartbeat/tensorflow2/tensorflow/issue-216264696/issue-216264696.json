{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8642", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8642/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8642/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8642/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/8642", "id": 216264696, "node_id": "MDU6SXNzdWUyMTYyNjQ2OTY=", "number": 8642, "title": "Graph with tf.cond can not be serialized correctly after calling remove_training_nodes.", "user": {"login": "isiosia", "id": 19769453, "node_id": "MDQ6VXNlcjE5NzY5NDUz", "avatar_url": "https://avatars2.githubusercontent.com/u/19769453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/isiosia", "html_url": "https://github.com/isiosia", "followers_url": "https://api.github.com/users/isiosia/followers", "following_url": "https://api.github.com/users/isiosia/following{/other_user}", "gists_url": "https://api.github.com/users/isiosia/gists{/gist_id}", "starred_url": "https://api.github.com/users/isiosia/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/isiosia/subscriptions", "organizations_url": "https://api.github.com/users/isiosia/orgs", "repos_url": "https://api.github.com/users/isiosia/repos", "events_url": "https://api.github.com/users/isiosia/events{/privacy}", "received_events_url": "https://api.github.com/users/isiosia/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473173272, "node_id": "MDU6TGFiZWw0NzMxNzMyNzI=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:feature", "name": "type:feature", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2017-03-23T01:57:44Z", "updated_at": "2018-01-24T22:55:34Z", "closed_at": "2018-01-24T22:55:33Z", "author_association": "NONE", "body_html": "<h3>What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?</h3>\n<p><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"169603113\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/3667\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/3667/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/3667\">#3667</a> may be the same problem? But that thread is closed without a clear answer.</p>\n<h3>Environment info</h3>\n<p>Operating System:</p>\n<ul>\n<li>Tensorflow 1.0.0</li>\n<li>Python 2.7</li>\n<li>Ubuntu 14.04</li>\n</ul>\n<p>Installed version of CUDA and cuDNN:<br>\n(please attach the output of <code>ls -l /path/to/cuda/lib/libcud*</code>):<br>\nCUDA 8.0<br>\ncuDNN 5.1.10<br>\n*This problem occurs in both GPU and CPU environment.</p>\n<h3>If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)</h3>\n<p>The following code is to produce a <code>.pb</code> file that can be used for <code>tf.import_graph_def</code>.</p>\n<pre><code>import tensorflow as tf\nfrom tensorflow.python.framework import graph_util\n\ninput_jpeg = tf.placeholder(tf.string, name='DecodeJpeg/contents')\nimage = tf.image.decode_jpeg(input_jpeg, channels=3)\nimage = tf.image.convert_image_dtype(image, dtype=tf.float32)\n\nheight = tf.constant(224)\nwidth = tf.constant(224)\ninput_h = tf.shape(image)[0]\ninput_w = tf.shape(image)[1]\n\ndef resize_t(image_t, h=height, w=width):\n  image2 = tf.expand_dims(image_t, axis=0)\n  return image2\n\nimage_checked = tf.cond(\n    (tf.less(input_h, height)), \n    lambda:resize_t(image), lambda:image)\n\nshape_t = tf.shape(image_checked, name='shape_t')\n\nwith tf.Session() as sess:\n  # freeze the graph and export\n  output_graph_def = sess.graph_def\n  output_graph_def = graph_util.convert_variables_to_constants(\n        sess, sess.graph_def, ['shape_t'])\n  output_graph_def = graph_util.remove_training_nodes(output_graph_def)\n  with open('out.pb', 'wb') as f:\n    f.write(output_graph_def.SerializeToString())\n</code></pre>\n<p>The <code>out.pb</code> file can be generated as expected, but when I import it using the code below:</p>\n<pre><code>import tensorflow as tf\nwith open('out.pb', 'rb') as f:\n  graph_content = f.read()\ngraph_def = tf.GraphDef()\ngraph_def.ParseFromString(graph_content)\n_ = tf.import_graph_def(graph_def, name='')\n</code></pre>\n<p>It failed with Message:</p>\n<pre><code>Traceback (most recent call last):\n  File \"im.py\", line 6, in &lt;module&gt;\n    _ = tf.import_graph_def(graph_def, name='')\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.py\", line 342, in import_graph_def\n    % (input_name,)))\nValueError: graph_def is invalid at node u'cond/ExpandDims/dim': More inputs specified ('cond/Switch:1') than the op expects..\n</code></pre>\n<h3>What other attempted solutions have you tried?</h3>\n<p>when I removed the <code>graph_util.remove_training_nodes</code> call, everything works well.<br>\nSo it seems that something goes wrong while removing the Identity nodes from the graph.</p>\n<h3>Logs or other output that would be helpful</h3>\n<p>(If logs are large, please upload as attachment or provide link).<br>\nExploring the <code>.pbtxt</code> generated with and without <code>graph_util.remove_training_nodes</code>,some Identity nodes are removed and the input of ExpandDims/dim is modified to connect to the output of Switch.(maybe?)<br>\nPart of <code>.pbtxt</code> file content without <code>graph_util.remove_training_nodes</code>:</p>\n<pre><code>^Kcond/Switch^R^FSwitch^Z^DLess^Z^DLess*^G\n^AT^R^B0\n\n1\n^Mcond/switch_t^R^HIdentity^Z^Mcond/Switch:1*^G\n^AT^R^B0\n\n'\n^Lcond/pred_id^R^HIdentity^Z^DLess*^G\n^AT^R^B0\n\nM\n^Scond/ExpandDims/dim^R^EConst^Z^N^cond/switch_t*^K\n^Edtype^R^B0^C*^R\n^Evalue^R       B^G^H^C^R^@:^A^@\nh\n^Vcond/ExpandDims/Switch^R^FSwitch^Z^Mconvert_image^Z^Lcond/pred_id*^G\n^AT^R^B0^A*\n^F_class^R^V\n^T^R^Rloc:@convert_image\na\n^Ocond/ExpandDims^R\nExpandDims^Z^Xcond/ExpandDims/Switch:1^Z^Scond/ExpandDims/dim*\n\n^DTdim^R^B0^C*^G\n^AT^R^B0^A\n\n</code></pre>\n<p>Part of <code>.pbtxt</code> file content with <code>graph_util.remove_training_nodes</code>:</p>\n<pre><code>^Kcond/Switch^R^FSwitch^Z^DLess^Z^DLess*^G\n^AT^R^B0\n\nL\n^Scond/ExpandDims/dim^R^EConst^Z^Mcond/Switch:1*^R\n^Evalue^R       B^G^H^C^R^@:^A^@*^K\n^Edtype^R^B0^C\n`\n^Vcond/ExpandDims/Switch^R^FSwitch^Z^Mconvert_image^Z^DLess*^G\n^AT^R^B0^A*\n^F_class^R^V\n^T^R^Rloc:@convert_image\na\n^Ocond/ExpandDims^R\nExpandDims^Z^Xcond/ExpandDims/Switch:1^Z^Scond/ExpandDims/dim*\n\n^DTdim^R^B0^C*^G\n^AT^R^B0^A\n</code></pre>", "body_text": "What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\n#3667 may be the same problem? But that thread is closed without a clear answer.\nEnvironment info\nOperating System:\n\nTensorflow 1.0.0\nPython 2.7\nUbuntu 14.04\n\nInstalled version of CUDA and cuDNN:\n(please attach the output of ls -l /path/to/cuda/lib/libcud*):\nCUDA 8.0\ncuDNN 5.1.10\n*This problem occurs in both GPU and CPU environment.\nIf possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\nThe following code is to produce a .pb file that can be used for tf.import_graph_def.\nimport tensorflow as tf\nfrom tensorflow.python.framework import graph_util\n\ninput_jpeg = tf.placeholder(tf.string, name='DecodeJpeg/contents')\nimage = tf.image.decode_jpeg(input_jpeg, channels=3)\nimage = tf.image.convert_image_dtype(image, dtype=tf.float32)\n\nheight = tf.constant(224)\nwidth = tf.constant(224)\ninput_h = tf.shape(image)[0]\ninput_w = tf.shape(image)[1]\n\ndef resize_t(image_t, h=height, w=width):\n  image2 = tf.expand_dims(image_t, axis=0)\n  return image2\n\nimage_checked = tf.cond(\n    (tf.less(input_h, height)), \n    lambda:resize_t(image), lambda:image)\n\nshape_t = tf.shape(image_checked, name='shape_t')\n\nwith tf.Session() as sess:\n  # freeze the graph and export\n  output_graph_def = sess.graph_def\n  output_graph_def = graph_util.convert_variables_to_constants(\n        sess, sess.graph_def, ['shape_t'])\n  output_graph_def = graph_util.remove_training_nodes(output_graph_def)\n  with open('out.pb', 'wb') as f:\n    f.write(output_graph_def.SerializeToString())\n\nThe out.pb file can be generated as expected, but when I import it using the code below:\nimport tensorflow as tf\nwith open('out.pb', 'rb') as f:\n  graph_content = f.read()\ngraph_def = tf.GraphDef()\ngraph_def.ParseFromString(graph_content)\n_ = tf.import_graph_def(graph_def, name='')\n\nIt failed with Message:\nTraceback (most recent call last):\n  File \"im.py\", line 6, in <module>\n    _ = tf.import_graph_def(graph_def, name='')\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.py\", line 342, in import_graph_def\n    % (input_name,)))\nValueError: graph_def is invalid at node u'cond/ExpandDims/dim': More inputs specified ('cond/Switch:1') than the op expects..\n\nWhat other attempted solutions have you tried?\nwhen I removed the graph_util.remove_training_nodes call, everything works well.\nSo it seems that something goes wrong while removing the Identity nodes from the graph.\nLogs or other output that would be helpful\n(If logs are large, please upload as attachment or provide link).\nExploring the .pbtxt generated with and without graph_util.remove_training_nodes,some Identity nodes are removed and the input of ExpandDims/dim is modified to connect to the output of Switch.(maybe?)\nPart of .pbtxt file content without graph_util.remove_training_nodes:\n^Kcond/Switch^R^FSwitch^Z^DLess^Z^DLess*^G\n^AT^R^B0\n\n1\n^Mcond/switch_t^R^HIdentity^Z^Mcond/Switch:1*^G\n^AT^R^B0\n\n'\n^Lcond/pred_id^R^HIdentity^Z^DLess*^G\n^AT^R^B0\n\nM\n^Scond/ExpandDims/dim^R^EConst^Z^N^cond/switch_t*^K\n^Edtype^R^B0^C*^R\n^Evalue^R       B^G^H^C^R^@:^A^@\nh\n^Vcond/ExpandDims/Switch^R^FSwitch^Z^Mconvert_image^Z^Lcond/pred_id*^G\n^AT^R^B0^A*\n^F_class^R^V\n^T^R^Rloc:@convert_image\na\n^Ocond/ExpandDims^R\nExpandDims^Z^Xcond/ExpandDims/Switch:1^Z^Scond/ExpandDims/dim*\n\n^DTdim^R^B0^C*^G\n^AT^R^B0^A\n\n\nPart of .pbtxt file content with graph_util.remove_training_nodes:\n^Kcond/Switch^R^FSwitch^Z^DLess^Z^DLess*^G\n^AT^R^B0\n\nL\n^Scond/ExpandDims/dim^R^EConst^Z^Mcond/Switch:1*^R\n^Evalue^R       B^G^H^C^R^@:^A^@*^K\n^Edtype^R^B0^C\n`\n^Vcond/ExpandDims/Switch^R^FSwitch^Z^Mconvert_image^Z^DLess*^G\n^AT^R^B0^A*\n^F_class^R^V\n^T^R^Rloc:@convert_image\na\n^Ocond/ExpandDims^R\nExpandDims^Z^Xcond/ExpandDims/Switch:1^Z^Scond/ExpandDims/dim*\n\n^DTdim^R^B0^C*^G\n^AT^R^B0^A", "body": "### What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\r\n#3667 may be the same problem? But that thread is closed without a clear answer.\r\n\r\n### Environment info\r\nOperating System:\r\n\r\n- Tensorflow 1.0.0\r\n- Python 2.7\r\n- Ubuntu 14.04\r\n\r\nInstalled version of CUDA and cuDNN: \r\n(please attach the output of `ls -l /path/to/cuda/lib/libcud*`):\r\nCUDA 8.0\r\ncuDNN 5.1.10\r\n*This problem occurs in both GPU and CPU environment.\r\n\r\n### If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\r\nThe following code is to produce a `.pb` file that can be used for `tf.import_graph_def`.\r\n\r\n```\r\nimport tensorflow as tf\r\nfrom tensorflow.python.framework import graph_util\r\n\r\ninput_jpeg = tf.placeholder(tf.string, name='DecodeJpeg/contents')\r\nimage = tf.image.decode_jpeg(input_jpeg, channels=3)\r\nimage = tf.image.convert_image_dtype(image, dtype=tf.float32)\r\n\r\nheight = tf.constant(224)\r\nwidth = tf.constant(224)\r\ninput_h = tf.shape(image)[0]\r\ninput_w = tf.shape(image)[1]\r\n\r\ndef resize_t(image_t, h=height, w=width):\r\n  image2 = tf.expand_dims(image_t, axis=0)\r\n  return image2\r\n\r\nimage_checked = tf.cond(\r\n    (tf.less(input_h, height)), \r\n    lambda:resize_t(image), lambda:image)\r\n\r\nshape_t = tf.shape(image_checked, name='shape_t')\r\n\r\nwith tf.Session() as sess:\r\n  # freeze the graph and export\r\n  output_graph_def = sess.graph_def\r\n  output_graph_def = graph_util.convert_variables_to_constants(\r\n        sess, sess.graph_def, ['shape_t'])\r\n  output_graph_def = graph_util.remove_training_nodes(output_graph_def)\r\n  with open('out.pb', 'wb') as f:\r\n    f.write(output_graph_def.SerializeToString())\r\n```\r\n\r\nThe `out.pb` file can be generated as expected, but when I import it using the code below:\r\n\r\n```\r\nimport tensorflow as tf\r\nwith open('out.pb', 'rb') as f:\r\n  graph_content = f.read()\r\ngraph_def = tf.GraphDef()\r\ngraph_def.ParseFromString(graph_content)\r\n_ = tf.import_graph_def(graph_def, name='')\r\n```\r\n\r\nIt failed with Message:\r\n```\r\nTraceback (most recent call last):\r\n  File \"im.py\", line 6, in <module>\r\n    _ = tf.import_graph_def(graph_def, name='')\r\n  File \"/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.py\", line 342, in import_graph_def\r\n    % (input_name,)))\r\nValueError: graph_def is invalid at node u'cond/ExpandDims/dim': More inputs specified ('cond/Switch:1') than the op expects..\r\n```\r\n### What other attempted solutions have you tried?\r\nwhen I removed the `graph_util.remove_training_nodes` call, everything works well.\r\nSo it seems that something goes wrong while removing the Identity nodes from the graph.\r\n\r\n\r\n### Logs or other output that would be helpful\r\n(If logs are large, please upload as attachment or provide link).\r\nExploring the `.pbtxt` generated with and without `graph_util.remove_training_nodes`,some Identity nodes are removed and the input of ExpandDims/dim is modified to connect to the output of Switch.(maybe?)\r\nPart of `.pbtxt` file content without `graph_util.remove_training_nodes`:\r\n```\r\n^Kcond/Switch^R^FSwitch^Z^DLess^Z^DLess*^G\r\n^AT^R^B0\r\n\r\n1\r\n^Mcond/switch_t^R^HIdentity^Z^Mcond/Switch:1*^G\r\n^AT^R^B0\r\n\r\n'\r\n^Lcond/pred_id^R^HIdentity^Z^DLess*^G\r\n^AT^R^B0\r\n\r\nM\r\n^Scond/ExpandDims/dim^R^EConst^Z^N^cond/switch_t*^K\r\n^Edtype^R^B0^C*^R\r\n^Evalue^R       B^G^H^C^R^@:^A^@\r\nh\r\n^Vcond/ExpandDims/Switch^R^FSwitch^Z^Mconvert_image^Z^Lcond/pred_id*^G\r\n^AT^R^B0^A*\r\n^F_class^R^V\r\n^T^R^Rloc:@convert_image\r\na\r\n^Ocond/ExpandDims^R\r\nExpandDims^Z^Xcond/ExpandDims/Switch:1^Z^Scond/ExpandDims/dim*\r\n\r\n^DTdim^R^B0^C*^G\r\n^AT^R^B0^A\r\n\r\n```\r\n\r\nPart of `.pbtxt` file content with `graph_util.remove_training_nodes`:\r\n```\r\n^Kcond/Switch^R^FSwitch^Z^DLess^Z^DLess*^G\r\n^AT^R^B0\r\n\r\nL\r\n^Scond/ExpandDims/dim^R^EConst^Z^Mcond/Switch:1*^R\r\n^Evalue^R       B^G^H^C^R^@:^A^@*^K\r\n^Edtype^R^B0^C\r\n`\r\n^Vcond/ExpandDims/Switch^R^FSwitch^Z^Mconvert_image^Z^DLess*^G\r\n^AT^R^B0^A*\r\n^F_class^R^V\r\n^T^R^Rloc:@convert_image\r\na\r\n^Ocond/ExpandDims^R\r\nExpandDims^Z^Xcond/ExpandDims/Switch:1^Z^Scond/ExpandDims/dim*\r\n\r\n^DTdim^R^B0^C*^G\r\n^AT^R^B0^A\r\n```"}