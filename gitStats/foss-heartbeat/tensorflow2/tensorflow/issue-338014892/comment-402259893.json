{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/402259893", "html_url": "https://github.com/tensorflow/tensorflow/issues/20529#issuecomment-402259893", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20529", "id": 402259893, "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjI1OTg5Mw==", "user": {"login": "brge17", "id": 33430930, "node_id": "MDQ6VXNlcjMzNDMwOTMw", "avatar_url": "https://avatars3.githubusercontent.com/u/33430930?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brge17", "html_url": "https://github.com/brge17", "followers_url": "https://api.github.com/users/brge17/followers", "following_url": "https://api.github.com/users/brge17/following{/other_user}", "gists_url": "https://api.github.com/users/brge17/gists{/gist_id}", "starred_url": "https://api.github.com/users/brge17/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brge17/subscriptions", "organizations_url": "https://api.github.com/users/brge17/orgs", "repos_url": "https://api.github.com/users/brge17/repos", "events_url": "https://api.github.com/users/brge17/events{/privacy}", "received_events_url": "https://api.github.com/users/brge17/received_events", "type": "User", "site_admin": false}, "created_at": "2018-07-03T18:57:36Z", "updated_at": "2018-07-16T15:49:16Z", "author_association": "NONE", "body_html": "<h3>Problem 3</h3>\n<p>It appears batches are sometimes missing from stateful metrics. An example is attached below, we define a simple stateful metric: a batch counter that increments each batch. At the end of the epoch the displayed value is either <strong>n</strong> (the total number of batches) or <strong>n-1</strong>.</p>\n<h3>Source code / logs</h3>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> tensorflow.python.keras.layers <span class=\"pl-k\">import</span> Input, Dense\n<span class=\"pl-k\">from</span> tensorflow.python.keras.models <span class=\"pl-k\">import</span> Model\n\n<span class=\"pl-k\">import</span> numpy <span class=\"pl-k\">as</span> np\n\n<span class=\"pl-k\">class</span> <span class=\"pl-en\">BatchCounter</span>(<span class=\"pl-e\">tf</span>.<span class=\"pl-e\">keras</span>.<span class=\"pl-e\">layers</span>.<span class=\"pl-e\">Layer</span>):\n\n        <span class=\"pl-k\">def</span> <span class=\"pl-c1\">__init__</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>, <span class=\"pl-smi\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>batch_counter<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">**</span><span class=\"pl-smi\">kwargs</span>):\n            <span class=\"pl-c1\">super</span>(BatchCounter, <span class=\"pl-c1\">self</span>).<span class=\"pl-c1\">__init__</span>(<span class=\"pl-v\">name</span><span class=\"pl-k\">=</span>name, <span class=\"pl-k\">**</span>kwargs)\n            <span class=\"pl-c1\">self</span>.stateful <span class=\"pl-k\">=</span> <span class=\"pl-c1\">True</span>\n            <span class=\"pl-c1\">self</span>.batches <span class=\"pl-k\">=</span> tf.keras.backend.variable(<span class=\"pl-v\">value</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">0</span>, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>int32<span class=\"pl-pds\">\"</span></span>)\n\n        <span class=\"pl-k\">def</span> <span class=\"pl-en\">reset_states</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>):\n            tf.keras.backend.set_value(<span class=\"pl-c1\">self</span>.batches, <span class=\"pl-c1\">0</span>)\n\n        <span class=\"pl-k\">def</span> <span class=\"pl-c1\">__call__</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>, <span class=\"pl-smi\">y_true</span>, <span class=\"pl-smi\">y_pred</span>):\n            updates <span class=\"pl-k\">=</span> [\n                tf.keras.backend.update_add(\n                    <span class=\"pl-c1\">self</span>.batches, \n                    tf.keras.backend.variable(<span class=\"pl-v\">value</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>int32<span class=\"pl-pds\">\"</span></span>))]\n            <span class=\"pl-c1\">self</span>.add_update(updates)\n            <span class=\"pl-k\">return</span> <span class=\"pl-c1\">self</span>.batches\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> Dummy dataset</span>\nX <span class=\"pl-k\">=</span> np.ones((<span class=\"pl-c1\">50</span>, <span class=\"pl-c1\">1</span>))\ny <span class=\"pl-k\">=</span> np.zeros((<span class=\"pl-c1\">50</span>, <span class=\"pl-c1\">1</span>))\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> Dummy model</span>\ninputs <span class=\"pl-k\">=</span> Input(<span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>(<span class=\"pl-c1\">1</span>,))\noutputs <span class=\"pl-k\">=</span> Dense(<span class=\"pl-c1\">1</span>)(inputs)\nmodel <span class=\"pl-k\">=</span> Model(<span class=\"pl-v\">inputs</span><span class=\"pl-k\">=</span>inputs, <span class=\"pl-v\">outputs</span><span class=\"pl-k\">=</span>outputs)\nmodel.compile(<span class=\"pl-v\">loss</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>mse<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-v\">optimizer</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>adam<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-v\">metrics</span><span class=\"pl-k\">=</span>[BatchCounter()])\n\nmodel.fit(X, y, <span class=\"pl-v\">batch_size</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">10</span>, <span class=\"pl-v\">epochs</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">10</span>, <span class=\"pl-v\">validation_data</span> <span class=\"pl-k\">=</span> (X, y))</pre></div>\n<pre><code>Epoch 1/10\n50/50 [==============================] - 0s 2ms/step - loss: 3.8098e-04 - batch_counter: 5.0000 - val_loss: 1.8327e-04 - val_batch_counter: 4.0000\nEpoch 2/10\n50/50 [==============================] - 0s 93us/step - loss: 1.0319e-04 - batch_counter: 5.0000 - val_loss: 2.0676e-05 - val_batch_counter: 4.0000\nEpoch 3/10\n50/50 [==============================] - 0s 80us/step - loss: 6.5885e-06 - batch_counter: 5.0000 - val_loss: 4.7464e-06 - val_batch_counter: 4.0000\nEpoch 4/10\n50/50 [==============================] - 0s 76us/step - loss: 1.5232e-05 - batch_counter: 5.0000 - val_loss: 2.8963e-05 - val_batch_counter: 5.0000\nEpoch 5/10\n50/50 [==============================] - 0s 76us/step - loss: 3.0441e-05 - batch_counter: 5.0000 - val_loss: 2.6422e-05 - val_batch_counter: 5.0000\nEpoch 6/10\n50/50 [==============================] - 0s 76us/step - loss: 1.9016e-05 - batch_counter: 5.0000 - val_loss: 8.0616e-06 - val_batch_counter: 5.0000\nEpoch 7/10\n50/50 [==============================] - 0s 86us/step - loss: 3.6174e-06 - batch_counter: 4.0000 - val_loss: 2.7267e-08 - val_batch_counter: 4.0000\nEpoch 8/10\n50/50 [==============================] - 0s 91us/step - loss: 7.0071e-07 - batch_counter: 5.0000 - val_loss: 2.4935e-06 - val_batch_counter: 4.0000\nEpoch 9/10\n50/50 [==============================] - 0s 77us/step - loss: 3.3024e-06 - batch_counter: 5.0000 - val_loss: 3.5519e-06 - val_batch_counter: 4.0000\nEpoch 10/10\n50/50 [==============================] - 0s 76us/step - loss: 2.7035e-06 - batch_counter: 4.0000 - val_loss: 1.2286e-06 - val_batch_counter: 4.0000\n</code></pre>\n<p><code>batch_counter</code> &amp; <code>val_batch_counter</code> should always be 5 in the above logs, (50 samples, batch size = 10). They are occasionally 4 or 5. This does not happen in the Keras implementation.</p>", "body_text": "Problem 3\nIt appears batches are sometimes missing from stateful metrics. An example is attached below, we define a simple stateful metric: a batch counter that increments each batch. At the end of the epoch the displayed value is either n (the total number of batches) or n-1.\nSource code / logs\nimport tensorflow as tf\nfrom tensorflow.python.keras.layers import Input, Dense\nfrom tensorflow.python.keras.models import Model\n\nimport numpy as np\n\nclass BatchCounter(tf.keras.layers.Layer):\n\n        def __init__(self, name=\"batch_counter\", **kwargs):\n            super(BatchCounter, self).__init__(name=name, **kwargs)\n            self.stateful = True\n            self.batches = tf.keras.backend.variable(value=0, dtype=\"int32\")\n\n        def reset_states(self):\n            tf.keras.backend.set_value(self.batches, 0)\n\n        def __call__(self, y_true, y_pred):\n            updates = [\n                tf.keras.backend.update_add(\n                    self.batches, \n                    tf.keras.backend.variable(value=1, dtype=\"int32\"))]\n            self.add_update(updates)\n            return self.batches\n\n# Dummy dataset\nX = np.ones((50, 1))\ny = np.zeros((50, 1))\n\n# Dummy model\ninputs = Input(shape=(1,))\noutputs = Dense(1)(inputs)\nmodel = Model(inputs=inputs, outputs=outputs)\nmodel.compile(loss=\"mse\", optimizer=\"adam\", metrics=[BatchCounter()])\n\nmodel.fit(X, y, batch_size=10, epochs=10, validation_data = (X, y))\nEpoch 1/10\n50/50 [==============================] - 0s 2ms/step - loss: 3.8098e-04 - batch_counter: 5.0000 - val_loss: 1.8327e-04 - val_batch_counter: 4.0000\nEpoch 2/10\n50/50 [==============================] - 0s 93us/step - loss: 1.0319e-04 - batch_counter: 5.0000 - val_loss: 2.0676e-05 - val_batch_counter: 4.0000\nEpoch 3/10\n50/50 [==============================] - 0s 80us/step - loss: 6.5885e-06 - batch_counter: 5.0000 - val_loss: 4.7464e-06 - val_batch_counter: 4.0000\nEpoch 4/10\n50/50 [==============================] - 0s 76us/step - loss: 1.5232e-05 - batch_counter: 5.0000 - val_loss: 2.8963e-05 - val_batch_counter: 5.0000\nEpoch 5/10\n50/50 [==============================] - 0s 76us/step - loss: 3.0441e-05 - batch_counter: 5.0000 - val_loss: 2.6422e-05 - val_batch_counter: 5.0000\nEpoch 6/10\n50/50 [==============================] - 0s 76us/step - loss: 1.9016e-05 - batch_counter: 5.0000 - val_loss: 8.0616e-06 - val_batch_counter: 5.0000\nEpoch 7/10\n50/50 [==============================] - 0s 86us/step - loss: 3.6174e-06 - batch_counter: 4.0000 - val_loss: 2.7267e-08 - val_batch_counter: 4.0000\nEpoch 8/10\n50/50 [==============================] - 0s 91us/step - loss: 7.0071e-07 - batch_counter: 5.0000 - val_loss: 2.4935e-06 - val_batch_counter: 4.0000\nEpoch 9/10\n50/50 [==============================] - 0s 77us/step - loss: 3.3024e-06 - batch_counter: 5.0000 - val_loss: 3.5519e-06 - val_batch_counter: 4.0000\nEpoch 10/10\n50/50 [==============================] - 0s 76us/step - loss: 2.7035e-06 - batch_counter: 4.0000 - val_loss: 1.2286e-06 - val_batch_counter: 4.0000\n\nbatch_counter & val_batch_counter should always be 5 in the above logs, (50 samples, batch size = 10). They are occasionally 4 or 5. This does not happen in the Keras implementation.", "body": "### Problem 3\r\n\r\nIt appears batches are sometimes missing from stateful metrics. An example is attached below, we define a simple stateful metric: a batch counter that increments each batch. At the end of the epoch the displayed value is either **n** (the total number of batches) or **n-1**.\r\n\r\n### Source code / logs\r\n```python\r\nimport tensorflow as tf\r\nfrom tensorflow.python.keras.layers import Input, Dense\r\nfrom tensorflow.python.keras.models import Model\r\n\r\nimport numpy as np\r\n\r\nclass BatchCounter(tf.keras.layers.Layer):\r\n\r\n        def __init__(self, name=\"batch_counter\", **kwargs):\r\n            super(BatchCounter, self).__init__(name=name, **kwargs)\r\n            self.stateful = True\r\n            self.batches = tf.keras.backend.variable(value=0, dtype=\"int32\")\r\n\r\n        def reset_states(self):\r\n            tf.keras.backend.set_value(self.batches, 0)\r\n\r\n        def __call__(self, y_true, y_pred):\r\n            updates = [\r\n                tf.keras.backend.update_add(\r\n                    self.batches, \r\n                    tf.keras.backend.variable(value=1, dtype=\"int32\"))]\r\n            self.add_update(updates)\r\n            return self.batches\r\n\r\n# Dummy dataset\r\nX = np.ones((50, 1))\r\ny = np.zeros((50, 1))\r\n\r\n# Dummy model\r\ninputs = Input(shape=(1,))\r\noutputs = Dense(1)(inputs)\r\nmodel = Model(inputs=inputs, outputs=outputs)\r\nmodel.compile(loss=\"mse\", optimizer=\"adam\", metrics=[BatchCounter()])\r\n\r\nmodel.fit(X, y, batch_size=10, epochs=10, validation_data = (X, y))\r\n```\r\n\r\n```\r\nEpoch 1/10\r\n50/50 [==============================] - 0s 2ms/step - loss: 3.8098e-04 - batch_counter: 5.0000 - val_loss: 1.8327e-04 - val_batch_counter: 4.0000\r\nEpoch 2/10\r\n50/50 [==============================] - 0s 93us/step - loss: 1.0319e-04 - batch_counter: 5.0000 - val_loss: 2.0676e-05 - val_batch_counter: 4.0000\r\nEpoch 3/10\r\n50/50 [==============================] - 0s 80us/step - loss: 6.5885e-06 - batch_counter: 5.0000 - val_loss: 4.7464e-06 - val_batch_counter: 4.0000\r\nEpoch 4/10\r\n50/50 [==============================] - 0s 76us/step - loss: 1.5232e-05 - batch_counter: 5.0000 - val_loss: 2.8963e-05 - val_batch_counter: 5.0000\r\nEpoch 5/10\r\n50/50 [==============================] - 0s 76us/step - loss: 3.0441e-05 - batch_counter: 5.0000 - val_loss: 2.6422e-05 - val_batch_counter: 5.0000\r\nEpoch 6/10\r\n50/50 [==============================] - 0s 76us/step - loss: 1.9016e-05 - batch_counter: 5.0000 - val_loss: 8.0616e-06 - val_batch_counter: 5.0000\r\nEpoch 7/10\r\n50/50 [==============================] - 0s 86us/step - loss: 3.6174e-06 - batch_counter: 4.0000 - val_loss: 2.7267e-08 - val_batch_counter: 4.0000\r\nEpoch 8/10\r\n50/50 [==============================] - 0s 91us/step - loss: 7.0071e-07 - batch_counter: 5.0000 - val_loss: 2.4935e-06 - val_batch_counter: 4.0000\r\nEpoch 9/10\r\n50/50 [==============================] - 0s 77us/step - loss: 3.3024e-06 - batch_counter: 5.0000 - val_loss: 3.5519e-06 - val_batch_counter: 4.0000\r\nEpoch 10/10\r\n50/50 [==============================] - 0s 76us/step - loss: 2.7035e-06 - batch_counter: 4.0000 - val_loss: 1.2286e-06 - val_batch_counter: 4.0000\r\n```\r\n\r\n``batch_counter`` & ``val_batch_counter`` should always be 5 in the above logs, (50 samples, batch size = 10). They are occasionally 4 or 5. This does not happen in the Keras implementation.\r\n"}