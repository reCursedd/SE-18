{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/333272260", "html_url": "https://github.com/tensorflow/tensorflow/issues/13146#issuecomment-333272260", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13146", "id": 333272260, "node_id": "MDEyOklzc3VlQ29tbWVudDMzMzI3MjI2MA==", "user": {"login": "tumusudheer", "id": 3826735, "node_id": "MDQ6VXNlcjM4MjY3MzU=", "avatar_url": "https://avatars3.githubusercontent.com/u/3826735?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tumusudheer", "html_url": "https://github.com/tumusudheer", "followers_url": "https://api.github.com/users/tumusudheer/followers", "following_url": "https://api.github.com/users/tumusudheer/following{/other_user}", "gists_url": "https://api.github.com/users/tumusudheer/gists{/gist_id}", "starred_url": "https://api.github.com/users/tumusudheer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tumusudheer/subscriptions", "organizations_url": "https://api.github.com/users/tumusudheer/orgs", "repos_url": "https://api.github.com/users/tumusudheer/repos", "events_url": "https://api.github.com/users/tumusudheer/events{/privacy}", "received_events_url": "https://api.github.com/users/tumusudheer/received_events", "type": "User", "site_admin": false}, "created_at": "2017-09-30T01:23:55Z", "updated_at": "2017-09-30T02:20:48Z", "author_association": "NONE", "body_html": "<p>Hi <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1034716\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/zhangyaobit\">@zhangyaobit</a>,</p>\n<p>Sorry for my delay and Thank you very much for going through the TextBoxes code, I really appreciate your help.</p>\n<ol>\n<li>I added import pdb; pdb.set_trace() here<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L311\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L311</a></li>\n</ol>\n<p>Here are the findings:</p>\n<pre><code>(Pdb) params_shape\nTensorShape([Dimension(1024)])\n(Pdb) inputs_shape\nTensorShape([Dimension(32), Dimension(19), Dimension(19), Dimension(1024)])\n\n</code></pre>\n<p>params_shape is not the number of channels but instead it was 1024 which is obviously wrong. Somewhere along the lines in the model, data (shapes) is not being transposed/handled correctly for NHWC.</p>\n<ol start=\"2\">\n<li>Also added pdb.set_trace() here:<br>\n<a href=\"https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L209\">https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L209</a></li>\n</ol>\n<pre><code>&gt; /home/sudheer/Flipkart/Research/maneesh/tensorflow_1.2/models/TextBoxes-TensorFlow_2.0/nets/txtbox_300.py(210)text_net()\n-&gt; end_points = {}\n(Pdb) inputs\n&lt;tf.Tensor 'fifo_queue_Dequeue:0' shape=(32, 300, 300, 3) dtype=float32&gt;\n\n</code></pre>\n<p>The shape of the input tensor is being set correctly. That is because I'm sending this extra <code>data_format</code> param to preprocessing function here.<br>\n<a href=\"https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/load_batch.py#L44\">https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/load_batch.py#L44<br>\n</a><br>\nThe code is supposed to be<br>\n<code>txt_preprocessing.preprocess_image(image,  glabels, gbboxes, height, width,                                                                                   out_shape,use_whiten=FLAGS.use_whiten,is_training=is_training,data_format=FLAGS.data_format)</code></p>\n<p>I guess I need to start debugging the model code to find out the place where dimensions are being set incorrectly.</p>\n<p>Added:</p>\n<p>Just found one mistake in the model: No matter what my input data_format is , the data_format is always being NHWC here:<br>\n<a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L312\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L312</a></p>\n<p>I guess in the code here <a href=\"https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L288\">https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L288</a>, batch_norm is being called but data_format is not being passed as input params for batch_norm</p>\n<p>If I add batch_norm as part of the arg_scope here: <a href=\"https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L386\">https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L386</a>, will the data_format be passed into _fused_batch_norm function ? or do I need to put data_format as part of batch_norm_params here ?<br>\n<a href=\"https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L200\">https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L200</a></p>\n<p>Thank you</p>", "body_text": "Hi @zhangyaobit,\nSorry for my delay and Thank you very much for going through the TextBoxes code, I really appreciate your help.\n\nI added import pdb; pdb.set_trace() here\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L311\n\nHere are the findings:\n(Pdb) params_shape\nTensorShape([Dimension(1024)])\n(Pdb) inputs_shape\nTensorShape([Dimension(32), Dimension(19), Dimension(19), Dimension(1024)])\n\n\nparams_shape is not the number of channels but instead it was 1024 which is obviously wrong. Somewhere along the lines in the model, data (shapes) is not being transposed/handled correctly for NHWC.\n\nAlso added pdb.set_trace() here:\nhttps://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L209\n\n> /home/sudheer/Flipkart/Research/maneesh/tensorflow_1.2/models/TextBoxes-TensorFlow_2.0/nets/txtbox_300.py(210)text_net()\n-> end_points = {}\n(Pdb) inputs\n<tf.Tensor 'fifo_queue_Dequeue:0' shape=(32, 300, 300, 3) dtype=float32>\n\n\nThe shape of the input tensor is being set correctly. That is because I'm sending this extra data_format param to preprocessing function here.\nhttps://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/load_batch.py#L44\n\nThe code is supposed to be\ntxt_preprocessing.preprocess_image(image,  glabels, gbboxes, height, width,                                                                                   out_shape,use_whiten=FLAGS.use_whiten,is_training=is_training,data_format=FLAGS.data_format)\nI guess I need to start debugging the model code to find out the place where dimensions are being set incorrectly.\nAdded:\nJust found one mistake in the model: No matter what my input data_format is , the data_format is always being NHWC here:\nhttps://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L312\nI guess in the code here https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L288, batch_norm is being called but data_format is not being passed as input params for batch_norm\nIf I add batch_norm as part of the arg_scope here: https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L386, will the data_format be passed into _fused_batch_norm function ? or do I need to put data_format as part of batch_norm_params here ?\nhttps://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L200\nThank you", "body": "Hi @zhangyaobit,\r\n\r\nSorry for my delay and Thank you very much for going through the TextBoxes code, I really appreciate your help.\r\n\r\n1) I added import pdb; pdb.set_trace() here\r\n[https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L311](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L311)\r\n\r\nHere are the findings:\r\n```\r\n(Pdb) params_shape\r\nTensorShape([Dimension(1024)])\r\n(Pdb) inputs_shape\r\nTensorShape([Dimension(32), Dimension(19), Dimension(19), Dimension(1024)])\r\n\r\n```\r\nparams_shape is not the number of channels but instead it was 1024 which is obviously wrong. Somewhere along the lines in the model, data (shapes) is not being transposed/handled correctly for NHWC.\r\n\r\n2) Also added pdb.set_trace() here:\r\n[https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L209](https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L209)\r\n\r\n```\r\n> /home/sudheer/Flipkart/Research/maneesh/tensorflow_1.2/models/TextBoxes-TensorFlow_2.0/nets/txtbox_300.py(210)text_net()\r\n-> end_points = {}\r\n(Pdb) inputs\r\n<tf.Tensor 'fifo_queue_Dequeue:0' shape=(32, 300, 300, 3) dtype=float32>\r\n\r\n```\r\nThe shape of the input tensor is being set correctly. That is because I'm sending this extra `data_format` param to preprocessing function here.\r\n[https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/load_batch.py#L44\r\n](https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/load_batch.py#L44\r\n)\r\nThe code is supposed to be \r\n`txt_preprocessing.preprocess_image(image,  glabels, gbboxes, height, width,                                                                                   out_shape,use_whiten=FLAGS.use_whiten,is_training=is_training,data_format=FLAGS.data_format)`\r\n\r\nI guess I need to start debugging the model code to find out the place where dimensions are being set incorrectly.\r\n\r\nAdded:\r\n\r\nJust found one mistake in the model: No matter what my input data_format is , the data_format is always being NHWC here:\r\n[https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L312](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/layers/python/layers/layers.py#L312)\r\n\r\nI guess in the code here [https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L288](https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L288), batch_norm is being called but data_format is not being passed as input params for batch_norm\r\n\r\nIf I add batch_norm as part of the arg_scope here: [https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L386](https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L386), will the data_format be passed into _fused_batch_norm function ? or do I need to put data_format as part of batch_norm_params here ?\r\n[https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L200](https://github.com/tumusudheer/TextBoxes-TensorFlow/blob/master/nets/txtbox_300.py#L200)\r\n\r\n\r\n\r\n\r\nThank you"}