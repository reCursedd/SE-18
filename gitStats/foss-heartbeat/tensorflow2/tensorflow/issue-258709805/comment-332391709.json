{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/332391709", "html_url": "https://github.com/tensorflow/tensorflow/issues/13146#issuecomment-332391709", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13146", "id": 332391709, "node_id": "MDEyOklzc3VlQ29tbWVudDMzMjM5MTcwOQ==", "user": {"login": "tumusudheer", "id": 3826735, "node_id": "MDQ6VXNlcjM4MjY3MzU=", "avatar_url": "https://avatars3.githubusercontent.com/u/3826735?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tumusudheer", "html_url": "https://github.com/tumusudheer", "followers_url": "https://api.github.com/users/tumusudheer/followers", "following_url": "https://api.github.com/users/tumusudheer/following{/other_user}", "gists_url": "https://api.github.com/users/tumusudheer/gists{/gist_id}", "starred_url": "https://api.github.com/users/tumusudheer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tumusudheer/subscriptions", "organizations_url": "https://api.github.com/users/tumusudheer/orgs", "repos_url": "https://api.github.com/users/tumusudheer/repos", "events_url": "https://api.github.com/users/tumusudheer/events{/privacy}", "received_events_url": "https://api.github.com/users/tumusudheer/received_events", "type": "User", "site_admin": false}, "created_at": "2017-09-27T02:35:52Z", "updated_at": "2017-09-27T02:41:54Z", "author_association": "NONE", "body_html": "<p>Hi <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1034716\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/zhangyaobit\">@zhangyaobit</a> ,</p>\n<p>Thank you very much for your response. For running inference on CPU, I created my graph such that all operations (conv2D and MaxPool) take NHWC data instead of NCHW. But when I'm restoring the checkpoint (which I obtained by training the graph using NCHW format on GPUs), I'm getting the following errors:</p>\n<pre><code>InvalidArgumentError (see above for traceback): Assign requires shapes of both tensors to match. lhs shape= [28] rhs shape= [3]\n         [[Node: save/Assign_16 = Assign[T=DT_FLOAT, _class=[\"loc:@text_box_300/conv10_box/conv_cls/BatchNorm/moving_mean\"], use_locking=true, validate_shape=true, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](text_box_300/conv10_box/conv_cls/BatchNorm/moving_mean, save/RestoreV2_16/_23)]]\n</code></pre>\n<p>I've attached complete error log in case you need (I've attached the code as well).</p>\n<p><a href=\"https://github.com/tensorflow/tensorflow/files/1335594/create_stand_alone.py.txt\">create_stand_alone.py.txt</a></p>\n<p>These are the steps I've followed as part of creating stand alone graph/model to run inference on CPUS:</p>\n<ol>\n<li>Created graph with all Ops supporting NHWC</li>\n<li>Restoring the checkpoint with weights (which has been trained on GPU by using graph with NCHW Ops)</li>\n<li>Save the final graph as .pb file</li>\n</ol>\n<p>I'm working on the <a href=\"https://github.com/tumusudheer/TextBoxes-TensorFlow\">this</a> model and was able to successfully run inference on GPUs but not on CPUs because of NHWC data format issue</p>\n<p><a href=\"https://github.com/tensorflow/tensorflow/files/1335632/error.txt\">error.txt</a></p>\n<p>It seems the cause of the error is tensorflow not able to assign the weights that have been restored from NCHW  graph checkpoint to NHWC graph variables. But when the checkpoint contains weights in the same format irrespective of data_format (as per your previous post), I should not get the error for dimension mis-match while assigning weights to graph variables. Am I missing something here or doing any thing wrong ? Can you please let me know if I'm doing any basic mistake or doing any thing wrong ? I can also provide my checkpoint files in case you need them.</p>\n<p>Thanks in advance.</p>", "body_text": "Hi @zhangyaobit ,\nThank you very much for your response. For running inference on CPU, I created my graph such that all operations (conv2D and MaxPool) take NHWC data instead of NCHW. But when I'm restoring the checkpoint (which I obtained by training the graph using NCHW format on GPUs), I'm getting the following errors:\nInvalidArgumentError (see above for traceback): Assign requires shapes of both tensors to match. lhs shape= [28] rhs shape= [3]\n         [[Node: save/Assign_16 = Assign[T=DT_FLOAT, _class=[\"loc:@text_box_300/conv10_box/conv_cls/BatchNorm/moving_mean\"], use_locking=true, validate_shape=true, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](text_box_300/conv10_box/conv_cls/BatchNorm/moving_mean, save/RestoreV2_16/_23)]]\n\nI've attached complete error log in case you need (I've attached the code as well).\ncreate_stand_alone.py.txt\nThese are the steps I've followed as part of creating stand alone graph/model to run inference on CPUS:\n\nCreated graph with all Ops supporting NHWC\nRestoring the checkpoint with weights (which has been trained on GPU by using graph with NCHW Ops)\nSave the final graph as .pb file\n\nI'm working on the this model and was able to successfully run inference on GPUs but not on CPUs because of NHWC data format issue\nerror.txt\nIt seems the cause of the error is tensorflow not able to assign the weights that have been restored from NCHW  graph checkpoint to NHWC graph variables. But when the checkpoint contains weights in the same format irrespective of data_format (as per your previous post), I should not get the error for dimension mis-match while assigning weights to graph variables. Am I missing something here or doing any thing wrong ? Can you please let me know if I'm doing any basic mistake or doing any thing wrong ? I can also provide my checkpoint files in case you need them.\nThanks in advance.", "body": "Hi @zhangyaobit ,\r\n\r\nThank you very much for your response. For running inference on CPU, I created my graph such that all operations (conv2D and MaxPool) take NHWC data instead of NCHW. But when I'm restoring the checkpoint (which I obtained by training the graph using NCHW format on GPUs), I'm getting the following errors:\r\n\r\n```\r\nInvalidArgumentError (see above for traceback): Assign requires shapes of both tensors to match. lhs shape= [28] rhs shape= [3]\r\n         [[Node: save/Assign_16 = Assign[T=DT_FLOAT, _class=[\"loc:@text_box_300/conv10_box/conv_cls/BatchNorm/moving_mean\"], use_locking=true, validate_shape=true, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](text_box_300/conv10_box/conv_cls/BatchNorm/moving_mean, save/RestoreV2_16/_23)]]\r\n```\r\nI've attached complete error log in case you need (I've attached the code as well).\r\n\r\n[create_stand_alone.py.txt](https://github.com/tensorflow/tensorflow/files/1335594/create_stand_alone.py.txt)\r\n\r\n\r\nThese are the steps I've followed as part of creating stand alone graph/model to run inference on CPUS:\r\n1. Created graph with all Ops supporting NHWC\r\n2. Restoring the checkpoint with weights (which has been trained on GPU by using graph with NCHW Ops)\r\n3. Save the final graph as .pb file\r\n\r\nI'm working on the [this](https://github.com/tumusudheer/TextBoxes-TensorFlow) model and was able to successfully run inference on GPUs but not on CPUs because of NHWC data format issue\r\n\r\n[error.txt](https://github.com/tensorflow/tensorflow/files/1335632/error.txt)\r\n\r\n\r\nIt seems the cause of the error is tensorflow not able to assign the weights that have been restored from NCHW  graph checkpoint to NHWC graph variables. But when the checkpoint contains weights in the same format irrespective of data_format (as per your previous post), I should not get the error for dimension mis-match while assigning weights to graph variables. Am I missing something here or doing any thing wrong ? Can you please let me know if I'm doing any basic mistake or doing any thing wrong ? I can also provide my checkpoint files in case you need them.\r\n\r\nThanks in advance. \r\n\r\n\r\n\r\n"}