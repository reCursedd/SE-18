{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/122246561", "pull_request_review_id": 44346893, "id": 122246561, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyMjI0NjU2MQ==", "diff_hunk": "@@ -2183,12 +2190,26 @@ def __init__(self,\n     self._name = name\n \n   def get_yield_op(self):\n-    \"\"\"Add a node that yields a minibatch every time it is executed.\"\"\"\n-    return gen_data_flow_ops.record_input(\n+    \"\"\"Adds a node that yields a group of records every time it is executed.\n+    If RecordInput `batches` parameter is not None, it yields a list of\n+    record batches with the specified `batch_size`.\n+    \"\"\"\n+    records = gen_data_flow_ops.record_input(\n         file_pattern=self._file_pattern,\n         file_buffer_size=self._buffer_size,\n         file_parallelism=self._parallelism,\n         file_shuffle_shift_ratio=self._shift_ratio,\n         batch_size=self._batch_size,\n         file_random_seed=self._seed,\n         name=self._name)\n+    if self._batches is None:\n+      return records\n+    else:\n+      with ops.name_scope(self._name):\n+        batch_list = [[] for i in six.moves.range(self._batches)]\n+        records = array_ops.split(records, self._batch_size, 0)\n+        records = [array_ops.reshape(record, []) for record in records]\n+        for index, protobuf in zip(six.moves.range(len(records)), records):\n+          batch_index = index % self._batches\n+          batch_list[batch_index].append(protobuf)", "path": "tensorflow/python/ops/data_flow_ops.py", "position": 57, "original_position": 57, "commit_id": "4af5ca8a59917f3f5c4d213719d468ac7990731c", "original_commit_id": "4af5ca8a59917f3f5c4d213719d468ac7990731c", "user": {"login": "ahundt", "id": 55744, "node_id": "MDQ6VXNlcjU1NzQ0", "avatar_url": "https://avatars1.githubusercontent.com/u/55744?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahundt", "html_url": "https://github.com/ahundt", "followers_url": "https://api.github.com/users/ahundt/followers", "following_url": "https://api.github.com/users/ahundt/following{/other_user}", "gists_url": "https://api.github.com/users/ahundt/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahundt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahundt/subscriptions", "organizations_url": "https://api.github.com/users/ahundt/orgs", "repos_url": "https://api.github.com/users/ahundt/repos", "events_url": "https://api.github.com/users/ahundt/events{/privacy}", "received_events_url": "https://api.github.com/users/ahundt/received_events", "type": "User", "site_admin": false}, "body": "@ekelsen I just realized I forgot to include the equivalent of the lines that [uses parallel_stack to combine batches](https://github.com/tensorflow/benchmarks/blob/b9221114d1261ec28f103455178abcfbeeb9b498/scripts/tf_cnn_benchmarks/preprocessing.py#L378) together. Do you think that belongs here as well or should it stay in user code? \r\n\r\nHowever, leaving things as they are may make sense. That's because this code contains full records they'll need to reorganize according to their features so they can do that as they need.\r\n\r\n```\r\n      for device_index in xrange(self.device_count):\r\n        images[device_index] = tf.parallel_stack(images[device_index])\r\n        label_index_batch[device_index] = tf.concat(labels[device_index], 0)\r\n```", "created_at": "2017-06-15T16:17:12Z", "updated_at": "2017-06-15T16:18:56Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/10143#discussion_r122246561", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/10143", "author_association": "NONE", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/122246561"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/10143#discussion_r122246561"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/10143"}}, "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=2533174\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ekelsen\">@ekelsen</a> I just realized I forgot to include the equivalent of the lines that <a href=\"https://github.com/tensorflow/benchmarks/blob/b9221114d1261ec28f103455178abcfbeeb9b498/scripts/tf_cnn_benchmarks/preprocessing.py#L378\">uses parallel_stack to combine batches</a> together. Do you think that belongs here as well or should it stay in user code?</p>\n<p>However, leaving things as they are may make sense. That's because this code contains full records they'll need to reorganize according to their features so they can do that as they need.</p>\n<pre><code>      for device_index in xrange(self.device_count):\n        images[device_index] = tf.parallel_stack(images[device_index])\n        label_index_batch[device_index] = tf.concat(labels[device_index], 0)\n</code></pre>", "body_text": "@ekelsen I just realized I forgot to include the equivalent of the lines that uses parallel_stack to combine batches together. Do you think that belongs here as well or should it stay in user code?\nHowever, leaving things as they are may make sense. That's because this code contains full records they'll need to reorganize according to their features so they can do that as they need.\n      for device_index in xrange(self.device_count):\n        images[device_index] = tf.parallel_stack(images[device_index])\n        label_index_batch[device_index] = tf.concat(labels[device_index], 0)"}