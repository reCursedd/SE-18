{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18260", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18260/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18260/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18260/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/18260", "id": 311599635, "node_id": "MDU6SXNzdWUzMTE1OTk2MzU=", "number": 18260, "title": "[BUG] [1.8] prefetch_to_device() doesn't work with eager Iterators", "user": {"login": "Pyrestone", "id": 20396757, "node_id": "MDQ6VXNlcjIwMzk2NzU3", "avatar_url": "https://avatars1.githubusercontent.com/u/20396757?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Pyrestone", "html_url": "https://github.com/Pyrestone", "followers_url": "https://api.github.com/users/Pyrestone/followers", "following_url": "https://api.github.com/users/Pyrestone/following{/other_user}", "gists_url": "https://api.github.com/users/Pyrestone/gists{/gist_id}", "starred_url": "https://api.github.com/users/Pyrestone/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Pyrestone/subscriptions", "organizations_url": "https://api.github.com/users/Pyrestone/orgs", "repos_url": "https://api.github.com/users/Pyrestone/repos", "events_url": "https://api.github.com/users/Pyrestone/events{/privacy}", "received_events_url": "https://api.github.com/users/Pyrestone/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 10, "created_at": "2018-04-05T12:58:56Z", "updated_at": "2018-05-22T10:39:52Z", "closed_at": "2018-04-06T21:25:38Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: YES, Minimal (non-) working example can be seen below.</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Windows 10</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: pip install tf-nightly-gpu (05.04.2018)</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.8.0.dev20180329</li>\n<li><strong>Python version</strong>: Python 3.6.3</li>\n<li><strong>Bazel version (if compiling from source)</strong>: --</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: --</li>\n<li><strong>CUDA/cuDNN version</strong>: CUDA 9, CuDNN 7.1</li>\n<li><strong>GPU model and memory</strong>: 2x GTX 1080 8GB</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\ncontrib_data<span class=\"pl-k\">=</span>tf.contrib.data\ndata<span class=\"pl-k\">=</span>tf.data\n<span class=\"pl-k\">import</span> tensorflow.contrib.eager <span class=\"pl-k\">as</span> tfe\ntf.enable_eager_execution()\nds<span class=\"pl-k\">=</span>data.Dataset.range(<span class=\"pl-c1\">50</span>)\nds<span class=\"pl-k\">=</span>ds.apply(contrib_data.prefetch_to_device(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/gpu:1<span class=\"pl-pds\">\"</span></span>))\nit<span class=\"pl-k\">=</span>tfe.Iterator(ds)</pre></div>\n<h3>Describe the problem</h3>\n<p>Even when applying prefetch_to_device as the last operation, it throws the following error:</p>\n<h3>logs</h3>\n<pre><code>WARNING:tensorflow:From C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\learn\\python\\learn\\datasets\\base.py:198: retry (from tensorflow.contrib.learn.python.learn.datasets.base) is deprecated and will be removed in a future version.\nInstructions for updating:\nUse the retry module or similar alternatives.\n2018-04-05 14:40:24.616506: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2\n2018-04-05 14:40:24.831563: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1355] Found device 0 with properties: \nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.835\npciBusID: 0000:01:00.0\ntotalMemory: 8.00GiB freeMemory: 6.52GiB\n2018-04-05 14:40:24.883091: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1355] Found device 1 with properties: \nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.835\npciBusID: 0000:02:00.0\ntotalMemory: 8.00GiB freeMemory: 6.52GiB\n2018-04-05 14:40:24.883562: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1434] Adding visible gpu devices: 0, 1\n2018-04-05 14:40:25.804203: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:922] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-04-05 14:40:25.804487: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:928]      0 1 \n2018-04-05 14:40:25.804689: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:941] 0:   N N \n2018-04-05 14:40:25.804889: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:941] 1:   N N \n2018-04-05 14:40:25.805180: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1052] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 6303 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080, pci bus id: 0000:01:00.0, compute capability: 6.1)\n2018-04-05 14:40:26.469466: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1052] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 6303 MB memory) -&gt; physical GPU (device: 1, name: GeForce GTX 1080, pci bus id: 0000:02:00.0, compute capability: 6.1)\nTraceback (most recent call last):\n  File \"MWE.py\", line 17, in &lt;module&gt;\n    it=tfe.Iterator(ds)\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\eager\\python\\datasets.py\", line 76, in __init__\n    super(Iterator, self).__init__(dataset)\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\data\\ops\\iterator_ops.py\", line 463, in __init__\n    ds_variant = dataset._as_variant_tensor()  # pylint: disable=protected-access\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\data\\python\\ops\\prefetching_ops.py\", line 154, in _as_variant_tensor\n    raise NotImplementedError(\"`prefetch_to_device()` must be the last \"\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): YES, Minimal (non-) working example can be seen below.\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows 10\nTensorFlow installed from (source or binary): pip install tf-nightly-gpu (05.04.2018)\nTensorFlow version (use command below): 1.8.0.dev20180329\nPython version: Python 3.6.3\nBazel version (if compiling from source): --\nGCC/Compiler version (if compiling from source): --\nCUDA/cuDNN version: CUDA 9, CuDNN 7.1\nGPU model and memory: 2x GTX 1080 8GB\nExact command to reproduce:\n\nimport tensorflow as tf\ncontrib_data=tf.contrib.data\ndata=tf.data\nimport tensorflow.contrib.eager as tfe\ntf.enable_eager_execution()\nds=data.Dataset.range(50)\nds=ds.apply(contrib_data.prefetch_to_device(\"/gpu:1\"))\nit=tfe.Iterator(ds)\nDescribe the problem\nEven when applying prefetch_to_device as the last operation, it throws the following error:\nlogs\nWARNING:tensorflow:From C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\learn\\python\\learn\\datasets\\base.py:198: retry (from tensorflow.contrib.learn.python.learn.datasets.base) is deprecated and will be removed in a future version.\nInstructions for updating:\nUse the retry module or similar alternatives.\n2018-04-05 14:40:24.616506: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2\n2018-04-05 14:40:24.831563: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1355] Found device 0 with properties: \nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.835\npciBusID: 0000:01:00.0\ntotalMemory: 8.00GiB freeMemory: 6.52GiB\n2018-04-05 14:40:24.883091: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1355] Found device 1 with properties: \nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.835\npciBusID: 0000:02:00.0\ntotalMemory: 8.00GiB freeMemory: 6.52GiB\n2018-04-05 14:40:24.883562: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1434] Adding visible gpu devices: 0, 1\n2018-04-05 14:40:25.804203: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:922] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-04-05 14:40:25.804487: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:928]      0 1 \n2018-04-05 14:40:25.804689: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:941] 0:   N N \n2018-04-05 14:40:25.804889: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:941] 1:   N N \n2018-04-05 14:40:25.805180: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1052] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 6303 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080, pci bus id: 0000:01:00.0, compute capability: 6.1)\n2018-04-05 14:40:26.469466: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1052] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 6303 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080, pci bus id: 0000:02:00.0, compute capability: 6.1)\nTraceback (most recent call last):\n  File \"MWE.py\", line 17, in <module>\n    it=tfe.Iterator(ds)\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\eager\\python\\datasets.py\", line 76, in __init__\n    super(Iterator, self).__init__(dataset)\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\data\\ops\\iterator_ops.py\", line 463, in __init__\n    ds_variant = dataset._as_variant_tensor()  # pylint: disable=protected-access\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\data\\python\\ops\\prefetching_ops.py\", line 154, in _as_variant_tensor\n    raise NotImplementedError(\"`prefetch_to_device()` must be the last \"\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: YES, Minimal (non-) working example can be seen below.\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Windows 10\r\n- **TensorFlow installed from (source or binary)**: pip install tf-nightly-gpu (05.04.2018)\r\n- **TensorFlow version (use command below)**: 1.8.0.dev20180329\r\n- **Python version**: Python 3.6.3\r\n- **Bazel version (if compiling from source)**: --\r\n- **GCC/Compiler version (if compiling from source)**: --\r\n- **CUDA/cuDNN version**: CUDA 9, CuDNN 7.1\r\n- **GPU model and memory**: 2x GTX 1080 8GB\r\n- **Exact command to reproduce**: \r\n```python\r\nimport tensorflow as tf\r\ncontrib_data=tf.contrib.data\r\ndata=tf.data\r\nimport tensorflow.contrib.eager as tfe\r\ntf.enable_eager_execution()\r\nds=data.Dataset.range(50)\r\nds=ds.apply(contrib_data.prefetch_to_device(\"/gpu:1\"))\r\nit=tfe.Iterator(ds)\r\n```\r\n### Describe the problem\r\nEven when applying prefetch_to_device as the last operation, it throws the following error:\r\n\r\n### logs\r\n```\r\nWARNING:tensorflow:From C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\learn\\python\\learn\\datasets\\base.py:198: retry (from tensorflow.contrib.learn.python.learn.datasets.base) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nUse the retry module or similar alternatives.\r\n2018-04-05 14:40:24.616506: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\platform\\cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2\r\n2018-04-05 14:40:24.831563: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1355] Found device 0 with properties: \r\nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.835\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 8.00GiB freeMemory: 6.52GiB\r\n2018-04-05 14:40:24.883091: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1355] Found device 1 with properties: \r\nname: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.835\r\npciBusID: 0000:02:00.0\r\ntotalMemory: 8.00GiB freeMemory: 6.52GiB\r\n2018-04-05 14:40:24.883562: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1434] Adding visible gpu devices: 0, 1\r\n2018-04-05 14:40:25.804203: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:922] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-04-05 14:40:25.804487: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:928]      0 1 \r\n2018-04-05 14:40:25.804689: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:941] 0:   N N \r\n2018-04-05 14:40:25.804889: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:941] 1:   N N \r\n2018-04-05 14:40:25.805180: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1052] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 6303 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\n2018-04-05 14:40:26.469466: I C:\\tf_jenkins\\workspace\\tf-nightly-windows\\M\\windows-gpu\\PY\\36\\tensorflow\\core\\common_runtime\\gpu\\gpu_device.cc:1052] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 6303 MB memory) -> physical GPU (device: 1, name: GeForce GTX 1080, pci bus id: 0000:02:00.0, compute capability: 6.1)\r\nTraceback (most recent call last):\r\n  File \"MWE.py\", line 17, in <module>\r\n    it=tfe.Iterator(ds)\r\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\eager\\python\\datasets.py\", line 76, in __init__\r\n    super(Iterator, self).__init__(dataset)\r\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\python\\data\\ops\\iterator_ops.py\", line 463, in __init__\r\n    ds_variant = dataset._as_variant_tensor()  # pylint: disable=protected-access\r\n  File \"C:\\Users\\PHANTOM\\AppData\\Local\\Programs\\Python\\Python36\\lib\\site-packages\\tensorflow\\contrib\\data\\python\\ops\\prefetching_ops.py\", line 154, in _as_variant_tensor\r\n    raise NotImplementedError(\"`prefetch_to_device()` must be the last \"\r\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.\r\n```"}