{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/337496324", "html_url": "https://github.com/tensorflow/tensorflow/pull/13666#issuecomment-337496324", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13666", "id": 337496324, "node_id": "MDEyOklzc3VlQ29tbWVudDMzNzQ5NjMyNA==", "user": {"login": "jinze1994", "id": 13191886, "node_id": "MDQ6VXNlcjEzMTkxODg2", "avatar_url": "https://avatars3.githubusercontent.com/u/13191886?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jinze1994", "html_url": "https://github.com/jinze1994", "followers_url": "https://api.github.com/users/jinze1994/followers", "following_url": "https://api.github.com/users/jinze1994/following{/other_user}", "gists_url": "https://api.github.com/users/jinze1994/gists{/gist_id}", "starred_url": "https://api.github.com/users/jinze1994/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jinze1994/subscriptions", "organizations_url": "https://api.github.com/users/jinze1994/orgs", "repos_url": "https://api.github.com/users/jinze1994/repos", "events_url": "https://api.github.com/users/jinze1994/events{/privacy}", "received_events_url": "https://api.github.com/users/jinze1994/received_events", "type": "User", "site_admin": false}, "created_at": "2017-10-18T08:10:32Z", "updated_at": "2017-10-18T08:30:56Z", "author_association": "CONTRIBUTOR", "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=17578177\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/cwhipkey\">@cwhipkey</a> Thank you for your reviews.</p>\n<ul>\n<li>I've made changes according to your comments.</li>\n<li>I've add shard function for CPU version in this PR, which gets rid of trouble of a new PR.</li>\n<li>I've add the benchmark in <code>core/kernel/diag_op_test.cc</code>, and compare with the old in performance.</li>\n</ul>\n<p>In general, current version in CPU can speed 10 times, and version in GPU can speed more than 100 times for length or 512.<br>\nHere are the results:</p>\n<h4>Old Version in CPU (<a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/96f334b0d6ec61f5037b8ddd1860a9aa7874efef/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/96f334b0d6ec61f5037b8ddd1860a9aa7874efef\"><tt>96f334b</tt></a>)</h4>\n<pre><code>$bazel test :diag_op_test --test_arg=--benchmarks=all --test_output=all\n...\n==================== Test output for //tensorflow/core/kernels:diag_op_test:\n2017-10-18 07:12:01.963569: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\nRunning main() from test_main.cc\nBenchmark                      Time(ns) Iterations\n--------------------------------------------------\nBM_Diag_16_DT_INT32_cpu           25606      28894       0.6M items/s\nBM_Diag_16_DT_FLOAT_cpu           23701      29621       0.7M items/s\nBM_Diag_16_DT_COMPLEX64_cpu       22794      30482       0.7M items/s\nBM_Diag_128_DT_INT32_cpu         236919       3006       0.5M items/s\nBM_Diag_128_DT_FLOAT_cpu         225901       3035       0.6M items/s\nBM_Diag_128_DT_COMPLEX64_cpu     248124       2874       0.5M items/s\nBM_Diag_512_DT_INT32_cpu        3368587        208       0.2M items/s\nBM_Diag_512_DT_FLOAT_cpu        3242726        215       0.2M items/s\nBM_Diag_512_DT_COMPLEX64_cpu    3517025        199       0.1M items/s\n================================================================================\n//tensorflow/core/kernels:diag_op_test                                   PASSED in 9.3s\n\nExecuted 1 out of 1 test: 1 test passes.\n</code></pre>\n<h4>Current Version in CPU&amp;GPU (<a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/36e9764583f856a00fb3573daaea74812c8edf47/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/36e9764583f856a00fb3573daaea74812c8edf47\"><tt>36e9764</tt></a>)</h4>\n<pre><code>Running main() from test_main.cc\nBenchmark                      Time(ns) Iterations\n--------------------------------------------------\nBM_Diag_16_DT_INT32_cpu           18760      34370       0.9M items/s\nBM_Diag_16_DT_FLOAT_cpu           19241      34903       0.8M items/s\nBM_Diag_16_DT_COMPLEX64_cpu       19791      33423       0.8M items/s\nBM_Diag_16_DT_INT32_gpu           34986      20144       0.5M items/s\nBM_Diag_16_DT_FLOAT_gpu           37343      19353       0.4M items/s\nBM_Diag_16_DT_COMPLEX64_gpu       35488      19930       0.5M items/s\nBM_Diag_128_DT_INT32_cpu          22539      29165       5.7M items/s\nBM_Diag_128_DT_FLOAT_cpu          26046      31457       4.9M items/s\nBM_Diag_128_DT_COMPLEX64_cpu      29816      20297       4.3M items/s\nBM_Diag_128_DT_INT32_gpu          36148      19113       3.5M items/s\nBM_Diag_128_DT_FLOAT_gpu          34664      19109       3.7M items/s\nBM_Diag_128_DT_COMPLEX64_gpu      35264      19279       3.6M items/s\nBM_Diag_512_DT_INT32_cpu          74927       9439       6.8M items/s\nBM_Diag_512_DT_FLOAT_cpu          73087       9120       7.0M items/s\nBM_Diag_512_DT_COMPLEX64_cpu      86292       7751       5.9M items/s\nBM_Diag_512_DT_INT32_gpu          35550      17597       14.4M items/s\nBM_Diag_512_DT_FLOAT_gpu          34587      19479       14.8M items/s\nBM_Diag_512_DT_COMPLEX64_gpu      37200      19071       13.8M items/s\n================================================================================\n//tensorflow/core/kernels:diag_op_test                          (cached) PASSED in 20.7s\n\nExecuted 0 out of 1 test: 1 test passes.\n</code></pre>\n<h4>System information of test environment</h4>\n<ul>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04):</strong> Linux Server release 7.2 (RedHat)</li>\n<li><strong>TensorFlow installed from (source or binary):</strong> source</li>\n<li><strong>TensorFlow version (use command below):</strong> 1.3.0</li>\n<li><strong>Python version:</strong> Python 3.6.1 :: Anaconda 4.4.0 (64-bit)</li>\n<li><strong>Bazel version (if compiling from source):</strong> 0.6.1</li>\n<li><strong>CUDA/cuDNN version:</strong> 8.0/5.1.3</li>\n<li><strong>GPU model and memory:</strong> Tesla M40/12G</li>\n<li><strong>Exact command to reproduce:</strong></li>\n</ul>", "body_text": "@cwhipkey Thank you for your reviews.\n\nI've made changes according to your comments.\nI've add shard function for CPU version in this PR, which gets rid of trouble of a new PR.\nI've add the benchmark in core/kernel/diag_op_test.cc, and compare with the old in performance.\n\nIn general, current version in CPU can speed 10 times, and version in GPU can speed more than 100 times for length or 512.\nHere are the results:\nOld Version in CPU (96f334b)\n$bazel test :diag_op_test --test_arg=--benchmarks=all --test_output=all\n...\n==================== Test output for //tensorflow/core/kernels:diag_op_test:\n2017-10-18 07:12:01.963569: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\nRunning main() from test_main.cc\nBenchmark                      Time(ns) Iterations\n--------------------------------------------------\nBM_Diag_16_DT_INT32_cpu           25606      28894       0.6M items/s\nBM_Diag_16_DT_FLOAT_cpu           23701      29621       0.7M items/s\nBM_Diag_16_DT_COMPLEX64_cpu       22794      30482       0.7M items/s\nBM_Diag_128_DT_INT32_cpu         236919       3006       0.5M items/s\nBM_Diag_128_DT_FLOAT_cpu         225901       3035       0.6M items/s\nBM_Diag_128_DT_COMPLEX64_cpu     248124       2874       0.5M items/s\nBM_Diag_512_DT_INT32_cpu        3368587        208       0.2M items/s\nBM_Diag_512_DT_FLOAT_cpu        3242726        215       0.2M items/s\nBM_Diag_512_DT_COMPLEX64_cpu    3517025        199       0.1M items/s\n================================================================================\n//tensorflow/core/kernels:diag_op_test                                   PASSED in 9.3s\n\nExecuted 1 out of 1 test: 1 test passes.\n\nCurrent Version in CPU&GPU (36e9764)\nRunning main() from test_main.cc\nBenchmark                      Time(ns) Iterations\n--------------------------------------------------\nBM_Diag_16_DT_INT32_cpu           18760      34370       0.9M items/s\nBM_Diag_16_DT_FLOAT_cpu           19241      34903       0.8M items/s\nBM_Diag_16_DT_COMPLEX64_cpu       19791      33423       0.8M items/s\nBM_Diag_16_DT_INT32_gpu           34986      20144       0.5M items/s\nBM_Diag_16_DT_FLOAT_gpu           37343      19353       0.4M items/s\nBM_Diag_16_DT_COMPLEX64_gpu       35488      19930       0.5M items/s\nBM_Diag_128_DT_INT32_cpu          22539      29165       5.7M items/s\nBM_Diag_128_DT_FLOAT_cpu          26046      31457       4.9M items/s\nBM_Diag_128_DT_COMPLEX64_cpu      29816      20297       4.3M items/s\nBM_Diag_128_DT_INT32_gpu          36148      19113       3.5M items/s\nBM_Diag_128_DT_FLOAT_gpu          34664      19109       3.7M items/s\nBM_Diag_128_DT_COMPLEX64_gpu      35264      19279       3.6M items/s\nBM_Diag_512_DT_INT32_cpu          74927       9439       6.8M items/s\nBM_Diag_512_DT_FLOAT_cpu          73087       9120       7.0M items/s\nBM_Diag_512_DT_COMPLEX64_cpu      86292       7751       5.9M items/s\nBM_Diag_512_DT_INT32_gpu          35550      17597       14.4M items/s\nBM_Diag_512_DT_FLOAT_gpu          34587      19479       14.8M items/s\nBM_Diag_512_DT_COMPLEX64_gpu      37200      19071       13.8M items/s\n================================================================================\n//tensorflow/core/kernels:diag_op_test                          (cached) PASSED in 20.7s\n\nExecuted 0 out of 1 test: 1 test passes.\n\nSystem information of test environment\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Server release 7.2 (RedHat)\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): 1.3.0\nPython version: Python 3.6.1 :: Anaconda 4.4.0 (64-bit)\nBazel version (if compiling from source): 0.6.1\nCUDA/cuDNN version: 8.0/5.1.3\nGPU model and memory: Tesla M40/12G\nExact command to reproduce:", "body": "@cwhipkey Thank you for your reviews.\r\n\r\n- I've made changes according to your comments.\r\n- I've add shard function for CPU version in this PR, which gets rid of trouble of a new PR.\r\n- I've add the benchmark in `core/kernel/diag_op_test.cc`, and compare with the old in performance.\r\n\r\nIn general, current version in CPU can speed 10 times, and version in GPU can speed more than 100 times for length or 512.\r\nHere are the results:\r\n\r\n#### Old Version in CPU (96f334b0d6ec61f5037b8ddd1860a9aa7874efef)\r\n```\r\n$bazel test :diag_op_test --test_arg=--benchmarks=all --test_output=all\r\n...\r\n==================== Test output for //tensorflow/core/kernels:diag_op_test:\r\n2017-10-18 07:12:01.963569: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\r\nRunning main() from test_main.cc\r\nBenchmark                      Time(ns) Iterations\r\n--------------------------------------------------\r\nBM_Diag_16_DT_INT32_cpu           25606      28894       0.6M items/s\r\nBM_Diag_16_DT_FLOAT_cpu           23701      29621       0.7M items/s\r\nBM_Diag_16_DT_COMPLEX64_cpu       22794      30482       0.7M items/s\r\nBM_Diag_128_DT_INT32_cpu         236919       3006       0.5M items/s\r\nBM_Diag_128_DT_FLOAT_cpu         225901       3035       0.6M items/s\r\nBM_Diag_128_DT_COMPLEX64_cpu     248124       2874       0.5M items/s\r\nBM_Diag_512_DT_INT32_cpu        3368587        208       0.2M items/s\r\nBM_Diag_512_DT_FLOAT_cpu        3242726        215       0.2M items/s\r\nBM_Diag_512_DT_COMPLEX64_cpu    3517025        199       0.1M items/s\r\n================================================================================\r\n//tensorflow/core/kernels:diag_op_test                                   PASSED in 9.3s\r\n\r\nExecuted 1 out of 1 test: 1 test passes.\r\n```\r\n#### Current Version in CPU&GPU (36e9764583f856a00fb3573daaea74812c8edf47)\r\n```\r\nRunning main() from test_main.cc\r\nBenchmark                      Time(ns) Iterations\r\n--------------------------------------------------\r\nBM_Diag_16_DT_INT32_cpu           18760      34370       0.9M items/s\r\nBM_Diag_16_DT_FLOAT_cpu           19241      34903       0.8M items/s\r\nBM_Diag_16_DT_COMPLEX64_cpu       19791      33423       0.8M items/s\r\nBM_Diag_16_DT_INT32_gpu           34986      20144       0.5M items/s\r\nBM_Diag_16_DT_FLOAT_gpu           37343      19353       0.4M items/s\r\nBM_Diag_16_DT_COMPLEX64_gpu       35488      19930       0.5M items/s\r\nBM_Diag_128_DT_INT32_cpu          22539      29165       5.7M items/s\r\nBM_Diag_128_DT_FLOAT_cpu          26046      31457       4.9M items/s\r\nBM_Diag_128_DT_COMPLEX64_cpu      29816      20297       4.3M items/s\r\nBM_Diag_128_DT_INT32_gpu          36148      19113       3.5M items/s\r\nBM_Diag_128_DT_FLOAT_gpu          34664      19109       3.7M items/s\r\nBM_Diag_128_DT_COMPLEX64_gpu      35264      19279       3.6M items/s\r\nBM_Diag_512_DT_INT32_cpu          74927       9439       6.8M items/s\r\nBM_Diag_512_DT_FLOAT_cpu          73087       9120       7.0M items/s\r\nBM_Diag_512_DT_COMPLEX64_cpu      86292       7751       5.9M items/s\r\nBM_Diag_512_DT_INT32_gpu          35550      17597       14.4M items/s\r\nBM_Diag_512_DT_FLOAT_gpu          34587      19479       14.8M items/s\r\nBM_Diag_512_DT_COMPLEX64_gpu      37200      19071       13.8M items/s\r\n================================================================================\r\n//tensorflow/core/kernels:diag_op_test                          (cached) PASSED in 20.7s\r\n\r\nExecuted 0 out of 1 test: 1 test passes.\r\n```\r\n#### System information of test environment \r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04):** Linux Server release 7.2 (RedHat)\r\n- **TensorFlow installed from (source or binary):** source\r\n- **TensorFlow version (use command below):** 1.3.0\r\n- **Python version:** Python 3.6.1 :: Anaconda 4.4.0 (64-bit)\r\n- **Bazel version (if compiling from source):** 0.6.1\r\n- **CUDA/cuDNN version:** 8.0/5.1.3\r\n- **GPU model and memory:** Tesla M40/12G\r\n- **Exact command to reproduce:**"}