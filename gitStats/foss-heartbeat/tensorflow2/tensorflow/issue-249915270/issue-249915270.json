{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12255", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12255/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12255/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12255/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/12255", "id": 249915270, "node_id": "MDU6SXNzdWUyNDk5MTUyNzA=", "number": 12255, "title": "Fail to tune the number of CPU for training", "user": {"login": "tobegit3hub", "id": 2715000, "node_id": "MDQ6VXNlcjI3MTUwMDA=", "avatar_url": "https://avatars0.githubusercontent.com/u/2715000?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tobegit3hub", "html_url": "https://github.com/tobegit3hub", "followers_url": "https://api.github.com/users/tobegit3hub/followers", "following_url": "https://api.github.com/users/tobegit3hub/following{/other_user}", "gists_url": "https://api.github.com/users/tobegit3hub/gists{/gist_id}", "starred_url": "https://api.github.com/users/tobegit3hub/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tobegit3hub/subscriptions", "organizations_url": "https://api.github.com/users/tobegit3hub/orgs", "repos_url": "https://api.github.com/users/tobegit3hub/repos", "events_url": "https://api.github.com/users/tobegit3hub/events{/privacy}", "received_events_url": "https://api.github.com/users/tobegit3hub/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-08-14T01:53:35Z", "updated_at": "2017-08-16T02:24:27Z", "closed_at": "2017-08-15T15:28:41Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<p>== uname -a =====================================================<br>\nLinux aws-prophet-tf01 4.4.53-1.el7.centos.x86_64 <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP Sun Mar 12 12:38:41 EDT 2017 x86_64 x86_64 x86_64 GNU/Linux</p>\n<p>== check pips ===================================================<br>\nnumpy (1.13.1)<br>\nprotobuf (3.3.0)<br>\ntensorflow (1.2.1)</p>\n<p>== check for virtualenv =========================================<br>\nFalse</p>\n<p>== tensorflow import ============================================<br>\ntf.VERSION = 1.2.1<br>\ntf.GIT_VERSION = v1.2.0-5-g435cdfc<br>\ntf.COMPILER_VERSION = v1.2.0-5-g435cdfc<br>\nSanity check: array([1], dtype=int32)</p>\n<p>== env ==========================================================<br>\nLD_LIBRARY_PATH is unset<br>\nDYLD_LIBRARY_PATH is unset</p>\n<p>== nvidia-smi ===================================================<br>\n./tf_env_collect.sh: line 105: nvidia-smi: command not found</p>\n<p>== cuda libs  ===================================================</p>\n<h3>Describe the problem</h3>\n<p>We are using TensorFlow to benchmark and train an simple neural network model. We found that the usage of CPU was around 200% while we have more idle CPUs. And we have manually set the configuration of session like this which will not work.</p>\n<pre><code>config = tf.ConfigProto(device_count={\"CPU\": 4}, # limit to num_cpu_core CPU usage  \n                inter_op_parallelism_threads = 1,   \n                intra_op_parallelism_threads = 4,  \n                log_device_placement=True)  \nwith tf.Session(config = config) as sess:  \n</code></pre>\n<p>Here is my script to benchmark and using <code>tf.embedding_lookup_sparse</code> for the space dataset in <a href=\"https://github.com/tobegit3hub/tensorflow_template_application/blob/master/sparse_classifier.py\">https://github.com/tobegit3hub/tensorflow_template_application/blob/master/sparse_classifier.py</a> .</p>\n<h3>Source code / logs</h3>\n<p>The usage of CPU looked like this.</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/2715000/29255695-4dd7deb6-80d6-11e7-8d7b-2c9f7ef3d687.png\"><img width=\"762\" alt=\"screen shot 2017-08-11 at 5 15 29 pm\" src=\"https://user-images.githubusercontent.com/2715000/29255695-4dd7deb6-80d6-11e7-8d7b-2c9f7ef3d687.png\" style=\"max-width:100%;\"></a></p>\n<p>Although we had set the configuration of session. It seemed that all op are placed in <code>cpu:0</code>. The log looks like this.</p>\n<pre><code>2017-08-14 01:44:00.058798: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/Parse[54/1040]\nparse_keys_0: (Const)/job:localhost/replica:0/task:0/cpu:0\nParseExample/ParseExample/names: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058818: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/ParseExample/names: (Const)/job:localhost/replica:0/task:0/cpu:0\nParseExample/Const: (Const): /job:localhost/replica:0/task:0/cpu:0                                            2017-08-14 01:44:00.058849: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/Const: (Const)/job:localhost/replica:0/task:0/cpu:0\nshuffle_batch/n: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058868: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/n: (Const)/job:localhost/replica:0/task:0/cpu:0\nshuffle_batch/fraction_over_100_of_1024_full/tags: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058886: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/fraction_over_100_of_1024_full/tags: (Const)/job:localhost/replica:0/task:0/cpu:0\nshuffle_batch/mul/y: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058901: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/mul/y: (Const)/job:localhost/replica:0/task:0/cpu:0\n</code></pre>", "body_text": "System information\n== uname -a =====================================================\nLinux aws-prophet-tf01 4.4.53-1.el7.centos.x86_64 #1 SMP Sun Mar 12 12:38:41 EDT 2017 x86_64 x86_64 x86_64 GNU/Linux\n== check pips ===================================================\nnumpy (1.13.1)\nprotobuf (3.3.0)\ntensorflow (1.2.1)\n== check for virtualenv =========================================\nFalse\n== tensorflow import ============================================\ntf.VERSION = 1.2.1\ntf.GIT_VERSION = v1.2.0-5-g435cdfc\ntf.COMPILER_VERSION = v1.2.0-5-g435cdfc\nSanity check: array([1], dtype=int32)\n== env ==========================================================\nLD_LIBRARY_PATH is unset\nDYLD_LIBRARY_PATH is unset\n== nvidia-smi ===================================================\n./tf_env_collect.sh: line 105: nvidia-smi: command not found\n== cuda libs  ===================================================\nDescribe the problem\nWe are using TensorFlow to benchmark and train an simple neural network model. We found that the usage of CPU was around 200% while we have more idle CPUs. And we have manually set the configuration of session like this which will not work.\nconfig = tf.ConfigProto(device_count={\"CPU\": 4}, # limit to num_cpu_core CPU usage  \n                inter_op_parallelism_threads = 1,   \n                intra_op_parallelism_threads = 4,  \n                log_device_placement=True)  \nwith tf.Session(config = config) as sess:  \n\nHere is my script to benchmark and using tf.embedding_lookup_sparse for the space dataset in https://github.com/tobegit3hub/tensorflow_template_application/blob/master/sparse_classifier.py .\nSource code / logs\nThe usage of CPU looked like this.\n\nAlthough we had set the configuration of session. It seemed that all op are placed in cpu:0. The log looks like this.\n2017-08-14 01:44:00.058798: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/Parse[54/1040]\nparse_keys_0: (Const)/job:localhost/replica:0/task:0/cpu:0\nParseExample/ParseExample/names: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058818: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/ParseExample/names: (Const)/job:localhost/replica:0/task:0/cpu:0\nParseExample/Const: (Const): /job:localhost/replica:0/task:0/cpu:0                                            2017-08-14 01:44:00.058849: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/Const: (Const)/job:localhost/replica:0/task:0/cpu:0\nshuffle_batch/n: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058868: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/n: (Const)/job:localhost/replica:0/task:0/cpu:0\nshuffle_batch/fraction_over_100_of_1024_full/tags: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058886: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/fraction_over_100_of_1024_full/tags: (Const)/job:localhost/replica:0/task:0/cpu:0\nshuffle_batch/mul/y: (Const): /job:localhost/replica:0/task:0/cpu:0\n2017-08-14 01:44:00.058901: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/mul/y: (Const)/job:localhost/replica:0/task:0/cpu:0", "body": "### System information\r\n\r\n== uname -a =====================================================\r\nLinux aws-prophet-tf01 4.4.53-1.el7.centos.x86_64 #1 SMP Sun Mar 12 12:38:41 EDT 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n== check pips ===================================================\r\nnumpy (1.13.1)\r\nprotobuf (3.3.0)\r\ntensorflow (1.2.1)\r\n\r\n== check for virtualenv =========================================\r\nFalse\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 1.2.1\r\ntf.GIT_VERSION = v1.2.0-5-g435cdfc\r\ntf.COMPILER_VERSION = v1.2.0-5-g435cdfc\r\nSanity check: array([1], dtype=int32)\r\n\r\n== env ==========================================================\r\nLD_LIBRARY_PATH is unset\r\nDYLD_LIBRARY_PATH is unset\r\n\r\n== nvidia-smi ===================================================\r\n./tf_env_collect.sh: line 105: nvidia-smi: command not found\r\n\r\n== cuda libs  ===================================================\r\n\r\n### Describe the problem\r\n\r\nWe are using TensorFlow to benchmark and train an simple neural network model. We found that the usage of CPU was around 200% while we have more idle CPUs. And we have manually set the configuration of session like this which will not work.\r\n\r\n```\r\nconfig = tf.ConfigProto(device_count={\"CPU\": 4}, # limit to num_cpu_core CPU usage  \r\n                inter_op_parallelism_threads = 1,   \r\n                intra_op_parallelism_threads = 4,  \r\n                log_device_placement=True)  \r\nwith tf.Session(config = config) as sess:  \r\n```\r\n\r\nHere is my script to benchmark and using `tf.embedding_lookup_sparse` for the space dataset in https://github.com/tobegit3hub/tensorflow_template_application/blob/master/sparse_classifier.py .\r\n\r\n### Source code / logs\r\n\r\nThe usage of CPU looked like this.\r\n\r\n<img width=\"762\" alt=\"screen shot 2017-08-11 at 5 15 29 pm\" src=\"https://user-images.githubusercontent.com/2715000/29255695-4dd7deb6-80d6-11e7-8d7b-2c9f7ef3d687.png\">\r\n\r\nAlthough we had set the configuration of session. It seemed that all op are placed in `cpu:0`. The log looks like this.\r\n\r\n```\r\n2017-08-14 01:44:00.058798: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/Parse[54/1040]\r\nparse_keys_0: (Const)/job:localhost/replica:0/task:0/cpu:0\r\nParseExample/ParseExample/names: (Const): /job:localhost/replica:0/task:0/cpu:0\r\n2017-08-14 01:44:00.058818: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/ParseExample/names: (Const)/job:localhost/replica:0/task:0/cpu:0\r\nParseExample/Const: (Const): /job:localhost/replica:0/task:0/cpu:0                                            2017-08-14 01:44:00.058849: I tensorflow/core/common_runtime/simple_placer.cc:847] ParseExample/Const: (Const)/job:localhost/replica:0/task:0/cpu:0\r\nshuffle_batch/n: (Const): /job:localhost/replica:0/task:0/cpu:0\r\n2017-08-14 01:44:00.058868: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/n: (Const)/job:localhost/replica:0/task:0/cpu:0\r\nshuffle_batch/fraction_over_100_of_1024_full/tags: (Const): /job:localhost/replica:0/task:0/cpu:0\r\n2017-08-14 01:44:00.058886: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/fraction_over_100_of_1024_full/tags: (Const)/job:localhost/replica:0/task:0/cpu:0\r\nshuffle_batch/mul/y: (Const): /job:localhost/replica:0/task:0/cpu:0\r\n2017-08-14 01:44:00.058901: I tensorflow/core/common_runtime/simple_placer.cc:847] shuffle_batch/mul/y: (Const)/job:localhost/replica:0/task:0/cpu:0\r\n```"}