{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/334911003", "html_url": "https://github.com/tensorflow/tensorflow/issues/13546#issuecomment-334911003", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13546", "id": 334911003, "node_id": "MDEyOklzc3VlQ29tbWVudDMzNDkxMTAwMw==", "user": {"login": "facaiy", "id": 1112263, "node_id": "MDQ6VXNlcjExMTIyNjM=", "avatar_url": "https://avatars3.githubusercontent.com/u/1112263?v=4", "gravatar_id": "", "url": "https://api.github.com/users/facaiy", "html_url": "https://github.com/facaiy", "followers_url": "https://api.github.com/users/facaiy/followers", "following_url": "https://api.github.com/users/facaiy/following{/other_user}", "gists_url": "https://api.github.com/users/facaiy/gists{/gist_id}", "starred_url": "https://api.github.com/users/facaiy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/facaiy/subscriptions", "organizations_url": "https://api.github.com/users/facaiy/orgs", "repos_url": "https://api.github.com/users/facaiy/repos", "events_url": "https://api.github.com/users/facaiy/events{/privacy}", "received_events_url": "https://api.github.com/users/facaiy/received_events", "type": "User", "site_admin": false}, "created_at": "2017-10-07T05:07:18Z", "updated_at": "2017-10-07T05:07:18Z", "author_association": "MEMBER", "body_html": "<p>If I understand you correctly, do you mean that intermediate variable <code>mom</code> is wasteful when <code>momentum = 0</code>?</p>\n<p><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/624bcfe409601910951789325f0b97f520c0b1ee/tensorflow/python/training/rmsprop.py#L32-L36\">tensorflow/tensorflow/python/training/rmsprop.py</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n        Lines 32 to 36\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/624bcfe409601910951789325f0b97f520c0b1ee\">624bcfe</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L32\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"32\"></td>\n          <td id=\"LC32\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\">mean_grad = decay * mean_square{t-1} + (1-decay) * gradient</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L33\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"33\"></td>\n          <td id=\"LC33\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\">mean_square = decay * mean_square{t-1} + (1-decay) * gradient ** 2</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L34\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"34\"></td>\n          <td id=\"LC34\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\">mom = momentum * mom{t-1} + learning_rate * g_t /</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L35\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"35\"></td>\n          <td id=\"LC35\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\">    sqrt(mean_square - mean_grad**2 + epsilon)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L36\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"36\"></td>\n          <td id=\"LC36\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-s\">delta = - mom</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p>Sounds reasonable, at least for me. I prefer to the first solution, which seems harmless and feasible:</p>\n<ul>\n<li>stop allocating resources if <code>momentum = 0</code>:<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/624bcfe409601910951789325f0b97f520c0b1ee/tensorflow/python/training/rmsprop.py#L103\">tensorflow/tensorflow/python/training/rmsprop.py</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 103\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/624bcfe409601910951789325f0b97f520c0b1ee\">624bcfe</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L103\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"103\"></td>\n          <td id=\"LC103\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-c1\">self</span>._zeros_slot(v, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>momentum<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">self</span>._name) </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</li>\n<li>adjust interface and c++ kernel implementations.<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/624bcfe409601910951789325f0b97f520c0b1ee/tensorflow/core/kernels/training_ops.cc#L352-L353\">tensorflow/tensorflow/core/kernels/training_ops.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n        Lines 352 to 353\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/624bcfe409601910951789325f0b97f520c0b1ee\">624bcfe</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L352\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"352\"></td>\n          <td id=\"LC352\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> mom.<span class=\"pl-c1\">device</span>(d) = </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L353\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"353\"></td>\n          <td id=\"LC353\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\">     mom * <span class=\"pl-c1\">momentum</span>() + (grad * <span class=\"pl-c1\">lr</span>()) / ((ms + <span class=\"pl-c1\">epsilon</span>()).<span class=\"pl-c1\">sqrt</span>()); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</li>\n</ul>\n<p>The work seems hard but not difficult :-)</p>", "body_text": "If I understand you correctly, do you mean that intermediate variable mom is wasteful when momentum = 0?\n\n  \n    \n      tensorflow/tensorflow/python/training/rmsprop.py\n    \n    \n        Lines 32 to 36\n      in\n      624bcfe\n    \n    \n    \n    \n\n        \n          \n           mean_grad = decay * mean_square{t-1} + (1-decay) * gradient \n        \n\n        \n          \n           mean_square = decay * mean_square{t-1} + (1-decay) * gradient ** 2 \n        \n\n        \n          \n           mom = momentum * mom{t-1} + learning_rate * g_t / \n        \n\n        \n          \n               sqrt(mean_square - mean_grad**2 + epsilon) \n        \n\n        \n          \n           delta = - mom \n        \n    \n  \n\n\nSounds reasonable, at least for me. I prefer to the first solution, which seems harmless and feasible:\n\nstop allocating resources if momentum = 0:\n\n  \n    \n      tensorflow/tensorflow/python/training/rmsprop.py\n    \n    \n         Line 103\n      in\n      624bcfe\n    \n    \n    \n    \n\n        \n          \n           self._zeros_slot(v, \"momentum\", self._name) \n        \n    \n  \n\n\nadjust interface and c++ kernel implementations.\n\n  \n    \n      tensorflow/tensorflow/core/kernels/training_ops.cc\n    \n    \n        Lines 352 to 353\n      in\n      624bcfe\n    \n    \n    \n    \n\n        \n          \n           mom.device(d) = \n        \n\n        \n          \n               mom * momentum() + (grad * lr()) / ((ms + epsilon()).sqrt()); \n        \n    \n  \n\n\n\nThe work seems hard but not difficult :-)", "body": "If I understand you correctly, do you mean that intermediate variable `mom` is wasteful when `momentum = 0`?\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/624bcfe409601910951789325f0b97f520c0b1ee/tensorflow/python/training/rmsprop.py#L32-L36\r\n\r\nSounds reasonable, at least for me. I prefer to the first solution, which seems harmless and feasible: \r\n+ stop allocating resources if `momentum = 0`:\r\n   https://github.com/tensorflow/tensorflow/blob/624bcfe409601910951789325f0b97f520c0b1ee/tensorflow/python/training/rmsprop.py#L103\r\n+ adjust interface and c++ kernel implementations.\r\n   https://github.com/tensorflow/tensorflow/blob/624bcfe409601910951789325f0b97f520c0b1ee/tensorflow/core/kernels/training_ops.cc#L352-L353\r\n\r\nThe work seems hard but not difficult :-)"}