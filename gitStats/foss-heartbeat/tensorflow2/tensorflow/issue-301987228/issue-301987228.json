{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17397", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17397/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17397/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17397/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17397", "id": 301987228, "node_id": "MDU6SXNzdWUzMDE5ODcyMjg=", "number": 17397, "title": "Error triggers when gradients calculated inside the tf.map_fn function", "user": {"login": "itdxer", "id": 1621713, "node_id": "MDQ6VXNlcjE2MjE3MTM=", "avatar_url": "https://avatars3.githubusercontent.com/u/1621713?v=4", "gravatar_id": "", "url": "https://api.github.com/users/itdxer", "html_url": "https://github.com/itdxer", "followers_url": "https://api.github.com/users/itdxer/followers", "following_url": "https://api.github.com/users/itdxer/following{/other_user}", "gists_url": "https://api.github.com/users/itdxer/gists{/gist_id}", "starred_url": "https://api.github.com/users/itdxer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/itdxer/subscriptions", "organizations_url": "https://api.github.com/users/itdxer/orgs", "repos_url": "https://api.github.com/users/itdxer/repos", "events_url": "https://api.github.com/users/itdxer/events{/privacy}", "received_events_url": "https://api.github.com/users/itdxer/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 8, "created_at": "2018-03-03T10:26:38Z", "updated_at": "2018-07-03T06:25:55Z", "closed_at": "2018-07-03T06:25:55Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: macOS 10.13</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: source</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.6.0-rc1</li>\n<li><strong>Python version</strong>: 3.6</li>\n<li><strong>Bazel version (if compiling from source)</strong>: 0.11.0</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: 4.2.1</li>\n<li><strong>CUDA/cuDNN version</strong>: -</li>\n<li><strong>GPU model and memory</strong>: -</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When I try to calculate jacobian using <code>map_fn</code> I get then following error: <code>Could not write to TensorArray index 1 because it has already been read.</code></p>\n<p>I've checked one of the similar issues, but suggested solutions didn't help to solve my problem: <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"268556765\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/13983\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/13983/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/13983\">#13983</a></p>\n<p>Based on the error logs it looks to me that problem happens because I try to calculate gradient multiple times with the same set of parameters. I tried to run my script with <code>n_samples=1</code> (see code below) and I get the expected result without error. In addition, error happens with index 1, which again point that probably first iteration was finished properly and error appears when function reaches second  sample.</p>\n<h3>Source code / logs</h3>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> numpy <span class=\"pl-k\">as</span> np\n<span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">jacobians</span>(<span class=\"pl-smi\">errors</span>, <span class=\"pl-smi\">parameters</span>):\n    <span class=\"pl-k\">return</span> tf.map_fn(\n        <span class=\"pl-v\">fn</span><span class=\"pl-k\">=</span><span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">x</span>, <span class=\"pl-smi\">params</span><span class=\"pl-k\">=</span>parameters: tf.gradients(x, params),\n        <span class=\"pl-v\">elems</span><span class=\"pl-k\">=</span>errors,\n        <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>[x.dtype <span class=\"pl-k\">for</span> x <span class=\"pl-k\">in</span> parameters],\n        <span class=\"pl-v\">back_prop</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>,\n        <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>jacobian<span class=\"pl-pds\">'</span></span>,\n        <span class=\"pl-v\">parallel_iterations</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>)\n\n\nx <span class=\"pl-k\">=</span> tf.placeholder(tf.float32, (<span class=\"pl-c1\">None</span>, <span class=\"pl-c1\">2</span>))\ny <span class=\"pl-k\">=</span> tf.placeholder(tf.float32, (<span class=\"pl-c1\">None</span>, <span class=\"pl-c1\">1</span>))\nweight <span class=\"pl-k\">=</span> tf.Variable(np.random.random((<span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">1</span>)), <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.float32)\nbias <span class=\"pl-k\">=</span> tf.Variable(np.random.random((<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">1</span>)), <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.float32)\n\nprediction <span class=\"pl-k\">=</span> tf.matmul(x, weight) <span class=\"pl-k\">+</span> bias\nerrors <span class=\"pl-k\">=</span> tf.square(y <span class=\"pl-k\">-</span> prediction)\n\nn_samples <span class=\"pl-k\">=</span> <span class=\"pl-c1\">5</span>\nJs <span class=\"pl-k\">=</span> jacobians(errors, [weight, bias])\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    sess.run(tf.global_variables_initializer())\n    sess.run(Js, {\n        x: np.random.random((n_samples, <span class=\"pl-c1\">2</span>)),\n        y: np.random.random((n_samples, <span class=\"pl-c1\">1</span>)),\n    })</pre></div>\n<p>When I run this code I get the following exception</p>\n<pre><code>/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n  from ._conv import register_converters as _register_converters\n2018-03-03 11:15:16.808741: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at tensor_array_ops.cc:415 : Invalid argument: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\nTraceback (most recent call last):\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1361, in _do_call\n    return fn(*args)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _run_fn\n    target_list, status, run_metadata)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 516, in __exit__\n    c_api.TF_GetCode(self.status.status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 29, in &lt;module&gt;\n    y: np.random.random((n_samples, 1))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 905, in run\n    run_metadata_ptr)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1137, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1355, in _do_run\n    options, run_metadata)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1374, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\n\nCaused by op 'jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3', defined at:\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 23, in &lt;module&gt;\n    Js = jacobians(errors, [weight, bias])\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 11, in jacobians\n    parallel_iterations=1)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 413, in map_fn\n    swap_memory=swap_memory)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3278, in while_loop\n    result = loop_context.BuildLoop(cond, body, loop_vars, shape_invariants)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3013, in BuildLoop\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2953, in _BuildLoop\n    body_result = body(*packed_vars_for_body)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 403, in compute\n    packed_fn_values = fn(packed_values)\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 7, in &lt;lambda&gt;\n    fn=lambda x, params=parameters: tf.gradients(x, params),\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 611, in gradients\n    lambda: grad_fn(op, *out_grads))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 377, in _MaybeCompile\n    return grad_fn()  # Exit early\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 611, in &lt;lambda&gt;\n    lambda: grad_fn(op, *out_grads))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_grad.py\", line 105, in _TensorArrayReadGrad\n    w_g = g.write(index, grad)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 118, in wrapped\n    return _add_should_use_warning(fn(*args, **kwargs))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 879, in write\n    return self._implementation.write(index, value, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 118, in wrapped\n    return _add_should_use_warning(fn(*args, **kwargs))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 278, in write\n    name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 7385, in _tensor_array_write_v3\n    flow_in=flow_in, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3270, in create_op\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\n...which was originally created as op 'jacobian/while/TensorArrayReadV3', defined at:\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 23, in &lt;module&gt;\n    Js = jacobians(errors, [weight, bias])\n[elided 4 identical lines from previous traceback]\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2953, in _BuildLoop\n    body_result = body(*packed_vars_for_body)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 402, in compute\n    packed_values = input_pack([elem_ta.read(i) for elem_ta in elems_ta])\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 402, in &lt;listcomp&gt;\n    packed_values = input_pack([elem_ta.read(i) for elem_ta in elems_ta])\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\n    return method(self, *args, **kwargs)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\n    return method(self, *args, **kwargs)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\n    return method(self, *args, **kwargs)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 861, in read\n    return self._implementation.read(index, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 260, in read\n    name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 6468, in _tensor_array_read_v3\n    dtype=dtype, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3270, in create_op\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): macOS 10.13\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): 1.6.0-rc1\nPython version: 3.6\nBazel version (if compiling from source): 0.11.0\nGCC/Compiler version (if compiling from source): 4.2.1\nCUDA/cuDNN version: -\nGPU model and memory: -\nExact command to reproduce:\n\nDescribe the problem\nWhen I try to calculate jacobian using map_fn I get then following error: Could not write to TensorArray index 1 because it has already been read.\nI've checked one of the similar issues, but suggested solutions didn't help to solve my problem: #13983\nBased on the error logs it looks to me that problem happens because I try to calculate gradient multiple times with the same set of parameters. I tried to run my script with n_samples=1 (see code below) and I get the expected result without error. In addition, error happens with index 1, which again point that probably first iteration was finished properly and error appears when function reaches second  sample.\nSource code / logs\nimport numpy as np\nimport tensorflow as tf\n\n\ndef jacobians(errors, parameters):\n    return tf.map_fn(\n        fn=lambda x, params=parameters: tf.gradients(x, params),\n        elems=errors,\n        dtype=[x.dtype for x in parameters],\n        back_prop=False,\n        name='jacobian',\n        parallel_iterations=1)\n\n\nx = tf.placeholder(tf.float32, (None, 2))\ny = tf.placeholder(tf.float32, (None, 1))\nweight = tf.Variable(np.random.random((2, 1)), dtype=tf.float32)\nbias = tf.Variable(np.random.random((1, 1)), dtype=tf.float32)\n\nprediction = tf.matmul(x, weight) + bias\nerrors = tf.square(y - prediction)\n\nn_samples = 5\nJs = jacobians(errors, [weight, bias])\n\nwith tf.Session() as sess:\n    sess.run(tf.global_variables_initializer())\n    sess.run(Js, {\n        x: np.random.random((n_samples, 2)),\n        y: np.random.random((n_samples, 1)),\n    })\nWhen I run this code I get the following exception\n/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n  from ._conv import register_converters as _register_converters\n2018-03-03 11:15:16.808741: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at tensor_array_ops.cc:415 : Invalid argument: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\nTraceback (most recent call last):\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1361, in _do_call\n    return fn(*args)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _run_fn\n    target_list, status, run_metadata)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 516, in __exit__\n    c_api.TF_GetCode(self.status.status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 29, in <module>\n    y: np.random.random((n_samples, 1))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 905, in run\n    run_metadata_ptr)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1137, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1355, in _do_run\n    options, run_metadata)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1374, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\n\nCaused by op 'jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3', defined at:\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 23, in <module>\n    Js = jacobians(errors, [weight, bias])\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 11, in jacobians\n    parallel_iterations=1)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 413, in map_fn\n    swap_memory=swap_memory)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3278, in while_loop\n    result = loop_context.BuildLoop(cond, body, loop_vars, shape_invariants)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3013, in BuildLoop\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2953, in _BuildLoop\n    body_result = body(*packed_vars_for_body)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 403, in compute\n    packed_fn_values = fn(packed_values)\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 7, in <lambda>\n    fn=lambda x, params=parameters: tf.gradients(x, params),\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 611, in gradients\n    lambda: grad_fn(op, *out_grads))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 377, in _MaybeCompile\n    return grad_fn()  # Exit early\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 611, in <lambda>\n    lambda: grad_fn(op, *out_grads))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_grad.py\", line 105, in _TensorArrayReadGrad\n    w_g = g.write(index, grad)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 118, in wrapped\n    return _add_should_use_warning(fn(*args, **kwargs))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 879, in write\n    return self._implementation.write(index, value, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 118, in wrapped\n    return _add_should_use_warning(fn(*args, **kwargs))\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 278, in write\n    name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 7385, in _tensor_array_write_v3\n    flow_in=flow_in, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3270, in create_op\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\n...which was originally created as op 'jacobian/while/TensorArrayReadV3', defined at:\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 23, in <module>\n    Js = jacobians(errors, [weight, bias])\n[elided 4 identical lines from previous traceback]\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2953, in _BuildLoop\n    body_result = body(*packed_vars_for_body)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 402, in compute\n    packed_values = input_pack([elem_ta.read(i) for elem_ta in elems_ta])\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 402, in <listcomp>\n    packed_values = input_pack([elem_ta.read(i) for elem_ta in elems_ta])\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\n    return method(self, *args, **kwargs)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\n    return method(self, *args, **kwargs)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\n    return method(self, *args, **kwargs)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 861, in read\n    return self._implementation.read(index, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 260, in read\n    name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 6468, in _tensor_array_read_v3\n    dtype=dtype, name=name)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3270, in create_op\n    op_def=op_def)\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: macOS 10.13\r\n- **TensorFlow installed from (source or binary)**: source\r\n- **TensorFlow version (use command below)**: 1.6.0-rc1\r\n- **Python version**: 3.6\r\n- **Bazel version (if compiling from source)**: 0.11.0\r\n- **GCC/Compiler version (if compiling from source)**: 4.2.1\r\n- **CUDA/cuDNN version**: -\r\n- **GPU model and memory**: -\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nWhen I try to calculate jacobian using `map_fn` I get then following error: ``Could not write to TensorArray index 1 because it has already been read.``\r\n\r\nI've checked one of the similar issues, but suggested solutions didn't help to solve my problem: https://github.com/tensorflow/tensorflow/issues/13983\r\n\r\nBased on the error logs it looks to me that problem happens because I try to calculate gradient multiple times with the same set of parameters. I tried to run my script with `n_samples=1` (see code below) and I get the expected result without error. In addition, error happens with index 1, which again point that probably first iteration was finished properly and error appears when function reaches second  sample.\r\n\r\n### Source code / logs\r\n\r\n```python\r\nimport numpy as np\r\nimport tensorflow as tf\r\n\r\n\r\ndef jacobians(errors, parameters):\r\n    return tf.map_fn(\r\n        fn=lambda x, params=parameters: tf.gradients(x, params),\r\n        elems=errors,\r\n        dtype=[x.dtype for x in parameters],\r\n        back_prop=False,\r\n        name='jacobian',\r\n        parallel_iterations=1)\r\n\r\n\r\nx = tf.placeholder(tf.float32, (None, 2))\r\ny = tf.placeholder(tf.float32, (None, 1))\r\nweight = tf.Variable(np.random.random((2, 1)), dtype=tf.float32)\r\nbias = tf.Variable(np.random.random((1, 1)), dtype=tf.float32)\r\n\r\nprediction = tf.matmul(x, weight) + bias\r\nerrors = tf.square(y - prediction)\r\n\r\nn_samples = 5\r\nJs = jacobians(errors, [weight, bias])\r\n\r\nwith tf.Session() as sess:\r\n    sess.run(tf.global_variables_initializer())\r\n    sess.run(Js, {\r\n        x: np.random.random((n_samples, 2)),\r\n        y: np.random.random((n_samples, 1)),\r\n    })\r\n```\r\n\r\nWhen I run this code I get the following exception\r\n\r\n```\r\n/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\r\n  from ._conv import register_converters as _register_converters\r\n2018-03-03 11:15:16.808741: W tensorflow/core/framework/op_kernel.cc:1273] OP_REQUIRES failed at tensor_array_ops.cc:415 : Invalid argument: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\r\nTraceback (most recent call last):\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1361, in _do_call\r\n    return fn(*args)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _run_fn\r\n    target_list, status, run_metadata)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 516, in __exit__\r\n    c_api.TF_GetCode(self.status.status))\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\r\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 29, in <module>\r\n    y: np.random.random((n_samples, 1))\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 905, in run\r\n    run_metadata_ptr)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1137, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1355, in _do_run\r\n    options, run_metadata)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1374, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\r\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\r\n\r\nCaused by op 'jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3', defined at:\r\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 23, in <module>\r\n    Js = jacobians(errors, [weight, bias])\r\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 11, in jacobians\r\n    parallel_iterations=1)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 413, in map_fn\r\n    swap_memory=swap_memory)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3278, in while_loop\r\n    result = loop_context.BuildLoop(cond, body, loop_vars, shape_invariants)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3013, in BuildLoop\r\n    pred, body, original_loop_vars, loop_vars, shape_invariants)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2953, in _BuildLoop\r\n    body_result = body(*packed_vars_for_body)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 403, in compute\r\n    packed_fn_values = fn(packed_values)\r\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 7, in <lambda>\r\n    fn=lambda x, params=parameters: tf.gradients(x, params),\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 611, in gradients\r\n    lambda: grad_fn(op, *out_grads))\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 377, in _MaybeCompile\r\n    return grad_fn()  # Exit early\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gradients_impl.py\", line 611, in <lambda>\r\n    lambda: grad_fn(op, *out_grads))\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_grad.py\", line 105, in _TensorArrayReadGrad\r\n    w_g = g.write(index, grad)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 118, in wrapped\r\n    return _add_should_use_warning(fn(*args, **kwargs))\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 879, in write\r\n    return self._implementation.write(index, value, name=name)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 118, in wrapped\r\n    return _add_should_use_warning(fn(*args, **kwargs))\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 278, in write\r\n    name=name)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 7385, in _tensor_array_write_v3\r\n    flow_in=flow_in, name=name)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3270, in create_op\r\n    op_def=op_def)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\n...which was originally created as op 'jacobian/while/TensorArrayReadV3', defined at:\r\n  File \"/Users/itdxer/Downloads/jacobian_fail_example.py\", line 23, in <module>\r\n    Js = jacobians(errors, [weight, bias])\r\n[elided 4 identical lines from previous traceback]\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2953, in _BuildLoop\r\n    body_result = body(*packed_vars_for_body)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 402, in compute\r\n    packed_values = input_pack([elem_ta.read(i) for elem_ta in elems_ta])\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/functional_ops.py\", line 402, in <listcomp>\r\n    packed_values = input_pack([elem_ta.read(i) for elem_ta in elems_ta])\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\r\n    return method(self, *args, **kwargs)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\r\n    return method(self, *args, **kwargs)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py\", line 58, in fn\r\n    return method(self, *args, **kwargs)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 861, in read\r\n    return self._implementation.read(index, name=name)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/tensor_array_ops.py\", line 260, in read\r\n    name=name)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/ops/gen_data_flow_ops.py\", line 6468, in _tensor_array_read_v3\r\n    dtype=dtype, name=name)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3270, in create_op\r\n    op_def=op_def)\r\n  File \"/Users/itdxer/.pyenv/versions/neupy36/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): TensorArray jacobian/TensorArray_1@jacobian/while/gradients: Could not write to TensorArray index 1 because it has already been read.\r\n\t [[Node: jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayWrite/TensorArrayWriteV3 = TensorArrayWriteV3[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](jacobian/while/gradients/jacobian/while/TensorArrayReadV3_grad/TensorArrayGrad/TensorArrayGradV3, jacobian/while/Identity, jacobian/while/gradients/Fill, jacobian/while/TensorArrayReadV3/Enter_1)]]\r\n```"}