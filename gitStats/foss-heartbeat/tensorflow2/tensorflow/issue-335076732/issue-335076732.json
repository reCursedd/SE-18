{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20240", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20240/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20240/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20240/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/20240", "id": 335076732, "node_id": "MDU6SXNzdWUzMzUwNzY3MzI=", "number": 20240, "title": "Bazel build Failed in compiling libtensorflow.so from source using the mkl config in windows 10", "user": {"login": "Danielzxliu", "id": 39880669, "node_id": "MDQ6VXNlcjM5ODgwNjY5", "avatar_url": "https://avatars3.githubusercontent.com/u/39880669?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Danielzxliu", "html_url": "https://github.com/Danielzxliu", "followers_url": "https://api.github.com/users/Danielzxliu/followers", "following_url": "https://api.github.com/users/Danielzxliu/following{/other_user}", "gists_url": "https://api.github.com/users/Danielzxliu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Danielzxliu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Danielzxliu/subscriptions", "organizations_url": "https://api.github.com/users/Danielzxliu/orgs", "repos_url": "https://api.github.com/users/Danielzxliu/repos", "events_url": "https://api.github.com/users/Danielzxliu/events{/privacy}", "received_events_url": "https://api.github.com/users/Danielzxliu/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1104829434, "node_id": "MDU6TGFiZWwxMTA0ODI5NDM0", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:mkl", "name": "comp:mkl", "color": "0052cc", "default": false}, {"id": 473173351, "node_id": "MDU6TGFiZWw0NzMxNzMzNTE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:build/install", "name": "type:build/install", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": {"login": "TensorFlow-MKL", "id": 44416303, "node_id": "MDQ6VXNlcjQ0NDE2MzAz", "avatar_url": "https://avatars2.githubusercontent.com/u/44416303?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TensorFlow-MKL", "html_url": "https://github.com/TensorFlow-MKL", "followers_url": "https://api.github.com/users/TensorFlow-MKL/followers", "following_url": "https://api.github.com/users/TensorFlow-MKL/following{/other_user}", "gists_url": "https://api.github.com/users/TensorFlow-MKL/gists{/gist_id}", "starred_url": "https://api.github.com/users/TensorFlow-MKL/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TensorFlow-MKL/subscriptions", "organizations_url": "https://api.github.com/users/TensorFlow-MKL/orgs", "repos_url": "https://api.github.com/users/TensorFlow-MKL/repos", "events_url": "https://api.github.com/users/TensorFlow-MKL/events{/privacy}", "received_events_url": "https://api.github.com/users/TensorFlow-MKL/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "TensorFlow-MKL", "id": 44416303, "node_id": "MDQ6VXNlcjQ0NDE2MzAz", "avatar_url": "https://avatars2.githubusercontent.com/u/44416303?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TensorFlow-MKL", "html_url": "https://github.com/TensorFlow-MKL", "followers_url": "https://api.github.com/users/TensorFlow-MKL/followers", "following_url": "https://api.github.com/users/TensorFlow-MKL/following{/other_user}", "gists_url": "https://api.github.com/users/TensorFlow-MKL/gists{/gist_id}", "starred_url": "https://api.github.com/users/TensorFlow-MKL/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TensorFlow-MKL/subscriptions", "organizations_url": "https://api.github.com/users/TensorFlow-MKL/orgs", "repos_url": "https://api.github.com/users/TensorFlow-MKL/repos", "events_url": "https://api.github.com/users/TensorFlow-MKL/events{/privacy}", "received_events_url": "https://api.github.com/users/TensorFlow-MKL/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 11, "created_at": "2018-06-23T07:17:13Z", "updated_at": "2018-11-15T19:25:41Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>OS Platform and Distribution )</strong>: win10 x64</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: source</li>\n<li><strong>TensorFlow version (use command below)</strong>: R1.9</li>\n<li><strong>Python version</strong>:  Anaconda3 Python3.6.2</li>\n<li><strong>Bazel version (if compiling from source)</strong>: 0.14.0</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: VS2015 Update3</li>\n<li><strong>CUDA/cuDNN version</strong>: none</li>\n<li><strong>GPU model and memory</strong>: none</li>\n<li><strong>Exact command to reproduce</strong>:<br>\nbazel build -c opt --copt=/arch:AVX  --config=mkl<br>\ntensorflow:libtensorflow.so <br>\ntensorflow/tools/lib_package:clicenses_generate <br>\ntensorflow/java:libtensorflow_jni.so <br>\ntensorflow/tools/lib_package:jnilicenses_generate</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I want to build libtensorflow.so with \"cpu + mkl\"  in win10 os.</p>\n<p>I had builded the libtensorflow.so using the script (run_libtensorflow.bat) in the directory: tensorflow/tools/ci_build/windows/cpu/bazel/.This script works very well,but then a link error occur<br>\nif I add --config=mkl to the option of bazel build.</p>\n<p>I think this link error is about mkl library,and this link error exist a period of time.<br>\nI tried to build libtensorflow.so r1.8,after fixing some compilation error the same link error occur.</p>\n<h3>The verbose log are following</h3>\n<p>INFO: Options provided by the client:<br>\nInherited 'common' options: --isatty=1 --terminal_columns=120<br>\nINFO: Options provided by the client:<br>\n'build' options: --python_path=C:/tools/Anaconda3/python.exe<br>\nINFO: Reading rc options for 'build' from d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc:<br>\n'build' options: --define framework_shared_object=true --define=use_fast_cpp_protos=true --define=allow_oversize_protos=true --define=grpc_no_ares=true --spawn_strategy=standalone --genrule_strategy=standalone -c opt<br>\nINFO: Reading rc options for 'build' from d:\\tensorflow_git_reps\\tensorflow_r1.9.tf_configure.bazelrc:<br>\n'build' options: --action_env PYTHON_BIN_PATH=C:/tools/Anaconda3/python.exe --action_env PYTHON_LIB_PATH=C:/tools/Anaconda3/lib/site-packages --python_path=C:/tools/Anaconda3/python.exe --action_env TF_NEED_OPENCL_SYCL=0 --action_env TF_NEED_CUDA=0 --action_env TF_DOWNLOAD_CLANG=0 --define grpc_no_ares=true --strip=always --config monolithic --copt=-w --host_copt=-w --verbose_failures<br>\nINFO: Found applicable config definition build:monolithic in file d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc: --define framework_shared_object=false<br>\nINFO: Found applicable config definition build:mkl in file d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc: --define=using_mkl=true -c opt --define=using_mkl=true<br>\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_common.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12<br>\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_decode.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12<br>\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_encode.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12<br>\nINFO: Analysed target //tensorflow:libtensorflow.so (77 packages loaded).<br>\nINFO: Found 1 target...<br>\nERROR: D:/tensorflow_git_reps/tensorflow_r1.9/tensorflow/BUILD:480:1: Linking of rule '//tensorflow:libtensorflow.so' failed (Exit 1169): link.exe failed: error executing command<br>\ncd G:/tf/_bazel_50219889/4o2fzunw/execroot/org_tensorflow<br>\nSET INCLUDE=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\INCLUDE;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\ATLMFC\\INCLUDE;C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.10240.0\\ucrt;C:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.6.1\\include\\um;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\shared;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\um;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\winrt;<br>\nSET LIB=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\LIB\\amd64;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\ATLMFC\\LIB\\amd64;C:\\Program Files (x86)\\Windows Kits\\10\\lib\\10.0.10240.0\\ucrt\\x64;C:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.6.1\\lib\\um\\x64;C:\\Program Files (x86)\\Windows Kits\\8.1\\lib\\winv6.3\\um\\x64;<br>\nSET PATH=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\IDE\\CommonExtensions\\Microsoft\\TestWindow;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\BIN\\amd64;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\VCPackages;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\IDE;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\Tools;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Team Tools\\Performance Tools\\x64;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Team Tools\\Performance Tools;C:\\Program Files (x86)\\Windows Kits\\8.1\\bin\\x64;C:\\Program Files (x86)\\Windows Kits\\8.1\\bin\\x86;C:\\Program Files (x86)\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.6.1 Tools\\x64;;C:\\Windows\\system32<br>\nSET PWD=/proc/self/cwd<br>\nSET PYTHON_BIN_PATH=C:/tools/Anaconda3/python.exe<br>\nSET PYTHON_LIB_PATH=C:/tools/Anaconda3/lib/site-packages<br>\nSET TEMP=C:\\Users\\50219889\\AppData\\Local\\Temp<br>\nSET TF_DOWNLOAD_CLANG=0<br>\nSET TF_NEED_CUDA=0<br>\nSET TF_NEED_OPENCL_SYCL=0<br>\nSET TMP=C:\\Users\\50219889\\AppData\\Local\\Temp<br>\nSET USE_LINKER=1<br>\nC:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/amd64/link.exe /nologo /DLL /WHOLEARCHIVE:external/mkl_windows/lib/libiomp5md.lib /WHOLEARCHIVE:external/mkl_windows/lib/mklml.lib /SUBSYSTEM:CONSOLE -DEFAULTLIB:advapi32.lib -pthread /MACHINE:X64 @bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.so-2.params /DEFAULTLIB:msvcrt.lib<br>\nLINK : warning LNK4044: unrecognized option '/pthread'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/ldl'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/lpthread'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/lm'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/ldl'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/lm'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/lm'; ignored<br>\nLINK : warning LNK4044: unrecognized option '/lm'; ignored<br>\n<strong>mklml.lib(mklml.dll) : error LNK2005: __NULL_IMPORT_DESCRIPTOR already defined in libiomp5md.lib(libiomp5md.dll)</strong><br>\nCreating library bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.ifso and object bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.exp<br>\nlibbatch_kernels.lo(batch_kernels.o) : warning LNK4217: locally defined symbol ?DEVICE_CPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_CPU) imported in function \"void __cdecl tensorflow::<code>dynamic initializer for 'registrar__body__0__object''(void)\" (??__Eregistrar__body__0__object@tensorflow@@YAXXZ) libarithmetic_optimizer.a(arithmetic_optimizer.o) : warning LNK4049: locally defined symbol ?DEVICE_CPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_CPU) imported libarithmetic_optimizer.a(arithmetic_optimizer.o) : warning LNK4217: locally defined symbol ?DEVICE_GPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_GPU) imported in function \"private: bool __cdecl tensorflow::grappler::</code>anonymous namespace'::ReorderCastAndTranspose::NodeIsOnCpuOrGpu(class tensorflow::NodeDef const *)const \" (?NodeIsOnCpuOrGpu@ReorderCastAndTranspose@?A0x3f420f79@grappler@tensorflow@@AEBA_NPEBVNodeDef@4@<a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=49380\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/z\">@z</a>)<br>\nliblayout_optimizer.a(layout_optimizer.o) : warning LNK4049: locally defined symbol ?DEVICE_GPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_GPU) imported<br>\nbazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.so : fatal error LNK1169: one or more multiply defined symbols found<br>\nTarget //tensorflow:libtensorflow.so failed to build<br>\nINFO: Elapsed time: 150.103s, Critical Path: 34.36s<br>\nINFO: 2 processes, local.<br>\nFAILED: Build did NOT complete successfully</p>", "body_text": "System information\n\nOS Platform and Distribution ): win10 x64\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): R1.9\nPython version:  Anaconda3 Python3.6.2\nBazel version (if compiling from source): 0.14.0\nGCC/Compiler version (if compiling from source): VS2015 Update3\nCUDA/cuDNN version: none\nGPU model and memory: none\nExact command to reproduce:\nbazel build -c opt --copt=/arch:AVX  --config=mkl\ntensorflow:libtensorflow.so \ntensorflow/tools/lib_package:clicenses_generate \ntensorflow/java:libtensorflow_jni.so \ntensorflow/tools/lib_package:jnilicenses_generate\n\nDescribe the problem\nI want to build libtensorflow.so with \"cpu + mkl\"  in win10 os.\nI had builded the libtensorflow.so using the script (run_libtensorflow.bat) in the directory: tensorflow/tools/ci_build/windows/cpu/bazel/.This script works very well,but then a link error occur\nif I add --config=mkl to the option of bazel build.\nI think this link error is about mkl library,and this link error exist a period of time.\nI tried to build libtensorflow.so r1.8,after fixing some compilation error the same link error occur.\nThe verbose log are following\nINFO: Options provided by the client:\nInherited 'common' options: --isatty=1 --terminal_columns=120\nINFO: Options provided by the client:\n'build' options: --python_path=C:/tools/Anaconda3/python.exe\nINFO: Reading rc options for 'build' from d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc:\n'build' options: --define framework_shared_object=true --define=use_fast_cpp_protos=true --define=allow_oversize_protos=true --define=grpc_no_ares=true --spawn_strategy=standalone --genrule_strategy=standalone -c opt\nINFO: Reading rc options for 'build' from d:\\tensorflow_git_reps\\tensorflow_r1.9.tf_configure.bazelrc:\n'build' options: --action_env PYTHON_BIN_PATH=C:/tools/Anaconda3/python.exe --action_env PYTHON_LIB_PATH=C:/tools/Anaconda3/lib/site-packages --python_path=C:/tools/Anaconda3/python.exe --action_env TF_NEED_OPENCL_SYCL=0 --action_env TF_NEED_CUDA=0 --action_env TF_DOWNLOAD_CLANG=0 --define grpc_no_ares=true --strip=always --config monolithic --copt=-w --host_copt=-w --verbose_failures\nINFO: Found applicable config definition build:monolithic in file d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc: --define framework_shared_object=false\nINFO: Found applicable config definition build:mkl in file d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc: --define=using_mkl=true -c opt --define=using_mkl=true\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_common.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_decode.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_encode.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12\nINFO: Analysed target //tensorflow:libtensorflow.so (77 packages loaded).\nINFO: Found 1 target...\nERROR: D:/tensorflow_git_reps/tensorflow_r1.9/tensorflow/BUILD:480:1: Linking of rule '//tensorflow:libtensorflow.so' failed (Exit 1169): link.exe failed: error executing command\ncd G:/tf/_bazel_50219889/4o2fzunw/execroot/org_tensorflow\nSET INCLUDE=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\INCLUDE;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\ATLMFC\\INCLUDE;C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.10240.0\\ucrt;C:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.6.1\\include\\um;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\shared;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\um;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\winrt;\nSET LIB=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\LIB\\amd64;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\ATLMFC\\LIB\\amd64;C:\\Program Files (x86)\\Windows Kits\\10\\lib\\10.0.10240.0\\ucrt\\x64;C:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.6.1\\lib\\um\\x64;C:\\Program Files (x86)\\Windows Kits\\8.1\\lib\\winv6.3\\um\\x64;\nSET PATH=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\IDE\\CommonExtensions\\Microsoft\\TestWindow;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\BIN\\amd64;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\VCPackages;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\IDE;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\Tools;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Team Tools\\Performance Tools\\x64;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Team Tools\\Performance Tools;C:\\Program Files (x86)\\Windows Kits\\8.1\\bin\\x64;C:\\Program Files (x86)\\Windows Kits\\8.1\\bin\\x86;C:\\Program Files (x86)\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.6.1 Tools\\x64;;C:\\Windows\\system32\nSET PWD=/proc/self/cwd\nSET PYTHON_BIN_PATH=C:/tools/Anaconda3/python.exe\nSET PYTHON_LIB_PATH=C:/tools/Anaconda3/lib/site-packages\nSET TEMP=C:\\Users\\50219889\\AppData\\Local\\Temp\nSET TF_DOWNLOAD_CLANG=0\nSET TF_NEED_CUDA=0\nSET TF_NEED_OPENCL_SYCL=0\nSET TMP=C:\\Users\\50219889\\AppData\\Local\\Temp\nSET USE_LINKER=1\nC:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/amd64/link.exe /nologo /DLL /WHOLEARCHIVE:external/mkl_windows/lib/libiomp5md.lib /WHOLEARCHIVE:external/mkl_windows/lib/mklml.lib /SUBSYSTEM:CONSOLE -DEFAULTLIB:advapi32.lib -pthread /MACHINE:X64 @bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.so-2.params /DEFAULTLIB:msvcrt.lib\nLINK : warning LNK4044: unrecognized option '/pthread'; ignored\nLINK : warning LNK4044: unrecognized option '/ldl'; ignored\nLINK : warning LNK4044: unrecognized option '/lpthread'; ignored\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\nLINK : warning LNK4044: unrecognized option '/ldl'; ignored\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\nmklml.lib(mklml.dll) : error LNK2005: __NULL_IMPORT_DESCRIPTOR already defined in libiomp5md.lib(libiomp5md.dll)\nCreating library bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.ifso and object bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.exp\nlibbatch_kernels.lo(batch_kernels.o) : warning LNK4217: locally defined symbol ?DEVICE_CPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_CPU) imported in function \"void __cdecl tensorflow::dynamic initializer for 'registrar__body__0__object''(void)\" (??__Eregistrar__body__0__object@tensorflow@@YAXXZ) libarithmetic_optimizer.a(arithmetic_optimizer.o) : warning LNK4049: locally defined symbol ?DEVICE_CPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_CPU) imported libarithmetic_optimizer.a(arithmetic_optimizer.o) : warning LNK4217: locally defined symbol ?DEVICE_GPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_GPU) imported in function \"private: bool __cdecl tensorflow::grappler::anonymous namespace'::ReorderCastAndTranspose::NodeIsOnCpuOrGpu(class tensorflow::NodeDef const *)const \" (?NodeIsOnCpuOrGpu@ReorderCastAndTranspose@?A0x3f420f79@grappler@tensorflow@@AEBA_NPEBVNodeDef@4@@z)\nliblayout_optimizer.a(layout_optimizer.o) : warning LNK4049: locally defined symbol ?DEVICE_GPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_GPU) imported\nbazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.so : fatal error LNK1169: one or more multiply defined symbols found\nTarget //tensorflow:libtensorflow.so failed to build\nINFO: Elapsed time: 150.103s, Critical Path: 34.36s\nINFO: 2 processes, local.\nFAILED: Build did NOT complete successfully", "body": "### System information\r\n- **OS Platform and Distribution )**: win10 x64\r\n- **TensorFlow installed from (source or binary)**: source\r\n- **TensorFlow version (use command below)**: R1.9\r\n- **Python version**:  Anaconda3 Python3.6.2\r\n- **Bazel version (if compiling from source)**: 0.14.0\r\n- **GCC/Compiler version (if compiling from source)**: VS2015 Update3\r\n- **CUDA/cuDNN version**: none\r\n- **GPU model and memory**: none\r\n- **Exact command to reproduce**: \r\nbazel build -c opt --copt=/arch:AVX  --config=mkl\\\r\n  tensorflow:libtensorflow.so \\\r\n  tensorflow/tools/lib_package:clicenses_generate \\\r\n  tensorflow/java:libtensorflow_jni.so \\\r\n  tensorflow/tools/lib_package:jnilicenses_generate\r\n\r\n### Describe the problem\r\nI want to build libtensorflow.so with \"cpu + mkl\"  in win10 os.\r\n\r\nI had builded the libtensorflow.so using the script (run_libtensorflow.bat) in the directory: tensorflow/tools/ci_build/windows/cpu/bazel/.This script works very well,but then a link error occur \r\nif I add --config=mkl to the option of bazel build. \r\n\r\nI think this link error is about mkl library,and this link error exist a period of time.\r\nI tried to build libtensorflow.so r1.8,after fixing some compilation error the same link error occur. \r\n\r\n### The verbose log are following \r\n\r\nINFO: Options provided by the client:\r\n  Inherited 'common' options: --isatty=1 --terminal_columns=120\r\nINFO: Options provided by the client:\r\n  'build' options: --python_path=C:/tools/Anaconda3/python.exe\r\nINFO: Reading rc options for 'build' from d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc:\r\n  'build' options: --define framework_shared_object=true --define=use_fast_cpp_protos=true --define=allow_oversize_protos=true --define=grpc_no_ares=true --spawn_strategy=standalone --genrule_strategy=standalone -c opt\r\nINFO: Reading rc options for 'build' from d:\\tensorflow_git_reps\\tensorflow_r1.9\\.tf_configure.bazelrc:\r\n  'build' options: --action_env PYTHON_BIN_PATH=C:/tools/Anaconda3/python.exe --action_env PYTHON_LIB_PATH=C:/tools/Anaconda3/lib/site-packages --python_path=C:/tools/Anaconda3/python.exe --action_env TF_NEED_OPENCL_SYCL=0 --action_env TF_NEED_CUDA=0 --action_env TF_DOWNLOAD_CLANG=0 --define grpc_no_ares=true --strip=always --config monolithic --copt=-w --host_copt=-w --verbose_failures\r\nINFO: Found applicable config definition build:monolithic in file d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc: --define framework_shared_object=false\r\nINFO: Found applicable config definition build:mkl in file d:\\tensorflow_git_reps\\tensorflow_r1.9\\tools\\bazel.rc: --define=using_mkl=true -c opt --define=using_mkl=true\r\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_common.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12\r\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_decode.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12\r\nWARNING: G:/tf/_bazel_50219889/4o2fzunw/external/grpc/BUILD:1960:1: in srcs attribute of cc_library rule @grpc//:grpc_nanopb: please do not import '@grpc//third_party/nanopb:pb_encode.c' directly. You should either move the file to this package or depend on an appropriate rule there. Since this rule was created by the macro 'grpc_generate_one_off_targets', the error might have been caused by the macro implementation in G:/tf/_bazel_50219889/4o2fzunw/external/grpc/bazel/grpc_build_system.bzl:172:12\r\nINFO: Analysed target //tensorflow:libtensorflow.so (77 packages loaded).\r\nINFO: Found 1 target...\r\nERROR: D:/tensorflow_git_reps/tensorflow_r1.9/tensorflow/BUILD:480:1: Linking of rule '//tensorflow:libtensorflow.so' failed (Exit 1169): link.exe failed: error executing command \r\n  cd G:/tf/_bazel_50219889/4o2fzunw/execroot/org_tensorflow\r\n  SET INCLUDE=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\INCLUDE;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\ATLMFC\\INCLUDE;C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.10240.0\\ucrt;C:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.6.1\\include\\um;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\\\shared;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\\\um;C:\\Program Files (x86)\\Windows Kits\\8.1\\include\\\\winrt;\r\n    SET LIB=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\LIB\\amd64;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\ATLMFC\\LIB\\amd64;C:\\Program Files (x86)\\Windows Kits\\10\\lib\\10.0.10240.0\\ucrt\\x64;C:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.6.1\\lib\\um\\x64;C:\\Program Files (x86)\\Windows Kits\\8.1\\lib\\winv6.3\\um\\x64;\r\n    SET PATH=C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\IDE\\CommonExtensions\\Microsoft\\TestWindow;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\BIN\\amd64;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\VCPackages;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\IDE;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\Tools;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Team Tools\\Performance Tools\\x64;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Team Tools\\Performance Tools;C:\\Program Files (x86)\\Windows Kits\\8.1\\bin\\x64;C:\\Program Files (x86)\\Windows Kits\\8.1\\bin\\x86;C:\\Program Files (x86)\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.6.1 Tools\\x64\\;;C:\\Windows\\system32\r\n    SET PWD=/proc/self/cwd\r\n    SET PYTHON_BIN_PATH=C:/tools/Anaconda3/python.exe\r\n    SET PYTHON_LIB_PATH=C:/tools/Anaconda3/lib/site-packages\r\n    SET TEMP=C:\\Users\\50219889\\AppData\\Local\\Temp\r\n    SET TF_DOWNLOAD_CLANG=0\r\n    SET TF_NEED_CUDA=0\r\n    SET TF_NEED_OPENCL_SYCL=0\r\n    SET TMP=C:\\Users\\50219889\\AppData\\Local\\Temp\r\n    SET USE_LINKER=1\r\n  C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/amd64/link.exe /nologo /DLL /WHOLEARCHIVE:external/mkl_windows/lib/libiomp5md.lib /WHOLEARCHIVE:external/mkl_windows/lib/mklml.lib /SUBSYSTEM:CONSOLE -DEFAULTLIB:advapi32.lib -pthread /MACHINE:X64 @bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.so-2.params /DEFAULTLIB:msvcrt.lib\r\nLINK : warning LNK4044: unrecognized option '/pthread'; ignored\r\nLINK : warning LNK4044: unrecognized option '/ldl'; ignored\r\nLINK : warning LNK4044: unrecognized option '/lpthread'; ignored\r\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\r\nLINK : warning LNK4044: unrecognized option '/ldl'; ignored\r\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\r\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\r\nLINK : warning LNK4044: unrecognized option '/lm'; ignored\r\n**mklml.lib(mklml.dll) : error LNK2005: __NULL_IMPORT_DESCRIPTOR already defined in libiomp5md.lib(libiomp5md.dll)**\r\n   Creating library bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.ifso and object bazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.exp\r\nlibbatch_kernels.lo(batch_kernels.o) : warning LNK4217: locally defined symbol ?DEVICE_CPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_CPU) imported in function \"void __cdecl tensorflow::`dynamic initializer for 'registrar__body__0__object''(void)\" (??__Eregistrar__body__0__object@tensorflow@@YAXXZ)\r\nlibarithmetic_optimizer.a(arithmetic_optimizer.o) : warning LNK4049: locally defined symbol ?DEVICE_CPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_CPU) imported\r\nlibarithmetic_optimizer.a(arithmetic_optimizer.o) : warning LNK4217: locally defined symbol ?DEVICE_GPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_GPU) imported in function \"private: bool __cdecl tensorflow::grappler::`anonymous namespace'::ReorderCastAndTranspose::NodeIsOnCpuOrGpu(class tensorflow::NodeDef const *)const \" (?NodeIsOnCpuOrGpu@ReorderCastAndTranspose@?A0x3f420f79@grappler@tensorflow@@AEBA_NPEBVNodeDef@4@@Z)\r\nliblayout_optimizer.a(layout_optimizer.o) : warning LNK4049: locally defined symbol ?DEVICE_GPU@tensorflow@@3QEBDEB (char const * const tensorflow::DEVICE_GPU) imported\r\nbazel-out/x64_windows-opt/bin/tensorflow/libtensorflow.so : fatal error LNK1169: one or more multiply defined symbols found\r\nTarget //tensorflow:libtensorflow.so failed to build\r\nINFO: Elapsed time: 150.103s, Critical Path: 34.36s\r\nINFO: 2 processes, local.\r\nFAILED: Build did NOT complete successfully"}