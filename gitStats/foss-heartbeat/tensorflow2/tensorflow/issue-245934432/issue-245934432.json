{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11803", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11803/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11803/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/11803/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/11803", "id": 245934432, "node_id": "MDU6SXNzdWUyNDU5MzQ0MzI=", "number": 11803, "title": "/gpu:0/stream doesn't appear on Timeline", "user": {"login": "laket", "id": 1290076, "node_id": "MDQ6VXNlcjEyOTAwNzY=", "avatar_url": "https://avatars1.githubusercontent.com/u/1290076?v=4", "gravatar_id": "", "url": "https://api.github.com/users/laket", "html_url": "https://github.com/laket", "followers_url": "https://api.github.com/users/laket/followers", "following_url": "https://api.github.com/users/laket/following{/other_user}", "gists_url": "https://api.github.com/users/laket/gists{/gist_id}", "starred_url": "https://api.github.com/users/laket/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/laket/subscriptions", "organizations_url": "https://api.github.com/users/laket/orgs", "repos_url": "https://api.github.com/users/laket/repos", "events_url": "https://api.github.com/users/laket/events{/privacy}", "received_events_url": "https://api.github.com/users/laket/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "prb12", "id": 11547801, "node_id": "MDQ6VXNlcjExNTQ3ODAx", "avatar_url": "https://avatars1.githubusercontent.com/u/11547801?v=4", "gravatar_id": "", "url": "https://api.github.com/users/prb12", "html_url": "https://github.com/prb12", "followers_url": "https://api.github.com/users/prb12/followers", "following_url": "https://api.github.com/users/prb12/following{/other_user}", "gists_url": "https://api.github.com/users/prb12/gists{/gist_id}", "starred_url": "https://api.github.com/users/prb12/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/prb12/subscriptions", "organizations_url": "https://api.github.com/users/prb12/orgs", "repos_url": "https://api.github.com/users/prb12/repos", "events_url": "https://api.github.com/users/prb12/events{/privacy}", "received_events_url": "https://api.github.com/users/prb12/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "prb12", "id": 11547801, "node_id": "MDQ6VXNlcjExNTQ3ODAx", "avatar_url": "https://avatars1.githubusercontent.com/u/11547801?v=4", "gravatar_id": "", "url": "https://api.github.com/users/prb12", "html_url": "https://github.com/prb12", "followers_url": "https://api.github.com/users/prb12/followers", "following_url": "https://api.github.com/users/prb12/following{/other_user}", "gists_url": "https://api.github.com/users/prb12/gists{/gist_id}", "starred_url": "https://api.github.com/users/prb12/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/prb12/subscriptions", "organizations_url": "https://api.github.com/users/prb12/orgs", "repos_url": "https://api.github.com/users/prb12/repos", "events_url": "https://api.github.com/users/prb12/events{/privacy}", "received_events_url": "https://api.github.com/users/prb12/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2017-07-27T06:04:45Z", "updated_at": "2017-08-01T21:58:39Z", "closed_at": "2017-08-01T21:58:39Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nUbuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<br>\nsource</li>\n<li><strong>TensorFlow version (use command below)</strong>:<br>\n('v1.2.0-2479-g88abddb', '1.3.0-rc0')</li>\n<li><strong>Python version</strong>:<br>\n2.7.12</li>\n<li><strong>Bazel version (if compiling from source)</strong>:<br>\nbazel release 0.4.5</li>\n<li><strong>CUDA/cuDNN version</strong>:<br>\nCUDA 8.0<br>\ncuDNN 5.1.5</li>\n<li><strong>GPU driver version</strong><br>\n375.66</li>\n<li><strong>GPU model and memory</strong>:<br>\nGeForce GTX 1080<br>\n8GB</li>\n<li><strong>Exact command to reproduce</strong>:<br>\npython convolution.py (attached)</li>\n</ul>\n<h3>The Problem</h3>\n<p>Making a timeline.Timeline object in my environment, \"/gpu:0/stream:xx\" rows don't appear.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/1290076/28655300-d8748114-72d5-11e7-80a9-fd1dd8198baa.png\"><img src=\"https://user-images.githubusercontent.com/1290076/28655300-d8748114-72d5-11e7-80a9-fd1dd8198baa.png\" alt=\"timeline_no_gpu\" style=\"max-width:100%;\"></a></p>\n<p>I found the event collector function <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/platform/default/gpu_tracer.cc#L149\">BufferCompleted</a> were not called at all during measuring performance.</p>\n<p>Though BufferCompleted is registered as a callback function to CUPTI for processing GPU events, CUPTI doesn't call it in my environment. This comes from failing to flush GPU events.<br>\nGPU events are flushed by <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/platform/default/gpu_tracer.cc#L206\">ActivityFlushAll</a> with flag <a href=\"http://docs.nvidia.com/cuda/cupti/group__CUPTI__ACTIVITY__API.html#group__CUPTI__ACTIVITY__API\" rel=\"nofollow\">CUPTI_ACTIVITY_FLAG_NONE</a> in tensorflow. But this flag doesn't seem to cover necessary GPU events, so GPU events were not flushed and collected.</p>\n<p>I modified gpu_tracer.cc to call ActivityFlushAll with flag CUPTI_ACTIVITY_FLAG_FORCE_INT, then I got \"/gpu:0/stream:xx\" rows in Timeline.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/1290076/28655697-86a8cd7e-72d8-11e7-8d1f-03374c4ad788.png\"><img src=\"https://user-images.githubusercontent.com/1290076/28655697-86a8cd7e-72d8-11e7-8d1f-03374c4ad788.png\" alt=\"timeline_with_gpu\" style=\"max-width:100%;\"></a></p>\n<p>Is there any reason to use CUPTI_ACTIVITY_FLAG_NONE?</p>\n<h3>Source code / logs</h3>\n<p>Attached source code comes from <a href=\"https://github.com/tensorflow/models/blob/master/tutorials/image/mnist/convolutional.py\">tensorflow/models</a> .<br>\nThe following modification was added to measure performance.</p>\n<pre><code>    from tensorflow.python.client import timeline\n    run_options = tf.RunOptions(trace_level=tf.RunOptions.FULL_TRACE)\n    run_metadata = tf.RunMetadata()\n    l, lr, predictions = sess.run([loss, learning_rate, train_prediction],\n                                   feed_dict=feed_dict, options=run_options, run_metadata=run_metadata)\n\n    tl = timeline.Timeline(run_metadata.step_stats)\n    ctf = tl.generate_chrome_trace_format(show_memory=True,\n                                        show_dataflow=True)\n    with open(\"timeline.json\", \"w\") as f:\n      f.write(ctf)\n</code></pre>\n<p><a href=\"https://github.com/tensorflow/tensorflow/files/1178943/convolutional.py.zip\">convolutional.py.zip</a></p>", "body_text": "System information\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nUbuntu 16.04\nTensorFlow installed from (source or binary):\nsource\nTensorFlow version (use command below):\n('v1.2.0-2479-g88abddb', '1.3.0-rc0')\nPython version:\n2.7.12\nBazel version (if compiling from source):\nbazel release 0.4.5\nCUDA/cuDNN version:\nCUDA 8.0\ncuDNN 5.1.5\nGPU driver version\n375.66\nGPU model and memory:\nGeForce GTX 1080\n8GB\nExact command to reproduce:\npython convolution.py (attached)\n\nThe Problem\nMaking a timeline.Timeline object in my environment, \"/gpu:0/stream:xx\" rows don't appear.\n\nI found the event collector function BufferCompleted were not called at all during measuring performance.\nThough BufferCompleted is registered as a callback function to CUPTI for processing GPU events, CUPTI doesn't call it in my environment. This comes from failing to flush GPU events.\nGPU events are flushed by ActivityFlushAll with flag CUPTI_ACTIVITY_FLAG_NONE in tensorflow. But this flag doesn't seem to cover necessary GPU events, so GPU events were not flushed and collected.\nI modified gpu_tracer.cc to call ActivityFlushAll with flag CUPTI_ACTIVITY_FLAG_FORCE_INT, then I got \"/gpu:0/stream:xx\" rows in Timeline.\n\nIs there any reason to use CUPTI_ACTIVITY_FLAG_NONE?\nSource code / logs\nAttached source code comes from tensorflow/models .\nThe following modification was added to measure performance.\n    from tensorflow.python.client import timeline\n    run_options = tf.RunOptions(trace_level=tf.RunOptions.FULL_TRACE)\n    run_metadata = tf.RunMetadata()\n    l, lr, predictions = sess.run([loss, learning_rate, train_prediction],\n                                   feed_dict=feed_dict, options=run_options, run_metadata=run_metadata)\n\n    tl = timeline.Timeline(run_metadata.step_stats)\n    ctf = tl.generate_chrome_trace_format(show_memory=True,\n                                        show_dataflow=True)\n    with open(\"timeline.json\", \"w\") as f:\n      f.write(ctf)\n\nconvolutional.py.zip", "body": "### System information\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nUbuntu 16.04\r\n- **TensorFlow installed from (source or binary)**:\r\nsource\r\n- **TensorFlow version (use command below)**:\r\n('v1.2.0-2479-g88abddb', '1.3.0-rc0')\r\n- **Python version**: \r\n2.7.12\r\n- **Bazel version (if compiling from source)**:\r\nbazel release 0.4.5\r\n- **CUDA/cuDNN version**:\r\nCUDA 8.0\r\ncuDNN 5.1.5\r\n- **GPU driver version**\r\n375.66 \r\n- **GPU model and memory**:\r\nGeForce GTX 1080 \r\n8GB\r\n- **Exact command to reproduce**:\r\npython convolution.py (attached)\r\n\r\n### The Problem\r\nMaking a timeline.Timeline object in my environment, \"/gpu:0/stream:xx\" rows don't appear. \r\n![timeline_no_gpu](https://user-images.githubusercontent.com/1290076/28655300-d8748114-72d5-11e7-80a9-fd1dd8198baa.png)\r\n\r\nI found the event collector function [BufferCompleted](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/platform/default/gpu_tracer.cc#L149) were not called at all during measuring performance. \r\n\r\nThough BufferCompleted is registered as a callback function to CUPTI for processing GPU events, CUPTI doesn't call it in my environment. This comes from failing to flush GPU events.\r\nGPU events are flushed by [ActivityFlushAll](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/platform/default/gpu_tracer.cc#L206) with flag [CUPTI_ACTIVITY_FLAG_NONE](http://docs.nvidia.com/cuda/cupti/group__CUPTI__ACTIVITY__API.html#group__CUPTI__ACTIVITY__API) in tensorflow. But this flag doesn't seem to cover necessary GPU events, so GPU events were not flushed and collected.\r\n\r\nI modified gpu_tracer.cc to call ActivityFlushAll with flag CUPTI_ACTIVITY_FLAG_FORCE_INT, then I got \"/gpu:0/stream:xx\" rows in Timeline. \r\n![timeline_with_gpu](https://user-images.githubusercontent.com/1290076/28655697-86a8cd7e-72d8-11e7-8d1f-03374c4ad788.png)\r\n\r\nIs there any reason to use CUPTI_ACTIVITY_FLAG_NONE?\r\n\r\n\r\n### Source code / logs\r\nAttached source code comes from [tensorflow/models](https://github.com/tensorflow/models/blob/master/tutorials/image/mnist/convolutional.py) .\r\nThe following modification was added to measure performance.\r\n\r\n        from tensorflow.python.client import timeline\r\n        run_options = tf.RunOptions(trace_level=tf.RunOptions.FULL_TRACE)\r\n        run_metadata = tf.RunMetadata()\r\n        l, lr, predictions = sess.run([loss, learning_rate, train_prediction],\r\n                                       feed_dict=feed_dict, options=run_options, run_metadata=run_metadata)\r\n\r\n        tl = timeline.Timeline(run_metadata.step_stats)\r\n        ctf = tl.generate_chrome_trace_format(show_memory=True,\r\n                                            show_dataflow=True)\r\n        with open(\"timeline.json\", \"w\") as f:\r\n          f.write(ctf)\r\n\r\n\r\n[convolutional.py.zip](https://github.com/tensorflow/tensorflow/files/1178943/convolutional.py.zip)\r\n"}