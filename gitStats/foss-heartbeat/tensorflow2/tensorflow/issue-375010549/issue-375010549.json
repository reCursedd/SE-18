{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23350", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23350/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23350/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23350/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23350", "id": 375010549, "node_id": "MDU6SXNzdWUzNzUwMTA1NDk=", "number": 23350, "title": "\"EncapsulateTPUComputationsPass failed\" on a model with Conv3D and Dropout layers", "user": {"login": "ftokarev", "id": 876658, "node_id": "MDQ6VXNlcjg3NjY1OA==", "avatar_url": "https://avatars1.githubusercontent.com/u/876658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ftokarev", "html_url": "https://github.com/ftokarev", "followers_url": "https://api.github.com/users/ftokarev/followers", "following_url": "https://api.github.com/users/ftokarev/following{/other_user}", "gists_url": "https://api.github.com/users/ftokarev/gists{/gist_id}", "starred_url": "https://api.github.com/users/ftokarev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ftokarev/subscriptions", "organizations_url": "https://api.github.com/users/ftokarev/orgs", "repos_url": "https://api.github.com/users/ftokarev/repos", "events_url": "https://api.github.com/users/ftokarev/events{/privacy}", "received_events_url": "https://api.github.com/users/ftokarev/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1097541661, "node_id": "MDU6TGFiZWwxMDk3NTQxNjYx", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:tpus", "name": "comp:tpus", "color": "0052cc", "default": false}, {"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "harshini-gadige", "id": 42781361, "node_id": "MDQ6VXNlcjQyNzgxMzYx", "avatar_url": "https://avatars1.githubusercontent.com/u/42781361?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harshini-gadige", "html_url": "https://github.com/harshini-gadige", "followers_url": "https://api.github.com/users/harshini-gadige/followers", "following_url": "https://api.github.com/users/harshini-gadige/following{/other_user}", "gists_url": "https://api.github.com/users/harshini-gadige/gists{/gist_id}", "starred_url": "https://api.github.com/users/harshini-gadige/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harshini-gadige/subscriptions", "organizations_url": "https://api.github.com/users/harshini-gadige/orgs", "repos_url": "https://api.github.com/users/harshini-gadige/repos", "events_url": "https://api.github.com/users/harshini-gadige/events{/privacy}", "received_events_url": "https://api.github.com/users/harshini-gadige/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "harshini-gadige", "id": 42781361, "node_id": "MDQ6VXNlcjQyNzgxMzYx", "avatar_url": "https://avatars1.githubusercontent.com/u/42781361?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harshini-gadige", "html_url": "https://github.com/harshini-gadige", "followers_url": "https://api.github.com/users/harshini-gadige/followers", "following_url": "https://api.github.com/users/harshini-gadige/following{/other_user}", "gists_url": "https://api.github.com/users/harshini-gadige/gists{/gist_id}", "starred_url": "https://api.github.com/users/harshini-gadige/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harshini-gadige/subscriptions", "organizations_url": "https://api.github.com/users/harshini-gadige/orgs", "repos_url": "https://api.github.com/users/harshini-gadige/repos", "events_url": "https://api.github.com/users/harshini-gadige/events{/privacy}", "received_events_url": "https://api.github.com/users/harshini-gadige/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-10-29T13:17:36Z", "updated_at": "2018-11-13T21:37:00Z", "closed_at": "2018-11-13T21:37:00Z", "author_association": "NONE", "body_html": "<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes</li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04</li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: n/a</li>\n<li>TensorFlow installed from (source or binary): binary</li>\n<li>TensorFlow version (use command below): 1.11.0</li>\n<li>Python version: 3.6.6</li>\n<li>Bazel version (if compiling from source): n/a</li>\n<li>GCC/Compiler version (if compiling from source): n/a</li>\n<li>CUDA/cuDNN version: n/a</li>\n<li>GPU model and memory: n/a</li>\n<li>TPU version: v3.8</li>\n</ul>\n<p>The model fails to run on a TPU. Here is a code snippet to reproduce the issue:</p>\n<pre><code>from tensorflow.keras.layers import Conv3D, Dropout, Input\nimport tensorflow as tf\nimport tensorflow.keras.backend as K\n\n\nK.set_image_data_format(\"channels_last\")\n\n\nBATCH_SIZE = 8\nINPUT_SIZE = (80, 40, 20, 3)\nOUTPUT_SIZE = (40, 20, 10, 32)\n\n\nTPU = \"&lt;tpu-name&gt;\"\nTPU_ZONE = \"europe-west4-a\"\nGCP_PROJECT = \"&lt;gcp-project&gt;\"\nMODEL_DIR = \"gs://&lt;gcs-bucket&gt;\"\n\n\ndef input_fn(params):\n    return (\n        tf.random_uniform((BATCH_SIZE, *INPUT_SIZE)),\n        tf.random_uniform((BATCH_SIZE, *OUTPUT_SIZE)))\n\n\ndef model_fn(features, labels, mode, params):\n    x = Input(tensor=features)\n    x = Conv3D(filters=32, kernel_size=(5, 5, 5), padding='same', strides=2)(x)\n    x = Dropout(0.5)(x)\n    loss = tf.losses.mean_squared_error(labels, x)\n    optimizer = tf.train.AdamOptimizer()\n    optimizer = tf.contrib.tpu.CrossShardOptimizer(optimizer)\n    train_op = optimizer.minimize(loss, global_step=tf.train.get_global_step())\n    return tf.contrib.tpu.TPUEstimatorSpec(mode=mode, loss=loss, train_op=train_op)\n\n\ntpu_cluster_resolver = tf.contrib.cluster_resolver.TPUClusterResolver(TPU,\n                                                                      zone=TPU_ZONE,\n                                                                      project=GCP_PROJECT)\n\nsession_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=True)\ntpu_config = tf.contrib.tpu.TPUConfig(iterations_per_loop=1, num_shards=8)\nrun_config = tf.contrib.tpu.RunConfig(cluster=tpu_cluster_resolver,\n                                      model_dir=MODEL_DIR,\n                                      save_checkpoints_secs=3600,\n                                      session_config=session_config,\n                                      tpu_config=tpu_config)\n\nestimator = tf.contrib.tpu.TPUEstimator(\n    model_fn=model_fn,\n    use_tpu=True,\n    config=run_config,\n    train_batch_size=8)\nestimator.train(input_fn=input_fn, max_steps=2)\n</code></pre>\n<p>Full stack trace:</p>\n<pre><code>WARNING:tensorflow:Estimator's model_fn (&lt;function model_fn at 0x7fdd54a11158&gt;) includes params argument, but params are not passed to Estimator.\n2018-10-29 13:02:51.199228: W tensorflow/core/distributed_runtime/rpc/grpc_session.cc:349] GrpcSession::ListDevices will initialize the session with an empty graph and other defaults because the session has not yet been created.\nWARNING:tensorflow:Reraising captured error\nTraceback (most recent call last):\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1292, in _do_call\n    return fn(*args)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1275, in _run_fn\n    self._extend_graph()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1312, in _extend_graph\n    tf_session.ExtendSession(self._session)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: {{node gradients/dropout/cond/dropout/div_grad/Neg/Enter}} has inputs from different frames. The input {{node dropout/cond/dropout/div/Switch}} is in frame 'while_context'. The input {{node TPUReplicateMetadata}} is in frame ''.\n        EncapsulateTPUComputationsPass failed\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"dropout_issue.py\", line 54, in &lt;module&gt;\n    estimator.train(input_fn=input_fn, max_steps=2)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/tpu_estimator.py\", line 2400, in train\n    rendezvous.raise_errors()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/error_handling.py\", line 128, in raise_errors\n    six.reraise(typ, value, traceback)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/six.py\", line 693, in reraise\n    raise value\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/tpu_estimator.py\", line 2394, in train\n    saving_listeners=saving_listeners\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1181, in _train_model\n    return self._train_model_default(input_fn, hooks, saving_listeners)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1215, in _train_model_default\n    saving_listeners)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1406, in _train_with_estimator_spec\n    log_step_count_steps=self._config.log_step_count_steps) as mon_sess:\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession\n    stop_grace_period_secs=stop_grace_period_secs)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 921, in __init__\n    stop_grace_period_secs=stop_grace_period_secs)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 643, in __init__\n    self._sess = _RecoverableSession(self._coordinated_creator)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1107, in __init__\n    _WrappedSession.__init__(self, self._create_session())\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1112, in _create_session\n    return self._sess_creator.create_session()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 800, in create_session\n    self.tf_sess = self._session_creator.create_session()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 566, in create_session\n    init_fn=self._scaffold.init_fn)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/session_manager.py\", line 287, in prepare_session\n    sess.run(init_op, feed_dict=init_feed_dict)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 887, in run\n    run_metadata_ptr)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1110, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1286, in _do_run\n    run_metadata)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1308, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: {{node gradients/dropout/cond/dropout/div_grad/Neg/Enter}} has inputs from different frames. The input {{node dropout/cond/dropout/div/Switch}} is in frame 'while_context'. The input {{node TPUReplicateMetadata}} is in frame ''.\n        EncapsulateTPUComputationsPass failed\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: n/a\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.11.0\nPython version: 3.6.6\nBazel version (if compiling from source): n/a\nGCC/Compiler version (if compiling from source): n/a\nCUDA/cuDNN version: n/a\nGPU model and memory: n/a\nTPU version: v3.8\n\nThe model fails to run on a TPU. Here is a code snippet to reproduce the issue:\nfrom tensorflow.keras.layers import Conv3D, Dropout, Input\nimport tensorflow as tf\nimport tensorflow.keras.backend as K\n\n\nK.set_image_data_format(\"channels_last\")\n\n\nBATCH_SIZE = 8\nINPUT_SIZE = (80, 40, 20, 3)\nOUTPUT_SIZE = (40, 20, 10, 32)\n\n\nTPU = \"<tpu-name>\"\nTPU_ZONE = \"europe-west4-a\"\nGCP_PROJECT = \"<gcp-project>\"\nMODEL_DIR = \"gs://<gcs-bucket>\"\n\n\ndef input_fn(params):\n    return (\n        tf.random_uniform((BATCH_SIZE, *INPUT_SIZE)),\n        tf.random_uniform((BATCH_SIZE, *OUTPUT_SIZE)))\n\n\ndef model_fn(features, labels, mode, params):\n    x = Input(tensor=features)\n    x = Conv3D(filters=32, kernel_size=(5, 5, 5), padding='same', strides=2)(x)\n    x = Dropout(0.5)(x)\n    loss = tf.losses.mean_squared_error(labels, x)\n    optimizer = tf.train.AdamOptimizer()\n    optimizer = tf.contrib.tpu.CrossShardOptimizer(optimizer)\n    train_op = optimizer.minimize(loss, global_step=tf.train.get_global_step())\n    return tf.contrib.tpu.TPUEstimatorSpec(mode=mode, loss=loss, train_op=train_op)\n\n\ntpu_cluster_resolver = tf.contrib.cluster_resolver.TPUClusterResolver(TPU,\n                                                                      zone=TPU_ZONE,\n                                                                      project=GCP_PROJECT)\n\nsession_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=True)\ntpu_config = tf.contrib.tpu.TPUConfig(iterations_per_loop=1, num_shards=8)\nrun_config = tf.contrib.tpu.RunConfig(cluster=tpu_cluster_resolver,\n                                      model_dir=MODEL_DIR,\n                                      save_checkpoints_secs=3600,\n                                      session_config=session_config,\n                                      tpu_config=tpu_config)\n\nestimator = tf.contrib.tpu.TPUEstimator(\n    model_fn=model_fn,\n    use_tpu=True,\n    config=run_config,\n    train_batch_size=8)\nestimator.train(input_fn=input_fn, max_steps=2)\n\nFull stack trace:\nWARNING:tensorflow:Estimator's model_fn (<function model_fn at 0x7fdd54a11158>) includes params argument, but params are not passed to Estimator.\n2018-10-29 13:02:51.199228: W tensorflow/core/distributed_runtime/rpc/grpc_session.cc:349] GrpcSession::ListDevices will initialize the session with an empty graph and other defaults because the session has not yet been created.\nWARNING:tensorflow:Reraising captured error\nTraceback (most recent call last):\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1292, in _do_call\n    return fn(*args)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1275, in _run_fn\n    self._extend_graph()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1312, in _extend_graph\n    tf_session.ExtendSession(self._session)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: {{node gradients/dropout/cond/dropout/div_grad/Neg/Enter}} has inputs from different frames. The input {{node dropout/cond/dropout/div/Switch}} is in frame 'while_context'. The input {{node TPUReplicateMetadata}} is in frame ''.\n        EncapsulateTPUComputationsPass failed\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"dropout_issue.py\", line 54, in <module>\n    estimator.train(input_fn=input_fn, max_steps=2)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/tpu_estimator.py\", line 2400, in train\n    rendezvous.raise_errors()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/error_handling.py\", line 128, in raise_errors\n    six.reraise(typ, value, traceback)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/six.py\", line 693, in reraise\n    raise value\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/tpu_estimator.py\", line 2394, in train\n    saving_listeners=saving_listeners\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1181, in _train_model\n    return self._train_model_default(input_fn, hooks, saving_listeners)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1215, in _train_model_default\n    saving_listeners)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1406, in _train_with_estimator_spec\n    log_step_count_steps=self._config.log_step_count_steps) as mon_sess:\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession\n    stop_grace_period_secs=stop_grace_period_secs)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 921, in __init__\n    stop_grace_period_secs=stop_grace_period_secs)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 643, in __init__\n    self._sess = _RecoverableSession(self._coordinated_creator)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1107, in __init__\n    _WrappedSession.__init__(self, self._create_session())\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1112, in _create_session\n    return self._sess_creator.create_session()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 800, in create_session\n    self.tf_sess = self._session_creator.create_session()\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 566, in create_session\n    init_fn=self._scaffold.init_fn)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/session_manager.py\", line 287, in prepare_session\n    sess.run(init_op, feed_dict=init_feed_dict)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 887, in run\n    run_metadata_ptr)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1110, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1286, in _do_run\n    run_metadata)\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1308, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: {{node gradients/dropout/cond/dropout/div_grad/Neg/Enter}} has inputs from different frames. The input {{node dropout/cond/dropout/div/Switch}} is in frame 'while_context'. The input {{node TPUReplicateMetadata}} is in frame ''.\n        EncapsulateTPUComputationsPass failed", "body": "**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: n/a\r\n- TensorFlow installed from (source or binary): binary\r\n- TensorFlow version (use command below): 1.11.0\r\n- Python version: 3.6.6\r\n- Bazel version (if compiling from source): n/a\r\n- GCC/Compiler version (if compiling from source): n/a\r\n- CUDA/cuDNN version: n/a\r\n- GPU model and memory: n/a\r\n- TPU version: v3.8\r\n\r\nThe model fails to run on a TPU. Here is a code snippet to reproduce the issue:\r\n\r\n```\r\nfrom tensorflow.keras.layers import Conv3D, Dropout, Input\r\nimport tensorflow as tf\r\nimport tensorflow.keras.backend as K\r\n\r\n\r\nK.set_image_data_format(\"channels_last\")\r\n\r\n\r\nBATCH_SIZE = 8\r\nINPUT_SIZE = (80, 40, 20, 3)\r\nOUTPUT_SIZE = (40, 20, 10, 32)\r\n\r\n\r\nTPU = \"<tpu-name>\"\r\nTPU_ZONE = \"europe-west4-a\"\r\nGCP_PROJECT = \"<gcp-project>\"\r\nMODEL_DIR = \"gs://<gcs-bucket>\"\r\n\r\n\r\ndef input_fn(params):\r\n    return (\r\n        tf.random_uniform((BATCH_SIZE, *INPUT_SIZE)),\r\n        tf.random_uniform((BATCH_SIZE, *OUTPUT_SIZE)))\r\n\r\n\r\ndef model_fn(features, labels, mode, params):\r\n    x = Input(tensor=features)\r\n    x = Conv3D(filters=32, kernel_size=(5, 5, 5), padding='same', strides=2)(x)\r\n    x = Dropout(0.5)(x)\r\n    loss = tf.losses.mean_squared_error(labels, x)\r\n    optimizer = tf.train.AdamOptimizer()\r\n    optimizer = tf.contrib.tpu.CrossShardOptimizer(optimizer)\r\n    train_op = optimizer.minimize(loss, global_step=tf.train.get_global_step())\r\n    return tf.contrib.tpu.TPUEstimatorSpec(mode=mode, loss=loss, train_op=train_op)\r\n\r\n\r\ntpu_cluster_resolver = tf.contrib.cluster_resolver.TPUClusterResolver(TPU,\r\n                                                                      zone=TPU_ZONE,\r\n                                                                      project=GCP_PROJECT)\r\n\r\nsession_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=True)\r\ntpu_config = tf.contrib.tpu.TPUConfig(iterations_per_loop=1, num_shards=8)\r\nrun_config = tf.contrib.tpu.RunConfig(cluster=tpu_cluster_resolver,\r\n                                      model_dir=MODEL_DIR,\r\n                                      save_checkpoints_secs=3600,\r\n                                      session_config=session_config,\r\n                                      tpu_config=tpu_config)\r\n\r\nestimator = tf.contrib.tpu.TPUEstimator(\r\n    model_fn=model_fn,\r\n    use_tpu=True,\r\n    config=run_config,\r\n    train_batch_size=8)\r\nestimator.train(input_fn=input_fn, max_steps=2)\r\n```\r\n\r\nFull stack trace:\r\n\r\n```\r\nWARNING:tensorflow:Estimator's model_fn (<function model_fn at 0x7fdd54a11158>) includes params argument, but params are not passed to Estimator.\r\n2018-10-29 13:02:51.199228: W tensorflow/core/distributed_runtime/rpc/grpc_session.cc:349] GrpcSession::ListDevices will initialize the session with an empty graph and other defaults because the session has not yet been created.\r\nWARNING:tensorflow:Reraising captured error\r\nTraceback (most recent call last):\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1292, in _do_call\r\n    return fn(*args)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1275, in _run_fn\r\n    self._extend_graph()\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1312, in _extend_graph\r\n    tf_session.ExtendSession(self._session)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: {{node gradients/dropout/cond/dropout/div_grad/Neg/Enter}} has inputs from different frames. The input {{node dropout/cond/dropout/div/Switch}} is in frame 'while_context'. The input {{node TPUReplicateMetadata}} is in frame ''.\r\n        EncapsulateTPUComputationsPass failed\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"dropout_issue.py\", line 54, in <module>\r\n    estimator.train(input_fn=input_fn, max_steps=2)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/tpu_estimator.py\", line 2400, in train\r\n    rendezvous.raise_errors()\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/error_handling.py\", line 128, in raise_errors\r\n    six.reraise(typ, value, traceback)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/six.py\", line 693, in reraise\r\n    raise value\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/contrib/tpu/python/tpu/tpu_estimator.py\", line 2394, in train\r\n    saving_listeners=saving_listeners\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1181, in _train_model\r\n    return self._train_model_default(input_fn, hooks, saving_listeners)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1215, in _train_model_default\r\n    saving_listeners)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1406, in _train_with_estimator_spec\r\n    log_step_count_steps=self._config.log_step_count_steps) as mon_sess:\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession\r\n    stop_grace_period_secs=stop_grace_period_secs)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 921, in __init__\r\n    stop_grace_period_secs=stop_grace_period_secs)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 643, in __init__\r\n    self._sess = _RecoverableSession(self._coordinated_creator)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1107, in __init__\r\n    _WrappedSession.__init__(self, self._create_session())\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1112, in _create_session\r\n    return self._sess_creator.create_session()\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 800, in create_session\r\n    self.tf_sess = self._session_creator.create_session()\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 566, in create_session\r\n    init_fn=self._scaffold.init_fn)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/training/session_manager.py\", line 287, in prepare_session\r\n    sess.run(init_op, feed_dict=init_feed_dict)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 887, in run\r\n    run_metadata_ptr)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1110, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1286, in _do_run\r\n    run_metadata)\r\n  File \"/opt/miniconda3/envs/tpu-tf-1.11/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1308, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: {{node gradients/dropout/cond/dropout/div_grad/Neg/Enter}} has inputs from different frames. The input {{node dropout/cond/dropout/div/Switch}} is in frame 'while_context'. The input {{node TPUReplicateMetadata}} is in frame ''.\r\n        EncapsulateTPUComputationsPass failed\r\n```\r\n\r\n"}