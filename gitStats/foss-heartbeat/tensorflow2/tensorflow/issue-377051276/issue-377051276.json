{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23477", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23477/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23477/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23477/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23477", "id": 377051276, "node_id": "MDU6SXNzdWUzNzcwNTEyNzY=", "number": 23477, "title": "Tensorflow's Estimator stops training", "user": {"login": "edoost", "id": 30546099, "node_id": "MDQ6VXNlcjMwNTQ2MDk5", "avatar_url": "https://avatars2.githubusercontent.com/u/30546099?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edoost", "html_url": "https://github.com/edoost", "followers_url": "https://api.github.com/users/edoost/followers", "following_url": "https://api.github.com/users/edoost/following{/other_user}", "gists_url": "https://api.github.com/users/edoost/gists{/gist_id}", "starred_url": "https://api.github.com/users/edoost/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edoost/subscriptions", "organizations_url": "https://api.github.com/users/edoost/orgs", "repos_url": "https://api.github.com/users/edoost/repos", "events_url": "https://api.github.com/users/edoost/events{/privacy}", "received_events_url": "https://api.github.com/users/edoost/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "open", "locked": false, "assignee": {"login": "rchao", "id": 6505863, "node_id": "MDQ6VXNlcjY1MDU4NjM=", "avatar_url": "https://avatars2.githubusercontent.com/u/6505863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rchao", "html_url": "https://github.com/rchao", "followers_url": "https://api.github.com/users/rchao/followers", "following_url": "https://api.github.com/users/rchao/following{/other_user}", "gists_url": "https://api.github.com/users/rchao/gists{/gist_id}", "starred_url": "https://api.github.com/users/rchao/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rchao/subscriptions", "organizations_url": "https://api.github.com/users/rchao/orgs", "repos_url": "https://api.github.com/users/rchao/repos", "events_url": "https://api.github.com/users/rchao/events{/privacy}", "received_events_url": "https://api.github.com/users/rchao/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rchao", "id": 6505863, "node_id": "MDQ6VXNlcjY1MDU4NjM=", "avatar_url": "https://avatars2.githubusercontent.com/u/6505863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rchao", "html_url": "https://github.com/rchao", "followers_url": "https://api.github.com/users/rchao/followers", "following_url": "https://api.github.com/users/rchao/following{/other_user}", "gists_url": "https://api.github.com/users/rchao/gists{/gist_id}", "starred_url": "https://api.github.com/users/rchao/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rchao/subscriptions", "organizations_url": "https://api.github.com/users/rchao/orgs", "repos_url": "https://api.github.com/users/rchao/repos", "events_url": "https://api.github.com/users/rchao/events{/privacy}", "received_events_url": "https://api.github.com/users/rchao/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-11-03T12:42:50Z", "updated_at": "2018-11-23T18:37:36Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>I asked this question on Stackoverflow 2 days ago (<a href=\"https://stackoverflow.com/questions/53089945/tensorflows-estimator-stops-training\" rel=\"nofollow\">https://stackoverflow.com/questions/53089945/tensorflows-estimator-stops-training</a>).</p>\n<p>I am training a model using Tensorflow's Estimator, but it suddenly stops training after 2600 steps after performing an evaluation. This is the last part of my code:</p>\n<pre><code>def train():\n    train_input_func = lambda: input_fn(mode='train')\n    eval_input_func = lambda: input_fn(mode='eval')\n\n    est_conf = tf.estimator.RunConfig(cfg.model_dir, save_checkpoints_secs=120)\n    estimator = tf.estimator.Estimator(model_fn, cfg.model_dir, est_conf)\n\n\n    Path(estimator.eval_dir()).mkdir(parents=True, exist_ok=True)\n    train_spec = tf.estimator.TrainSpec(input_fn=train_input_func)\n    eval_spec = tf.estimator.EvalSpec(input_fn=eval_input_func, throttle_secs=120)\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n\nif __name__ == '__main__':\n    train()\n</code></pre>\n<p>and this is the <code>input_fn</code>:</p>\n<pre><code>def input_fn(mode=None):\n        data_generator = lambda: data_loader.data_generator(mode=mode)\n\n        dataset = tf.data.Dataset.from_generator(data_generator,\n                                                 output_types=(tf.int32, tf.int32),\n                                                 output_shapes=([None], [None]))\n\n        if mode is 'train':\n            dataset.shuffle(cfg.shuffle_buffer).repeat(1000)\n\n        dataset = dataset.padded_batch(cfg.batch_size, padded_shapes=([None],[None])).prefetch(1)\n\n        return dataset\n</code></pre>\n<p>The training simply stops like this:</p>\n<pre><code>loss = 3.530099, step = 2500 (4.443 sec)          \nglobal_step/sec: 25.3421 \nloss = 1.3306174, step = 2600 (3.946 sec)         \nSaving checkpoints for 2604 into ./model/model.ckpt.                                                \nCalling model_fn.        \nDone calling model_fn.   \nStarting evaluation at 2018-11-03-12:15:23        \nGraph was finalized.     \n2018-11-03 15:45:23.655651: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1490] Adding visible gpu devices: 0\n2018-11-03 15:45:23.655681: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-11-03 15:45:23.655685: I tensorflow/core/common_runtime/gpu/gpu_device.cc:977]      0          \n2018-11-03 15:45:23.655689: I tensorflow/core/common_runtime/gpu/gpu_device.cc:990] 0:   N          \n2018-11-03 15:45:23.655805: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1103] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 10402 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:01:00.0, compute capability: 6.1)\nRestoring parameters from ./model/model.ckpt-2604 \nRunning local_init_op.   \nDone running local_init_op.                       \nEvaluation [10/100]      \nEvaluation [20/100]      \nEvaluation [30/100]      \nEvaluation [40/100]      \nEvaluation [50/100]      \nEvaluation [60/100]      \nEvaluation [70/100]      \nEvaluation [80/100]      \nEvaluation [90/100]      \nEvaluation [100/100]     \nFinished evaluation at 2018-11-03-12:15:26        \nSaving dict for global step 2604: acc = 0.9593193, global_step = 2604, loss = 2.918349              \nSaving 'checkpoint_path' summary for global step 2604: ./model/model.ckpt-2604                      \nLoss for final step: 0.83287233.                  \n\n</code></pre>\n<p>Isn't it supposed to continue training until the end of the last epoch?</p>\n<p>Also, if I run it on CPU, I recieve this:</p>\n<pre><code>Caused by op 'cond_1/GatherV2_1', defined at:                                                                                                                                            \n  File \"tf_pos_lstm.py\", line 125, in &lt;module&gt;                                                                                                                                           \n    train()                                                                                                                                                                              \n  File \"tf_pos_lstm.py\", line 122, in train\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 471, in train_and_evaluate\n    return executor.run()\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 610, in run\n    return self.run_local()\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 711, in run_local\n    saving_listeners=saving_listeners)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1181, in _train_model\n    return self._train_model_default(input_fn, hooks, saving_listeners)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1211, in _train_model_default\n    features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1169, in _call_model_fn\n    model_fn_results = self._model_fn(features=features, **kwargs)\n  File \"tf_pos_lstm.py\", line 56, in model_fn\n    crf_params)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 250, in crf_log_likelihood\n    transition_params)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 114, in crf_sequence_score\n    false_fn=_multi_seq_fn)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/layers/utils.py\", line 202, in smart_cond\n    pred, true_fn=true_fn, false_fn=false_fn, name=name)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/smart_cond.py\", line 59, in smart_cond\n    name=name)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n    return func(*args, **kwargs)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2087, in cond\n    orig_res_f, res_f = context_f.BuildCondBranch(false_fn)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1920, in BuildCondBranch\n    original_result = fn()\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 106, in _multi_seq_fn\n    transition_params)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 320, in crf_binary_score\n    flattened_transition_indices)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 2669, in gather\n    return gen_array_ops.gather_v2(params, indices, axis, name=name)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 3232, in gather_v2\n    \"GatherV2\", params=params, indices=indices, axis=axis, name=name)\nFile \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n    return func(*args, **kwargs)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3272, in create_op\n    op_def=op_def)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1768, in __init__\n    self._traceback = tf_stack.extract_stack()\n\nInvalidArgumentError (see above for traceback): indices[12,23] = 551 is not in [0, 529)\n         [[{{node cond_1/GatherV2_1}} = GatherV2[Taxis=DT_INT32, Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](cond_1/Reshape_4, cond_1/ad\nd_2, gradients/f_count)]]\n</code></pre>\n<p><strong>System information</strong></p>\n<pre><code>== cat /etc/issue ===============================================\nLinux deep 4.13.0-46-generic #51-Ubuntu SMP Tue Jun 12 12:36:29 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n\n== are we in docker =============================================\nNo\n\n== compiler =====================================================\nc++ (Ubuntu 7.2.0-8ubuntu3.2) 7.2.0\nCopyright (C) 2017 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n\n\n== uname -a =====================================================\nLinux deep 4.13.0-46-generic #51-Ubuntu SMP Tue Jun 12 12:36:29 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n\n== check pips ===================================================\nnumpy               1.14.5\nprotobuf            3.6.0\ntensorflow          1.11.0\n\n== check for virtualenv =========================================\nFalse\n\n== tensorflow import ============================================\ntf.VERSION = 1.11.0\ntf.GIT_VERSION = b'unknown'\ntf.COMPILER_VERSION = b'unknown'\nSanity check: array([1], dtype=int32)\n\n== env ==========================================================\nLD_LIBRARY_PATH is unset\nDYLD_LIBRARY_PATH is unset\n\n== nvidia-smi ===================================================\nSat Nov  3 16:05:47 2018\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 390.67                 Driver Version: 390.67                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GTX 108...  Off  | 00000000:01:00.0 Off |                  N/A |\n|  0%   43C    P5    37W / 250W |      0MiB / 11176MiB |      3%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID   Type   Process name                             Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n\n\n</code></pre>", "body_text": "I asked this question on Stackoverflow 2 days ago (https://stackoverflow.com/questions/53089945/tensorflows-estimator-stops-training).\nI am training a model using Tensorflow's Estimator, but it suddenly stops training after 2600 steps after performing an evaluation. This is the last part of my code:\ndef train():\n    train_input_func = lambda: input_fn(mode='train')\n    eval_input_func = lambda: input_fn(mode='eval')\n\n    est_conf = tf.estimator.RunConfig(cfg.model_dir, save_checkpoints_secs=120)\n    estimator = tf.estimator.Estimator(model_fn, cfg.model_dir, est_conf)\n\n\n    Path(estimator.eval_dir()).mkdir(parents=True, exist_ok=True)\n    train_spec = tf.estimator.TrainSpec(input_fn=train_input_func)\n    eval_spec = tf.estimator.EvalSpec(input_fn=eval_input_func, throttle_secs=120)\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n\nif __name__ == '__main__':\n    train()\n\nand this is the input_fn:\ndef input_fn(mode=None):\n        data_generator = lambda: data_loader.data_generator(mode=mode)\n\n        dataset = tf.data.Dataset.from_generator(data_generator,\n                                                 output_types=(tf.int32, tf.int32),\n                                                 output_shapes=([None], [None]))\n\n        if mode is 'train':\n            dataset.shuffle(cfg.shuffle_buffer).repeat(1000)\n\n        dataset = dataset.padded_batch(cfg.batch_size, padded_shapes=([None],[None])).prefetch(1)\n\n        return dataset\n\nThe training simply stops like this:\nloss = 3.530099, step = 2500 (4.443 sec)          \nglobal_step/sec: 25.3421 \nloss = 1.3306174, step = 2600 (3.946 sec)         \nSaving checkpoints for 2604 into ./model/model.ckpt.                                                \nCalling model_fn.        \nDone calling model_fn.   \nStarting evaluation at 2018-11-03-12:15:23        \nGraph was finalized.     \n2018-11-03 15:45:23.655651: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1490] Adding visible gpu devices: 0\n2018-11-03 15:45:23.655681: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-11-03 15:45:23.655685: I tensorflow/core/common_runtime/gpu/gpu_device.cc:977]      0          \n2018-11-03 15:45:23.655689: I tensorflow/core/common_runtime/gpu/gpu_device.cc:990] 0:   N          \n2018-11-03 15:45:23.655805: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1103] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 10402 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:01:00.0, compute capability: 6.1)\nRestoring parameters from ./model/model.ckpt-2604 \nRunning local_init_op.   \nDone running local_init_op.                       \nEvaluation [10/100]      \nEvaluation [20/100]      \nEvaluation [30/100]      \nEvaluation [40/100]      \nEvaluation [50/100]      \nEvaluation [60/100]      \nEvaluation [70/100]      \nEvaluation [80/100]      \nEvaluation [90/100]      \nEvaluation [100/100]     \nFinished evaluation at 2018-11-03-12:15:26        \nSaving dict for global step 2604: acc = 0.9593193, global_step = 2604, loss = 2.918349              \nSaving 'checkpoint_path' summary for global step 2604: ./model/model.ckpt-2604                      \nLoss for final step: 0.83287233.                  \n\n\nIsn't it supposed to continue training until the end of the last epoch?\nAlso, if I run it on CPU, I recieve this:\nCaused by op 'cond_1/GatherV2_1', defined at:                                                                                                                                            \n  File \"tf_pos_lstm.py\", line 125, in <module>                                                                                                                                           \n    train()                                                                                                                                                                              \n  File \"tf_pos_lstm.py\", line 122, in train\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 471, in train_and_evaluate\n    return executor.run()\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 610, in run\n    return self.run_local()\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 711, in run_local\n    saving_listeners=saving_listeners)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1181, in _train_model\n    return self._train_model_default(input_fn, hooks, saving_listeners)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1211, in _train_model_default\n    features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1169, in _call_model_fn\n    model_fn_results = self._model_fn(features=features, **kwargs)\n  File \"tf_pos_lstm.py\", line 56, in model_fn\n    crf_params)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 250, in crf_log_likelihood\n    transition_params)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 114, in crf_sequence_score\n    false_fn=_multi_seq_fn)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/layers/utils.py\", line 202, in smart_cond\n    pred, true_fn=true_fn, false_fn=false_fn, name=name)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/smart_cond.py\", line 59, in smart_cond\n    name=name)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n    return func(*args, **kwargs)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2087, in cond\n    orig_res_f, res_f = context_f.BuildCondBranch(false_fn)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1920, in BuildCondBranch\n    original_result = fn()\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 106, in _multi_seq_fn\n    transition_params)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 320, in crf_binary_score\n    flattened_transition_indices)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 2669, in gather\n    return gen_array_ops.gather_v2(params, indices, axis, name=name)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 3232, in gather_v2\n    \"GatherV2\", params=params, indices=indices, axis=axis, name=name)\nFile \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n    return func(*args, **kwargs)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3272, in create_op\n    op_def=op_def)\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1768, in __init__\n    self._traceback = tf_stack.extract_stack()\n\nInvalidArgumentError (see above for traceback): indices[12,23] = 551 is not in [0, 529)\n         [[{{node cond_1/GatherV2_1}} = GatherV2[Taxis=DT_INT32, Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](cond_1/Reshape_4, cond_1/ad\nd_2, gradients/f_count)]]\n\nSystem information\n== cat /etc/issue ===============================================\nLinux deep 4.13.0-46-generic #51-Ubuntu SMP Tue Jun 12 12:36:29 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n\n== are we in docker =============================================\nNo\n\n== compiler =====================================================\nc++ (Ubuntu 7.2.0-8ubuntu3.2) 7.2.0\nCopyright (C) 2017 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n\n\n== uname -a =====================================================\nLinux deep 4.13.0-46-generic #51-Ubuntu SMP Tue Jun 12 12:36:29 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n\n== check pips ===================================================\nnumpy               1.14.5\nprotobuf            3.6.0\ntensorflow          1.11.0\n\n== check for virtualenv =========================================\nFalse\n\n== tensorflow import ============================================\ntf.VERSION = 1.11.0\ntf.GIT_VERSION = b'unknown'\ntf.COMPILER_VERSION = b'unknown'\nSanity check: array([1], dtype=int32)\n\n== env ==========================================================\nLD_LIBRARY_PATH is unset\nDYLD_LIBRARY_PATH is unset\n\n== nvidia-smi ===================================================\nSat Nov  3 16:05:47 2018\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 390.67                 Driver Version: 390.67                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GTX 108...  Off  | 00000000:01:00.0 Off |                  N/A |\n|  0%   43C    P5    37W / 250W |      0MiB / 11176MiB |      3%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID   Type   Process name                             Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+", "body": "I asked this question on Stackoverflow 2 days ago (https://stackoverflow.com/questions/53089945/tensorflows-estimator-stops-training).\r\n\r\nI am training a model using Tensorflow's Estimator, but it suddenly stops training after 2600 steps after performing an evaluation. This is the last part of my code:\r\n\r\n```\r\ndef train():\r\n    train_input_func = lambda: input_fn(mode='train')\r\n    eval_input_func = lambda: input_fn(mode='eval')\r\n\r\n    est_conf = tf.estimator.RunConfig(cfg.model_dir, save_checkpoints_secs=120)\r\n    estimator = tf.estimator.Estimator(model_fn, cfg.model_dir, est_conf)\r\n\r\n\r\n    Path(estimator.eval_dir()).mkdir(parents=True, exist_ok=True)\r\n    train_spec = tf.estimator.TrainSpec(input_fn=train_input_func)\r\n    eval_spec = tf.estimator.EvalSpec(input_fn=eval_input_func, throttle_secs=120)\r\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\r\n\r\nif __name__ == '__main__':\r\n    train()\r\n```\r\n\r\nand this is the `input_fn`:\r\n\r\n```\r\ndef input_fn(mode=None):\r\n        data_generator = lambda: data_loader.data_generator(mode=mode)\r\n\r\n        dataset = tf.data.Dataset.from_generator(data_generator,\r\n                                                 output_types=(tf.int32, tf.int32),\r\n                                                 output_shapes=([None], [None]))\r\n\r\n        if mode is 'train':\r\n            dataset.shuffle(cfg.shuffle_buffer).repeat(1000)\r\n\r\n        dataset = dataset.padded_batch(cfg.batch_size, padded_shapes=([None],[None])).prefetch(1)\r\n\r\n        return dataset\r\n```\r\n\r\nThe training simply stops like this:\r\n\r\n```\r\nloss = 3.530099, step = 2500 (4.443 sec)          \r\nglobal_step/sec: 25.3421 \r\nloss = 1.3306174, step = 2600 (3.946 sec)         \r\nSaving checkpoints for 2604 into ./model/model.ckpt.                                                \r\nCalling model_fn.        \r\nDone calling model_fn.   \r\nStarting evaluation at 2018-11-03-12:15:23        \r\nGraph was finalized.     \r\n2018-11-03 15:45:23.655651: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1490] Adding visible gpu devices: 0\r\n2018-11-03 15:45:23.655681: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-11-03 15:45:23.655685: I tensorflow/core/common_runtime/gpu/gpu_device.cc:977]      0          \r\n2018-11-03 15:45:23.655689: I tensorflow/core/common_runtime/gpu/gpu_device.cc:990] 0:   N          \r\n2018-11-03 15:45:23.655805: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1103] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 10402 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\nRestoring parameters from ./model/model.ckpt-2604 \r\nRunning local_init_op.   \r\nDone running local_init_op.                       \r\nEvaluation [10/100]      \r\nEvaluation [20/100]      \r\nEvaluation [30/100]      \r\nEvaluation [40/100]      \r\nEvaluation [50/100]      \r\nEvaluation [60/100]      \r\nEvaluation [70/100]      \r\nEvaluation [80/100]      \r\nEvaluation [90/100]      \r\nEvaluation [100/100]     \r\nFinished evaluation at 2018-11-03-12:15:26        \r\nSaving dict for global step 2604: acc = 0.9593193, global_step = 2604, loss = 2.918349              \r\nSaving 'checkpoint_path' summary for global step 2604: ./model/model.ckpt-2604                      \r\nLoss for final step: 0.83287233.                  \r\n\r\n```\r\nIsn't it supposed to continue training until the end of the last epoch?\r\n\r\nAlso, if I run it on CPU, I recieve this:\r\n\r\n```\r\nCaused by op 'cond_1/GatherV2_1', defined at:                                                                                                                                            \r\n  File \"tf_pos_lstm.py\", line 125, in <module>                                                                                                                                           \r\n    train()                                                                                                                                                                              \r\n  File \"tf_pos_lstm.py\", line 122, in train\r\n    tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 471, in train_and_evaluate\r\n    return executor.run()\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 610, in run\r\n    return self.run_local()\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 711, in run_local\r\n    saving_listeners=saving_listeners)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 356, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1181, in _train_model\r\n    return self._train_model_default(input_fn, hooks, saving_listeners)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1211, in _train_model_default\r\n    features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1169, in _call_model_fn\r\n    model_fn_results = self._model_fn(features=features, **kwargs)\r\n  File \"tf_pos_lstm.py\", line 56, in model_fn\r\n    crf_params)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 250, in crf_log_likelihood\r\n    transition_params)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 114, in crf_sequence_score\r\n    false_fn=_multi_seq_fn)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/layers/utils.py\", line 202, in smart_cond\r\n    pred, true_fn=true_fn, false_fn=false_fn, name=name)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/smart_cond.py\", line 59, in smart_cond\r\n    name=name)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2087, in cond\r\n    orig_res_f, res_f = context_f.BuildCondBranch(false_fn)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1920, in BuildCondBranch\r\n    original_result = fn()\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 106, in _multi_seq_fn\r\n    transition_params)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/contrib/crf/python/ops/crf.py\", line 320, in crf_binary_score\r\n    flattened_transition_indices)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 2669, in gather\r\n    return gen_array_ops.gather_v2(params, indices, axis, name=name)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 3232, in gather_v2\r\n    \"GatherV2\", params=params, indices=indices, axis=axis, name=name)\r\nFile \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3272, in create_op\r\n    op_def=op_def)\r\n  File \"/home/nazarbin/miniconda3/envs/cpuenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1768, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n\r\nInvalidArgumentError (see above for traceback): indices[12,23] = 551 is not in [0, 529)\r\n         [[{{node cond_1/GatherV2_1}} = GatherV2[Taxis=DT_INT32, Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](cond_1/Reshape_4, cond_1/ad\r\nd_2, gradients/f_count)]]\r\n```\r\n\r\n\r\n**System information**\r\n\r\n```\r\n== cat /etc/issue ===============================================\r\nLinux deep 4.13.0-46-generic #51-Ubuntu SMP Tue Jun 12 12:36:29 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n== are we in docker =============================================\r\nNo\r\n\r\n== compiler =====================================================\r\nc++ (Ubuntu 7.2.0-8ubuntu3.2) 7.2.0\r\nCopyright (C) 2017 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n\r\n\r\n== uname -a =====================================================\r\nLinux deep 4.13.0-46-generic #51-Ubuntu SMP Tue Jun 12 12:36:29 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n== check pips ===================================================\r\nnumpy               1.14.5\r\nprotobuf            3.6.0\r\ntensorflow          1.11.0\r\n\r\n== check for virtualenv =========================================\r\nFalse\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 1.11.0\r\ntf.GIT_VERSION = b'unknown'\r\ntf.COMPILER_VERSION = b'unknown'\r\nSanity check: array([1], dtype=int32)\r\n\r\n== env ==========================================================\r\nLD_LIBRARY_PATH is unset\r\nDYLD_LIBRARY_PATH is unset\r\n\r\n== nvidia-smi ===================================================\r\nSat Nov  3 16:05:47 2018\r\n+-----------------------------------------------------------------------------+\r\n| NVIDIA-SMI 390.67                 Driver Version: 390.67                    |\r\n|-------------------------------+----------------------+----------------------+\r\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\r\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\r\n|===============================+======================+======================|\r\n|   0  GeForce GTX 108...  Off  | 00000000:01:00.0 Off |                  N/A |\r\n|  0%   43C    P5    37W / 250W |      0MiB / 11176MiB |      3%      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n\r\n+-----------------------------------------------------------------------------+\r\n| Processes:                                                       GPU Memory |\r\n|  GPU       PID   Type   Process name                             Usage      |\r\n|=============================================================================|\r\n|  No running processes found                                                 |\r\n+-----------------------------------------------------------------------------+\r\n\r\n\r\n```\r\n"}