{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/431089676", "html_url": "https://github.com/tensorflow/tensorflow/issues/22619#issuecomment-431089676", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22619", "id": 431089676, "node_id": "MDEyOklzc3VlQ29tbWVudDQzMTA4OTY3Ng==", "user": {"login": "elliottslaughter", "id": 3129, "node_id": "MDQ6VXNlcjMxMjk=", "avatar_url": "https://avatars0.githubusercontent.com/u/3129?v=4", "gravatar_id": "", "url": "https://api.github.com/users/elliottslaughter", "html_url": "https://github.com/elliottslaughter", "followers_url": "https://api.github.com/users/elliottslaughter/followers", "following_url": "https://api.github.com/users/elliottslaughter/following{/other_user}", "gists_url": "https://api.github.com/users/elliottslaughter/gists{/gist_id}", "starred_url": "https://api.github.com/users/elliottslaughter/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/elliottslaughter/subscriptions", "organizations_url": "https://api.github.com/users/elliottslaughter/orgs", "repos_url": "https://api.github.com/users/elliottslaughter/repos", "events_url": "https://api.github.com/users/elliottslaughter/events{/privacy}", "received_events_url": "https://api.github.com/users/elliottslaughter/received_events", "type": "User", "site_admin": false}, "created_at": "2018-10-18T17:12:28Z", "updated_at": "2018-10-18T17:12:28Z", "author_association": "NONE", "body_html": "<p>I can confirm that the constant folding pass was the issue. Using <code>tf.placeholder</code> as suggested does fix the problem. For anyone who comes here later, I've updated my gist, and you can see the difference with the new <code>--no-const-fold</code> option:</p>\n<pre><code>$ time python test_cores.py 2 --use-inter\n2018-10-18 10:07:53.755221: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\nRunning on 1 CPU devices with 2 inter- and 1 intra-parallelism\n  Assigning matmul to /cpu:0\n  Assigning matmul to /cpu:0\n  Duration (via time.perf_counter()): 46.047578 (1190217.583074 - 1190171.535495)\n  Clock (via time.clock()): 46.045166 (51.374167 - 5.329001)\n\nreal\t0m47.237s\nuser\t0m46.413s\nsys\t0m5.146s\n$ time python test_cores.py 2 --use-inter --no-const-fold\n2018-10-18 10:08:49.194386: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\nRunning on 1 CPU devices with 2 inter- and 1 intra-parallelism\n  Assigning matmul to /cpu:0\n  Assigning matmul to /cpu:0\n  Duration (via time.perf_counter()): 25.088182 (1190255.414810 - 1190230.326628)\n  Clock (via time.clock()): 48.275543 (57.226300 - 8.950757)\n\nreal\t0m29.652s\nuser\t0m49.870s\nsys\t0m7.621s\n</code></pre>\n<p>The updated gist shows how to use <code>tf.placeholder</code> to achieve this:</p>\n<p><a href=\"https://gist.github.com/elliottslaughter/750a27c832782f4daec8686281027de8\">https://gist.github.com/elliottslaughter/750a27c832782f4daec8686281027de8</a></p>\n<p>Thanks <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=40365382\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/azaks2\">@azaks2</a> for your help!</p>", "body_text": "I can confirm that the constant folding pass was the issue. Using tf.placeholder as suggested does fix the problem. For anyone who comes here later, I've updated my gist, and you can see the difference with the new --no-const-fold option:\n$ time python test_cores.py 2 --use-inter\n2018-10-18 10:07:53.755221: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\nRunning on 1 CPU devices with 2 inter- and 1 intra-parallelism\n  Assigning matmul to /cpu:0\n  Assigning matmul to /cpu:0\n  Duration (via time.perf_counter()): 46.047578 (1190217.583074 - 1190171.535495)\n  Clock (via time.clock()): 46.045166 (51.374167 - 5.329001)\n\nreal\t0m47.237s\nuser\t0m46.413s\nsys\t0m5.146s\n$ time python test_cores.py 2 --use-inter --no-const-fold\n2018-10-18 10:08:49.194386: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\nRunning on 1 CPU devices with 2 inter- and 1 intra-parallelism\n  Assigning matmul to /cpu:0\n  Assigning matmul to /cpu:0\n  Duration (via time.perf_counter()): 25.088182 (1190255.414810 - 1190230.326628)\n  Clock (via time.clock()): 48.275543 (57.226300 - 8.950757)\n\nreal\t0m29.652s\nuser\t0m49.870s\nsys\t0m7.621s\n\nThe updated gist shows how to use tf.placeholder to achieve this:\nhttps://gist.github.com/elliottslaughter/750a27c832782f4daec8686281027de8\nThanks @azaks2 for your help!", "body": "I can confirm that the constant folding pass was the issue. Using `tf.placeholder` as suggested does fix the problem. For anyone who comes here later, I've updated my gist, and you can see the difference with the new `--no-const-fold` option:\r\n\r\n```\r\n$ time python test_cores.py 2 --use-inter\r\n2018-10-18 10:07:53.755221: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\nRunning on 1 CPU devices with 2 inter- and 1 intra-parallelism\r\n  Assigning matmul to /cpu:0\r\n  Assigning matmul to /cpu:0\r\n  Duration (via time.perf_counter()): 46.047578 (1190217.583074 - 1190171.535495)\r\n  Clock (via time.clock()): 46.045166 (51.374167 - 5.329001)\r\n\r\nreal\t0m47.237s\r\nuser\t0m46.413s\r\nsys\t0m5.146s\r\n$ time python test_cores.py 2 --use-inter --no-const-fold\r\n2018-10-18 10:08:49.194386: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\nRunning on 1 CPU devices with 2 inter- and 1 intra-parallelism\r\n  Assigning matmul to /cpu:0\r\n  Assigning matmul to /cpu:0\r\n  Duration (via time.perf_counter()): 25.088182 (1190255.414810 - 1190230.326628)\r\n  Clock (via time.clock()): 48.275543 (57.226300 - 8.950757)\r\n\r\nreal\t0m29.652s\r\nuser\t0m49.870s\r\nsys\t0m7.621s\r\n```\r\n\r\nThe updated gist shows how to use `tf.placeholder` to achieve this:\r\n\r\nhttps://gist.github.com/elliottslaughter/750a27c832782f4daec8686281027de8\r\n\r\nThanks @azaks2 for your help!"}