{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3710", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3710/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3710/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3710/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/3710", "id": 170176361, "node_id": "MDU6SXNzdWUxNzAxNzYzNjE=", "number": 3710, "title": "function.Defun can't be applied to tf.Variable", "user": {"login": "zeis", "id": 1945427, "node_id": "MDQ6VXNlcjE5NDU0Mjc=", "avatar_url": "https://avatars1.githubusercontent.com/u/1945427?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zeis", "html_url": "https://github.com/zeis", "followers_url": "https://api.github.com/users/zeis/followers", "following_url": "https://api.github.com/users/zeis/following{/other_user}", "gists_url": "https://api.github.com/users/zeis/gists{/gist_id}", "starred_url": "https://api.github.com/users/zeis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zeis/subscriptions", "organizations_url": "https://api.github.com/users/zeis/orgs", "repos_url": "https://api.github.com/users/zeis/repos", "events_url": "https://api.github.com/users/zeis/events{/privacy}", "received_events_url": "https://api.github.com/users/zeis/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "andydavis1", "id": 15696327, "node_id": "MDQ6VXNlcjE1Njk2MzI3", "avatar_url": "https://avatars0.githubusercontent.com/u/15696327?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andydavis1", "html_url": "https://github.com/andydavis1", "followers_url": "https://api.github.com/users/andydavis1/followers", "following_url": "https://api.github.com/users/andydavis1/following{/other_user}", "gists_url": "https://api.github.com/users/andydavis1/gists{/gist_id}", "starred_url": "https://api.github.com/users/andydavis1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andydavis1/subscriptions", "organizations_url": "https://api.github.com/users/andydavis1/orgs", "repos_url": "https://api.github.com/users/andydavis1/repos", "events_url": "https://api.github.com/users/andydavis1/events{/privacy}", "received_events_url": "https://api.github.com/users/andydavis1/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "andydavis1", "id": 15696327, "node_id": "MDQ6VXNlcjE1Njk2MzI3", "avatar_url": "https://avatars0.githubusercontent.com/u/15696327?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andydavis1", "html_url": "https://github.com/andydavis1", "followers_url": "https://api.github.com/users/andydavis1/followers", "following_url": "https://api.github.com/users/andydavis1/following{/other_user}", "gists_url": "https://api.github.com/users/andydavis1/gists{/gist_id}", "starred_url": "https://api.github.com/users/andydavis1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andydavis1/subscriptions", "organizations_url": "https://api.github.com/users/andydavis1/orgs", "repos_url": "https://api.github.com/users/andydavis1/repos", "events_url": "https://api.github.com/users/andydavis1/events{/privacy}", "received_events_url": "https://api.github.com/users/andydavis1/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2016-08-09T14:11:04Z", "updated_at": "2017-02-09T22:02:10Z", "closed_at": "2016-10-09T02:32:16Z", "author_association": "NONE", "body_html": "<p>I need to specify a custom gradient for my custom_op() function. I've written the following example.</p>\n<pre><code>import numpy as np\nimport tensorflow as tf\nfrom tensorflow.python.framework import function\n\ndef custom_op_grad(op, grad):\n    return grad\n\n@function.Defun(x=tf.float32, python_grad_func=custom_op_grad)\ndef custom_op(x):\n    exp = tf.exp(x)\n    constant = tf.constant(1., dtype=tf.float32)\n    add1 = tf.add(constant, exp)\n    log = tf.log(add1)\n    return log\n\nx = tf.Variable(np.array(np.arange(6)).reshape(3, 2), dtype=tf.float32)\n\nsess = tf.Session()\nsess.run(tf.initialize_all_variables())\n\nx = tf.identity(x)\n\ngrad = tf.gradients(custom_op(x), [x])[0]\n\nres = sess.run(grad)\n\nprint(res)\n\nsess.close()\n</code></pre>\n<p>If I run the above example as it is I get the following result:</p>\n<pre><code>[[ 1.  1.]\n [ 1.  1.]\n [ 1.  1.]]\n</code></pre>\n<p>If I comment out the @function.Defun(...) decorator (with I use to specify a custom gradient function) I get a different result:</p>\n<pre><code>[[ 0.5         0.7310586 ]\n [ 0.88079709  0.95257413]\n [ 0.98201376  0.99330717]]\n</code></pre>\n<p>That is strange because custom_op_grad(op, grad) just returns grad, which I guess should be the same as the gradient calculated in the second case.</p>\n<p>Moreover, if I keep the decorator I also need to do this: x = tf.identity(x). If I comment out this line, I get the following error and I don't understand why:</p>\n<pre><code>Traceback (most recent call last):\n  File \"custom_op3.py\", line 42, in &lt;module&gt;\n    grad = tf.gradients(custom_op(x), [x])[0]\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/function.py\", line 528, in __call__\n    return call_function(self._definition, *args, **kwargs)\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/function.py\", line 267, in call_function\n    compute_shapes=False)\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2285, in create_op\n    raise TypeError(\"Input #%d is not a tensor: %s\" % (idx, a))\nTypeError: Input #0 is not a tensor: &lt;tensorflow.python.ops.variables.Variable object at 0x10eb7d710&gt;\n</code></pre>\n<p>I'm using the GitHub version of TensofFlow.</p>", "body_text": "I need to specify a custom gradient for my custom_op() function. I've written the following example.\nimport numpy as np\nimport tensorflow as tf\nfrom tensorflow.python.framework import function\n\ndef custom_op_grad(op, grad):\n    return grad\n\n@function.Defun(x=tf.float32, python_grad_func=custom_op_grad)\ndef custom_op(x):\n    exp = tf.exp(x)\n    constant = tf.constant(1., dtype=tf.float32)\n    add1 = tf.add(constant, exp)\n    log = tf.log(add1)\n    return log\n\nx = tf.Variable(np.array(np.arange(6)).reshape(3, 2), dtype=tf.float32)\n\nsess = tf.Session()\nsess.run(tf.initialize_all_variables())\n\nx = tf.identity(x)\n\ngrad = tf.gradients(custom_op(x), [x])[0]\n\nres = sess.run(grad)\n\nprint(res)\n\nsess.close()\n\nIf I run the above example as it is I get the following result:\n[[ 1.  1.]\n [ 1.  1.]\n [ 1.  1.]]\n\nIf I comment out the @function.Defun(...) decorator (with I use to specify a custom gradient function) I get a different result:\n[[ 0.5         0.7310586 ]\n [ 0.88079709  0.95257413]\n [ 0.98201376  0.99330717]]\n\nThat is strange because custom_op_grad(op, grad) just returns grad, which I guess should be the same as the gradient calculated in the second case.\nMoreover, if I keep the decorator I also need to do this: x = tf.identity(x). If I comment out this line, I get the following error and I don't understand why:\nTraceback (most recent call last):\n  File \"custom_op3.py\", line 42, in <module>\n    grad = tf.gradients(custom_op(x), [x])[0]\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/function.py\", line 528, in __call__\n    return call_function(self._definition, *args, **kwargs)\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/function.py\", line 267, in call_function\n    compute_shapes=False)\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2285, in create_op\n    raise TypeError(\"Input #%d is not a tensor: %s\" % (idx, a))\nTypeError: Input #0 is not a tensor: <tensorflow.python.ops.variables.Variable object at 0x10eb7d710>\n\nI'm using the GitHub version of TensofFlow.", "body": "I need to specify a custom gradient for my custom_op() function. I've written the following example.\n\n```\nimport numpy as np\nimport tensorflow as tf\nfrom tensorflow.python.framework import function\n\ndef custom_op_grad(op, grad):\n    return grad\n\n@function.Defun(x=tf.float32, python_grad_func=custom_op_grad)\ndef custom_op(x):\n    exp = tf.exp(x)\n    constant = tf.constant(1., dtype=tf.float32)\n    add1 = tf.add(constant, exp)\n    log = tf.log(add1)\n    return log\n\nx = tf.Variable(np.array(np.arange(6)).reshape(3, 2), dtype=tf.float32)\n\nsess = tf.Session()\nsess.run(tf.initialize_all_variables())\n\nx = tf.identity(x)\n\ngrad = tf.gradients(custom_op(x), [x])[0]\n\nres = sess.run(grad)\n\nprint(res)\n\nsess.close()\n```\n\nIf I run the above example as it is I get the following result:\n\n```\n[[ 1.  1.]\n [ 1.  1.]\n [ 1.  1.]]\n```\n\nIf I comment out the @function.Defun(...) decorator (with I use to specify a custom gradient function) I get a different result:\n\n```\n[[ 0.5         0.7310586 ]\n [ 0.88079709  0.95257413]\n [ 0.98201376  0.99330717]]\n```\n\nThat is strange because custom_op_grad(op, grad) just returns grad, which I guess should be the same as the gradient calculated in the second case.\n\nMoreover, if I keep the decorator I also need to do this: x = tf.identity(x). If I comment out this line, I get the following error and I don't understand why:\n\n```\nTraceback (most recent call last):\n  File \"custom_op3.py\", line 42, in <module>\n    grad = tf.gradients(custom_op(x), [x])[0]\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/function.py\", line 528, in __call__\n    return call_function(self._definition, *args, **kwargs)\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/function.py\", line 267, in call_function\n    compute_shapes=False)\n  File \"/Users/zeis/tfm/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2285, in create_op\n    raise TypeError(\"Input #%d is not a tensor: %s\" % (idx, a))\nTypeError: Input #0 is not a tensor: <tensorflow.python.ops.variables.Variable object at 0x10eb7d710>\n```\n\nI'm using the GitHub version of TensofFlow.\n"}