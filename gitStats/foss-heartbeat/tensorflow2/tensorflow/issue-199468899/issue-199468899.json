{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6730", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6730/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6730/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6730/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6730", "id": 199468899, "node_id": "MDU6SXNzdWUxOTk0Njg4OTk=", "number": 6730, "title": "tf.map_fn throws error...sometimes.... ", "user": {"login": "usmcamp0811", "id": 17965629, "node_id": "MDQ6VXNlcjE3OTY1NjI5", "avatar_url": "https://avatars0.githubusercontent.com/u/17965629?v=4", "gravatar_id": "", "url": "https://api.github.com/users/usmcamp0811", "html_url": "https://github.com/usmcamp0811", "followers_url": "https://api.github.com/users/usmcamp0811/followers", "following_url": "https://api.github.com/users/usmcamp0811/following{/other_user}", "gists_url": "https://api.github.com/users/usmcamp0811/gists{/gist_id}", "starred_url": "https://api.github.com/users/usmcamp0811/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/usmcamp0811/subscriptions", "organizations_url": "https://api.github.com/users/usmcamp0811/orgs", "repos_url": "https://api.github.com/users/usmcamp0811/repos", "events_url": "https://api.github.com/users/usmcamp0811/events{/privacy}", "received_events_url": "https://api.github.com/users/usmcamp0811/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}, {"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-01-09T02:58:15Z", "updated_at": "2017-01-16T04:00:38Z", "closed_at": "2017-01-16T04:00:38Z", "author_association": "NONE", "body_html": "<h3>Environment info</h3>\n<p>Operating System: Ubuntu 16.04</p>\n<p>Installed version of CUDA and cuDNN:<br>\nlibcudart.so.8.0 (libc6,x86-64) =&gt; /usr/local/cuda-8.0/targets/x86_64-linux/lib/libcudart.so.8.0<br>\nlibcudart.so.7.5 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/libcudart.so.7.5<br>\nlibcudart.so (libc6,x86-64) =&gt; /usr/local/cuda-8.0/targets/x86_64-linux/lib/libcudart.so<br>\nlibcudart.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/libcudart.so<br>\nlibcuda.so.1 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/libcuda.so.1<br>\nlibcuda.so.1 (libc6) =&gt; /usr/lib/i386-linux-gnu/libcuda.so.1<br>\nlibcuda.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/libcuda.so<br>\nlibcuda.so (libc6) =&gt; /usr/lib/i386-linux-gnu/libcuda.so</p>\n<p>pip install tensorflow-gpu<br>\n0.12.0-rc1</p>\n<h3>If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)</h3>\n<p>I posted to the below stackoverflow link with some code and my initial problem that I mostly fixed, but it does seem that there is a problem with the tf.map_fn()<br>\n<a href=\"http://stackoverflow.com/questions/41534866/image-distortion-returns-error-the-tensor-returned-for-reshape-50-was-not-vali/41536952?noredirect=1#comment70281037_41536952\" rel=\"nofollow\">http://stackoverflow.com/questions/41534866/image-distortion-returns-error-the-tensor-returned-for-reshape-50-was-not-vali/41536952?noredirect=1#comment70281037_41536952</a></p>\n<p>I was trying to use tf.map_fn to distort a batch of images and it throws an error sometimes... the batch starts its life as a TFRecords file of flat images. The batch is turned into 4d tensor by tf.reshape then put through tf.map_fn(image distortion function) and then reshaped back into a flat 2d tensor. Most of the time I get a reshape error but not all the time. The times I don't get the error, the code will run for all epochs...</p>\n<p>`/home/mcamp/anaconda3/bin/python \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/train_model.py\"<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally<br>\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally<br>\nI tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero<br>\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:<br>\nname: GeForce GTX 960<br>\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.342<br>\npciBusID 0000:01:00.0<br>\nTotal memory: 3.94GiB<br>\nFree memory: 2.53GiB<br>\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0<br>\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y<br>\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 960, pci bus id: 0000:01:00.0)<br>\n*<br>\nTraceback (most recent call last):<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1021, in _do_call<br>\nreturn fn(*args)<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1003, in _run_fn<br>\nstatus, run_metadata)<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/contextlib.py\", line 66, in <strong>exit</strong><br>\nnext(self.gen)<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py\", line 469, in raise_exception_on_not_ok_status<br>\npywrap_tensorflow.TF_GetCode(status))<br>\ntensorflow.python.framework.errors_impl.InvalidArgumentError: The tensor returned for Reshape_3:0 was not valid.</p>\n<p>During handling of the above exception, another exception occurred:</p>\n<p>Traceback (most recent call last):<br>\nFile \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/train_model.py\", line 44, in <br>\nmodel.train(training_data, epochs=FLAGS.n_epochs)<br>\nFile \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/ConvNetClass.py\", line 190, in train<br>\ntraining_data_dict['y_train_batch']]) <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115898449\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/4\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/4/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/4\">#4</a><br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 766, in run<br>\nrun_metadata_ptr)<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 964, in _run<br>\nfeed_dict_string, options, run_metadata)<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1014, in _do_run<br>\ntarget_list, options, run_metadata)<br>\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1034, in _do_call<br>\nraise type(e)(node_def, op, message)<br>\ntensorflow.python.framework.errors_impl.InvalidArgumentError: The tensor returned for Reshape_3:0 was not valid.`</p>", "body_text": "Environment info\nOperating System: Ubuntu 16.04\nInstalled version of CUDA and cuDNN:\nlibcudart.so.8.0 (libc6,x86-64) => /usr/local/cuda-8.0/targets/x86_64-linux/lib/libcudart.so.8.0\nlibcudart.so.7.5 (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcudart.so.7.5\nlibcudart.so (libc6,x86-64) => /usr/local/cuda-8.0/targets/x86_64-linux/lib/libcudart.so\nlibcudart.so (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcudart.so\nlibcuda.so.1 (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcuda.so.1\nlibcuda.so.1 (libc6) => /usr/lib/i386-linux-gnu/libcuda.so.1\nlibcuda.so (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcuda.so\nlibcuda.so (libc6) => /usr/lib/i386-linux-gnu/libcuda.so\npip install tensorflow-gpu\n0.12.0-rc1\nIf possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\nI posted to the below stackoverflow link with some code and my initial problem that I mostly fixed, but it does seem that there is a problem with the tf.map_fn()\nhttp://stackoverflow.com/questions/41534866/image-distortion-returns-error-the-tensor-returned-for-reshape-50-was-not-vali/41536952?noredirect=1#comment70281037_41536952\nI was trying to use tf.map_fn to distort a batch of images and it throws an error sometimes... the batch starts its life as a TFRecords file of flat images. The batch is turned into 4d tensor by tf.reshape then put through tf.map_fn(image distortion function) and then reshaped back into a flat 2d tensor. Most of the time I get a reshape error but not all the time. The times I don't get the error, the code will run for all epochs...\n`/home/mcamp/anaconda3/bin/python \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/train_model.py\"\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\nI tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 960\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.342\npciBusID 0000:01:00.0\nTotal memory: 3.94GiB\nFree memory: 2.53GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 960, pci bus id: 0000:01:00.0)\n*\nTraceback (most recent call last):\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1021, in _do_call\nreturn fn(*args)\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1003, in _run_fn\nstatus, run_metadata)\nFile \"/home/mcamp/anaconda3/lib/python3.5/contextlib.py\", line 66, in exit\nnext(self.gen)\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py\", line 469, in raise_exception_on_not_ok_status\npywrap_tensorflow.TF_GetCode(status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: The tensor returned for Reshape_3:0 was not valid.\nDuring handling of the above exception, another exception occurred:\nTraceback (most recent call last):\nFile \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/train_model.py\", line 44, in \nmodel.train(training_data, epochs=FLAGS.n_epochs)\nFile \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/ConvNetClass.py\", line 190, in train\ntraining_data_dict['y_train_batch']]) #4\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 766, in run\nrun_metadata_ptr)\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 964, in _run\nfeed_dict_string, options, run_metadata)\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1014, in _do_run\ntarget_list, options, run_metadata)\nFile \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1034, in _do_call\nraise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: The tensor returned for Reshape_3:0 was not valid.`", "body": "### Environment info\r\nOperating System: Ubuntu 16.04\r\n\r\nInstalled version of CUDA and cuDNN: \r\n\tlibcudart.so.8.0 (libc6,x86-64) => /usr/local/cuda-8.0/targets/x86_64-linux/lib/libcudart.so.8.0\r\n\tlibcudart.so.7.5 (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcudart.so.7.5\r\n\tlibcudart.so (libc6,x86-64) => /usr/local/cuda-8.0/targets/x86_64-linux/lib/libcudart.so\r\n\tlibcudart.so (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcudart.so\r\n\tlibcuda.so.1 (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcuda.so.1\r\n\tlibcuda.so.1 (libc6) => /usr/lib/i386-linux-gnu/libcuda.so.1\r\n\tlibcuda.so (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libcuda.so\r\n\tlibcuda.so (libc6) => /usr/lib/i386-linux-gnu/libcuda.so\r\n\r\npip install tensorflow-gpu\r\n 0.12.0-rc1\r\n\r\n### If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\r\nI posted to the below stackoverflow link with some code and my initial problem that I mostly fixed, but it does seem that there is a problem with the tf.map_fn()\r\nhttp://stackoverflow.com/questions/41534866/image-distortion-returns-error-the-tensor-returned-for-reshape-50-was-not-vali/41536952?noredirect=1#comment70281037_41536952 \r\n\r\nI was trying to use tf.map_fn to distort a batch of images and it throws an error sometimes... the batch starts its life as a TFRecords file of flat images. The batch is turned into 4d tensor by tf.reshape then put through tf.map_fn(image distortion function) and then reshaped back into a flat 2d tensor. Most of the time I get a reshape error but not all the time. The times I don't get the error, the code will run for all epochs...\r\n\r\n`/home/mcamp/anaconda3/bin/python \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/train_model.py\"\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\r\nI tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties: \r\nname: GeForce GTX 960\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.342\r\npciBusID 0000:01:00.0\r\nTotal memory: 3.94GiB\r\nFree memory: 2.53GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0 \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 960, pci bus id: 0000:01:00.0)\r\n*\r\nTraceback (most recent call last):\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1021, in _do_call\r\n    return fn(*args)\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1003, in _run_fn\r\n    status, run_metadata)\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/contextlib.py\", line 66, in __exit__\r\n    next(self.gen)\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py\", line 469, in raise_exception_on_not_ok_status\r\n    pywrap_tensorflow.TF_GetCode(status))\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: The tensor returned for Reshape_3:0 was not valid.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/train_model.py\", line 44, in <module>\r\n    model.train(training_data, epochs=FLAGS.n_epochs)\r\n  File \"/media/mcamp/Local SSHD/Python Projects/GarageDoor2/ConvNetClass.py\", line 190, in train\r\n    training_data_dict['y_train_batch']]) #4\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 766, in run\r\n    run_metadata_ptr)\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 964, in _run\r\n    feed_dict_string, options, run_metadata)\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1014, in _do_run\r\n    target_list, options, run_metadata)\r\n  File \"/home/mcamp/anaconda3/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1034, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: The tensor returned for Reshape_3:0 was not valid.`\r\n"}