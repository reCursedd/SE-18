{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/215096218", "pull_request_review_id": 152289100, "id": 215096218, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTA5NjIxOA==", "diff_hunk": "@@ -467,33 +467,26 @@ void CUDAExecutor::VlogOccupancyInfo(const KernelBase &kernel,\n     return;\n   }\n \n+  int block_size = thread_dims.x * thread_dims.y * thread_dims.z;\n+\n   const DeviceDescription &device_description =\n       kernel.parent()->GetDeviceDescription();\n \n-  uint64 blocks_per_sm = CalculateOccupancy(\n-      device_description, regs_per_thread, smem_per_block, thread_dims);\n-  VLOG(2) << \"Resident blocks per SM is \" << blocks_per_sm;\n+  const CUDAKernel* cuda_kernel = AsCUDAKernel(&kernel);\n+  CUfunction cufunc = cuda_kernel->AsCUDAFunctionValue();\n \n-  // To increase occupancy, there must be a sufficient number of blocks\n-  // available to spread across the sm's at this new improved occupancy level.\n-  int multiprocessor_count = device_description.core_count();\n-  int block_count = block_dims.x * block_dims.y * block_dims.z;\n-  int available_blocks_per_sm =\n-      port::MathUtil::CeilOfRatio(block_count, multiprocessor_count);\n-  if (available_blocks_per_sm <= static_cast<int64>(blocks_per_sm)) {\n-    VLOG(2) << \"Occupancy is limited by number of blocks available per sm.\";\n-    return;\n-  }\n+  int blocks_per_sm = CalculateOccupancy(device_description, regs_per_thread,\n+                                         smem_per_block, thread_dims, cufunc);\n+  VLOG(2) << \"Resident blocks per SM is \" << blocks_per_sm;\n \n-  uint64 improved_regs_per_thread = CalculateRegisterLimitForTargetOccupancy(\n-      device_description, smem_per_block, thread_dims, blocks_per_sm + 1);\n-  if (improved_regs_per_thread != 0) {\n-    VLOG(2) << \"Reducing register usage from \" << regs_per_thread\n-            << \" to \" << improved_regs_per_thread\n-            << \" could increase resident blocks per SM by one.\";\n-  } else {\n-    VLOG(2) << \"Resident blocks per SM cannot be increased by reducing \"\n-        \"register usage.\";\n+  int suggested_threads =\n+      CompareOccupancy(&blocks_per_sm, device_description, regs_per_thread,\n+                       smem_per_block, thread_dims, cufunc);\n+  if (suggested_threads != 0) {\n+    VLOG(2) << \"The cuda occupancy calculator reccommends using \"", "path": "tensorflow/stream_executor/cuda/cuda_gpu_executor.cc", "position": null, "original_position": 42, "commit_id": "6a5090b086bc9d665eb9e65f05eb94cdb58baaa2", "original_commit_id": "e93a9f9ccfd9c7a2419bf3fc1d7866765bbcfce3", "user": {"login": "jlebar", "id": 150663, "node_id": "MDQ6VXNlcjE1MDY2Mw==", "avatar_url": "https://avatars1.githubusercontent.com/u/150663?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jlebar", "html_url": "https://github.com/jlebar", "followers_url": "https://api.github.com/users/jlebar/followers", "following_url": "https://api.github.com/users/jlebar/following{/other_user}", "gists_url": "https://api.github.com/users/jlebar/gists{/gist_id}", "starred_url": "https://api.github.com/users/jlebar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jlebar/subscriptions", "organizations_url": "https://api.github.com/users/jlebar/orgs", "repos_url": "https://api.github.com/users/jlebar/repos", "events_url": "https://api.github.com/users/jlebar/events{/privacy}", "received_events_url": "https://api.github.com/users/jlebar/received_events", "type": "User", "site_admin": false}, "body": "reccommends (sorry I was coy)", "created_at": "2018-09-04T23:25:23Z", "updated_at": "2018-09-06T20:09:45Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/21958#discussion_r215096218", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/21958", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/215096218"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/21958#discussion_r215096218"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/21958"}}, "body_html": "<p>reccommends (sorry I was coy)</p>", "body_text": "reccommends (sorry I was coy)", "in_reply_to_id": 214497803}