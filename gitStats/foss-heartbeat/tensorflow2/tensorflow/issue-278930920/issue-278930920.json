{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15091", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15091/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15091/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15091/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/15091", "id": 278930920, "node_id": "MDU6SXNzdWUyNzg5MzA5MjA=", "number": 15091, "title": "GatherNd InvalidArgumentError: flat indices[8, :] = [8, -1] does not index into param", "user": {"login": "laghaout", "id": 12374939, "node_id": "MDQ6VXNlcjEyMzc0OTM5", "avatar_url": "https://avatars2.githubusercontent.com/u/12374939?v=4", "gravatar_id": "", "url": "https://api.github.com/users/laghaout", "html_url": "https://github.com/laghaout", "followers_url": "https://api.github.com/users/laghaout/followers", "following_url": "https://api.github.com/users/laghaout/following{/other_user}", "gists_url": "https://api.github.com/users/laghaout/gists{/gist_id}", "starred_url": "https://api.github.com/users/laghaout/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/laghaout/subscriptions", "organizations_url": "https://api.github.com/users/laghaout/orgs", "repos_url": "https://api.github.com/users/laghaout/repos", "events_url": "https://api.github.com/users/laghaout/events{/privacy}", "received_events_url": "https://api.github.com/users/laghaout/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2017-12-04T09:45:44Z", "updated_at": "2018-11-01T18:32:30Z", "closed_at": "2017-12-08T20:47:35Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>OS Platform and Distribution</strong>: Ubuntu 17.10 (Linux-4.13.0-17-generic-x86_64-with-debian-stretch-sid)</li>\n<li><strong>TensorFlow installed from</strong>: binary</li>\n<li><strong>TensorFlow version</strong>: v1.3.0-rc2-20-g0787eee 1.3.0 (same on 1.4.0)</li>\n<li><strong>Python version</strong>: 3.6.3</li>\n<li><strong>GPU model and memory</strong>: N/A (CPU only)</li>\n<li><strong>Numpy version:</strong> 1.13.3</li>\n<li><strong>Bazel version</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>C++ compiler version</strong>: (Ubuntu 7.2.0-8ubuntu3) 7.2.0</li>\n<li><strong>Have I written custom code</strong>: Yes</li>\n<li><strong>Exact command to reproduce</strong>: There is no single command. The error arises when trying to fetch a TensorFlow tensor. Please see the description below.</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I am training a recurrent neural network (RNN) whereby I give it variable-length sequences of random steps in two dimensions and train it to recognize the quadrant in which the random walker ended up. This RNN works fine on a Windows machine with GPU (all other specs are otherwise the same as above). However, on a Linux machine with CPU only, I get an error which mysteriously traces back to a dimensionality hiccup with <code>GatherNd</code>.</p>\n<p>The code for the full RNN is too convoluted to post, but as you can see from below, I am printing out the fetches to two tensors <code>tf_weights</code> and <code>tf_last</code> at each iteration of the batching. (In this case the training data is consumed one batch at a time for a total of 28 batches). The batches are very basic loops so you'd think that if a fetch works in one iteration of the loop it should also work for the next. This is indeed the case for <code>tf_weights</code> but not for <code>tf_last</code> which, for no apparent reason, fails to evaluate at batch 7/28. <code>tf_last</code> can be traced to a <code>GatherNd</code> operation.</p>\n<p>I thoroughly inspected the data and it looks fine. <em>Please keep in mind that my code does work under Windows with GPU with all other specs remaining the same, so it's hard to conceive of a bug from within the code itself.</em></p>\n<h3>Source code</h3>\n<pre><code>import tensorflow as tf\n\ngraph = tf.Graph()\n\nwith graph.as_default():\n\n    tf_features = tf.placeholder(\n            tf.float32, [batch_size, max_seq_len, input_dim], \n            name = 'tf_features')\n\n    tf_targets = tf.placeholder(\n            tf.float32, [batch_size, target_len],\n            name = 'tf_targets')\n\n    tf_seq_len = tf.placeholder(\n            tf.int32, [batch_size],\n            name = 'tf_seq_len')\n\n    tf_cell = 'tf.contrib.rnn.'+cell_type+'('+str(num_hidden)+')'\n    tf_cell = eval(tf_cell)\n\n    tf_output, tf_state = tf.nn.dynamic_rnn(\n            tf_cell, tf_features, sequence_length = tf_seq_len, \n            dtype = tf.float32)\n  \n    tf_output = tf_output[:, :, :num_hidden]\n           \n    tf_last = tf.gather_nd(\n            tf_output, \n            tf.stack([tf.range(batch_size), tf_seq_len-1], axis = 1), # batch_size\n            name = 'tf_last')\n</code></pre>\n<h3>Logs</h3>\n<pre><code>---------------- RUN 0/0\n ---------------- FOLD 0/2\n  ---------------- TRAIN\n  Epoch 0\n  - Optimizing optimize\n   ---------------- BATCH 0/28 [0, 50], len_data = 1499\n   *** tf_weights: -0.563565\n   *** tf_last: -0.192192\n   ---------------- BATCH 1/28 [50, 100], len_data = 1499\n   *** tf_weights: -0.553565\n   *** tf_last: -0.0799878\n   ---------------- BATCH 2/28 [100, 150], len_data = 1499\n   *** tf_weights: -0.546777\n   *** tf_last: -0.118384\n   ---------------- BATCH 3/28 [150, 200], len_data = 1499\n   *** tf_weights: -0.538511\n   *** tf_last: -0.142531\n   ---------------- BATCH 4/28 [200, 250], len_data = 1499\n   *** tf_weights: -0.529593\n   *** tf_last: -0.147268\n   ---------------- BATCH 5/28 [250, 300], len_data = 1499\n   *** tf_weights: -0.520294\n   *** tf_last: -0.014847\n   ---------------- BATCH 6/28 [300, 350], len_data = 1499\n   *** tf_weights: -0.510754\n   *** tf_last: -0.094138\n   ---------------- BATCH 7/28 [350, 400], len_data = 1499\n   *** tf_weights: -0.504503\n   *** Failed to evaluate tf_last\nTraceback (most recent call last):\n\n  File \"&lt;ipython-input-25-49e8720a879a&gt;\", line 1, in &lt;module&gt;\n    runfile('/home/ala/Python/domains/main.py', wdir='/home/ala/Python/domains')\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 710, in runfile\n    execfile(filename, namespace)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 101, in execfile\n    exec(compile(f.read(), filename, 'exec'), namespace)\n\n  File \"/home/ala/Python/domains/main.py\", line 166, in &lt;module&gt;\n    metrics_valid = RNN_object.validate(data_train, KFolds)\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 727, in validate\n    reinitialize = True))\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 366, in train\n    self.optimize(data)\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 1102, in optimize\n    optimized_driving_metric = self.evaluate(data, driving_metric)\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 1796, in evaluate\n    evaluated_tf_var = self.sess.run(eval(tf_var), feed_dict)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 895, in run\n    run_metadata_ptr)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1124, in _run\n    feed_dict_tensor, options, run_metadata)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1321, in _do_run\n    options, run_metadata)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _do_call\n    raise type(e)(node_def, op, message)\n\nInvalidArgumentError: flat indices[8, :] = [8, -1] does not index into param (shape: [50,300,2]).\n\t [[Node: tf_last = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](strided_slice_2, stack)]]\n\nCaused by op 'tf_last', defined at:\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py\", line 245, in &lt;module&gt;\n    main()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py\", line 241, in main\n    kernel.start()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelapp.py\", line 477, in start\n    ioloop.IOLoop.instance().start()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/ioloop.py\", line 177, in start\n    super(ZMQIOLoop, self).start()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/ioloop.py\", line 888, in start\n    handler_func(fd_obj, events)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\n    self._handle_recv()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\n    callback(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 283, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 235, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 399, in execute_request\n    user_expressions, allow_stdin)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2728, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2856, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2910, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"&lt;ipython-input-25-49e8720a879a&gt;\", line 1, in &lt;module&gt;\n    runfile('/home/ala/Python/domains/main.py', wdir='/home/ala/Python/domains')\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 710, in runfile\n    execfile(filename, namespace)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 101, in execfile\n    exec(compile(f.read(), filename, 'exec'), namespace)\n  File \"/home/ala/Python/domains/main.py\", line 109, in &lt;module&gt;\n    RNN_object.define(data_test)\n  File \"/home/ala/Python/domains/classifiers.py\", line 1514, in define\n    name = 'tf_last')\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1338, in gather_nd\n    name=name)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2630, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1204, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): flat indices[8, :] = [8, -1] does not index into param (shape: [50,300,2]).\n\t [[Node: tf_last = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](strided_slice_2, stack)]]\n</code></pre>", "body_text": "System information\n\nOS Platform and Distribution: Ubuntu 17.10 (Linux-4.13.0-17-generic-x86_64-with-debian-stretch-sid)\nTensorFlow installed from: binary\nTensorFlow version: v1.3.0-rc2-20-g0787eee 1.3.0 (same on 1.4.0)\nPython version: 3.6.3\nGPU model and memory: N/A (CPU only)\nNumpy version: 1.13.3\nBazel version: N/A\nCUDA/cuDNN version: N/A\nC++ compiler version: (Ubuntu 7.2.0-8ubuntu3) 7.2.0\nHave I written custom code: Yes\nExact command to reproduce: There is no single command. The error arises when trying to fetch a TensorFlow tensor. Please see the description below.\n\nDescribe the problem\nI am training a recurrent neural network (RNN) whereby I give it variable-length sequences of random steps in two dimensions and train it to recognize the quadrant in which the random walker ended up. This RNN works fine on a Windows machine with GPU (all other specs are otherwise the same as above). However, on a Linux machine with CPU only, I get an error which mysteriously traces back to a dimensionality hiccup with GatherNd.\nThe code for the full RNN is too convoluted to post, but as you can see from below, I am printing out the fetches to two tensors tf_weights and tf_last at each iteration of the batching. (In this case the training data is consumed one batch at a time for a total of 28 batches). The batches are very basic loops so you'd think that if a fetch works in one iteration of the loop it should also work for the next. This is indeed the case for tf_weights but not for tf_last which, for no apparent reason, fails to evaluate at batch 7/28. tf_last can be traced to a GatherNd operation.\nI thoroughly inspected the data and it looks fine. Please keep in mind that my code does work under Windows with GPU with all other specs remaining the same, so it's hard to conceive of a bug from within the code itself.\nSource code\nimport tensorflow as tf\n\ngraph = tf.Graph()\n\nwith graph.as_default():\n\n    tf_features = tf.placeholder(\n            tf.float32, [batch_size, max_seq_len, input_dim], \n            name = 'tf_features')\n\n    tf_targets = tf.placeholder(\n            tf.float32, [batch_size, target_len],\n            name = 'tf_targets')\n\n    tf_seq_len = tf.placeholder(\n            tf.int32, [batch_size],\n            name = 'tf_seq_len')\n\n    tf_cell = 'tf.contrib.rnn.'+cell_type+'('+str(num_hidden)+')'\n    tf_cell = eval(tf_cell)\n\n    tf_output, tf_state = tf.nn.dynamic_rnn(\n            tf_cell, tf_features, sequence_length = tf_seq_len, \n            dtype = tf.float32)\n  \n    tf_output = tf_output[:, :, :num_hidden]\n           \n    tf_last = tf.gather_nd(\n            tf_output, \n            tf.stack([tf.range(batch_size), tf_seq_len-1], axis = 1), # batch_size\n            name = 'tf_last')\n\nLogs\n---------------- RUN 0/0\n ---------------- FOLD 0/2\n  ---------------- TRAIN\n  Epoch 0\n  - Optimizing optimize\n   ---------------- BATCH 0/28 [0, 50], len_data = 1499\n   *** tf_weights: -0.563565\n   *** tf_last: -0.192192\n   ---------------- BATCH 1/28 [50, 100], len_data = 1499\n   *** tf_weights: -0.553565\n   *** tf_last: -0.0799878\n   ---------------- BATCH 2/28 [100, 150], len_data = 1499\n   *** tf_weights: -0.546777\n   *** tf_last: -0.118384\n   ---------------- BATCH 3/28 [150, 200], len_data = 1499\n   *** tf_weights: -0.538511\n   *** tf_last: -0.142531\n   ---------------- BATCH 4/28 [200, 250], len_data = 1499\n   *** tf_weights: -0.529593\n   *** tf_last: -0.147268\n   ---------------- BATCH 5/28 [250, 300], len_data = 1499\n   *** tf_weights: -0.520294\n   *** tf_last: -0.014847\n   ---------------- BATCH 6/28 [300, 350], len_data = 1499\n   *** tf_weights: -0.510754\n   *** tf_last: -0.094138\n   ---------------- BATCH 7/28 [350, 400], len_data = 1499\n   *** tf_weights: -0.504503\n   *** Failed to evaluate tf_last\nTraceback (most recent call last):\n\n  File \"<ipython-input-25-49e8720a879a>\", line 1, in <module>\n    runfile('/home/ala/Python/domains/main.py', wdir='/home/ala/Python/domains')\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 710, in runfile\n    execfile(filename, namespace)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 101, in execfile\n    exec(compile(f.read(), filename, 'exec'), namespace)\n\n  File \"/home/ala/Python/domains/main.py\", line 166, in <module>\n    metrics_valid = RNN_object.validate(data_train, KFolds)\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 727, in validate\n    reinitialize = True))\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 366, in train\n    self.optimize(data)\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 1102, in optimize\n    optimized_driving_metric = self.evaluate(data, driving_metric)\n\n  File \"/home/ala/Python/domains/classifiers.py\", line 1796, in evaluate\n    evaluated_tf_var = self.sess.run(eval(tf_var), feed_dict)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 895, in run\n    run_metadata_ptr)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1124, in _run\n    feed_dict_tensor, options, run_metadata)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1321, in _do_run\n    options, run_metadata)\n\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _do_call\n    raise type(e)(node_def, op, message)\n\nInvalidArgumentError: flat indices[8, :] = [8, -1] does not index into param (shape: [50,300,2]).\n\t [[Node: tf_last = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](strided_slice_2, stack)]]\n\nCaused by op 'tf_last', defined at:\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py\", line 245, in <module>\n    main()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py\", line 241, in main\n    kernel.start()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelapp.py\", line 477, in start\n    ioloop.IOLoop.instance().start()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/ioloop.py\", line 177, in start\n    super(ZMQIOLoop, self).start()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/ioloop.py\", line 888, in start\n    handler_func(fd_obj, events)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\n    self._handle_recv()\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\n    callback(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 283, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 235, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 399, in execute_request\n    user_expressions, allow_stdin)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2728, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2856, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2910, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-25-49e8720a879a>\", line 1, in <module>\n    runfile('/home/ala/Python/domains/main.py', wdir='/home/ala/Python/domains')\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 710, in runfile\n    execfile(filename, namespace)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 101, in execfile\n    exec(compile(f.read(), filename, 'exec'), namespace)\n  File \"/home/ala/Python/domains/main.py\", line 109, in <module>\n    RNN_object.define(data_test)\n  File \"/home/ala/Python/domains/classifiers.py\", line 1514, in define\n    name = 'tf_last')\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1338, in gather_nd\n    name=name)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2630, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1204, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): flat indices[8, :] = [8, -1] does not index into param (shape: [50,300,2]).\n\t [[Node: tf_last = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](strided_slice_2, stack)]]", "body": "### System information\r\n\r\n- **OS Platform and Distribution**: Ubuntu 17.10 (Linux-4.13.0-17-generic-x86_64-with-debian-stretch-sid)\r\n- **TensorFlow installed from**: binary\r\n- **TensorFlow version**: v1.3.0-rc2-20-g0787eee 1.3.0 (same on 1.4.0)\r\n- **Python version**: 3.6.3\r\n- **GPU model and memory**: N/A (CPU only)\r\n- **Numpy version:** 1.13.3\r\n- **Bazel version**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **C++ compiler version**: (Ubuntu 7.2.0-8ubuntu3) 7.2.0\r\n- **Have I written custom code**: Yes\r\n- **Exact command to reproduce**: There is no single command. The error arises when trying to fetch a TensorFlow tensor. Please see the description below.\r\n\r\n### Describe the problem\r\n\r\nI am training a recurrent neural network (RNN) whereby I give it variable-length sequences of random steps in two dimensions and train it to recognize the quadrant in which the random walker ended up. This RNN works fine on a Windows machine with GPU (all other specs are otherwise the same as above). However, on a Linux machine with CPU only, I get an error which mysteriously traces back to a dimensionality hiccup with `GatherNd`. \r\n\r\nThe code for the full RNN is too convoluted to post, but as you can see from below, I am printing out the fetches to two tensors `tf_weights` and `tf_last` at each iteration of the batching. (In this case the training data is consumed one batch at a time for a total of 28 batches). The batches are very basic loops so you'd think that if a fetch works in one iteration of the loop it should also work for the next. This is indeed the case for `tf_weights` but not for `tf_last` which, for no apparent reason, fails to evaluate at batch 7/28. `tf_last` can be traced to a `GatherNd` operation.\r\n\r\nI thoroughly inspected the data and it looks fine. _Please keep in mind that my code does work under Windows with GPU with all other specs remaining the same, so it's hard to conceive of a bug from within the code itself._\r\n\r\n### Source code\r\n\r\n```\r\nimport tensorflow as tf\r\n\r\ngraph = tf.Graph()\r\n\r\nwith graph.as_default():\r\n\r\n    tf_features = tf.placeholder(\r\n            tf.float32, [batch_size, max_seq_len, input_dim], \r\n            name = 'tf_features')\r\n\r\n    tf_targets = tf.placeholder(\r\n            tf.float32, [batch_size, target_len],\r\n            name = 'tf_targets')\r\n\r\n    tf_seq_len = tf.placeholder(\r\n            tf.int32, [batch_size],\r\n            name = 'tf_seq_len')\r\n\r\n    tf_cell = 'tf.contrib.rnn.'+cell_type+'('+str(num_hidden)+')'\r\n    tf_cell = eval(tf_cell)\r\n\r\n    tf_output, tf_state = tf.nn.dynamic_rnn(\r\n            tf_cell, tf_features, sequence_length = tf_seq_len, \r\n            dtype = tf.float32)\r\n  \r\n    tf_output = tf_output[:, :, :num_hidden]\r\n           \r\n    tf_last = tf.gather_nd(\r\n            tf_output, \r\n            tf.stack([tf.range(batch_size), tf_seq_len-1], axis = 1), # batch_size\r\n            name = 'tf_last')\r\n```\r\n\r\n### Logs\r\n\r\n```\r\n---------------- RUN 0/0\r\n ---------------- FOLD 0/2\r\n  ---------------- TRAIN\r\n  Epoch 0\r\n  - Optimizing optimize\r\n   ---------------- BATCH 0/28 [0, 50], len_data = 1499\r\n   *** tf_weights: -0.563565\r\n   *** tf_last: -0.192192\r\n   ---------------- BATCH 1/28 [50, 100], len_data = 1499\r\n   *** tf_weights: -0.553565\r\n   *** tf_last: -0.0799878\r\n   ---------------- BATCH 2/28 [100, 150], len_data = 1499\r\n   *** tf_weights: -0.546777\r\n   *** tf_last: -0.118384\r\n   ---------------- BATCH 3/28 [150, 200], len_data = 1499\r\n   *** tf_weights: -0.538511\r\n   *** tf_last: -0.142531\r\n   ---------------- BATCH 4/28 [200, 250], len_data = 1499\r\n   *** tf_weights: -0.529593\r\n   *** tf_last: -0.147268\r\n   ---------------- BATCH 5/28 [250, 300], len_data = 1499\r\n   *** tf_weights: -0.520294\r\n   *** tf_last: -0.014847\r\n   ---------------- BATCH 6/28 [300, 350], len_data = 1499\r\n   *** tf_weights: -0.510754\r\n   *** tf_last: -0.094138\r\n   ---------------- BATCH 7/28 [350, 400], len_data = 1499\r\n   *** tf_weights: -0.504503\r\n   *** Failed to evaluate tf_last\r\nTraceback (most recent call last):\r\n\r\n  File \"<ipython-input-25-49e8720a879a>\", line 1, in <module>\r\n    runfile('/home/ala/Python/domains/main.py', wdir='/home/ala/Python/domains')\r\n\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 710, in runfile\r\n    execfile(filename, namespace)\r\n\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 101, in execfile\r\n    exec(compile(f.read(), filename, 'exec'), namespace)\r\n\r\n  File \"/home/ala/Python/domains/main.py\", line 166, in <module>\r\n    metrics_valid = RNN_object.validate(data_train, KFolds)\r\n\r\n  File \"/home/ala/Python/domains/classifiers.py\", line 727, in validate\r\n    reinitialize = True))\r\n\r\n  File \"/home/ala/Python/domains/classifiers.py\", line 366, in train\r\n    self.optimize(data)\r\n\r\n  File \"/home/ala/Python/domains/classifiers.py\", line 1102, in optimize\r\n    optimized_driving_metric = self.evaluate(data, driving_metric)\r\n\r\n  File \"/home/ala/Python/domains/classifiers.py\", line 1796, in evaluate\r\n    evaluated_tf_var = self.sess.run(eval(tf_var), feed_dict)\r\n\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 895, in run\r\n    run_metadata_ptr)\r\n\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1124, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1321, in _do_run\r\n    options, run_metadata)\r\n\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _do_call\r\n    raise type(e)(node_def, op, message)\r\n\r\nInvalidArgumentError: flat indices[8, :] = [8, -1] does not index into param (shape: [50,300,2]).\r\n\t [[Node: tf_last = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](strided_slice_2, stack)]]\r\n\r\nCaused by op 'tf_last', defined at:\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py\", line 245, in <module>\r\n    main()\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py\", line 241, in main\r\n    kernel.start()\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelapp.py\", line 477, in start\r\n    ioloop.IOLoop.instance().start()\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/ioloop.py\", line 177, in start\r\n    super(ZMQIOLoop, self).start()\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/ioloop.py\", line 888, in start\r\n    handler_func(fd_obj, events)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\r\n    self._handle_recv()\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\r\n    self._run_callback(callback, msg)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\r\n    callback(*args, **kwargs)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py\", line 277, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 283, in dispatcher\r\n    return self.dispatch_shell(stream, msg)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 235, in dispatch_shell\r\n    handler(stream, idents, msg)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py\", line 399, in execute_request\r\n    user_expressions, allow_stdin)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\r\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/ipykernel/zmqshell.py\", line 533, in run_cell\r\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2728, in run_cell\r\n    interactivity=interactivity, compiler=compiler, result=result)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2856, in run_ast_nodes\r\n    if self.run_code(code, result):\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2910, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-25-49e8720a879a>\", line 1, in <module>\r\n    runfile('/home/ala/Python/domains/main.py', wdir='/home/ala/Python/domains')\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 710, in runfile\r\n    execfile(filename, namespace)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py\", line 101, in execfile\r\n    exec(compile(f.read(), filename, 'exec'), namespace)\r\n  File \"/home/ala/Python/domains/main.py\", line 109, in <module>\r\n    RNN_object.define(data_test)\r\n  File \"/home/ala/Python/domains/classifiers.py\", line 1514, in define\r\n    name = 'tf_last')\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 1338, in gather_nd\r\n    name=name)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\r\n    op_def=op_def)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2630, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/home/ala/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1204, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): flat indices[8, :] = [8, -1] does not index into param (shape: [50,300,2]).\r\n\t [[Node: tf_last = GatherNd[Tindices=DT_INT32, Tparams=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](strided_slice_2, stack)]]\r\n```"}