{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14000", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14000/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14000/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14000/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/14000", "id": 268801178, "node_id": "MDU6SXNzdWUyNjg4MDExNzg=", "number": 14000, "title": "Model trained on GPU does not restore properly when ran on CPU", "user": {"login": "183amir", "id": 5738695, "node_id": "MDQ6VXNlcjU3Mzg2OTU=", "avatar_url": "https://avatars2.githubusercontent.com/u/5738695?v=4", "gravatar_id": "", "url": "https://api.github.com/users/183amir", "html_url": "https://github.com/183amir", "followers_url": "https://api.github.com/users/183amir/followers", "following_url": "https://api.github.com/users/183amir/following{/other_user}", "gists_url": "https://api.github.com/users/183amir/gists{/gist_id}", "starred_url": "https://api.github.com/users/183amir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/183amir/subscriptions", "organizations_url": "https://api.github.com/users/183amir/orgs", "repos_url": "https://api.github.com/users/183amir/repos", "events_url": "https://api.github.com/users/183amir/events{/privacy}", "received_events_url": "https://api.github.com/users/183amir/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "nealwu", "id": 726075, "node_id": "MDQ6VXNlcjcyNjA3NQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/726075?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nealwu", "html_url": "https://github.com/nealwu", "followers_url": "https://api.github.com/users/nealwu/followers", "following_url": "https://api.github.com/users/nealwu/following{/other_user}", "gists_url": "https://api.github.com/users/nealwu/gists{/gist_id}", "starred_url": "https://api.github.com/users/nealwu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nealwu/subscriptions", "organizations_url": "https://api.github.com/users/nealwu/orgs", "repos_url": "https://api.github.com/users/nealwu/repos", "events_url": "https://api.github.com/users/nealwu/events{/privacy}", "received_events_url": "https://api.github.com/users/nealwu/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nealwu", "id": 726075, "node_id": "MDQ6VXNlcjcyNjA3NQ==", "avatar_url": "https://avatars3.githubusercontent.com/u/726075?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nealwu", "html_url": "https://github.com/nealwu", "followers_url": "https://api.github.com/users/nealwu/followers", "following_url": "https://api.github.com/users/nealwu/following{/other_user}", "gists_url": "https://api.github.com/users/nealwu/gists{/gist_id}", "starred_url": "https://api.github.com/users/nealwu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nealwu/subscriptions", "organizations_url": "https://api.github.com/users/nealwu/orgs", "repos_url": "https://api.github.com/users/nealwu/repos", "events_url": "https://api.github.com/users/nealwu/events{/privacy}", "received_events_url": "https://api.github.com/users/nealwu/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 8, "created_at": "2017-10-26T15:14:11Z", "updated_at": "2018-03-30T05:46:11Z", "closed_at": "2017-12-01T23:42:03Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nno</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:</li>\n</ul>\n<pre><code>== cat /etc/issue ===============================================\nLinux  3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u5 (2017-09-19) x86_64 GNU/Linux\nVERSION_ID=\"8\"\nVERSION=\"8 (jessie)\"\n\n== are we in docker =============================================\nNo\n\n== compiler =====================================================\nc++ (GCC) 4.8.5\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n\n\n== uname -a =====================================================\nLinux  3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u5 (2017-09-19) x86_64 GNU/Linux\n\n== check pips ===================================================\nnumpy (1.12.1)\nprotobuf (3.4.0)\ntensorflow (1.3.0)\ntensorflow-gpu (1.4.0rc0)\ntensorflow-tensorboard (0.1.5)\n\n== check for virtualenv =========================================\nTrue\n\n== tensorflow import ============================================\ntf.VERSION = 1.4.0-rc0\ntf.GIT_VERSION = v1.3.0-rc1-3112-g65b6a75\ntf.COMPILER_VERSION = v1.3.0-rc1-3112-g65b6a75\nSanity check: array([1], dtype=int32)\n\n== env ==========================================================\nLD_LIBRARY_PATH /cuda/cuda-8.0/lib64:/cuda/cudnn-8.0-linux-x64-v6.0/lib64\nDYLD_LIBRARY_PATH is unset\n\n== nvidia-smi ===================================================\nThu Oct 26 16:47:55 2017\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 375.26                 Driver Version: 375.26                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GT 610      Off  | 0000:01:00.0     N/A |                  N/A |\n| N/A   42C    P0    N/A /  N/A |      0MiB /   963MiB |     N/A      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|    0                  Not Supported                                         |\n+-----------------------------------------------------------------------------+\n\n== cuda libs  ===================================================\n</code></pre>\n<ul>\n<li>\n<p><strong>TensorFlow installed from (source or binary)</strong>:<br>\nInstalled binary with pip.</p>\n</li>\n<li>\n<p><strong>TensorFlow version (use command below)</strong>:<br>\n('v1.3.0-rc1-3112-g65b6a75', '1.4.0-rc0')<br>\nThe same bug happens on Tensorflow 1.3.0 too.</p>\n</li>\n<li>\n<p><strong>Python version</strong>:<br>\n2.7</p>\n</li>\n<li>\n<p><strong>CUDA/cuDNN version</strong>:<br>\nCUDA 8.0<br>\ncuDNN 6.0</p>\n</li>\n<li>\n<p><strong>GPU model and memory</strong>:<br>\nI am testing on two different computers. On one PC I have this GPU:<br>\nname: GeForce GTX TITAN Black major: 3 minor: 5 memoryClockRate(GHz): 0.98<br>\npciBusID: 0000:02:00.0<br>\ntotalMemory: 5.94GiB freeMemory: 5.87GiB<br>\nOn my PC I do not have a GPU.</p>\n</li>\n<li>\n<p><strong>Exact command to reproduce</strong>:</p>\n</li>\n</ul>\n<p>This (latest now) checkout of tensorflow models:<br>\n<a href=\"https://github.com/tensorflow/models/tree/edcd29f2dbb4b3eaed387fe17cb5270f867aec42/official/mnist\">https://github.com/tensorflow/models/tree/edcd29f2dbb4b3eaed387fe17cb5270f867aec42/official/mnist</a></p>\n<div class=\"highlight highlight-source-shell\"><pre>$ python convert_to_records.py --directory <span class=\"pl-k\">~</span>/tmp/mnist_data\nSuccessfully downloaded train-images-idx3-ubyte.gz 9912422 bytes.\nExtracting /home/amir/tmp/mnist_data/train-images-idx3-ubyte.gz\nSuccessfully downloaded train-labels-idx1-ubyte.gz 28881 bytes.\nExtracting /home/amir/tmp/mnist_data/train-labels-idx1-ubyte.gz\nSuccessfully downloaded t10k-images-idx3-ubyte.gz 1648877 bytes.\nExtracting /home/amir/tmp/mnist_data/t10k-images-idx3-ubyte.gz\nSuccessfully downloaded t10k-labels-idx1-ubyte.gz 4542 bytes.\nExtracting /home/amir/tmp/mnist_data/t10k-labels-idx1-ubyte.gz\nWriting /home/amir/tmp/mnist_data/train.tfrecords\nWriting /home/amir/tmp/mnist_data/validation.tfrecords\nWriting /home/amir/tmp/mnist_data/test.tfrecords\n$ python mnist.py --data_dir <span class=\"pl-k\">~</span>/tmp/mnist_data --model_dir <span class=\"pl-k\">~</span>/tmp/mnist_model --steps 2000\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {<span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_secs<span class=\"pl-pds\">'</span></span>: 600, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_session_config<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_max<span class=\"pl-pds\">'</span></span>: 5, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_type<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>worker<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_is_chief<span class=\"pl-pds\">'</span></span>: True, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_clu</span>\n<span class=\"pl-s\">ster_spec<span class=\"pl-pds\">'</span></span>: <span class=\"pl-k\">&lt;</span>tensorflow.python.training.server_lib.ClusterSpec object at 0x7ff6e918d<span class=\"pl-k\">910&gt;</span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_steps<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_every_n_hours<span class=\"pl-pds\">'</span></span>: 10000\n, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_service<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_ps_replicas<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_tf_random_seed<span class=\"pl-pds\">'</span></span>: 1, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_master<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_worker_replicas<span class=\"pl-pds\">'</span></span>: 1, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_id<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_log_step_count_steps<span class=\"pl-pds\">'</span></span>: 100, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_model_di</span>\n<span class=\"pl-s\">r<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>/home/amir/tmp/mnist_model<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_summary_steps<span class=\"pl-pds\">'</span></span>: 100}\nWARNING:tensorflow:From mnist.py:84: __init__ (from tensorflow.contrib.data.python.ops.readers) is deprecated and will be removed <span class=\"pl-k\">in</span> a future version.\nInstructions <span class=\"pl-k\">for</span> updating:\nUse <span class=\"pl-s\"><span class=\"pl-pds\">`</span>tf.data.TFRecordDataset<span class=\"pl-pds\">`</span></span>.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with num_threads is deprecated and will be removed <span class=\"pl-k\">in</span> a fut\nure version.\nInstructions <span class=\"pl-k\">for</span> updating:\nReplace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_threads=T<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_parallel_calls=T<span class=\"pl-pds\">`</span></span>. Replace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>output_buffer_size=N<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>ds.prefetch(N)<span class=\"pl-pds\">`</span></span> on the returned dataset.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with output_buffer_size is deprecated and will be removed i\nn a future version.\nInstructions <span class=\"pl-k\">for</span> updating:\nReplace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_threads=T<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_parallel_calls=T<span class=\"pl-pds\">`</span></span>. Replace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>output_buffer_size=N<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>ds.prefetch(N)<span class=\"pl-pds\">`</span></span> on the returned dataset.\nINFO:tensorflow:Create CheckpointSaverHook.\n2017-10-26 15:52:17.067286: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to us\ne: SSE4.1 SSE4.2 AVX\n2017-10-26 15:52:18.075205: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:892] successful NUMA node <span class=\"pl-c1\">read</span> from SysFS had negative value (-1), but there mu\nst be at least one NUMA node, so returning NUMA node zero\n2017-10-26 15:52:18.075593: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 0 with properties:\nname: GeForce GTX TITAN Black major: 3 minor: 5 memoryClockRate(GHz): 0.98\npciBusID: 0000:02:00.0\ntotalMemory: 5.94GiB freeMemory: 5.87GiB\n2017-10-26 15:52:18.075610: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -<span class=\"pl-k\">&gt;</span> (device: 0, name: GeForce GTX T\nITAN Black, pci bus id: 0000:02:00.0, compute capability: 3.5)\nINFO:tensorflow:Saving checkpoints <span class=\"pl-k\">for</span> 1 into /home/amir/tmp/mnist_model/model.ckpt.\nINFO:tensorflow:train_accuracy = 0.13\nINFO:tensorflow:loss = 2.28967, step = 1\nINFO:tensorflow:global_step/sec: 86.9528\nINFO:tensorflow:train_accuracy = 0.485 (1.150 sec)\nINFO:tensorflow:loss = 0.519769, step = 101 (1.150 sec)\nINFO:tensorflow:global_step/sec: 91.0098\nINFO:tensorflow:train_accuracy = 0.61 (1.099 sec)\nINFO:tensorflow:loss = 0.464828, step = 201 (1.099 sec)\nINFO:tensorflow:global_step/sec: 95.5818\nINFO:tensorflow:train_accuracy = 0.6825 (1.046 sec)\nINFO:tensorflow:loss = 0.299279, step = 301 (1.046 sec)\n...\nEvaluation results:\n    {<span class=\"pl-s\"><span class=\"pl-pds\">'</span>loss<span class=\"pl-pds\">'</span></span>: 0.027056012, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>global_step<span class=\"pl-pds\">'</span></span>: 20000, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>accuracy<span class=\"pl-pds\">'</span></span>: 0.99309999}\n$ <span class=\"pl-c\"><span class=\"pl-c\">#</span> comment out the .train line (lines 232-235) in mnist.py</span>\n$ <span class=\"pl-c\"><span class=\"pl-c\">#</span> somehow disable GPU</span>\n$ python mnist.py --data_dir <span class=\"pl-k\">~</span>/tmp/mnist_data --model_dir <span class=\"pl-k\">~</span>/tmp/mnist_model --steps 2000 --data_format channels_last\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {<span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_secs<span class=\"pl-pds\">'</span></span>: 600, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_session_config<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_max<span class=\"pl-pds\">'</span></span>: 5, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_type<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>worker<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_is_chief<span class=\"pl-pds\">'</span></span>: True, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_clu</span>\n<span class=\"pl-s\">ster_spec<span class=\"pl-pds\">'</span></span>: <span class=\"pl-k\">&lt;</span>tensorflow.python.training.server_lib.ClusterSpec object at 0x7f4a9afcfd<span class=\"pl-k\">10&gt;</span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_checkpoints_steps<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_keep_checkpoint_every_n_hours<span class=\"pl-pds\">'</span></span>: 10000\n, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_service<span class=\"pl-pds\">'</span></span>: None, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_ps_replicas<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_tf_random_seed<span class=\"pl-pds\">'</span></span>: 1, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_master<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_num_worker_replicas<span class=\"pl-pds\">'</span></span>: 1, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_task_id<span class=\"pl-pds\">'</span></span>: 0, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_log_step_count_steps<span class=\"pl-pds\">'</span></span>: 100, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_model_di</span>\n<span class=\"pl-s\">r<span class=\"pl-pds\">'</span></span>: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>/home/amir/tmp/mnist_model<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>_save_summary_steps<span class=\"pl-pds\">'</span></span>: 100}\nWARNING:tensorflow:From mnist.py:84: __init__ (from tensorflow.contrib.data.python.ops.readers) is deprecated and will be removed <span class=\"pl-k\">in</span> a future version.\nInstructions <span class=\"pl-k\">for</span> updating:\nUse <span class=\"pl-s\"><span class=\"pl-pds\">`</span>tf.data.TFRecordDataset<span class=\"pl-pds\">`</span></span>.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with num_threads is deprecated and will be removed <span class=\"pl-k\">in</span> a fut\nure version.\nInstructions <span class=\"pl-k\">for</span> updating:\nReplace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_threads=T<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_parallel_calls=T<span class=\"pl-pds\">`</span></span>. Replace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>output_buffer_size=N<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>ds.prefetch(N)<span class=\"pl-pds\">`</span></span> on the returned dataset.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with output_buffer_size is deprecated and will be removed i\nn a future version.\nInstructions <span class=\"pl-k\">for</span> updating:\nReplace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_threads=T<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>num_parallel_calls=T<span class=\"pl-pds\">`</span></span>. Replace <span class=\"pl-s\"><span class=\"pl-pds\">`</span>output_buffer_size=N<span class=\"pl-pds\">`</span></span> with <span class=\"pl-s\"><span class=\"pl-pds\">`</span>ds.prefetch(N)<span class=\"pl-pds\">`</span></span> on the returned dataset.\nINFO:tensorflow:Starting evaluation at 2017-10-26-14:33:53\n2017-10-26 16:33:53.385155: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to us\ne: SSE4.1 SSE4.2 AVX AVX2 FMA\n2017-10-26 16:33:53.907636: E tensorflow/stream_executor/cuda/cuda_driver.cc:406] failed call to cuInit: CUDA_ERROR_NO_DEVICE\n2017-10-26 16:33:53.907712: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:158] retrieving CUDA diagnostic information <span class=\"pl-k\">for</span> host: italix14\n2017-10-26 16:33:53.907722: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:165] hostname: italix14\n2017-10-26 16:33:53.907800: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:189] libcuda reported version is: Invalid argument: expected %d.%d or %d.%d.%d f\norm <span class=\"pl-k\">for</span> driver version<span class=\"pl-k\">;</span> got <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>1<span class=\"pl-pds\">\"</span></span>\n2017-10-26 16:33:53.907837: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:369] driver version file contents: <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span>NVRM version: NVIDIA UNIX x86_64 Kernel Mo</span>\n<span class=\"pl-s\">dule  375.26  Thu Dec  8 18:36:43 PST 2016</span>\n<span class=\"pl-s\">GCC version:  gcc version 4.8.4 (Debian 4.8.4-1)</span>\n<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>\n2017-10-26 16:33:53.907871: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:193] kernel reported version is: 375.26.0\nINFO:tensorflow:Restoring parameters from /home/amir/tmp/mnist_model/model.ckpt-20000\nINFO:tensorflow:Finished evaluation at 2017-10-26-14:34:20\nINFO:tensorflow:Saving dict <span class=\"pl-k\">for</span> global step 20000: accuracy = 0.0962, global_step = 20000, loss = 6.32954\n\nEvaluation results:\n    {<span class=\"pl-s\"><span class=\"pl-pds\">'</span>loss<span class=\"pl-pds\">'</span></span>: 6.3295369, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>global_step<span class=\"pl-pds\">'</span></span>: 20000, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>accuracy<span class=\"pl-pds\">'</span></span>: 0.096199997}</pre></div>\n<h3>Describe the problem</h3>\n<p>I have trained the official mnist model on GPU (<code>channels_first</code>,  <code>NCHW</code>) but when I test it on CPU (<code>channels_last</code>,  <code>NHWC</code>) I get different results. On GPU, I get an accuracy of <code>0.99309999</code> but the same model (when tested on CPU) gives <code>0.096199997</code>. I believe when the model is restored from the checkpoint the kernel weights are not restored properly to accommodate for the new channel format.</p>\n<p>The problem I have shown here is using the official mnist model but in reality I have a model that I have already trained using the <code>channels_first</code> format on GPU which took several days to train. But, now I cannot evaluate this model on CPU.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nno\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\n\n== cat /etc/issue ===============================================\nLinux  3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u5 (2017-09-19) x86_64 GNU/Linux\nVERSION_ID=\"8\"\nVERSION=\"8 (jessie)\"\n\n== are we in docker =============================================\nNo\n\n== compiler =====================================================\nc++ (GCC) 4.8.5\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n\n\n== uname -a =====================================================\nLinux  3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u5 (2017-09-19) x86_64 GNU/Linux\n\n== check pips ===================================================\nnumpy (1.12.1)\nprotobuf (3.4.0)\ntensorflow (1.3.0)\ntensorflow-gpu (1.4.0rc0)\ntensorflow-tensorboard (0.1.5)\n\n== check for virtualenv =========================================\nTrue\n\n== tensorflow import ============================================\ntf.VERSION = 1.4.0-rc0\ntf.GIT_VERSION = v1.3.0-rc1-3112-g65b6a75\ntf.COMPILER_VERSION = v1.3.0-rc1-3112-g65b6a75\nSanity check: array([1], dtype=int32)\n\n== env ==========================================================\nLD_LIBRARY_PATH /cuda/cuda-8.0/lib64:/cuda/cudnn-8.0-linux-x64-v6.0/lib64\nDYLD_LIBRARY_PATH is unset\n\n== nvidia-smi ===================================================\nThu Oct 26 16:47:55 2017\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 375.26                 Driver Version: 375.26                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GT 610      Off  | 0000:01:00.0     N/A |                  N/A |\n| N/A   42C    P0    N/A /  N/A |      0MiB /   963MiB |     N/A      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|    0                  Not Supported                                         |\n+-----------------------------------------------------------------------------+\n\n== cuda libs  ===================================================\n\n\n\nTensorFlow installed from (source or binary):\nInstalled binary with pip.\n\n\nTensorFlow version (use command below):\n('v1.3.0-rc1-3112-g65b6a75', '1.4.0-rc0')\nThe same bug happens on Tensorflow 1.3.0 too.\n\n\nPython version:\n2.7\n\n\nCUDA/cuDNN version:\nCUDA 8.0\ncuDNN 6.0\n\n\nGPU model and memory:\nI am testing on two different computers. On one PC I have this GPU:\nname: GeForce GTX TITAN Black major: 3 minor: 5 memoryClockRate(GHz): 0.98\npciBusID: 0000:02:00.0\ntotalMemory: 5.94GiB freeMemory: 5.87GiB\nOn my PC I do not have a GPU.\n\n\nExact command to reproduce:\n\n\nThis (latest now) checkout of tensorflow models:\nhttps://github.com/tensorflow/models/tree/edcd29f2dbb4b3eaed387fe17cb5270f867aec42/official/mnist\n$ python convert_to_records.py --directory ~/tmp/mnist_data\nSuccessfully downloaded train-images-idx3-ubyte.gz 9912422 bytes.\nExtracting /home/amir/tmp/mnist_data/train-images-idx3-ubyte.gz\nSuccessfully downloaded train-labels-idx1-ubyte.gz 28881 bytes.\nExtracting /home/amir/tmp/mnist_data/train-labels-idx1-ubyte.gz\nSuccessfully downloaded t10k-images-idx3-ubyte.gz 1648877 bytes.\nExtracting /home/amir/tmp/mnist_data/t10k-images-idx3-ubyte.gz\nSuccessfully downloaded t10k-labels-idx1-ubyte.gz 4542 bytes.\nExtracting /home/amir/tmp/mnist_data/t10k-labels-idx1-ubyte.gz\nWriting /home/amir/tmp/mnist_data/train.tfrecords\nWriting /home/amir/tmp/mnist_data/validation.tfrecords\nWriting /home/amir/tmp/mnist_data/test.tfrecords\n$ python mnist.py --data_dir ~/tmp/mnist_data --model_dir ~/tmp/mnist_model --steps 2000\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_is_chief': True, '_clu\nster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7ff6e918d910>, '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000\n, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': 1, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_di\nr': '/home/amir/tmp/mnist_model', '_save_summary_steps': 100}\nWARNING:tensorflow:From mnist.py:84: __init__ (from tensorflow.contrib.data.python.ops.readers) is deprecated and will be removed in a future version.\nInstructions for updating:\nUse `tf.data.TFRecordDataset`.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with num_threads is deprecated and will be removed in a fut\nure version.\nInstructions for updating:\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with output_buffer_size is deprecated and will be removed i\nn a future version.\nInstructions for updating:\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\nINFO:tensorflow:Create CheckpointSaverHook.\n2017-10-26 15:52:17.067286: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to us\ne: SSE4.1 SSE4.2 AVX\n2017-10-26 15:52:18.075205: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:892] successful NUMA node read from SysFS had negative value (-1), but there mu\nst be at least one NUMA node, so returning NUMA node zero\n2017-10-26 15:52:18.075593: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 0 with properties:\nname: GeForce GTX TITAN Black major: 3 minor: 5 memoryClockRate(GHz): 0.98\npciBusID: 0000:02:00.0\ntotalMemory: 5.94GiB freeMemory: 5.87GiB\n2017-10-26 15:52:18.075610: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -> (device: 0, name: GeForce GTX T\nITAN Black, pci bus id: 0000:02:00.0, compute capability: 3.5)\nINFO:tensorflow:Saving checkpoints for 1 into /home/amir/tmp/mnist_model/model.ckpt.\nINFO:tensorflow:train_accuracy = 0.13\nINFO:tensorflow:loss = 2.28967, step = 1\nINFO:tensorflow:global_step/sec: 86.9528\nINFO:tensorflow:train_accuracy = 0.485 (1.150 sec)\nINFO:tensorflow:loss = 0.519769, step = 101 (1.150 sec)\nINFO:tensorflow:global_step/sec: 91.0098\nINFO:tensorflow:train_accuracy = 0.61 (1.099 sec)\nINFO:tensorflow:loss = 0.464828, step = 201 (1.099 sec)\nINFO:tensorflow:global_step/sec: 95.5818\nINFO:tensorflow:train_accuracy = 0.6825 (1.046 sec)\nINFO:tensorflow:loss = 0.299279, step = 301 (1.046 sec)\n...\nEvaluation results:\n    {'loss': 0.027056012, 'global_step': 20000, 'accuracy': 0.99309999}\n$ # comment out the .train line (lines 232-235) in mnist.py\n$ # somehow disable GPU\n$ python mnist.py --data_dir ~/tmp/mnist_data --model_dir ~/tmp/mnist_model --steps 2000 --data_format channels_last\nINFO:tensorflow:Using default config.\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_is_chief': True, '_clu\nster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f4a9afcfd10>, '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000\n, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': 1, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_di\nr': '/home/amir/tmp/mnist_model', '_save_summary_steps': 100}\nWARNING:tensorflow:From mnist.py:84: __init__ (from tensorflow.contrib.data.python.ops.readers) is deprecated and will be removed in a future version.\nInstructions for updating:\nUse `tf.data.TFRecordDataset`.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with num_threads is deprecated and will be removed in a fut\nure version.\nInstructions for updating:\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with output_buffer_size is deprecated and will be removed i\nn a future version.\nInstructions for updating:\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\nINFO:tensorflow:Starting evaluation at 2017-10-26-14:33:53\n2017-10-26 16:33:53.385155: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to us\ne: SSE4.1 SSE4.2 AVX AVX2 FMA\n2017-10-26 16:33:53.907636: E tensorflow/stream_executor/cuda/cuda_driver.cc:406] failed call to cuInit: CUDA_ERROR_NO_DEVICE\n2017-10-26 16:33:53.907712: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:158] retrieving CUDA diagnostic information for host: italix14\n2017-10-26 16:33:53.907722: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:165] hostname: italix14\n2017-10-26 16:33:53.907800: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:189] libcuda reported version is: Invalid argument: expected %d.%d or %d.%d.%d f\norm for driver version; got \"1\"\n2017-10-26 16:33:53.907837: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:369] driver version file contents: \"\"\"NVRM version: NVIDIA UNIX x86_64 Kernel Mo\ndule  375.26  Thu Dec  8 18:36:43 PST 2016\nGCC version:  gcc version 4.8.4 (Debian 4.8.4-1)\n\"\"\"\n2017-10-26 16:33:53.907871: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:193] kernel reported version is: 375.26.0\nINFO:tensorflow:Restoring parameters from /home/amir/tmp/mnist_model/model.ckpt-20000\nINFO:tensorflow:Finished evaluation at 2017-10-26-14:34:20\nINFO:tensorflow:Saving dict for global step 20000: accuracy = 0.0962, global_step = 20000, loss = 6.32954\n\nEvaluation results:\n    {'loss': 6.3295369, 'global_step': 20000, 'accuracy': 0.096199997}\nDescribe the problem\nI have trained the official mnist model on GPU (channels_first,  NCHW) but when I test it on CPU (channels_last,  NHWC) I get different results. On GPU, I get an accuracy of 0.99309999 but the same model (when tested on CPU) gives 0.096199997. I believe when the model is restored from the checkpoint the kernel weights are not restored properly to accommodate for the new channel format.\nThe problem I have shown here is using the official mnist model but in reality I have a model that I have already trained using the channels_first format on GPU which took several days to train. But, now I cannot evaluate this model on CPU.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nno\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\n```\r\n== cat /etc/issue ===============================================\r\nLinux  3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u5 (2017-09-19) x86_64 GNU/Linux\r\nVERSION_ID=\"8\"\r\nVERSION=\"8 (jessie)\"\r\n\r\n== are we in docker =============================================\r\nNo\r\n\r\n== compiler =====================================================\r\nc++ (GCC) 4.8.5\r\nCopyright (C) 2015 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n\r\n\r\n== uname -a =====================================================\r\nLinux  3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u5 (2017-09-19) x86_64 GNU/Linux\r\n\r\n== check pips ===================================================\r\nnumpy (1.12.1)\r\nprotobuf (3.4.0)\r\ntensorflow (1.3.0)\r\ntensorflow-gpu (1.4.0rc0)\r\ntensorflow-tensorboard (0.1.5)\r\n\r\n== check for virtualenv =========================================\r\nTrue\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 1.4.0-rc0\r\ntf.GIT_VERSION = v1.3.0-rc1-3112-g65b6a75\r\ntf.COMPILER_VERSION = v1.3.0-rc1-3112-g65b6a75\r\nSanity check: array([1], dtype=int32)\r\n\r\n== env ==========================================================\r\nLD_LIBRARY_PATH /cuda/cuda-8.0/lib64:/cuda/cudnn-8.0-linux-x64-v6.0/lib64\r\nDYLD_LIBRARY_PATH is unset\r\n\r\n== nvidia-smi ===================================================\r\nThu Oct 26 16:47:55 2017\r\n+-----------------------------------------------------------------------------+\r\n| NVIDIA-SMI 375.26                 Driver Version: 375.26                    |\r\n|-------------------------------+----------------------+----------------------+\r\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\r\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\r\n|===============================+======================+======================|\r\n|   0  GeForce GT 610      Off  | 0000:01:00.0     N/A |                  N/A |\r\n| N/A   42C    P0    N/A /  N/A |      0MiB /   963MiB |     N/A      Default |\r\n+-------------------------------+----------------------+----------------------+\r\n\r\n+-----------------------------------------------------------------------------+\r\n| Processes:                                                       GPU Memory |\r\n|  GPU       PID  Type  Process name                               Usage      |\r\n|=============================================================================|\r\n|    0                  Not Supported                                         |\r\n+-----------------------------------------------------------------------------+\r\n\r\n== cuda libs  ===================================================\r\n```\r\n- **TensorFlow installed from (source or binary)**:\r\nInstalled binary with pip.\r\n- **TensorFlow version (use command below)**:\r\n('v1.3.0-rc1-3112-g65b6a75', '1.4.0-rc0')\r\nThe same bug happens on Tensorflow 1.3.0 too.\r\n- **Python version**: \r\n2.7\r\n- **CUDA/cuDNN version**:\r\nCUDA 8.0\r\ncuDNN 6.0\r\n- **GPU model and memory**:\r\nI am testing on two different computers. On one PC I have this GPU:\r\nname: GeForce GTX TITAN Black major: 3 minor: 5 memoryClockRate(GHz): 0.98\r\npciBusID: 0000:02:00.0\r\ntotalMemory: 5.94GiB freeMemory: 5.87GiB\r\nOn my PC I do not have a GPU.\r\n\r\n- **Exact command to reproduce**:\r\n\r\nThis (latest now) checkout of tensorflow models:\r\nhttps://github.com/tensorflow/models/tree/edcd29f2dbb4b3eaed387fe17cb5270f867aec42/official/mnist\r\n\r\n```sh\r\n$ python convert_to_records.py --directory ~/tmp/mnist_data\r\nSuccessfully downloaded train-images-idx3-ubyte.gz 9912422 bytes.\r\nExtracting /home/amir/tmp/mnist_data/train-images-idx3-ubyte.gz\r\nSuccessfully downloaded train-labels-idx1-ubyte.gz 28881 bytes.\r\nExtracting /home/amir/tmp/mnist_data/train-labels-idx1-ubyte.gz\r\nSuccessfully downloaded t10k-images-idx3-ubyte.gz 1648877 bytes.\r\nExtracting /home/amir/tmp/mnist_data/t10k-images-idx3-ubyte.gz\r\nSuccessfully downloaded t10k-labels-idx1-ubyte.gz 4542 bytes.\r\nExtracting /home/amir/tmp/mnist_data/t10k-labels-idx1-ubyte.gz\r\nWriting /home/amir/tmp/mnist_data/train.tfrecords\r\nWriting /home/amir/tmp/mnist_data/validation.tfrecords\r\nWriting /home/amir/tmp/mnist_data/test.tfrecords\r\n$ python mnist.py --data_dir ~/tmp/mnist_data --model_dir ~/tmp/mnist_model --steps 2000\r\nINFO:tensorflow:Using default config.\r\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_is_chief': True, '_clu\r\nster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7ff6e918d910>, '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000\r\n, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': 1, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_di\r\nr': '/home/amir/tmp/mnist_model', '_save_summary_steps': 100}\r\nWARNING:tensorflow:From mnist.py:84: __init__ (from tensorflow.contrib.data.python.ops.readers) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nUse `tf.data.TFRecordDataset`.\r\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with num_threads is deprecated and will be removed in a fut\r\nure version.\r\nInstructions for updating:\r\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\r\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with output_buffer_size is deprecated and will be removed i\r\nn a future version.\r\nInstructions for updating:\r\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\r\nINFO:tensorflow:Create CheckpointSaverHook.\r\n2017-10-26 15:52:17.067286: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to us\r\ne: SSE4.1 SSE4.2 AVX\r\n2017-10-26 15:52:18.075205: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:892] successful NUMA node read from SysFS had negative value (-1), but there mu\r\nst be at least one NUMA node, so returning NUMA node zero\r\n2017-10-26 15:52:18.075593: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1030] Found device 0 with properties:\r\nname: GeForce GTX TITAN Black major: 3 minor: 5 memoryClockRate(GHz): 0.98\r\npciBusID: 0000:02:00.0\r\ntotalMemory: 5.94GiB freeMemory: 5.87GiB\r\n2017-10-26 15:52:18.075610: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1120] Creating TensorFlow device (/device:GPU:0) -> (device: 0, name: GeForce GTX T\r\nITAN Black, pci bus id: 0000:02:00.0, compute capability: 3.5)\r\nINFO:tensorflow:Saving checkpoints for 1 into /home/amir/tmp/mnist_model/model.ckpt.\r\nINFO:tensorflow:train_accuracy = 0.13\r\nINFO:tensorflow:loss = 2.28967, step = 1\r\nINFO:tensorflow:global_step/sec: 86.9528\r\nINFO:tensorflow:train_accuracy = 0.485 (1.150 sec)\r\nINFO:tensorflow:loss = 0.519769, step = 101 (1.150 sec)\r\nINFO:tensorflow:global_step/sec: 91.0098\r\nINFO:tensorflow:train_accuracy = 0.61 (1.099 sec)\r\nINFO:tensorflow:loss = 0.464828, step = 201 (1.099 sec)\r\nINFO:tensorflow:global_step/sec: 95.5818\r\nINFO:tensorflow:train_accuracy = 0.6825 (1.046 sec)\r\nINFO:tensorflow:loss = 0.299279, step = 301 (1.046 sec)\r\n...\r\nEvaluation results:\r\n    {'loss': 0.027056012, 'global_step': 20000, 'accuracy': 0.99309999}\r\n$ # comment out the .train line (lines 232-235) in mnist.py\r\n$ # somehow disable GPU\r\n$ python mnist.py --data_dir ~/tmp/mnist_data --model_dir ~/tmp/mnist_model --steps 2000 --data_format channels_last\r\nINFO:tensorflow:Using default config.\r\nINFO:tensorflow:Using config: {'_save_checkpoints_secs': 600, '_session_config': None, '_keep_checkpoint_max': 5, '_task_type': 'worker', '_is_chief': True, '_clu\r\nster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f4a9afcfd10>, '_save_checkpoints_steps': None, '_keep_checkpoint_every_n_hours': 10000\r\n, '_service': None, '_num_ps_replicas': 0, '_tf_random_seed': 1, '_master': '', '_num_worker_replicas': 1, '_task_id': 0, '_log_step_count_steps': 100, '_model_di\r\nr': '/home/amir/tmp/mnist_model', '_save_summary_steps': 100}\r\nWARNING:tensorflow:From mnist.py:84: __init__ (from tensorflow.contrib.data.python.ops.readers) is deprecated and will be removed in a future version.\r\nInstructions for updating:\r\nUse `tf.data.TFRecordDataset`.\r\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with num_threads is deprecated and will be removed in a fut\r\nure version.\r\nInstructions for updating:\r\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\r\nWARNING:tensorflow:From mnist.py:92: calling map (from tensorflow.contrib.data.python.ops.dataset_ops) with output_buffer_size is deprecated and will be removed i\r\nn a future version.\r\nInstructions for updating:\r\nReplace `num_threads=T` with `num_parallel_calls=T`. Replace `output_buffer_size=N` with `ds.prefetch(N)` on the returned dataset.\r\nINFO:tensorflow:Starting evaluation at 2017-10-26-14:33:53\r\n2017-10-26 16:33:53.385155: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to us\r\ne: SSE4.1 SSE4.2 AVX AVX2 FMA\r\n2017-10-26 16:33:53.907636: E tensorflow/stream_executor/cuda/cuda_driver.cc:406] failed call to cuInit: CUDA_ERROR_NO_DEVICE\r\n2017-10-26 16:33:53.907712: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:158] retrieving CUDA diagnostic information for host: italix14\r\n2017-10-26 16:33:53.907722: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:165] hostname: italix14\r\n2017-10-26 16:33:53.907800: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:189] libcuda reported version is: Invalid argument: expected %d.%d or %d.%d.%d f\r\norm for driver version; got \"1\"\r\n2017-10-26 16:33:53.907837: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:369] driver version file contents: \"\"\"NVRM version: NVIDIA UNIX x86_64 Kernel Mo\r\ndule  375.26  Thu Dec  8 18:36:43 PST 2016\r\nGCC version:  gcc version 4.8.4 (Debian 4.8.4-1)\r\n\"\"\"\r\n2017-10-26 16:33:53.907871: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:193] kernel reported version is: 375.26.0\r\nINFO:tensorflow:Restoring parameters from /home/amir/tmp/mnist_model/model.ckpt-20000\r\nINFO:tensorflow:Finished evaluation at 2017-10-26-14:34:20\r\nINFO:tensorflow:Saving dict for global step 20000: accuracy = 0.0962, global_step = 20000, loss = 6.32954\r\n\r\nEvaluation results:\r\n    {'loss': 6.3295369, 'global_step': 20000, 'accuracy': 0.096199997}\r\n```\r\n\r\n\r\n### Describe the problem\r\nI have trained the official mnist model on GPU (`channels_first`,  `NCHW`) but when I test it on CPU (`channels_last`,  `NHWC`) I get different results. On GPU, I get an accuracy of `0.99309999` but the same model (when tested on CPU) gives `0.096199997`. I believe when the model is restored from the checkpoint the kernel weights are not restored properly to accommodate for the new channel format.\r\n\r\nThe problem I have shown here is using the official mnist model but in reality I have a model that I have already trained using the `channels_first` format on GPU which took several days to train. But, now I cannot evaluate this model on CPU.\r\n\r\n"}