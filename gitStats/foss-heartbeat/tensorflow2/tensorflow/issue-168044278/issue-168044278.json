{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3545", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3545/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3545/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/3545/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/3545", "id": 168044278, "node_id": "MDU6SXNzdWUxNjgwNDQyNzg=", "number": 3545, "title": "Tensorflow unable to detect no. of CPU cores", "user": {"login": "npanpaliya", "id": 14196089, "node_id": "MDQ6VXNlcjE0MTk2MDg5", "avatar_url": "https://avatars3.githubusercontent.com/u/14196089?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npanpaliya", "html_url": "https://github.com/npanpaliya", "followers_url": "https://api.github.com/users/npanpaliya/followers", "following_url": "https://api.github.com/users/npanpaliya/following{/other_user}", "gists_url": "https://api.github.com/users/npanpaliya/gists{/gist_id}", "starred_url": "https://api.github.com/users/npanpaliya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npanpaliya/subscriptions", "organizations_url": "https://api.github.com/users/npanpaliya/orgs", "repos_url": "https://api.github.com/users/npanpaliya/repos", "events_url": "https://api.github.com/users/npanpaliya/events{/privacy}", "received_events_url": "https://api.github.com/users/npanpaliya/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 15, "created_at": "2016-07-28T08:50:13Z", "updated_at": "2016-08-29T23:27:37Z", "closed_at": "2016-08-29T23:27:37Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>Environment info</h3>\n<p><strong>Operating System:</strong><br>\nUbuntu 14.04 Linux ppc64le</p>\n<p><strong>Installed version of CUDA and cuDNN: 7.5</strong><br>\nls -l /usr/local/cuda-7.5/lib64/libcud*<br>\n-rw-r--r-- 1 root root   326744 Nov  9  2015 /usr/local/cuda-7.5/lib64/libcudadevrt.a<br>\nlrwxrwxrwx 1 root root       16 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so -&gt; libcudart.so.7.5<br>\nlrwxrwxrwx 1 root root       19 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so.7.5 -&gt; libcudart.so.7.5.23<br>\n-rwxr-xr-x 1 root root   445192 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so.7.5.23<br>\n-rw-r--r-- 1 root root   902750 Nov  9  2015 /usr/local/cuda-7.5/lib64/libcudart_static.a<br>\nlrwxrwxrwx 1 root root       13 Apr 24 20:17 /usr/local/cuda-7.5/lib64/libcudnn.so -&gt; libcudnn.so.5<br>\n-rwxr-xr-x 1 root root 60068392 Apr 22 19:18 /usr/local/cuda-7.5/lib64/libcudnn.so.5.0.5<br>\n-rw-r--r-- 1 root root 59436124 Apr 22 19:30 /usr/local/cuda-7.5/lib64/libcudnn_static.a<br>\n**</p>\n<p><strong>Tensorflow 0.8 built and installed from source. (v0.8.0 tag)</strong></p>\n<ol>\n<li>The commit hash (<code>git rev-parse HEAD</code>) : <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/4b7bc3174ed67b4a0eb1803537c9d00f132e9ae7/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/4b7bc3174ed67b4a0eb1803537c9d00f132e9ae7\"><tt>4b7bc31</tt></a></li>\n<li>The output of <code>bazel version</code>: 0.2.0<br>\nNote: Same issue also exists with tensorflow 0.9</li>\n</ol>\n<p><strong>Steps to reproduce:</strong><br>\nOn python prompt,</p>\n<ol>\n<li>import tensorflow as tf</li>\n<li>tf.Session()</li>\n</ol>\n<p>In a large output of above statement, there is a line that says \"can't determine no. of CPU cores, assuming 4\".</p>\n<p>After looking into the tensorflow code, I found that __linux macro in tensorflow/core/platform/posix/port.cc is found to be not defined and hence sched_getaffinity is not called, and returns 4 as default value. I checked that usually on linux, __linux is defined but if we compile using -std=c++11, then this macro gets undefined.<br>\nAnyway, even if sched_getaffinity is called, it returns logical no. of CPU cores i.e. maximum threads possible. On POWER, usually this count is pretty higher and having so many threads degrades the performance. Ideally, we should have physical core size as the max possible thread count in thread pool for optimum performance. I tried looking for a built-in function that gives me physical core size, but unfortunately, all of the functions I found gives me logical core size. Then I found another library \"<a href=\"https://www.open-mpi.org/projects/hwloc/\" rel=\"nofollow\">libhwloc</a>\" that gives C API to get this information. This library in general is very useful with nice documentation. It is also available on canonical and one can install it using \"apt-get install libhwloc-dev\" on Ubuntu system or on RHEL using \"yum install hwloc-devel\".<br>\nSo, I wanted to know if Tensorflow can accept this additional dependency on hwloc library.</p>", "body_text": "Environment info\nOperating System:\nUbuntu 14.04 Linux ppc64le\nInstalled version of CUDA and cuDNN: 7.5\nls -l /usr/local/cuda-7.5/lib64/libcud*\n-rw-r--r-- 1 root root   326744 Nov  9  2015 /usr/local/cuda-7.5/lib64/libcudadevrt.a\nlrwxrwxrwx 1 root root       16 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so -> libcudart.so.7.5\nlrwxrwxrwx 1 root root       19 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so.7.5 -> libcudart.so.7.5.23\n-rwxr-xr-x 1 root root   445192 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so.7.5.23\n-rw-r--r-- 1 root root   902750 Nov  9  2015 /usr/local/cuda-7.5/lib64/libcudart_static.a\nlrwxrwxrwx 1 root root       13 Apr 24 20:17 /usr/local/cuda-7.5/lib64/libcudnn.so -> libcudnn.so.5\n-rwxr-xr-x 1 root root 60068392 Apr 22 19:18 /usr/local/cuda-7.5/lib64/libcudnn.so.5.0.5\n-rw-r--r-- 1 root root 59436124 Apr 22 19:30 /usr/local/cuda-7.5/lib64/libcudnn_static.a\n**\nTensorflow 0.8 built and installed from source. (v0.8.0 tag)\n\nThe commit hash (git rev-parse HEAD) : 4b7bc31\nThe output of bazel version: 0.2.0\nNote: Same issue also exists with tensorflow 0.9\n\nSteps to reproduce:\nOn python prompt,\n\nimport tensorflow as tf\ntf.Session()\n\nIn a large output of above statement, there is a line that says \"can't determine no. of CPU cores, assuming 4\".\nAfter looking into the tensorflow code, I found that __linux macro in tensorflow/core/platform/posix/port.cc is found to be not defined and hence sched_getaffinity is not called, and returns 4 as default value. I checked that usually on linux, __linux is defined but if we compile using -std=c++11, then this macro gets undefined.\nAnyway, even if sched_getaffinity is called, it returns logical no. of CPU cores i.e. maximum threads possible. On POWER, usually this count is pretty higher and having so many threads degrades the performance. Ideally, we should have physical core size as the max possible thread count in thread pool for optimum performance. I tried looking for a built-in function that gives me physical core size, but unfortunately, all of the functions I found gives me logical core size. Then I found another library \"libhwloc\" that gives C API to get this information. This library in general is very useful with nice documentation. It is also available on canonical and one can install it using \"apt-get install libhwloc-dev\" on Ubuntu system or on RHEL using \"yum install hwloc-devel\".\nSo, I wanted to know if Tensorflow can accept this additional dependency on hwloc library.", "body": "### Environment info\n\n**Operating System:**\nUbuntu 14.04 Linux ppc64le\n\n**Installed version of CUDA and cuDNN: 7.5**\nls -l /usr/local/cuda-7.5/lib64/libcud*\n-rw-r--r-- 1 root root   326744 Nov  9  2015 /usr/local/cuda-7.5/lib64/libcudadevrt.a\nlrwxrwxrwx 1 root root       16 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so -> libcudart.so.7.5\nlrwxrwxrwx 1 root root       19 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so.7.5 -> libcudart.so.7.5.23\n-rwxr-xr-x 1 root root   445192 Nov  5  2015 /usr/local/cuda-7.5/lib64/libcudart.so.7.5.23\n-rw-r--r-- 1 root root   902750 Nov  9  2015 /usr/local/cuda-7.5/lib64/libcudart_static.a\nlrwxrwxrwx 1 root root       13 Apr 24 20:17 /usr/local/cuda-7.5/lib64/libcudnn.so -> libcudnn.so.5\n-rwxr-xr-x 1 root root 60068392 Apr 22 19:18 /usr/local/cuda-7.5/lib64/libcudnn.so.5.0.5\n-rw-r--r-- 1 root root 59436124 Apr 22 19:30 /usr/local/cuda-7.5/lib64/libcudnn_static.a\n**\n\n**Tensorflow 0.8 built and installed from source. (v0.8.0 tag)**\n1. The commit hash (`git rev-parse HEAD`) : 4b7bc3174ed67b4a0eb1803537c9d00f132e9ae7\n2. The output of `bazel version`: 0.2.0\nNote: Same issue also exists with tensorflow 0.9\n\n**Steps to reproduce:**\nOn python prompt, \n1. import tensorflow as tf\n2. tf.Session()\n\nIn a large output of above statement, there is a line that says \"can't determine no. of CPU cores, assuming 4\".\n\nAfter looking into the tensorflow code, I found that __linux macro in tensorflow/core/platform/posix/port.cc is found to be not defined and hence sched_getaffinity is not called, and returns 4 as default value. I checked that usually on linux, __linux is defined but if we compile using -std=c++11, then this macro gets undefined. \nAnyway, even if sched_getaffinity is called, it returns logical no. of CPU cores i.e. maximum threads possible. On POWER, usually this count is pretty higher and having so many threads degrades the performance. Ideally, we should have physical core size as the max possible thread count in thread pool for optimum performance. I tried looking for a built-in function that gives me physical core size, but unfortunately, all of the functions I found gives me logical core size. Then I found another library \"[libhwloc](https://www.open-mpi.org/projects/hwloc/)\" that gives C API to get this information. This library in general is very useful with nice documentation. It is also available on canonical and one can install it using \"apt-get install libhwloc-dev\" on Ubuntu system or on RHEL using \"yum install hwloc-devel\". \nSo, I wanted to know if Tensorflow can accept this additional dependency on hwloc library.  \n"}