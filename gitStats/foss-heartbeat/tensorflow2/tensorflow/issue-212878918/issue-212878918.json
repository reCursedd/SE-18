{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8220", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8220/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8220/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/8220/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/8220", "id": 212878918, "node_id": "MDU6SXNzdWUyMTI4Nzg5MTg=", "number": 8220, "title": "Session hang issue with python multiprocessing", "user": {"login": "rfeinman", "id": 9561213, "node_id": "MDQ6VXNlcjk1NjEyMTM=", "avatar_url": "https://avatars2.githubusercontent.com/u/9561213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rfeinman", "html_url": "https://github.com/rfeinman", "followers_url": "https://api.github.com/users/rfeinman/followers", "following_url": "https://api.github.com/users/rfeinman/following{/other_user}", "gists_url": "https://api.github.com/users/rfeinman/gists{/gist_id}", "starred_url": "https://api.github.com/users/rfeinman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rfeinman/subscriptions", "organizations_url": "https://api.github.com/users/rfeinman/orgs", "repos_url": "https://api.github.com/users/rfeinman/repos", "events_url": "https://api.github.com/users/rfeinman/events{/privacy}", "received_events_url": "https://api.github.com/users/rfeinman/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "suharshs", "id": 1450614, "node_id": "MDQ6VXNlcjE0NTA2MTQ=", "avatar_url": "https://avatars1.githubusercontent.com/u/1450614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/suharshs", "html_url": "https://github.com/suharshs", "followers_url": "https://api.github.com/users/suharshs/followers", "following_url": "https://api.github.com/users/suharshs/following{/other_user}", "gists_url": "https://api.github.com/users/suharshs/gists{/gist_id}", "starred_url": "https://api.github.com/users/suharshs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/suharshs/subscriptions", "organizations_url": "https://api.github.com/users/suharshs/orgs", "repos_url": "https://api.github.com/users/suharshs/repos", "events_url": "https://api.github.com/users/suharshs/events{/privacy}", "received_events_url": "https://api.github.com/users/suharshs/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "suharshs", "id": 1450614, "node_id": "MDQ6VXNlcjE0NTA2MTQ=", "avatar_url": "https://avatars1.githubusercontent.com/u/1450614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/suharshs", "html_url": "https://github.com/suharshs", "followers_url": "https://api.github.com/users/suharshs/followers", "following_url": "https://api.github.com/users/suharshs/following{/other_user}", "gists_url": "https://api.github.com/users/suharshs/gists{/gist_id}", "starred_url": "https://api.github.com/users/suharshs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/suharshs/subscriptions", "organizations_url": "https://api.github.com/users/suharshs/orgs", "repos_url": "https://api.github.com/users/suharshs/repos", "events_url": "https://api.github.com/users/suharshs/events{/privacy}", "received_events_url": "https://api.github.com/users/suharshs/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 14, "created_at": "2017-03-08T22:38:51Z", "updated_at": "2018-09-20T07:08:29Z", "closed_at": "2017-05-19T22:39:44Z", "author_association": "NONE", "body_html": "<h3>Issue summary</h3>\n<p>I am having trouble allocating GPU devices for a multiprocessing pool. Please see the short code reproduction below. I would like to understand why I am getting the CUDA_ERROR_NOT_INITIALIZED error in case 4. For this case, the program hangs, and I have to stop my docker container to exit.</p>\n<h3>Minimal reproducible example</h3>\n<p>core code:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">run_session</span>(<span class=\"pl-smi\">device</span>):\n    gpu_options <span class=\"pl-k\">=</span> tf.GPUOptions(<span class=\"pl-v\">allow_growth</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>, <span class=\"pl-v\">visible_device_list</span><span class=\"pl-k\">=</span>device)\n    sess <span class=\"pl-k\">=</span> tf.Session(<span class=\"pl-v\">config</span><span class=\"pl-k\">=</span>tf.ConfigProto(<span class=\"pl-v\">gpu_options</span><span class=\"pl-k\">=</span>gpu_options))\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>Using device #<span class=\"pl-c1\">%s</span><span class=\"pl-pds\">'</span></span> <span class=\"pl-k\">%</span> device)\n    a <span class=\"pl-k\">=</span> tf.placeholder(tf.int16, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>a<span class=\"pl-pds\">'</span></span>)\n    y <span class=\"pl-k\">=</span> tf.identity(a, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>y<span class=\"pl-pds\">'</span></span>)\n    <span class=\"pl-c1\">print</span> sess.run(y, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{a: <span class=\"pl-c1\">3</span>})\n    sess.close()\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>Done.<span class=\"pl-pds\">'</span></span>)</pre></div>\n<p>Case 1 (this works fine):</p>\n<div class=\"highlight highlight-source-python\"><pre>run_session(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>0<span class=\"pl-pds\">'</span></span>)</pre></div>\n<pre><code>I tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #0\n3\nDone.\n</code></pre>\n<p>Case 2 (this works fine):</p>\n<div class=\"highlight highlight-source-python\"><pre>run_session(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>0<span class=\"pl-pds\">'</span></span>)\nrun_session(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>1<span class=\"pl-pds\">'</span></span>)</pre></div>\n<pre><code>I tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #0\n3\nDone.\nW tensorflow/stream_executor/cuda/cuda_driver.cc:590] creating context when one is currently active; existing: 0x24cbbe0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:84:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 1\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 1:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 1, name: GeForce GTX 980 Ti, pci bus id: 0000:84:00.0)\nUsing device #1\n3\nDone.\n</code></pre>\n<p>Case 3 (this works fine):</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> multiprocessing <span class=\"pl-k\">as</span> mp\n\np <span class=\"pl-k\">=</span> mp.Pool(<span class=\"pl-c1\">2</span>)\np.map(run_session, [<span class=\"pl-s\"><span class=\"pl-pds\">'</span>0<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>1<span class=\"pl-pds\">'</span></span>])\np.close()\np.join()</pre></div>\n<pre><code>I tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:84:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 1\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 1:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 1, name: GeForce GTX 980 Ti, pci bus id: 0000:84:00.0)\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #1\nUsing device #0\n3\nDone.\n3\nDone.\n</code></pre>\n<p>Case 4 (here, the program hangs):</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> multiprocessing <span class=\"pl-k\">as</span> mp\n\nrun_session(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>0<span class=\"pl-pds\">'</span></span>)\np <span class=\"pl-k\">=</span> mp.Pool(<span class=\"pl-c1\">2</span>)\np.map(run_session, [<span class=\"pl-s\"><span class=\"pl-pds\">'</span>0<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>1<span class=\"pl-pds\">'</span></span>])\np.close()\np.join()</pre></div>\n<pre><code>I tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #0\n3\nDone.\nE tensorflow/stream_executor/cuda/cuda_driver.cc:1368] could not retrieve CUDA device count: CUDA_ERROR_NOT_INITIALIZED\nUsing device #0\nE tensorflow/stream_executor/cuda/cuda_driver.cc:1368] could not retrieve CUDA device count: CUDA_ERROR_NOT_INITIALIZED\nUsing device #1\n</code></pre>\n<h3>Environment info</h3>\n<p>Operating System: Ubuntu 14.04.4 LTS (GNU/Linux 3.19.0-25-generic x86_64)<br>\nDocker container: gcr.io/tensorflow/tensorflow:latest-devel-gpu<br>\nCUDA version: 8.0.61<br>\ncuDNN version: 5.1.10</p>\n<h3>Related GitHub issues</h3>\n<p><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"142647609\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1578\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1578/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1578\">#1578</a></p>", "body_text": "Issue summary\nI am having trouble allocating GPU devices for a multiprocessing pool. Please see the short code reproduction below. I would like to understand why I am getting the CUDA_ERROR_NOT_INITIALIZED error in case 4. For this case, the program hangs, and I have to stop my docker container to exit.\nMinimal reproducible example\ncore code:\nimport tensorflow as tf\n\ndef run_session(device):\n    gpu_options = tf.GPUOptions(allow_growth=True, visible_device_list=device)\n    sess = tf.Session(config=tf.ConfigProto(gpu_options=gpu_options))\n    print('Using device #%s' % device)\n    a = tf.placeholder(tf.int16, name='a')\n    y = tf.identity(a, name='y')\n    print sess.run(y, feed_dict={a: 3})\n    sess.close()\n    print('Done.')\nCase 1 (this works fine):\nrun_session('0')\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #0\n3\nDone.\n\nCase 2 (this works fine):\nrun_session('0')\nrun_session('1')\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #0\n3\nDone.\nW tensorflow/stream_executor/cuda/cuda_driver.cc:590] creating context when one is currently active; existing: 0x24cbbe0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:84:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 1\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 1:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 1, name: GeForce GTX 980 Ti, pci bus id: 0000:84:00.0)\nUsing device #1\n3\nDone.\n\nCase 3 (this works fine):\nimport multiprocessing as mp\n\np = mp.Pool(2)\np.map(run_session, ['0', '1'])\np.close()\np.join()\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:84:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 1\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 1:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 1, name: GeForce GTX 980 Ti, pci bus id: 0000:84:00.0)\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #1\nUsing device #0\n3\nDone.\n3\nDone.\n\nCase 4 (here, the program hangs):\nimport multiprocessing as mp\n\nrun_session('0')\np = mp.Pool(2)\np.map(run_session, ['0', '1'])\np.close()\np.join()\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 980 Ti\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:08:00.0\nTotal memory: 5.97GiB\nFree memory: 5.86GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\nUsing device #0\n3\nDone.\nE tensorflow/stream_executor/cuda/cuda_driver.cc:1368] could not retrieve CUDA device count: CUDA_ERROR_NOT_INITIALIZED\nUsing device #0\nE tensorflow/stream_executor/cuda/cuda_driver.cc:1368] could not retrieve CUDA device count: CUDA_ERROR_NOT_INITIALIZED\nUsing device #1\n\nEnvironment info\nOperating System: Ubuntu 14.04.4 LTS (GNU/Linux 3.19.0-25-generic x86_64)\nDocker container: gcr.io/tensorflow/tensorflow:latest-devel-gpu\nCUDA version: 8.0.61\ncuDNN version: 5.1.10\nRelated GitHub issues\n#1578", "body": "### Issue summary\r\n\r\nI am having trouble allocating GPU devices for a multiprocessing pool. Please see the short code reproduction below. I would like to understand why I am getting the CUDA_ERROR_NOT_INITIALIZED error in case 4. For this case, the program hangs, and I have to stop my docker container to exit.\r\n\r\n### Minimal reproducible example \r\n\r\ncore code:\r\n```python\r\nimport tensorflow as tf\r\n\r\ndef run_session(device):\r\n    gpu_options = tf.GPUOptions(allow_growth=True, visible_device_list=device)\r\n    sess = tf.Session(config=tf.ConfigProto(gpu_options=gpu_options))\r\n    print('Using device #%s' % device)\r\n    a = tf.placeholder(tf.int16, name='a')\r\n    y = tf.identity(a, name='y')\r\n    print sess.run(y, feed_dict={a: 3})\r\n    sess.close()\r\n    print('Done.')\r\n```\r\nCase 1 (this works fine):\r\n```python\r\nrun_session('0')\r\n```\r\n```\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 980 Ti\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:08:00.0\r\nTotal memory: 5.97GiB\r\nFree memory: 5.86GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\r\nUsing device #0\r\n3\r\nDone.\r\n```\r\nCase 2 (this works fine):\r\n```python\r\nrun_session('0')\r\nrun_session('1')\r\n```\r\n```\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 980 Ti\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:08:00.0\r\nTotal memory: 5.97GiB\r\nFree memory: 5.86GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\r\nUsing device #0\r\n3\r\nDone.\r\nW tensorflow/stream_executor/cuda/cuda_driver.cc:590] creating context when one is currently active; existing: 0x24cbbe0\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 980 Ti\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:84:00.0\r\nTotal memory: 5.97GiB\r\nFree memory: 5.86GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 1\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 1:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 1, name: GeForce GTX 980 Ti, pci bus id: 0000:84:00.0)\r\nUsing device #1\r\n3\r\nDone.\r\n```\r\nCase 3 (this works fine):\r\n```python\r\nimport multiprocessing as mp\r\n\r\np = mp.Pool(2)\r\np.map(run_session, ['0', '1'])\r\np.close()\r\np.join()\r\n```\r\n```\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 980 Ti\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:84:00.0\r\nTotal memory: 5.97GiB\r\nFree memory: 5.86GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 1\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 1:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 1, name: GeForce GTX 980 Ti, pci bus id: 0000:84:00.0)\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 980 Ti\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:08:00.0\r\nTotal memory: 5.97GiB\r\nFree memory: 5.86GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\r\nUsing device #1\r\nUsing device #0\r\n3\r\nDone.\r\n3\r\nDone.\r\n```\r\nCase 4 (here, the program hangs):\r\n```python\r\nimport multiprocessing as mp\r\n\r\nrun_session('0')\r\np = mp.Pool(2)\r\np.map(run_session, ['0', '1'])\r\np.close()\r\np.join()\r\n```\r\n```\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 980 Ti\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:08:00.0\r\nTotal memory: 5.97GiB\r\nFree memory: 5.86GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 980 Ti, pci bus id: 0000:08:00.0)\r\nUsing device #0\r\n3\r\nDone.\r\nE tensorflow/stream_executor/cuda/cuda_driver.cc:1368] could not retrieve CUDA device count: CUDA_ERROR_NOT_INITIALIZED\r\nUsing device #0\r\nE tensorflow/stream_executor/cuda/cuda_driver.cc:1368] could not retrieve CUDA device count: CUDA_ERROR_NOT_INITIALIZED\r\nUsing device #1\r\n```\r\n\r\n\r\n### Environment info\r\nOperating System: Ubuntu 14.04.4 LTS (GNU/Linux 3.19.0-25-generic x86_64)\r\nDocker container: gcr.io/tensorflow/tensorflow:latest-devel-gpu\r\nCUDA version: 8.0.61\r\ncuDNN version: 5.1.10\r\n\r\n### Related GitHub issues\r\n#1578\r\n"}