{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23166", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23166/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23166/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23166/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23166", "id": 372616818, "node_id": "MDU6SXNzdWUzNzI2MTY4MTg=", "number": 23166, "title": "\"Invalid loop structure. Mismatched parent frames\"", "user": {"login": "carlini", "id": 1269300, "node_id": "MDQ6VXNlcjEyNjkzMDA=", "avatar_url": "https://avatars2.githubusercontent.com/u/1269300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/carlini", "html_url": "https://github.com/carlini", "followers_url": "https://api.github.com/users/carlini/followers", "following_url": "https://api.github.com/users/carlini/following{/other_user}", "gists_url": "https://api.github.com/users/carlini/gists{/gist_id}", "starred_url": "https://api.github.com/users/carlini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/carlini/subscriptions", "organizations_url": "https://api.github.com/users/carlini/orgs", "repos_url": "https://api.github.com/users/carlini/repos", "events_url": "https://api.github.com/users/carlini/events{/privacy}", "received_events_url": "https://api.github.com/users/carlini/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1097546578, "node_id": "MDU6TGFiZWwxMDk3NTQ2NTc4", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:keras", "name": "comp:keras", "color": "0052cc", "default": false}], "state": "open", "locked": false, "assignee": {"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wt-huang", "id": 42785337, "node_id": "MDQ6VXNlcjQyNzg1MzM3", "avatar_url": "https://avatars0.githubusercontent.com/u/42785337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wt-huang", "html_url": "https://github.com/wt-huang", "followers_url": "https://api.github.com/users/wt-huang/followers", "following_url": "https://api.github.com/users/wt-huang/following{/other_user}", "gists_url": "https://api.github.com/users/wt-huang/gists{/gist_id}", "starred_url": "https://api.github.com/users/wt-huang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wt-huang/subscriptions", "organizations_url": "https://api.github.com/users/wt-huang/orgs", "repos_url": "https://api.github.com/users/wt-huang/repos", "events_url": "https://api.github.com/users/wt-huang/events{/privacy}", "received_events_url": "https://api.github.com/users/wt-huang/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-10-22T17:27:24Z", "updated_at": "2018-11-13T08:04:47Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>Computing the gradient through a batch normalization layer as implemented in keras with a batch size of None while in a tf.while loop can cause the following error:</p>\n<p>\"tensorflow.python.framework.errors_impl.InvalidArgumentError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". This is an internal bug, please file a bug report with instructions on how to reproduce the error\"</p>\n<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes</li>\n<li>OS Platform and Distribution: Ubuntu 16.04</li>\n<li>TensorFlow installed from (source or binary): binary</li>\n<li>TensorFlow version (use command below): Reproducible using the latest release [v1.12.0-rc1-0-g7b08198113 1.12.0-rc1] through back to at least 1.10.0.</li>\n<li>Python version: 3.5.2</li>\n<li>CUDA/cuDNN version: Reproducible without CUDA.</li>\n<li>GPU model and memory: Reproducible without any GPUs.</li>\n</ul>\n<p>Current Behavior: running the below script throws a really bad error.</p>\n<p>Expected Behavior: it crashes, but not with this error.</p>\n<p><strong>Code to reproduce the issue</strong></p>\n<p>This is the minimal example that I can get to cause a crash. It isn't \"correct\" code in that it shouldn't work, but it shouldn't crash because of mismatched parent frames. Code that I believe is actually correct also causes the crash, but is much longer.</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> numpy <span class=\"pl-k\">as</span> np\n<span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>## MUST be keras, not from tensorflow import keras</span>\n<span class=\"pl-k\">import</span> keras\n\n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">__name__</span> <span class=\"pl-k\">==</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>__main__<span class=\"pl-pds\">\"</span></span>:\n  sess <span class=\"pl-k\">=</span> keras.backend.get_session()\n\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span>## I can't reproduce this with tf.layers.batch_normalization</span>\n  model <span class=\"pl-k\">=</span> keras.models.Sequential([keras.layers.BatchNormalization(<span class=\"pl-v\">input_shape</span><span class=\"pl-k\">=</span>(<span class=\"pl-c1\">1</span>,))])\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span>## This next line MUST have the None, otherwise it doesn't crash</span>\n  x <span class=\"pl-k\">=</span> tf.placeholder(tf.float32, (<span class=\"pl-c1\">None</span>, <span class=\"pl-c1\">1</span>))\n\n  eta <span class=\"pl-k\">=</span> tf.zeros(tf.shape(x))\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">cond</span>(<span class=\"pl-smi\">i</span>, <span class=\"pl-smi\">_</span>):\n    <span class=\"pl-k\">return</span> tf.less(i, <span class=\"pl-c1\">10</span>)\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">body</span>(<span class=\"pl-smi\">i</span>, <span class=\"pl-smi\">e</span>):\n    preds <span class=\"pl-k\">=</span> model(x<span class=\"pl-k\">+</span>e)\n    <span class=\"pl-k\">return</span> i <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>, tf.gradients(preds, x)[<span class=\"pl-c1\">0</span>]\n\n  _, eta <span class=\"pl-k\">=</span> tf.while_loop(cond, body, [tf.zeros([]), eta])\n\n  sess.run(eta, {x: np.zeros((<span class=\"pl-c1\">128</span>,<span class=\"pl-c1\">1</span>))})</pre></div>\n<p><strong>Other info / logs</strong></p>\n<pre><code>2018-10-22 17:21:30.132455: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\nTraceback (most recent call last):\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1334, in _do_call\n    return fn(*args)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1319, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1407, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.InternalError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". The node giving this error: {{node while/gradients/while/sequential_1/batch_normalization_1/cond/batchnorm/mul_1_grad/Shape/Enter}}This is an internal bug, please file a bug report with instructions on how to reproduce the error.\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"bug.py\", line 26, in &lt;module&gt;\n    sess.run(eta, {x: np.zeros((128,1))})\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 929, in run\n    run_metadata_ptr)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1152, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1328, in _do_run\n    run_metadata)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1348, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InternalError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". The node giving this error: node while/gradients/while/sequential_1/batch_normalization_1/cond/batchnorm/mul_1_grad/Shape/Enter (defined at bug.py:22) This is an internal bug, please file a bug report with instructions on how to reproduce the error.\n</code></pre>", "body_text": "Computing the gradient through a batch normalization layer as implemented in keras with a batch size of None while in a tf.while loop can cause the following error:\n\"tensorflow.python.framework.errors_impl.InvalidArgumentError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". This is an internal bug, please file a bug report with instructions on how to reproduce the error\"\nSystem information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution: Ubuntu 16.04\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): Reproducible using the latest release [v1.12.0-rc1-0-g7b08198113 1.12.0-rc1] through back to at least 1.10.0.\nPython version: 3.5.2\nCUDA/cuDNN version: Reproducible without CUDA.\nGPU model and memory: Reproducible without any GPUs.\n\nCurrent Behavior: running the below script throws a really bad error.\nExpected Behavior: it crashes, but not with this error.\nCode to reproduce the issue\nThis is the minimal example that I can get to cause a crash. It isn't \"correct\" code in that it shouldn't work, but it shouldn't crash because of mismatched parent frames. Code that I believe is actually correct also causes the crash, but is much longer.\nimport numpy as np\nimport tensorflow as tf\n### MUST be keras, not from tensorflow import keras\nimport keras\n\nif __name__ == \"__main__\":\n  sess = keras.backend.get_session()\n\n  ### I can't reproduce this with tf.layers.batch_normalization\n  model = keras.models.Sequential([keras.layers.BatchNormalization(input_shape=(1,))])\n  ### This next line MUST have the None, otherwise it doesn't crash\n  x = tf.placeholder(tf.float32, (None, 1))\n\n  eta = tf.zeros(tf.shape(x))\n  def cond(i, _):\n    return tf.less(i, 10)\n  def body(i, e):\n    preds = model(x+e)\n    return i + 1, tf.gradients(preds, x)[0]\n\n  _, eta = tf.while_loop(cond, body, [tf.zeros([]), eta])\n\n  sess.run(eta, {x: np.zeros((128,1))})\nOther info / logs\n2018-10-22 17:21:30.132455: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\nTraceback (most recent call last):\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1334, in _do_call\n    return fn(*args)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1319, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1407, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.InternalError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". The node giving this error: {{node while/gradients/while/sequential_1/batch_normalization_1/cond/batchnorm/mul_1_grad/Shape/Enter}}This is an internal bug, please file a bug report with instructions on how to reproduce the error.\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"bug.py\", line 26, in <module>\n    sess.run(eta, {x: np.zeros((128,1))})\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 929, in run\n    run_metadata_ptr)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1152, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1328, in _do_run\n    run_metadata)\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1348, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InternalError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". The node giving this error: node while/gradients/while/sequential_1/batch_normalization_1/cond/batchnorm/mul_1_grad/Shape/Enter (defined at bug.py:22) This is an internal bug, please file a bug report with instructions on how to reproduce the error.", "body": "Computing the gradient through a batch normalization layer as implemented in keras with a batch size of None while in a tf.while loop can cause the following error:\r\n\r\n\"tensorflow.python.framework.errors_impl.InvalidArgumentError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". This is an internal bug, please file a bug report with instructions on how to reproduce the error\"\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\r\n- OS Platform and Distribution: Ubuntu 16.04\r\n- TensorFlow installed from (source or binary): binary\r\n- TensorFlow version (use command below): Reproducible using the latest release [v1.12.0-rc1-0-g7b08198113 1.12.0-rc1] through back to at least 1.10.0.\r\n- Python version: 3.5.2\r\n- CUDA/cuDNN version: Reproducible without CUDA.\r\n- GPU model and memory: Reproducible without any GPUs.\r\n\r\nCurrent Behavior: running the below script throws a really bad error.\r\n\r\nExpected Behavior: it crashes, but not with this error.\r\n\r\n**Code to reproduce the issue**\r\n\r\nThis is the minimal example that I can get to cause a crash. It isn't \"correct\" code in that it shouldn't work, but it shouldn't crash because of mismatched parent frames. Code that I believe is actually correct also causes the crash, but is much longer.\r\n\r\n```python\r\nimport numpy as np\r\nimport tensorflow as tf\r\n### MUST be keras, not from tensorflow import keras\r\nimport keras\r\n\r\nif __name__ == \"__main__\":\r\n  sess = keras.backend.get_session()\r\n\r\n  ### I can't reproduce this with tf.layers.batch_normalization\r\n  model = keras.models.Sequential([keras.layers.BatchNormalization(input_shape=(1,))])\r\n  ### This next line MUST have the None, otherwise it doesn't crash\r\n  x = tf.placeholder(tf.float32, (None, 1))\r\n\r\n  eta = tf.zeros(tf.shape(x))\r\n  def cond(i, _):\r\n    return tf.less(i, 10)\r\n  def body(i, e):\r\n    preds = model(x+e)\r\n    return i + 1, tf.gradients(preds, x)[0]\r\n\r\n  _, eta = tf.while_loop(cond, body, [tf.zeros([]), eta])\r\n\r\n  sess.run(eta, {x: np.zeros((128,1))})\r\n```\r\n\r\n**Other info / logs**\r\n\r\n```\r\n2018-10-22 17:21:30.132455: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\nTraceback (most recent call last):\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1334, in _do_call\r\n    return fn(*args)\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1319, in _run_fn\r\n    options, feed_dict, fetch_list, target_list, run_metadata)\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1407, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.InternalError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". The node giving this error: {{node while/gradients/while/sequential_1/batch_normalization_1/cond/batchnorm/mul_1_grad/Shape/Enter}}This is an internal bug, please file a bug report with instructions on how to reproduce the error.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"bug.py\", line 26, in <module>\r\n    sess.run(eta, {x: np.zeros((128,1))})\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 929, in run\r\n    run_metadata_ptr)\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1152, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1328, in _do_run\r\n    run_metadata)\r\n  File \"/home/ncarlini/.local/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1348, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InternalError: Invalid loop structure: Mismatched parent frames for \"while/while_context\": \"while/while_context\" vs \"\". The node giving this error: node while/gradients/while/sequential_1/batch_normalization_1/cond/batchnorm/mul_1_grad/Shape/Enter (defined at bug.py:22) This is an internal bug, please file a bug report with instructions on how to reproduce the error.\r\n```"}