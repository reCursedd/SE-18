{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18947", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18947/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18947/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18947/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/18947", "id": 318624481, "node_id": "MDU6SXNzdWUzMTg2MjQ0ODE=", "number": 18947, "title": "tf.contrib.data.prefetch_to_device throws an error when used with tf.data.Iterator.from_structure", "user": {"login": "svirg", "id": 629304, "node_id": "MDQ6VXNlcjYyOTMwNA==", "avatar_url": "https://avatars0.githubusercontent.com/u/629304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/svirg", "html_url": "https://github.com/svirg", "followers_url": "https://api.github.com/users/svirg/followers", "following_url": "https://api.github.com/users/svirg/following{/other_user}", "gists_url": "https://api.github.com/users/svirg/gists{/gist_id}", "starred_url": "https://api.github.com/users/svirg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/svirg/subscriptions", "organizations_url": "https://api.github.com/users/svirg/orgs", "repos_url": "https://api.github.com/users/svirg/repos", "events_url": "https://api.github.com/users/svirg/events{/privacy}", "received_events_url": "https://api.github.com/users/svirg/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}, {"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rohan100jain", "id": 144114, "node_id": "MDQ6VXNlcjE0NDExNA==", "avatar_url": "https://avatars2.githubusercontent.com/u/144114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohan100jain", "html_url": "https://github.com/rohan100jain", "followers_url": "https://api.github.com/users/rohan100jain/followers", "following_url": "https://api.github.com/users/rohan100jain/following{/other_user}", "gists_url": "https://api.github.com/users/rohan100jain/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohan100jain/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohan100jain/subscriptions", "organizations_url": "https://api.github.com/users/rohan100jain/orgs", "repos_url": "https://api.github.com/users/rohan100jain/repos", "events_url": "https://api.github.com/users/rohan100jain/events{/privacy}", "received_events_url": "https://api.github.com/users/rohan100jain/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2018-04-28T10:39:40Z", "updated_at": "2018-09-23T19:02:52Z", "closed_at": "2018-09-23T18:40:12Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nYes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.8.0</li>\n<li><strong>Python version</strong>: 2.7.12</li>\n<li><strong>Bazel version (if compiling from source)</strong>:</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:</li>\n<li><strong>CUDA/cuDNN version</strong>:</li>\n<li><strong>GPU model and memory</strong>:</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I'm using <strong>tf.data.Iterator.from_structure</strong> mechanism to switch between training/validation datasets during training<br>\nHowever, when <strong>tf.contrib.data.prefetch_to_device</strong> is added at the end of the dataset pipeline, the code crashes with the following error:<br>\n<code>NotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.</code><br>\nExplicit one shot iterator works fine</p>\n<h3>Source code / logs</h3>\n<pre><code>with tf.Graph().as_default():\n    with tf.Session() as sess:\n        dataset = tf.data.Dataset.range(10).apply(tf.contrib.data.prefetch_to_device('/cpu:0'))\n\n        # 1) works fine\n        iterator = dataset.make_one_shot_iterator()\n        print sess.run(iterator.get_next())\n        \n        # 2) fails\n        iterator = tf.data.Iterator.from_structure((tf.int64), ([]))\n        sess.run(iterator.make_initializer(dataset))\n        print sess.run(iterator.get_next())\n</code></pre>\n<pre><code>0\n\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n&lt;ipython-input-34-dbae58b82de0&gt; in &lt;module&gt;()\n      6 \n      7         iterator = tf.data.Iterator.from_structure((tf.int64), ([]))\n----&gt; 8         sess.run(iterator.make_initializer(dataset))\n      9         print sess.run(iterator.get_next())\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/python/data/ops/iterator_ops.pyc in make_initializer(self, dataset, name)\n    306     with ops.colocate_with(self._iterator_resource):\n    307       return gen_dataset_ops.make_iterator(\n--&gt; 308           dataset._as_variant_tensor(), self._iterator_resource, name=name)  # pylint: disable=protected-access\n    309 \n    310   def get_next(self, name=None):\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/data/python/ops/prefetching_ops.pyc in _as_variant_tensor(self)\n    289     # TODO(mrry): Investigate support for chaining further transformations after\n    290     # the prefetch, including GPU support.\n--&gt; 291     raise NotImplementedError(\"`prefetch_to_device()` must be the last \"\n    292                               \"transformation in a dataset pipeline.\")\n    293 \n\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.\n</code></pre>\n<p>I guess, prefetching is still under development? Is there a temporary workaround for this kind of scenario?</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nYes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.8.0\nPython version: 2.7.12\nBazel version (if compiling from source):\nGCC/Compiler version (if compiling from source):\nCUDA/cuDNN version:\nGPU model and memory:\nExact command to reproduce:\n\nDescribe the problem\nI'm using tf.data.Iterator.from_structure mechanism to switch between training/validation datasets during training\nHowever, when tf.contrib.data.prefetch_to_device is added at the end of the dataset pipeline, the code crashes with the following error:\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.\nExplicit one shot iterator works fine\nSource code / logs\nwith tf.Graph().as_default():\n    with tf.Session() as sess:\n        dataset = tf.data.Dataset.range(10).apply(tf.contrib.data.prefetch_to_device('/cpu:0'))\n\n        # 1) works fine\n        iterator = dataset.make_one_shot_iterator()\n        print sess.run(iterator.get_next())\n        \n        # 2) fails\n        iterator = tf.data.Iterator.from_structure((tf.int64), ([]))\n        sess.run(iterator.make_initializer(dataset))\n        print sess.run(iterator.get_next())\n\n0\n\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n<ipython-input-34-dbae58b82de0> in <module>()\n      6 \n      7         iterator = tf.data.Iterator.from_structure((tf.int64), ([]))\n----> 8         sess.run(iterator.make_initializer(dataset))\n      9         print sess.run(iterator.get_next())\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/python/data/ops/iterator_ops.pyc in make_initializer(self, dataset, name)\n    306     with ops.colocate_with(self._iterator_resource):\n    307       return gen_dataset_ops.make_iterator(\n--> 308           dataset._as_variant_tensor(), self._iterator_resource, name=name)  # pylint: disable=protected-access\n    309 \n    310   def get_next(self, name=None):\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/data/python/ops/prefetching_ops.pyc in _as_variant_tensor(self)\n    289     # TODO(mrry): Investigate support for chaining further transformations after\n    290     # the prefetch, including GPU support.\n--> 291     raise NotImplementedError(\"`prefetch_to_device()` must be the last \"\n    292                               \"transformation in a dataset pipeline.\")\n    293 \n\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.\n\nI guess, prefetching is still under development? Is there a temporary workaround for this kind of scenario?", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nYes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: 1.8.0\r\n- **Python version**: 2.7.12\r\n- **Bazel version (if compiling from source)**:\r\n- **GCC/Compiler version (if compiling from source)**:\r\n- **CUDA/cuDNN version**:\r\n- **GPU model and memory**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nI'm using **tf.data.Iterator.from_structure** mechanism to switch between training/validation datasets during training\r\nHowever, when **tf.contrib.data.prefetch_to_device** is added at the end of the dataset pipeline, the code crashes with the following error:\r\n```NotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.```\r\nExplicit one shot iterator works fine\r\n\r\n### Source code / logs\r\n```\r\nwith tf.Graph().as_default():\r\n    with tf.Session() as sess:\r\n        dataset = tf.data.Dataset.range(10).apply(tf.contrib.data.prefetch_to_device('/cpu:0'))\r\n\r\n        # 1) works fine\r\n        iterator = dataset.make_one_shot_iterator()\r\n        print sess.run(iterator.get_next())\r\n        \r\n        # 2) fails\r\n        iterator = tf.data.Iterator.from_structure((tf.int64), ([]))\r\n        sess.run(iterator.make_initializer(dataset))\r\n        print sess.run(iterator.get_next())\r\n```\r\n```\r\n0\r\n\r\n---------------------------------------------------------------------------\r\nNotImplementedError                       Traceback (most recent call last)\r\n<ipython-input-34-dbae58b82de0> in <module>()\r\n      6 \r\n      7         iterator = tf.data.Iterator.from_structure((tf.int64), ([]))\r\n----> 8         sess.run(iterator.make_initializer(dataset))\r\n      9         print sess.run(iterator.get_next())\r\n\r\n/usr/local/lib/python2.7/dist-packages/tensorflow/python/data/ops/iterator_ops.pyc in make_initializer(self, dataset, name)\r\n    306     with ops.colocate_with(self._iterator_resource):\r\n    307       return gen_dataset_ops.make_iterator(\r\n--> 308           dataset._as_variant_tensor(), self._iterator_resource, name=name)  # pylint: disable=protected-access\r\n    309 \r\n    310   def get_next(self, name=None):\r\n\r\n/usr/local/lib/python2.7/dist-packages/tensorflow/contrib/data/python/ops/prefetching_ops.pyc in _as_variant_tensor(self)\r\n    289     # TODO(mrry): Investigate support for chaining further transformations after\r\n    290     # the prefetch, including GPU support.\r\n--> 291     raise NotImplementedError(\"`prefetch_to_device()` must be the last \"\r\n    292                               \"transformation in a dataset pipeline.\")\r\n    293 \r\n\r\nNotImplementedError: `prefetch_to_device()` must be the last transformation in a dataset pipeline.\r\n```\r\n\r\nI guess, prefetching is still under development? Is there a temporary workaround for this kind of scenario?"}