{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5577", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5577/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5577/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5577/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/5577", "id": 188958130, "node_id": "MDU6SXNzdWUxODg5NTgxMzA=", "number": 5577, "title": "Possible Bug - tf.nn.moments differing outputs", "user": {"login": "raphtown", "id": 177576, "node_id": "MDQ6VXNlcjE3NzU3Ng==", "avatar_url": "https://avatars2.githubusercontent.com/u/177576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raphtown", "html_url": "https://github.com/raphtown", "followers_url": "https://api.github.com/users/raphtown/followers", "following_url": "https://api.github.com/users/raphtown/following{/other_user}", "gists_url": "https://api.github.com/users/raphtown/gists{/gist_id}", "starred_url": "https://api.github.com/users/raphtown/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raphtown/subscriptions", "organizations_url": "https://api.github.com/users/raphtown/orgs", "repos_url": "https://api.github.com/users/raphtown/repos", "events_url": "https://api.github.com/users/raphtown/events{/privacy}", "received_events_url": "https://api.github.com/users/raphtown/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2016-11-13T08:04:26Z", "updated_at": "2016-11-14T16:49:18Z", "closed_at": "2016-11-14T16:49:18Z", "author_association": "NONE", "body_html": "<p>Hello,</p>\n<p>I am observing differing outputs from tf.nn.moments when I run it multiple times on the same data, using GPU.  This makes it difficult for me to replicate my learning process!  See the logs at the bottom for what I mean.  I would expect the difference between moments across runs on the same data to be zero, but that is not the case in the logs I attached below (and most of the times I run it).</p>\n<p>If I run on CPU it is fine though.  Also, if I compute moments over smaller sets of data the problems seems to occur less often.</p>\n<p>Not sure what would be causing this, my guess would be some sort of numerical instability?  Help would be appreciated!</p>\n<h3>What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?</h3>\n<p>None found, I discovered this issue when trying to get replicable results using batch_norm in contrib.</p>\n<h3>Environment info</h3>\n<p>Operating System: Ubuntu 14.04.5 LTS (running in a <a href=\"http://singularity.lbl.gov\" rel=\"nofollow\">singularity</a> container on a CentOS 6.7 host).</p>\n<p>Installed version of CUDA and cuDNN:<br>\nI am using CUDA 8.0 with NVIDIA driver 367.48, and cuDNN v5.1 .<br>\n(please attach the output of <code>ls -l /path/to/cuda/lib/libcud*</code>):</p>\n<pre><code>libOpenCL.so\nlibOpenCL.so.1\nlibOpenCL.so.1.0\nlibOpenCL.so.1.0.0\nlibcublas.so\nlibcublas.so.8.0\nlibcublas.so.8.0.45\nlibcublas_device.a\nlibcublas_static.a\nlibcudadevrt.a\nlibcudart.so\nlibcudart.so.8.0\nlibcudart.so.8.0.44\nlibcudart_static.a\nlibcudnn.so\nlibcudnn.so.5\nlibcudnn.so.5.1.5\nlibcudnn_static.a\nlibcufft.so\nlibcufft.so.8.0\nlibcufft.so.8.0.44\nlibcufft_static.a\nlibcufftw.so\nlibcufftw.so.8.0\nlibcufftw.so.8.0.44\nlibcufftw_static.a\nlibcuinj64.so\nlibcuinj64.so.8.0\nlibcuinj64.so.8.0.44\nlibculibos.a\nlibcurand.so\nlibcurand.so.8.0\nlibcurand.so.8.0.44\nlibcurand_static.a\nlibcusolver.so\nlibcusolver.so.8.0\nlibcusolver.so.8.0.44\nlibcusolver_static.a\nlibcusparse.so\nlibcusparse.so.8.0\nlibcusparse.so.8.0.44\nlibcusparse_static.a\nlibnppc.so\nlibnppc.so.8.0\nlibnppc.so.8.0.44\nlibnppc_static.a\nlibnppi.so\nlibnppi.so.8.0\nlibnppi.so.8.0.44\nlibnppi_static.a\nlibnppial.so\nlibnppial.so.8.0\nlibnppial.so.8.0.44\nlibnppicc.so\nlibnppicc.so.8.0\nlibnppicc.so.8.0.44\nlibnppicom.so\nlibnppicom.so.8.0\nlibnppicom.so.8.0.44\nlibnppidei.so\nlibnppidei.so.8.0\nlibnppidei.so.8.0.44\nlibnppif.so\nlibnppif.so.8.0\nlibnppif.so.8.0.44\nlibnppig.so\nlibnppig.so.8.0\nlibnppig.so.8.0.44\nlibnppim.so\nlibnppim.so.8.0\nlibnppim.so.8.0.44\nlibnppist.so\nlibnppist.so.8.0\nlibnppist.so.8.0.44\nlibnppisu.so\nlibnppisu.so.8.0\nlibnppisu.so.8.0.44\nlibnppitc.so\nlibnppitc.so.8.0\nlibnppitc.so.8.0.44\nlibnpps.so\nlibnpps.so.8.0\nlibnpps.so.8.0.44\nlibnpps_static.a\nlibnvToolsExt.so\nlibnvToolsExt.so.1\nlibnvToolsExt.so.1.0.0\nlibnvblas.so\nlibnvblas.so.8.0\nlibnvblas.so.8.0.44\nlibnvgraph.so\nlibnvgraph.so.8.0\nlibnvgraph.so.8.0.44\nlibnvgraph_static.a\nlibnvrtc-builtins.so\nlibnvrtc-builtins.so.8.0\nlibnvrtc-builtins.so.8.0.44\nlibnvrtc.so\nlibnvrtc.so.8.0\nlibnvrtc.so.8.0.44\nstubs\n</code></pre>\n<p>I installed tensorflow using the 0.11.0rc2-gpu tag on docker hub.</p>\n<h3>If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)</h3>\n<pre><code>import numpy as np\nimport tensorflow as tf\n\nbatch_size = 2**10\nchannel_size = 100\n\nif __name__ == \"__main__\":\n\n    with tf.device('/gpu:0'):\n        x = tf.placeholder(tf.float32, shape=[None, channel_size],\n                           name='input')\n        mom = tf.nn.moments(x, [0])\n\n    feed_dict = {}\n    feed_dict['input:0'] = np.random.rand(batch_size, channel_size)\n\n    with tf.Session(config=tf.ConfigProto(allow_soft_placement=True)) as sess:\n        tf.initialize_all_variables().run()\n        [mom_out1] = sess.run([mom], feed_dict=feed_dict)\n        [mom_out2] = sess.run([mom], feed_dict=feed_dict)\n    print \"DIFFERENCE:\", mom_out1[0][0] - mom_out2[0][0]\n</code></pre>\n<h3>What other attempted solutions have you tried?</h3>\n<p>No other solutions tried.</p>\n<h3>Logs or other output that would be helpful</h3>\n<p>Output of running my the code once:</p>\n<pre><code>WARNING: Not mounting current directory: user bind control is disabled by system administrator\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcurand.so locally\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:951] Found device 0 with properties: \nname: GeForce GTX TITAN X\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:09:00.0\nTotal memory: 11.92GiB\nFree memory: 11.81GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:972] DMA: 0 \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 0:   Y \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX TITAN X, pci bus id: 0000:09:00.0)\nDIFFERENCE: -5.96046e-08\n</code></pre>", "body_text": "Hello,\nI am observing differing outputs from tf.nn.moments when I run it multiple times on the same data, using GPU.  This makes it difficult for me to replicate my learning process!  See the logs at the bottom for what I mean.  I would expect the difference between moments across runs on the same data to be zero, but that is not the case in the logs I attached below (and most of the times I run it).\nIf I run on CPU it is fine though.  Also, if I compute moments over smaller sets of data the problems seems to occur less often.\nNot sure what would be causing this, my guess would be some sort of numerical instability?  Help would be appreciated!\nWhat related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\nNone found, I discovered this issue when trying to get replicable results using batch_norm in contrib.\nEnvironment info\nOperating System: Ubuntu 14.04.5 LTS (running in a singularity container on a CentOS 6.7 host).\nInstalled version of CUDA and cuDNN:\nI am using CUDA 8.0 with NVIDIA driver 367.48, and cuDNN v5.1 .\n(please attach the output of ls -l /path/to/cuda/lib/libcud*):\nlibOpenCL.so\nlibOpenCL.so.1\nlibOpenCL.so.1.0\nlibOpenCL.so.1.0.0\nlibcublas.so\nlibcublas.so.8.0\nlibcublas.so.8.0.45\nlibcublas_device.a\nlibcublas_static.a\nlibcudadevrt.a\nlibcudart.so\nlibcudart.so.8.0\nlibcudart.so.8.0.44\nlibcudart_static.a\nlibcudnn.so\nlibcudnn.so.5\nlibcudnn.so.5.1.5\nlibcudnn_static.a\nlibcufft.so\nlibcufft.so.8.0\nlibcufft.so.8.0.44\nlibcufft_static.a\nlibcufftw.so\nlibcufftw.so.8.0\nlibcufftw.so.8.0.44\nlibcufftw_static.a\nlibcuinj64.so\nlibcuinj64.so.8.0\nlibcuinj64.so.8.0.44\nlibculibos.a\nlibcurand.so\nlibcurand.so.8.0\nlibcurand.so.8.0.44\nlibcurand_static.a\nlibcusolver.so\nlibcusolver.so.8.0\nlibcusolver.so.8.0.44\nlibcusolver_static.a\nlibcusparse.so\nlibcusparse.so.8.0\nlibcusparse.so.8.0.44\nlibcusparse_static.a\nlibnppc.so\nlibnppc.so.8.0\nlibnppc.so.8.0.44\nlibnppc_static.a\nlibnppi.so\nlibnppi.so.8.0\nlibnppi.so.8.0.44\nlibnppi_static.a\nlibnppial.so\nlibnppial.so.8.0\nlibnppial.so.8.0.44\nlibnppicc.so\nlibnppicc.so.8.0\nlibnppicc.so.8.0.44\nlibnppicom.so\nlibnppicom.so.8.0\nlibnppicom.so.8.0.44\nlibnppidei.so\nlibnppidei.so.8.0\nlibnppidei.so.8.0.44\nlibnppif.so\nlibnppif.so.8.0\nlibnppif.so.8.0.44\nlibnppig.so\nlibnppig.so.8.0\nlibnppig.so.8.0.44\nlibnppim.so\nlibnppim.so.8.0\nlibnppim.so.8.0.44\nlibnppist.so\nlibnppist.so.8.0\nlibnppist.so.8.0.44\nlibnppisu.so\nlibnppisu.so.8.0\nlibnppisu.so.8.0.44\nlibnppitc.so\nlibnppitc.so.8.0\nlibnppitc.so.8.0.44\nlibnpps.so\nlibnpps.so.8.0\nlibnpps.so.8.0.44\nlibnpps_static.a\nlibnvToolsExt.so\nlibnvToolsExt.so.1\nlibnvToolsExt.so.1.0.0\nlibnvblas.so\nlibnvblas.so.8.0\nlibnvblas.so.8.0.44\nlibnvgraph.so\nlibnvgraph.so.8.0\nlibnvgraph.so.8.0.44\nlibnvgraph_static.a\nlibnvrtc-builtins.so\nlibnvrtc-builtins.so.8.0\nlibnvrtc-builtins.so.8.0.44\nlibnvrtc.so\nlibnvrtc.so.8.0\nlibnvrtc.so.8.0.44\nstubs\n\nI installed tensorflow using the 0.11.0rc2-gpu tag on docker hub.\nIf possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\nimport numpy as np\nimport tensorflow as tf\n\nbatch_size = 2**10\nchannel_size = 100\n\nif __name__ == \"__main__\":\n\n    with tf.device('/gpu:0'):\n        x = tf.placeholder(tf.float32, shape=[None, channel_size],\n                           name='input')\n        mom = tf.nn.moments(x, [0])\n\n    feed_dict = {}\n    feed_dict['input:0'] = np.random.rand(batch_size, channel_size)\n\n    with tf.Session(config=tf.ConfigProto(allow_soft_placement=True)) as sess:\n        tf.initialize_all_variables().run()\n        [mom_out1] = sess.run([mom], feed_dict=feed_dict)\n        [mom_out2] = sess.run([mom], feed_dict=feed_dict)\n    print \"DIFFERENCE:\", mom_out1[0][0] - mom_out2[0][0]\n\nWhat other attempted solutions have you tried?\nNo other solutions tried.\nLogs or other output that would be helpful\nOutput of running my the code once:\nWARNING: Not mounting current directory: user bind control is disabled by system administrator\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcurand.so locally\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:951] Found device 0 with properties: \nname: GeForce GTX TITAN X\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\npciBusID 0000:09:00.0\nTotal memory: 11.92GiB\nFree memory: 11.81GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:972] DMA: 0 \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 0:   Y \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX TITAN X, pci bus id: 0000:09:00.0)\nDIFFERENCE: -5.96046e-08", "body": "Hello,\r\n\r\nI am observing differing outputs from tf.nn.moments when I run it multiple times on the same data, using GPU.  This makes it difficult for me to replicate my learning process!  See the logs at the bottom for what I mean.  I would expect the difference between moments across runs on the same data to be zero, but that is not the case in the logs I attached below (and most of the times I run it).  \r\n\r\nIf I run on CPU it is fine though.  Also, if I compute moments over smaller sets of data the problems seems to occur less often.\r\n\r\nNot sure what would be causing this, my guess would be some sort of numerical instability?  Help would be appreciated!\r\n\r\n### What related GitHub issues or StackOverflow threads have you found by searching the web for your problem?\r\n\r\nNone found, I discovered this issue when trying to get replicable results using batch_norm in contrib.\r\n\r\n### Environment info\r\nOperating System: Ubuntu 14.04.5 LTS (running in a [singularity](http://singularity.lbl.gov) container on a CentOS 6.7 host). \r\n\r\nInstalled version of CUDA and cuDNN: \r\nI am using CUDA 8.0 with NVIDIA driver 367.48, and cuDNN v5.1 . \r\n(please attach the output of `ls -l /path/to/cuda/lib/libcud*`):\r\n```\r\nlibOpenCL.so\r\nlibOpenCL.so.1\r\nlibOpenCL.so.1.0\r\nlibOpenCL.so.1.0.0\r\nlibcublas.so\r\nlibcublas.so.8.0\r\nlibcublas.so.8.0.45\r\nlibcublas_device.a\r\nlibcublas_static.a\r\nlibcudadevrt.a\r\nlibcudart.so\r\nlibcudart.so.8.0\r\nlibcudart.so.8.0.44\r\nlibcudart_static.a\r\nlibcudnn.so\r\nlibcudnn.so.5\r\nlibcudnn.so.5.1.5\r\nlibcudnn_static.a\r\nlibcufft.so\r\nlibcufft.so.8.0\r\nlibcufft.so.8.0.44\r\nlibcufft_static.a\r\nlibcufftw.so\r\nlibcufftw.so.8.0\r\nlibcufftw.so.8.0.44\r\nlibcufftw_static.a\r\nlibcuinj64.so\r\nlibcuinj64.so.8.0\r\nlibcuinj64.so.8.0.44\r\nlibculibos.a\r\nlibcurand.so\r\nlibcurand.so.8.0\r\nlibcurand.so.8.0.44\r\nlibcurand_static.a\r\nlibcusolver.so\r\nlibcusolver.so.8.0\r\nlibcusolver.so.8.0.44\r\nlibcusolver_static.a\r\nlibcusparse.so\r\nlibcusparse.so.8.0\r\nlibcusparse.so.8.0.44\r\nlibcusparse_static.a\r\nlibnppc.so\r\nlibnppc.so.8.0\r\nlibnppc.so.8.0.44\r\nlibnppc_static.a\r\nlibnppi.so\r\nlibnppi.so.8.0\r\nlibnppi.so.8.0.44\r\nlibnppi_static.a\r\nlibnppial.so\r\nlibnppial.so.8.0\r\nlibnppial.so.8.0.44\r\nlibnppicc.so\r\nlibnppicc.so.8.0\r\nlibnppicc.so.8.0.44\r\nlibnppicom.so\r\nlibnppicom.so.8.0\r\nlibnppicom.so.8.0.44\r\nlibnppidei.so\r\nlibnppidei.so.8.0\r\nlibnppidei.so.8.0.44\r\nlibnppif.so\r\nlibnppif.so.8.0\r\nlibnppif.so.8.0.44\r\nlibnppig.so\r\nlibnppig.so.8.0\r\nlibnppig.so.8.0.44\r\nlibnppim.so\r\nlibnppim.so.8.0\r\nlibnppim.so.8.0.44\r\nlibnppist.so\r\nlibnppist.so.8.0\r\nlibnppist.so.8.0.44\r\nlibnppisu.so\r\nlibnppisu.so.8.0\r\nlibnppisu.so.8.0.44\r\nlibnppitc.so\r\nlibnppitc.so.8.0\r\nlibnppitc.so.8.0.44\r\nlibnpps.so\r\nlibnpps.so.8.0\r\nlibnpps.so.8.0.44\r\nlibnpps_static.a\r\nlibnvToolsExt.so\r\nlibnvToolsExt.so.1\r\nlibnvToolsExt.so.1.0.0\r\nlibnvblas.so\r\nlibnvblas.so.8.0\r\nlibnvblas.so.8.0.44\r\nlibnvgraph.so\r\nlibnvgraph.so.8.0\r\nlibnvgraph.so.8.0.44\r\nlibnvgraph_static.a\r\nlibnvrtc-builtins.so\r\nlibnvrtc-builtins.so.8.0\r\nlibnvrtc-builtins.so.8.0.44\r\nlibnvrtc.so\r\nlibnvrtc.so.8.0\r\nlibnvrtc.so.8.0.44\r\nstubs\r\n```\r\n\r\nI installed tensorflow using the 0.11.0rc2-gpu tag on docker hub.\r\n\r\n### If possible, provide a minimal reproducible example (We usually don't have time to read hundreds of lines of your code)\r\n\r\n```\r\nimport numpy as np\r\nimport tensorflow as tf\r\n\r\nbatch_size = 2**10\r\nchannel_size = 100\r\n\r\nif __name__ == \"__main__\":\r\n\r\n    with tf.device('/gpu:0'):\r\n        x = tf.placeholder(tf.float32, shape=[None, channel_size],\r\n                           name='input')\r\n        mom = tf.nn.moments(x, [0])\r\n\r\n    feed_dict = {}\r\n    feed_dict['input:0'] = np.random.rand(batch_size, channel_size)\r\n\r\n    with tf.Session(config=tf.ConfigProto(allow_soft_placement=True)) as sess:\r\n        tf.initialize_all_variables().run()\r\n        [mom_out1] = sess.run([mom], feed_dict=feed_dict)\r\n        [mom_out2] = sess.run([mom], feed_dict=feed_dict)\r\n    print \"DIFFERENCE:\", mom_out1[0][0] - mom_out2[0][0]\r\n```\r\n\r\n### What other attempted solutions have you tried?\r\n\r\nNo other solutions tried.\r\n\r\n\r\n### Logs or other output that would be helpful\r\n\r\nOutput of running my the code once:\r\n```\r\nWARNING: Not mounting current directory: user bind control is disabled by system administrator\r\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcublas.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcudnn.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcufft.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcuda.so.1 locally\r\nI tensorflow/stream_executor/dso_loader.cc:111] successfully opened CUDA library libcurand.so locally\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:951] Found device 0 with properties: \r\nname: GeForce GTX TITAN X\r\nmajor: 5 minor: 2 memoryClockRate (GHz) 1.076\r\npciBusID 0000:09:00.0\r\nTotal memory: 11.92GiB\r\nFree memory: 11.81GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:972] DMA: 0 \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 0:   Y \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX TITAN X, pci bus id: 0000:09:00.0)\r\nDIFFERENCE: -5.96046e-08\r\n```"}