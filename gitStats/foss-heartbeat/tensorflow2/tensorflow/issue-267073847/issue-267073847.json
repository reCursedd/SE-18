{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13847", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13847/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13847/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13847/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13847", "id": 267073847, "node_id": "MDU6SXNzdWUyNjcwNzM4NDc=", "number": 13847, "title": "tf.train.batch and shuffle_batch undetermined for multi queue input with multiple threads", "user": {"login": "BastiaanBergman", "id": 478375, "node_id": "MDQ6VXNlcjQ3ODM3NQ==", "avatar_url": "https://avatars0.githubusercontent.com/u/478375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BastiaanBergman", "html_url": "https://github.com/BastiaanBergman", "followers_url": "https://api.github.com/users/BastiaanBergman/followers", "following_url": "https://api.github.com/users/BastiaanBergman/following{/other_user}", "gists_url": "https://api.github.com/users/BastiaanBergman/gists{/gist_id}", "starred_url": "https://api.github.com/users/BastiaanBergman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BastiaanBergman/subscriptions", "organizations_url": "https://api.github.com/users/BastiaanBergman/orgs", "repos_url": "https://api.github.com/users/BastiaanBergman/repos", "events_url": "https://api.github.com/users/BastiaanBergman/events{/privacy}", "received_events_url": "https://api.github.com/users/BastiaanBergman/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2017-10-20T06:18:06Z", "updated_at": "2017-12-12T16:40:20Z", "closed_at": "2017-12-12T16:40:20Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>\n<p><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<br>\nCustom code, see below.</p>\n</li>\n<li>\n<p><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nOSX</p>\n</li>\n<li>\n<p><strong>TensorFlow installed from (source or binary)</strong>:<br>\npip install tensorflow == 1.2</p>\n</li>\n<li>\n<p><strong>TensorFlow version (use command below)</strong>:<br>\n('v1.2.0-rc2-21-g12f033d', '1.2.0')</p>\n</li>\n<li>\n<p><strong>Python version</strong>:<br>\nPython 2.7.10</p>\n</li>\n<li>\n<p><strong>Bazel version (if compiling from source)</strong>:<br>\nn/a</p>\n</li>\n<li>\n<p><strong>CUDA/cuDNN version</strong>:<br>\nn/a</p>\n</li>\n<li>\n<p><strong>GPU model and memory</strong>:<br>\nn/a</p>\n</li>\n<li>\n<p><strong>Exact command to reproduce</strong>:</p>\n</li>\n</ul>\n<pre><code>a_fifo = tf.train.slice_input_producer([np.arange(30)],\n                                        shuffle=False,\n                                        name='a')[0]\nb_fifo = tf.train.slice_input_producer([np.arange(30)],\n                                        shuffle=False,\n                                        name='b')[0]\ntrain_batch = tf.train.batch([a_fifo, b_fifo],\n                            batch_size=5,\n                            capacity=18,\n                            num_threads=2,\n                            name='batch')\nat, bt = train_batch\nwith tf.Session() as sess:\n    threads = tf.train.start_queue_runners(sess=sess)\n    sess.run(tf.global_variables_initializer())\n    try:\n        for i in range(150):\n            av, bv = sess.run([at, bt])\n            assert list(av) == list(bv), \"queues derailed!\"\n    except Exception as e:\n        print((\"Exception in training: {}\").format(e))\n        print(\"__\",i,\"__\")\n        print(av)\n        print(bv)\n</code></pre>\n<p>Output:</p>\n<blockquote>\n<p>Exception in training: queues derailed!<br>\n__ 11 __<br>\n[26 25 27 28 29]<br>\n[25 26 27 28 29]</p>\n</blockquote>\n<h3>Describe the problem</h3>\n<p>Both queues should be dequeued synchronously, as it does when num_threads =1 in the batch statement. With num_threads &gt; 1 the two input queue's will derail, as shown in the example above. Same issue appears also in train.shuffle_batch.</p>\n<h3>Source code / logs</h3>\n<p>See code above.</p>", "body_text": "System information\n\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):\nCustom code, see below.\n\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nOSX\n\n\nTensorFlow installed from (source or binary):\npip install tensorflow == 1.2\n\n\nTensorFlow version (use command below):\n('v1.2.0-rc2-21-g12f033d', '1.2.0')\n\n\nPython version:\nPython 2.7.10\n\n\nBazel version (if compiling from source):\nn/a\n\n\nCUDA/cuDNN version:\nn/a\n\n\nGPU model and memory:\nn/a\n\n\nExact command to reproduce:\n\n\na_fifo = tf.train.slice_input_producer([np.arange(30)],\n                                        shuffle=False,\n                                        name='a')[0]\nb_fifo = tf.train.slice_input_producer([np.arange(30)],\n                                        shuffle=False,\n                                        name='b')[0]\ntrain_batch = tf.train.batch([a_fifo, b_fifo],\n                            batch_size=5,\n                            capacity=18,\n                            num_threads=2,\n                            name='batch')\nat, bt = train_batch\nwith tf.Session() as sess:\n    threads = tf.train.start_queue_runners(sess=sess)\n    sess.run(tf.global_variables_initializer())\n    try:\n        for i in range(150):\n            av, bv = sess.run([at, bt])\n            assert list(av) == list(bv), \"queues derailed!\"\n    except Exception as e:\n        print((\"Exception in training: {}\").format(e))\n        print(\"__\",i,\"__\")\n        print(av)\n        print(bv)\n\nOutput:\n\nException in training: queues derailed!\n__ 11 __\n[26 25 27 28 29]\n[25 26 27 28 29]\n\nDescribe the problem\nBoth queues should be dequeued synchronously, as it does when num_threads =1 in the batch statement. With num_threads > 1 the two input queue's will derail, as shown in the example above. Same issue appears also in train.shuffle_batch.\nSource code / logs\nSee code above.", "body": "\r\n### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:\r\nCustom code, see below.\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nOSX\r\n\r\n- **TensorFlow installed from (source or binary)**:\r\npip install tensorflow == 1.2\r\n\r\n- **TensorFlow version (use command below)**:\r\n('v1.2.0-rc2-21-g12f033d', '1.2.0')\r\n\r\n- **Python version**: \r\nPython 2.7.10\r\n\r\n- **Bazel version (if compiling from source)**:\r\nn/a\r\n\r\n- **CUDA/cuDNN version**:\r\nn/a\r\n\r\n- **GPU model and memory**:\r\nn/a\r\n\r\n- **Exact command to reproduce**:\r\n\r\n\r\n```\r\na_fifo = tf.train.slice_input_producer([np.arange(30)],\r\n                                        shuffle=False,\r\n                                        name='a')[0]\r\nb_fifo = tf.train.slice_input_producer([np.arange(30)],\r\n                                        shuffle=False,\r\n                                        name='b')[0]\r\ntrain_batch = tf.train.batch([a_fifo, b_fifo],\r\n                            batch_size=5,\r\n                            capacity=18,\r\n                            num_threads=2,\r\n                            name='batch')\r\nat, bt = train_batch\r\nwith tf.Session() as sess:\r\n    threads = tf.train.start_queue_runners(sess=sess)\r\n    sess.run(tf.global_variables_initializer())\r\n    try:\r\n        for i in range(150):\r\n            av, bv = sess.run([at, bt])\r\n            assert list(av) == list(bv), \"queues derailed!\"\r\n    except Exception as e:\r\n        print((\"Exception in training: {}\").format(e))\r\n        print(\"__\",i,\"__\")\r\n        print(av)\r\n        print(bv)\r\n```\r\n\r\nOutput:\r\n\r\n> Exception in training: queues derailed!\r\n> __ 11 __\r\n> [26 25 27 28 29]\r\n> [25 26 27 28 29]\r\n\r\n\r\n\r\n\r\n### Describe the problem\r\nBoth queues should be dequeued synchronously, as it does when num_threads =1 in the batch statement. With num_threads > 1 the two input queue's will derail, as shown in the example above. Same issue appears also in train.shuffle_batch.\r\n\r\n### Source code / logs\r\nSee code above."}