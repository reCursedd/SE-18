{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9978", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9978/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9978/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9978/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/9978", "id": 229441689, "node_id": "MDU6SXNzdWUyMjk0NDE2ODk=", "number": 9978, "title": "graph_editor.copy_with_input_replacements crashes for some orderings of inputs", "user": {"login": "yaroslavvb", "id": 23068, "node_id": "MDQ6VXNlcjIzMDY4", "avatar_url": "https://avatars3.githubusercontent.com/u/23068?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yaroslavvb", "html_url": "https://github.com/yaroslavvb", "followers_url": "https://api.github.com/users/yaroslavvb/followers", "following_url": "https://api.github.com/users/yaroslavvb/following{/other_user}", "gists_url": "https://api.github.com/users/yaroslavvb/gists{/gist_id}", "starred_url": "https://api.github.com/users/yaroslavvb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yaroslavvb/subscriptions", "organizations_url": "https://api.github.com/users/yaroslavvb/orgs", "repos_url": "https://api.github.com/users/yaroslavvb/repos", "events_url": "https://api.github.com/users/yaroslavvb/events{/privacy}", "received_events_url": "https://api.github.com/users/yaroslavvb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2017-05-17T18:07:30Z", "updated_at": "2018-01-24T13:36:09Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<p>Graph editor copy_with_input_replacements  visits nodes in order provided, and assumes that op referenced by \"op._original_op\" has already already been visited. When this assumption is false, it fails with KeyError inside transform.py</p>\n<p>Reproducible case</p>\n<pre><code>import tensorflow as tf\nimport numpy as np\nimport tensorflow.contrib.graph_editor as ge\n\nif __name__=='__main__':\n  params = tf.Variable(1, dtype=np.float32, name=\"params\")\n  temp = tf.reduce_sum(params, name=\"sum_temp\")\n  cost1 = tf.square(temp, name=\"cost1\")\n  gradients1 = tf.gradients([cost1], [params])\n  ops = tf.get_default_graph().get_operations()\n  ops = list(sorted(ops, key=lambda op: op.name))\n  copied_sgv, info = ge.copy_with_input_replacements(ge.sgv(ops), {})\n</code></pre>\n<p>It fails with following error</p>\n<pre><code>Traceback (most recent call last):\n  File \"graph_editor_test.py\", line 13, in &lt;module&gt;\n    copied_sgv, info = ge.copy_with_input_replacements(ge.sgv(ops), {})\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 620, in copy_with_input_replacements\n    sgv, dst_graph, dst_scope, src_scope, reuse_dst_scope=reuse_dst_scope)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 436, in __call__\n    self._copy_ops(info)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 450, in _copy_ops\n    op_, op_outputs_ = self.transform_op_handler(info, op)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 173, in copy_op_handler\n    original_op = info.transform_original_op_handler(info, op._original_op)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 125, in transform_op_if_inside_handler\n    return info.transformed_ops[op]\nKeyError: &lt;tf.Operation 'sum_temp' type=Sum&gt;\n</code></pre>\n<p>A work-around is to clear <code>_original_op</code> entries for all ops</p>\n<pre><code>def clear_original_ops(ops):\n  for op in ops:\n    op._original_op = None\n</code></pre>\n<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=724322\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/purpledog\">@purpledog</a></p>", "body_text": "Graph editor copy_with_input_replacements  visits nodes in order provided, and assumes that op referenced by \"op._original_op\" has already already been visited. When this assumption is false, it fails with KeyError inside transform.py\nReproducible case\nimport tensorflow as tf\nimport numpy as np\nimport tensorflow.contrib.graph_editor as ge\n\nif __name__=='__main__':\n  params = tf.Variable(1, dtype=np.float32, name=\"params\")\n  temp = tf.reduce_sum(params, name=\"sum_temp\")\n  cost1 = tf.square(temp, name=\"cost1\")\n  gradients1 = tf.gradients([cost1], [params])\n  ops = tf.get_default_graph().get_operations()\n  ops = list(sorted(ops, key=lambda op: op.name))\n  copied_sgv, info = ge.copy_with_input_replacements(ge.sgv(ops), {})\n\nIt fails with following error\nTraceback (most recent call last):\n  File \"graph_editor_test.py\", line 13, in <module>\n    copied_sgv, info = ge.copy_with_input_replacements(ge.sgv(ops), {})\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 620, in copy_with_input_replacements\n    sgv, dst_graph, dst_scope, src_scope, reuse_dst_scope=reuse_dst_scope)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 436, in __call__\n    self._copy_ops(info)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 450, in _copy_ops\n    op_, op_outputs_ = self.transform_op_handler(info, op)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 173, in copy_op_handler\n    original_op = info.transform_original_op_handler(info, op._original_op)\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 125, in transform_op_if_inside_handler\n    return info.transformed_ops[op]\nKeyError: <tf.Operation 'sum_temp' type=Sum>\n\nA work-around is to clear _original_op entries for all ops\ndef clear_original_ops(ops):\n  for op in ops:\n    op._original_op = None\n\n@purpledog", "body": "Graph editor copy_with_input_replacements  visits nodes in order provided, and assumes that op referenced by \"op._original_op\" has already already been visited. When this assumption is false, it fails with KeyError inside transform.py\r\n\r\nReproducible case\r\n\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\nimport tensorflow.contrib.graph_editor as ge\r\n\r\nif __name__=='__main__':\r\n  params = tf.Variable(1, dtype=np.float32, name=\"params\")\r\n  temp = tf.reduce_sum(params, name=\"sum_temp\")\r\n  cost1 = tf.square(temp, name=\"cost1\")\r\n  gradients1 = tf.gradients([cost1], [params])\r\n  ops = tf.get_default_graph().get_operations()\r\n  ops = list(sorted(ops, key=lambda op: op.name))\r\n  copied_sgv, info = ge.copy_with_input_replacements(ge.sgv(ops), {})\r\n```\r\nIt fails with following error\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"graph_editor_test.py\", line 13, in <module>\r\n    copied_sgv, info = ge.copy_with_input_replacements(ge.sgv(ops), {})\r\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 620, in copy_with_input_replacements\r\n    sgv, dst_graph, dst_scope, src_scope, reuse_dst_scope=reuse_dst_scope)\r\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 436, in __call__\r\n    self._copy_ops(info)\r\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 450, in _copy_ops\r\n    op_, op_outputs_ = self.transform_op_handler(info, op)\r\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 173, in copy_op_handler\r\n    original_op = info.transform_original_op_handler(info, op._original_op)\r\n  File \"/Users/yaroslav/anaconda/envs/memory/lib/python3.5/site-packages/tensorflow/contrib/graph_editor/transform.py\", line 125, in transform_op_if_inside_handler\r\n    return info.transformed_ops[op]\r\nKeyError: <tf.Operation 'sum_temp' type=Sum>\r\n```\r\n\r\nA work-around is to clear `_original_op` entries for all ops\r\n\r\n```\r\ndef clear_original_ops(ops):\r\n  for op in ops:\r\n    op._original_op = None\r\n```\r\n\r\n@purpledog "}