{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13849", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13849/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13849/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/13849/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/13849", "id": 267085960, "node_id": "MDU6SXNzdWUyNjcwODU5NjA=", "number": 13849, "title": "Feature request: only master is allowed to export for `tf.contrib.learn.Experiment`", "user": {"login": "facaiy", "id": 1112263, "node_id": "MDQ6VXNlcjExMTIyNjM=", "avatar_url": "https://avatars3.githubusercontent.com/u/1112263?v=4", "gravatar_id": "", "url": "https://api.github.com/users/facaiy", "html_url": "https://github.com/facaiy", "followers_url": "https://api.github.com/users/facaiy/followers", "following_url": "https://api.github.com/users/facaiy/following{/other_user}", "gists_url": "https://api.github.com/users/facaiy/gists{/gist_id}", "starred_url": "https://api.github.com/users/facaiy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/facaiy/subscriptions", "organizations_url": "https://api.github.com/users/facaiy/orgs", "repos_url": "https://api.github.com/users/facaiy/repos", "events_url": "https://api.github.com/users/facaiy/events{/privacy}", "received_events_url": "https://api.github.com/users/facaiy/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "xiejw", "id": 1184671, "node_id": "MDQ6VXNlcjExODQ2NzE=", "avatar_url": "https://avatars1.githubusercontent.com/u/1184671?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xiejw", "html_url": "https://github.com/xiejw", "followers_url": "https://api.github.com/users/xiejw/followers", "following_url": "https://api.github.com/users/xiejw/following{/other_user}", "gists_url": "https://api.github.com/users/xiejw/gists{/gist_id}", "starred_url": "https://api.github.com/users/xiejw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xiejw/subscriptions", "organizations_url": "https://api.github.com/users/xiejw/orgs", "repos_url": "https://api.github.com/users/xiejw/repos", "events_url": "https://api.github.com/users/xiejw/events{/privacy}", "received_events_url": "https://api.github.com/users/xiejw/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "xiejw", "id": 1184671, "node_id": "MDQ6VXNlcjExODQ2NzE=", "avatar_url": "https://avatars1.githubusercontent.com/u/1184671?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xiejw", "html_url": "https://github.com/xiejw", "followers_url": "https://api.github.com/users/xiejw/followers", "following_url": "https://api.github.com/users/xiejw/following{/other_user}", "gists_url": "https://api.github.com/users/xiejw/gists{/gist_id}", "starred_url": "https://api.github.com/users/xiejw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xiejw/subscriptions", "organizations_url": "https://api.github.com/users/xiejw/orgs", "repos_url": "https://api.github.com/users/xiejw/repos", "events_url": "https://api.github.com/users/xiejw/events{/privacy}", "received_events_url": "https://api.github.com/users/xiejw/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2017-10-20T07:27:05Z", "updated_at": "2017-10-27T01:09:59Z", "closed_at": "2017-10-27T01:09:59Z", "author_association": "MEMBER", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Mac 10.11.6</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.4.0-nightly, 1.3.0</li>\n<li><strong>Python version</strong>:  2.7</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A</li>\n<li><strong>Exact command to reproduce</strong>: N/A</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When using <code>tf.contrib.learn.Experiment</code> for distributed training, it seems that all workers, ps, and master try to export model when finished. However, this will cause write conflict when <code>model_dir</code> is on hdfs, because all write the same file to the same location.</p>\n<p>Hence, I propose that only master is allowed to export model.<br>\nI can work on it if tensorflowers're agreed.</p>\n<h3>Source code / logs</h3>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c1\">INFO</span>:tensorflow:Saving <span class=\"pl-c1\">dict</span> <span class=\"pl-k\">for</span> <span class=\"pl-k\">global</span> step <span class=\"pl-c1\">30</span>: accuracy <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0.339453</span>, global_step <span class=\"pl-k\">=</span> <span class=\"pl-c1\">30</span>, loss <span class=\"pl-k\">=</span> <span class=\"pl-c1\">70112.8</span>\nTraceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>main.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">60</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    tf.app.run()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/python/platform/app.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">48</span>, <span class=\"pl-k\">in</span> run\n    _sys.exit(main(_sys.argv[:<span class=\"pl-c1\">1</span>] <span class=\"pl-k\">+</span> flags_passthrough))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>main.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">56</span>, <span class=\"pl-k\">in</span> main\n    sess.run()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Workshop/sina/Prometheus/prometheus/python/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">172</span>, <span class=\"pl-k\">in</span> run\n    ex.train_and_evaluate()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/experiment.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">641</span>, <span class=\"pl-k\">in</span> train_and_evaluate\n    export_results <span class=\"pl-k\">=</span> <span class=\"pl-c1\">self</span>._maybe_export(eval_result)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/experiment.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">744</span>, <span class=\"pl-k\">in</span> _maybe_export\n    eval_result<span class=\"pl-k\">=</span>eval_result))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/export_strategy.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">87</span>, <span class=\"pl-k\">in</span> export\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">self</span>.export_fn(estimator, export_path, <span class=\"pl-k\">**</span>kwargs)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/utils/saved_model_export_utils.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">454</span>, <span class=\"pl-k\">in</span> export_fn\n    checkpoint_path<span class=\"pl-k\">=</span>checkpoint_path)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1307</span>, <span class=\"pl-k\">in</span> export_savedmodel\n    builder <span class=\"pl-k\">=</span> saved_model_builder.SavedModelBuilder(temp_export_dir)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/python/saved_model/builder_impl.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">88</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__init__</span>\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>directory: %s<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">%</span> export_dir)\n<span class=\"pl-c1\">AssertionError</span>: Export directory already exists. Please specify a different export directory: <span class=\"pl-v\">file</span>:<span class=\"pl-k\">///</span>tmp<span class=\"pl-k\">/</span>facai<span class=\"pl-k\">/</span>prome<span class=\"pl-k\">/</span>model<span class=\"pl-k\">/</span>new<span class=\"pl-k\">/</span>export<span class=\"pl-k\">/</span>Servo<span class=\"pl-k\">/</span>temp<span class=\"pl-k\">-</span><span class=\"pl-c1\">1508482645</span></pre></div>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Mac 10.11.6\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): 1.4.0-nightly, 1.3.0\nPython version:  2.7\nBazel version (if compiling from source): N/A\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A\nExact command to reproduce: N/A\n\nDescribe the problem\nWhen using tf.contrib.learn.Experiment for distributed training, it seems that all workers, ps, and master try to export model when finished. However, this will cause write conflict when model_dir is on hdfs, because all write the same file to the same location.\nHence, I propose that only master is allowed to export model.\nI can work on it if tensorflowers're agreed.\nSource code / logs\nINFO:tensorflow:Saving dict for global step 30: accuracy = 0.339453, global_step = 30, loss = 70112.8\nTraceback (most recent call last):\n  File \"main.py\", line 60, in <module>\n    tf.app.run()\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 48, in run\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\n  File \"main.py\", line 56, in main\n    sess.run()\n  File \"/Users/facai/Workshop/sina/Prometheus/prometheus/python/session.py\", line 172, in run\n    ex.train_and_evaluate()\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 641, in train_and_evaluate\n    export_results = self._maybe_export(eval_result)\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 744, in _maybe_export\n    eval_result=eval_result))\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/export_strategy.py\", line 87, in export\n    return self.export_fn(estimator, export_path, **kwargs)\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/utils/saved_model_export_utils.py\", line 454, in export_fn\n    checkpoint_path=checkpoint_path)\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1307, in export_savedmodel\n    builder = saved_model_builder.SavedModelBuilder(temp_export_dir)\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/python/saved_model/builder_impl.py\", line 88, in __init__\n    \"directory: %s\" % export_dir)\nAssertionError: Export directory already exists. Please specify a different export directory: file:///tmp/facai/prome/model/new/export/Servo/temp-1508482645", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac 10.11.6\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: 1.4.0-nightly, 1.3.0\r\n- **Python version**:  2.7\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Exact command to reproduce**: N/A\r\n\r\n### Describe the problem\r\n\r\nWhen using `tf.contrib.learn.Experiment` for distributed training, it seems that all workers, ps, and master try to export model when finished. However, this will cause write conflict when `model_dir` is on hdfs, because all write the same file to the same location.\r\n\r\nHence, I propose that only master is allowed to export model.\r\nI can work on it if tensorflowers're agreed.\r\n\r\n### Source code / logs\r\n\r\n```python\r\nINFO:tensorflow:Saving dict for global step 30: accuracy = 0.339453, global_step = 30, loss = 70112.8\r\nTraceback (most recent call last):\r\n  File \"main.py\", line 60, in <module>\r\n    tf.app.run()\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/python/platform/app.py\", line 48, in run\r\n    _sys.exit(main(_sys.argv[:1] + flags_passthrough))\r\n  File \"main.py\", line 56, in main\r\n    sess.run()\r\n  File \"/Users/facai/Workshop/sina/Prometheus/prometheus/python/session.py\", line 172, in run\r\n    ex.train_and_evaluate()\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 641, in train_and_evaluate\r\n    export_results = self._maybe_export(eval_result)\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/experiment.py\", line 744, in _maybe_export\r\n    eval_result=eval_result))\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/export_strategy.py\", line 87, in export\r\n    return self.export_fn(estimator, export_path, **kwargs)\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/utils/saved_model_export_utils.py\", line 454, in export_fn\r\n    checkpoint_path=checkpoint_path)\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1307, in export_savedmodel\r\n    builder = saved_model_builder.SavedModelBuilder(temp_export_dir)\r\n  File \"/Users/facai/Library/anaconda3/envs/py27_test/lib/python2.7/site-packages/tensorflow/python/saved_model/builder_impl.py\", line 88, in __init__\r\n    \"directory: %s\" % export_dir)\r\nAssertionError: Export directory already exists. Please specify a different export directory: file:///tmp/facai/prome/model/new/export/Servo/temp-1508482645\r\n```\r\n"}