{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/361835192", "html_url": "https://github.com/tensorflow/tensorflow/issues/15425#issuecomment-361835192", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15425", "id": 361835192, "node_id": "MDEyOklzc3VlQ29tbWVudDM2MTgzNTE5Mg==", "user": {"login": "benbarsdell", "id": 3979096, "node_id": "MDQ6VXNlcjM5NzkwOTY=", "avatar_url": "https://avatars2.githubusercontent.com/u/3979096?v=4", "gravatar_id": "", "url": "https://api.github.com/users/benbarsdell", "html_url": "https://github.com/benbarsdell", "followers_url": "https://api.github.com/users/benbarsdell/followers", "following_url": "https://api.github.com/users/benbarsdell/following{/other_user}", "gists_url": "https://api.github.com/users/benbarsdell/gists{/gist_id}", "starred_url": "https://api.github.com/users/benbarsdell/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/benbarsdell/subscriptions", "organizations_url": "https://api.github.com/users/benbarsdell/orgs", "repos_url": "https://api.github.com/users/benbarsdell/repos", "events_url": "https://api.github.com/users/benbarsdell/events{/privacy}", "received_events_url": "https://api.github.com/users/benbarsdell/received_events", "type": "User", "site_admin": false}, "created_at": "2018-01-31T06:16:48Z", "updated_at": "2018-01-31T06:16:48Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I've run into this UnimplementedError as well with 1.5. A small repro:</p>\n<pre><code>import tensorflow as tf\nimport tensorflow.contrib.nccl as nccl\n\nif __name__ == '__main__':\n    devices = ['/gpu:0', '/gpu:0']\n    with tf.device(devices[0]):\n        data0 = tf.constant([1.1, 2.2, 3.3, 4.4])\n        received_tensor = nccl.broadcast(data0)\n    received_tensors = []\n    for device in devices[1:]:\n        with tf.device(device):\n            received_tensors.append(tf.identity(received_tensor))\n    sess = tf.Session()\n    sess.run(received_tensors)\n</code></pre>\n<p>It looks like the registration of the optimization pass at this line never happens:</p>\n<p><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/bf1fad214febef6af5c101d8f953d0109c46dfbb/tensorflow/contrib/nccl/kernels/nccl_rewrite.cc#L270\">tensorflow/tensorflow/contrib/nccl/kernels/nccl_rewrite.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 270\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/bf1fad214febef6af5c101d8f953d0109c46dfbb\">bf1fad2</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L270\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"270\"></td>\n          <td id=\"LC270\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-en\">REGISTER_OPTIMIZATION</span>(OptimizationPassRegistry::POST_PLACEMENT, <span class=\"pl-c1\">0</span>, </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p>This may be because _nccl_ops.so doesn't include kernels/nccl_rewrite.cc:</p>\n<p><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/bf1fad214febef6af5c101d8f953d0109c46dfbb/tensorflow/contrib/nccl/BUILD#L24\">tensorflow/tensorflow/contrib/nccl/BUILD</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 24\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/bf1fad214febef6af5c101d8f953d0109c46dfbb\">bf1fad2</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L24\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"24\"></td>\n          <td id=\"LC24\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-v\">name</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>python/ops/_nccl_ops.so<span class=\"pl-pds\">\"</span></span>, </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p>Unfortunately Bazel throws a fit when I try to add the source file to this target.</p>", "body_text": "I've run into this UnimplementedError as well with 1.5. A small repro:\nimport tensorflow as tf\nimport tensorflow.contrib.nccl as nccl\n\nif __name__ == '__main__':\n    devices = ['/gpu:0', '/gpu:0']\n    with tf.device(devices[0]):\n        data0 = tf.constant([1.1, 2.2, 3.3, 4.4])\n        received_tensor = nccl.broadcast(data0)\n    received_tensors = []\n    for device in devices[1:]:\n        with tf.device(device):\n            received_tensors.append(tf.identity(received_tensor))\n    sess = tf.Session()\n    sess.run(received_tensors)\n\nIt looks like the registration of the optimization pass at this line never happens:\n\n  \n    \n      tensorflow/tensorflow/contrib/nccl/kernels/nccl_rewrite.cc\n    \n    \n         Line 270\n      in\n      bf1fad2\n    \n    \n    \n    \n\n        \n          \n           REGISTER_OPTIMIZATION(OptimizationPassRegistry::POST_PLACEMENT, 0, \n        \n    \n  \n\n\nThis may be because _nccl_ops.so doesn't include kernels/nccl_rewrite.cc:\n\n  \n    \n      tensorflow/tensorflow/contrib/nccl/BUILD\n    \n    \n         Line 24\n      in\n      bf1fad2\n    \n    \n    \n    \n\n        \n          \n           name = \"python/ops/_nccl_ops.so\", \n        \n    \n  \n\n\nUnfortunately Bazel throws a fit when I try to add the source file to this target.", "body": "I've run into this UnimplementedError as well with 1.5. A small repro:\r\n```\r\nimport tensorflow as tf\r\nimport tensorflow.contrib.nccl as nccl\r\n\r\nif __name__ == '__main__':\r\n    devices = ['/gpu:0', '/gpu:0']\r\n    with tf.device(devices[0]):\r\n        data0 = tf.constant([1.1, 2.2, 3.3, 4.4])\r\n        received_tensor = nccl.broadcast(data0)\r\n    received_tensors = []\r\n    for device in devices[1:]:\r\n        with tf.device(device):\r\n            received_tensors.append(tf.identity(received_tensor))\r\n    sess = tf.Session()\r\n    sess.run(received_tensors)\r\n```\r\n\r\nIt looks like the registration of the optimization pass at this line never happens:\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/bf1fad214febef6af5c101d8f953d0109c46dfbb/tensorflow/contrib/nccl/kernels/nccl_rewrite.cc#L270\r\n\r\nThis may be because _nccl_ops.so doesn't include kernels/nccl_rewrite.cc:\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/bf1fad214febef6af5c101d8f953d0109c46dfbb/tensorflow/contrib/nccl/BUILD#L24\r\n\r\nUnfortunately Bazel throws a fit when I try to add the source file to this target."}