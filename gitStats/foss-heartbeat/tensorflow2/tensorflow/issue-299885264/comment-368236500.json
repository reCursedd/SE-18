{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/368236500", "html_url": "https://github.com/tensorflow/tensorflow/issues/17233#issuecomment-368236500", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17233", "id": 368236500, "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODIzNjUwMA==", "user": {"login": "eamartin", "id": 287200, "node_id": "MDQ6VXNlcjI4NzIwMA==", "avatar_url": "https://avatars2.githubusercontent.com/u/287200?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eamartin", "html_url": "https://github.com/eamartin", "followers_url": "https://api.github.com/users/eamartin/followers", "following_url": "https://api.github.com/users/eamartin/following{/other_user}", "gists_url": "https://api.github.com/users/eamartin/gists{/gist_id}", "starred_url": "https://api.github.com/users/eamartin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eamartin/subscriptions", "organizations_url": "https://api.github.com/users/eamartin/orgs", "repos_url": "https://api.github.com/users/eamartin/repos", "events_url": "https://api.github.com/users/eamartin/events{/privacy}", "received_events_url": "https://api.github.com/users/eamartin/received_events", "type": "User", "site_admin": false}, "created_at": "2018-02-24T15:35:49Z", "updated_at": "2018-02-24T15:39:26Z", "author_association": "NONE", "body_html": "<p>I suspect an extra memcpy is the cause. The slowdown is 45ms, and 100MB/45ms = 2.2GB/s. This is about the throughput of a memcpy that causes a lot of pagefaults.</p>\n<div class=\"highlight highlight-source-python\"><pre>In [<span class=\"pl-c1\">5</span>]: x <span class=\"pl-k\">=</span> np.ones(<span class=\"pl-c1\">100</span> <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1</span> <span class=\"pl-k\">&lt;&lt;</span> <span class=\"pl-c1\">20</span>, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>np.uint8)\n\nIn [<span class=\"pl-c1\">6</span>]: <span class=\"pl-k\">%</span>time y <span class=\"pl-k\">=</span> np.copy(x)\n<span class=\"pl-c1\">CPU</span> times: user <span class=\"pl-c1\">32</span> ms, sys: <span class=\"pl-c1\">8</span> ms, total: <span class=\"pl-c1\">40</span> ms\nWall time: <span class=\"pl-c1\">36.9</span> ms</pre></div>\n<p>GIven this, I suspect the TF changes caused an additional memcpy on feed. The memcpy theory can be further tested by running <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=23068\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/yaroslavvb\">@yaroslavvb</a> 's test at 200MB instead of 100MB. If slowdown roughly doubles to 90ms, strong indicator that memcpy (or at least something that touches every fed byte) is the source of slowdown.</p>\n<p>Good catch <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=23068\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/yaroslavvb\">@yaroslavvb</a> !</p>", "body_text": "I suspect an extra memcpy is the cause. The slowdown is 45ms, and 100MB/45ms = 2.2GB/s. This is about the throughput of a memcpy that causes a lot of pagefaults.\nIn [5]: x = np.ones(100 * 1 << 20, dtype=np.uint8)\n\nIn [6]: %time y = np.copy(x)\nCPU times: user 32 ms, sys: 8 ms, total: 40 ms\nWall time: 36.9 ms\nGIven this, I suspect the TF changes caused an additional memcpy on feed. The memcpy theory can be further tested by running @yaroslavvb 's test at 200MB instead of 100MB. If slowdown roughly doubles to 90ms, strong indicator that memcpy (or at least something that touches every fed byte) is the source of slowdown.\nGood catch @yaroslavvb !", "body": "I suspect an extra memcpy is the cause. The slowdown is 45ms, and 100MB/45ms = 2.2GB/s. This is about the throughput of a memcpy that causes a lot of pagefaults.\r\n\r\n```python\r\nIn [5]: x = np.ones(100 * 1 << 20, dtype=np.uint8)\r\n\r\nIn [6]: %time y = np.copy(x)\r\nCPU times: user 32 ms, sys: 8 ms, total: 40 ms\r\nWall time: 36.9 ms\r\n```\r\n\r\nGIven this, I suspect the TF changes caused an additional memcpy on feed. The memcpy theory can be further tested by running @yaroslavvb 's test at 200MB instead of 100MB. If slowdown roughly doubles to 90ms, strong indicator that memcpy (or at least something that touches every fed byte) is the source of slowdown.\r\n\r\nGood catch @yaroslavvb !"}