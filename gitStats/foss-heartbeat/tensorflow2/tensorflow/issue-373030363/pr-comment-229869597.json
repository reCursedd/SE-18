{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/229869597", "pull_request_review_id": 170474537, "id": 229869597, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyOTg2OTU5Nw==", "diff_hunk": "@@ -398,8 +398,13 @@ Status GrpcServer::Stop() {\n       state_ = STOPPED;\n       return Status::OK();\n     case STARTED:\n-      return errors::Unimplemented(\n-          \"Clean shutdown is not currently implemented\");\n+      server_->Shutdown();\n+      master_service_->Shutdown();\n+      worker_service_->Shutdown();\n+      eager_service_->Shutdown();\n+      state_ = STOPPED;\n+      LOG(INFO) << \"Server stopped (target: \" << target() << \")\";\n+      return Status::OK();", "path": "tensorflow/core/distributed_runtime/rpc/grpc_server_lib.cc", "position": 12, "original_position": 12, "commit_id": "56576ad348dfb5a858864e95e87434e514693c81", "original_commit_id": "d7d33062ad24afa008962559c834a8b5eda83612", "user": {"login": "poxvoculi", "id": 15676913, "node_id": "MDQ6VXNlcjE1Njc2OTEz", "avatar_url": "https://avatars2.githubusercontent.com/u/15676913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/poxvoculi", "html_url": "https://github.com/poxvoculi", "followers_url": "https://api.github.com/users/poxvoculi/followers", "following_url": "https://api.github.com/users/poxvoculi/following{/other_user}", "gists_url": "https://api.github.com/users/poxvoculi/gists{/gist_id}", "starred_url": "https://api.github.com/users/poxvoculi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/poxvoculi/subscriptions", "organizations_url": "https://api.github.com/users/poxvoculi/orgs", "repos_url": "https://api.github.com/users/poxvoculi/repos", "events_url": "https://api.github.com/users/poxvoculi/events{/privacy}", "received_events_url": "https://api.github.com/users/poxvoculi/received_events", "type": "User", "site_admin": false}, "body": "I am not familiar with Apache Ignite.  I looked at a little bit of documentation but don't have time to look into it deeply.  We need to be clear about what 'process' means.  Do you want to kill and restart a gRPC server in the same linux process?  Or does Ignite actually kill the linux process and start a new one to bring up the new server Node?  This is an important question because TF has some per-process objects which will persist in the process between server instances, if you really try to restart in the same process.  The main example is memory allocators (see https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/process_state.h).  This could have strange effects.\r\n\r\nBack to your requirements.  I'm guessing that you want Ignite to completely clean up old server instances and create new instances with no prior state.  If that's true, can Ignite not destroy the descendant process in which the old server is running (without waiting for the server to terminate) and create a new one in a new process?\r\n\r\nIf it's a high enough priority we should be able to make gRPC servers shut down cleanly, but until we try to do it, it's hard to say what kind of problems we might discover.\r\n\r\n", "created_at": "2018-10-31T21:11:40Z", "updated_at": "2018-10-31T21:11:41Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/23190#discussion_r229869597", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/23190", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/229869597"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/23190#discussion_r229869597"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/23190"}}, "body_html": "<p>I am not familiar with Apache Ignite.  I looked at a little bit of documentation but don't have time to look into it deeply.  We need to be clear about what 'process' means.  Do you want to kill and restart a gRPC server in the same linux process?  Or does Ignite actually kill the linux process and start a new one to bring up the new server Node?  This is an important question because TF has some per-process objects which will persist in the process between server instances, if you really try to restart in the same process.  The main example is memory allocators (see <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/process_state.h\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/process_state.h</a>).  This could have strange effects.</p>\n<p>Back to your requirements.  I'm guessing that you want Ignite to completely clean up old server instances and create new instances with no prior state.  If that's true, can Ignite not destroy the descendant process in which the old server is running (without waiting for the server to terminate) and create a new one in a new process?</p>\n<p>If it's a high enough priority we should be able to make gRPC servers shut down cleanly, but until we try to do it, it's hard to say what kind of problems we might discover.</p>", "body_text": "I am not familiar with Apache Ignite.  I looked at a little bit of documentation but don't have time to look into it deeply.  We need to be clear about what 'process' means.  Do you want to kill and restart a gRPC server in the same linux process?  Or does Ignite actually kill the linux process and start a new one to bring up the new server Node?  This is an important question because TF has some per-process objects which will persist in the process between server instances, if you really try to restart in the same process.  The main example is memory allocators (see https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/common_runtime/process_state.h).  This could have strange effects.\nBack to your requirements.  I'm guessing that you want Ignite to completely clean up old server instances and create new instances with no prior state.  If that's true, can Ignite not destroy the descendant process in which the old server is running (without waiting for the server to terminate) and create a new one in a new process?\nIf it's a high enough priority we should be able to make gRPC servers shut down cleanly, but until we try to do it, it's hard to say what kind of problems we might discover.", "in_reply_to_id": 227438700}