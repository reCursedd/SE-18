{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6568", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6568/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6568/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6568/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6568", "id": 198080661, "node_id": "MDU6SXNzdWUxOTgwODA2NjE=", "number": 6568, "title": "Get rid of setdlopen() in tests", "user": {"login": "jart", "id": 49262, "node_id": "MDQ6VXNlcjQ5MjYy", "avatar_url": "https://avatars1.githubusercontent.com/u/49262?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jart", "html_url": "https://github.com/jart", "followers_url": "https://api.github.com/users/jart/followers", "following_url": "https://api.github.com/users/jart/following{/other_user}", "gists_url": "https://api.github.com/users/jart/gists{/gist_id}", "starred_url": "https://api.github.com/users/jart/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jart/subscriptions", "organizations_url": "https://api.github.com/users/jart/orgs", "repos_url": "https://api.github.com/users/jart/repos", "events_url": "https://api.github.com/users/jart/events{/privacy}", "received_events_url": "https://api.github.com/users/jart/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473173351, "node_id": "MDU6TGFiZWw0NzMxNzMzNTE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:build/install", "name": "type:build/install", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2016-12-29T22:52:58Z", "updated_at": "2017-11-03T09:45:01Z", "closed_at": "2017-03-01T22:34:34Z", "author_association": "MEMBER", "body_html": "<p>We need to find a new strategy for loading <code>.so</code> files at runtime that depend on other <code>.so</code> files. This is so we can remove the dlopen hack, which is now present in &gt;100 files.</p>\n<p>The solution needs to meet the requirement that each .py file fully specifies its dependencies and does not rely on code in <code>__init__.py</code> files to run beforehand. This requirement is necessary in order to maintain the work we've done to: a) remove hourglass imports so affected tests can be calculated better; and b) so Python modules can be loaded lazily like Java.</p>\n<h2>Background</h2>\n<p>We've refactored TensorFlow to remove hourglass imports in <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/5866e065bc95c1d7de8a27413b368016941889a6/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/5866e065bc95c1d7de8a27413b368016941889a6\"><tt>5866e06</tt></a>, <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/58201a058853de647b37ddb0ccf63d89b2357f03/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/58201a058853de647b37ddb0ccf63d89b2357f03\"><tt>58201a0</tt></a>, etc. Since tests no longer depend on the master <code>__init__.py</code> file, we've needed to add code like this to the tops of _test.py files that load custom ops defined by contrib libraries:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> sys\n\n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">hasattr</span>(sys, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>getdlopenflags<span class=\"pl-pds\">\"</span></span>) <span class=\"pl-k\">and</span> <span class=\"pl-c1\">hasattr</span>(sys, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>setdlopenflags<span class=\"pl-pds\">\"</span></span>):\n  <span class=\"pl-k\">import</span> ctypes\n  sys.setdlopenflags(sys.getdlopenflags() <span class=\"pl-k\">|</span> ctypes.<span class=\"pl-c1\">RTLD_GLOBAL</span>)\n\n<span class=\"pl-k\">from</span> google3.third_party.tensorflow.contrib.rnn.python.ops <span class=\"pl-k\">import</span> core_rnn_cell_impl\n<span class=\"pl-k\">from</span> google3.third_party.tensorflow.python.framework <span class=\"pl-k\">import</span> ops\n<span class=\"pl-c1\">...</span></pre></div>\n<p>Otherwise we get errors like <code>undefined symbol: _ZTIN10tensorflow8OpKernelE</code> e.g.</p>\n<pre><code>Traceback (most recent call last):\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.py\", line 26, in &lt;module&gt;\n    from tensorflow.contrib.slim.python.slim.nets import inception_v2\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/slim/python/slim/nets/inception_v2.py\", line 21, in &lt;module&gt;\n    from tensorflow.contrib import layers\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/__init__.py\", line 118, in &lt;module&gt;\n    from tensorflow.contrib.layers.python.layers import *\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/layers/__init__.py\", line 22, in &lt;module&gt;\n    from tensorflow.contrib.layers.python.layers.embedding_ops import *\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/layers/embedding_ops.py\", line 21, in &lt;module&gt;\n    from tensorflow.contrib.layers.python.ops import sparse_feature_cross_op\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/ops/sparse_feature_cross_op.py\", line 31, in &lt;module&gt;\n    resource_loader.get_path_to_datafile(\"_sparse_feature_cross_op.so\"))\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/util/loader.py\", line 42, in load_op_library\n    ret = load_library.load_op_library(path)\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/python/framework/load_library.py\", line 64, in load_op_library\n    None, None, error_msg, error_code)\ntensorflow.python.framework.errors_impl.NotFoundError: bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/ops/_sparse_feature_cross_op.so: undefined symbol: _ZTIN10tensorflow8OpKernelE\n</code></pre>\n<p>CC: <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=7946809\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/gunan\">@gunan</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=577277\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/martinwicke\">@martinwicke</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1192265\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/yifeif\">@yifeif</a></p>", "body_text": "We need to find a new strategy for loading .so files at runtime that depend on other .so files. This is so we can remove the dlopen hack, which is now present in >100 files.\nThe solution needs to meet the requirement that each .py file fully specifies its dependencies and does not rely on code in __init__.py files to run beforehand. This requirement is necessary in order to maintain the work we've done to: a) remove hourglass imports so affected tests can be calculated better; and b) so Python modules can be loaded lazily like Java.\nBackground\nWe've refactored TensorFlow to remove hourglass imports in 5866e06, 58201a0, etc. Since tests no longer depend on the master __init__.py file, we've needed to add code like this to the tops of _test.py files that load custom ops defined by contrib libraries:\nimport sys\n\nif hasattr(sys, \"getdlopenflags\") and hasattr(sys, \"setdlopenflags\"):\n  import ctypes\n  sys.setdlopenflags(sys.getdlopenflags() | ctypes.RTLD_GLOBAL)\n\nfrom google3.third_party.tensorflow.contrib.rnn.python.ops import core_rnn_cell_impl\nfrom google3.third_party.tensorflow.python.framework import ops\n...\nOtherwise we get errors like undefined symbol: _ZTIN10tensorflow8OpKernelE e.g.\nTraceback (most recent call last):\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.py\", line 26, in <module>\n    from tensorflow.contrib.slim.python.slim.nets import inception_v2\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/slim/python/slim/nets/inception_v2.py\", line 21, in <module>\n    from tensorflow.contrib import layers\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/__init__.py\", line 118, in <module>\n    from tensorflow.contrib.layers.python.layers import *\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/layers/__init__.py\", line 22, in <module>\n    from tensorflow.contrib.layers.python.layers.embedding_ops import *\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/layers/embedding_ops.py\", line 21, in <module>\n    from tensorflow.contrib.layers.python.ops import sparse_feature_cross_op\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/ops/sparse_feature_cross_op.py\", line 31, in <module>\n    resource_loader.get_path_to_datafile(\"_sparse_feature_cross_op.so\"))\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/util/loader.py\", line 42, in load_op_library\n    ret = load_library.load_op_library(path)\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/python/framework/load_library.py\", line 64, in load_op_library\n    None, None, error_msg, error_code)\ntensorflow.python.framework.errors_impl.NotFoundError: bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/ops/_sparse_feature_cross_op.so: undefined symbol: _ZTIN10tensorflow8OpKernelE\n\nCC: @gunan @martinwicke @yifeif", "body": "We need to find a new strategy for loading `.so` files at runtime that depend on other `.so` files. This is so we can remove the dlopen hack, which is now present in >100 files.\r\n\r\nThe solution needs to meet the requirement that each .py file fully specifies its dependencies and does not rely on code in `__init__.py` files to run beforehand. This requirement is necessary in order to maintain the work we've done to: a) remove hourglass imports so affected tests can be calculated better; and b) so Python modules can be loaded lazily like Java.\r\n\r\n## Background\r\n\r\nWe've refactored TensorFlow to remove hourglass imports in https://github.com/tensorflow/tensorflow/commit/5866e065bc95c1d7de8a27413b368016941889a6, https://github.com/tensorflow/tensorflow/commit/58201a058853de647b37ddb0ccf63d89b2357f03, etc. Since tests no longer depend on the master `__init__.py` file, we've needed to add code like this to the tops of _test.py files that load custom ops defined by contrib libraries:\r\n\r\n```python\r\nimport sys\r\n\r\nif hasattr(sys, \"getdlopenflags\") and hasattr(sys, \"setdlopenflags\"):\r\n  import ctypes\r\n  sys.setdlopenflags(sys.getdlopenflags() | ctypes.RTLD_GLOBAL)\r\n\r\nfrom google3.third_party.tensorflow.contrib.rnn.python.ops import core_rnn_cell_impl\r\nfrom google3.third_party.tensorflow.python.framework import ops\r\n...\r\n```\r\n\r\nOtherwise we get errors like `undefined symbol: _ZTIN10tensorflow8OpKernelE` e.g.\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.py\", line 26, in <module>\r\n    from tensorflow.contrib.slim.python.slim.nets import inception_v2\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/slim/python/slim/nets/inception_v2.py\", line 21, in <module>\r\n    from tensorflow.contrib import layers\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/__init__.py\", line 118, in <module>\r\n    from tensorflow.contrib.layers.python.layers import *\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/layers/__init__.py\", line 22, in <module>\r\n    from tensorflow.contrib.layers.python.layers.embedding_ops import *\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/layers/embedding_ops.py\", line 21, in <module>\r\n    from tensorflow.contrib.layers.python.ops import sparse_feature_cross_op\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/ops/sparse_feature_cross_op.py\", line 31, in <module>\r\n    resource_loader.get_path_to_datafile(\"_sparse_feature_cross_op.so\"))\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/util/loader.py\", line 42, in load_op_library\r\n    ret = load_library.load_op_library(path)\r\n  File \"bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/python/framework/load_library.py\", line 64, in load_op_library\r\n    None, None, error_msg, error_code)\r\ntensorflow.python.framework.errors_impl.NotFoundError: bazel-out/local-fastbuild/bin/tensorflow/contrib/slim/python/slim/nets/inception_v2_test.runfiles/org_tensorflow/tensorflow/contrib/layers/python/ops/_sparse_feature_cross_op.so: undefined symbol: _ZTIN10tensorflow8OpKernelE\r\n```\r\n\r\nCC: @gunan @martinwicke @yifeif "}