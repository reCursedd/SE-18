{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12648", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12648/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12648/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12648/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/12648", "id": 253285905, "node_id": "MDU6SXNzdWUyNTMyODU5MDU=", "number": 12648, "title": "Variable in Dataset map function is not stably initialized", "user": {"login": "llvim", "id": 7426917, "node_id": "MDQ6VXNlcjc0MjY5MTc=", "avatar_url": "https://avatars1.githubusercontent.com/u/7426917?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llvim", "html_url": "https://github.com/llvim", "followers_url": "https://api.github.com/users/llvim/followers", "following_url": "https://api.github.com/users/llvim/following{/other_user}", "gists_url": "https://api.github.com/users/llvim/gists{/gist_id}", "starred_url": "https://api.github.com/users/llvim/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llvim/subscriptions", "organizations_url": "https://api.github.com/users/llvim/orgs", "repos_url": "https://api.github.com/users/llvim/repos", "events_url": "https://api.github.com/users/llvim/events{/privacy}", "received_events_url": "https://api.github.com/users/llvim/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2017-08-28T10:14:12Z", "updated_at": "2017-08-29T01:48:00Z", "closed_at": "2017-08-28T17:44:53Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:NO</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:macos</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:source</li>\n<li><strong>TensorFlow version (use command below)</strong>:1.3</li>\n<li><strong>Python version</strong>: 3.6</li>\n<li><strong>Bazel version (if compiling from source)</strong>:0.5.3-homebrew</li>\n<li><strong>CUDA/cuDNN version</strong>:NO</li>\n<li><strong>GPU model and memory</strong>:</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>unable to init variable in map, flatmap, fillter function of Dataset API</p>\n<h3>Source code / logs</h3>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span>  tf\n<span class=\"pl-k\">from</span>  tensorflow.contrib.data <span class=\"pl-k\">import</span> Dataset\n\ndataset <span class=\"pl-k\">=</span> Dataset.range(<span class=\"pl-c1\">100</span>)\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">mapf</span>(<span class=\"pl-smi\">v</span>):\n    temp <span class=\"pl-k\">=</span> tf.Variable(\n            tf.random_uniform(\n                    [<span class=\"pl-c1\">1</span>],\n                    <span class=\"pl-v\">minval</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">0</span>,\n                    <span class=\"pl-v\">maxval</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">10</span>,\n                    <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.int32,\n            ),\n            <span class=\"pl-v\">trainable</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>,\n            <span class=\"pl-v\">collections</span><span class=\"pl-k\">=</span>[tf.GraphKeys.<span class=\"pl-c1\">LOCAL_VARIABLES</span>],\n            <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>my_var<span class=\"pl-pds\">\"</span></span>\n    )\n\n    <span class=\"pl-k\">with</span> tf.control_dependencies([tf.variables_initializer([temp])]):\n        temp <span class=\"pl-k\">=</span> temp <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>\n\n    <span class=\"pl-k\">return</span> temp\n\n\ndataset <span class=\"pl-k\">=</span> dataset.map(mapf)\ndataset <span class=\"pl-k\">=</span> dataset.batch(<span class=\"pl-c1\">1</span>)\n\niterator <span class=\"pl-k\">=</span> dataset.make_one_shot_iterator()\n\nnext_element <span class=\"pl-k\">=</span> iterator.get_next()\nlocal_init <span class=\"pl-k\">=</span> tf.local_variables_initializer()\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    sess.run(local_init)\n    <span class=\"pl-k\">try</span>:\n        <span class=\"pl-k\">while</span> <span class=\"pl-c1\">True</span>:\n            <span class=\"pl-c1\">print</span>(sess.run([next_element]))\n    <span class=\"pl-k\">except</span> tf.errors.OutOfRangeError <span class=\"pl-k\">as</span> e:\n        <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>ending<span class=\"pl-pds\">\"</span></span>)</pre></div>\n<p>output is not stable:</p>\n<pre><code>2017-08-28 18:09:31.817313: W tensorflow/core/framework/op_kernel.cc:1192] Failed precondition: Attempting to use uninitialized value my_var\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\nTraceback (most recent call last):\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1327, in _do_call\n    return fn(*args)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1306, in _run_fn\n    status, run_metadata)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/contextlib.py\", line 88, in __exit__\n    next(self.gen)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 466, in raise_exception_on_not_ok_status\n    pywrap_tensorflow.TF_GetCode(status))\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value my_var\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\n         [[Node: IteratorGetNext_2 = IteratorGetNext[output_shapes=[[?,1]], output_types=[DT_INT32], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"dataset.py\", line 90, in &lt;module&gt;\n    print(sess.run([next_element]))\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 895, in run\n    run_metadata_ptr)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1124, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1321, in _do_run\n    options, run_metadata)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value my_var\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\n         [[Node: IteratorGetNext_2 = IteratorGetNext[output_shapes=[[?,1]], output_types=[DT_INT32], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator)]]\n\n\n</code></pre>\n<p>OR</p>\n<pre><code>[array([[2]], dtype=int32)]\n[array([[9]], dtype=int32)]\n[array([[1]], dtype=int32)]\n[array([[5]], dtype=int32)]\n[array([[9]], dtype=int32)]\n[array([[9]], dtype=int32)]\n.....\nending\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):NO\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):macos\nTensorFlow installed from (source or binary):source\nTensorFlow version (use command below):1.3\nPython version: 3.6\nBazel version (if compiling from source):0.5.3-homebrew\nCUDA/cuDNN version:NO\nGPU model and memory:\nExact command to reproduce:\n\nDescribe the problem\nunable to init variable in map, flatmap, fillter function of Dataset API\nSource code / logs\nimport tensorflow as  tf\nfrom  tensorflow.contrib.data import Dataset\n\ndataset = Dataset.range(100)\n\ndef mapf(v):\n    temp = tf.Variable(\n            tf.random_uniform(\n                    [1],\n                    minval=0,\n                    maxval=10,\n                    dtype=tf.int32,\n            ),\n            trainable=False,\n            collections=[tf.GraphKeys.LOCAL_VARIABLES],\n            name=\"my_var\"\n    )\n\n    with tf.control_dependencies([tf.variables_initializer([temp])]):\n        temp = temp + 1\n\n    return temp\n\n\ndataset = dataset.map(mapf)\ndataset = dataset.batch(1)\n\niterator = dataset.make_one_shot_iterator()\n\nnext_element = iterator.get_next()\nlocal_init = tf.local_variables_initializer()\n\nwith tf.Session() as sess:\n    sess.run(local_init)\n    try:\n        while True:\n            print(sess.run([next_element]))\n    except tf.errors.OutOfRangeError as e:\n        print(\"ending\")\noutput is not stable:\n2017-08-28 18:09:31.817313: W tensorflow/core/framework/op_kernel.cc:1192] Failed precondition: Attempting to use uninitialized value my_var\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\nTraceback (most recent call last):\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1327, in _do_call\n    return fn(*args)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1306, in _run_fn\n    status, run_metadata)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/contextlib.py\", line 88, in __exit__\n    next(self.gen)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 466, in raise_exception_on_not_ok_status\n    pywrap_tensorflow.TF_GetCode(status))\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value my_var\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\n         [[Node: IteratorGetNext_2 = IteratorGetNext[output_shapes=[[?,1]], output_types=[DT_INT32], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"dataset.py\", line 90, in <module>\n    print(sess.run([next_element]))\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 895, in run\n    run_metadata_ptr)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1124, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1321, in _do_run\n    options, run_metadata)\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value my_var\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\n         [[Node: IteratorGetNext_2 = IteratorGetNext[output_shapes=[[?,1]], output_types=[DT_INT32], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator)]]\n\n\n\nOR\n[array([[2]], dtype=int32)]\n[array([[9]], dtype=int32)]\n[array([[1]], dtype=int32)]\n[array([[5]], dtype=int32)]\n[array([[9]], dtype=int32)]\n[array([[9]], dtype=int32)]\n.....\nending", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:NO\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:macos\r\n- **TensorFlow installed from (source or binary)**:source\r\n- **TensorFlow version (use command below)**:1.3\r\n- **Python version**: 3.6\r\n- **Bazel version (if compiling from source)**:0.5.3-homebrew\r\n- **CUDA/cuDNN version**:NO\r\n- **GPU model and memory**:\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\nunable to init variable in map, flatmap, fillter function of Dataset API\r\n\r\n### Source code / logs\r\n```python\r\nimport tensorflow as  tf\r\nfrom  tensorflow.contrib.data import Dataset\r\n\r\ndataset = Dataset.range(100)\r\n\r\ndef mapf(v):\r\n    temp = tf.Variable(\r\n            tf.random_uniform(\r\n                    [1],\r\n                    minval=0,\r\n                    maxval=10,\r\n                    dtype=tf.int32,\r\n            ),\r\n            trainable=False,\r\n            collections=[tf.GraphKeys.LOCAL_VARIABLES],\r\n            name=\"my_var\"\r\n    )\r\n\r\n    with tf.control_dependencies([tf.variables_initializer([temp])]):\r\n        temp = temp + 1\r\n\r\n    return temp\r\n\r\n\r\ndataset = dataset.map(mapf)\r\ndataset = dataset.batch(1)\r\n\r\niterator = dataset.make_one_shot_iterator()\r\n\r\nnext_element = iterator.get_next()\r\nlocal_init = tf.local_variables_initializer()\r\n\r\nwith tf.Session() as sess:\r\n    sess.run(local_init)\r\n    try:\r\n        while True:\r\n            print(sess.run([next_element]))\r\n    except tf.errors.OutOfRangeError as e:\r\n        print(\"ending\")\r\n```\r\noutput is not stable:\r\n```\r\n2017-08-28 18:09:31.817313: W tensorflow/core/framework/op_kernel.cc:1192] Failed precondition: Attempting to use uninitialized value my_var\r\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\r\nTraceback (most recent call last):\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1327, in _do_call\r\n    return fn(*args)\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1306, in _run_fn\r\n    status, run_metadata)\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/contextlib.py\", line 88, in __exit__\r\n    next(self.gen)\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 466, in raise_exception_on_not_ok_status\r\n    pywrap_tensorflow.TF_GetCode(status))\r\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value my_var\r\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\r\n         [[Node: IteratorGetNext_2 = IteratorGetNext[output_shapes=[[?,1]], output_types=[DT_INT32], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"dataset.py\", line 90, in <module>\r\n    print(sess.run([next_element]))\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 895, in run\r\n    run_metadata_ptr)\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1124, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1321, in _do_run\r\n    options, run_metadata)\r\n  File \"/Users/liyanan/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value my_var\r\n         [[Node: my_var/read = Identity[T=DT_INT32, _class=[\"loc:@my_var\"]](my_var)]]\r\n         [[Node: IteratorGetNext_2 = IteratorGetNext[output_shapes=[[?,1]], output_types=[DT_INT32], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator)]]\r\n\r\n\r\n```\r\n\r\nOR \r\n\r\n```\r\n[array([[2]], dtype=int32)]\r\n[array([[9]], dtype=int32)]\r\n[array([[1]], dtype=int32)]\r\n[array([[5]], dtype=int32)]\r\n[array([[9]], dtype=int32)]\r\n[array([[9]], dtype=int32)]\r\n.....\r\nending\r\n```"}