{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9757", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9757/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9757/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9757/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/9757", "id": 227042590, "node_id": "MDU6SXNzdWUyMjcwNDI1OTA=", "number": 9757, "title": "Large page fault causes slow performance while using gpu", "user": {"login": "luxiaolei", "id": 15217663, "node_id": "MDQ6VXNlcjE1MjE3NjYz", "avatar_url": "https://avatars1.githubusercontent.com/u/15217663?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luxiaolei", "html_url": "https://github.com/luxiaolei", "followers_url": "https://api.github.com/users/luxiaolei/followers", "following_url": "https://api.github.com/users/luxiaolei/following{/other_user}", "gists_url": "https://api.github.com/users/luxiaolei/gists{/gist_id}", "starred_url": "https://api.github.com/users/luxiaolei/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luxiaolei/subscriptions", "organizations_url": "https://api.github.com/users/luxiaolei/orgs", "repos_url": "https://api.github.com/users/luxiaolei/repos", "events_url": "https://api.github.com/users/luxiaolei/events{/privacy}", "received_events_url": "https://api.github.com/users/luxiaolei/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "tfboyd", "id": 23486130, "node_id": "MDQ6VXNlcjIzNDg2MTMw", "avatar_url": "https://avatars1.githubusercontent.com/u/23486130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tfboyd", "html_url": "https://github.com/tfboyd", "followers_url": "https://api.github.com/users/tfboyd/followers", "following_url": "https://api.github.com/users/tfboyd/following{/other_user}", "gists_url": "https://api.github.com/users/tfboyd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tfboyd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tfboyd/subscriptions", "organizations_url": "https://api.github.com/users/tfboyd/orgs", "repos_url": "https://api.github.com/users/tfboyd/repos", "events_url": "https://api.github.com/users/tfboyd/events{/privacy}", "received_events_url": "https://api.github.com/users/tfboyd/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "tfboyd", "id": 23486130, "node_id": "MDQ6VXNlcjIzNDg2MTMw", "avatar_url": "https://avatars1.githubusercontent.com/u/23486130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tfboyd", "html_url": "https://github.com/tfboyd", "followers_url": "https://api.github.com/users/tfboyd/followers", "following_url": "https://api.github.com/users/tfboyd/following{/other_user}", "gists_url": "https://api.github.com/users/tfboyd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tfboyd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tfboyd/subscriptions", "organizations_url": "https://api.github.com/users/tfboyd/orgs", "repos_url": "https://api.github.com/users/tfboyd/repos", "events_url": "https://api.github.com/users/tfboyd/events{/privacy}", "received_events_url": "https://api.github.com/users/tfboyd/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2017-05-08T13:16:22Z", "updated_at": "2017-06-17T04:55:04Z", "closed_at": "2017-05-15T11:50:46Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:<br>\nLinux Ubuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<br>\nbinary, using <code>pip install tensorflow-gpu==1.0.1</code></li>\n<li><strong>TensorFlow version (use command below)</strong>:<br>\n1.0.1</li>\n<li><strong>Bazel version (if compiling from source)</strong>:</li>\n<li><strong>CUDA/cuDNN version</strong>:<br>\n8.0/5.1</li>\n<li><strong>GPU model and memory</strong>:<br>\nnvidia gtx1080, 8g</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I have observed a large amount of page fault while running the provided sample code on gpu, and this causes a serious performance drawdown.</p>\n<p>The key parts of the output of <code>/usr/bin/time -v python sample.py</code> are:</p>\n<pre><code>System time (seconds): 7.28  \nPercent of CPU this job got: 85%  \nElapsed (wall clock) time (h:mm:ss or m:ss): 0:22.41 \nMinor (reclaiming a frame) page faults: 684695  \nInvoluntary context switches: 164 \nFile system inputs: 0  \nFile system outputs: 8  \n</code></pre>\n<p>There are 684k page faults,  and the <code>gpu-volatile usage</code> is only about 30%.</p>\n<p>I am very hesitating to ask for help here, because on another system with exact os, software and gpu, this issue does not appears, I have posted on stackoverflow to compare two systems <a href=\"http://stackoverflow.com/questions/43842731/two-exactly-same-systems-have-very-different-performances-when-running-tensorflo\" rel=\"nofollow\">here</a><br>\nIs that possible that tensorflow handles different hardwares differently? It looks to me that the gpu-cpu I/O may have caused this issue, and I suspect that I need to configure my hardware settings somewhere, but don't know how.</p>\n<p>Things I have tried:</p>\n<ol>\n<li>Upgrade BIOS to the latest version and reset default settings.</li>\n<li>Call Asus(my motherboard and gpu vendor) customer service for help.</li>\n<li>Inject LD_PRELOAD=\"/usr/lib/libtcmalloc.so\" to .bashrc file.</li>\n</ol>\n<h3>Source code / logs</h3>\n<p>Here is the sample code I used to test</p>\n<pre><code>import tensorflow as tf\nimport numpy as np\nfrom tqdm import trange\n\nnp.random.seed(111)\nh,w = 3000, 2000\nsteps = 1000\n\nx = tf.placeholder(dtype=tf.float32, shape=[h, w], name='x')\nt = tf.constant(np.random.random(size=[w, w]), dtype=tf.float32)\nm = tf.matmul(x,t)\n\nx0 = np.random.random(size=[h, w])\nsess = tf.Session()\nfor i in trange(steps):\n    x0 = sess.run(m, feed_dict={x: x0})\n</code></pre>\n<p>The attachment contains: <code>Nvidia-smi</code> output, <code>/usr/bin/time -v</code> output, hardware specs in html format, chrome trace timeline.<br>\n<a href=\"https://github.com/tensorflow/tensorflow/files/983550/sysB.zip\">sysB.zip</a></p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):\nLinux Ubuntu 16.04\nTensorFlow installed from (source or binary):\nbinary, using pip install tensorflow-gpu==1.0.1\nTensorFlow version (use command below):\n1.0.1\nBazel version (if compiling from source):\nCUDA/cuDNN version:\n8.0/5.1\nGPU model and memory:\nnvidia gtx1080, 8g\n\nDescribe the problem\nI have observed a large amount of page fault while running the provided sample code on gpu, and this causes a serious performance drawdown.\nThe key parts of the output of /usr/bin/time -v python sample.py are:\nSystem time (seconds): 7.28  \nPercent of CPU this job got: 85%  \nElapsed (wall clock) time (h:mm:ss or m:ss): 0:22.41 \nMinor (reclaiming a frame) page faults: 684695  \nInvoluntary context switches: 164 \nFile system inputs: 0  \nFile system outputs: 8  \n\nThere are 684k page faults,  and the gpu-volatile usage is only about 30%.\nI am very hesitating to ask for help here, because on another system with exact os, software and gpu, this issue does not appears, I have posted on stackoverflow to compare two systems here\nIs that possible that tensorflow handles different hardwares differently? It looks to me that the gpu-cpu I/O may have caused this issue, and I suspect that I need to configure my hardware settings somewhere, but don't know how.\nThings I have tried:\n\nUpgrade BIOS to the latest version and reset default settings.\nCall Asus(my motherboard and gpu vendor) customer service for help.\nInject LD_PRELOAD=\"/usr/lib/libtcmalloc.so\" to .bashrc file.\n\nSource code / logs\nHere is the sample code I used to test\nimport tensorflow as tf\nimport numpy as np\nfrom tqdm import trange\n\nnp.random.seed(111)\nh,w = 3000, 2000\nsteps = 1000\n\nx = tf.placeholder(dtype=tf.float32, shape=[h, w], name='x')\nt = tf.constant(np.random.random(size=[w, w]), dtype=tf.float32)\nm = tf.matmul(x,t)\n\nx0 = np.random.random(size=[h, w])\nsess = tf.Session()\nfor i in trange(steps):\n    x0 = sess.run(m, feed_dict={x: x0})\n\nThe attachment contains: Nvidia-smi output, /usr/bin/time -v output, hardware specs in html format, chrome trace timeline.\nsysB.zip", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:\r\nLinux Ubuntu 16.04\r\n- **TensorFlow installed from (source or binary)**:\r\nbinary, using `pip install tensorflow-gpu==1.0.1`\r\n- **TensorFlow version (use command below)**:\r\n1.0.1\r\n- **Bazel version (if compiling from source)**:\r\n- **CUDA/cuDNN version**:\r\n8.0/5.1\r\n- **GPU model and memory**:\r\nnvidia gtx1080, 8g\r\n\r\n### Describe the problem\r\nI have observed a large amount of page fault while running the provided sample code on gpu, and this causes a serious performance drawdown. \r\n\r\nThe key parts of the output of `/usr/bin/time -v python sample.py` are:\r\n\r\n    System time (seconds): 7.28  \r\n    Percent of CPU this job got: 85%  \r\n    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:22.41 \r\n    Minor (reclaiming a frame) page faults: 684695  \r\n    Involuntary context switches: 164 \r\n    File system inputs: 0  \r\n    File system outputs: 8  \r\n\r\nThere are 684k page faults,  and the `gpu-volatile usage` is only about 30%. \r\n\r\nI am very hesitating to ask for help here, because on another system with exact os, software and gpu, this issue does not appears, I have posted on stackoverflow to compare two systems [here](http://stackoverflow.com/questions/43842731/two-exactly-same-systems-have-very-different-performances-when-running-tensorflo) \r\nIs that possible that tensorflow handles different hardwares differently? It looks to me that the gpu-cpu I/O may have caused this issue, and I suspect that I need to configure my hardware settings somewhere, but don't know how.\r\n\r\nThings I have tried:\r\n\r\n1. Upgrade BIOS to the latest version and reset default settings.\r\n2. Call Asus(my motherboard and gpu vendor) customer service for help.\r\n3. Inject LD_PRELOAD=\"/usr/lib/libtcmalloc.so\" to .bashrc file.\r\n \r\n### Source code / logs\r\n\r\nHere is the sample code I used to test\r\n\r\n    import tensorflow as tf\r\n    import numpy as np\r\n    from tqdm import trange\r\n  \r\n    np.random.seed(111)\r\n    h,w = 3000, 2000\r\n    steps = 1000\r\n\r\n    x = tf.placeholder(dtype=tf.float32, shape=[h, w], name='x')\r\n    t = tf.constant(np.random.random(size=[w, w]), dtype=tf.float32)\r\n    m = tf.matmul(x,t)\r\n\r\n    x0 = np.random.random(size=[h, w])\r\n    sess = tf.Session()\r\n    for i in trange(steps):\r\n        x0 = sess.run(m, feed_dict={x: x0})\r\n\r\nThe attachment contains: `Nvidia-smi` output, `/usr/bin/time -v` output, hardware specs in html format, chrome trace timeline.\r\n[sysB.zip](https://github.com/tensorflow/tensorflow/files/983550/sysB.zip)\r\n\r\n\r\n\r\n"}