{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12073", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12073/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12073/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12073/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/12073", "id": 248348746, "node_id": "MDU6SXNzdWUyNDgzNDg3NDY=", "number": 12073, "title": "tf.py_func errors in freeze_graph", "user": {"login": "rolai", "id": 9015121, "node_id": "MDQ6VXNlcjkwMTUxMjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9015121?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rolai", "html_url": "https://github.com/rolai", "followers_url": "https://api.github.com/users/rolai/followers", "following_url": "https://api.github.com/users/rolai/following{/other_user}", "gists_url": "https://api.github.com/users/rolai/gists{/gist_id}", "starred_url": "https://api.github.com/users/rolai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rolai/subscriptions", "organizations_url": "https://api.github.com/users/rolai/orgs", "repos_url": "https://api.github.com/users/rolai/repos", "events_url": "https://api.github.com/users/rolai/events{/privacy}", "received_events_url": "https://api.github.com/users/rolai/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-08-07T09:01:18Z", "updated_at": "2018-10-31T21:29:15Z", "closed_at": "2017-09-18T02:36:49Z", "author_association": "NONE", "body_html": "<p>I use <code>tf.py_func</code> in my networks, and it works fine in training and test mode.  Then I run <code>bazel-bin/tensorflow/python/tools/freeze_graph</code> to freeze the graph and generate xxx.pb file.<br>\nI try to restore the xxx.pb and run the model again, error happens.</p>\n<h3>Erorr logs</h3>\n<pre><code>2017-08-07 16:04:15.565535: W tensorflow/core/framework/op_kernel.cc:1158] Unknown: exceptions.KeyError: 'pyfunc_0'\nTraceback (most recent call last):\n  File \"object_detector_pb.py\", line 159, in &lt;module&gt;\n    objects = detector.detect(img)\n  File \"object_detector_pb.py\", line 118, in detect\n    scores, boxes = self.im_detect(image)\n  File \"object_detector_pb.py\", line 101, in im_detect\n    scores, bbox_pred, rois = self.sess.run([self._cls_prob, self._bbox_pred, self._rois], feed)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 789, in run\n    run_metadata_ptr)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 997, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\n    target_list, options, run_metadata)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.UnknownError: exceptions.KeyError: 'pyfunc_0'\n\t [[Node: detector/MobilenetV1_2/ANCHOR_default/generate_anchors = PyFunc[Tin=[DT_INT32, DT_INT32, DT_INT32, DT_INT32, DT_FLOAT], Tout=[DT_FLOAT, DT_INT32], token=\"pyfunc_0\", _device=\"/job:localhost/replica:0/task:0/cpu:0\"](detector/MobilenetV1_2/ANCHOR_default/ToInt32, detector/MobilenetV1_2/ANCHOR_default/ToInt32_1, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_2, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_3, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_4)]]\n\nCaused by op u'detector/MobilenetV1_2/ANCHOR_default/generate_anchors', defined at:\n  File \"object_detector_pb.py\", line 143, in &lt;module&gt;\n    detector = ObjectDetector(model_path, config_file)\n  File \"object_detector_pb.py\", line 76, in __init__\n    tf.import_graph_def(graph_def, name=\"detector\")\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/importer.py\", line 311, in import_graph_def\n    op_def=op_def)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nUnknownError (see above for traceback): exceptions.KeyError: 'pyfunc_0'\n\t [[Node: detector/MobilenetV1_2/ANCHOR_default/generate_anchors = PyFunc[Tin=[DT_INT32, DT_INT32, DT_INT32, DT_INT32, DT_FLOAT], Tout=[DT_FLOAT, DT_INT32], token=\"pyfunc_0\", _device=\"/job:localhost/replica:0/task:0/cpu:0\"](detector/MobilenetV1_2/ANCHOR_default/ToInt32, detector/MobilenetV1_2/ANCHOR_default/ToInt32_1, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_2, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_3, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_4)]]\n</code></pre>\n<p>I found the <code>tf.py_func</code> is not in the graph. How can I define and use the <code>tf.py_func</code> in freezed graph?</p>", "body_text": "I use tf.py_func in my networks, and it works fine in training and test mode.  Then I run bazel-bin/tensorflow/python/tools/freeze_graph to freeze the graph and generate xxx.pb file.\nI try to restore the xxx.pb and run the model again, error happens.\nErorr logs\n2017-08-07 16:04:15.565535: W tensorflow/core/framework/op_kernel.cc:1158] Unknown: exceptions.KeyError: 'pyfunc_0'\nTraceback (most recent call last):\n  File \"object_detector_pb.py\", line 159, in <module>\n    objects = detector.detect(img)\n  File \"object_detector_pb.py\", line 118, in detect\n    scores, boxes = self.im_detect(image)\n  File \"object_detector_pb.py\", line 101, in im_detect\n    scores, bbox_pred, rois = self.sess.run([self._cls_prob, self._bbox_pred, self._rois], feed)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 789, in run\n    run_metadata_ptr)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 997, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\n    target_list, options, run_metadata)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.UnknownError: exceptions.KeyError: 'pyfunc_0'\n\t [[Node: detector/MobilenetV1_2/ANCHOR_default/generate_anchors = PyFunc[Tin=[DT_INT32, DT_INT32, DT_INT32, DT_INT32, DT_FLOAT], Tout=[DT_FLOAT, DT_INT32], token=\"pyfunc_0\", _device=\"/job:localhost/replica:0/task:0/cpu:0\"](detector/MobilenetV1_2/ANCHOR_default/ToInt32, detector/MobilenetV1_2/ANCHOR_default/ToInt32_1, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_2, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_3, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_4)]]\n\nCaused by op u'detector/MobilenetV1_2/ANCHOR_default/generate_anchors', defined at:\n  File \"object_detector_pb.py\", line 143, in <module>\n    detector = ObjectDetector(model_path, config_file)\n  File \"object_detector_pb.py\", line 76, in __init__\n    tf.import_graph_def(graph_def, name=\"detector\")\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/importer.py\", line 311, in import_graph_def\n    op_def=op_def)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nUnknownError (see above for traceback): exceptions.KeyError: 'pyfunc_0'\n\t [[Node: detector/MobilenetV1_2/ANCHOR_default/generate_anchors = PyFunc[Tin=[DT_INT32, DT_INT32, DT_INT32, DT_INT32, DT_FLOAT], Tout=[DT_FLOAT, DT_INT32], token=\"pyfunc_0\", _device=\"/job:localhost/replica:0/task:0/cpu:0\"](detector/MobilenetV1_2/ANCHOR_default/ToInt32, detector/MobilenetV1_2/ANCHOR_default/ToInt32_1, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_2, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_3, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_4)]]\n\nI found the tf.py_func is not in the graph. How can I define and use the tf.py_func in freezed graph?", "body": "I use `tf.py_func` in my networks, and it works fine in training and test mode.  Then I run `bazel-bin/tensorflow/python/tools/freeze_graph` to freeze the graph and generate xxx.pb file.\r\nI try to restore the xxx.pb and run the model again, error happens.\r\n\r\n### Erorr logs\r\n```\r\n2017-08-07 16:04:15.565535: W tensorflow/core/framework/op_kernel.cc:1158] Unknown: exceptions.KeyError: 'pyfunc_0'\r\nTraceback (most recent call last):\r\n  File \"object_detector_pb.py\", line 159, in <module>\r\n    objects = detector.detect(img)\r\n  File \"object_detector_pb.py\", line 118, in detect\r\n    scores, boxes = self.im_detect(image)\r\n  File \"object_detector_pb.py\", line 101, in im_detect\r\n    scores, bbox_pred, rois = self.sess.run([self._cls_prob, self._bbox_pred, self._rois], feed)\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 789, in run\r\n    run_metadata_ptr)\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 997, in _run\r\n    feed_dict_string, options, run_metadata)\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\r\n    target_list, options, run_metadata)\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.UnknownError: exceptions.KeyError: 'pyfunc_0'\r\n\t [[Node: detector/MobilenetV1_2/ANCHOR_default/generate_anchors = PyFunc[Tin=[DT_INT32, DT_INT32, DT_INT32, DT_INT32, DT_FLOAT], Tout=[DT_FLOAT, DT_INT32], token=\"pyfunc_0\", _device=\"/job:localhost/replica:0/task:0/cpu:0\"](detector/MobilenetV1_2/ANCHOR_default/ToInt32, detector/MobilenetV1_2/ANCHOR_default/ToInt32_1, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_2, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_3, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_4)]]\r\n\r\nCaused by op u'detector/MobilenetV1_2/ANCHOR_default/generate_anchors', defined at:\r\n  File \"object_detector_pb.py\", line 143, in <module>\r\n    detector = ObjectDetector(model_path, config_file)\r\n  File \"object_detector_pb.py\", line 76, in __init__\r\n    tf.import_graph_def(graph_def, name=\"detector\")\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/importer.py\", line 311, in import_graph_def\r\n    op_def=op_def)\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\nUnknownError (see above for traceback): exceptions.KeyError: 'pyfunc_0'\r\n\t [[Node: detector/MobilenetV1_2/ANCHOR_default/generate_anchors = PyFunc[Tin=[DT_INT32, DT_INT32, DT_INT32, DT_INT32, DT_FLOAT], Tout=[DT_FLOAT, DT_INT32], token=\"pyfunc_0\", _device=\"/job:localhost/replica:0/task:0/cpu:0\"](detector/MobilenetV1_2/ANCHOR_default/ToInt32, detector/MobilenetV1_2/ANCHOR_default/ToInt32_1, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_2, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_3, detector/MobilenetV1_2/ANCHOR_default/generate_anchors/input_4)]]\r\n```\r\n\r\nI found the `tf.py_func` is not in the graph. How can I define and use the `tf.py_func` in freezed graph?"}