{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/249328005", "html_url": "https://github.com/tensorflow/tensorflow/issues/4467#issuecomment-249328005", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4467", "id": 249328005, "node_id": "MDEyOklzc3VlQ29tbWVudDI0OTMyODAwNQ==", "user": {"login": "victor-shepardson", "id": 4522484, "node_id": "MDQ6VXNlcjQ1MjI0ODQ=", "avatar_url": "https://avatars0.githubusercontent.com/u/4522484?v=4", "gravatar_id": "", "url": "https://api.github.com/users/victor-shepardson", "html_url": "https://github.com/victor-shepardson", "followers_url": "https://api.github.com/users/victor-shepardson/followers", "following_url": "https://api.github.com/users/victor-shepardson/following{/other_user}", "gists_url": "https://api.github.com/users/victor-shepardson/gists{/gist_id}", "starred_url": "https://api.github.com/users/victor-shepardson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/victor-shepardson/subscriptions", "organizations_url": "https://api.github.com/users/victor-shepardson/orgs", "repos_url": "https://api.github.com/users/victor-shepardson/repos", "events_url": "https://api.github.com/users/victor-shepardson/events{/privacy}", "received_events_url": "https://api.github.com/users/victor-shepardson/received_events", "type": "User", "site_admin": false}, "created_at": "2016-09-23T23:52:06Z", "updated_at": "2016-09-23T23:52:06Z", "author_association": "NONE", "body_html": "<p>I'm having a similar problem; TFRecordWriter doesn't appear to be the issue, rather it's the protobuf library. BytesList() is slow, and SerializeToString() is mega-slow. Writing 1 MiB:</p>\n<pre><code>%%prun\ndef quantize(x):\n    return x.astype(np.int8).tostring()\nfeats = {'':tf.train.Feature(bytes_list=tf.train.BytesList(value=quantize(np.ones((2**10, 2**10)))))}\nexample = tf.train.Example(features=tf.train.Features(feature=feats))\nwriter = tf.python_io.TFRecordWriter('/dev/null')\nwriter.write(example.SerializeToString())\n</code></pre>\n<pre><code>         15729132 function calls (15729090 primitive calls) in 6.355 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n        2    1.679    0.839    2.488    1.244 encoder.py:260(RepeatedFieldSize)\n        1    1.292    1.292    2.881    2.881 encoder.py:711(EncodeRepeatedField)\n  1048580    0.701    0.000    1.013    0.000 encoder.py:372(EncodeVarint)\n  3145731    0.535    0.000    0.535    0.000 containers.py:202(__getitem__)\n  3145748    0.440    0.000    0.440    0.000 {method 'write' of '_io.BytesIO' objects}\n        1    0.366    0.366    0.841    0.841 containers.py:261(extend)\n  1048576    0.359    0.000    0.471    0.000 type_checkers.py:100(CheckValue)\n3145753/3145751    0.289    0.000    0.289    0.000 {len}\n  2097157    0.283    0.000    0.283    0.000 encoder.py:82(_VarintSize)\n  1048592    0.150    0.000    0.150    0.000 {chr}\n  1048621    0.113    0.000    0.113    0.000 {isinstance}\n        1    0.109    0.109    6.355    6.355 &lt;string&gt;:2(&lt;module&gt;)\n        6    0.021    0.003    0.021    0.003 {method 'extend' of 'list' objects}\n     16/6    0.003    0.000    0.862    0.144 python_message.py:474(init)\n      9/4    0.003    0.000    2.495    0.624 python_message.py:1035(ByteSize)\n      5/1    0.003    0.001    5.383    5.383 python_message.py:1077(InternalSerialize)\n        1    0.003    0.003    0.003    0.003 {_pywrap_tensorflow.PyRecordWriter_WriteRecord}\n        1    0.003    0.003    0.003    0.003 {method 'astype' of 'numpy.ndarray' objects}\n        1    0.002    0.002    0.002    0.002 {numpy.core.multiarray.copyto}\n        1    0.001    0.001    0.001    0.001 {method 'getvalue' of '_io.BytesIO' objects}\n        1    0.000    0.000    0.000    0.000 {method 'tostring' of 'numpy.ndarray' objects}\n     10/5    0.000    0.000    0.018    0.004 python_message.py:1233(MergeFrom)\n        1    0.000    0.000    0.000    0.000 {_pywrap_tensorflow.PyRecordWriter_New}\n       21    0.000    0.000    0.000    0.000 python_message.py:1362(__init__)\n       12    0.000    0.000    0.000    0.000 python_message.py:790(ListFields)\n        8    0.000    0.000    0.000    0.000 python_message.py:429(MakeSubMessageDefault)\n       12    0.000    0.000    0.000    0.000 python_message.py:775(_IsPresent)\n       12    0.000    0.000    0.000    0.000 {method 'sort' of 'list' objects}\n        5    0.000    0.000    0.017    0.003 containers.py:280(MergeFrom)\n        5    0.000    0.000    0.000    0.000 containers.py:541(__getitem__)\n       18    0.000    0.000    0.000    0.000 python_message.py:1381(Modified)\n      4/1    0.000    0.000    5.382    5.382 encoder.py:760(EncodeField)\n       40    0.000    0.000    0.000    0.000 {method 'items' of 'dict' objects}\n    21/12    0.000    0.000    0.000    0.000 python_message.py:1317(Modified)\n        5    0.000    0.000    0.000    0.000 python_message.py:1397(__init__)\n      2/1    0.000    0.000    0.000    0.000 python_message.py:1141(IsInitialized)\n        6    0.000    0.000    0.000    0.000 python_message.py:421(MakeRepeatedScalarDefault)\n        1    0.000    0.000    4.130    4.130 encoder.py:818(EncodeField)\n        4    0.000    0.000    0.000    0.000 type_checkers.py:162(CheckValue)\n        1    0.000    0.000    5.384    5.384 python_message.py:1071(SerializePartialToString)\n        1    0.000    0.000    0.003    0.003 &lt;string&gt;:2(quantize)\n        1    0.000    0.000    1.246    1.246 encoder.py:351(FieldSize)\n        1    0.000    0.000    0.002    0.002 numeric.py:136(ones)\n        5    0.000    0.000    0.000    0.000 python_message.py:1406(Modified)\n        2    0.000    0.000    0.000    0.000 python_message.py:660(field_setter)\n        6    0.000    0.000    0.000    0.000 containers.py:237(__init__)\n       21    0.000    0.000    0.000    0.000 {_weakref.proxy}\n      5/2    0.000    0.000    2.488    1.244 encoder.py:307(FieldSize)\n        1    0.000    0.000    0.004    0.004 containers.py:595(MergeFrom)\n        1    0.000    0.000    0.000    0.000 tf_record.py:57(__init__)\n        8    0.000    0.000    0.000    0.000 python_message.py:537(_GetFieldByName)\n        5    0.000    0.000    0.000    0.000 python_message.py:1332(_UpdateOneofState)\n        6    0.000    0.000    0.000    0.000 containers.py:192(__init__)\n       10    0.000    0.000    0.000    0.000 python_message.py:1004(SetListener)\n        2    0.000    0.000    0.000    0.000 {setattr}\n        1    0.000    0.000    0.000    0.000 python_message.py:271(_IsMapField)\n        5    0.000    0.000    0.000    0.000 containers.py:206(__len__)\n        1    0.000    0.000    0.000    0.000 {numpy.core.multiarray.empty}\n        1    0.000    0.000    0.003    0.003 tf_record.py:78(write)\n        2    0.000    0.000    0.000    0.000 python_message.py:379(MakeMessageMapDefault)\n        1    0.000    0.000    0.000    0.000 {_codecs.utf_8_decode}\n        1    0.000    0.000    5.384    5.384 python_message.py:1057(SerializeToString)\n        2    0.000    0.000    0.000    0.000 python_message.py:651(getter)\n        1    0.000    0.000    0.003    0.003 pywrap_tensorflow.py:183(WriteRecord)\n        2    0.000    0.000    0.000    0.000 containers.py:525(__init__)\n        2    0.000    0.000    0.000    0.000 descriptor.py:118(GetOptions)\n        1    0.000    0.000    0.000    0.000 {method 'decode' of 'str' objects}\n        2    0.000    0.000    0.000    0.000 containers.py:586(__len__)\n        5    0.000    0.000    0.000    0.000 {method 'setdefault' of 'dict' objects}\n       12    0.000    0.000    0.000    0.000 {method 'get' of 'dict' objects}\n       12    0.000    0.000    0.000    0.000 python_message.py:792(&lt;lambda&gt;)\n        1    0.000    0.000    0.000    0.000 compat.py:27(as_bytes)\n        1    0.000    0.000    0.000    0.000 utf_8.py:15(decode)\n        3    0.000    0.000    0.000    0.000 containers.py:589(__iter__)\n        4    0.000    0.000    0.000    0.000 {iter}\n        1    0.000    0.000    0.000    0.000 python_message.py:277(_IsMessageMapField)\n        1    0.000    0.000    0.000    0.000 pywrap_tensorflow.py:182(&lt;lambda&gt;)\n        2    0.000    0.000    0.000    0.000 {method 'pop' of 'dict' objects}\n        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}\n\n</code></pre>\n<pre><code>def quantize(x):\n    return x.astype(np.int8).tostring()\nwriter = tf.python_io.TFRecordWriter('/dev/null')\n%time q = quantize(np.ones((2**10, 2**10))) #fast\n%time bl = tf.train.BytesList(value=q) #slow\n%time example = tf.train.Example(features=tf.train.Features(feature={'':tf.train.Feature(bytes_list=bl)})) #fast\n%time s = example.SerializeToString() #very slow\n%time writer.write(s) #fast\n</code></pre>\n<pre><code>CPU times: user 8 ms, sys: 0 ns, total: 8 ms\nWall time: 5.11 ms\nCPU times: user 440 ms, sys: 4 ms, total: 444 ms\nWall time: 440 ms\nCPU times: user 20 ms, sys: 0 ns, total: 20 ms\nWall time: 20.4 ms\nCPU times: user 2.21 s, sys: 16 ms, total: 2.23 s\nWall time: 2.22 s\nCPU times: user 4 ms, sys: 0 ns, total: 4 ms\nWall time: 2.81 ms\n</code></pre>\n<p>i'm using the docker image tensorflow/tensorflow:latest-gpu with nvidia-docker on ubuntu 16.04</p>", "body_text": "I'm having a similar problem; TFRecordWriter doesn't appear to be the issue, rather it's the protobuf library. BytesList() is slow, and SerializeToString() is mega-slow. Writing 1 MiB:\n%%prun\ndef quantize(x):\n    return x.astype(np.int8).tostring()\nfeats = {'':tf.train.Feature(bytes_list=tf.train.BytesList(value=quantize(np.ones((2**10, 2**10)))))}\nexample = tf.train.Example(features=tf.train.Features(feature=feats))\nwriter = tf.python_io.TFRecordWriter('/dev/null')\nwriter.write(example.SerializeToString())\n\n         15729132 function calls (15729090 primitive calls) in 6.355 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n        2    1.679    0.839    2.488    1.244 encoder.py:260(RepeatedFieldSize)\n        1    1.292    1.292    2.881    2.881 encoder.py:711(EncodeRepeatedField)\n  1048580    0.701    0.000    1.013    0.000 encoder.py:372(EncodeVarint)\n  3145731    0.535    0.000    0.535    0.000 containers.py:202(__getitem__)\n  3145748    0.440    0.000    0.440    0.000 {method 'write' of '_io.BytesIO' objects}\n        1    0.366    0.366    0.841    0.841 containers.py:261(extend)\n  1048576    0.359    0.000    0.471    0.000 type_checkers.py:100(CheckValue)\n3145753/3145751    0.289    0.000    0.289    0.000 {len}\n  2097157    0.283    0.000    0.283    0.000 encoder.py:82(_VarintSize)\n  1048592    0.150    0.000    0.150    0.000 {chr}\n  1048621    0.113    0.000    0.113    0.000 {isinstance}\n        1    0.109    0.109    6.355    6.355 <string>:2(<module>)\n        6    0.021    0.003    0.021    0.003 {method 'extend' of 'list' objects}\n     16/6    0.003    0.000    0.862    0.144 python_message.py:474(init)\n      9/4    0.003    0.000    2.495    0.624 python_message.py:1035(ByteSize)\n      5/1    0.003    0.001    5.383    5.383 python_message.py:1077(InternalSerialize)\n        1    0.003    0.003    0.003    0.003 {_pywrap_tensorflow.PyRecordWriter_WriteRecord}\n        1    0.003    0.003    0.003    0.003 {method 'astype' of 'numpy.ndarray' objects}\n        1    0.002    0.002    0.002    0.002 {numpy.core.multiarray.copyto}\n        1    0.001    0.001    0.001    0.001 {method 'getvalue' of '_io.BytesIO' objects}\n        1    0.000    0.000    0.000    0.000 {method 'tostring' of 'numpy.ndarray' objects}\n     10/5    0.000    0.000    0.018    0.004 python_message.py:1233(MergeFrom)\n        1    0.000    0.000    0.000    0.000 {_pywrap_tensorflow.PyRecordWriter_New}\n       21    0.000    0.000    0.000    0.000 python_message.py:1362(__init__)\n       12    0.000    0.000    0.000    0.000 python_message.py:790(ListFields)\n        8    0.000    0.000    0.000    0.000 python_message.py:429(MakeSubMessageDefault)\n       12    0.000    0.000    0.000    0.000 python_message.py:775(_IsPresent)\n       12    0.000    0.000    0.000    0.000 {method 'sort' of 'list' objects}\n        5    0.000    0.000    0.017    0.003 containers.py:280(MergeFrom)\n        5    0.000    0.000    0.000    0.000 containers.py:541(__getitem__)\n       18    0.000    0.000    0.000    0.000 python_message.py:1381(Modified)\n      4/1    0.000    0.000    5.382    5.382 encoder.py:760(EncodeField)\n       40    0.000    0.000    0.000    0.000 {method 'items' of 'dict' objects}\n    21/12    0.000    0.000    0.000    0.000 python_message.py:1317(Modified)\n        5    0.000    0.000    0.000    0.000 python_message.py:1397(__init__)\n      2/1    0.000    0.000    0.000    0.000 python_message.py:1141(IsInitialized)\n        6    0.000    0.000    0.000    0.000 python_message.py:421(MakeRepeatedScalarDefault)\n        1    0.000    0.000    4.130    4.130 encoder.py:818(EncodeField)\n        4    0.000    0.000    0.000    0.000 type_checkers.py:162(CheckValue)\n        1    0.000    0.000    5.384    5.384 python_message.py:1071(SerializePartialToString)\n        1    0.000    0.000    0.003    0.003 <string>:2(quantize)\n        1    0.000    0.000    1.246    1.246 encoder.py:351(FieldSize)\n        1    0.000    0.000    0.002    0.002 numeric.py:136(ones)\n        5    0.000    0.000    0.000    0.000 python_message.py:1406(Modified)\n        2    0.000    0.000    0.000    0.000 python_message.py:660(field_setter)\n        6    0.000    0.000    0.000    0.000 containers.py:237(__init__)\n       21    0.000    0.000    0.000    0.000 {_weakref.proxy}\n      5/2    0.000    0.000    2.488    1.244 encoder.py:307(FieldSize)\n        1    0.000    0.000    0.004    0.004 containers.py:595(MergeFrom)\n        1    0.000    0.000    0.000    0.000 tf_record.py:57(__init__)\n        8    0.000    0.000    0.000    0.000 python_message.py:537(_GetFieldByName)\n        5    0.000    0.000    0.000    0.000 python_message.py:1332(_UpdateOneofState)\n        6    0.000    0.000    0.000    0.000 containers.py:192(__init__)\n       10    0.000    0.000    0.000    0.000 python_message.py:1004(SetListener)\n        2    0.000    0.000    0.000    0.000 {setattr}\n        1    0.000    0.000    0.000    0.000 python_message.py:271(_IsMapField)\n        5    0.000    0.000    0.000    0.000 containers.py:206(__len__)\n        1    0.000    0.000    0.000    0.000 {numpy.core.multiarray.empty}\n        1    0.000    0.000    0.003    0.003 tf_record.py:78(write)\n        2    0.000    0.000    0.000    0.000 python_message.py:379(MakeMessageMapDefault)\n        1    0.000    0.000    0.000    0.000 {_codecs.utf_8_decode}\n        1    0.000    0.000    5.384    5.384 python_message.py:1057(SerializeToString)\n        2    0.000    0.000    0.000    0.000 python_message.py:651(getter)\n        1    0.000    0.000    0.003    0.003 pywrap_tensorflow.py:183(WriteRecord)\n        2    0.000    0.000    0.000    0.000 containers.py:525(__init__)\n        2    0.000    0.000    0.000    0.000 descriptor.py:118(GetOptions)\n        1    0.000    0.000    0.000    0.000 {method 'decode' of 'str' objects}\n        2    0.000    0.000    0.000    0.000 containers.py:586(__len__)\n        5    0.000    0.000    0.000    0.000 {method 'setdefault' of 'dict' objects}\n       12    0.000    0.000    0.000    0.000 {method 'get' of 'dict' objects}\n       12    0.000    0.000    0.000    0.000 python_message.py:792(<lambda>)\n        1    0.000    0.000    0.000    0.000 compat.py:27(as_bytes)\n        1    0.000    0.000    0.000    0.000 utf_8.py:15(decode)\n        3    0.000    0.000    0.000    0.000 containers.py:589(__iter__)\n        4    0.000    0.000    0.000    0.000 {iter}\n        1    0.000    0.000    0.000    0.000 python_message.py:277(_IsMessageMapField)\n        1    0.000    0.000    0.000    0.000 pywrap_tensorflow.py:182(<lambda>)\n        2    0.000    0.000    0.000    0.000 {method 'pop' of 'dict' objects}\n        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}\n\n\ndef quantize(x):\n    return x.astype(np.int8).tostring()\nwriter = tf.python_io.TFRecordWriter('/dev/null')\n%time q = quantize(np.ones((2**10, 2**10))) #fast\n%time bl = tf.train.BytesList(value=q) #slow\n%time example = tf.train.Example(features=tf.train.Features(feature={'':tf.train.Feature(bytes_list=bl)})) #fast\n%time s = example.SerializeToString() #very slow\n%time writer.write(s) #fast\n\nCPU times: user 8 ms, sys: 0 ns, total: 8 ms\nWall time: 5.11 ms\nCPU times: user 440 ms, sys: 4 ms, total: 444 ms\nWall time: 440 ms\nCPU times: user 20 ms, sys: 0 ns, total: 20 ms\nWall time: 20.4 ms\nCPU times: user 2.21 s, sys: 16 ms, total: 2.23 s\nWall time: 2.22 s\nCPU times: user 4 ms, sys: 0 ns, total: 4 ms\nWall time: 2.81 ms\n\ni'm using the docker image tensorflow/tensorflow:latest-gpu with nvidia-docker on ubuntu 16.04", "body": "I'm having a similar problem; TFRecordWriter doesn't appear to be the issue, rather it's the protobuf library. BytesList() is slow, and SerializeToString() is mega-slow. Writing 1 MiB:\n\n```\n%%prun\ndef quantize(x):\n    return x.astype(np.int8).tostring()\nfeats = {'':tf.train.Feature(bytes_list=tf.train.BytesList(value=quantize(np.ones((2**10, 2**10)))))}\nexample = tf.train.Example(features=tf.train.Features(feature=feats))\nwriter = tf.python_io.TFRecordWriter('/dev/null')\nwriter.write(example.SerializeToString())\n```\n\n```\n         15729132 function calls (15729090 primitive calls) in 6.355 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n        2    1.679    0.839    2.488    1.244 encoder.py:260(RepeatedFieldSize)\n        1    1.292    1.292    2.881    2.881 encoder.py:711(EncodeRepeatedField)\n  1048580    0.701    0.000    1.013    0.000 encoder.py:372(EncodeVarint)\n  3145731    0.535    0.000    0.535    0.000 containers.py:202(__getitem__)\n  3145748    0.440    0.000    0.440    0.000 {method 'write' of '_io.BytesIO' objects}\n        1    0.366    0.366    0.841    0.841 containers.py:261(extend)\n  1048576    0.359    0.000    0.471    0.000 type_checkers.py:100(CheckValue)\n3145753/3145751    0.289    0.000    0.289    0.000 {len}\n  2097157    0.283    0.000    0.283    0.000 encoder.py:82(_VarintSize)\n  1048592    0.150    0.000    0.150    0.000 {chr}\n  1048621    0.113    0.000    0.113    0.000 {isinstance}\n        1    0.109    0.109    6.355    6.355 <string>:2(<module>)\n        6    0.021    0.003    0.021    0.003 {method 'extend' of 'list' objects}\n     16/6    0.003    0.000    0.862    0.144 python_message.py:474(init)\n      9/4    0.003    0.000    2.495    0.624 python_message.py:1035(ByteSize)\n      5/1    0.003    0.001    5.383    5.383 python_message.py:1077(InternalSerialize)\n        1    0.003    0.003    0.003    0.003 {_pywrap_tensorflow.PyRecordWriter_WriteRecord}\n        1    0.003    0.003    0.003    0.003 {method 'astype' of 'numpy.ndarray' objects}\n        1    0.002    0.002    0.002    0.002 {numpy.core.multiarray.copyto}\n        1    0.001    0.001    0.001    0.001 {method 'getvalue' of '_io.BytesIO' objects}\n        1    0.000    0.000    0.000    0.000 {method 'tostring' of 'numpy.ndarray' objects}\n     10/5    0.000    0.000    0.018    0.004 python_message.py:1233(MergeFrom)\n        1    0.000    0.000    0.000    0.000 {_pywrap_tensorflow.PyRecordWriter_New}\n       21    0.000    0.000    0.000    0.000 python_message.py:1362(__init__)\n       12    0.000    0.000    0.000    0.000 python_message.py:790(ListFields)\n        8    0.000    0.000    0.000    0.000 python_message.py:429(MakeSubMessageDefault)\n       12    0.000    0.000    0.000    0.000 python_message.py:775(_IsPresent)\n       12    0.000    0.000    0.000    0.000 {method 'sort' of 'list' objects}\n        5    0.000    0.000    0.017    0.003 containers.py:280(MergeFrom)\n        5    0.000    0.000    0.000    0.000 containers.py:541(__getitem__)\n       18    0.000    0.000    0.000    0.000 python_message.py:1381(Modified)\n      4/1    0.000    0.000    5.382    5.382 encoder.py:760(EncodeField)\n       40    0.000    0.000    0.000    0.000 {method 'items' of 'dict' objects}\n    21/12    0.000    0.000    0.000    0.000 python_message.py:1317(Modified)\n        5    0.000    0.000    0.000    0.000 python_message.py:1397(__init__)\n      2/1    0.000    0.000    0.000    0.000 python_message.py:1141(IsInitialized)\n        6    0.000    0.000    0.000    0.000 python_message.py:421(MakeRepeatedScalarDefault)\n        1    0.000    0.000    4.130    4.130 encoder.py:818(EncodeField)\n        4    0.000    0.000    0.000    0.000 type_checkers.py:162(CheckValue)\n        1    0.000    0.000    5.384    5.384 python_message.py:1071(SerializePartialToString)\n        1    0.000    0.000    0.003    0.003 <string>:2(quantize)\n        1    0.000    0.000    1.246    1.246 encoder.py:351(FieldSize)\n        1    0.000    0.000    0.002    0.002 numeric.py:136(ones)\n        5    0.000    0.000    0.000    0.000 python_message.py:1406(Modified)\n        2    0.000    0.000    0.000    0.000 python_message.py:660(field_setter)\n        6    0.000    0.000    0.000    0.000 containers.py:237(__init__)\n       21    0.000    0.000    0.000    0.000 {_weakref.proxy}\n      5/2    0.000    0.000    2.488    1.244 encoder.py:307(FieldSize)\n        1    0.000    0.000    0.004    0.004 containers.py:595(MergeFrom)\n        1    0.000    0.000    0.000    0.000 tf_record.py:57(__init__)\n        8    0.000    0.000    0.000    0.000 python_message.py:537(_GetFieldByName)\n        5    0.000    0.000    0.000    0.000 python_message.py:1332(_UpdateOneofState)\n        6    0.000    0.000    0.000    0.000 containers.py:192(__init__)\n       10    0.000    0.000    0.000    0.000 python_message.py:1004(SetListener)\n        2    0.000    0.000    0.000    0.000 {setattr}\n        1    0.000    0.000    0.000    0.000 python_message.py:271(_IsMapField)\n        5    0.000    0.000    0.000    0.000 containers.py:206(__len__)\n        1    0.000    0.000    0.000    0.000 {numpy.core.multiarray.empty}\n        1    0.000    0.000    0.003    0.003 tf_record.py:78(write)\n        2    0.000    0.000    0.000    0.000 python_message.py:379(MakeMessageMapDefault)\n        1    0.000    0.000    0.000    0.000 {_codecs.utf_8_decode}\n        1    0.000    0.000    5.384    5.384 python_message.py:1057(SerializeToString)\n        2    0.000    0.000    0.000    0.000 python_message.py:651(getter)\n        1    0.000    0.000    0.003    0.003 pywrap_tensorflow.py:183(WriteRecord)\n        2    0.000    0.000    0.000    0.000 containers.py:525(__init__)\n        2    0.000    0.000    0.000    0.000 descriptor.py:118(GetOptions)\n        1    0.000    0.000    0.000    0.000 {method 'decode' of 'str' objects}\n        2    0.000    0.000    0.000    0.000 containers.py:586(__len__)\n        5    0.000    0.000    0.000    0.000 {method 'setdefault' of 'dict' objects}\n       12    0.000    0.000    0.000    0.000 {method 'get' of 'dict' objects}\n       12    0.000    0.000    0.000    0.000 python_message.py:792(<lambda>)\n        1    0.000    0.000    0.000    0.000 compat.py:27(as_bytes)\n        1    0.000    0.000    0.000    0.000 utf_8.py:15(decode)\n        3    0.000    0.000    0.000    0.000 containers.py:589(__iter__)\n        4    0.000    0.000    0.000    0.000 {iter}\n        1    0.000    0.000    0.000    0.000 python_message.py:277(_IsMessageMapField)\n        1    0.000    0.000    0.000    0.000 pywrap_tensorflow.py:182(<lambda>)\n        2    0.000    0.000    0.000    0.000 {method 'pop' of 'dict' objects}\n        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}\n\n```\n\n```\ndef quantize(x):\n    return x.astype(np.int8).tostring()\nwriter = tf.python_io.TFRecordWriter('/dev/null')\n%time q = quantize(np.ones((2**10, 2**10))) #fast\n%time bl = tf.train.BytesList(value=q) #slow\n%time example = tf.train.Example(features=tf.train.Features(feature={'':tf.train.Feature(bytes_list=bl)})) #fast\n%time s = example.SerializeToString() #very slow\n%time writer.write(s) #fast\n```\n\n```\nCPU times: user 8 ms, sys: 0 ns, total: 8 ms\nWall time: 5.11 ms\nCPU times: user 440 ms, sys: 4 ms, total: 444 ms\nWall time: 440 ms\nCPU times: user 20 ms, sys: 0 ns, total: 20 ms\nWall time: 20.4 ms\nCPU times: user 2.21 s, sys: 16 ms, total: 2.23 s\nWall time: 2.22 s\nCPU times: user 4 ms, sys: 0 ns, total: 4 ms\nWall time: 2.81 ms\n```\n\ni'm using the docker image tensorflow/tensorflow:latest-gpu with nvidia-docker on ubuntu 16.04\n"}