{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/300667233", "html_url": "https://github.com/tensorflow/tensorflow/issues/9823#issuecomment-300667233", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/9823", "id": 300667233, "node_id": "MDEyOklzc3VlQ29tbWVudDMwMDY2NzIzMw==", "user": {"login": "fesun", "id": 23738439, "node_id": "MDQ6VXNlcjIzNzM4NDM5", "avatar_url": "https://avatars3.githubusercontent.com/u/23738439?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fesun", "html_url": "https://github.com/fesun", "followers_url": "https://api.github.com/users/fesun/followers", "following_url": "https://api.github.com/users/fesun/following{/other_user}", "gists_url": "https://api.github.com/users/fesun/gists{/gist_id}", "starred_url": "https://api.github.com/users/fesun/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fesun/subscriptions", "organizations_url": "https://api.github.com/users/fesun/orgs", "repos_url": "https://api.github.com/users/fesun/repos", "events_url": "https://api.github.com/users/fesun/events{/privacy}", "received_events_url": "https://api.github.com/users/fesun/received_events", "type": "User", "site_admin": false}, "created_at": "2017-05-11T02:43:22Z", "updated_at": "2017-05-11T02:43:22Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I traced it using strace and found two mmap called by different two threads, so actually memory consumption is 2x than needed.</p>\n<p>Here is the code:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">import</span> time\n\nbucket_size <span class=\"pl-k\">=</span> <span class=\"pl-c1\">1000000000</span>\n\na <span class=\"pl-k\">=</span> tf.get_variable(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>W<span class=\"pl-pds\">\"</span></span>, [bucket_size], <span class=\"pl-v\">initializer</span><span class=\"pl-k\">=</span>tf.zeros_initializer, <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.float32, <span class=\"pl-v\">trainable</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>)\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>start to initialize variable<span class=\"pl-pds\">\"</span></span>)\n    time.sleep(<span class=\"pl-c1\">10</span>)\n    sess.run(a.initializer)\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>initialize variable done<span class=\"pl-pds\">\"</span></span>)\n\ntime.sleep(<span class=\"pl-c1\">10</span>)</pre></div>\n<p>Here is the strace output</p>\n<pre><code>[pid 25768] write(1, \"start to initialize variable\\n\", 29start to initialize variable\n &lt;unfinished ...&gt;\n[pid 25817] futex(0x26c92e4, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;\n[pid 25768] &lt;... write resumed&gt; )       = 29\n[pid 25768] select(0, NULL, NULL, NULL, {10, 0}) = 0 (Timeout)\n[pid 25768] mmap(NULL, 4294967296, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f2ec8000000\n[pid 25768] futex(0x26c92e4, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c92e0, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\n[pid 25817] &lt;... futex resumed&gt; )       = 0\n[pid 25768] futex(0x7ffdfa482a9c, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;\n[pid 25817] futex(0x26c92b8, FUTEX_WAKE_PRIVATE, 1) = 0\n[pid 25817] futex(0x26c9264, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c9260, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\n[pid 25816] &lt;... futex resumed&gt; )       = 0\n[pid 25817] mmap(NULL, 2097152, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0 &lt;unfinished ...&gt;\n[pid 25816] futex(0x26c9238, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;\n[pid 25817] &lt;... mmap resumed&gt; )        = 0x7f307f9ff000\n[pid 25816] &lt;... futex resumed&gt; )       = 0\n[pid 25817] munmap(0x7f307f9ff000, 2097152 &lt;unfinished ...&gt;\n[pid 25816] futex(0x26c9264, FUTEX_WAIT_PRIVATE, 3, NULL &lt;unfinished ...&gt;\n[pid 25817] &lt;... munmap resumed&gt; )      = 0\n[pid 25817] mmap(NULL, 4190208, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f307f800000\n[pid 25817] munmap(0x7f307fa00000, 2093056) = 0\n[pid 25817] mmap(NULL, 4294967296, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f2dc8000000\n[pid 25817] futex(0x26c9264, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c9260, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\n[pid 25816] &lt;... futex resumed&gt; )       = 0\n[pid 25817] futex(0x7ffdfa482a9c, FUTEX_CMP_REQUEUE_PRIVATE, 1, 2147483647, 0x7ffdfa482a70, 2) = 1\n[pid 25816] futex(0x26c9238, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;\n[pid 25817] futex(0x26c92e4, FUTEX_WAIT_PRIVATE, 3, NULL &lt;unfinished ...&gt;\n[pid 25816] &lt;... futex resumed&gt; )       = 0\n[pid 25768] &lt;... futex resumed&gt; )       = 0\n[pid 25816] futex(0x26c9264, FUTEX_WAIT_PRIVATE, 5, NULL &lt;unfinished ...&gt;\n[pid 25768] futex(0x7ffdfa482a70, FUTEX_WAKE_PRIVATE, 1) = 0\n[pid 25768] write(1, \"initialize variable done\\n\", 25initialize variable done\n</code></pre>\n<p>Both 25768 25817 called mmap to allocate 4G memory. Why?</p>", "body_text": "I traced it using strace and found two mmap called by different two threads, so actually memory consumption is 2x than needed.\nHere is the code:\nimport tensorflow as tf\nimport time\n\nbucket_size = 1000000000\n\na = tf.get_variable(\"W\", [bucket_size], initializer=tf.zeros_initializer, dtype=tf.float32, trainable=False)\n\nwith tf.Session() as sess:\n    print(\"start to initialize variable\")\n    time.sleep(10)\n    sess.run(a.initializer)\n    print(\"initialize variable done\")\n\ntime.sleep(10)\nHere is the strace output\n[pid 25768] write(1, \"start to initialize variable\\n\", 29start to initialize variable\n <unfinished ...>\n[pid 25817] futex(0x26c92e4, FUTEX_WAIT_PRIVATE, 1, NULL <unfinished ...>\n[pid 25768] <... write resumed> )       = 29\n[pid 25768] select(0, NULL, NULL, NULL, {10, 0}) = 0 (Timeout)\n[pid 25768] mmap(NULL, 4294967296, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f2ec8000000\n[pid 25768] futex(0x26c92e4, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c92e0, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\n[pid 25817] <... futex resumed> )       = 0\n[pid 25768] futex(0x7ffdfa482a9c, FUTEX_WAIT_PRIVATE, 1, NULL <unfinished ...>\n[pid 25817] futex(0x26c92b8, FUTEX_WAKE_PRIVATE, 1) = 0\n[pid 25817] futex(0x26c9264, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c9260, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\n[pid 25816] <... futex resumed> )       = 0\n[pid 25817] mmap(NULL, 2097152, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0 <unfinished ...>\n[pid 25816] futex(0x26c9238, FUTEX_WAKE_PRIVATE, 1 <unfinished ...>\n[pid 25817] <... mmap resumed> )        = 0x7f307f9ff000\n[pid 25816] <... futex resumed> )       = 0\n[pid 25817] munmap(0x7f307f9ff000, 2097152 <unfinished ...>\n[pid 25816] futex(0x26c9264, FUTEX_WAIT_PRIVATE, 3, NULL <unfinished ...>\n[pid 25817] <... munmap resumed> )      = 0\n[pid 25817] mmap(NULL, 4190208, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f307f800000\n[pid 25817] munmap(0x7f307fa00000, 2093056) = 0\n[pid 25817] mmap(NULL, 4294967296, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f2dc8000000\n[pid 25817] futex(0x26c9264, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c9260, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\n[pid 25816] <... futex resumed> )       = 0\n[pid 25817] futex(0x7ffdfa482a9c, FUTEX_CMP_REQUEUE_PRIVATE, 1, 2147483647, 0x7ffdfa482a70, 2) = 1\n[pid 25816] futex(0x26c9238, FUTEX_WAKE_PRIVATE, 1 <unfinished ...>\n[pid 25817] futex(0x26c92e4, FUTEX_WAIT_PRIVATE, 3, NULL <unfinished ...>\n[pid 25816] <... futex resumed> )       = 0\n[pid 25768] <... futex resumed> )       = 0\n[pid 25816] futex(0x26c9264, FUTEX_WAIT_PRIVATE, 5, NULL <unfinished ...>\n[pid 25768] futex(0x7ffdfa482a70, FUTEX_WAKE_PRIVATE, 1) = 0\n[pid 25768] write(1, \"initialize variable done\\n\", 25initialize variable done\n\nBoth 25768 25817 called mmap to allocate 4G memory. Why?", "body": "I traced it using strace and found two mmap called by different two threads, so actually memory consumption is 2x than needed.\r\n\r\nHere is the code:\r\n```python\r\nimport tensorflow as tf\r\nimport time\r\n\r\nbucket_size = 1000000000\r\n\r\na = tf.get_variable(\"W\", [bucket_size], initializer=tf.zeros_initializer, dtype=tf.float32, trainable=False)\r\n\r\nwith tf.Session() as sess:\r\n    print(\"start to initialize variable\")\r\n    time.sleep(10)\r\n    sess.run(a.initializer)\r\n    print(\"initialize variable done\")\r\n\r\ntime.sleep(10)\r\n```\r\n\r\nHere is the strace output\r\n```\r\n[pid 25768] write(1, \"start to initialize variable\\n\", 29start to initialize variable\r\n <unfinished ...>\r\n[pid 25817] futex(0x26c92e4, FUTEX_WAIT_PRIVATE, 1, NULL <unfinished ...>\r\n[pid 25768] <... write resumed> )       = 29\r\n[pid 25768] select(0, NULL, NULL, NULL, {10, 0}) = 0 (Timeout)\r\n[pid 25768] mmap(NULL, 4294967296, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f2ec8000000\r\n[pid 25768] futex(0x26c92e4, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c92e0, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\r\n[pid 25817] <... futex resumed> )       = 0\r\n[pid 25768] futex(0x7ffdfa482a9c, FUTEX_WAIT_PRIVATE, 1, NULL <unfinished ...>\r\n[pid 25817] futex(0x26c92b8, FUTEX_WAKE_PRIVATE, 1) = 0\r\n[pid 25817] futex(0x26c9264, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c9260, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\r\n[pid 25816] <... futex resumed> )       = 0\r\n[pid 25817] mmap(NULL, 2097152, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0 <unfinished ...>\r\n[pid 25816] futex(0x26c9238, FUTEX_WAKE_PRIVATE, 1 <unfinished ...>\r\n[pid 25817] <... mmap resumed> )        = 0x7f307f9ff000\r\n[pid 25816] <... futex resumed> )       = 0\r\n[pid 25817] munmap(0x7f307f9ff000, 2097152 <unfinished ...>\r\n[pid 25816] futex(0x26c9264, FUTEX_WAIT_PRIVATE, 3, NULL <unfinished ...>\r\n[pid 25817] <... munmap resumed> )      = 0\r\n[pid 25817] mmap(NULL, 4190208, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f307f800000\r\n[pid 25817] munmap(0x7f307fa00000, 2093056) = 0\r\n[pid 25817] mmap(NULL, 4294967296, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7f2dc8000000\r\n[pid 25817] futex(0x26c9264, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x26c9260, {FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1}) = 1\r\n[pid 25816] <... futex resumed> )       = 0\r\n[pid 25817] futex(0x7ffdfa482a9c, FUTEX_CMP_REQUEUE_PRIVATE, 1, 2147483647, 0x7ffdfa482a70, 2) = 1\r\n[pid 25816] futex(0x26c9238, FUTEX_WAKE_PRIVATE, 1 <unfinished ...>\r\n[pid 25817] futex(0x26c92e4, FUTEX_WAIT_PRIVATE, 3, NULL <unfinished ...>\r\n[pid 25816] <... futex resumed> )       = 0\r\n[pid 25768] <... futex resumed> )       = 0\r\n[pid 25816] futex(0x26c9264, FUTEX_WAIT_PRIVATE, 5, NULL <unfinished ...>\r\n[pid 25768] futex(0x7ffdfa482a70, FUTEX_WAKE_PRIVATE, 1) = 0\r\n[pid 25768] write(1, \"initialize variable done\\n\", 25initialize variable done\r\n```\r\n\r\nBoth 25768 25817 called mmap to allocate 4G memory. Why?"}