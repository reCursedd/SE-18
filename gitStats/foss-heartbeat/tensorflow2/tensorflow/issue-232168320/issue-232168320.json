{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10282", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10282/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10282/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10282/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/10282", "id": 232168320, "node_id": "MDU6SXNzdWUyMzIxNjgzMjA=", "number": 10282, "title": "Conflict between Defun and py_func", "user": {"login": "EverettYou", "id": 4394330, "node_id": "MDQ6VXNlcjQzOTQzMzA=", "avatar_url": "https://avatars0.githubusercontent.com/u/4394330?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EverettYou", "html_url": "https://github.com/EverettYou", "followers_url": "https://api.github.com/users/EverettYou/followers", "following_url": "https://api.github.com/users/EverettYou/following{/other_user}", "gists_url": "https://api.github.com/users/EverettYou/gists{/gist_id}", "starred_url": "https://api.github.com/users/EverettYou/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EverettYou/subscriptions", "organizations_url": "https://api.github.com/users/EverettYou/orgs", "repos_url": "https://api.github.com/users/EverettYou/repos", "events_url": "https://api.github.com/users/EverettYou/events{/privacy}", "received_events_url": "https://api.github.com/users/EverettYou/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-05-30T07:45:51Z", "updated_at": "2017-09-08T04:56:33Z", "closed_at": "2017-09-08T04:56:33Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Mac OS 10.12.5</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: v1.1.0-rc0-61-g1ec6ed5 1.1.0</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A (run on CPU)</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<pre><code>import tensorflow as tf\nfrom tensorflow.python.framework import function\n\ndef f(x):\n    return x\n\n@function.Defun(tf.float32, func_name='f')\ndef f1(x): \n    return tf.py_func(f, [x], tf.float32)\n\nwith tf.Session() as sess:\n    x = tf.constant(1.)\n    print(sess.run(f1(x)))\n</code></pre>\n<h3>Describe the problem</h3>\n<p>The decorator <code>Defun</code> does not work with <code>py_func</code>, and generates the KeyError when attempting to call with the token <code>pyfunc_#</code>.  If one comments out the decorator <code>@function.Defun(...)</code>, or if one redefines <code>def f1(x): return x</code>, the error will disappear.</p>\n<h3>Source code / logs</h3>\n<p>Error traceback:</p>\n<pre><code>---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/ops/script_ops.py in __call__(self, token, args)\n     77   def __call__(self, token, args):\n     78     \"\"\"Calls the registered function for `token` with args.\"\"\"\n---&gt; 79     func = self._funcs[token]\n     80     if func is None:\n     81       raise ValueError(\"callback %s is not found\" % token)\n\nKeyError: 'pyfunc_0'\n\n---------------------------------------------------------------------------\nInternalError                             Traceback (most recent call last)\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n   1038     try:\n-&gt; 1039       return fn(*args)\n   1040     except errors.OpError as e:\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\n   1020                                  feed_dict, fetch_list, target_list,\n-&gt; 1021                                  status, run_metadata)\n   1022 \n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/contextlib.py in __exit__(self, type, value, traceback)\n     65             try:\n---&gt; 66                 next(self.gen)\n     67             except StopIteration:\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py in raise_exception_on_not_ok_status()\n    465           compat.as_text(pywrap_tensorflow.TF_Message(status)),\n--&gt; 466           pywrap_tensorflow.TF_GetCode(status))\n    467   finally:\n\nInternalError: Failed to run py callback pyfunc_0: see error log.\n\t [[Node: n1 = PyFunc[Tin=[DT_FLOAT], Tout=[DT_FLOAT], token=\"pyfunc_0\"](n0)]]\n\t [[Node: f = f[_device=\"/job:localhost/replica:0/task:0/cpu:0\"](Const)]]\n\nDuring handling of the above exception, another exception occurred:\n\nInternalError                             Traceback (most recent call last)\n&lt;ipython-input-1-0ed0f802b342&gt; in &lt;module&gt;()\n      8 with tf.Session() as sess:\n      9     x = tf.constant(1.)\n---&gt; 10     print(sess.run(f1(x)))\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\n    776     try:\n    777       result = self._run(None, fetches, feed_dict, options_ptr,\n--&gt; 778                          run_metadata_ptr)\n    779       if run_metadata:\n    780         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\n    980     if final_fetches or final_targets:\n    981       results = self._do_run(handle, final_targets, final_fetches,\n--&gt; 982                              feed_dict_string, options, run_metadata)\n    983     else:\n    984       results = []\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n   1030     if handle is None:\n   1031       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n-&gt; 1032                            target_list, options, run_metadata)\n   1033     else:\n   1034       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n   1050         except KeyError:\n   1051           pass\n-&gt; 1052       raise type(e)(node_def, op, message)\n   1053 \n   1054   def _extend_graph(self):\n\nInternalError: Failed to run py callback pyfunc_0: see error log.\n\t [[Node: n1 = PyFunc[Tin=[DT_FLOAT], Tout=[DT_FLOAT], token=\"pyfunc_0\"](n0)]]\n\t [[Node: f = f[_device=\"/job:localhost/replica:0/task:0/cpu:0\"](Const)]]\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Mac OS 10.12.5\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): v1.1.0-rc0-61-g1ec6ed5 1.1.0\nBazel version (if compiling from source): N/A\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A (run on CPU)\nExact command to reproduce:\n\nimport tensorflow as tf\nfrom tensorflow.python.framework import function\n\ndef f(x):\n    return x\n\n@function.Defun(tf.float32, func_name='f')\ndef f1(x): \n    return tf.py_func(f, [x], tf.float32)\n\nwith tf.Session() as sess:\n    x = tf.constant(1.)\n    print(sess.run(f1(x)))\n\nDescribe the problem\nThe decorator Defun does not work with py_func, and generates the KeyError when attempting to call with the token pyfunc_#.  If one comments out the decorator @function.Defun(...), or if one redefines def f1(x): return x, the error will disappear.\nSource code / logs\nError traceback:\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/ops/script_ops.py in __call__(self, token, args)\n     77   def __call__(self, token, args):\n     78     \"\"\"Calls the registered function for `token` with args.\"\"\"\n---> 79     func = self._funcs[token]\n     80     if func is None:\n     81       raise ValueError(\"callback %s is not found\" % token)\n\nKeyError: 'pyfunc_0'\n\n---------------------------------------------------------------------------\nInternalError                             Traceback (most recent call last)\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n   1038     try:\n-> 1039       return fn(*args)\n   1040     except errors.OpError as e:\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\n   1020                                  feed_dict, fetch_list, target_list,\n-> 1021                                  status, run_metadata)\n   1022 \n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/contextlib.py in __exit__(self, type, value, traceback)\n     65             try:\n---> 66                 next(self.gen)\n     67             except StopIteration:\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py in raise_exception_on_not_ok_status()\n    465           compat.as_text(pywrap_tensorflow.TF_Message(status)),\n--> 466           pywrap_tensorflow.TF_GetCode(status))\n    467   finally:\n\nInternalError: Failed to run py callback pyfunc_0: see error log.\n\t [[Node: n1 = PyFunc[Tin=[DT_FLOAT], Tout=[DT_FLOAT], token=\"pyfunc_0\"](n0)]]\n\t [[Node: f = f[_device=\"/job:localhost/replica:0/task:0/cpu:0\"](Const)]]\n\nDuring handling of the above exception, another exception occurred:\n\nInternalError                             Traceback (most recent call last)\n<ipython-input-1-0ed0f802b342> in <module>()\n      8 with tf.Session() as sess:\n      9     x = tf.constant(1.)\n---> 10     print(sess.run(f1(x)))\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\n    776     try:\n    777       result = self._run(None, fetches, feed_dict, options_ptr,\n--> 778                          run_metadata_ptr)\n    779       if run_metadata:\n    780         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\n    980     if final_fetches or final_targets:\n    981       results = self._do_run(handle, final_targets, final_fetches,\n--> 982                              feed_dict_string, options, run_metadata)\n    983     else:\n    984       results = []\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n   1030     if handle is None:\n   1031       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n-> 1032                            target_list, options, run_metadata)\n   1033     else:\n   1034       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n   1050         except KeyError:\n   1051           pass\n-> 1052       raise type(e)(node_def, op, message)\n   1053 \n   1054   def _extend_graph(self):\n\nInternalError: Failed to run py callback pyfunc_0: see error log.\n\t [[Node: n1 = PyFunc[Tin=[DT_FLOAT], Tout=[DT_FLOAT], token=\"pyfunc_0\"](n0)]]\n\t [[Node: f = f[_device=\"/job:localhost/replica:0/task:0/cpu:0\"](Const)]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac OS 10.12.5\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: v1.1.0-rc0-61-g1ec6ed5 1.1.0\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A (run on CPU)\r\n- **Exact command to reproduce**:\r\n\r\n```\r\nimport tensorflow as tf\r\nfrom tensorflow.python.framework import function\r\n\r\ndef f(x):\r\n    return x\r\n\r\n@function.Defun(tf.float32, func_name='f')\r\ndef f1(x): \r\n    return tf.py_func(f, [x], tf.float32)\r\n\r\nwith tf.Session() as sess:\r\n    x = tf.constant(1.)\r\n    print(sess.run(f1(x)))\r\n```\r\n\r\n### Describe the problem\r\nThe decorator `Defun` does not work with `py_func`, and generates the KeyError when attempting to call with the token `pyfunc_#`.  If one comments out the decorator `@function.Defun(...)`, or if one redefines `def f1(x): return x`, the error will disappear.\r\n\r\n### Source code / logs\r\nError traceback:\r\n```\r\n---------------------------------------------------------------------------\r\nKeyError                                  Traceback (most recent call last)\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/ops/script_ops.py in __call__(self, token, args)\r\n     77   def __call__(self, token, args):\r\n     78     \"\"\"Calls the registered function for `token` with args.\"\"\"\r\n---> 79     func = self._funcs[token]\r\n     80     if func is None:\r\n     81       raise ValueError(\"callback %s is not found\" % token)\r\n\r\nKeyError: 'pyfunc_0'\r\n\r\n---------------------------------------------------------------------------\r\nInternalError                             Traceback (most recent call last)\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\r\n   1038     try:\r\n-> 1039       return fn(*args)\r\n   1040     except errors.OpError as e:\r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\r\n   1020                                  feed_dict, fetch_list, target_list,\r\n-> 1021                                  status, run_metadata)\r\n   1022 \r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/contextlib.py in __exit__(self, type, value, traceback)\r\n     65             try:\r\n---> 66                 next(self.gen)\r\n     67             except StopIteration:\r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py in raise_exception_on_not_ok_status()\r\n    465           compat.as_text(pywrap_tensorflow.TF_Message(status)),\r\n--> 466           pywrap_tensorflow.TF_GetCode(status))\r\n    467   finally:\r\n\r\nInternalError: Failed to run py callback pyfunc_0: see error log.\r\n\t [[Node: n1 = PyFunc[Tin=[DT_FLOAT], Tout=[DT_FLOAT], token=\"pyfunc_0\"](n0)]]\r\n\t [[Node: f = f[_device=\"/job:localhost/replica:0/task:0/cpu:0\"](Const)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nInternalError                             Traceback (most recent call last)\r\n<ipython-input-1-0ed0f802b342> in <module>()\r\n      8 with tf.Session() as sess:\r\n      9     x = tf.constant(1.)\r\n---> 10     print(sess.run(f1(x)))\r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\r\n    776     try:\r\n    777       result = self._run(None, fetches, feed_dict, options_ptr,\r\n--> 778                          run_metadata_ptr)\r\n    779       if run_metadata:\r\n    780         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\r\n    980     if final_fetches or final_targets:\r\n    981       results = self._do_run(handle, final_targets, final_fetches,\r\n--> 982                              feed_dict_string, options, run_metadata)\r\n    983     else:\r\n    984       results = []\r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\r\n   1030     if handle is None:\r\n   1031       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\r\n-> 1032                            target_list, options, run_metadata)\r\n   1033     else:\r\n   1034       return self._do_call(_prun_fn, self._session, handle, feed_dict,\r\n\r\n/Library/Frameworks/Python.framework/Versions/3.5/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\r\n   1050         except KeyError:\r\n   1051           pass\r\n-> 1052       raise type(e)(node_def, op, message)\r\n   1053 \r\n   1054   def _extend_graph(self):\r\n\r\nInternalError: Failed to run py callback pyfunc_0: see error log.\r\n\t [[Node: n1 = PyFunc[Tin=[DT_FLOAT], Tout=[DT_FLOAT], token=\"pyfunc_0\"](n0)]]\r\n\t [[Node: f = f[_device=\"/job:localhost/replica:0/task:0/cpu:0\"](Const)]]\r\n```"}