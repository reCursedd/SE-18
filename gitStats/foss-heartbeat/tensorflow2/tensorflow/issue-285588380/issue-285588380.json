{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15804", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15804/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15804/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/15804/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/15804", "id": 285588380, "node_id": "MDU6SXNzdWUyODU1ODgzODA=", "number": 15804, "title": "[bug]libtensorflowlite_jni.so crash when creating interpreter with byteBuffer mode", "user": {"login": "tonghuizhang", "id": 35052496, "node_id": "MDQ6VXNlcjM1MDUyNDk2", "avatar_url": "https://avatars3.githubusercontent.com/u/35052496?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tonghuizhang", "html_url": "https://github.com/tonghuizhang", "followers_url": "https://api.github.com/users/tonghuizhang/followers", "following_url": "https://api.github.com/users/tonghuizhang/following{/other_user}", "gists_url": "https://api.github.com/users/tonghuizhang/gists{/gist_id}", "starred_url": "https://api.github.com/users/tonghuizhang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tonghuizhang/subscriptions", "organizations_url": "https://api.github.com/users/tonghuizhang/orgs", "repos_url": "https://api.github.com/users/tonghuizhang/repos", "events_url": "https://api.github.com/users/tonghuizhang/events{/privacy}", "received_events_url": "https://api.github.com/users/tonghuizhang/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 750616506, "node_id": "MDU6TGFiZWw3NTA2MTY1MDY=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:lite", "name": "comp:lite", "color": "0052cc", "default": false}, {"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "aselle", "id": 326106, "node_id": "MDQ6VXNlcjMyNjEwNg==", "avatar_url": "https://avatars1.githubusercontent.com/u/326106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aselle", "html_url": "https://github.com/aselle", "followers_url": "https://api.github.com/users/aselle/followers", "following_url": "https://api.github.com/users/aselle/following{/other_user}", "gists_url": "https://api.github.com/users/aselle/gists{/gist_id}", "starred_url": "https://api.github.com/users/aselle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aselle/subscriptions", "organizations_url": "https://api.github.com/users/aselle/orgs", "repos_url": "https://api.github.com/users/aselle/repos", "events_url": "https://api.github.com/users/aselle/events{/privacy}", "received_events_url": "https://api.github.com/users/aselle/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 9, "created_at": "2018-01-03T02:51:32Z", "updated_at": "2018-04-25T15:02:55Z", "closed_at": "2018-04-25T15:02:54Z", "author_association": "NONE", "body_html": "<p>Dear tensorflow developers\uff1a<br>\nA crash is found when using java nio to create interpreter of tensorflowLite, which make us puzzled for a long time. I hope you can help us to solve the issue, thanks &amp; best regard. The issues will be described in detail as follows:</p>\n<pre><code>   Naturally, we use the function provided by tensorflow below to create model &amp; interpreter.      \n\n   NativeInterpreterWrapper(ByteBuffer modelByteBuffer) {\n      errorHandle = createErrorReporter(ERROR_BUFFER_SIZE);\n      modelHandle = createModelWithBuffer(modelByteBuffer, errorHandle);\n      interpreterHandle = createInterpreter(modelHandle);\n   }\n\n   step 1.  We create the Input parameter modelByteBuffer. The ByteBuffer as follows:\n\n      fileChannel.map(FileChannel.MapMode.READ_ONLY, startOffset, declaredLength);\n      \n      The following conditions should be satisfied at the same time, \n      1)  startOffset is not zero,  for example startOffset = 200\n           If the startOffset is zero, the issue will not occur.\n      2)  the byteBuffer size is very large, for example size = 80MB\n           if the size is small, the issue will not occur.\n\n   Step 2. We call the funtion NativeInterpreterWrapper with byteBuffer.\n    \n   Unfortunately, after running  step 1 &amp; 2, the crash is occured as follows:\n</code></pre>\n<p>01-02 18:58:54.544 21135-21135/? A/DEBUG: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG: Build fingerprint: 'google/marlin/marlin:8.0.0/OPR3.170623.013/4397526:user/release-keys'<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG: Revision: '0'<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG: ABI: 'arm'<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG: pid: 20837, tid: 20837, name: fish.xxxxxx  &gt;&gt;&gt; com.taobao.idlexxxx.xxxxxx &lt;&lt;&lt;<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG: signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xa733f5a6<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r0 a733f5a6  r1 00000004  r2 00000006  r3 00000000<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r4 e0f59c58  r5 de9734b0  r6 a73f5160  r7 ffc5de20<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r8 00000004  r9 00000000  sl ffc5de90  fp a733f57a<br>\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     ip edee063c  sp ffc5dd90  lr edea7741  pc a73aa208  cpsr 200f1830<br>\n01-02 18:58:54.546 21135-21135/? A/DEBUG: backtrace:<br>\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #00 pc 00062208  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so<br>\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> pc 00062d53  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so<br>\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115894138\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/2\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/2/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/2\">#2</a> pc 00006d93  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so (Java_org_tensorflow_lite_NativeInterpreterWrapper_createInterpreter+50)<br>\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115896656\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/3\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/3/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/3\">#3</a> pc 000281ef  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/oat/arm/base.odex (offset 0x1c000)<br>\n01-02 18:58:55.403 742-742/? E//system/bin/tombstoned: Tombstone written to: /data/tombstones//tombstone_03</p>\n<pre><code>While, If we reallocate memory, the issue will also not occur .The relative code is as follows:\n\u2026\u2026.\nrf = new RandomAccessFile(modelPath, \"r\");\ndeclaredLength = rf.length() - startOffset;\nrf.seek(startOffset);\nByteBuffer byteBuffer = ByteBuffer.allocateDirect((int) declaredLength);\n\u2026\u2026.\nbyteBuffer.put(tfbyte);\n\u2026\u2026.\n\nIs there a memory allocation bug? And could you tell me how to avoid the crash if not reallocate \nmemory\uff1f Thanks very much.\n</code></pre>", "body_text": "Dear tensorflow developers\uff1a\nA crash is found when using java nio to create interpreter of tensorflowLite, which make us puzzled for a long time. I hope you can help us to solve the issue, thanks & best regard. The issues will be described in detail as follows:\n   Naturally, we use the function provided by tensorflow below to create model & interpreter.      \n\n   NativeInterpreterWrapper(ByteBuffer modelByteBuffer) {\n      errorHandle = createErrorReporter(ERROR_BUFFER_SIZE);\n      modelHandle = createModelWithBuffer(modelByteBuffer, errorHandle);\n      interpreterHandle = createInterpreter(modelHandle);\n   }\n\n   step 1.  We create the Input parameter modelByteBuffer. The ByteBuffer as follows:\n\n      fileChannel.map(FileChannel.MapMode.READ_ONLY, startOffset, declaredLength);\n      \n      The following conditions should be satisfied at the same time, \n      1)  startOffset is not zero,  for example startOffset = 200\n           If the startOffset is zero, the issue will not occur.\n      2)  the byteBuffer size is very large, for example size = 80MB\n           if the size is small, the issue will not occur.\n\n   Step 2. We call the funtion NativeInterpreterWrapper with byteBuffer.\n    \n   Unfortunately, after running  step 1 & 2, the crash is occured as follows:\n\n01-02 18:58:54.544 21135-21135/? A/DEBUG: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\n01-02 18:58:54.545 21135-21135/? A/DEBUG: Build fingerprint: 'google/marlin/marlin:8.0.0/OPR3.170623.013/4397526:user/release-keys'\n01-02 18:58:54.545 21135-21135/? A/DEBUG: Revision: '0'\n01-02 18:58:54.545 21135-21135/? A/DEBUG: ABI: 'arm'\n01-02 18:58:54.545 21135-21135/? A/DEBUG: pid: 20837, tid: 20837, name: fish.xxxxxx  >>> com.taobao.idlexxxx.xxxxxx <<<\n01-02 18:58:54.545 21135-21135/? A/DEBUG: signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xa733f5a6\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r0 a733f5a6  r1 00000004  r2 00000006  r3 00000000\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r4 e0f59c58  r5 de9734b0  r6 a73f5160  r7 ffc5de20\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r8 00000004  r9 00000000  sl ffc5de90  fp a733f57a\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     ip edee063c  sp ffc5dd90  lr edea7741  pc a73aa208  cpsr 200f1830\n01-02 18:58:54.546 21135-21135/? A/DEBUG: backtrace:\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #00 pc 00062208  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #1 pc 00062d53  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #2 pc 00006d93  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so (Java_org_tensorflow_lite_NativeInterpreterWrapper_createInterpreter+50)\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #3 pc 000281ef  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/oat/arm/base.odex (offset 0x1c000)\n01-02 18:58:55.403 742-742/? E//system/bin/tombstoned: Tombstone written to: /data/tombstones//tombstone_03\nWhile, If we reallocate memory, the issue will also not occur .The relative code is as follows:\n\u2026\u2026.\nrf = new RandomAccessFile(modelPath, \"r\");\ndeclaredLength = rf.length() - startOffset;\nrf.seek(startOffset);\nByteBuffer byteBuffer = ByteBuffer.allocateDirect((int) declaredLength);\n\u2026\u2026.\nbyteBuffer.put(tfbyte);\n\u2026\u2026.\n\nIs there a memory allocation bug? And could you tell me how to avoid the crash if not reallocate \nmemory\uff1f Thanks very much.", "body": "Dear tensorflow developers\uff1a\r\n       A crash is found when using java nio to create interpreter of tensorflowLite, which make us puzzled for a long time. I hope you can help us to solve the issue, thanks & best regard. The issues will be described in detail as follows:\r\n\r\n       Naturally, we use the function provided by tensorflow below to create model & interpreter.      \r\n \r\n       NativeInterpreterWrapper(ByteBuffer modelByteBuffer) {\r\n          errorHandle = createErrorReporter(ERROR_BUFFER_SIZE);\r\n          modelHandle = createModelWithBuffer(modelByteBuffer, errorHandle);\r\n          interpreterHandle = createInterpreter(modelHandle);\r\n       }\r\n\r\n       step 1.  We create the Input parameter modelByteBuffer. The ByteBuffer as follows:\r\n\r\n          fileChannel.map(FileChannel.MapMode.READ_ONLY, startOffset, declaredLength);\r\n          \r\n          The following conditions should be satisfied at the same time, \r\n          1)  startOffset is not zero,  for example startOffset = 200\r\n               If the startOffset is zero, the issue will not occur.\r\n          2)  the byteBuffer size is very large, for example size = 80MB\r\n               if the size is small, the issue will not occur.\r\n\r\n       Step 2. We call the funtion NativeInterpreterWrapper with byteBuffer.\r\n        \r\n       Unfortunately, after running  step 1 & 2, the crash is occured as follows:\r\n\r\n01-02 18:58:54.544 21135-21135/? A/DEBUG: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG: Build fingerprint: 'google/marlin/marlin:8.0.0/OPR3.170623.013/4397526:user/release-keys'\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG: Revision: '0'\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG: ABI: 'arm'\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG: pid: 20837, tid: 20837, name: fish.xxxxxx  >>> com.taobao.idlexxxx.xxxxxx <<<\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG: signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xa733f5a6\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r0 a733f5a6  r1 00000004  r2 00000006  r3 00000000\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r4 e0f59c58  r5 de9734b0  r6 a73f5160  r7 ffc5de20\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     r8 00000004  r9 00000000  sl ffc5de90  fp a733f57a\r\n01-02 18:58:54.545 21135-21135/? A/DEBUG:     ip edee063c  sp ffc5dd90  lr edea7741  pc a73aa208  cpsr 200f1830\r\n01-02 18:58:54.546 21135-21135/? A/DEBUG: backtrace:\r\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #00 pc 00062208  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so\r\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #01 pc 00062d53  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so\r\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #02 pc 00006d93  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/lib/arm/libtensorflowlite_jni.so (Java_org_tensorflow_lite_NativeInterpreterWrapper_createInterpreter+50)\r\n01-02 18:58:54.546 21135-21135/? A/DEBUG:     #03 pc 000281ef  /data/app/com.taobao.idlexxxx.xxxxxx-qw202S8jC-x2xWFXznSPlw==/oat/arm/base.odex (offset 0x1c000)\r\n01-02 18:58:55.403 742-742/? E//system/bin/tombstoned: Tombstone written to: /data/tombstones//tombstone_03\r\n\r\n\r\n    While, If we reallocate memory, the issue will also not occur .The relative code is as follows:\r\n    \u2026\u2026.\r\n    rf = new RandomAccessFile(modelPath, \"r\");\r\n    declaredLength = rf.length() - startOffset;\r\n    rf.seek(startOffset);\r\n    ByteBuffer byteBuffer = ByteBuffer.allocateDirect((int) declaredLength);\r\n    \u2026\u2026.\r\n    byteBuffer.put(tfbyte);\r\n    \u2026\u2026.\r\n\r\n    Is there a memory allocation bug? And could you tell me how to avoid the crash if not reallocate \r\n    memory\uff1f Thanks very much.\r\n  "}