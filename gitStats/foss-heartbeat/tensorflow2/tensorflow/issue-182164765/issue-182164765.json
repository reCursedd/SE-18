{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4886", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4886/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4886/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4886/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/4886", "id": 182164765, "node_id": "MDU6SXNzdWUxODIxNjQ3NjU=", "number": 4886, "title": "Gradient of tf.reduce_max and tf.nn.max_pool don't agree with each other, and theano", "user": {"login": "ppwwyyxx", "id": 1381301, "node_id": "MDQ6VXNlcjEzODEzMDE=", "avatar_url": "https://avatars3.githubusercontent.com/u/1381301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ppwwyyxx", "html_url": "https://github.com/ppwwyyxx", "followers_url": "https://api.github.com/users/ppwwyyxx/followers", "following_url": "https://api.github.com/users/ppwwyyxx/following{/other_user}", "gists_url": "https://api.github.com/users/ppwwyyxx/gists{/gist_id}", "starred_url": "https://api.github.com/users/ppwwyyxx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ppwwyyxx/subscriptions", "organizations_url": "https://api.github.com/users/ppwwyyxx/orgs", "repos_url": "https://api.github.com/users/ppwwyyxx/repos", "events_url": "https://api.github.com/users/ppwwyyxx/events{/privacy}", "received_events_url": "https://api.github.com/users/ppwwyyxx/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "ebrevdo", "id": 1794715, "node_id": "MDQ6VXNlcjE3OTQ3MTU=", "avatar_url": "https://avatars0.githubusercontent.com/u/1794715?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebrevdo", "html_url": "https://github.com/ebrevdo", "followers_url": "https://api.github.com/users/ebrevdo/followers", "following_url": "https://api.github.com/users/ebrevdo/following{/other_user}", "gists_url": "https://api.github.com/users/ebrevdo/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebrevdo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebrevdo/subscriptions", "organizations_url": "https://api.github.com/users/ebrevdo/orgs", "repos_url": "https://api.github.com/users/ebrevdo/repos", "events_url": "https://api.github.com/users/ebrevdo/events{/privacy}", "received_events_url": "https://api.github.com/users/ebrevdo/received_events", "type": "User", "site_admin": false}, {"login": "zheng-xq", "id": 15736910, "node_id": "MDQ6VXNlcjE1NzM2OTEw", "avatar_url": "https://avatars0.githubusercontent.com/u/15736910?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zheng-xq", "html_url": "https://github.com/zheng-xq", "followers_url": "https://api.github.com/users/zheng-xq/followers", "following_url": "https://api.github.com/users/zheng-xq/following{/other_user}", "gists_url": "https://api.github.com/users/zheng-xq/gists{/gist_id}", "starred_url": "https://api.github.com/users/zheng-xq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zheng-xq/subscriptions", "organizations_url": "https://api.github.com/users/zheng-xq/orgs", "repos_url": "https://api.github.com/users/zheng-xq/repos", "events_url": "https://api.github.com/users/zheng-xq/events{/privacy}", "received_events_url": "https://api.github.com/users/zheng-xq/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2016-10-11T03:25:55Z", "updated_at": "2016-10-28T06:26:15Z", "closed_at": "2016-10-28T06:26:15Z", "author_association": "CONTRIBUTOR", "body_html": "<div class=\"highlight highlight-source-python\"><pre>a <span class=\"pl-k\">=</span> tf.placeholder(<span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.float32, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>a<span class=\"pl-pds\">'</span></span>, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[<span class=\"pl-c1\">4</span>])\nb <span class=\"pl-k\">=</span> tf.reduce_max(a)\nb2 <span class=\"pl-k\">=</span> tf.nn.max_pool(tf.reshape(a, [<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">1</span>]),\n        [<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">2</span>,<span class=\"pl-c1\">2</span>,<span class=\"pl-c1\">1</span>], [<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">1</span>], <span class=\"pl-s\"><span class=\"pl-pds\">'</span>VALID<span class=\"pl-pds\">'</span></span>)[<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>]\nc <span class=\"pl-k\">=</span> tf.gradients([b], [a])[<span class=\"pl-c1\">0</span>]\nc2 <span class=\"pl-k\">=</span> tf.gradients([b2], [a])[<span class=\"pl-c1\">0</span>]\n\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    v <span class=\"pl-k\">=</span> np.asarray([<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">2</span>], <span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>float32<span class=\"pl-pds\">'</span></span>)\n    <span class=\"pl-c1\">print</span> sess.run(c, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{a:v})  <span class=\"pl-c\"><span class=\"pl-c\">#</span> 0, 0.3, 0.3, 0.3</span>\n    <span class=\"pl-c1\">print</span> sess.run(c2, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{a:v})  <span class=\"pl-c\"><span class=\"pl-c\">#</span> 0, 1, 0, 0</span>\n\n<span class=\"pl-k\">import</span> theano.tensor <span class=\"pl-k\">as</span> T\n<span class=\"pl-k\">import</span> theano.tensor.signal.downsample <span class=\"pl-k\">as</span> D\na <span class=\"pl-k\">=</span> T.fvector(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>a<span class=\"pl-pds\">'</span></span>)\nb <span class=\"pl-k\">=</span> T.max(a)\nb2 <span class=\"pl-k\">=</span> T.reshape(a, [<span class=\"pl-c1\">1</span>,<span class=\"pl-c1\">2</span>,<span class=\"pl-c1\">2</span>])\nb2 <span class=\"pl-k\">=</span> D.max_pool_2d(b2, [<span class=\"pl-c1\">2</span>,<span class=\"pl-c1\">2</span>])[<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>,<span class=\"pl-c1\">0</span>]\nc <span class=\"pl-k\">=</span> T.grad(b, a)\nc2 <span class=\"pl-k\">=</span> T.grad(b2, a)\n<span class=\"pl-c1\">print</span> c.eval({a: v})    <span class=\"pl-c\"><span class=\"pl-c\">#</span> 0, 1, 1, 1</span>\n<span class=\"pl-c1\">print</span> c2.eval({a: v})    <span class=\"pl-c\"><span class=\"pl-c\">#</span> 0, 1, 1, 1</span></pre></div>\n<p>Bug or feature? <g-emoji class=\"g-emoji\" alias=\"frowning\" fallback-src=\"https://assets-cdn.github.com/images/icons/emoji/unicode/1f626.png\">\ud83d\ude26</g-emoji> Although as subgradient they all seem to make sense, but is there a reason to justify the difference of reduce_max and max_pool?</p>\n<p>I saw the <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/ops/math_grad.py#L71\">comment</a> for reduce_max and it seems like the first one is feature.</p>", "body_text": "a = tf.placeholder(dtype=tf.float32, name='a', shape=[4])\nb = tf.reduce_max(a)\nb2 = tf.nn.max_pool(tf.reshape(a, [1, 2, 2, 1]),\n        [1,2,2,1], [1,1,1,1], 'VALID')[0,0,0,0]\nc = tf.gradients([b], [a])[0]\nc2 = tf.gradients([b2], [a])[0]\n\nwith tf.Session() as sess:\n    v = np.asarray([1, 2, 2, 2], dtype='float32')\n    print sess.run(c, feed_dict={a:v})  # 0, 0.3, 0.3, 0.3\n    print sess.run(c2, feed_dict={a:v})  # 0, 1, 0, 0\n\nimport theano.tensor as T\nimport theano.tensor.signal.downsample as D\na = T.fvector('a')\nb = T.max(a)\nb2 = T.reshape(a, [1,2,2])\nb2 = D.max_pool_2d(b2, [2,2])[0,0,0]\nc = T.grad(b, a)\nc2 = T.grad(b2, a)\nprint c.eval({a: v})    # 0, 1, 1, 1\nprint c2.eval({a: v})    # 0, 1, 1, 1\nBug or feature? \ud83d\ude26 Although as subgradient they all seem to make sense, but is there a reason to justify the difference of reduce_max and max_pool?\nI saw the comment for reduce_max and it seems like the first one is feature.", "body": "``` python\na = tf.placeholder(dtype=tf.float32, name='a', shape=[4])\nb = tf.reduce_max(a)\nb2 = tf.nn.max_pool(tf.reshape(a, [1, 2, 2, 1]),\n        [1,2,2,1], [1,1,1,1], 'VALID')[0,0,0,0]\nc = tf.gradients([b], [a])[0]\nc2 = tf.gradients([b2], [a])[0]\n\nwith tf.Session() as sess:\n    v = np.asarray([1, 2, 2, 2], dtype='float32')\n    print sess.run(c, feed_dict={a:v})  # 0, 0.3, 0.3, 0.3\n    print sess.run(c2, feed_dict={a:v})  # 0, 1, 0, 0\n\nimport theano.tensor as T\nimport theano.tensor.signal.downsample as D\na = T.fvector('a')\nb = T.max(a)\nb2 = T.reshape(a, [1,2,2])\nb2 = D.max_pool_2d(b2, [2,2])[0,0,0]\nc = T.grad(b, a)\nc2 = T.grad(b2, a)\nprint c.eval({a: v})    # 0, 1, 1, 1\nprint c2.eval({a: v})    # 0, 1, 1, 1\n```\n\nBug or feature? \ud83d\ude26 Although as subgradient they all seem to make sense, but is there a reason to justify the difference of reduce_max and max_pool?\n\nI saw the [comment](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/ops/math_grad.py#L71) for reduce_max and it seems like the first one is feature. \n"}