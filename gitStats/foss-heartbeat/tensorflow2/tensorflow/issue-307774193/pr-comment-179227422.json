{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/179227422", "pull_request_review_id": 109432024, "id": 179227422, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE3OTIyNzQyMg==", "diff_hunk": "@@ -49,8 +51,22 @@ thread::ThreadPool* ComputePool(const SessionOptions& options) {\n int32 NumInterOpThreadsFromSessionOptions(const SessionOptions& options) {\n   const int32 t = options.config.inter_op_parallelism_threads();\n   if (t != 0) return t;\n+#ifdef INTEL_MKL\n+  // MKL library executes ops in parallel using OMP threads\n+  // Set inter_op conservatively to avoid thread oversubscription that could \n+  // lead to severe perf degradations and OMP resource exhaustion\n+  const int mkl_intra_op = omp_get_max_threads();\n+  CHECK_GE(mkl_intra_op, 1);\n+  const int32 mkl_inter_op = std::ceil(\n+    static_cast<float>(port::NumSchedulableCPUs()) / mkl_intra_op);", "path": "tensorflow/core/common_runtime/process_util.cc", "position": null, "original_position": 20, "commit_id": "2ef8e85e7d572d6cbbec2eea66df8462914a2908", "original_commit_id": "b3e956b5aa424b2fdcb91d1a673f62788567f97c", "user": {"login": "rmlarsen", "id": 16907534, "node_id": "MDQ6VXNlcjE2OTA3NTM0", "avatar_url": "https://avatars2.githubusercontent.com/u/16907534?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rmlarsen", "html_url": "https://github.com/rmlarsen", "followers_url": "https://api.github.com/users/rmlarsen/followers", "following_url": "https://api.github.com/users/rmlarsen/following{/other_user}", "gists_url": "https://api.github.com/users/rmlarsen/gists{/gist_id}", "starred_url": "https://api.github.com/users/rmlarsen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rmlarsen/subscriptions", "organizations_url": "https://api.github.com/users/rmlarsen/orgs", "repos_url": "https://api.github.com/users/rmlarsen/repos", "events_url": "https://api.github.com/users/rmlarsen/events{/privacy}", "received_events_url": "https://api.github.com/users/rmlarsen/received_events", "type": "User", "site_admin": false}, "body": "There is no reason to go to float just to round up.\r\n\r\n(port::NumSchedulableCPUs() + mkl_intra_op - 1) / mkl_intra_op\r\n\r\ndoes what you want. This is also defined as inline function div_up or similar, in several places.", "created_at": "2018-04-04T17:47:46Z", "updated_at": "2018-04-04T22:10:03Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/17931#discussion_r179227422", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17931", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/179227422"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/17931#discussion_r179227422"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/17931"}}, "body_html": "<p>There is no reason to go to float just to round up.</p>\n<p>(port::NumSchedulableCPUs() + mkl_intra_op - 1) / mkl_intra_op</p>\n<p>does what you want. This is also defined as inline function div_up or similar, in several places.</p>", "body_text": "There is no reason to go to float just to round up.\n(port::NumSchedulableCPUs() + mkl_intra_op - 1) / mkl_intra_op\ndoes what you want. This is also defined as inline function div_up or similar, in several places."}