{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14087", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14087/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14087/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/14087/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/14087", "id": 269543631, "node_id": "MDU6SXNzdWUyNjk1NDM2MzE=", "number": 14087, "title": "tf.contrib.boosted_trees cannot be used in 1.4.0rc1", "user": {"login": "zhedongzheng", "id": 16261331, "node_id": "MDQ6VXNlcjE2MjYxMzMx", "avatar_url": "https://avatars2.githubusercontent.com/u/16261331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zhedongzheng", "html_url": "https://github.com/zhedongzheng", "followers_url": "https://api.github.com/users/zhedongzheng/followers", "following_url": "https://api.github.com/users/zhedongzheng/following{/other_user}", "gists_url": "https://api.github.com/users/zhedongzheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/zhedongzheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zhedongzheng/subscriptions", "organizations_url": "https://api.github.com/users/zhedongzheng/orgs", "repos_url": "https://api.github.com/users/zhedongzheng/repos", "events_url": "https://api.github.com/users/zhedongzheng/events{/privacy}", "received_events_url": "https://api.github.com/users/zhedongzheng/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2017-10-30T10:10:41Z", "updated_at": "2017-10-31T18:28:56Z", "closed_at": "2017-10-31T18:28:56Z", "author_association": "NONE", "body_html": "<p>TF Version: 1.4.0rc1<br>\nPy Version: 2.7<br>\nOS: Mac OS</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> tensorflow.contrib.boosted_trees.estimator_batch.estimator <span class=\"pl-k\">import</span> GradientBoostedDecisionTreeClassifier\n<span class=\"pl-k\">from</span> tensorflow.contrib.boosted_trees.proto <span class=\"pl-k\">import</span> learner_pb2\n\nlearner_config <span class=\"pl-k\">=</span> learner_pb2.LearnerConfig()\n\nlearner_config.learning_rate_tuner.fixed.learning_rate <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0.1</span>\nlearner_config.num_classes <span class=\"pl-k\">=</span> <span class=\"pl-c1\">10</span>\nlearner_config.regularization.l1 <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0.0</span>\nlearner_config.regularization.l2 <span class=\"pl-k\">=</span> <span class=\"pl-c1\">1.0</span> <span class=\"pl-k\">/</span> <span class=\"pl-c1\">1000</span>\nlearner_config.constraints.max_tree_depth <span class=\"pl-k\">=</span> <span class=\"pl-c1\">4</span>\nlearner_config.growing_mode <span class=\"pl-k\">=</span> learner_pb2.LearnerConfig.<span class=\"pl-c1\">LAYER_BY_LAYER</span>\nlearner_config.multi_class_strategy <span class=\"pl-k\">=</span> (learner_pb2.LearnerConfig.<span class=\"pl-c1\">DIAGONAL_HESSIAN</span>)\n\nestimator <span class=\"pl-k\">=</span> GradientBoostedDecisionTreeClassifier(\n    <span class=\"pl-v\">learner_config</span> <span class=\"pl-k\">=</span> learner_config,\n    <span class=\"pl-v\">n_classes</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">10</span>,\n    <span class=\"pl-v\">examples_per_layer</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">1000</span>,\n    <span class=\"pl-v\">num_trees</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">10</span>,\n    <span class=\"pl-v\">center_bias</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">False</span>)\n\n(X_train, y_train), (X_test, y_test) <span class=\"pl-k\">=</span> tf.keras.datasets.mnist.load_data()\nX_train <span class=\"pl-k\">=</span> (X_train <span class=\"pl-k\">/</span> <span class=\"pl-c1\">255</span>.).reshape(<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">28</span><span class=\"pl-k\">*</span><span class=\"pl-c1\">28</span>).astype(np.float32)\ny_train <span class=\"pl-k\">=</span> y_train.astype(np.int32)\n\nestimator.fit(<span class=\"pl-v\">input_fn</span><span class=\"pl-k\">=</span>tf.estimator.inputs.numpy_input_fn(\n    <span class=\"pl-v\">x</span><span class=\"pl-k\">=</span>{<span class=\"pl-s\"><span class=\"pl-pds\">'</span>features<span class=\"pl-pds\">'</span></span>:X_train}, <span class=\"pl-v\">y</span><span class=\"pl-k\">=</span>y_train, <span class=\"pl-v\">batch_size</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">128</span>, <span class=\"pl-v\">num_epochs</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>, <span class=\"pl-v\">shuffle</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>))</pre></div>\n<p>A minimal example to train on mnist dataset throws error:</p>\n<pre><code>Traceback (most recent call last):\n  File \"boost_tree.py\", line 29, in &lt;module&gt;\n    x={'features':X_train}, y=y_train, batch_size=128, num_epochs=1, shuffle=True))\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 316, in new_func\n    return func(*args, **kwargs)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 480, in fit\n    loss = self._train_model(input_fn=input_fn, hooks=hooks)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 986, in _train_model\n    model_fn_ops = self._get_train_ops(features, labels)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1202, in _get_train_ops\n    return self._call_model_fn(features, labels, model_fn_lib.ModeKeys.TRAIN)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1166, in _call_model_fn\n    model_fn_results = self._model_fn(features, labels, **kwargs)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/estimator_batch/model.py\", line 116, in model_builder\n    logits=logits)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1064, in create_model_fn_ops\n    enable_centered_bias=self._enable_centered_bias)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 648, in _create_model_fn_ops\n    batch_size, loss_fn, weight_tensor)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1923, in _train_op\n    train_op = train_op_fn(loss)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/estimator_batch/model.py\", line 105, in _train_op_fn\n    update_op = gbdt_model.train(loss, predictions_dict, labels)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/python/training/functions/gbdt_batch.py\", line 543, in train\n    hessian_list = self._diagonal_hessian(gradients, predictions)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/python/training/functions/gbdt_batch.py\", line 845, in _diagonal_hessian\n    aggregation_method=None)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 581, in gradients\n    grad_scope, op, func_call, lambda: grad_fn(op, *out_grads))\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 353, in _MaybeCompile\n    return grad_fn()  # Exit early\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 581, in &lt;lambda&gt;\n    grad_scope, op, func_call, lambda: grad_fn(op, *out_grads))\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/array_grad.py\", line 352, in _PreventGradientGrad\n    \"Gradient explicitly disabled. Reason: %s\" % op.get_attr(\"message\"))\nLookupError: Gradient explicitly disabled. Reason: Currently there is no way to take the second derivative of sparse_softmax_cross_entropy_with_logits due to the fused implementation's interaction with tf.gradients()\n</code></pre>", "body_text": "TF Version: 1.4.0rc1\nPy Version: 2.7\nOS: Mac OS\nimport tensorflow as tf\nfrom tensorflow.contrib.boosted_trees.estimator_batch.estimator import GradientBoostedDecisionTreeClassifier\nfrom tensorflow.contrib.boosted_trees.proto import learner_pb2\n\nlearner_config = learner_pb2.LearnerConfig()\n\nlearner_config.learning_rate_tuner.fixed.learning_rate = 0.1\nlearner_config.num_classes = 10\nlearner_config.regularization.l1 = 0.0\nlearner_config.regularization.l2 = 1.0 / 1000\nlearner_config.constraints.max_tree_depth = 4\nlearner_config.growing_mode = learner_pb2.LearnerConfig.LAYER_BY_LAYER\nlearner_config.multi_class_strategy = (learner_pb2.LearnerConfig.DIAGONAL_HESSIAN)\n\nestimator = GradientBoostedDecisionTreeClassifier(\n    learner_config = learner_config,\n    n_classes = 10,\n    examples_per_layer = 1000,\n    num_trees = 10,\n    center_bias = False)\n\n(X_train, y_train), (X_test, y_test) = tf.keras.datasets.mnist.load_data()\nX_train = (X_train / 255.).reshape(-1, 28*28).astype(np.float32)\ny_train = y_train.astype(np.int32)\n\nestimator.fit(input_fn=tf.estimator.inputs.numpy_input_fn(\n    x={'features':X_train}, y=y_train, batch_size=128, num_epochs=1, shuffle=True))\nA minimal example to train on mnist dataset throws error:\nTraceback (most recent call last):\n  File \"boost_tree.py\", line 29, in <module>\n    x={'features':X_train}, y=y_train, batch_size=128, num_epochs=1, shuffle=True))\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 316, in new_func\n    return func(*args, **kwargs)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 480, in fit\n    loss = self._train_model(input_fn=input_fn, hooks=hooks)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 986, in _train_model\n    model_fn_ops = self._get_train_ops(features, labels)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1202, in _get_train_ops\n    return self._call_model_fn(features, labels, model_fn_lib.ModeKeys.TRAIN)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1166, in _call_model_fn\n    model_fn_results = self._model_fn(features, labels, **kwargs)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/estimator_batch/model.py\", line 116, in model_builder\n    logits=logits)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1064, in create_model_fn_ops\n    enable_centered_bias=self._enable_centered_bias)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 648, in _create_model_fn_ops\n    batch_size, loss_fn, weight_tensor)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1923, in _train_op\n    train_op = train_op_fn(loss)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/estimator_batch/model.py\", line 105, in _train_op_fn\n    update_op = gbdt_model.train(loss, predictions_dict, labels)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/python/training/functions/gbdt_batch.py\", line 543, in train\n    hessian_list = self._diagonal_hessian(gradients, predictions)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/python/training/functions/gbdt_batch.py\", line 845, in _diagonal_hessian\n    aggregation_method=None)\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 581, in gradients\n    grad_scope, op, func_call, lambda: grad_fn(op, *out_grads))\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 353, in _MaybeCompile\n    return grad_fn()  # Exit early\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 581, in <lambda>\n    grad_scope, op, func_call, lambda: grad_fn(op, *out_grads))\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/array_grad.py\", line 352, in _PreventGradientGrad\n    \"Gradient explicitly disabled. Reason: %s\" % op.get_attr(\"message\"))\nLookupError: Gradient explicitly disabled. Reason: Currently there is no way to take the second derivative of sparse_softmax_cross_entropy_with_logits due to the fused implementation's interaction with tf.gradients()", "body": "TF Version: 1.4.0rc1\r\nPy Version: 2.7\r\nOS: Mac OS\r\n\r\n```python\r\nimport tensorflow as tf\r\nfrom tensorflow.contrib.boosted_trees.estimator_batch.estimator import GradientBoostedDecisionTreeClassifier\r\nfrom tensorflow.contrib.boosted_trees.proto import learner_pb2\r\n\r\nlearner_config = learner_pb2.LearnerConfig()\r\n\r\nlearner_config.learning_rate_tuner.fixed.learning_rate = 0.1\r\nlearner_config.num_classes = 10\r\nlearner_config.regularization.l1 = 0.0\r\nlearner_config.regularization.l2 = 1.0 / 1000\r\nlearner_config.constraints.max_tree_depth = 4\r\nlearner_config.growing_mode = learner_pb2.LearnerConfig.LAYER_BY_LAYER\r\nlearner_config.multi_class_strategy = (learner_pb2.LearnerConfig.DIAGONAL_HESSIAN)\r\n\r\nestimator = GradientBoostedDecisionTreeClassifier(\r\n    learner_config = learner_config,\r\n    n_classes = 10,\r\n    examples_per_layer = 1000,\r\n    num_trees = 10,\r\n    center_bias = False)\r\n\r\n(X_train, y_train), (X_test, y_test) = tf.keras.datasets.mnist.load_data()\r\nX_train = (X_train / 255.).reshape(-1, 28*28).astype(np.float32)\r\ny_train = y_train.astype(np.int32)\r\n\r\nestimator.fit(input_fn=tf.estimator.inputs.numpy_input_fn(\r\n    x={'features':X_train}, y=y_train, batch_size=128, num_epochs=1, shuffle=True))\r\n```\r\n\r\nA minimal example to train on mnist dataset throws error:\r\n```\r\nTraceback (most recent call last):\r\n  File \"boost_tree.py\", line 29, in <module>\r\n    x={'features':X_train}, y=y_train, batch_size=128, num_epochs=1, shuffle=True))\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 316, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 480, in fit\r\n    loss = self._train_model(input_fn=input_fn, hooks=hooks)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 986, in _train_model\r\n    model_fn_ops = self._get_train_ops(features, labels)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1202, in _get_train_ops\r\n    return self._call_model_fn(features, labels, model_fn_lib.ModeKeys.TRAIN)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/estimator.py\", line 1166, in _call_model_fn\r\n    model_fn_results = self._model_fn(features, labels, **kwargs)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/estimator_batch/model.py\", line 116, in model_builder\r\n    logits=logits)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1064, in create_model_fn_ops\r\n    enable_centered_bias=self._enable_centered_bias)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 648, in _create_model_fn_ops\r\n    batch_size, loss_fn, weight_tensor)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/learn/python/learn/estimators/head.py\", line 1923, in _train_op\r\n    train_op = train_op_fn(loss)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/estimator_batch/model.py\", line 105, in _train_op_fn\r\n    update_op = gbdt_model.train(loss, predictions_dict, labels)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/python/training/functions/gbdt_batch.py\", line 543, in train\r\n    hessian_list = self._diagonal_hessian(gradients, predictions)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/contrib/boosted_trees/python/training/functions/gbdt_batch.py\", line 845, in _diagonal_hessian\r\n    aggregation_method=None)\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 581, in gradients\r\n    grad_scope, op, func_call, lambda: grad_fn(op, *out_grads))\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 353, in _MaybeCompile\r\n    return grad_fn()  # Exit early\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py\", line 581, in <lambda>\r\n    grad_scope, op, func_call, lambda: grad_fn(op, *out_grads))\r\n  File \"/Users/zhedongzheng/pyenv/py2.7/tf_1.4/tf_1.4/lib/python2.7/site-packages/tensorflow/python/ops/array_grad.py\", line 352, in _PreventGradientGrad\r\n    \"Gradient explicitly disabled. Reason: %s\" % op.get_attr(\"message\"))\r\nLookupError: Gradient explicitly disabled. Reason: Currently there is no way to take the second derivative of sparse_softmax_cross_entropy_with_logits due to the fused implementation's interaction with tf.gradients()\r\n```"}