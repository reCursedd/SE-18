{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12996", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12996/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12996/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12996/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/12996", "id": 257028611, "node_id": "MDU6SXNzdWUyNTcwMjg2MTE=", "number": 12996, "title": "restore part of model using Estimator API", "user": {"login": "Moymix", "id": 17916698, "node_id": "MDQ6VXNlcjE3OTE2Njk4", "avatar_url": "https://avatars1.githubusercontent.com/u/17916698?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Moymix", "html_url": "https://github.com/Moymix", "followers_url": "https://api.github.com/users/Moymix/followers", "following_url": "https://api.github.com/users/Moymix/following{/other_user}", "gists_url": "https://api.github.com/users/Moymix/gists{/gist_id}", "starred_url": "https://api.github.com/users/Moymix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Moymix/subscriptions", "organizations_url": "https://api.github.com/users/Moymix/orgs", "repos_url": "https://api.github.com/users/Moymix/repos", "events_url": "https://api.github.com/users/Moymix/events{/privacy}", "received_events_url": "https://api.github.com/users/Moymix/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-09-12T12:40:41Z", "updated_at": "2017-09-14T16:42:02Z", "closed_at": "2017-09-14T16:42:02Z", "author_association": "NONE", "body_html": "<p>Hi,</p>\n<p>I am trying to restore part of model using tensorflow high level API Estimator,  but I can not find I way.<br>\nI can only specify checkpoint_path for Estimator.</p>\n<p>Here is an example.<br>\nI what to extract COCO images feature using tf-slim pretrained model resnet_v2, but this pretrained model does not provide \"resnet_v2_152/block1/unit_1/bottleneck_v2/conv2/biases\". So, I need to initialize it to zero.<br>\nBut using Estimator, It will find that this biases not in checkpoint and raise a Not found error.</p>\n<pre><code>import tensorflow as tf\n\nimport tensorflow.contrib.slim.python.slim.nets.resnet_v2 as resnet_v2\n\n\ndef cnn_model_fn(features, labels, mode):\n    net, end_points = resnet_v2.resnet_v2_152(inputs=features, is_training=mode == tf.estimator.ModeKeys.TRAIN)\n    if mode == tf.estimator.ModeKeys.PREDICT:\n        return tf.estimator.EstimatorSpec(mode=mode, predictions=net)\n    else:\n        raise NotImplementedError('only support predict!')\n\n\ndef parse_filename(filename):\n    image_string = tf.read_file(filename)\n    image_decoded = tf.image.decode_jpeg(image_string, channels=3)\n    image_resized = tf.image.resize_images(image_decoded, [256, 256])\n    return image_resized\n\n\ndef dataset_input_fn(dataset, num_epochs=None, batch_size=128, shuffle=False, buffer_size=1000, seed=None):\n    def input_fn():\n        d = dataset.repeat(num_epochs).batch(batch_size)\n        if shuffle:\n            d = d.shuffle(buffer_size)\n        iterator = d.make_one_shot_iterator()\n        next_example = iterator.get_next()\n        return next_example\n\n    return input_fn\n\n\nfilenames = sorted(tf.gfile.Glob('/root/data/COCO/download/val2014/*'))\ndataset = tf.contrib.data.Dataset.from_tensor_slices(filenames).map(parse_filename)\n\ninput_fn = dataset_input_fn(dataset, num_epochs=1, batch_size=1, shuffle=False)\n\nestimator = tf.estimator.Estimator(model_fn=cnn_model_fn, model_dir=None)\n\nes = estimator.predict(input_fn=input_fn,\n                       checkpoint_path='/root/data/checkpoints/resnet_v2_152_2017_04_14/resnet_v2_152.ckpt')\nprint(es.__next__())\n\n\nprint(\"Done!\")\n\n</code></pre>\n<p>The error is obvious.<br>\n<code>2017-09-12 20:36:31.231422: W tensorflow/core/framework/op_kernel.cc:1192] Not found: Tensor name \"resnet_v2_152/block1/unit_1/bottleneck_v2/conv2/biases\" not found in checkpoint files /root/data/checkpoints/resnet_v2_152_2017_04_14/resnet_v2_152.ckpt</code></p>", "body_text": "Hi,\nI am trying to restore part of model using tensorflow high level API Estimator,  but I can not find I way.\nI can only specify checkpoint_path for Estimator.\nHere is an example.\nI what to extract COCO images feature using tf-slim pretrained model resnet_v2, but this pretrained model does not provide \"resnet_v2_152/block1/unit_1/bottleneck_v2/conv2/biases\". So, I need to initialize it to zero.\nBut using Estimator, It will find that this biases not in checkpoint and raise a Not found error.\nimport tensorflow as tf\n\nimport tensorflow.contrib.slim.python.slim.nets.resnet_v2 as resnet_v2\n\n\ndef cnn_model_fn(features, labels, mode):\n    net, end_points = resnet_v2.resnet_v2_152(inputs=features, is_training=mode == tf.estimator.ModeKeys.TRAIN)\n    if mode == tf.estimator.ModeKeys.PREDICT:\n        return tf.estimator.EstimatorSpec(mode=mode, predictions=net)\n    else:\n        raise NotImplementedError('only support predict!')\n\n\ndef parse_filename(filename):\n    image_string = tf.read_file(filename)\n    image_decoded = tf.image.decode_jpeg(image_string, channels=3)\n    image_resized = tf.image.resize_images(image_decoded, [256, 256])\n    return image_resized\n\n\ndef dataset_input_fn(dataset, num_epochs=None, batch_size=128, shuffle=False, buffer_size=1000, seed=None):\n    def input_fn():\n        d = dataset.repeat(num_epochs).batch(batch_size)\n        if shuffle:\n            d = d.shuffle(buffer_size)\n        iterator = d.make_one_shot_iterator()\n        next_example = iterator.get_next()\n        return next_example\n\n    return input_fn\n\n\nfilenames = sorted(tf.gfile.Glob('/root/data/COCO/download/val2014/*'))\ndataset = tf.contrib.data.Dataset.from_tensor_slices(filenames).map(parse_filename)\n\ninput_fn = dataset_input_fn(dataset, num_epochs=1, batch_size=1, shuffle=False)\n\nestimator = tf.estimator.Estimator(model_fn=cnn_model_fn, model_dir=None)\n\nes = estimator.predict(input_fn=input_fn,\n                       checkpoint_path='/root/data/checkpoints/resnet_v2_152_2017_04_14/resnet_v2_152.ckpt')\nprint(es.__next__())\n\n\nprint(\"Done!\")\n\n\nThe error is obvious.\n2017-09-12 20:36:31.231422: W tensorflow/core/framework/op_kernel.cc:1192] Not found: Tensor name \"resnet_v2_152/block1/unit_1/bottleneck_v2/conv2/biases\" not found in checkpoint files /root/data/checkpoints/resnet_v2_152_2017_04_14/resnet_v2_152.ckpt", "body": "Hi, \r\n\r\nI am trying to restore part of model using tensorflow high level API Estimator,  but I can not find I way.\r\nI can only specify checkpoint_path for Estimator.\r\n\r\nHere is an example.\r\nI what to extract COCO images feature using tf-slim pretrained model resnet_v2, but this pretrained model does not provide \"resnet_v2_152/block1/unit_1/bottleneck_v2/conv2/biases\". So, I need to initialize it to zero.\r\nBut using Estimator, It will find that this biases not in checkpoint and raise a Not found error.\r\n\r\n```\r\nimport tensorflow as tf\r\n\r\nimport tensorflow.contrib.slim.python.slim.nets.resnet_v2 as resnet_v2\r\n\r\n\r\ndef cnn_model_fn(features, labels, mode):\r\n    net, end_points = resnet_v2.resnet_v2_152(inputs=features, is_training=mode == tf.estimator.ModeKeys.TRAIN)\r\n    if mode == tf.estimator.ModeKeys.PREDICT:\r\n        return tf.estimator.EstimatorSpec(mode=mode, predictions=net)\r\n    else:\r\n        raise NotImplementedError('only support predict!')\r\n\r\n\r\ndef parse_filename(filename):\r\n    image_string = tf.read_file(filename)\r\n    image_decoded = tf.image.decode_jpeg(image_string, channels=3)\r\n    image_resized = tf.image.resize_images(image_decoded, [256, 256])\r\n    return image_resized\r\n\r\n\r\ndef dataset_input_fn(dataset, num_epochs=None, batch_size=128, shuffle=False, buffer_size=1000, seed=None):\r\n    def input_fn():\r\n        d = dataset.repeat(num_epochs).batch(batch_size)\r\n        if shuffle:\r\n            d = d.shuffle(buffer_size)\r\n        iterator = d.make_one_shot_iterator()\r\n        next_example = iterator.get_next()\r\n        return next_example\r\n\r\n    return input_fn\r\n\r\n\r\nfilenames = sorted(tf.gfile.Glob('/root/data/COCO/download/val2014/*'))\r\ndataset = tf.contrib.data.Dataset.from_tensor_slices(filenames).map(parse_filename)\r\n\r\ninput_fn = dataset_input_fn(dataset, num_epochs=1, batch_size=1, shuffle=False)\r\n\r\nestimator = tf.estimator.Estimator(model_fn=cnn_model_fn, model_dir=None)\r\n\r\nes = estimator.predict(input_fn=input_fn,\r\n                       checkpoint_path='/root/data/checkpoints/resnet_v2_152_2017_04_14/resnet_v2_152.ckpt')\r\nprint(es.__next__())\r\n\r\n\r\nprint(\"Done!\")\r\n\r\n```\r\n\r\nThe error is obvious.\r\n`2017-09-12 20:36:31.231422: W tensorflow/core/framework/op_kernel.cc:1192] Not found: Tensor name \"resnet_v2_152/block1/unit_1/bottleneck_v2/conv2/biases\" not found in checkpoint files /root/data/checkpoints/resnet_v2_152_2017_04_14/resnet_v2_152.ckpt`\r\n\r\n\r\n"}