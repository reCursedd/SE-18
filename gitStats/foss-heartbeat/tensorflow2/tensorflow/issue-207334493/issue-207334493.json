{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7474", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7474/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7474/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7474/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/7474", "id": 207334493, "node_id": "MDU6SXNzdWUyMDczMzQ0OTM=", "number": 7474, "title": "Gradient of gamma log pdf is broken", "user": {"login": "altosaar", "id": 5317244, "node_id": "MDQ6VXNlcjUzMTcyNDQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/5317244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/altosaar", "html_url": "https://github.com/altosaar", "followers_url": "https://api.github.com/users/altosaar/followers", "following_url": "https://api.github.com/users/altosaar/following{/other_user}", "gists_url": "https://api.github.com/users/altosaar/gists{/gist_id}", "starred_url": "https://api.github.com/users/altosaar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/altosaar/subscriptions", "organizations_url": "https://api.github.com/users/altosaar/orgs", "repos_url": "https://api.github.com/users/altosaar/repos", "events_url": "https://api.github.com/users/altosaar/events{/privacy}", "received_events_url": "https://api.github.com/users/altosaar/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}, {"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-02-13T20:46:19Z", "updated_at": "2017-03-01T22:34:34Z", "closed_at": "2017-03-01T22:34:34Z", "author_association": "NONE", "body_html": "<pre><code>In [1]: import tensorflow as tf\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\nd\nIn [2]: dist = tf.contrib.distributions\n\nIn [3]: mu = tf.get_variable('mean_arg', [], 'float32')\n\nIn [4]: m = tf.nn.softplus(mu)\n\nIn [5]: q = dist.Gamma(0.01, 0.01/mu)\n\nIn [6]: sess = tf.InteractiveSession()\nI tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 780 Ti\nmajor: 3 minor: 5 memoryClockRate (GHz) 0.928\npciBusID 0000:02:00.0\nTotal memory: 2.98GiB\nFree memory: 2.90GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: GeForce GTX 780 Ti, pci bus id: 0000:02:00.0)\n\nIn [7]: sess.run(tf.global_variables_initializer())\n\nIn [8]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\nOut[8]: [0.74267536]\n\nIn [9]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\nOut[9]: [nan]\n\nIn [10]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\nOut[10]: [nan]\n\nIn [20]: tf.__version__\nOut[20]: '0.12.0-rc1'\n</code></pre>\n<p>It looks like this happens because Gamma samples can be negative:</p>\n<pre><code>In [80]: z = q.sample()\n\nIn [81]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[81]: [-0.0050091296, 0.74267536]\n\nIn [82]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[82]: [-0.0, nan]\n\nIn [83]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[83]: [-0.0, nan]\n\nIn [84]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[84]: [-0.0, nan]\n\nIn [85]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[85]: [-0.01258331, 0.74267519]\n\nIn [86]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[86]: [-1.0715475e-21, 0.74267536]\n</code></pre>\n<p>Happy to run more tests to figure out this issue.</p>\n<p>Update: quick fix thanks to <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1794715\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ebrevdo\">@ebrevdo</a> -<br>\n<code>z = z + np.finfo(z.dtype.as_numpy_dtype).tiny</code></p>", "body_text": "In [1]: import tensorflow as tf\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\nd\nIn [2]: dist = tf.contrib.distributions\n\nIn [3]: mu = tf.get_variable('mean_arg', [], 'float32')\n\nIn [4]: m = tf.nn.softplus(mu)\n\nIn [5]: q = dist.Gamma(0.01, 0.01/mu)\n\nIn [6]: sess = tf.InteractiveSession()\nI tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\nname: GeForce GTX 780 Ti\nmajor: 3 minor: 5 memoryClockRate (GHz) 0.928\npciBusID 0000:02:00.0\nTotal memory: 2.98GiB\nFree memory: 2.90GiB\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 780 Ti, pci bus id: 0000:02:00.0)\n\nIn [7]: sess.run(tf.global_variables_initializer())\n\nIn [8]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\nOut[8]: [0.74267536]\n\nIn [9]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\nOut[9]: [nan]\n\nIn [10]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\nOut[10]: [nan]\n\nIn [20]: tf.__version__\nOut[20]: '0.12.0-rc1'\n\nIt looks like this happens because Gamma samples can be negative:\nIn [80]: z = q.sample()\n\nIn [81]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[81]: [-0.0050091296, 0.74267536]\n\nIn [82]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[82]: [-0.0, nan]\n\nIn [83]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[83]: [-0.0, nan]\n\nIn [84]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[84]: [-0.0, nan]\n\nIn [85]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[85]: [-0.01258331, 0.74267519]\n\nIn [86]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\nOut[86]: [-1.0715475e-21, 0.74267536]\n\nHappy to run more tests to figure out this issue.\nUpdate: quick fix thanks to @ebrevdo -\nz = z + np.finfo(z.dtype.as_numpy_dtype).tiny", "body": "```\r\nIn [1]: import tensorflow as tf\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally\r\nI tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally\r\nd\r\nIn [2]: dist = tf.contrib.distributions\r\n\r\nIn [3]: mu = tf.get_variable('mean_arg', [], 'float32')\r\n\r\nIn [4]: m = tf.nn.softplus(mu)\r\n\r\nIn [5]: q = dist.Gamma(0.01, 0.01/mu)\r\n\r\nIn [6]: sess = tf.InteractiveSession()\r\nI tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:\r\nname: GeForce GTX 780 Ti\r\nmajor: 3 minor: 5 memoryClockRate (GHz) 0.928\r\npciBusID 0000:02:00.0\r\nTotal memory: 2.98GiB\r\nFree memory: 2.90GiB\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -> (device: 0, name: GeForce GTX 780 Ti, pci bus id: 0000:02:00.0)\r\n\r\nIn [7]: sess.run(tf.global_variables_initializer())\r\n\r\nIn [8]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\r\nOut[8]: [0.74267536]\r\n\r\nIn [9]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\r\nOut[9]: [nan]\r\n\r\nIn [10]: sess.run(tf.gradients(q.log_pdf(q.sample()), mu))\r\nOut[10]: [nan]\r\n\r\nIn [20]: tf.__version__\r\nOut[20]: '0.12.0-rc1'\r\n```\r\nIt looks like this happens because Gamma samples can be negative:\r\n```\r\nIn [80]: z = q.sample()\r\n\r\nIn [81]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\r\nOut[81]: [-0.0050091296, 0.74267536]\r\n\r\nIn [82]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\r\nOut[82]: [-0.0, nan]\r\n\r\nIn [83]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\r\nOut[83]: [-0.0, nan]\r\n\r\nIn [84]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\r\nOut[84]: [-0.0, nan]\r\n\r\nIn [85]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\r\nOut[85]: [-0.01258331, 0.74267519]\r\n\r\nIn [86]: sess.run([z] + tf.gradients(q.log_pdf(z), mu))\r\nOut[86]: [-1.0715475e-21, 0.74267536]\r\n```\r\nHappy to run more tests to figure out this issue.\r\n\r\nUpdate: quick fix thanks to @ebrevdo - \r\n```z = z + np.finfo(z.dtype.as_numpy_dtype).tiny```"}