{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6844", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6844/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6844/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/6844/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/6844", "id": 200767757, "node_id": "MDU6SXNzdWUyMDA3Njc3NTc=", "number": 6844, "title": "changing number of outputs/classes", "user": {"login": "amnezzia", "id": 6934000, "node_id": "MDQ6VXNlcjY5MzQwMDA=", "avatar_url": "https://avatars1.githubusercontent.com/u/6934000?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amnezzia", "html_url": "https://github.com/amnezzia", "followers_url": "https://api.github.com/users/amnezzia/followers", "following_url": "https://api.github.com/users/amnezzia/following{/other_user}", "gists_url": "https://api.github.com/users/amnezzia/gists{/gist_id}", "starred_url": "https://api.github.com/users/amnezzia/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amnezzia/subscriptions", "organizations_url": "https://api.github.com/users/amnezzia/orgs", "repos_url": "https://api.github.com/users/amnezzia/repos", "events_url": "https://api.github.com/users/amnezzia/events{/privacy}", "received_events_url": "https://api.github.com/users/amnezzia/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473184161, "node_id": "MDU6TGFiZWw0NzMxODQxNjE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:support", "name": "type:support", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-01-14T01:01:10Z", "updated_at": "2017-01-21T12:42:05Z", "closed_at": "2017-01-21T12:42:04Z", "author_association": "NONE", "body_html": "<p>my StackOverflow thread: <a href=\"http://stackoverflow.com/questions/41645571/changing-number-of-outputs-classes-in-tensorflow\" rel=\"nofollow\">http://stackoverflow.com/questions/41645571/changing-number-of-outputs-classes-in-tensorflow</a></p>\n<h3>Environment info</h3>\n<p>Operating System: OSX</p>\n<ol>\n<li>python3 installed with miniconda3, TF installation link: <a href=\"https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.11.0rc1-py3-none-any.whl\" rel=\"nofollow\">https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.11.0rc1-py3-none-any.whl</a></li>\n<li>Version 0.11.0rc1</li>\n</ol>\n<p>Minimal example:</p>\n<pre><code>import tensorflow as tf\nimport numpy as np\n\ntf.reset_default_graph()\n\nx = tf.placeholder(tf.float32, (None, 2))\ny = tf.placeholder(tf.int32, (None,))\n\nw = tf.Variable(tf.truncated_normal(shape=(2, 2)))\nb = tf.Variable(tf.zeros(shape=(1, 2)))\n\nn_more = tf.placeholder(tf.int32, ())\n\nw_more = tf.truncated_normal((2, n_more))\nnew_w = tf.concat(concat_dim=1, values=[w, w_more])\nchange_w_op = tf.assign(w, new_w, validate_shape=False)\n\nb_more = tf.zeros(shape=(1, n_more))\nnew_b = tf.concat(concat_dim=1, values=[b, b_more])\nchange_b_op = tf.assign(b, new_b, validate_shape=False)\n\n\np = tf.matmul(x, w) + b\np1 = tf.matmul(x, w)\n\nloss = tf.reduce_mean(tf.nn.sparse_softmax_cross_entropy_with_logits(p, y))\nloss1 = tf.reduce_mean(tf.nn.sparse_softmax_cross_entropy_with_logits(p1, y))\nopt = tf.train.GradientDescentOptimizer(0.1)\ngrads_and_vars = opt.compute_gradients(loss, var_list=[w, b])\ntrain_op = opt.apply_gradients(grads_and_vars)\n\ngrads_and_vars1 = opt.compute_gradients(loss1, var_list=[w])\ntrain_op1 = opt.apply_gradients(grads_and_vars1)\n\ninit = tf.initialize_all_variables()\n\nsess = tf.Session()\nsess.run(init)\n\n# add two more classes\nres = sess.run([change_w_op, change_b_op], feed_dict={n_more: 2})\nsess.run([w, b])\n#&gt;[array([[-0.49880403,  0.1797405 , -0.66030115, -0.2065938 ],\n#&gt;        [-1.19939673,  1.05717182,  0.03949607,  1.66543031]], dtype=float32),\n#&gt; array([[-0.02882343,  0.02882343,  0.        ,  0.        ]], dtype=float32)]\n# Works as expected\nres = sess.run([p, p1], \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 4, 3)\n             })\n# both elements in the res are (3, 4) arrays  -- Works as expected\n\nres = sess.run([loss, loss1], \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 4, 3)\n             })\n# res = [2.4644723, 2.4450662]  --  Works as expected\n\nres = sess.run(grads_and_vars1, \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 2, 3)\n             })\n# res is a list of two (2, 4) arrays -- Works as expected\n\nres = sess.run(grads_and_vars, \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 2, 3)\n             })\n\n</code></pre>\n<p>The last one produces the error below.<br>\nMy main questions are:<br>\nWhat am I doing wrong here?<br>\nWhy changing w does not cause problems but changing b does?<br>\nIs this a bug?</p>\n<pre><code>---------------------------------------------------------------------------\nInvalidArgumentError                      Traceback (most recent call last)\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n    971     try:\n--&gt; 972       return fn(*args)\n    973     except errors.OpError as e:\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\n    953                                  feed_dict, fetch_list, target_list,\n--&gt; 954                                  status, run_metadata)\n    955 \n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/contextlib.py in __exit__(self, type, value, traceback)\n     65             try:\n---&gt; 66                 next(self.gen)\n     67             except StopIteration:\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/errors.py in raise_exception_on_not_ok_status()\n    462           compat.as_text(pywrap_tensorflow.TF_Message(status)),\n--&gt; 463           pywrap_tensorflow.TF_GetCode(status))\n    464   finally:\n\nInvalidArgumentError: Incompatible shapes: [3,4] vs. [1,2]\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\n\nDuring handling of the above exception, another exception occurred:\n\nInvalidArgumentError                      Traceback (most recent call last)\n&lt;ipython-input-206-b8a2a3bd8471&gt; in &lt;module&gt;()\n      2              feed_dict={\n      3                  x:np.random.randn(3, 2),\n----&gt; 4                  y:np.random.randint(0, 2, 3)\n      5              })\n      6 res\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\n    715     try:\n    716       result = self._run(None, fetches, feed_dict, options_ptr,\n--&gt; 717                          run_metadata_ptr)\n    718       if run_metadata:\n    719         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\n    913     if final_fetches or final_targets:\n    914       results = self._do_run(handle, final_targets, final_fetches,\n--&gt; 915                              feed_dict_string, options, run_metadata)\n    916     else:\n    917       results = []\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n    963     if handle is None:\n    964       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n--&gt; 965                            target_list, options, run_metadata)\n    966     else:\n    967       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n    983         except KeyError:\n    984           pass\n--&gt; 985       raise type(e)(node_def, op, message)\n    986 \n    987   def _extend_graph(self):\n\nInvalidArgumentError: Incompatible shapes: [3,4] vs. [1,2]\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\n\nCaused by op 'gradients/add_grad/BroadcastGradientArgs', defined at:\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 184, in _run_module_as_main\n    \"__main__\", mod_spec)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 85, in _run_code\n    exec(code, run_globals)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/__main__.py\", line 3, in &lt;module&gt;\n    app.launch_new_instance()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/traitlets/config/application.py\", line 658, in launch_instance\n    app.start()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelapp.py\", line 474, in start\n    ioloop.IOLoop.instance().start()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/ioloop.py\", line 177, in start\n    super(ZMQIOLoop, self).start()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/ioloop.py\", line 887, in start\n    handler_func(fd_obj, events)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\n    self._handle_recv()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\n    callback(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\n    user_expressions, allow_stdin)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/zmqshell.py\", line 501, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"&lt;ipython-input-196-ab717a15c74f&gt;\", line 31, in &lt;module&gt;\n    grads_and_vars = opt.compute_gradients(loss, var_list=[w, b])\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/training/optimizer.py\", line 253, in compute_gradients\n    colocate_gradients_with_ops=colocate_gradients_with_ops)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gradients.py\", line 469, in gradients\n    in_grads = _AsList(grad_fn(op, *out_grads))\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/math_grad.py\", line 555, in _AddGrad\n    rx, ry = gen_array_ops._broadcast_gradient_args(sx, sy)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 388, in _broadcast_gradient_args\n    name=name)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n    op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n    self._traceback = _extract_stack()\n\n...which was originally created as op 'add', defined at:\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 184, in _run_module_as_main\n    \"__main__\", mod_spec)\n[elided 18 identical lines from previous traceback]\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"&lt;ipython-input-196-ab717a15c74f&gt;\", line 25, in &lt;module&gt;\n    p = tf.matmul(x, w) + b\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/math_ops.py\", line 751, in binary_op_wrapper\n    return func(x, y, name=name)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 71, in add\n    result = _op_def_lib.apply_op(\"Add\", x=x, y=y, name=name)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n    op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Incompatible shapes: [3,4] vs. [1,2]\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\n</code></pre>", "body_text": "my StackOverflow thread: http://stackoverflow.com/questions/41645571/changing-number-of-outputs-classes-in-tensorflow\nEnvironment info\nOperating System: OSX\n\npython3 installed with miniconda3, TF installation link: https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.11.0rc1-py3-none-any.whl\nVersion 0.11.0rc1\n\nMinimal example:\nimport tensorflow as tf\nimport numpy as np\n\ntf.reset_default_graph()\n\nx = tf.placeholder(tf.float32, (None, 2))\ny = tf.placeholder(tf.int32, (None,))\n\nw = tf.Variable(tf.truncated_normal(shape=(2, 2)))\nb = tf.Variable(tf.zeros(shape=(1, 2)))\n\nn_more = tf.placeholder(tf.int32, ())\n\nw_more = tf.truncated_normal((2, n_more))\nnew_w = tf.concat(concat_dim=1, values=[w, w_more])\nchange_w_op = tf.assign(w, new_w, validate_shape=False)\n\nb_more = tf.zeros(shape=(1, n_more))\nnew_b = tf.concat(concat_dim=1, values=[b, b_more])\nchange_b_op = tf.assign(b, new_b, validate_shape=False)\n\n\np = tf.matmul(x, w) + b\np1 = tf.matmul(x, w)\n\nloss = tf.reduce_mean(tf.nn.sparse_softmax_cross_entropy_with_logits(p, y))\nloss1 = tf.reduce_mean(tf.nn.sparse_softmax_cross_entropy_with_logits(p1, y))\nopt = tf.train.GradientDescentOptimizer(0.1)\ngrads_and_vars = opt.compute_gradients(loss, var_list=[w, b])\ntrain_op = opt.apply_gradients(grads_and_vars)\n\ngrads_and_vars1 = opt.compute_gradients(loss1, var_list=[w])\ntrain_op1 = opt.apply_gradients(grads_and_vars1)\n\ninit = tf.initialize_all_variables()\n\nsess = tf.Session()\nsess.run(init)\n\n# add two more classes\nres = sess.run([change_w_op, change_b_op], feed_dict={n_more: 2})\nsess.run([w, b])\n#>[array([[-0.49880403,  0.1797405 , -0.66030115, -0.2065938 ],\n#>        [-1.19939673,  1.05717182,  0.03949607,  1.66543031]], dtype=float32),\n#> array([[-0.02882343,  0.02882343,  0.        ,  0.        ]], dtype=float32)]\n# Works as expected\nres = sess.run([p, p1], \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 4, 3)\n             })\n# both elements in the res are (3, 4) arrays  -- Works as expected\n\nres = sess.run([loss, loss1], \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 4, 3)\n             })\n# res = [2.4644723, 2.4450662]  --  Works as expected\n\nres = sess.run(grads_and_vars1, \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 2, 3)\n             })\n# res is a list of two (2, 4) arrays -- Works as expected\n\nres = sess.run(grads_and_vars, \n             feed_dict={\n                 x:np.random.randn(3, 2), \n                 y:np.random.randint(0, 2, 3)\n             })\n\n\nThe last one produces the error below.\nMy main questions are:\nWhat am I doing wrong here?\nWhy changing w does not cause problems but changing b does?\nIs this a bug?\n---------------------------------------------------------------------------\nInvalidArgumentError                      Traceback (most recent call last)\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n    971     try:\n--> 972       return fn(*args)\n    973     except errors.OpError as e:\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\n    953                                  feed_dict, fetch_list, target_list,\n--> 954                                  status, run_metadata)\n    955 \n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/contextlib.py in __exit__(self, type, value, traceback)\n     65             try:\n---> 66                 next(self.gen)\n     67             except StopIteration:\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/errors.py in raise_exception_on_not_ok_status()\n    462           compat.as_text(pywrap_tensorflow.TF_Message(status)),\n--> 463           pywrap_tensorflow.TF_GetCode(status))\n    464   finally:\n\nInvalidArgumentError: Incompatible shapes: [3,4] vs. [1,2]\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\n\nDuring handling of the above exception, another exception occurred:\n\nInvalidArgumentError                      Traceback (most recent call last)\n<ipython-input-206-b8a2a3bd8471> in <module>()\n      2              feed_dict={\n      3                  x:np.random.randn(3, 2),\n----> 4                  y:np.random.randint(0, 2, 3)\n      5              })\n      6 res\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\n    715     try:\n    716       result = self._run(None, fetches, feed_dict, options_ptr,\n--> 717                          run_metadata_ptr)\n    718       if run_metadata:\n    719         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\n    913     if final_fetches or final_targets:\n    914       results = self._do_run(handle, final_targets, final_fetches,\n--> 915                              feed_dict_string, options, run_metadata)\n    916     else:\n    917       results = []\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n    963     if handle is None:\n    964       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n--> 965                            target_list, options, run_metadata)\n    966     else:\n    967       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n    983         except KeyError:\n    984           pass\n--> 985       raise type(e)(node_def, op, message)\n    986 \n    987   def _extend_graph(self):\n\nInvalidArgumentError: Incompatible shapes: [3,4] vs. [1,2]\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\n\nCaused by op 'gradients/add_grad/BroadcastGradientArgs', defined at:\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 184, in _run_module_as_main\n    \"__main__\", mod_spec)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 85, in _run_code\n    exec(code, run_globals)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/__main__.py\", line 3, in <module>\n    app.launch_new_instance()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/traitlets/config/application.py\", line 658, in launch_instance\n    app.start()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelapp.py\", line 474, in start\n    ioloop.IOLoop.instance().start()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/ioloop.py\", line 177, in start\n    super(ZMQIOLoop, self).start()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/ioloop.py\", line 887, in start\n    handler_func(fd_obj, events)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\n    self._handle_recv()\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\n    self._run_callback(callback, msg)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\n    callback(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n    return fn(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n    return self.dispatch_shell(stream, msg)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n    handler(stream, idents, msg)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\n    user_expressions, allow_stdin)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/zmqshell.py\", line 501, in run_cell\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\n    interactivity=interactivity, compiler=compiler, result=result)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\n    if self.run_code(code, result):\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-196-ab717a15c74f>\", line 31, in <module>\n    grads_and_vars = opt.compute_gradients(loss, var_list=[w, b])\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/training/optimizer.py\", line 253, in compute_gradients\n    colocate_gradients_with_ops=colocate_gradients_with_ops)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gradients.py\", line 469, in gradients\n    in_grads = _AsList(grad_fn(op, *out_grads))\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/math_grad.py\", line 555, in _AddGrad\n    rx, ry = gen_array_ops._broadcast_gradient_args(sx, sy)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 388, in _broadcast_gradient_args\n    name=name)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n    op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n    self._traceback = _extract_stack()\n\n...which was originally created as op 'add', defined at:\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 184, in _run_module_as_main\n    \"__main__\", mod_spec)\n[elided 18 identical lines from previous traceback]\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-196-ab717a15c74f>\", line 25, in <module>\n    p = tf.matmul(x, w) + b\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/math_ops.py\", line 751, in binary_op_wrapper\n    return func(x, y, name=name)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 71, in add\n    result = _op_def_lib.apply_op(\"Add\", x=x, y=y, name=name)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\n    op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Incompatible shapes: [3,4] vs. [1,2]\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]", "body": "my StackOverflow thread: http://stackoverflow.com/questions/41645571/changing-number-of-outputs-classes-in-tensorflow\r\n\r\n### Environment info\r\nOperating System: OSX\r\n1. python3 installed with miniconda3, TF installation link: https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.11.0rc1-py3-none-any.whl\r\n2. Version 0.11.0rc1\r\n\r\nMinimal example:\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\n\r\ntf.reset_default_graph()\r\n\r\nx = tf.placeholder(tf.float32, (None, 2))\r\ny = tf.placeholder(tf.int32, (None,))\r\n\r\nw = tf.Variable(tf.truncated_normal(shape=(2, 2)))\r\nb = tf.Variable(tf.zeros(shape=(1, 2)))\r\n\r\nn_more = tf.placeholder(tf.int32, ())\r\n\r\nw_more = tf.truncated_normal((2, n_more))\r\nnew_w = tf.concat(concat_dim=1, values=[w, w_more])\r\nchange_w_op = tf.assign(w, new_w, validate_shape=False)\r\n\r\nb_more = tf.zeros(shape=(1, n_more))\r\nnew_b = tf.concat(concat_dim=1, values=[b, b_more])\r\nchange_b_op = tf.assign(b, new_b, validate_shape=False)\r\n\r\n\r\np = tf.matmul(x, w) + b\r\np1 = tf.matmul(x, w)\r\n\r\nloss = tf.reduce_mean(tf.nn.sparse_softmax_cross_entropy_with_logits(p, y))\r\nloss1 = tf.reduce_mean(tf.nn.sparse_softmax_cross_entropy_with_logits(p1, y))\r\nopt = tf.train.GradientDescentOptimizer(0.1)\r\ngrads_and_vars = opt.compute_gradients(loss, var_list=[w, b])\r\ntrain_op = opt.apply_gradients(grads_and_vars)\r\n\r\ngrads_and_vars1 = opt.compute_gradients(loss1, var_list=[w])\r\ntrain_op1 = opt.apply_gradients(grads_and_vars1)\r\n\r\ninit = tf.initialize_all_variables()\r\n\r\nsess = tf.Session()\r\nsess.run(init)\r\n\r\n# add two more classes\r\nres = sess.run([change_w_op, change_b_op], feed_dict={n_more: 2})\r\nsess.run([w, b])\r\n#>[array([[-0.49880403,  0.1797405 , -0.66030115, -0.2065938 ],\r\n#>        [-1.19939673,  1.05717182,  0.03949607,  1.66543031]], dtype=float32),\r\n#> array([[-0.02882343,  0.02882343,  0.        ,  0.        ]], dtype=float32)]\r\n# Works as expected\r\nres = sess.run([p, p1], \r\n             feed_dict={\r\n                 x:np.random.randn(3, 2), \r\n                 y:np.random.randint(0, 4, 3)\r\n             })\r\n# both elements in the res are (3, 4) arrays  -- Works as expected\r\n\r\nres = sess.run([loss, loss1], \r\n             feed_dict={\r\n                 x:np.random.randn(3, 2), \r\n                 y:np.random.randint(0, 4, 3)\r\n             })\r\n# res = [2.4644723, 2.4450662]  --  Works as expected\r\n\r\nres = sess.run(grads_and_vars1, \r\n             feed_dict={\r\n                 x:np.random.randn(3, 2), \r\n                 y:np.random.randint(0, 2, 3)\r\n             })\r\n# res is a list of two (2, 4) arrays -- Works as expected\r\n\r\nres = sess.run(grads_and_vars, \r\n             feed_dict={\r\n                 x:np.random.randn(3, 2), \r\n                 y:np.random.randint(0, 2, 3)\r\n             })\r\n\r\n```\r\nThe last one produces the error below.\r\nMy main questions are:\r\nWhat am I doing wrong here? \r\nWhy changing w does not cause problems but changing b does? \r\nIs this a bug?\r\n```\r\n---------------------------------------------------------------------------\r\nInvalidArgumentError                      Traceback (most recent call last)\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\r\n    971     try:\r\n--> 972       return fn(*args)\r\n    973     except errors.OpError as e:\r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\r\n    953                                  feed_dict, fetch_list, target_list,\r\n--> 954                                  status, run_metadata)\r\n    955 \r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/contextlib.py in __exit__(self, type, value, traceback)\r\n     65             try:\r\n---> 66                 next(self.gen)\r\n     67             except StopIteration:\r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/errors.py in raise_exception_on_not_ok_status()\r\n    462           compat.as_text(pywrap_tensorflow.TF_Message(status)),\r\n--> 463           pywrap_tensorflow.TF_GetCode(status))\r\n    464   finally:\r\n\r\nInvalidArgumentError: Incompatible shapes: [3,4] vs. [1,2]\r\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nInvalidArgumentError                      Traceback (most recent call last)\r\n<ipython-input-206-b8a2a3bd8471> in <module>()\r\n      2              feed_dict={\r\n      3                  x:np.random.randn(3, 2),\r\n----> 4                  y:np.random.randint(0, 2, 3)\r\n      5              })\r\n      6 res\r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\r\n    715     try:\r\n    716       result = self._run(None, fetches, feed_dict, options_ptr,\r\n--> 717                          run_metadata_ptr)\r\n    718       if run_metadata:\r\n    719         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\r\n    913     if final_fetches or final_targets:\r\n    914       results = self._do_run(handle, final_targets, final_fetches,\r\n--> 915                              feed_dict_string, options, run_metadata)\r\n    916     else:\r\n    917       results = []\r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\r\n    963     if handle is None:\r\n    964       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\r\n--> 965                            target_list, options, run_metadata)\r\n    966     else:\r\n    967       return self._do_call(_prun_fn, self._session, handle, feed_dict,\r\n\r\n/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\r\n    983         except KeyError:\r\n    984           pass\r\n--> 985       raise type(e)(node_def, op, message)\r\n    986 \r\n    987   def _extend_graph(self):\r\n\r\nInvalidArgumentError: Incompatible shapes: [3,4] vs. [1,2]\r\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\r\n\r\nCaused by op 'gradients/add_grad/BroadcastGradientArgs', defined at:\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 184, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 85, in _run_code\r\n    exec(code, run_globals)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/__main__.py\", line 3, in <module>\r\n    app.launch_new_instance()\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/traitlets/config/application.py\", line 658, in launch_instance\r\n    app.start()\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelapp.py\", line 474, in start\r\n    ioloop.IOLoop.instance().start()\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/ioloop.py\", line 177, in start\r\n    super(ZMQIOLoop, self).start()\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/ioloop.py\", line 887, in start\r\n    handler_func(fd_obj, events)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\r\n    self._handle_recv()\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\r\n    self._run_callback(callback, msg)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\r\n    callback(*args, **kwargs)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\r\n    return self.dispatch_shell(stream, msg)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\r\n    handler(stream, idents, msg)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/kernelbase.py\", line 390, in execute_request\r\n    user_expressions, allow_stdin)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/ipkernel.py\", line 196, in do_execute\r\n    res = shell.run_cell(code, store_history=store_history, silent=silent)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/ipykernel/zmqshell.py\", line 501, in run_cell\r\n    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2717, in run_cell\r\n    interactivity=interactivity, compiler=compiler, result=result)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2821, in run_ast_nodes\r\n    if self.run_code(code, result):\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-196-ab717a15c74f>\", line 31, in <module>\r\n    grads_and_vars = opt.compute_gradients(loss, var_list=[w, b])\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/training/optimizer.py\", line 253, in compute_gradients\r\n    colocate_gradients_with_ops=colocate_gradients_with_ops)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gradients.py\", line 469, in gradients\r\n    in_grads = _AsList(grad_fn(op, *out_grads))\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/math_grad.py\", line 555, in _AddGrad\r\n    rx, ry = gen_array_ops._broadcast_gradient_args(sx, sy)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 388, in _broadcast_gradient_args\r\n    name=name)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\r\n    op_def=op_def)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\n...which was originally created as op 'add', defined at:\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/runpy.py\", line 184, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n[elided 18 identical lines from previous traceback]\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/IPython/core/interactiveshell.py\", line 2881, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-196-ab717a15c74f>\", line 25, in <module>\r\n    p = tf.matmul(x, w) + b\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/math_ops.py\", line 751, in binary_op_wrapper\r\n    return func(x, y, name=name)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/ops/gen_math_ops.py\", line 71, in add\r\n    result = _op_def_lib.apply_op(\"Add\", x=x, y=y, name=name)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 749, in apply_op\r\n    op_def=op_def)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2380, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/Users/merekhinsky/.conda/envs/e1/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1298, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\nInvalidArgumentError (see above for traceback): Incompatible shapes: [3,4] vs. [1,2]\r\n\t [[Node: gradients/add_grad/BroadcastGradientArgs = BroadcastGradientArgs[T=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients/add_grad/Shape, gradients/add_grad/Shape_1)]]\r\n```"}