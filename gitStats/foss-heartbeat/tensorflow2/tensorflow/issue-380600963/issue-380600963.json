{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23731", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23731/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23731/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23731/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23731", "id": 380600963, "node_id": "MDU6SXNzdWUzODA2MDA5NjM=", "number": 23731, "title": "Error when using tf.metrics.mean_iou() in eval_metric_ops of tf.estimator.EstimatorSpec()", "user": {"login": "mzhaoshuai", "id": 22476764, "node_id": "MDQ6VXNlcjIyNDc2NzY0", "avatar_url": "https://avatars1.githubusercontent.com/u/22476764?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mzhaoshuai", "html_url": "https://github.com/mzhaoshuai", "followers_url": "https://api.github.com/users/mzhaoshuai/followers", "following_url": "https://api.github.com/users/mzhaoshuai/following{/other_user}", "gists_url": "https://api.github.com/users/mzhaoshuai/gists{/gist_id}", "starred_url": "https://api.github.com/users/mzhaoshuai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mzhaoshuai/subscriptions", "organizations_url": "https://api.github.com/users/mzhaoshuai/orgs", "repos_url": "https://api.github.com/users/mzhaoshuai/repos", "events_url": "https://api.github.com/users/mzhaoshuai/events{/privacy}", "received_events_url": "https://api.github.com/users/mzhaoshuai/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": {"login": "pavithrasv", "id": 13326758, "node_id": "MDQ6VXNlcjEzMzI2NzU4", "avatar_url": "https://avatars0.githubusercontent.com/u/13326758?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pavithrasv", "html_url": "https://github.com/pavithrasv", "followers_url": "https://api.github.com/users/pavithrasv/followers", "following_url": "https://api.github.com/users/pavithrasv/following{/other_user}", "gists_url": "https://api.github.com/users/pavithrasv/gists{/gist_id}", "starred_url": "https://api.github.com/users/pavithrasv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pavithrasv/subscriptions", "organizations_url": "https://api.github.com/users/pavithrasv/orgs", "repos_url": "https://api.github.com/users/pavithrasv/repos", "events_url": "https://api.github.com/users/pavithrasv/events{/privacy}", "received_events_url": "https://api.github.com/users/pavithrasv/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pavithrasv", "id": 13326758, "node_id": "MDQ6VXNlcjEzMzI2NzU4", "avatar_url": "https://avatars0.githubusercontent.com/u/13326758?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pavithrasv", "html_url": "https://github.com/pavithrasv", "followers_url": "https://api.github.com/users/pavithrasv/followers", "following_url": "https://api.github.com/users/pavithrasv/following{/other_user}", "gists_url": "https://api.github.com/users/pavithrasv/gists{/gist_id}", "starred_url": "https://api.github.com/users/pavithrasv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pavithrasv/subscriptions", "organizations_url": "https://api.github.com/users/pavithrasv/orgs", "repos_url": "https://api.github.com/users/pavithrasv/repos", "events_url": "https://api.github.com/users/pavithrasv/events{/privacy}", "received_events_url": "https://api.github.com/users/pavithrasv/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-11-14T09:11:51Z", "updated_at": "2018-11-19T21:39:47Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>:<em>no</em></li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>:  <em>Linux Ubuntu 16.04.5 LTS</em>\u3002</li>\n<li><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device</strong>:<em>no</em></li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:<em>binary</em></li>\n<li><strong>TensorFlow version (use command below)</strong>:<em>1.11.0</em></li>\n<li><strong>Python version</strong>:<em>Python 3.5.2</em></li>\n<li><strong>Bazel version (if compiling from source)</strong>:<em>None</em></li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:<em>None</em></li>\n<li><strong>CUDA/cuDNN version</strong>:<em>CUDA-9.1/cuDNN-7.0.5</em></li>\n<li><strong>GPU model and memory</strong>: <em>GTX 1080Ti 11GB, 2 same cards</em></li>\n<li><strong>Exact command to reproduce</strong>:<em>below</em></li>\n</ul>\n<h3>Supplementary material</h3>\n<p>I just pulled the tensorflow's offical docker image and RUN some <code>pip install ...</code> instructions.<br>\nThe tag of the iamge is <code>1.11.0-devel-gpu-py3</code>.</p>\n<h3>Describe the problem</h3>\n<p>When I use the code below</p>\n<pre><code>accuracy = tf.metrics.accuracy(valid_labels, valid_preds)\nmean_iou = tf.metrics.mean_iou(valid_labels, valid_preds, params['num_classes'])\nprint(mean_iou)\neval_metrics = {'px_accuracy': accuracy, 'mean_iou': mean_iou}\t\n......\nreturn tf.estimator.EstimatorSpec(\n\t\tmode=mode,\n\t\tpredictions=None,\n\t\tloss=loss,\n\t\ttrain_op=train_op,\n\t\teval_metric_ops=eval_metrics)\n</code></pre>\n<p>It will raise <code>TypeError</code></p>\n<pre><code>TypeError: eval_metric_ops[mean_iou] must be Operation or Tensor, \ngiven: &lt;tf.Variable 'mean_iou/AssignAddVariableOp' shape=(21, 21) dtype=float64&gt;\n</code></pre>\n<p>And the result of  <code>print</code> is</p>\n<pre><code>(&lt;tf.Tensor 'mean_iou/Select_1:0' shape=() dtype=float32&gt;, \n&lt;tf.Variable 'mean_iou/AssignAddVariableOp' shape=(21, 21) dtype=float64&gt;)\n</code></pre>\n<p>I google the error and find the similar issue<br>\n<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"337044823\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/20418\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/20418/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/20418\">#20418</a></p>\n<p>So I modify the code</p>\n<pre><code>accuracy = tf.metrics.accuracy(valid_labels, valid_preds)\nmean_iou = tf.metrics.mean_iou(valid_labels, valid_preds, params['num_classes'])\nmean_iou = (mean_iou[0], tf.to_float(mean_iou[1]))\nprint(mean_iou)\neval_metrics = {'px_accuracy': accuracy, 'mean_iou': mean_iou}\t\n</code></pre>\n<p>Then the code works normally.</p>\n<p>So I think there may be something wrong in <code>tf.metrics.mean_iou</code>.</p>\n<p>A strange thing is that the original code(no <code>tf.to_float()</code>) used to work normally......<br>\nAfter I add <code>distribution strategy</code>  to the config of the estimator and do some other changes , it broke down.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow):no\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04):  Linux Ubuntu 16.04.5 LTS\u3002\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:no\nTensorFlow installed from (source or binary):binary\nTensorFlow version (use command below):1.11.0\nPython version:Python 3.5.2\nBazel version (if compiling from source):None\nGCC/Compiler version (if compiling from source):None\nCUDA/cuDNN version:CUDA-9.1/cuDNN-7.0.5\nGPU model and memory: GTX 1080Ti 11GB, 2 same cards\nExact command to reproduce:below\n\nSupplementary material\nI just pulled the tensorflow's offical docker image and RUN some pip install ... instructions.\nThe tag of the iamge is 1.11.0-devel-gpu-py3.\nDescribe the problem\nWhen I use the code below\naccuracy = tf.metrics.accuracy(valid_labels, valid_preds)\nmean_iou = tf.metrics.mean_iou(valid_labels, valid_preds, params['num_classes'])\nprint(mean_iou)\neval_metrics = {'px_accuracy': accuracy, 'mean_iou': mean_iou}\t\n......\nreturn tf.estimator.EstimatorSpec(\n\t\tmode=mode,\n\t\tpredictions=None,\n\t\tloss=loss,\n\t\ttrain_op=train_op,\n\t\teval_metric_ops=eval_metrics)\n\nIt will raise TypeError\nTypeError: eval_metric_ops[mean_iou] must be Operation or Tensor, \ngiven: <tf.Variable 'mean_iou/AssignAddVariableOp' shape=(21, 21) dtype=float64>\n\nAnd the result of  print is\n(<tf.Tensor 'mean_iou/Select_1:0' shape=() dtype=float32>, \n<tf.Variable 'mean_iou/AssignAddVariableOp' shape=(21, 21) dtype=float64>)\n\nI google the error and find the similar issue\n#20418\nSo I modify the code\naccuracy = tf.metrics.accuracy(valid_labels, valid_preds)\nmean_iou = tf.metrics.mean_iou(valid_labels, valid_preds, params['num_classes'])\nmean_iou = (mean_iou[0], tf.to_float(mean_iou[1]))\nprint(mean_iou)\neval_metrics = {'px_accuracy': accuracy, 'mean_iou': mean_iou}\t\n\nThen the code works normally.\nSo I think there may be something wrong in tf.metrics.mean_iou.\nA strange thing is that the original code(no tf.to_float()) used to work normally......\nAfter I add distribution strategy  to the config of the estimator and do some other changes , it broke down.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**:_no_\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**:  _Linux Ubuntu 16.04.5 LTS_\u3002\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device**:_no_\r\n- **TensorFlow installed from (source or binary)**:_binary_\r\n- **TensorFlow version (use command below)**:_1.11.0_\r\n- **Python version**:_Python 3.5.2_\r\n- **Bazel version (if compiling from source)**:_None_\r\n- **GCC/Compiler version (if compiling from source)**:_None_\r\n- **CUDA/cuDNN version**:_CUDA-9.1/cuDNN-7.0.5_\r\n- **GPU model and memory**: _GTX 1080Ti 11GB, 2 same cards_\r\n- **Exact command to reproduce**:_below_\r\n\r\n### Supplementary material\r\nI just pulled the tensorflow's offical docker image and RUN some `pip install ...` instructions.\r\nThe tag of the iamge is `1.11.0-devel-gpu-py3`.\r\n\r\n### Describe the problem\r\nWhen I use the code below\r\n\r\n```\r\naccuracy = tf.metrics.accuracy(valid_labels, valid_preds)\r\nmean_iou = tf.metrics.mean_iou(valid_labels, valid_preds, params['num_classes'])\r\nprint(mean_iou)\r\neval_metrics = {'px_accuracy': accuracy, 'mean_iou': mean_iou}\t\r\n......\r\nreturn tf.estimator.EstimatorSpec(\r\n\t\tmode=mode,\r\n\t\tpredictions=None,\r\n\t\tloss=loss,\r\n\t\ttrain_op=train_op,\r\n\t\teval_metric_ops=eval_metrics)\r\n```\r\n\r\nIt will raise `TypeError`\r\n\r\n```\r\nTypeError: eval_metric_ops[mean_iou] must be Operation or Tensor, \r\ngiven: <tf.Variable 'mean_iou/AssignAddVariableOp' shape=(21, 21) dtype=float64>\r\n```\r\n\r\nAnd the result of  `print` is\r\n\r\n```\r\n(<tf.Tensor 'mean_iou/Select_1:0' shape=() dtype=float32>, \r\n<tf.Variable 'mean_iou/AssignAddVariableOp' shape=(21, 21) dtype=float64>)\r\n```\r\n\r\nI google the error and find the similar issue\r\nhttps://github.com/tensorflow/tensorflow/issues/20418\r\n\r\nSo I modify the code\r\n```\r\naccuracy = tf.metrics.accuracy(valid_labels, valid_preds)\r\nmean_iou = tf.metrics.mean_iou(valid_labels, valid_preds, params['num_classes'])\r\nmean_iou = (mean_iou[0], tf.to_float(mean_iou[1]))\r\nprint(mean_iou)\r\neval_metrics = {'px_accuracy': accuracy, 'mean_iou': mean_iou}\t\r\n```\r\nThen the code works normally.\r\n\r\nSo I think there may be something wrong in `tf.metrics.mean_iou`.\r\n\r\nA strange thing is that the original code(no `tf.to_float()`) used to work normally......\r\nAfter I add `distribution strategy`  to the config of the estimator and do some other changes , it broke down. \r\n\r\n"}