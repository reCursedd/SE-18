{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/217509532", "pull_request_review_id": 155240369, "id": 217509532, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzUwOTUzMg==", "diff_hunk": "@@ -1251,6 +1254,76 @@ class MklTanhGradOp : public MklReluGradOpBase<Device, T, eltwise_tanh> {\n   }\n };\n \n+#define RELU6_UPPER_BOUND 6.0f\n+template <typename Device, typename T>\n+class MklRelu6Op : public MklReluOpBase<Device, T, eltwise_bounded_relu> {\n+ public:\n+  ~MklRelu6Op() {}\n+\n+  explicit MklRelu6Op(OpKernelConstruction* context)\n+      : MklReluOpBase<Device, T, eltwise_bounded_relu>(\n+            context, RELU6_UPPER_BOUND, 0.0f) {}\n+\n+  virtual void Compute_Scalar(OpKernelContext* context) {\n+    const size_t src_index = 0;  // index of src input tensor\n+    const size_t dst_index = 0;  // index of dst output tensor\n+    const Tensor& src_tensor = MklGetInput(context, src_index);\n+    MklDnnShape dnn_shape_src;\n+    GetMklShape(context, src_index, &dnn_shape_src);\n+\n+    Tensor* dst_tensor = nullptr;\n+    void* user_i =\n+        static_cast<void*>(const_cast<T*>(src_tensor.flat<T>().data()));\n+    MklDnnShape dnn_shape_dst;\n+    dnn_shape_dst.SetMklTensor(false);\n+    AllocateOutputSetMklShape(context, dst_index, &dst_tensor,\n+                              src_tensor.shape(), dnn_shape_dst);\n+    void* out_o = static_cast<void*>(dst_tensor->flat<T>().data());\n+    (static_cast<T*>(out_o))[0] =\n+        std::min(std::max((static_cast<T*>(user_i))[0], static_cast<T>(0)),\n+                 static_cast<T>(RELU6_UPPER_BOUND));\n+    return;\n+  }\n+};\n+\n+template <typename Device, typename T>\n+class MklRelu6GradOp\n+    : public MklReluGradOpBase<Device, T, eltwise_bounded_relu> {\n+ public:\n+  ~MklRelu6GradOp() {}\n+\n+  explicit MklRelu6GradOp(OpKernelConstruction* context)\n+      : MklReluGradOpBase<Device, T, eltwise_bounded_relu>(\n+            context, RELU6_UPPER_BOUND, 0.0f) {}\n+\n+  virtual void Compute_Scalar(OpKernelContext* context) {\n+    const size_t diff_dst_index = 0;  // index of diff_dst input tensor\n+    const size_t src_index = 1;       // index of src input tensor\n+    const size_t diff_src_index = 0;  // index of diff_src output tensor\n+    const Tensor& src_tensor = MklGetInput(context, src_index);\n+    const Tensor& diff_dst_tensor = MklGetInput(context, diff_dst_index);\n+    Tensor* diff_src_tensor = nullptr;\n+\n+    MklDnnShape dnn_shape_diff_dst;\n+    GetMklShape(context, diff_dst_index, &dnn_shape_diff_dst);\n+\n+    MklDnnShape dnn_shape_diff_src;\n+    dnn_shape_diff_src.SetMklTensor(false);\n+    AllocateOutputSetMklShape(context, diff_src_index, &diff_src_tensor,\n+                              diff_dst_tensor.shape(), dnn_shape_diff_src);\n+    void* out_o = static_cast<void*>(diff_src_tensor->flat<T>().data());", "path": "tensorflow/core/kernels/mkl_relu_op.cc", "position": null, "original_position": 197, "commit_id": "b55c96d199028c58a547807eedb0bf1fe285945f", "original_commit_id": "1253ef6970edccb21c4d4995a4af9103c0cd2b88", "user": {"login": "ezhulenev", "id": 1174378, "node_id": "MDQ6VXNlcjExNzQzNzg=", "avatar_url": "https://avatars2.githubusercontent.com/u/1174378?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezhulenev", "html_url": "https://github.com/ezhulenev", "followers_url": "https://api.github.com/users/ezhulenev/followers", "following_url": "https://api.github.com/users/ezhulenev/following{/other_user}", "gists_url": "https://api.github.com/users/ezhulenev/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezhulenev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezhulenev/subscriptions", "organizations_url": "https://api.github.com/users/ezhulenev/orgs", "repos_url": "https://api.github.com/users/ezhulenev/repos", "events_url": "https://api.github.com/users/ezhulenev/events{/privacy}", "received_events_url": "https://api.github.com/users/ezhulenev/received_events", "type": "User", "site_admin": false}, "body": "Same question about pointers, so much syntactic noise but I don't get why it's needed here,", "created_at": "2018-09-13T19:40:24Z", "updated_at": "2018-10-18T06:09:24Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/22244#discussion_r217509532", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/22244", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/217509532"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/22244#discussion_r217509532"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/22244"}}, "body_html": "<p>Same question about pointers, so much syntactic noise but I don't get why it's needed here,</p>", "body_text": "Same question about pointers, so much syntactic noise but I don't get why it's needed here,"}