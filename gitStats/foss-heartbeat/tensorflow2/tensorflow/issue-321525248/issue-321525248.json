{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19178", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19178/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19178/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19178/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19178", "id": 321525248, "node_id": "MDU6SXNzdWUzMjE1MjUyNDg=", "number": 19178, "title": "Race condition when initializing variables in control_dependencies", "user": {"login": "Noctune", "id": 448023, "node_id": "MDQ6VXNlcjQ0ODAyMw==", "avatar_url": "https://avatars3.githubusercontent.com/u/448023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Noctune", "html_url": "https://github.com/Noctune", "followers_url": "https://api.github.com/users/Noctune/followers", "following_url": "https://api.github.com/users/Noctune/following{/other_user}", "gists_url": "https://api.github.com/users/Noctune/gists{/gist_id}", "starred_url": "https://api.github.com/users/Noctune/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Noctune/subscriptions", "organizations_url": "https://api.github.com/users/Noctune/orgs", "repos_url": "https://api.github.com/users/Noctune/repos", "events_url": "https://api.github.com/users/Noctune/events{/privacy}", "received_events_url": "https://api.github.com/users/Noctune/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386191887, "node_id": "MDU6TGFiZWwzODYxOTE4ODc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response", "name": "stat:awaiting response", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "tatatodd", "id": 5453737, "node_id": "MDQ6VXNlcjU0NTM3Mzc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5453737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatatodd", "html_url": "https://github.com/tatatodd", "followers_url": "https://api.github.com/users/tatatodd/followers", "following_url": "https://api.github.com/users/tatatodd/following{/other_user}", "gists_url": "https://api.github.com/users/tatatodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatatodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatatodd/subscriptions", "organizations_url": "https://api.github.com/users/tatatodd/orgs", "repos_url": "https://api.github.com/users/tatatodd/repos", "events_url": "https://api.github.com/users/tatatodd/events{/privacy}", "received_events_url": "https://api.github.com/users/tatatodd/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "tatatodd", "id": 5453737, "node_id": "MDQ6VXNlcjU0NTM3Mzc=", "avatar_url": "https://avatars3.githubusercontent.com/u/5453737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatatodd", "html_url": "https://github.com/tatatodd", "followers_url": "https://api.github.com/users/tatatodd/followers", "following_url": "https://api.github.com/users/tatatodd/following{/other_user}", "gists_url": "https://api.github.com/users/tatatodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatatodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatatodd/subscriptions", "organizations_url": "https://api.github.com/users/tatatodd/orgs", "repos_url": "https://api.github.com/users/tatatodd/repos", "events_url": "https://api.github.com/users/tatatodd/events{/privacy}", "received_events_url": "https://api.github.com/users/tatatodd/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2018-05-09T11:00:22Z", "updated_at": "2018-06-25T19:01:21Z", "closed_at": "2018-06-25T19:01:21Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<pre><code>== cat /etc/issue ===============================================\nDarwin Mikes-MBP.enversion.com 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64\nMac OS X 10.12.6\n\n== are we in docker =============================================\nNo\n\n== compiler =====================================================\nApple LLVM version 9.0.0 (clang-900.0.39.2)\nTarget: x86_64-apple-darwin16.7.0\nThread model: posix\nInstalledDir: /Library/Developer/CommandLineTools/usr/bin\n\n== uname -a =====================================================\nDarwin Mikes-MBP.enversion.com 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64\n\n== check pips ===================================================\n\n== check for virtualenv =========================================\nFalse\n\n== tensorflow import ============================================\ntf.VERSION = 1.8.0\ntf.GIT_VERSION = v1.8.0-0-g93bc2e2072\ntf.COMPILER_VERSION = v1.8.0-0-g93bc2e2072\nSanity check: array([1], dtype=int32)\n\n== env ==========================================================\nLD_LIBRARY_PATH is unset\nDYLD_LIBRARY_PATH is unset\n\n== nvidia-smi ===================================================\ntf_env_collect.sh: line 105: nvidia-smi: command not found\n\n== cuda libs  ===================================================\n</code></pre>\n<h3>Describe the problem</h3>\n<p>Given how <code>Variable</code> and <code>control_dependencies</code> are documented, I would expect the following to work:</p>\n<pre><code>with tf.Session() as sess:\n    v = tf.Variable(tf.zeros([100,100]))\n    with tf.control_dependencies([v.initializer]):\n        d = tf.Print(v, [v])\n    print(sess.run(d))\n</code></pre>\n<p>But this seems to create a race condition. Sometimes it executes fine, sometimes it errors with <code>FailedPreconditionError: Attempting to use uninitialized value Variable</code>. It is unclear to me if the use of initializers in <code>control_dependencies</code> is valid. If it is not, the documentation should probably better reflect this.</p>\n<h3>Source code / logs</h3>\n<p>Full traceback:</p>\n<pre><code>Traceback (most recent call last):\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1322, in _do_call\n    return fn(*args)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1307, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1409, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"test.py\", line 105, in &lt;module&gt;\n    print(sess.run(d))\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 900, in run\n    run_metadata_ptr)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\n    run_metadata)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\n\nCaused by op 'Variable/read', defined at:\n  File \"test.py\", line 101, in &lt;module&gt;\n    v = tf.Variable(tf.zeros([100,100]))\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 235, in __init__\n    constraint=constraint)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 397, in _init_from_args\n    self._snapshot = array_ops.identity(self._variable, name=\"read\")\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 142, in identity\n    return gen_array_ops.identity(input, name=name)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 3187, in identity\n    \"Identity\", input=input, name=name)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\n    op_def=op_def)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nFailedPreconditionError (see above for traceback): Attempting to use uninitialized value Variable\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\n</code></pre>", "body_text": "System information\n== cat /etc/issue ===============================================\nDarwin Mikes-MBP.enversion.com 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64\nMac OS X 10.12.6\n\n== are we in docker =============================================\nNo\n\n== compiler =====================================================\nApple LLVM version 9.0.0 (clang-900.0.39.2)\nTarget: x86_64-apple-darwin16.7.0\nThread model: posix\nInstalledDir: /Library/Developer/CommandLineTools/usr/bin\n\n== uname -a =====================================================\nDarwin Mikes-MBP.enversion.com 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64\n\n== check pips ===================================================\n\n== check for virtualenv =========================================\nFalse\n\n== tensorflow import ============================================\ntf.VERSION = 1.8.0\ntf.GIT_VERSION = v1.8.0-0-g93bc2e2072\ntf.COMPILER_VERSION = v1.8.0-0-g93bc2e2072\nSanity check: array([1], dtype=int32)\n\n== env ==========================================================\nLD_LIBRARY_PATH is unset\nDYLD_LIBRARY_PATH is unset\n\n== nvidia-smi ===================================================\ntf_env_collect.sh: line 105: nvidia-smi: command not found\n\n== cuda libs  ===================================================\n\nDescribe the problem\nGiven how Variable and control_dependencies are documented, I would expect the following to work:\nwith tf.Session() as sess:\n    v = tf.Variable(tf.zeros([100,100]))\n    with tf.control_dependencies([v.initializer]):\n        d = tf.Print(v, [v])\n    print(sess.run(d))\n\nBut this seems to create a race condition. Sometimes it executes fine, sometimes it errors with FailedPreconditionError: Attempting to use uninitialized value Variable. It is unclear to me if the use of initializers in control_dependencies is valid. If it is not, the documentation should probably better reflect this.\nSource code / logs\nFull traceback:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1322, in _do_call\n    return fn(*args)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1307, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1409, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"test.py\", line 105, in <module>\n    print(sess.run(d))\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 900, in run\n    run_metadata_ptr)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\n    run_metadata)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\n\nCaused by op 'Variable/read', defined at:\n  File \"test.py\", line 101, in <module>\n    v = tf.Variable(tf.zeros([100,100]))\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 235, in __init__\n    constraint=constraint)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 397, in _init_from_args\n    self._snapshot = array_ops.identity(self._variable, name=\"read\")\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 142, in identity\n    return gen_array_ops.identity(input, name=name)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 3187, in identity\n    \"Identity\", input=input, name=name)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\n    op_def=op_def)\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nFailedPreconditionError (see above for traceback): Attempting to use uninitialized value Variable\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]", "body": "### System information\r\n\r\n```\r\n== cat /etc/issue ===============================================\r\nDarwin Mikes-MBP.enversion.com 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64\r\nMac OS X 10.12.6\r\n\r\n== are we in docker =============================================\r\nNo\r\n\r\n== compiler =====================================================\r\nApple LLVM version 9.0.0 (clang-900.0.39.2)\r\nTarget: x86_64-apple-darwin16.7.0\r\nThread model: posix\r\nInstalledDir: /Library/Developer/CommandLineTools/usr/bin\r\n\r\n== uname -a =====================================================\r\nDarwin Mikes-MBP.enversion.com 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64\r\n\r\n== check pips ===================================================\r\n\r\n== check for virtualenv =========================================\r\nFalse\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 1.8.0\r\ntf.GIT_VERSION = v1.8.0-0-g93bc2e2072\r\ntf.COMPILER_VERSION = v1.8.0-0-g93bc2e2072\r\nSanity check: array([1], dtype=int32)\r\n\r\n== env ==========================================================\r\nLD_LIBRARY_PATH is unset\r\nDYLD_LIBRARY_PATH is unset\r\n\r\n== nvidia-smi ===================================================\r\ntf_env_collect.sh: line 105: nvidia-smi: command not found\r\n\r\n== cuda libs  ===================================================\r\n```\r\n\r\n### Describe the problem\r\n\r\nGiven how `Variable` and `control_dependencies` are documented, I would expect the following to work:\r\n\r\n```\r\nwith tf.Session() as sess:\r\n    v = tf.Variable(tf.zeros([100,100]))\r\n    with tf.control_dependencies([v.initializer]):\r\n        d = tf.Print(v, [v])\r\n    print(sess.run(d))\r\n```\r\n\r\nBut this seems to create a race condition. Sometimes it executes fine, sometimes it errors with `FailedPreconditionError: Attempting to use uninitialized value Variable`. It is unclear to me if the use of initializers in `control_dependencies` is valid. If it is not, the documentation should probably better reflect this.\r\n\r\n### Source code / logs\r\n\r\nFull traceback:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1322, in _do_call\r\n    return fn(*args)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1307, in _run_fn\r\n    options, feed_dict, fetch_list, target_list, run_metadata)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1409, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\r\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 105, in <module>\r\n    print(sess.run(d))\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 900, in run\r\n    run_metadata_ptr)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\r\n    run_metadata)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Attempting to use uninitialized value Variable\r\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\r\n\r\nCaused by op 'Variable/read', defined at:\r\n  File \"test.py\", line 101, in <module>\r\n    v = tf.Variable(tf.zeros([100,100]))\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 235, in __init__\r\n    constraint=constraint)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 397, in _init_from_args\r\n    self._snapshot = array_ops.identity(self._variable, name=\"read\")\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 142, in identity\r\n    return gen_array_ops.identity(input, name=name)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 3187, in identity\r\n    \"Identity\", input=input, name=name)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\r\n    op_def=op_def)\r\n  File \"/usr/local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nFailedPreconditionError (see above for traceback): Attempting to use uninitialized value Variable\r\n         [[Node: Variable/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable/Assign\"], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](Variable)]]\r\n```\r\n"}