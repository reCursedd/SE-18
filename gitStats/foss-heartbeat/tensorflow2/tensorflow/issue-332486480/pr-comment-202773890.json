{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/202773890", "pull_request_review_id": 137535725, "id": 202773890, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwMjc3Mzg5MA==", "diff_hunk": "@@ -232,11 +232,19 @@ bool CommonInitDecode(StringPiece png_string, int desired_channels,\n     CommonFreeDecode(context);\n     return false;\n   }\n-  if (context->channels == 0) {  // Autodetect number of channels\n-    context->channels = png_get_channels(context->png_ptr, context->info_ptr);\n-  }\n   const bool has_tRNS =\n       (png_get_valid(context->png_ptr, context->info_ptr, PNG_INFO_tRNS)) != 0;\n+  if (context->channels == 0) {  // Autodetect number of channels\n+    if (context->color_type == PNG_COLOR_TYPE_PALETTE) {", "path": "tensorflow/core/lib/png/png_io.cc", "position": 10, "original_position": 10, "commit_id": "141fe1e7dccd97c99a60bbabfd1e8c52a7d3348a", "original_commit_id": "310e822b4c88169b140a4e5c8e37da756c91758a", "user": {"login": "yoya", "id": 26040, "node_id": "MDQ6VXNlcjI2MDQw", "avatar_url": "https://avatars1.githubusercontent.com/u/26040?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yoya", "html_url": "https://github.com/yoya", "followers_url": "https://api.github.com/users/yoya/followers", "following_url": "https://api.github.com/users/yoya/following{/other_user}", "gists_url": "https://api.github.com/users/yoya/gists{/gist_id}", "starred_url": "https://api.github.com/users/yoya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yoya/subscriptions", "organizations_url": "https://api.github.com/users/yoya/orgs", "repos_url": "https://api.github.com/users/yoya/repos", "events_url": "https://api.github.com/users/yoya/events{/privacy}", "received_events_url": "https://api.github.com/users/yoya/received_events", "type": "User", "site_admin": false}, "body": "Certainly, you convert palette to rgb bellow.\r\nBut grayscale conversion run after that, because channels is 1 (args channels=0)\r\n\r\nThis issue depends on meaning of:\r\n \"the number of channels in the PNG-encoded image.\"\r\nhttps://www.tensorflow.org/api_docs/python/tf/image/decode_png\r\n\r\npng_get_channels function return 1 if colortype is PALETTE.\r\nhttp://www.libpng.org/pub/png/libpng-manual.html#section-3.6\r\nPalette has indices channels so channels 1 only.\r\n\r\nI think that the current decode_png behavior is unkind.", "created_at": "2018-07-16T18:12:18Z", "updated_at": "2018-07-26T06:49:14Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/20029#discussion_r202773890", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/20029", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/202773890"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/20029#discussion_r202773890"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/20029"}}, "body_html": "<p>Certainly, you convert palette to rgb bellow.<br>\nBut grayscale conversion run after that, because channels is 1 (args channels=0)</p>\n<p>This issue depends on meaning of:<br>\n\"the number of channels in the PNG-encoded image.\"<br>\n<a href=\"https://www.tensorflow.org/api_docs/python/tf/image/decode_png\" rel=\"nofollow\">https://www.tensorflow.org/api_docs/python/tf/image/decode_png</a></p>\n<p>png_get_channels function return 1 if colortype is PALETTE.<br>\n<a href=\"http://www.libpng.org/pub/png/libpng-manual.html#section-3.6\" rel=\"nofollow\">http://www.libpng.org/pub/png/libpng-manual.html#section-3.6</a><br>\nPalette has indices channels so channels 1 only.</p>\n<p>I think that the current decode_png behavior is unkind.</p>", "body_text": "Certainly, you convert palette to rgb bellow.\nBut grayscale conversion run after that, because channels is 1 (args channels=0)\nThis issue depends on meaning of:\n\"the number of channels in the PNG-encoded image.\"\nhttps://www.tensorflow.org/api_docs/python/tf/image/decode_png\npng_get_channels function return 1 if colortype is PALETTE.\nhttp://www.libpng.org/pub/png/libpng-manual.html#section-3.6\nPalette has indices channels so channels 1 only.\nI think that the current decode_png behavior is unkind.", "in_reply_to_id": 202703582}