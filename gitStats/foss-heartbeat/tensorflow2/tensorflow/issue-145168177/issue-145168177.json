{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/1740", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/1740/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/1740/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/1740/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/1740", "id": 145168177, "node_id": "MDU6SXNzdWUxNDUxNjgxNzc=", "number": 1740, "title": "Tensorflow Adam Multigpu Gradient", "user": {"login": "Fhrozen", "id": 11988996, "node_id": "MDQ6VXNlcjExOTg4OTk2", "avatar_url": "https://avatars3.githubusercontent.com/u/11988996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Fhrozen", "html_url": "https://github.com/Fhrozen", "followers_url": "https://api.github.com/users/Fhrozen/followers", "following_url": "https://api.github.com/users/Fhrozen/following{/other_user}", "gists_url": "https://api.github.com/users/Fhrozen/gists{/gist_id}", "starred_url": "https://api.github.com/users/Fhrozen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Fhrozen/subscriptions", "organizations_url": "https://api.github.com/users/Fhrozen/orgs", "repos_url": "https://api.github.com/users/Fhrozen/repos", "events_url": "https://api.github.com/users/Fhrozen/events{/privacy}", "received_events_url": "https://api.github.com/users/Fhrozen/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-04-01T12:27:58Z", "updated_at": "2016-04-02T22:02:25Z", "closed_at": "2016-04-02T22:02:25Z", "author_association": "NONE", "body_html": "<p>I am trying to implement a network multiple gpu on tensorflow using ADAM Optimization.</p>\n<p>I am coping the code from the Cifar10_multigpu, but it looks that when the gradient calls the second tower it calls the gradient of the first and generated error on the average of the two towers. the code of the two tower is this</p>\n<pre><code> for d in devs:\n        with tf.device(d):\n            with tf.name_scope('%s_%d' % (tf_model.TOWER_NAME, i)) as scope:\n                loss = tower_loss(scope)\n                tf.get_variable_scope().reuse_variables()\n                summaries = tf.get_collection(tf.GraphKeys.SUMMARIES, scope)\n                grads = opt.compute_gradients(loss)\n                print('\\n'.join('{}: {}'.format(*k) for k in enumerate(grads)))\n                tower_grads.append(grads)\n        i +=1\n</code></pre>\n<p>and this generates each tower:</p>\n<pre><code>stream, target= placeholder_inputs(FLAGS.batch_size*tf_model.ANGLES/FLAGS.num_gpus)\n    logits = tf_model.inference_noisy_simulate(stream)\n    _ = tf_model.loss(logits, target)\n    losses = tf.get_collection('losses', scope)\n    total_loss = tf.add_n(losses, name='total_loss')\n</code></pre>\n<p>looking at the gradients the first tower generate this:</p>\n<pre><code>0: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca11d0ae10&gt;)\n1: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv1/Conv2D_grad/tuple/control_dependency_1:0' shape=(1, 1, 8, 16) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351b10&gt;)\n2: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv1/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c380dd0&gt;)\n3: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv2/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 16) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351a10&gt;)\n4: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv2/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6dd0&gt;)\n5: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv3/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 32) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6490&gt;)\n6: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv3/BiasAdd_grad/tuple/control_dependency_1:0' shape=(32,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351990&gt;)\n7: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv4/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 32, 64) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351890&gt;)\n8: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv4/BiasAdd_grad/tuple/control_dependency_1:0' shape=(64,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c3b7790&gt;)\n9: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv5/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 64, 128) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2d9110&gt;)\n10: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv5/BiasAdd_grad/tuple/control_dependency_1:0' shape=(128,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2849d0&gt;)\n11: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv6/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 128, 256) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2e6f10&gt;)\n12: (&lt;tf.Tensor 'tower_0/gradients/tower_0/conv6/BiasAdd_grad/tuple/control_dependency_1:0' shape=(256,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2afed0&gt;)\n13: (&lt;tf.Tensor 'tower_0/gradients/tower_0/fc1/MatMul_grad/tuple/control_dependency_1:0' shape=(18944, 4096) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c1f9550&gt;)\n14: (&lt;tf.Tensor 'tower_0/gradients/tower_0/fc1/add_grad/tuple/control_dependency_1:0' shape=(4096,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c214a10&gt;)\n15: (&lt;tf.Tensor 'tower_0/gradients/tower_0/fc1_1/MatMul_grad/tuple/control_dependency_1:0' shape=(4096, 1024) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c23dfd0&gt;)\n16: (&lt;tf.Tensor 'tower_0/gradients/tower_0/fc1_1/add_grad/tuple/control_dependency_1:0' shape=(1024,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c269bd0&gt;)\n17: (&lt;tf.Tensor 'tower_0/gradients/tower_0/softmax_linear/MatMul_grad/tuple/control_dependency_1:0' shape=(1024, 360) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c1d1a50&gt;)\n18: (&lt;tf.Tensor 'tower_0/gradients/tower_0/softmax_linear/softmax_linear_grad/tuple/control_dependency_1:0' shape=(360,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c1def50&gt;)\n</code></pre>\n<p>and the second generates this;</p>\n<pre><code>0: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca11d0ae10&gt;)\n1: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351b10&gt;)\n2: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c380dd0&gt;)\n3: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351a10&gt;)\n4: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6dd0&gt;)\n5: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6490&gt;)\n6: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351990&gt;)\n7: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c351890&gt;)\n8: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c3b7790&gt;)\n9: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2d9110&gt;)\n10: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2849d0&gt;)\n11: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2e6f10&gt;)\n12: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c2afed0&gt;)\n13: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c1f9550&gt;)\n14: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c214a10&gt;)\n15: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c23dfd0&gt;)\n16: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c269bd0&gt;)\n17: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c1d1a50&gt;)\n18: (None, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c1def50&gt;)\n19: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv1/Conv2D_grad/tuple/control_dependency_1:0' shape=(1, 1, 8, 16) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0c178c50&gt;)\n20: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv1/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bfbb490&gt;)\n21: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv2/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 16) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bfda950&gt;)\n22: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv2/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf91bd0&gt;)\n23: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv3/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 32) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bfcb590&gt;)\n24: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv3/BiasAdd_grad/tuple/control_dependency_1:0' shape=(32,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf39e90&gt;)\n25: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv4/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 32, 64) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf499d0&gt;)\n26: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv4/BiasAdd_grad/tuple/control_dependency_1:0' shape=(64,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf14fd0&gt;)\n27: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv5/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 64, 128) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf39150&gt;)\n28: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv5/BiasAdd_grad/tuple/control_dependency_1:0' shape=(128,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bebd8d0&gt;)\n29: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv6/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 128, 256) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf23110&gt;)\n30: (&lt;tf.Tensor 'tower_1/gradients/tower_1/conv6/BiasAdd_grad/tuple/control_dependency_1:0' shape=(256,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf04610&gt;)\n31: (&lt;tf.Tensor 'tower_1/gradients/tower_1/fc1/MatMul_grad/tuple/control_dependency_1:0' shape=(18944, 4096) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bebdc50&gt;)\n32: (&lt;tf.Tensor 'tower_1/gradients/tower_1/fc1/add_grad/tuple/control_dependency_1:0' shape=(4096,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bebd310&gt;)\n33: (&lt;tf.Tensor 'tower_1/gradients/tower_1/fc1_1/MatMul_grad/tuple/control_dependency_1:0' shape=(4096, 1024) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0be96e10&gt;)\n34: (&lt;tf.Tensor 'tower_1/gradients/tower_1/fc1_1/add_grad/tuple/control_dependency_1:0' shape=(1024,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0be96990&gt;)\n35: (&lt;tf.Tensor 'tower_1/gradients/tower_1/softmax_linear/MatMul_grad/tuple/control_dependency_1:0' shape=(1024, 360) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0be52c90&gt;)\n36: (&lt;tf.Tensor 'tower_1/gradients/tower_1/softmax_linear/softmax_linear_grad/tuple/control_dependency_1:0' shape=(360,) dtype=float32&gt;, &lt;tensorflow.python.ops.variables.Variable object at 0x7fca0bf56f50&gt;)\n</code></pre>\n<p>I am wondering how to remove from the second the first None, but no targeting indexes so i can make for more towers.</p>", "body_text": "I am trying to implement a network multiple gpu on tensorflow using ADAM Optimization.\nI am coping the code from the Cifar10_multigpu, but it looks that when the gradient calls the second tower it calls the gradient of the first and generated error on the average of the two towers. the code of the two tower is this\n for d in devs:\n        with tf.device(d):\n            with tf.name_scope('%s_%d' % (tf_model.TOWER_NAME, i)) as scope:\n                loss = tower_loss(scope)\n                tf.get_variable_scope().reuse_variables()\n                summaries = tf.get_collection(tf.GraphKeys.SUMMARIES, scope)\n                grads = opt.compute_gradients(loss)\n                print('\\n'.join('{}: {}'.format(*k) for k in enumerate(grads)))\n                tower_grads.append(grads)\n        i +=1\n\nand this generates each tower:\nstream, target= placeholder_inputs(FLAGS.batch_size*tf_model.ANGLES/FLAGS.num_gpus)\n    logits = tf_model.inference_noisy_simulate(stream)\n    _ = tf_model.loss(logits, target)\n    losses = tf.get_collection('losses', scope)\n    total_loss = tf.add_n(losses, name='total_loss')\n\nlooking at the gradients the first tower generate this:\n0: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca11d0ae10>)\n1: (<tf.Tensor 'tower_0/gradients/tower_0/conv1/Conv2D_grad/tuple/control_dependency_1:0' shape=(1, 1, 8, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351b10>)\n2: (<tf.Tensor 'tower_0/gradients/tower_0/conv1/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c380dd0>)\n3: (<tf.Tensor 'tower_0/gradients/tower_0/conv2/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351a10>)\n4: (<tf.Tensor 'tower_0/gradients/tower_0/conv2/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6dd0>)\n5: (<tf.Tensor 'tower_0/gradients/tower_0/conv3/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 32) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6490>)\n6: (<tf.Tensor 'tower_0/gradients/tower_0/conv3/BiasAdd_grad/tuple/control_dependency_1:0' shape=(32,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351990>)\n7: (<tf.Tensor 'tower_0/gradients/tower_0/conv4/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 32, 64) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351890>)\n8: (<tf.Tensor 'tower_0/gradients/tower_0/conv4/BiasAdd_grad/tuple/control_dependency_1:0' shape=(64,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3b7790>)\n9: (<tf.Tensor 'tower_0/gradients/tower_0/conv5/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 64, 128) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2d9110>)\n10: (<tf.Tensor 'tower_0/gradients/tower_0/conv5/BiasAdd_grad/tuple/control_dependency_1:0' shape=(128,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2849d0>)\n11: (<tf.Tensor 'tower_0/gradients/tower_0/conv6/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 128, 256) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2e6f10>)\n12: (<tf.Tensor 'tower_0/gradients/tower_0/conv6/BiasAdd_grad/tuple/control_dependency_1:0' shape=(256,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2afed0>)\n13: (<tf.Tensor 'tower_0/gradients/tower_0/fc1/MatMul_grad/tuple/control_dependency_1:0' shape=(18944, 4096) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1f9550>)\n14: (<tf.Tensor 'tower_0/gradients/tower_0/fc1/add_grad/tuple/control_dependency_1:0' shape=(4096,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c214a10>)\n15: (<tf.Tensor 'tower_0/gradients/tower_0/fc1_1/MatMul_grad/tuple/control_dependency_1:0' shape=(4096, 1024) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c23dfd0>)\n16: (<tf.Tensor 'tower_0/gradients/tower_0/fc1_1/add_grad/tuple/control_dependency_1:0' shape=(1024,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c269bd0>)\n17: (<tf.Tensor 'tower_0/gradients/tower_0/softmax_linear/MatMul_grad/tuple/control_dependency_1:0' shape=(1024, 360) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1d1a50>)\n18: (<tf.Tensor 'tower_0/gradients/tower_0/softmax_linear/softmax_linear_grad/tuple/control_dependency_1:0' shape=(360,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1def50>)\n\nand the second generates this;\n0: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca11d0ae10>)\n1: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351b10>)\n2: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c380dd0>)\n3: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351a10>)\n4: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6dd0>)\n5: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6490>)\n6: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351990>)\n7: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351890>)\n8: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3b7790>)\n9: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2d9110>)\n10: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2849d0>)\n11: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2e6f10>)\n12: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2afed0>)\n13: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1f9550>)\n14: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c214a10>)\n15: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c23dfd0>)\n16: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c269bd0>)\n17: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1d1a50>)\n18: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1def50>)\n19: (<tf.Tensor 'tower_1/gradients/tower_1/conv1/Conv2D_grad/tuple/control_dependency_1:0' shape=(1, 1, 8, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c178c50>)\n20: (<tf.Tensor 'tower_1/gradients/tower_1/conv1/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bfbb490>)\n21: (<tf.Tensor 'tower_1/gradients/tower_1/conv2/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bfda950>)\n22: (<tf.Tensor 'tower_1/gradients/tower_1/conv2/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf91bd0>)\n23: (<tf.Tensor 'tower_1/gradients/tower_1/conv3/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 32) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bfcb590>)\n24: (<tf.Tensor 'tower_1/gradients/tower_1/conv3/BiasAdd_grad/tuple/control_dependency_1:0' shape=(32,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf39e90>)\n25: (<tf.Tensor 'tower_1/gradients/tower_1/conv4/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 32, 64) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf499d0>)\n26: (<tf.Tensor 'tower_1/gradients/tower_1/conv4/BiasAdd_grad/tuple/control_dependency_1:0' shape=(64,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf14fd0>)\n27: (<tf.Tensor 'tower_1/gradients/tower_1/conv5/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 64, 128) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf39150>)\n28: (<tf.Tensor 'tower_1/gradients/tower_1/conv5/BiasAdd_grad/tuple/control_dependency_1:0' shape=(128,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bebd8d0>)\n29: (<tf.Tensor 'tower_1/gradients/tower_1/conv6/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 128, 256) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf23110>)\n30: (<tf.Tensor 'tower_1/gradients/tower_1/conv6/BiasAdd_grad/tuple/control_dependency_1:0' shape=(256,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf04610>)\n31: (<tf.Tensor 'tower_1/gradients/tower_1/fc1/MatMul_grad/tuple/control_dependency_1:0' shape=(18944, 4096) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bebdc50>)\n32: (<tf.Tensor 'tower_1/gradients/tower_1/fc1/add_grad/tuple/control_dependency_1:0' shape=(4096,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bebd310>)\n33: (<tf.Tensor 'tower_1/gradients/tower_1/fc1_1/MatMul_grad/tuple/control_dependency_1:0' shape=(4096, 1024) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0be96e10>)\n34: (<tf.Tensor 'tower_1/gradients/tower_1/fc1_1/add_grad/tuple/control_dependency_1:0' shape=(1024,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0be96990>)\n35: (<tf.Tensor 'tower_1/gradients/tower_1/softmax_linear/MatMul_grad/tuple/control_dependency_1:0' shape=(1024, 360) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0be52c90>)\n36: (<tf.Tensor 'tower_1/gradients/tower_1/softmax_linear/softmax_linear_grad/tuple/control_dependency_1:0' shape=(360,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf56f50>)\n\nI am wondering how to remove from the second the first None, but no targeting indexes so i can make for more towers.", "body": "I am trying to implement a network multiple gpu on tensorflow using ADAM Optimization.\n\nI am coping the code from the Cifar10_multigpu, but it looks that when the gradient calls the second tower it calls the gradient of the first and generated error on the average of the two towers. the code of the two tower is this\n\n```\n for d in devs:\n        with tf.device(d):\n            with tf.name_scope('%s_%d' % (tf_model.TOWER_NAME, i)) as scope:\n                loss = tower_loss(scope)\n                tf.get_variable_scope().reuse_variables()\n                summaries = tf.get_collection(tf.GraphKeys.SUMMARIES, scope)\n                grads = opt.compute_gradients(loss)\n                print('\\n'.join('{}: {}'.format(*k) for k in enumerate(grads)))\n                tower_grads.append(grads)\n        i +=1\n```\n\nand this generates each tower:\n\n```\nstream, target= placeholder_inputs(FLAGS.batch_size*tf_model.ANGLES/FLAGS.num_gpus)\n    logits = tf_model.inference_noisy_simulate(stream)\n    _ = tf_model.loss(logits, target)\n    losses = tf.get_collection('losses', scope)\n    total_loss = tf.add_n(losses, name='total_loss')\n```\n\nlooking at the gradients the first tower generate this:\n\n```\n0: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca11d0ae10>)\n1: (<tf.Tensor 'tower_0/gradients/tower_0/conv1/Conv2D_grad/tuple/control_dependency_1:0' shape=(1, 1, 8, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351b10>)\n2: (<tf.Tensor 'tower_0/gradients/tower_0/conv1/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c380dd0>)\n3: (<tf.Tensor 'tower_0/gradients/tower_0/conv2/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351a10>)\n4: (<tf.Tensor 'tower_0/gradients/tower_0/conv2/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6dd0>)\n5: (<tf.Tensor 'tower_0/gradients/tower_0/conv3/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 32) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6490>)\n6: (<tf.Tensor 'tower_0/gradients/tower_0/conv3/BiasAdd_grad/tuple/control_dependency_1:0' shape=(32,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351990>)\n7: (<tf.Tensor 'tower_0/gradients/tower_0/conv4/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 32, 64) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351890>)\n8: (<tf.Tensor 'tower_0/gradients/tower_0/conv4/BiasAdd_grad/tuple/control_dependency_1:0' shape=(64,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3b7790>)\n9: (<tf.Tensor 'tower_0/gradients/tower_0/conv5/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 64, 128) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2d9110>)\n10: (<tf.Tensor 'tower_0/gradients/tower_0/conv5/BiasAdd_grad/tuple/control_dependency_1:0' shape=(128,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2849d0>)\n11: (<tf.Tensor 'tower_0/gradients/tower_0/conv6/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 128, 256) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2e6f10>)\n12: (<tf.Tensor 'tower_0/gradients/tower_0/conv6/BiasAdd_grad/tuple/control_dependency_1:0' shape=(256,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2afed0>)\n13: (<tf.Tensor 'tower_0/gradients/tower_0/fc1/MatMul_grad/tuple/control_dependency_1:0' shape=(18944, 4096) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1f9550>)\n14: (<tf.Tensor 'tower_0/gradients/tower_0/fc1/add_grad/tuple/control_dependency_1:0' shape=(4096,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c214a10>)\n15: (<tf.Tensor 'tower_0/gradients/tower_0/fc1_1/MatMul_grad/tuple/control_dependency_1:0' shape=(4096, 1024) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c23dfd0>)\n16: (<tf.Tensor 'tower_0/gradients/tower_0/fc1_1/add_grad/tuple/control_dependency_1:0' shape=(1024,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c269bd0>)\n17: (<tf.Tensor 'tower_0/gradients/tower_0/softmax_linear/MatMul_grad/tuple/control_dependency_1:0' shape=(1024, 360) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1d1a50>)\n18: (<tf.Tensor 'tower_0/gradients/tower_0/softmax_linear/softmax_linear_grad/tuple/control_dependency_1:0' shape=(360,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1def50>)\n```\n\nand the second generates this;\n\n```\n0: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca11d0ae10>)\n1: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351b10>)\n2: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c380dd0>)\n3: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351a10>)\n4: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6dd0>)\n5: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3a6490>)\n6: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351990>)\n7: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c351890>)\n8: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c3b7790>)\n9: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2d9110>)\n10: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2849d0>)\n11: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2e6f10>)\n12: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c2afed0>)\n13: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1f9550>)\n14: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c214a10>)\n15: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c23dfd0>)\n16: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c269bd0>)\n17: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1d1a50>)\n18: (None, <tensorflow.python.ops.variables.Variable object at 0x7fca0c1def50>)\n19: (<tf.Tensor 'tower_1/gradients/tower_1/conv1/Conv2D_grad/tuple/control_dependency_1:0' shape=(1, 1, 8, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0c178c50>)\n20: (<tf.Tensor 'tower_1/gradients/tower_1/conv1/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bfbb490>)\n21: (<tf.Tensor 'tower_1/gradients/tower_1/conv2/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 16) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bfda950>)\n22: (<tf.Tensor 'tower_1/gradients/tower_1/conv2/BiasAdd_grad/tuple/control_dependency_1:0' shape=(16,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf91bd0>)\n23: (<tf.Tensor 'tower_1/gradients/tower_1/conv3/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 16, 32) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bfcb590>)\n24: (<tf.Tensor 'tower_1/gradients/tower_1/conv3/BiasAdd_grad/tuple/control_dependency_1:0' shape=(32,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf39e90>)\n25: (<tf.Tensor 'tower_1/gradients/tower_1/conv4/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 32, 64) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf499d0>)\n26: (<tf.Tensor 'tower_1/gradients/tower_1/conv4/BiasAdd_grad/tuple/control_dependency_1:0' shape=(64,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf14fd0>)\n27: (<tf.Tensor 'tower_1/gradients/tower_1/conv5/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 64, 128) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf39150>)\n28: (<tf.Tensor 'tower_1/gradients/tower_1/conv5/BiasAdd_grad/tuple/control_dependency_1:0' shape=(128,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bebd8d0>)\n29: (<tf.Tensor 'tower_1/gradients/tower_1/conv6/Conv2D_grad/tuple/control_dependency_1:0' shape=(45, 4, 128, 256) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf23110>)\n30: (<tf.Tensor 'tower_1/gradients/tower_1/conv6/BiasAdd_grad/tuple/control_dependency_1:0' shape=(256,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf04610>)\n31: (<tf.Tensor 'tower_1/gradients/tower_1/fc1/MatMul_grad/tuple/control_dependency_1:0' shape=(18944, 4096) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bebdc50>)\n32: (<tf.Tensor 'tower_1/gradients/tower_1/fc1/add_grad/tuple/control_dependency_1:0' shape=(4096,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bebd310>)\n33: (<tf.Tensor 'tower_1/gradients/tower_1/fc1_1/MatMul_grad/tuple/control_dependency_1:0' shape=(4096, 1024) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0be96e10>)\n34: (<tf.Tensor 'tower_1/gradients/tower_1/fc1_1/add_grad/tuple/control_dependency_1:0' shape=(1024,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0be96990>)\n35: (<tf.Tensor 'tower_1/gradients/tower_1/softmax_linear/MatMul_grad/tuple/control_dependency_1:0' shape=(1024, 360) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0be52c90>)\n36: (<tf.Tensor 'tower_1/gradients/tower_1/softmax_linear/softmax_linear_grad/tuple/control_dependency_1:0' shape=(360,) dtype=float32>, <tensorflow.python.ops.variables.Variable object at 0x7fca0bf56f50>)\n```\n\nI am wondering how to remove from the second the first None, but no targeting indexes so i can make for more towers.\n"}