{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/208623042", "pull_request_review_id": 144470525, "id": 208623042, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwODYyMzA0Mg==", "diff_hunk": "@@ -975,25 +975,31 @@ def _TopKGrad(op, grad, _):\n   in_shape = array_ops.shape(op.inputs[0])\n   ind_shape = array_ops.shape(op.outputs[1])\n \n-  ind_lastdim = array_ops.gather(ind_shape, array_ops.size(ind_shape) - 1)\n+  # int32 is not supported on GPU hence up-casting\n+  ind_lastdim = array_ops.gather(math_ops.cast(\n+      ind_shape, dtypes.int64), array_ops.size(ind_shape) - 1)\n   # Flatten indices to 2D.\n   ind_2d = array_ops.reshape(op.outputs[1], array_ops.stack([-1, ind_lastdim]))\n \n-  in_lastdim = array_ops.gather(in_shape, array_ops.size(in_shape) - 1)\n+  in_lastdim = array_ops.gather(math_ops.cast(\n+      in_shape, dtypes.int64), array_ops.size(in_shape) - 1)\n   outerdim = array_ops.shape(ind_2d)[0]\n   # Compute linear indices (flattened to 1D).\n-  ind = array_ops.reshape(ind_2d + array_ops.expand_dims(\n-      math_ops.range(0, outerdim * in_lastdim, in_lastdim), -1), [-1])\n+  ind = array_ops.reshape(ind_2d + math_ops.cast(array_ops.expand_dims(\n+      math_ops.range(0, math_ops.cast(outerdim, dtypes.int64)\n+                     * in_lastdim, in_lastdim), -1\n+  ), dtypes.int32), [-1])\n \n   # Substitute grad to appropriate locations and fill the rest with zeros,\n   # finally reshaping it to the original input shape.\n   return [\n       array_ops.reshape(\n-          sparse_ops.sparse_to_dense(\n-              ind,\n-              array_ops.reshape(math_ops.reduce_prod(in_shape), [1]),\n+          array_ops.scatter_nd(\n+              array_ops.expand_dims(ind, -1),\n               array_ops.reshape(grad, [-1]),\n-              validate_indices=False), in_shape),\n+              array_ops.reshape(math_ops.reduce_prod(in_shape), [1])", "path": "tensorflow/python/ops/nn_grad.py", "position": null, "original_position": 34, "commit_id": "b07f8211409f2b2e46ab539291e824f2b7865885", "original_commit_id": "061fce13f44f654fa45ea7efaef3e5d4a545c8c4", "user": {"login": "carusyte", "id": 1680881, "node_id": "MDQ6VXNlcjE2ODA4ODE=", "avatar_url": "https://avatars2.githubusercontent.com/u/1680881?v=4", "gravatar_id": "", "url": "https://api.github.com/users/carusyte", "html_url": "https://github.com/carusyte", "followers_url": "https://api.github.com/users/carusyte/followers", "following_url": "https://api.github.com/users/carusyte/following{/other_user}", "gists_url": "https://api.github.com/users/carusyte/gists{/gist_id}", "starred_url": "https://api.github.com/users/carusyte/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/carusyte/subscriptions", "organizations_url": "https://api.github.com/users/carusyte/orgs", "repos_url": "https://api.github.com/users/carusyte/repos", "events_url": "https://api.github.com/users/carusyte/events{/privacy}", "received_events_url": "https://api.github.com/users/carusyte/received_events", "type": "User", "site_admin": false}, "body": "Sure! Didn't realize I could \"shape\" a rank 1 tensor in such a neat way!", "created_at": "2018-08-08T15:17:57Z", "updated_at": "2018-08-25T06:26:35Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/21436#discussion_r208623042", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/21436", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/208623042"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/21436#discussion_r208623042"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/21436"}}, "body_html": "<p>Sure! Didn't realize I could \"shape\" a rank 1 tensor in such a neat way!</p>", "body_text": "Sure! Didn't realize I could \"shape\" a rank 1 tensor in such a neat way!", "in_reply_to_id": 208606859}