{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/340066330", "html_url": "https://github.com/tensorflow/tensorflow/issues/2169#issuecomment-340066330", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/2169", "id": 340066330, "node_id": "MDEyOklzc3VlQ29tbWVudDM0MDA2NjMzMA==", "user": {"login": "tspthomas", "id": 4240244, "node_id": "MDQ6VXNlcjQyNDAyNDQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/4240244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tspthomas", "html_url": "https://github.com/tspthomas", "followers_url": "https://api.github.com/users/tspthomas/followers", "following_url": "https://api.github.com/users/tspthomas/following{/other_user}", "gists_url": "https://api.github.com/users/tspthomas/gists{/gist_id}", "starred_url": "https://api.github.com/users/tspthomas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tspthomas/subscriptions", "organizations_url": "https://api.github.com/users/tspthomas/orgs", "repos_url": "https://api.github.com/users/tspthomas/repos", "events_url": "https://api.github.com/users/tspthomas/events{/privacy}", "received_events_url": "https://api.github.com/users/tspthomas/received_events", "type": "User", "site_admin": false}, "created_at": "2017-10-27T19:38:13Z", "updated_at": "2017-10-27T19:38:13Z", "author_association": "NONE", "body_html": "<p>Hello <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=13853798\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/Pepslee\">@Pepslee</a>, thanks for sharing the code.</p>\n<p>I was doing some benchmarks with previous code and it was working fine, but now I'm facing out of memory issues in <code>tf.one_hot</code> function. It is trying to allocate a tensor of shape <code>[153600,614400]</code>. The <code>pooled_shape</code> is <code>[None, 60, 40, 64]</code>, so <code>60x40x64 = 153600</code> and <code>60x40x64x2x2 = 614400</code> (<code>2x2</code> comes from the <code>ksize</code>). Correct me if I'm wrong, but a tensor of this size couldn't fit in memory.</p>\n<p>The weird part for me is that a version based on <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=10159876\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/rayanelleuch\">@rayanelleuch</a>'s code doesn't give me any issues. If we compute the size of this Tensor it would be something like <code>(153600x614400x4)/1024/1024/1024</code>, resulting in around <code>351.56GB</code>. Another important detail is that I'm using Keras (not sure whether it changes something regarding this part).</p>\n<p>Is there anything I'm missing here? Please correct if I'm wrong.</p>\n<p>Here is part of the log:</p>\n<pre><code>2017-10-27 18:28:47.630711: W tensorflow/core/framework/op_kernel.cc:1192] Resource exhausted: OOM when allocating tensor with shape[153600,614400]\n2017-10-27 18:28:47.631246: E tensorflow/tools/benchmark/benchmark_model.cc:256] Error during inference: Resource exhausted: OOM when allocating tensor with shape[153600,614400]\n         [[Node: max_unpool2d_new_1/max_unpool2d_new_1/one_hot = OneHot[T=DT_FLOAT, TI=DT_INT32, axis=-1, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](max_unpool2d_new_1/max_unpool2d_new_1/Reshape/_9, max_unpool2d_new_1/max_unpool2d_new_1/mul_3, max_unpool2d_new_1/max_unpool2d_new_1/one_hot/on_value, max_unpool2d_new_1/max_unpool2d_new_1/one_hot/off_value)]]\n         [[Node: logits/BiasAdd/_19 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3407_logits/BiasAdd\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n2017-10-27 18:28:47.631445: I tensorflow/tools/benchmark/benchmark_model.cc:291] Failed on run 0\n2017-10-27 18:28:47.631572: E tensorflow/tools/benchmark/benchmark_model.cc:474] Timing failed with Resource exhausted: OOM when allocating tensor with shape[153600,614400]\n</code></pre>", "body_text": "Hello @Pepslee, thanks for sharing the code.\nI was doing some benchmarks with previous code and it was working fine, but now I'm facing out of memory issues in tf.one_hot function. It is trying to allocate a tensor of shape [153600,614400]. The pooled_shape is [None, 60, 40, 64], so 60x40x64 = 153600 and 60x40x64x2x2 = 614400 (2x2 comes from the ksize). Correct me if I'm wrong, but a tensor of this size couldn't fit in memory.\nThe weird part for me is that a version based on @rayanelleuch's code doesn't give me any issues. If we compute the size of this Tensor it would be something like (153600x614400x4)/1024/1024/1024, resulting in around 351.56GB. Another important detail is that I'm using Keras (not sure whether it changes something regarding this part).\nIs there anything I'm missing here? Please correct if I'm wrong.\nHere is part of the log:\n2017-10-27 18:28:47.630711: W tensorflow/core/framework/op_kernel.cc:1192] Resource exhausted: OOM when allocating tensor with shape[153600,614400]\n2017-10-27 18:28:47.631246: E tensorflow/tools/benchmark/benchmark_model.cc:256] Error during inference: Resource exhausted: OOM when allocating tensor with shape[153600,614400]\n         [[Node: max_unpool2d_new_1/max_unpool2d_new_1/one_hot = OneHot[T=DT_FLOAT, TI=DT_INT32, axis=-1, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](max_unpool2d_new_1/max_unpool2d_new_1/Reshape/_9, max_unpool2d_new_1/max_unpool2d_new_1/mul_3, max_unpool2d_new_1/max_unpool2d_new_1/one_hot/on_value, max_unpool2d_new_1/max_unpool2d_new_1/one_hot/off_value)]]\n         [[Node: logits/BiasAdd/_19 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3407_logits/BiasAdd\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n2017-10-27 18:28:47.631445: I tensorflow/tools/benchmark/benchmark_model.cc:291] Failed on run 0\n2017-10-27 18:28:47.631572: E tensorflow/tools/benchmark/benchmark_model.cc:474] Timing failed with Resource exhausted: OOM when allocating tensor with shape[153600,614400]", "body": "Hello @Pepslee, thanks for sharing the code.\r\n\r\nI was doing some benchmarks with previous code and it was working fine, but now I'm facing out of memory issues in `tf.one_hot` function. It is trying to allocate a tensor of shape `[153600,614400]`. The `pooled_shape` is `[None, 60, 40, 64]`, so `60x40x64 = 153600` and `60x40x64x2x2 = 614400` (`2x2` comes from the `ksize`). Correct me if I'm wrong, but a tensor of this size couldn't fit in memory. \r\n\r\nThe weird part for me is that a version based on @rayanelleuch's code doesn't give me any issues. If we compute the size of this Tensor it would be something like `(153600x614400x4)/1024/1024/1024`, resulting in around `351.56GB`. Another important detail is that I'm using Keras (not sure whether it changes something regarding this part).\r\n\r\nIs there anything I'm missing here? Please correct if I'm wrong.\r\n\r\nHere is part of the log:\r\n```\r\n2017-10-27 18:28:47.630711: W tensorflow/core/framework/op_kernel.cc:1192] Resource exhausted: OOM when allocating tensor with shape[153600,614400]\r\n2017-10-27 18:28:47.631246: E tensorflow/tools/benchmark/benchmark_model.cc:256] Error during inference: Resource exhausted: OOM when allocating tensor with shape[153600,614400]\r\n         [[Node: max_unpool2d_new_1/max_unpool2d_new_1/one_hot = OneHot[T=DT_FLOAT, TI=DT_INT32, axis=-1, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](max_unpool2d_new_1/max_unpool2d_new_1/Reshape/_9, max_unpool2d_new_1/max_unpool2d_new_1/mul_3, max_unpool2d_new_1/max_unpool2d_new_1/one_hot/on_value, max_unpool2d_new_1/max_unpool2d_new_1/one_hot/off_value)]]\r\n         [[Node: logits/BiasAdd/_19 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_3407_logits/BiasAdd\", tensor_type=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\r\n2017-10-27 18:28:47.631445: I tensorflow/tools/benchmark/benchmark_model.cc:291] Failed on run 0\r\n2017-10-27 18:28:47.631572: E tensorflow/tools/benchmark/benchmark_model.cc:474] Timing failed with Resource exhausted: OOM when allocating tensor with shape[153600,614400]\r\n```\r\n\r\n"}