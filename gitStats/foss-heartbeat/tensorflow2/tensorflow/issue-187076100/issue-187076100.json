{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5379", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5379/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5379/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/5379/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/5379", "id": 187076100, "node_id": "MDU6SXNzdWUxODcwNzYxMDA=", "number": 5379, "title": "C++ SetDefaultDevice does not appear to work properly", "user": {"login": "beniz", "id": 3530657, "node_id": "MDQ6VXNlcjM1MzA2NTc=", "avatar_url": "https://avatars2.githubusercontent.com/u/3530657?v=4", "gravatar_id": "", "url": "https://api.github.com/users/beniz", "html_url": "https://github.com/beniz", "followers_url": "https://api.github.com/users/beniz/followers", "following_url": "https://api.github.com/users/beniz/following{/other_user}", "gists_url": "https://api.github.com/users/beniz/gists{/gist_id}", "starred_url": "https://api.github.com/users/beniz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/beniz/subscriptions", "organizations_url": "https://api.github.com/users/beniz/orgs", "repos_url": "https://api.github.com/users/beniz/repos", "events_url": "https://api.github.com/users/beniz/events{/privacy}", "received_events_url": "https://api.github.com/users/beniz/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2016-11-03T14:32:11Z", "updated_at": "2018-07-18T08:35:44Z", "closed_at": "2017-06-16T18:02:08Z", "author_association": "NONE", "body_html": "<p>I'm using a simple C++ session that works fine otherwise. Trying to use <code>tensorflow::graph::SetDefaultDevice</code> to pin on either CPU or GPU (per id) does not appear to work:</p>\n<ul>\n<li>without <code>SetDefaultDevice</code>:</li>\n</ul>\n<pre><code>I tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 1:   Y Y   \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: Tesla K40c, pci bus i\nd: 0000:02:00.0)  \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:1) -&gt; (device: 1, name: Tesla K40c, pci bus i\nd: 0000:03:00.0) \n</code></pre>\n<p>all goes well beyond this point.</p>\n<ul>\n<li>now trying to pin on <code>GPU0</code>:</li>\n</ul>\n<pre><code>tensorflow::graph::SetDefaultDevice(\"/gpu:0\", &amp;graph_def);\n</code></pre>\n<p>yields</p>\n<pre><code>E tensorflow/core/common_runtime/direct_session.cc:132] Invalid argument: Could not parse entry in 'visible_device_list': '/gpu:0'.  visible_device_list = /gpu:0\n</code></pre>\n<p>Same with <code>/cpu:0</code>, no surprise.</p>\n<ul>\n<li>looking at <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/tensorflow/tensorflow/blob/f7ec99516ce0e0937e0b865e90aa02c748cd36c6/tensorflow/core/common_runtime/gpu/gpu_device.cc#L808\">tensorflow/tensorflow/core/common_runtime/gpu/gpu_device.cc</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 808\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/tensorflow/tensorflow/commit/f7ec99516ce0e0937e0b865e90aa02c748cd36c6\">f7ec995</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L808\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"808\"></td>\n          <td id=\"LC808\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (!<span class=\"pl-c1\">strings::safe_strto32</span>(gpu_id_str, &amp;gpu_id)) { </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n it seems the code is rather looking for an int ? Trying it out:</li>\n</ul>\n<pre><code>tensorflow::graph::SetDefaultDevice(\"0\",&amp;graph_def);\n</code></pre>\n<p>yields</p>\n<pre><code>I tensorflow/core/common_runtime/gpu/gpu_device.cc:972] DMA: 0 \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 0:   Y \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: Tesla K40c, pci bus id: 0000:02:00.0)\nE tensorflow/core/common_runtime/gpu/process_state.cc:108] Invalid allocator type: 0\n</code></pre>\n<p>Am I doing something wrong or has something changed (maybe due to <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/3e8c4fd7403659ec32b9fec90a78831043aa0786/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/3e8c4fd7403659ec32b9fec90a78831043aa0786\"><tt>3e8c4fd</tt></a> ?)</p>\n<p>The tutorial at <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/cc/tutorials/example_trainer.cc#L104\">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/cc/tutorials/example_trainer.cc#L104</a> still calls on <code>SetDefaultDevice</code> the way I tried to use it, this seems odd :)</p>", "body_text": "I'm using a simple C++ session that works fine otherwise. Trying to use tensorflow::graph::SetDefaultDevice to pin on either CPU or GPU (per id) does not appear to work:\n\nwithout SetDefaultDevice:\n\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 1:   Y Y   \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -> (device: 0, name: Tesla K40c, pci bus i\nd: 0000:02:00.0)  \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:1) -> (device: 1, name: Tesla K40c, pci bus i\nd: 0000:03:00.0) \n\nall goes well beyond this point.\n\nnow trying to pin on GPU0:\n\ntensorflow::graph::SetDefaultDevice(\"/gpu:0\", &graph_def);\n\nyields\nE tensorflow/core/common_runtime/direct_session.cc:132] Invalid argument: Could not parse entry in 'visible_device_list': '/gpu:0'.  visible_device_list = /gpu:0\n\nSame with /cpu:0, no surprise.\n\nlooking at \n  \n    \n      tensorflow/tensorflow/core/common_runtime/gpu/gpu_device.cc\n    \n    \n         Line 808\n      in\n      f7ec995\n    \n    \n    \n    \n\n        \n          \n           if (!strings::safe_strto32(gpu_id_str, &gpu_id)) { \n        \n    \n  \n\n it seems the code is rather looking for an int ? Trying it out:\n\ntensorflow::graph::SetDefaultDevice(\"0\",&graph_def);\n\nyields\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:972] DMA: 0 \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 0:   Y \nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -> (device: 0, name: Tesla K40c, pci bus id: 0000:02:00.0)\nE tensorflow/core/common_runtime/gpu/process_state.cc:108] Invalid allocator type: 0\n\nAm I doing something wrong or has something changed (maybe due to 3e8c4fd ?)\nThe tutorial at https://github.com/tensorflow/tensorflow/blob/master/tensorflow/cc/tutorials/example_trainer.cc#L104 still calls on SetDefaultDevice the way I tried to use it, this seems odd :)", "body": "I'm using a simple C++ session that works fine otherwise. Trying to use `tensorflow::graph::SetDefaultDevice` to pin on either CPU or GPU (per id) does not appear to work:\r\n\r\n- without `SetDefaultDevice`:\r\n\r\n```\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 1:   Y Y   \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -> (device: 0, name: Tesla K40c, pci bus i\r\nd: 0000:02:00.0)  \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:1) -> (device: 1, name: Tesla K40c, pci bus i\r\nd: 0000:03:00.0) \r\n```\r\nall goes well beyond this point.\r\n\r\n- now trying to pin on `GPU0`:\r\n```\r\ntensorflow::graph::SetDefaultDevice(\"/gpu:0\", &graph_def);\r\n```\r\nyields\r\n```\r\nE tensorflow/core/common_runtime/direct_session.cc:132] Invalid argument: Could not parse entry in 'visible_device_list': '/gpu:0'.  visible_device_list = /gpu:0\r\n```\r\nSame with `/cpu:0`, no surprise.\r\n\r\n- looking at https://github.com/tensorflow/tensorflow/blob/f7ec99516ce0e0937e0b865e90aa02c748cd36c6/tensorflow/core/common_runtime/gpu/gpu_device.cc#L808 it seems the code is rather looking for an int ? Trying it out:\r\n\r\n```\r\ntensorflow::graph::SetDefaultDevice(\"0\",&graph_def);\r\n```\r\nyields\r\n```\r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:972] DMA: 0 \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:982] 0:   Y \r\nI tensorflow/core/common_runtime/gpu/gpu_device.cc:1041] Creating TensorFlow device (/gpu:0) -> (device: 0, name: Tesla K40c, pci bus id: 0000:02:00.0)\r\nE tensorflow/core/common_runtime/gpu/process_state.cc:108] Invalid allocator type: 0\r\n```\r\n\r\nAm I doing something wrong or has something changed (maybe due to 3e8c4fd7403659ec32b9fec90a78831043aa0786 ?)\r\n\r\nThe tutorial at https://github.com/tensorflow/tensorflow/blob/master/tensorflow/cc/tutorials/example_trainer.cc#L104 still calls on `SetDefaultDevice` the way I tried to use it, this seems odd :)\r\n"}