{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16320", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16320/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16320/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16320/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/16320", "id": 290785094, "node_id": "MDU6SXNzdWUyOTA3ODUwOTQ=", "number": 16320, "title": "BUG: py_func don't support unicode string results for python2", "user": {"login": "facaiy", "id": 1112263, "node_id": "MDQ6VXNlcjExMTIyNjM=", "avatar_url": "https://avatars3.githubusercontent.com/u/1112263?v=4", "gravatar_id": "", "url": "https://api.github.com/users/facaiy", "html_url": "https://github.com/facaiy", "followers_url": "https://api.github.com/users/facaiy/followers", "following_url": "https://api.github.com/users/facaiy/following{/other_user}", "gists_url": "https://api.github.com/users/facaiy/gists{/gist_id}", "starred_url": "https://api.github.com/users/facaiy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/facaiy/subscriptions", "organizations_url": "https://api.github.com/users/facaiy/orgs", "repos_url": "https://api.github.com/users/facaiy/repos", "events_url": "https://api.github.com/users/facaiy/events{/privacy}", "received_events_url": "https://api.github.com/users/facaiy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-01-23T10:31:25Z", "updated_at": "2018-01-25T01:12:31Z", "closed_at": "2018-01-25T01:12:31Z", "author_association": "MEMBER", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Y</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Mac 10.11</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: source</li>\n<li><strong>TensorFlow version (use command below)</strong>: master</li>\n<li><strong>Python version</strong>: 2.7</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A</li>\n<li><strong>Exact command to reproduce</strong>: N/A</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When I investigated <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"269822804\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/14116\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/14116/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/14116\">#14116</a>, I found that <code>py_func</code> converts unicode strings result to bytes only for  Python3, while raise an exception for Python 2.</p>\n<p>I'm curious why we don't the same thing for Python 2.</p>\n<h3>Source code / logs</h3>\n<p>script:</p>\n<div class=\"highlight highlight-source-python\"><pre>  <span class=\"pl-k\">def</span> <span class=\"pl-en\">testReturnUnicodeString</span>(<span class=\"pl-smi\"><span class=\"pl-smi\">self</span></span>):\n    <span class=\"pl-k\">with</span> <span class=\"pl-c1\">self</span>.test_session():\n      correct <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-k\">u</span><span class=\"pl-pds\">\"</span>\u4f60\u597d \u4e16\u754c<span class=\"pl-pds\">\"</span></span>\n\n      <span class=\"pl-k\">def</span> <span class=\"pl-en\">unicode_string</span>():\n        <span class=\"pl-k\">return</span> correct\n\n      z, <span class=\"pl-k\">=</span> script_ops.py_func(unicode_string, [], [dtypes.string])\n      <span class=\"pl-c1\">self</span>.assertEqual(z.eval(), correct.encode(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>utf8<span class=\"pl-pds\">\"</span></span>))</pre></div>\n<p>logs:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c1\">exec</span> <span class=\"pl-ii\">$</span>{<span class=\"pl-c1\">PAGER</span>:<span class=\"pl-k\">-/</span>usr<span class=\"pl-k\">/</span><span class=\"pl-c1\">bin</span><span class=\"pl-k\">/</span>less} <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>$0<span class=\"pl-pds\">\"</span></span> <span class=\"pl-ii\">||</span> <span class=\"pl-c1\">exit</span> <span class=\"pl-c1\">1</span>\n<span class=\"pl-ii\">----------------------------------------------------------------------------</span><span class=\"pl-k\">-</span>\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">04.611108</span>: I tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>platform<span class=\"pl-k\">/</span>cpu_feature_guard.cc:<span class=\"pl-c1\">137</span>] Your <span class=\"pl-c1\">CPU</span> supports instructions that this TensorFlow binary was <span class=\"pl-k\">not</span> compiled to use: <span class=\"pl-c1\">SSE4</span>.1 <span class=\"pl-c1\">SSE4</span>.2 <span class=\"pl-c1\">AVX</span> <span class=\"pl-c1\">AVX2</span> <span class=\"pl-c1\">FMA</span>\n.<span class=\"pl-c1\">.2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">06.545687</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unimplemented: Unsupported numpy <span class=\"pl-c1\">type</span> <span class=\"pl-c1\">20</span>\n<span class=\"pl-c1\">.2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">06.548797</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unimplemented: Unsupported <span class=\"pl-c1\">object</span> <span class=\"pl-c1\">type</span> <span class=\"pl-c1\">dict</span>\n<span class=\"pl-c1\">...</span>.<span class=\"pl-c1\">.2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.129501</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.ValueError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.131595</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.TypeError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.134736</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Resource exhausted: exceptions.MemoryError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.136335</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unimplemented: exceptions.NotImplementedError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.138000</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unknown: WeirdError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.138882</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.ValueError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.139022</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.TypeError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.139236</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Resource exhausted: exceptions.MemoryError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.139349</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unimplemented: exceptions.NotImplementedError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">08.139492</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unknown: WeirdError: blah\n<span class=\"pl-c1\">...</span>.<span class=\"pl-c1\">.2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">10.036466</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.ValueError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">10.038219</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.TypeError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">10.041279</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Resource exhausted: exceptions.MemoryError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">10.044136</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unimplemented: exceptions.NotImplementedError: blah\n<span class=\"pl-c1\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">10.046983</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Unknown: WeirdError: blah\n<span class=\"pl-c1\">............</span><span class=\"pl-ii\">2018</span><span class=\"pl-k\">-</span><span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span><span class=\"pl-k\">-</span><span class=\"pl-c1\">23</span> <span class=\"pl-c1\">0<span class=\"pl-ii\">9</span></span>:<span class=\"pl-c1\">43</span>:<span class=\"pl-c1\">11.081837</span>: W tensorflow<span class=\"pl-k\">/</span>core<span class=\"pl-k\">/</span>framework<span class=\"pl-k\">/</span>op_kernel.cc:<span class=\"pl-c1\">1181</span>] Invalid argument: exceptions.UnicodeEncodeError: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>ascii<span class=\"pl-pds\">'</span></span> codec can<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t encode characters in position 0-1: ordinal not in range(128)<span class=\"pl-ii\"></span></span>\nE<span class=\"pl-c1\">.........</span>.\n<span class=\"pl-k\">======================================================================</span>\n<span class=\"pl-c1\">ERROR</span>: testReturnUnicodeString (__main__.PyFuncTest)\n<span class=\"pl-ii\">----------------------------------------------------------------------</span>\nTraceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">227</span>, <span class=\"pl-k\">in</span> testReturnUnicodeString\n    <span class=\"pl-c1\">self</span>.assertEqual(z.eval(), correct.encode(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>utf8<span class=\"pl-pds\">\"</span></span>))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">639</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">eval</span>\n    <span class=\"pl-k\">return</span> _eval_using_default_session(<span class=\"pl-c1\">self</span>, feed_dict, <span class=\"pl-c1\">self</span>.graph, session)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">4795</span>, <span class=\"pl-k\">in</span> _eval_using_default_session\n    <span class=\"pl-k\">return</span> session.run(tensors, feed_dict)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">895</span>, <span class=\"pl-k\">in</span> run\n    run_metadata_ptr)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1128</span>, <span class=\"pl-k\">in</span> _run\n    feed_dict_tensor, options, run_metadata)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1344</span>, <span class=\"pl-k\">in</span> _do_run\n    options, run_metadata)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1363</span>, <span class=\"pl-k\">in</span> _do_call\n    <span class=\"pl-k\">raise</span> <span class=\"pl-c1\">type</span>(e)(node_def, op, message)\nInvalidArgumentError: exceptions.UnicodeEncodeError: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>ascii<span class=\"pl-pds\">'</span></span> codec can<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t encode characters in position 0-1: ordinal not in range(128)<span class=\"pl-ii\"></span></span>\n\t [[Node: PyFunc = PyFunc[Tin=[], Tout=[<span class=\"pl-c1\">DT_STRING</span>], token=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pyfunc_2049<span class=\"pl-pds\">\"</span></span>, _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/device:CPU:0<span class=\"pl-pds\">\"</span></span>]()]]\n\nCaused by op <span class=\"pl-s\"><span class=\"pl-k\">u</span><span class=\"pl-pds\">'</span>PyFunc<span class=\"pl-pds\">'</span></span>, defined at:\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">476</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    test.main()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/test.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">74</span>, <span class=\"pl-k\">in</span> main\n    <span class=\"pl-k\">return</span> _googletest.main(argv)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">99</span>, <span class=\"pl-k\">in</span> main\n    benchmark.benchmarks_main(<span class=\"pl-v\">true_main</span><span class=\"pl-k\">=</span>main_wrapper)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/benchmark.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">336</span>, <span class=\"pl-k\">in</span> benchmarks_main\n    true_main()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">98</span>, <span class=\"pl-k\">in</span> main_wrapper\n    <span class=\"pl-k\">return</span> app.run(<span class=\"pl-v\">main</span><span class=\"pl-k\">=</span>g_main, <span class=\"pl-v\">argv</span><span class=\"pl-k\">=</span>args)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/app.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">124</span>, <span class=\"pl-k\">in</span> run\n    _sys.exit(main(argv))\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">69</span>, <span class=\"pl-k\">in</span> g_main\n    <span class=\"pl-k\">return</span> unittest_main(<span class=\"pl-v\">argv</span><span class=\"pl-k\">=</span>argv)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/main.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">95</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__init__</span>\n    <span class=\"pl-c1\">self</span>.runTests()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/main.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">232</span>, <span class=\"pl-k\">in</span> runTests\n    <span class=\"pl-c1\">self</span>.result <span class=\"pl-k\">=</span> testRunner.run(<span class=\"pl-c1\">self</span>.test)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/runner.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">151</span>, <span class=\"pl-k\">in</span> run\n    test(result)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">70</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__call__</span>\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">self</span>.run(<span class=\"pl-k\">*</span>args, <span class=\"pl-k\">**</span>kwds)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">108</span>, <span class=\"pl-k\">in</span> run\n    test(result)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">70</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__call__</span>\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">self</span>.run(<span class=\"pl-k\">*</span>args, <span class=\"pl-k\">**</span>kwds)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">108</span>, <span class=\"pl-k\">in</span> run\n    test(result)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/case.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">393</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__call__</span>\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">self</span>.run(<span class=\"pl-k\">*</span>args, <span class=\"pl-k\">**</span>kwds)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/case.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">329</span>, <span class=\"pl-k\">in</span> run\n    testMethod()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">226</span>, <span class=\"pl-k\">in</span> testReturnUnicodeString\n    z, <span class=\"pl-k\">=</span> script_ops.py_func(unicode_string, [], [dtypes.string])\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/script_ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">300</span>, <span class=\"pl-k\">in</span> py_func\n    func<span class=\"pl-k\">=</span>func, inp<span class=\"pl-k\">=</span>inp, Tout<span class=\"pl-k\">=</span>Tout, stateful<span class=\"pl-k\">=</span>stateful, eager<span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>, name<span class=\"pl-k\">=</span>name)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/script_ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">209</span>, <span class=\"pl-k\">in</span> _internal_py_func\n    <span class=\"pl-c1\">input</span><span class=\"pl-k\">=</span>inp, token<span class=\"pl-k\">=</span>token, Tout<span class=\"pl-k\">=</span>Tout, name<span class=\"pl-k\">=</span>name)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/gen_script_ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">93</span>, <span class=\"pl-k\">in</span> _py_func\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>PyFunc<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">input</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">input</span>, token<span class=\"pl-k\">=</span>token, Tout<span class=\"pl-k\">=</span>Tout, name<span class=\"pl-k\">=</span>name)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/op_def_library.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">787</span>, <span class=\"pl-k\">in</span> _apply_op_helper\n    op_def<span class=\"pl-k\">=</span>op_def)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">3172</span>, <span class=\"pl-k\">in</span> create_op\n    op_def<span class=\"pl-k\">=</span>op_def)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1617</span>, <span class=\"pl-k\">in</span> <span class=\"pl-c1\">__init__</span>\n    <span class=\"pl-c1\">self</span>._traceback <span class=\"pl-k\">=</span> <span class=\"pl-c1\">self</span>._graph._extract_stack()  <span class=\"pl-c\"><span class=\"pl-c\">#</span> pylint: disable=protected-access</span>\n\nInvalidArgumentError (see above <span class=\"pl-k\">for</span> traceback): exceptions.UnicodeEncodeError: <span class=\"pl-s\"><span class=\"pl-pds\">'</span>ascii<span class=\"pl-pds\">'</span></span> codec can<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t encode characters in position 0-1: ordinal not in range(128)<span class=\"pl-ii\"></span></span>\n\t [[Node: PyFunc = PyFunc[Tin=[], Tout=[<span class=\"pl-c1\">DT_STRING</span>], token=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pyfunc_2049<span class=\"pl-pds\">\"</span></span>, _device=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/job:localhost/replica:0/task:0/device:CPU:0<span class=\"pl-pds\">\"</span></span>]()]]\n\n\n<span class=\"pl-ii\">----------------------------------------------------------------------</span>\nRan <span class=\"pl-c1\">36</span> tests <span class=\"pl-k\">in</span> <span class=\"pl-c1\">6.</span><span class=\"pl-ii\">497s</span>\n\nFAILED (<span class=\"pl-v\">errors</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>)</pre></div>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Y\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Mac 10.11\nTensorFlow installed from (source or binary): source\nTensorFlow version (use command below): master\nPython version: 2.7\nBazel version (if compiling from source): N/A\nGCC/Compiler version (if compiling from source): N/A\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A\nExact command to reproduce: N/A\n\nDescribe the problem\nWhen I investigated #14116, I found that py_func converts unicode strings result to bytes only for  Python3, while raise an exception for Python 2.\nI'm curious why we don't the same thing for Python 2.\nSource code / logs\nscript:\n  def testReturnUnicodeString(self):\n    with self.test_session():\n      correct = u\"\u4f60\u597d \u4e16\u754c\"\n\n      def unicode_string():\n        return correct\n\n      z, = script_ops.py_func(unicode_string, [], [dtypes.string])\n      self.assertEqual(z.eval(), correct.encode(\"utf8\"))\nlogs:\nexec ${PAGER:-/usr/bin/less} \"$0\" || exit 1\n-----------------------------------------------------------------------------\n2018-01-23 09:43:04.611108: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\n..2018-01-23 09:43:06.545687: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: Unsupported numpy type 20\n.2018-01-23 09:43:06.548797: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: Unsupported object type dict\n.....2018-01-23 09:43:08.129501: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.ValueError: blah\n2018-01-23 09:43:08.131595: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.TypeError: blah\n2018-01-23 09:43:08.134736: W tensorflow/core/framework/op_kernel.cc:1181] Resource exhausted: exceptions.MemoryError: blah\n2018-01-23 09:43:08.136335: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: exceptions.NotImplementedError: blah\n2018-01-23 09:43:08.138000: W tensorflow/core/framework/op_kernel.cc:1181] Unknown: WeirdError: blah\n2018-01-23 09:43:08.138882: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.ValueError: blah\n2018-01-23 09:43:08.139022: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.TypeError: blah\n2018-01-23 09:43:08.139236: W tensorflow/core/framework/op_kernel.cc:1181] Resource exhausted: exceptions.MemoryError: blah\n2018-01-23 09:43:08.139349: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: exceptions.NotImplementedError: blah\n2018-01-23 09:43:08.139492: W tensorflow/core/framework/op_kernel.cc:1181] Unknown: WeirdError: blah\n.....2018-01-23 09:43:10.036466: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.ValueError: blah\n2018-01-23 09:43:10.038219: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.TypeError: blah\n2018-01-23 09:43:10.041279: W tensorflow/core/framework/op_kernel.cc:1181] Resource exhausted: exceptions.MemoryError: blah\n2018-01-23 09:43:10.044136: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: exceptions.NotImplementedError: blah\n2018-01-23 09:43:10.046983: W tensorflow/core/framework/op_kernel.cc:1181] Unknown: WeirdError: blah\n............2018-01-23 09:43:11.081837: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)\nE..........\n======================================================================\nERROR: testReturnUnicodeString (__main__.PyFuncTest)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py\", line 227, in testReturnUnicodeString\n    self.assertEqual(z.eval(), correct.encode(\"utf8\"))\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 639, in eval\n    return _eval_using_default_session(self, feed_dict, self.graph, session)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 4795, in _eval_using_default_session\n    return session.run(tensors, feed_dict)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 895, in run\n    run_metadata_ptr)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 1128, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 1344, in _do_run\n    options, run_metadata)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 1363, in _do_call\n    raise type(e)(node_def, op, message)\nInvalidArgumentError: exceptions.UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)\n\t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_STRING], token=\"pyfunc_2049\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n\nCaused by op u'PyFunc', defined at:\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py\", line 476, in <module>\n    test.main()\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/test.py\", line 74, in main\n    return _googletest.main(argv)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py\", line 99, in main\n    benchmark.benchmarks_main(true_main=main_wrapper)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/benchmark.py\", line 336, in benchmarks_main\n    true_main()\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py\", line 98, in main_wrapper\n    return app.run(main=g_main, argv=args)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 124, in run\n    _sys.exit(main(argv))\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py\", line 69, in g_main\n    return unittest_main(argv=argv)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/main.py\", line 95, in __init__\n    self.runTests()\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/main.py\", line 232, in runTests\n    self.result = testRunner.run(self.test)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/runner.py\", line 151, in run\n    test(result)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 70, in __call__\n    return self.run(*args, **kwds)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 108, in run\n    test(result)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 70, in __call__\n    return self.run(*args, **kwds)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 108, in run\n    test(result)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/case.py\", line 393, in __call__\n    return self.run(*args, **kwds)\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/case.py\", line 329, in run\n    testMethod()\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py\", line 226, in testReturnUnicodeString\n    z, = script_ops.py_func(unicode_string, [], [dtypes.string])\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/script_ops.py\", line 300, in py_func\n    func=func, inp=inp, Tout=Tout, stateful=stateful, eager=False, name=name)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/script_ops.py\", line 209, in _internal_py_func\n    input=inp, token=token, Tout=Tout, name=name)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/gen_script_ops.py\", line 93, in _py_func\n    \"PyFunc\", input=input, token=token, Tout=Tout, name=name)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 3172, in create_op\n    op_def=op_def)\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 1617, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): exceptions.UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)\n\t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_STRING], token=\"pyfunc_2049\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n\n\n----------------------------------------------------------------------\nRan 36 tests in 6.497s\n\nFAILED (errors=1)", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Y\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Mac 10.11\r\n- **TensorFlow installed from (source or binary)**: source\r\n- **TensorFlow version (use command below)**: master\r\n- **Python version**: 2.7\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **GCC/Compiler version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Exact command to reproduce**: N/A\r\n\r\n### Describe the problem\r\n\r\nWhen I investigated #14116, I found that `py_func` converts unicode strings result to bytes only for  Python3, while raise an exception for Python 2.\r\n\r\nI'm curious why we don't the same thing for Python 2.\r\n\r\n### Source code / logs\r\n\r\nscript:\r\n\r\n```python\r\n  def testReturnUnicodeString(self):\r\n    with self.test_session():\r\n      correct = u\"\u4f60\u597d \u4e16\u754c\"\r\n\r\n      def unicode_string():\r\n        return correct\r\n\r\n      z, = script_ops.py_func(unicode_string, [], [dtypes.string])\r\n      self.assertEqual(z.eval(), correct.encode(\"utf8\"))\r\n```\r\n\r\nlogs:\r\n\r\n```python\r\nexec ${PAGER:-/usr/bin/less} \"$0\" || exit 1\r\n-----------------------------------------------------------------------------\r\n2018-01-23 09:43:04.611108: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\r\n..2018-01-23 09:43:06.545687: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: Unsupported numpy type 20\r\n.2018-01-23 09:43:06.548797: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: Unsupported object type dict\r\n.....2018-01-23 09:43:08.129501: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.ValueError: blah\r\n2018-01-23 09:43:08.131595: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.TypeError: blah\r\n2018-01-23 09:43:08.134736: W tensorflow/core/framework/op_kernel.cc:1181] Resource exhausted: exceptions.MemoryError: blah\r\n2018-01-23 09:43:08.136335: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: exceptions.NotImplementedError: blah\r\n2018-01-23 09:43:08.138000: W tensorflow/core/framework/op_kernel.cc:1181] Unknown: WeirdError: blah\r\n2018-01-23 09:43:08.138882: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.ValueError: blah\r\n2018-01-23 09:43:08.139022: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.TypeError: blah\r\n2018-01-23 09:43:08.139236: W tensorflow/core/framework/op_kernel.cc:1181] Resource exhausted: exceptions.MemoryError: blah\r\n2018-01-23 09:43:08.139349: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: exceptions.NotImplementedError: blah\r\n2018-01-23 09:43:08.139492: W tensorflow/core/framework/op_kernel.cc:1181] Unknown: WeirdError: blah\r\n.....2018-01-23 09:43:10.036466: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.ValueError: blah\r\n2018-01-23 09:43:10.038219: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.TypeError: blah\r\n2018-01-23 09:43:10.041279: W tensorflow/core/framework/op_kernel.cc:1181] Resource exhausted: exceptions.MemoryError: blah\r\n2018-01-23 09:43:10.044136: W tensorflow/core/framework/op_kernel.cc:1181] Unimplemented: exceptions.NotImplementedError: blah\r\n2018-01-23 09:43:10.046983: W tensorflow/core/framework/op_kernel.cc:1181] Unknown: WeirdError: blah\r\n............2018-01-23 09:43:11.081837: W tensorflow/core/framework/op_kernel.cc:1181] Invalid argument: exceptions.UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)\r\nE..........\r\n======================================================================\r\nERROR: testReturnUnicodeString (__main__.PyFuncTest)\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py\", line 227, in testReturnUnicodeString\r\n    self.assertEqual(z.eval(), correct.encode(\"utf8\"))\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 639, in eval\r\n    return _eval_using_default_session(self, feed_dict, self.graph, session)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 4795, in _eval_using_default_session\r\n    return session.run(tensors, feed_dict)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 895, in run\r\n    run_metadata_ptr)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 1128, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 1344, in _do_run\r\n    options, run_metadata)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/client/session.py\", line 1363, in _do_call\r\n    raise type(e)(node_def, op, message)\r\nInvalidArgumentError: exceptions.UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)\r\n\t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_STRING], token=\"pyfunc_2049\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\r\n\r\nCaused by op u'PyFunc', defined at:\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py\", line 476, in <module>\r\n    test.main()\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/test.py\", line 74, in main\r\n    return _googletest.main(argv)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py\", line 99, in main\r\n    benchmark.benchmarks_main(true_main=main_wrapper)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/benchmark.py\", line 336, in benchmarks_main\r\n    true_main()\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py\", line 98, in main_wrapper\r\n    return app.run(main=g_main, argv=args)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/app.py\", line 124, in run\r\n    _sys.exit(main(argv))\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/platform/googletest.py\", line 69, in g_main\r\n    return unittest_main(argv=argv)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/main.py\", line 95, in __init__\r\n    self.runTests()\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/main.py\", line 232, in runTests\r\n    self.result = testRunner.run(self.test)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/runner.py\", line 151, in run\r\n    test(result)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 70, in __call__\r\n    return self.run(*args, **kwds)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 108, in run\r\n    test(result)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 70, in __call__\r\n    return self.run(*args, **kwds)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/suite.py\", line 108, in run\r\n    test(result)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/case.py\", line 393, in __call__\r\n    return self.run(*args, **kwds)\r\n  File \"/usr/home/facai/workshop/anaconda2/lib/python2.7/unittest/case.py\", line 329, in run\r\n    testMethod()\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/kernel_tests/py_func_test.py\", line 226, in testReturnUnicodeString\r\n    z, = script_ops.py_func(unicode_string, [], [dtypes.string])\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/script_ops.py\", line 300, in py_func\r\n    func=func, inp=inp, Tout=Tout, stateful=stateful, eager=False, name=name)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/script_ops.py\", line 209, in _internal_py_func\r\n    input=inp, token=token, Tout=Tout, name=name)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/ops/gen_script_ops.py\", line 93, in _py_func\r\n    \"PyFunc\", input=input, token=token, Tout=Tout, name=name)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 3172, in create_op\r\n    op_def=op_def)\r\n  File \"/data1/users/facai/.cache/bazel/_bazel_facai/3338df3cdc4fd0e5fdd3f3ae6490e0be/execroot/org_tensorflow/bazel-out/local-opt/bin/tensorflow/python/kernel_tests/py_func_test.runfiles/org_tensorflow/tensorflow/python/framework/ops.py\", line 1617, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): exceptions.UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)\r\n\t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_STRING], token=\"pyfunc_2049\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\r\n\r\n\r\n----------------------------------------------------------------------\r\nRan 36 tests in 6.497s\r\n\r\nFAILED (errors=1)\r\n```\r\n"}