{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19747", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19747/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19747/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19747/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19747", "id": 329045847, "node_id": "MDU6SXNzdWUzMjkwNDU4NDc=", "number": 19747, "title": "MyDatasetReaderOp crashes on assertion in tensorflow::core::RefCounted::~RefCounted()", "user": {"login": "ilya-edrenkin", "id": 13562803, "node_id": "MDQ6VXNlcjEzNTYyODAz", "avatar_url": "https://avatars2.githubusercontent.com/u/13562803?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ilya-edrenkin", "html_url": "https://github.com/ilya-edrenkin", "followers_url": "https://api.github.com/users/ilya-edrenkin/followers", "following_url": "https://api.github.com/users/ilya-edrenkin/following{/other_user}", "gists_url": "https://api.github.com/users/ilya-edrenkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/ilya-edrenkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ilya-edrenkin/subscriptions", "organizations_url": "https://api.github.com/users/ilya-edrenkin/orgs", "repos_url": "https://api.github.com/users/ilya-edrenkin/repos", "events_url": "https://api.github.com/users/ilya-edrenkin/events{/privacy}", "received_events_url": "https://api.github.com/users/ilya-edrenkin/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-06-04T13:02:00Z", "updated_at": "2018-06-04T14:47:13Z", "closed_at": "2018-06-04T14:47:13Z", "author_association": "CONTRIBUTOR", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>:v1.8.0-0-g93bc2e2072 1.8.0</li>\n<li><strong>Python version</strong>: 3.5</li>\n<li><strong>Bazel version (if compiling from source)</strong>: Not relevant</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:g++ (Ubuntu 5.4.0-6ubuntu1~16.04.9) 5.4.0 20160609</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0/7.0.5</li>\n<li><strong>GPU model and memory</strong>:GTX 1080Ti</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<div class=\"highlight highlight-source-shell\"><pre>/usr/bin/c++   -Dexample_EXPORTS  -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/external/nsync/public -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC   -std=gnu++11 -o CMakeFiles/example.dir/my-reader-dataset-op.cc.o -c /opt/ssd/ilya/temp/my-reader-dataset-op.cc\n/usr/bin/c++  -fPIC -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/external/nsync/public -D_GLIBCXX_USE_CXX11_ABI=0  -shared -Wl,-soname,libexample.so -o libexample.so CMakeFiles/example.dir/my-reader-dataset-op.cc.o -L/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow -ltensorflow_framework </pre></div>\n<p><code>my-reader-dataset-op.cc</code> and <code>my.py</code> are copied from <a href=\"https://www.tensorflow.org/extend/new_data_formats#writing_a_dataset_for_a_file_format\" rel=\"nofollow\">https://www.tensorflow.org/extend/new_data_formats#writing_a_dataset_for_a_file_format</a> with two small changes in the Python code:</p>\n<ol>\n<li>The dataset is wrapped into <code>batch</code> Dataset (any other wrapper that calls <code>Unref</code> in its destructor would work too, e.g. <code>cache</code>).</li>\n<li>The iterator is initialized twice. The crash happens on the re-initialization attempt.</li>\n</ol>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">if</span> <span class=\"pl-c1\">__name__</span> <span class=\"pl-k\">==</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>__main__<span class=\"pl-pds\">\"</span></span>:\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> Create a MyReaderDataset and print its elements.</span>\n  <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    dataset <span class=\"pl-k\">=</span> MyReaderDataset()\n    dataset <span class=\"pl-k\">=</span> dataset.batch(<span class=\"pl-c1\">1</span>)\n    iterator <span class=\"pl-k\">=</span> dataset.make_initializable_iterator()\n    sess.run([iterator.initializer])\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>First init OK<span class=\"pl-pds\">\"</span></span>)\n    sess.run([iterator.initializer])\n    <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Reinit OK<span class=\"pl-pds\">\"</span></span>)\n    next_element <span class=\"pl-k\">=</span> iterator.get_next()\n    <span class=\"pl-k\">try</span>:\n      <span class=\"pl-k\">while</span> <span class=\"pl-c1\">True</span>:\n        <span class=\"pl-c1\">print</span>(sess.run(next_element))  <span class=\"pl-c\"><span class=\"pl-c\">#</span> Prints \"MyReader!\" ten times.</span>\n    <span class=\"pl-k\">except</span> tf.errors.OutOfRangeError:\n      <span class=\"pl-k\">pass</span></pre></div>\n<div class=\"highlight highlight-source-gdb\"><pre>First init OK\n<span class=\"pl-c1\">2018</span>-<span class=\"pl-c1\">06</span>-<span class=\"pl-c1\">04</span> <span class=\"pl-c1\">14</span>:<span class=\"pl-c1\">52</span>:<span class=\"pl-c1\">16</span>.<span class=\"pl-c1\">062227</span>: F /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/include/tensorflow/core/lib/core/refcount.h:<span class=\"pl-c1\">79</span>] Check failed: ref_.load() == <span class=\"pl-c1\">0</span> (<span class=\"pl-c1\">1</span> vs. <span class=\"pl-c1\">0</span>)\n\nThread <span class=\"pl-c1\">59</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>python3<span class=\"pl-pds\">\"</span></span> received signal SIGABRT, Aborted.\n[Switching to Thread <span class=\"pl-c1\">0x7ff95bfff700</span> (LWP <span class=\"pl-c1\">24856</span>)]\n<span class=\"pl-c1\">0x00007ffff7825428</span> in __GI_raise (sig=sig@entry=<span class=\"pl-c1\">6</span>) at ../sysdeps/unix/sysv/linux/raise.c:<span class=\"pl-c1\">54</span>\n<span class=\"pl-c1\">54</span>\t../sysdeps/unix/sysv/linux/raise.c: No such file or directory.\n(gdb) bt\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>0  0x00007ffff7825428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>1  0x00007ffff782702a in __GI_abort () at abort.c:89</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>2  0x00007fffa62a1174 in tensorflow::internal::LogMessageFatal::~LogMessageFatal() ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/../libtensorflow_framework.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>3  0x00007fffe6cf34e4 in tensorflow::core::RefCounted::~RefCounted() () from ./libexample.so</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>4  0x00007fffe6cf4670 in tensorflow::DatasetBase::~DatasetBase() () from ./libexample.so</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>5  0x00007fffe6cf4a7c in tensorflow::GraphDatasetBase::~GraphDatasetBase() () from ./libexample.so</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>6  0x00007fffe6cf25fc in tensorflow::(anonymous namespace)::MyReaderDatasetOp::Dataset::~Dataset() ()</span>\n   from ./libexample.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>7  0x00007fffe6cf262c in tensorflow::(anonymous namespace)::MyReaderDatasetOp::Dataset::~Dataset() ()</span>\n   from ./libexample.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>8  0x00007fffa941529f in tensorflow::(anonymous namespace)::BatchDatasetOp::Dataset::~Dataset() ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>9  0x00007fffa9414f3b in tensorflow::(anonymous namespace)::BatchDatasetOp::Dataset::Iterator::~Iterator() ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>10 0x00007fffa84387b9 in std::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)2&gt;::_M_release() ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>11 0x00007fffa945e6b6 in tensorflow::(anonymous namespace)::MakeIteratorOp::Compute(tensorflow::OpKernelContext*) ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>12 0x00007fffa664150c in tensorflow::ThreadPoolDevice::Compute(tensorflow::OpKernel*, tensorflow::OpKernelContext*) ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/../libtensorflow_framework.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>13 0x00007fffa660724d in tensorflow::(anonymous namespace)::ExecutorState::Process(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long) ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/../libtensorflow_framework.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>14 0x00007fffa65f5fd0 in std::_Function_handler&lt;void (), std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long)&gt; (tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long)&gt; &gt;::_M_invoke(std::_Any_data const&amp;) ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/../libtensorflow_framework.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>15 0x00007fffa626d6aa in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop(int) ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/../libtensorflow_framework.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>16 0x00007fffa626c752 in std::_Function_handler&lt;void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::{lambda()#1}&gt;::_M_invoke(std::_Any_data const&amp;) ()</span>\n   from /opt/ssd/ilya/temp-<span class=\"pl-c1\">environment</span>-for-bugreport/lib/python3.<span class=\"pl-c1\">5</span>/site-packages/tensorflow/python/../libtensorflow_framework.so\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>17 0x00007fff9d36fc80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>18 0x00007ffff7bc16ba in start_thread (arg=0x7ff95bfff700) at pthread_create.c:333</span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>19 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</span>\n(gdb) </pre></div>\n<p>It looks like <code>Unref</code> in <a href=\"https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/kernels/data/batch_dataset_op.cc#L62\">https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/kernels/data/batch_dataset_op.cc#L62</a> observes ref-count <code>1</code> and causes the destructor <code>MyReaderDatasetOp::Dataset::~Dataset()</code> to be called via <code>delete this</code>: <a href=\"https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/lib/core/refcount.h#L93\">https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/lib/core/refcount.h#L93</a>. However, later in destructor unfolding non-zero count is observed for the same object, which causes assertion failure.</p>\n<p>The error doesn't reproduce with built-in datasets, e.g. TextLineReader or RangeDataset. However, if I copy RangeDataset code and rebuild it as MyRangeDataset, it reproduces with exactly the same symptoms.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below):v1.8.0-0-g93bc2e2072 1.8.0\nPython version: 3.5\nBazel version (if compiling from source): Not relevant\nGCC/Compiler version (if compiling from source):g++ (Ubuntu 5.4.0-6ubuntu1~16.04.9) 5.4.0 20160609\nCUDA/cuDNN version: 9.0/7.0.5\nGPU model and memory:GTX 1080Ti\nExact command to reproduce:\n\n/usr/bin/c++   -Dexample_EXPORTS  -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/external/nsync/public -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC   -std=gnu++11 -o CMakeFiles/example.dir/my-reader-dataset-op.cc.o -c /opt/ssd/ilya/temp/my-reader-dataset-op.cc\n/usr/bin/c++  -fPIC -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/external/nsync/public -D_GLIBCXX_USE_CXX11_ABI=0  -shared -Wl,-soname,libexample.so -o libexample.so CMakeFiles/example.dir/my-reader-dataset-op.cc.o -L/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow -ltensorflow_framework \nmy-reader-dataset-op.cc and my.py are copied from https://www.tensorflow.org/extend/new_data_formats#writing_a_dataset_for_a_file_format with two small changes in the Python code:\n\nThe dataset is wrapped into batch Dataset (any other wrapper that calls Unref in its destructor would work too, e.g. cache).\nThe iterator is initialized twice. The crash happens on the re-initialization attempt.\n\nif __name__ == \"__main__\":\n  # Create a MyReaderDataset and print its elements.\n  with tf.Session() as sess:\n    dataset = MyReaderDataset()\n    dataset = dataset.batch(1)\n    iterator = dataset.make_initializable_iterator()\n    sess.run([iterator.initializer])\n    print(\"First init OK\")\n    sess.run([iterator.initializer])\n    print(\"Reinit OK\")\n    next_element = iterator.get_next()\n    try:\n      while True:\n        print(sess.run(next_element))  # Prints \"MyReader!\" ten times.\n    except tf.errors.OutOfRangeError:\n      pass\nFirst init OK\n2018-06-04 14:52:16.062227: F /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/tensorflow/core/lib/core/refcount.h:79] Check failed: ref_.load() == 0 (1 vs. 0)\n\nThread 59 \"python3\" received signal SIGABRT, Aborted.\n[Switching to Thread 0x7ff95bfff700 (LWP 24856)]\n0x00007ffff7825428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54\n54\t../sysdeps/unix/sysv/linux/raise.c: No such file or directory.\n(gdb) bt\n#0  0x00007ffff7825428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54\n#1  0x00007ffff782702a in __GI_abort () at abort.c:89\n#2  0x00007fffa62a1174 in tensorflow::internal::LogMessageFatal::~LogMessageFatal() ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\n#3  0x00007fffe6cf34e4 in tensorflow::core::RefCounted::~RefCounted() () from ./libexample.so\n#4  0x00007fffe6cf4670 in tensorflow::DatasetBase::~DatasetBase() () from ./libexample.so\n#5  0x00007fffe6cf4a7c in tensorflow::GraphDatasetBase::~GraphDatasetBase() () from ./libexample.so\n#6  0x00007fffe6cf25fc in tensorflow::(anonymous namespace)::MyReaderDatasetOp::Dataset::~Dataset() ()\n   from ./libexample.so\n#7  0x00007fffe6cf262c in tensorflow::(anonymous namespace)::MyReaderDatasetOp::Dataset::~Dataset() ()\n   from ./libexample.so\n#8  0x00007fffa941529f in tensorflow::(anonymous namespace)::BatchDatasetOp::Dataset::~Dataset() ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#9  0x00007fffa9414f3b in tensorflow::(anonymous namespace)::BatchDatasetOp::Dataset::Iterator::~Iterator() ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#10 0x00007fffa84387b9 in std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#11 0x00007fffa945e6b6 in tensorflow::(anonymous namespace)::MakeIteratorOp::Compute(tensorflow::OpKernelContext*) ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#12 0x00007fffa664150c in tensorflow::ThreadPoolDevice::Compute(tensorflow::OpKernel*, tensorflow::OpKernelContext*) ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\n#13 0x00007fffa660724d in tensorflow::(anonymous namespace)::ExecutorState::Process(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long) ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\n#14 0x00007fffa65f5fd0 in std::_Function_handler<void (), std::_Bind<std::_Mem_fn<void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long)> (tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long)> >::_M_invoke(std::_Any_data const&) ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\n#15 0x00007fffa626d6aa in Eigen::NonBlockingThreadPoolTempl<tensorflow::thread::EigenEnvironment>::WorkerLoop(int) ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\n#16 0x00007fffa626c752 in std::_Function_handler<void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function<void ()>)::{lambda()#1}>::_M_invoke(std::_Any_data const&) ()\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\n#17 0x00007fff9d36fc80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#18 0x00007ffff7bc16ba in start_thread (arg=0x7ff95bfff700) at pthread_create.c:333\n#19 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n(gdb) \nIt looks like Unref in https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/kernels/data/batch_dataset_op.cc#L62 observes ref-count 1 and causes the destructor MyReaderDatasetOp::Dataset::~Dataset() to be called via delete this: https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/lib/core/refcount.h#L93. However, later in destructor unfolding non-zero count is observed for the same object, which causes assertion failure.\nThe error doesn't reproduce with built-in datasets, e.g. TextLineReader or RangeDataset. However, if I copy RangeDataset code and rebuild it as MyRangeDataset, it reproduces with exactly the same symptoms.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**:v1.8.0-0-g93bc2e2072 1.8.0\r\n- **Python version**: 3.5\r\n- **Bazel version (if compiling from source)**: Not relevant\r\n- **GCC/Compiler version (if compiling from source)**:g++ (Ubuntu 5.4.0-6ubuntu1~16.04.9) 5.4.0 20160609\r\n- **CUDA/cuDNN version**: 9.0/7.0.5\r\n- **GPU model and memory**:GTX 1080Ti\r\n- **Exact command to reproduce**:\r\n\r\n```bash\r\n/usr/bin/c++   -Dexample_EXPORTS  -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/external/nsync/public -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC   -std=gnu++11 -o CMakeFiles/example.dir/my-reader-dataset-op.cc.o -c /opt/ssd/ilya/temp/my-reader-dataset-op.cc\r\n/usr/bin/c++  -fPIC -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include -I/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/external/nsync/public -D_GLIBCXX_USE_CXX11_ABI=0  -shared -Wl,-soname,libexample.so -o libexample.so CMakeFiles/example.dir/my-reader-dataset-op.cc.o -L/opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow -ltensorflow_framework \r\n```\r\n\r\n`my-reader-dataset-op.cc` and `my.py` are copied from https://www.tensorflow.org/extend/new_data_formats#writing_a_dataset_for_a_file_format with two small changes in the Python code:\r\n1) The dataset is wrapped into `batch` Dataset (any other wrapper that calls `Unref` in its destructor would work too, e.g. `cache`).\r\n2) The iterator is initialized twice. The crash happens on the re-initialization attempt.\r\n\r\n```python3\r\nif __name__ == \"__main__\":\r\n  # Create a MyReaderDataset and print its elements.\r\n  with tf.Session() as sess:\r\n    dataset = MyReaderDataset()\r\n    dataset = dataset.batch(1)\r\n    iterator = dataset.make_initializable_iterator()\r\n    sess.run([iterator.initializer])\r\n    print(\"First init OK\")\r\n    sess.run([iterator.initializer])\r\n    print(\"Reinit OK\")\r\n    next_element = iterator.get_next()\r\n    try:\r\n      while True:\r\n        print(sess.run(next_element))  # Prints \"MyReader!\" ten times.\r\n    except tf.errors.OutOfRangeError:\r\n      pass\r\n```\r\n\r\n```gdb\r\nFirst init OK\r\n2018-06-04 14:52:16.062227: F /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/include/tensorflow/core/lib/core/refcount.h:79] Check failed: ref_.load() == 0 (1 vs. 0)\r\n\r\nThread 59 \"python3\" received signal SIGABRT, Aborted.\r\n[Switching to Thread 0x7ff95bfff700 (LWP 24856)]\r\n0x00007ffff7825428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54\r\n54\t../sysdeps/unix/sysv/linux/raise.c: No such file or directory.\r\n(gdb) bt\r\n#0  0x00007ffff7825428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54\r\n#1  0x00007ffff782702a in __GI_abort () at abort.c:89\r\n#2  0x00007fffa62a1174 in tensorflow::internal::LogMessageFatal::~LogMessageFatal() ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#3  0x00007fffe6cf34e4 in tensorflow::core::RefCounted::~RefCounted() () from ./libexample.so\r\n#4  0x00007fffe6cf4670 in tensorflow::DatasetBase::~DatasetBase() () from ./libexample.so\r\n#5  0x00007fffe6cf4a7c in tensorflow::GraphDatasetBase::~GraphDatasetBase() () from ./libexample.so\r\n#6  0x00007fffe6cf25fc in tensorflow::(anonymous namespace)::MyReaderDatasetOp::Dataset::~Dataset() ()\r\n   from ./libexample.so\r\n#7  0x00007fffe6cf262c in tensorflow::(anonymous namespace)::MyReaderDatasetOp::Dataset::~Dataset() ()\r\n   from ./libexample.so\r\n#8  0x00007fffa941529f in tensorflow::(anonymous namespace)::BatchDatasetOp::Dataset::~Dataset() ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#9  0x00007fffa9414f3b in tensorflow::(anonymous namespace)::BatchDatasetOp::Dataset::Iterator::~Iterator() ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#10 0x00007fffa84387b9 in std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#11 0x00007fffa945e6b6 in tensorflow::(anonymous namespace)::MakeIteratorOp::Compute(tensorflow::OpKernelContext*) ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#12 0x00007fffa664150c in tensorflow::ThreadPoolDevice::Compute(tensorflow::OpKernel*, tensorflow::OpKernelContext*) ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#13 0x00007fffa660724d in tensorflow::(anonymous namespace)::ExecutorState::Process(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long) ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#14 0x00007fffa65f5fd0 in std::_Function_handler<void (), std::_Bind<std::_Mem_fn<void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long)> (tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long)> >::_M_invoke(std::_Any_data const&) ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#15 0x00007fffa626d6aa in Eigen::NonBlockingThreadPoolTempl<tensorflow::thread::EigenEnvironment>::WorkerLoop(int) ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#16 0x00007fffa626c752 in std::_Function_handler<void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function<void ()>)::{lambda()#1}>::_M_invoke(std::_Any_data const&) ()\r\n   from /opt/ssd/ilya/temp-environment-for-bugreport/lib/python3.5/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#17 0x00007fff9d36fc80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#18 0x00007ffff7bc16ba in start_thread (arg=0x7ff95bfff700) at pthread_create.c:333\r\n#19 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\r\n(gdb) \r\n```\r\n\r\nIt looks like `Unref` in https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/kernels/data/batch_dataset_op.cc#L62 observes ref-count `1` and causes the destructor `MyReaderDatasetOp::Dataset::~Dataset()` to be called via `delete this`: https://github.com/tensorflow/tensorflow/blob/v1.8.0/tensorflow/core/lib/core/refcount.h#L93. However, later in destructor unfolding non-zero count is observed for the same object, which causes assertion failure.\r\n\r\nThe error doesn't reproduce with built-in datasets, e.g. TextLineReader or RangeDataset. However, if I copy RangeDataset code and rebuild it as MyRangeDataset, it reproduces with exactly the same symptoms."}