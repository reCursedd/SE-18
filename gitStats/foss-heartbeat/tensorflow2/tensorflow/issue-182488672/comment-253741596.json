{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/253741596", "html_url": "https://github.com/tensorflow/tensorflow/issues/4911#issuecomment-253741596", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4911", "id": 253741596, "node_id": "MDEyOklzc3VlQ29tbWVudDI1Mzc0MTU5Ng==", "user": {"login": "riless", "id": 1511944, "node_id": "MDQ6VXNlcjE1MTE5NDQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/1511944?v=4", "gravatar_id": "", "url": "https://api.github.com/users/riless", "html_url": "https://github.com/riless", "followers_url": "https://api.github.com/users/riless/followers", "following_url": "https://api.github.com/users/riless/following{/other_user}", "gists_url": "https://api.github.com/users/riless/gists{/gist_id}", "starred_url": "https://api.github.com/users/riless/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/riless/subscriptions", "organizations_url": "https://api.github.com/users/riless/orgs", "repos_url": "https://api.github.com/users/riless/repos", "events_url": "https://api.github.com/users/riless/events{/privacy}", "received_events_url": "https://api.github.com/users/riless/received_events", "type": "User", "site_admin": false}, "created_at": "2016-10-14T08:37:17Z", "updated_at": "2016-10-14T09:00:35Z", "author_association": "NONE", "body_html": "<blockquote>\n<p>your device is not providing a 420sp camera frame or is not providing an actual argb8888 output bitmap</p>\n</blockquote>\n<p><code>LOGGER.i(\"IMAGE FORMAT: \" + String.valueOf(image.getFormat()));</code> Outputs <code>IMAGE FORMAT: 35</code>. refering to <a href=\"https://developer.android.com/reference/android/graphics/ImageFormat.html\" rel=\"nofollow\">this page</a>, it is the YUV_420_888 format.</p>\n<p>All <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/android/src/org/tensorflow/demo/TensorFlowImageListener.java#L122-L186\">this code</a> is exactly the same. I've just added a debug line after seeing that my model's output is incoh\u00e9rente.</p>\n<p><code>ImageUtils.saveBitmap(rgbFrameBitmap);</code></p>\n<p>I've added some logging to the YUV2RGB() function.</p>\n<div class=\"highlight highlight-source-c++\"><pre><span class=\"pl-k\">static</span> <span class=\"pl-k\">inline</span> uint32 <span class=\"pl-en\">YUV2RGB</span>(<span class=\"pl-k\">int</span> nY, <span class=\"pl-k\">int</span> nU, <span class=\"pl-k\">int</span> nV) {\n\n  <span class=\"pl-c1\">LOG</span>(INFO) &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nY: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nY &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span>\n            &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nU: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nU &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span>\n            &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nV: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nV &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span>;\n  nY -= <span class=\"pl-c1\">16</span>;\n  nU -= <span class=\"pl-c1\">128</span>;\n  nV -= <span class=\"pl-c1\">128</span>;\n  <span class=\"pl-k\">if</span> (nY &lt; <span class=\"pl-c1\">0</span>) nY = <span class=\"pl-c1\">0</span>;\n\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> This is the floating point equivalent. We do the conversion in integer</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> because some Android devices do not have floating point in hardware.</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> nR = (int)(1.164 * nY + 2.018 * nU);</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> nG = (int)(1.164 * nY - 0.813 * nV - 0.391 * nU);</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> nB = (int)(1.164 * nY + 1.596 * nV);</span>\n\n  <span class=\"pl-k\">int</span> nR = (<span class=\"pl-k\">int</span>)(<span class=\"pl-c1\">1192</span> * nY + <span class=\"pl-c1\">1634</span> * nV);\n  <span class=\"pl-k\">int</span> nG = (<span class=\"pl-k\">int</span>)(<span class=\"pl-c1\">1192</span> * nY - <span class=\"pl-c1\">833</span> * nV - <span class=\"pl-c1\">400</span> * nU);\n  <span class=\"pl-k\">int</span> nB = (<span class=\"pl-k\">int</span>)(<span class=\"pl-c1\">1192</span> * nY + <span class=\"pl-c1\">2066</span> * nU);\n\n  <span class=\"pl-c1\">LOG</span>(INFO) &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nR: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nR &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span>\n            &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nG: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nG &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span>\n            &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nB: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nB &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span>;\n\n\n  nR = <span class=\"pl-c1\">MIN</span>(<span class=\"pl-c1\">kMaxChannelValue</span>, <span class=\"pl-c1\">MAX</span>(<span class=\"pl-c1\">0</span>, nR));\n  nG = <span class=\"pl-c1\">MIN</span>(<span class=\"pl-c1\">kMaxChannelValue</span>, <span class=\"pl-c1\">MAX</span>(<span class=\"pl-c1\">0</span>, nG));\n  nB = <span class=\"pl-c1\">MIN</span>(<span class=\"pl-c1\">kMaxChannelValue</span>, <span class=\"pl-c1\">MAX</span>(<span class=\"pl-c1\">0</span>, nB));\n\n  nR = (nR &gt;&gt; <span class=\"pl-c1\">10</span>) &amp; <span class=\"pl-c1\">0xff</span>;\n  nG = (nG &gt;&gt; <span class=\"pl-c1\">10</span>) &amp; <span class=\"pl-c1\">0xff</span>;\n  nB = (nB &gt;&gt; <span class=\"pl-c1\">10</span>) &amp; <span class=\"pl-c1\">0xff</span>;\n\n  <span class=\"pl-c1\">LOG</span>(INFO) &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nR: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nR &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span>\n            &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nG: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nG &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span>\n            &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nB: <span class=\"pl-pds\">\"</span></span> &lt;&lt; nB &lt;&lt; <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n\\n</span><span class=\"pl-pds\">\"</span></span>;\n\n  <span class=\"pl-k\">return</span> <span class=\"pl-c1\">0xff000000</span> | (nR &lt;&lt; <span class=\"pl-c1\">16</span>) | (nG &lt;&lt; <span class=\"pl-c1\">8</span>) | nB;\n}\n</pre></div>\n<p>Here is the output</p>\n<pre><code>...\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 69, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -145976, nG: 221000, nB: -201272\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 215, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 71, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -143592, nG: 223384, nB: -198888\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 218, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 75, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -138824, nG: 228152, nB: -194120\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 222, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 78, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -135248, nG: 231728, nB: -190544\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 226, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 78, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -135248, nG: 231728, nB: -190544\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 226, nB: 0\n...\n</code></pre>", "body_text": "your device is not providing a 420sp camera frame or is not providing an actual argb8888 output bitmap\n\nLOGGER.i(\"IMAGE FORMAT: \" + String.valueOf(image.getFormat())); Outputs IMAGE FORMAT: 35. refering to this page, it is the YUV_420_888 format.\nAll this code is exactly the same. I've just added a debug line after seeing that my model's output is incoh\u00e9rente.\nImageUtils.saveBitmap(rgbFrameBitmap);\nI've added some logging to the YUV2RGB() function.\nstatic inline uint32 YUV2RGB(int nY, int nU, int nV) {\n\n  LOG(INFO) << \"nY: \" << nY << \", \"\n            << \"nU: \" << nU << \", \"\n            << \"nV: \" << nV << \"\\n\";\n  nY -= 16;\n  nU -= 128;\n  nV -= 128;\n  if (nY < 0) nY = 0;\n\n  // This is the floating point equivalent. We do the conversion in integer\n  // because some Android devices do not have floating point in hardware.\n  // nR = (int)(1.164 * nY + 2.018 * nU);\n  // nG = (int)(1.164 * nY - 0.813 * nV - 0.391 * nU);\n  // nB = (int)(1.164 * nY + 1.596 * nV);\n\n  int nR = (int)(1192 * nY + 1634 * nV);\n  int nG = (int)(1192 * nY - 833 * nV - 400 * nU);\n  int nB = (int)(1192 * nY + 2066 * nU);\n\n  LOG(INFO) << \"nR: \" << nR << \", \"\n            << \"nG: \" << nG << \", \"\n            << \"nB: \" << nB << \"\\n\";\n\n\n  nR = MIN(kMaxChannelValue, MAX(0, nR));\n  nG = MIN(kMaxChannelValue, MAX(0, nG));\n  nB = MIN(kMaxChannelValue, MAX(0, nB));\n\n  nR = (nR >> 10) & 0xff;\n  nG = (nG >> 10) & 0xff;\n  nB = (nB >> 10) & 0xff;\n\n  LOG(INFO) << \"nR: \" << nR << \", \"\n            << \"nG: \" << nG << \", \"\n            << \"nB: \" << nB << \"\\n\\n\";\n\n  return 0xff000000 | (nR << 16) | (nG << 8) | nB;\n}\n\nHere is the output\n...\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 69, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -145976, nG: 221000, nB: -201272\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 215, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 71, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -143592, nG: 223384, nB: -198888\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 218, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 75, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -138824, nG: 228152, nB: -194120\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 222, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 78, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -135248, nG: 231728, nB: -190544\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 226, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 78, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -135248, nG: 231728, nB: -190544\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 226, nB: 0\n...", "body": ">  your device is not providing a 420sp camera frame or is not providing an actual argb8888 output bitmap\n\n`LOGGER.i(\"IMAGE FORMAT: \" + String.valueOf(image.getFormat()));` Outputs `IMAGE FORMAT: 35`. refering to [this page](https://developer.android.com/reference/android/graphics/ImageFormat.html), it is the YUV_420_888 format.\n\nAll [this code](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/android/src/org/tensorflow/demo/TensorFlowImageListener.java#L122-L186) is exactly the same. I've just added a debug line after seeing that my model's output is incoh\u00e9rente.\n\n`ImageUtils.saveBitmap(rgbFrameBitmap);`\n\nI've added some logging to the YUV2RGB() function.\n\n``` cpp\nstatic inline uint32 YUV2RGB(int nY, int nU, int nV) {\n\n  LOG(INFO) << \"nY: \" << nY << \", \"\n            << \"nU: \" << nU << \", \"\n            << \"nV: \" << nV << \"\\n\";\n  nY -= 16;\n  nU -= 128;\n  nV -= 128;\n  if (nY < 0) nY = 0;\n\n  // This is the floating point equivalent. We do the conversion in integer\n  // because some Android devices do not have floating point in hardware.\n  // nR = (int)(1.164 * nY + 2.018 * nU);\n  // nG = (int)(1.164 * nY - 0.813 * nV - 0.391 * nU);\n  // nB = (int)(1.164 * nY + 1.596 * nV);\n\n  int nR = (int)(1192 * nY + 1634 * nV);\n  int nG = (int)(1192 * nY - 833 * nV - 400 * nU);\n  int nB = (int)(1192 * nY + 2066 * nU);\n\n  LOG(INFO) << \"nR: \" << nR << \", \"\n            << \"nG: \" << nG << \", \"\n            << \"nB: \" << nB << \"\\n\";\n\n\n  nR = MIN(kMaxChannelValue, MAX(0, nR));\n  nG = MIN(kMaxChannelValue, MAX(0, nG));\n  nB = MIN(kMaxChannelValue, MAX(0, nB));\n\n  nR = (nR >> 10) & 0xff;\n  nG = (nG >> 10) & 0xff;\n  nB = (nB >> 10) & 0xff;\n\n  LOG(INFO) << \"nR: \" << nR << \", \"\n            << \"nG: \" << nG << \", \"\n            << \"nB: \" << nB << \"\\n\\n\";\n\n  return 0xff000000 | (nR << 16) | (nG << 8) | nB;\n}\n\n```\n\nHere is the output\n\n```\n...\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 69, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -145976, nG: 221000, nB: -201272\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 215, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 71, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -143592, nG: 223384, nB: -198888\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 218, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 75, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -138824, nG: 228152, nB: -194120\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 222, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 78, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -135248, nG: 231728, nB: -190544\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 226, nB: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.406 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 80, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -132864, nG: 234112, nB: -188160\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 228, nB: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:33 nY: 78, nU: 0, nV: 0\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:51 nR: -135248, nG: 231728, nB: -190544\n10-14 10:31:59.411 28676-28716/? I/native: yuv2rgb.cc:64 nR: 0, nG: 226, nB: 0\n...\n```\n"}