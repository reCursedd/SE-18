{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12046", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12046/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12046/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/12046/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/12046", "id": 248091423, "node_id": "MDU6SXNzdWUyNDgwOTE0MjM=", "number": 12046, "title": "tf.scatter_update to variable pinned on GPU fails", "user": {"login": "muhadriy", "id": 29864790, "node_id": "MDQ6VXNlcjI5ODY0Nzkw", "avatar_url": "https://avatars0.githubusercontent.com/u/29864790?v=4", "gravatar_id": "", "url": "https://api.github.com/users/muhadriy", "html_url": "https://github.com/muhadriy", "followers_url": "https://api.github.com/users/muhadriy/followers", "following_url": "https://api.github.com/users/muhadriy/following{/other_user}", "gists_url": "https://api.github.com/users/muhadriy/gists{/gist_id}", "starred_url": "https://api.github.com/users/muhadriy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/muhadriy/subscriptions", "organizations_url": "https://api.github.com/users/muhadriy/orgs", "repos_url": "https://api.github.com/users/muhadriy/repos", "events_url": "https://api.github.com/users/muhadriy/events{/privacy}", "received_events_url": "https://api.github.com/users/muhadriy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-08-04T19:05:03Z", "updated_at": "2017-09-02T04:22:39Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>Linux Ubuntu 16.04</li>\n<li>tensorflow-gpu v1.2.0 binary installed from pip</li>\n<li>Python 3.5</li>\n<li>CUDA 8.0, cuDNN v5.1</li>\n<li>GeForce GTX 1080 Ti, 11GB</li>\n<li>A simple example I came up with which reproduces the error follows below:</li>\n</ul>\n<hr>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">with</span> tf.device(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/gpu:0<span class=\"pl-pds\">\"</span></span>):\n    a <span class=\"pl-k\">=</span> tf.Variable([<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">4</span>, <span class=\"pl-c1\">5</span>, <span class=\"pl-c1\">6</span>, <span class=\"pl-c1\">7</span>, <span class=\"pl-c1\">8</span>])\n    c <span class=\"pl-k\">=</span> tf.Variable([<span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">0</span>])\n    step_sos <span class=\"pl-k\">=</span> tf.Variable([<span class=\"pl-c1\">False</span>, <span class=\"pl-c1\">False</span>, <span class=\"pl-c1\">True</span>, <span class=\"pl-c1\">True</span>, <span class=\"pl-c1\">False</span>, <span class=\"pl-c1\">False</span>, <span class=\"pl-c1\">True</span>, <span class=\"pl-c1\">True</span>])\n    write_ops <span class=\"pl-k\">=</span> []\n    <span class=\"pl-k\">for</span> b <span class=\"pl-k\">in</span> <span class=\"pl-c1\">range</span>(<span class=\"pl-c1\">8</span>):\n        write_ops.append(tf.cond(step_sos[b], <span class=\"pl-k\">lambda</span>: tf.scatter_update(a, b, <span class=\"pl-c1\">0</span>), <span class=\"pl-k\">lambda</span>: a))\n\n    <span class=\"pl-k\">with</span> tf.control_dependencies(write_ops):\n       d <span class=\"pl-k\">=</span> tf.assign(c, a)\n\n\nsession_config <span class=\"pl-k\">=</span> tf.ConfigProto(<span class=\"pl-v\">allow_soft_placement</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>, <span class=\"pl-v\">log_device_placement</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)\n\n<span class=\"pl-k\">with</span> tf.Session(<span class=\"pl-v\">config</span><span class=\"pl-k\">=</span>session_config) <span class=\"pl-k\">as</span> sess:\n    init_op <span class=\"pl-k\">=</span> tf.global_variables_initializer()\n    sess.run(init_op)\n    sess.run(d)\n    <span class=\"pl-c1\">print</span>(sess.run(c))</pre></div>\n<hr>\n<h3></h3>\n<p>When setting allow_soft_placement=True the error is solved but the variable and some operations which are often used are placed in the CPU, which leads to fluctuating GPU utilization.</p>\n<h3>Source code / logs</h3>\n<pre><code>Traceback (most recent call last):\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1139, in _do_call\n    return fn(*args)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1117, in _run_fn\n    self._extend_graph()\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1166, in _extend_graph\n    self._session, graph_def.SerializeToString(), status)\n  File \"/usr/lib/python3.5/contextlib.py\", line 66, in __exit__\n    next(self.gen)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py\", line 466, in raise_exception_on_not_ok_status\n    pywrap_tensorflow.TF_GetCode(status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices: \nAssign: CPU \nIdentity: CPU \nVariableV2: CPU \n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"scatter_test.py\", line 20, in &lt;module&gt;\n    sess.run(init_op)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 789, in run\n    run_metadata_ptr)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 997, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\n    target_list, options, run_metadata)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices: \nAssign: CPU \nIdentity: CPU \nVariableV2: CPU \n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\n\nCaused by op 'Variable_2', defined at:\n  File \"scatter_test.py\", line 7, in &lt;module&gt;\n    step_sos = tf.Variable([False, False, True, True, False, False, True, True])\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/variables.py\", line 200, in __init__\n    expected_shape=expected_shape)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/variables.py\", line 297, in _init_from_args\n    name=name)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/state_ops.py\", line 128, in variable_op_v2\n    shared_name=shared_name)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/gen_state_ops.py\", line 684, in _variable_v2\n    name=name)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices: \nAssign: CPU \nIdentity: CPU \nVariableV2: CPU \n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\n</code></pre>", "body_text": "System information\n\nLinux Ubuntu 16.04\ntensorflow-gpu v1.2.0 binary installed from pip\nPython 3.5\nCUDA 8.0, cuDNN v5.1\nGeForce GTX 1080 Ti, 11GB\nA simple example I came up with which reproduces the error follows below:\n\n\nimport tensorflow as tf\nwith tf.device(\"/gpu:0\"):\n    a = tf.Variable([1, 2, 3, 4, 5, 6, 7, 8])\n    c = tf.Variable([0, 0, 0, 0, 0, 0, 0, 0])\n    step_sos = tf.Variable([False, False, True, True, False, False, True, True])\n    write_ops = []\n    for b in range(8):\n        write_ops.append(tf.cond(step_sos[b], lambda: tf.scatter_update(a, b, 0), lambda: a))\n\n    with tf.control_dependencies(write_ops):\n       d = tf.assign(c, a)\n\n\nsession_config = tf.ConfigProto(allow_soft_placement=False, log_device_placement=True)\n\nwith tf.Session(config=session_config) as sess:\n    init_op = tf.global_variables_initializer()\n    sess.run(init_op)\n    sess.run(d)\n    print(sess.run(c))\n\n\nWhen setting allow_soft_placement=True the error is solved but the variable and some operations which are often used are placed in the CPU, which leads to fluctuating GPU utilization.\nSource code / logs\nTraceback (most recent call last):\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1139, in _do_call\n    return fn(*args)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1117, in _run_fn\n    self._extend_graph()\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1166, in _extend_graph\n    self._session, graph_def.SerializeToString(), status)\n  File \"/usr/lib/python3.5/contextlib.py\", line 66, in __exit__\n    next(self.gen)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py\", line 466, in raise_exception_on_not_ok_status\n    pywrap_tensorflow.TF_GetCode(status))\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices: \nAssign: CPU \nIdentity: CPU \nVariableV2: CPU \n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"scatter_test.py\", line 20, in <module>\n    sess.run(init_op)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 789, in run\n    run_metadata_ptr)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 997, in _run\n    feed_dict_string, options, run_metadata)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\n    target_list, options, run_metadata)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices: \nAssign: CPU \nIdentity: CPU \nVariableV2: CPU \n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\n\nCaused by op 'Variable_2', defined at:\n  File \"scatter_test.py\", line 7, in <module>\n    step_sos = tf.Variable([False, False, True, True, False, False, True, True])\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/variables.py\", line 200, in __init__\n    expected_shape=expected_shape)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/variables.py\", line 297, in _init_from_args\n    name=name)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/state_ops.py\", line 128, in variable_op_v2\n    shared_name=shared_name)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/gen_state_ops.py\", line 684, in _variable_v2\n    name=name)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\n    op_def=op_def)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\n    original_op=self._default_original_op, op_def=op_def)\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\n    self._traceback = _extract_stack()\n\nInvalidArgumentError (see above for traceback): Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\nColocation Debug Info:\nColocation group had the following types and devices: \nAssign: CPU \nIdentity: CPU \nVariableV2: CPU \n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]", "body": "### System information\r\n- Linux Ubuntu 16.04\r\n- tensorflow-gpu v1.2.0 binary installed from pip\r\n- Python 3.5\r\n- CUDA 8.0, cuDNN v5.1 \r\n- GeForce GTX 1080 Ti, 11GB\r\n- A simple example I came up with which reproduces the error follows below:\r\n**************************************************************************************************\r\n```python\r\nimport tensorflow as tf\r\nwith tf.device(\"/gpu:0\"):\r\n    a = tf.Variable([1, 2, 3, 4, 5, 6, 7, 8])\r\n    c = tf.Variable([0, 0, 0, 0, 0, 0, 0, 0])\r\n    step_sos = tf.Variable([False, False, True, True, False, False, True, True])\r\n    write_ops = []\r\n    for b in range(8):\r\n        write_ops.append(tf.cond(step_sos[b], lambda: tf.scatter_update(a, b, 0), lambda: a))\r\n\r\n    with tf.control_dependencies(write_ops):\r\n       d = tf.assign(c, a)\r\n\r\n\r\nsession_config = tf.ConfigProto(allow_soft_placement=False, log_device_placement=True)\r\n\r\nwith tf.Session(config=session_config) as sess:\r\n    init_op = tf.global_variables_initializer()\r\n    sess.run(init_op)\r\n    sess.run(d)\r\n    print(sess.run(c))\r\n```\r\n********************************************************************************************************              \r\n\r\n### \r\nWhen setting allow_soft_placement=True the error is solved but the variable and some operations which are often used are placed in the CPU, which leads to fluctuating GPU utilization.\r\n\r\n### Source code / logs\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1139, in _do_call\r\n    return fn(*args)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1117, in _run_fn\r\n    self._extend_graph()\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1166, in _extend_graph\r\n    self._session, graph_def.SerializeToString(), status)\r\n  File \"/usr/lib/python3.5/contextlib.py\", line 66, in __exit__\r\n    next(self.gen)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/errors_impl.py\", line 466, in raise_exception_on_not_ok_status\r\n    pywrap_tensorflow.TF_GetCode(status))\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nColocation Debug Info:\r\nColocation group had the following types and devices: \r\nAssign: CPU \r\nIdentity: CPU \r\nVariableV2: CPU \r\n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"scatter_test.py\", line 20, in <module>\r\n    sess.run(init_op)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 789, in run\r\n    run_metadata_ptr)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 997, in _run\r\n    feed_dict_string, options, run_metadata)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1132, in _do_run\r\n    target_list, options, run_metadata)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/client/session.py\", line 1152, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nColocation Debug Info:\r\nColocation group had the following types and devices: \r\nAssign: CPU \r\nIdentity: CPU \r\nVariableV2: CPU \r\n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\r\n\r\nCaused by op 'Variable_2', defined at:\r\n  File \"scatter_test.py\", line 7, in <module>\r\n    step_sos = tf.Variable([False, False, True, True, False, False, True, True])\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/variables.py\", line 200, in __init__\r\n    expected_shape=expected_shape)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/variables.py\", line 297, in _init_from_args\r\n    name=name)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/state_ops.py\", line 128, in variable_op_v2\r\n    shared_name=shared_name)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/ops/gen_state_ops.py\", line 684, in _variable_v2\r\n    name=name)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/op_def_library.py\", line 767, in apply_op\r\n    op_def=op_def)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 2506, in create_op\r\n    original_op=self._default_original_op, op_def=op_def)\r\n  File \"/home/ylli/neuralattention/code/venv/lib/python3.5/site-packages/tensorflow/python/framework/ops.py\", line 1269, in __init__\r\n    self._traceback = _extract_stack()\r\n\r\nInvalidArgumentError (see above for traceback): Cannot assign a device for operation 'Variable_2': Could not satisfy explicit device specification '/device:GPU:0' because no supported kernel for GPU devices is available.\r\nColocation Debug Info:\r\nColocation group had the following types and devices: \r\nAssign: CPU \r\nIdentity: CPU \r\nVariableV2: CPU \r\n\t [[Node: Variable_2 = VariableV2[container=\"\", dtype=DT_BOOL, shape=[8], shared_name=\"\", _device=\"/device:GPU:0\"]()]]\r\n```\r\n"}