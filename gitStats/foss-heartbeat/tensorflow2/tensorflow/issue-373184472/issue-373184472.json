{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23195", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23195/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23195/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/23195/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/23195", "id": 373184472, "node_id": "MDU6SXNzdWUzNzMxODQ0NzI=", "number": 23195, "title": "Segfault reading dataset more than once (`make_batched_features_dataset`)", "user": {"login": "brianmartin", "id": 130559, "node_id": "MDQ6VXNlcjEzMDU1OQ==", "avatar_url": "https://avatars1.githubusercontent.com/u/130559?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brianmartin", "html_url": "https://github.com/brianmartin", "followers_url": "https://api.github.com/users/brianmartin/followers", "following_url": "https://api.github.com/users/brianmartin/following{/other_user}", "gists_url": "https://api.github.com/users/brianmartin/gists{/gist_id}", "starred_url": "https://api.github.com/users/brianmartin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brianmartin/subscriptions", "organizations_url": "https://api.github.com/users/brianmartin/orgs", "repos_url": "https://api.github.com/users/brianmartin/repos", "events_url": "https://api.github.com/users/brianmartin/events{/privacy}", "received_events_url": "https://api.github.com/users/brianmartin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "shivaniag", "id": 16565716, "node_id": "MDQ6VXNlcjE2NTY1NzE2", "avatar_url": "https://avatars1.githubusercontent.com/u/16565716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shivaniag", "html_url": "https://github.com/shivaniag", "followers_url": "https://api.github.com/users/shivaniag/followers", "following_url": "https://api.github.com/users/shivaniag/following{/other_user}", "gists_url": "https://api.github.com/users/shivaniag/gists{/gist_id}", "starred_url": "https://api.github.com/users/shivaniag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shivaniag/subscriptions", "organizations_url": "https://api.github.com/users/shivaniag/orgs", "repos_url": "https://api.github.com/users/shivaniag/repos", "events_url": "https://api.github.com/users/shivaniag/events{/privacy}", "received_events_url": "https://api.github.com/users/shivaniag/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "shivaniag", "id": 16565716, "node_id": "MDQ6VXNlcjE2NTY1NzE2", "avatar_url": "https://avatars1.githubusercontent.com/u/16565716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shivaniag", "html_url": "https://github.com/shivaniag", "followers_url": "https://api.github.com/users/shivaniag/followers", "following_url": "https://api.github.com/users/shivaniag/following{/other_user}", "gists_url": "https://api.github.com/users/shivaniag/gists{/gist_id}", "starred_url": "https://api.github.com/users/shivaniag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shivaniag/subscriptions", "organizations_url": "https://api.github.com/users/shivaniag/orgs", "repos_url": "https://api.github.com/users/shivaniag/repos", "events_url": "https://api.github.com/users/shivaniag/events{/privacy}", "received_events_url": "https://api.github.com/users/shivaniag/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2018-10-23T20:21:54Z", "updated_at": "2018-10-31T01:38:43Z", "closed_at": "2018-10-31T01:38:43Z", "author_association": "NONE", "body_html": "<p><strong>System information</strong></p>\n<ul>\n<li>Have I written custom code (as opposed to using a stock example script provided in TensorFlow): <strong>No</strong></li>\n<li>OS Platform and Distribution (e.g., Linux Ubuntu 16.04): <strong>macOS 10.14 Mojave</strong></li>\n<li>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: <strong>NA</strong></li>\n<li>TensorFlow installed from (source or binary): <strong>Binary / pip</strong></li>\n<li>TensorFlow version (use command below): <strong><code>('v1.11.0-rc2-4-gc19e29306c', '1.11.0')</code></strong></li>\n<li>Python version: <strong>2.7.10</strong></li>\n<li>Bazel version (if compiling from source): <strong>NA</strong></li>\n<li>GCC/Compiler version (if compiling from source): <strong>NA</strong></li>\n<li>CUDA/cuDNN version: <strong>NA</strong></li>\n<li>GPU model and memory: <strong>NA</strong></li>\n</ul>\n<p><a href=\"https://gist.github.com/brianmartin/2b43dca69453478ed33b49f1029e03fe\">Gist of full output of `./tools/tf_env_collect.sh</a></p>\n<p><strong>Exact command to reproduce:</strong></p>\n<pre><code>$ wget https://gist.githubusercontent.com/brianmartin/4f221eb838dce8099342f829fb13253d/raw/00c2a1736b9a292f8a6fb88164d240a766468744/gistfile1.txt\n$ python gistfile1.txt\n</code></pre>\n<p><strong>Describe the current behavior</strong></p>\n<p>Current behavior in 1.11.0, 1.12.0rcX is that the included script segfaults (11: SIGSEGV).</p>\n<p><strong>Describe the expected behavior</strong></p>\n<p>Expected behavior is no segfault. Version 1.10.1, 1.10.0, and 1.9.0 do not segfault. I have not checked lower versions.</p>\n<p><strong>Code to reproduce the issue</strong></p>\n<p>See a full script which reproduces this issue along two different code paths here: <a href=\"https://gist.github.com/brianmartin/4f221eb838dce8099342f829fb13253d\">https://gist.github.com/brianmartin/4f221eb838dce8099342f829fb13253d</a></p>\n<p>The segfault occurs when reading the dataset a second time. The first read works as expected.</p>\n<p>For reference the two code samples which produce datasets which cause a segfault on second read are:</p>\n<div class=\"highlight highlight-source-python\"><pre>    dataset <span class=\"pl-k\">=</span> make_batched_features_dataset(<span class=\"pl-v\">file_pattern</span><span class=\"pl-k\">=</span>data_file,\n                                            <span class=\"pl-v\">batch_size</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>,\n                                            <span class=\"pl-v\">features</span><span class=\"pl-k\">=</span>feature_spec)</pre></div>\n<p>I've also dug into <code>make_batched_features_dataset</code> and minified down to this repro:</p>\n<div class=\"highlight highlight-source-python\"><pre>    <span class=\"pl-k\">from</span> tensorflow.contrib.data.python.ops <span class=\"pl-k\">import</span> parsing_ops\n    <span class=\"pl-k\">from</span> tensorflow.python.data.ops <span class=\"pl-k\">import</span> readers\n\n    dataset <span class=\"pl-k\">=</span> Dataset.from_tensor_slices([data_file]) \\\n                     .interleave(readers.TFRecordDataset, <span class=\"pl-v\">cycle_length</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>) \\\n                     .batch(<span class=\"pl-v\">batch_size</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">1</span>) \\\n                     .apply(parsing_ops.parse_example_dataset(feature_spec))</pre></div>\n<hr>\n<p>Please let me know if there's anything else I can provide or help with! This is blocking us from upgrading to the latest Tensorflow version in <a href=\"https://github.com/spotify/spotify-tensorflow\">spotify/spotify-tensorflow</a>.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): No\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): macOS 10.14 Mojave\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: NA\nTensorFlow installed from (source or binary): Binary / pip\nTensorFlow version (use command below): ('v1.11.0-rc2-4-gc19e29306c', '1.11.0')\nPython version: 2.7.10\nBazel version (if compiling from source): NA\nGCC/Compiler version (if compiling from source): NA\nCUDA/cuDNN version: NA\nGPU model and memory: NA\n\nGist of full output of `./tools/tf_env_collect.sh\nExact command to reproduce:\n$ wget https://gist.githubusercontent.com/brianmartin/4f221eb838dce8099342f829fb13253d/raw/00c2a1736b9a292f8a6fb88164d240a766468744/gistfile1.txt\n$ python gistfile1.txt\n\nDescribe the current behavior\nCurrent behavior in 1.11.0, 1.12.0rcX is that the included script segfaults (11: SIGSEGV).\nDescribe the expected behavior\nExpected behavior is no segfault. Version 1.10.1, 1.10.0, and 1.9.0 do not segfault. I have not checked lower versions.\nCode to reproduce the issue\nSee a full script which reproduces this issue along two different code paths here: https://gist.github.com/brianmartin/4f221eb838dce8099342f829fb13253d\nThe segfault occurs when reading the dataset a second time. The first read works as expected.\nFor reference the two code samples which produce datasets which cause a segfault on second read are:\n    dataset = make_batched_features_dataset(file_pattern=data_file,\n                                            batch_size=1,\n                                            features=feature_spec)\nI've also dug into make_batched_features_dataset and minified down to this repro:\n    from tensorflow.contrib.data.python.ops import parsing_ops\n    from tensorflow.python.data.ops import readers\n\n    dataset = Dataset.from_tensor_slices([data_file]) \\\n                     .interleave(readers.TFRecordDataset, cycle_length=1) \\\n                     .batch(batch_size=1) \\\n                     .apply(parsing_ops.parse_example_dataset(feature_spec))\n\nPlease let me know if there's anything else I can provide or help with! This is blocking us from upgrading to the latest Tensorflow version in spotify/spotify-tensorflow.", "body": "**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): **No**\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): **macOS 10.14 Mojave**\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: **NA**\r\n- TensorFlow installed from (source or binary): **Binary / pip**\r\n- TensorFlow version (use command below): **`('v1.11.0-rc2-4-gc19e29306c', '1.11.0')`**\r\n- Python version: **2.7.10**\r\n- Bazel version (if compiling from source): **NA**\r\n- GCC/Compiler version (if compiling from source): **NA**\r\n- CUDA/cuDNN version: **NA**\r\n- GPU model and memory: **NA**\r\n\r\n[Gist of full output of `./tools/tf_env_collect.sh](https://gist.github.com/brianmartin/2b43dca69453478ed33b49f1029e03fe)\r\n\r\n**Exact command to reproduce:**\r\n\r\n```\r\n$ wget https://gist.githubusercontent.com/brianmartin/4f221eb838dce8099342f829fb13253d/raw/00c2a1736b9a292f8a6fb88164d240a766468744/gistfile1.txt\r\n$ python gistfile1.txt\r\n```\r\n\r\n**Describe the current behavior**\r\n\r\nCurrent behavior in 1.11.0, 1.12.0rcX is that the included script segfaults (11: SIGSEGV).\r\n\r\n**Describe the expected behavior**\r\n\r\nExpected behavior is no segfault. Version 1.10.1, 1.10.0, and 1.9.0 do not segfault. I have not checked lower versions.\r\n\r\n**Code to reproduce the issue**\r\n\r\nSee a full script which reproduces this issue along two different code paths here: https://gist.github.com/brianmartin/4f221eb838dce8099342f829fb13253d\r\n\r\nThe segfault occurs when reading the dataset a second time. The first read works as expected.\r\n\r\nFor reference the two code samples which produce datasets which cause a segfault on second read are:\r\n\r\n```py\r\n    dataset = make_batched_features_dataset(file_pattern=data_file,\r\n                                            batch_size=1,\r\n                                            features=feature_spec)\r\n```\r\n\r\nI've also dug into `make_batched_features_dataset` and minified down to this repro:\r\n\r\n```py\r\n    from tensorflow.contrib.data.python.ops import parsing_ops\r\n    from tensorflow.python.data.ops import readers\r\n\r\n    dataset = Dataset.from_tensor_slices([data_file]) \\\r\n                     .interleave(readers.TFRecordDataset, cycle_length=1) \\\r\n                     .batch(batch_size=1) \\\r\n                     .apply(parsing_ops.parse_example_dataset(feature_spec))\r\n```\r\n\r\n------\r\n\r\nPlease let me know if there's anything else I can provide or help with! This is blocking us from upgrading to the latest Tensorflow version in [spotify/spotify-tensorflow](https://github.com/spotify/spotify-tensorflow)."}