{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/368620277", "html_url": "https://github.com/tensorflow/tensorflow/issues/10685#issuecomment-368620277", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/10685", "id": 368620277, "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODYyMDI3Nw==", "user": {"login": "anton-matosov", "id": 3339485, "node_id": "MDQ6VXNlcjMzMzk0ODU=", "avatar_url": "https://avatars1.githubusercontent.com/u/3339485?v=4", "gravatar_id": "", "url": "https://api.github.com/users/anton-matosov", "html_url": "https://github.com/anton-matosov", "followers_url": "https://api.github.com/users/anton-matosov/followers", "following_url": "https://api.github.com/users/anton-matosov/following{/other_user}", "gists_url": "https://api.github.com/users/anton-matosov/gists{/gist_id}", "starred_url": "https://api.github.com/users/anton-matosov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/anton-matosov/subscriptions", "organizations_url": "https://api.github.com/users/anton-matosov/orgs", "repos_url": "https://api.github.com/users/anton-matosov/repos", "events_url": "https://api.github.com/users/anton-matosov/events{/privacy}", "received_events_url": "https://api.github.com/users/anton-matosov/received_events", "type": "User", "site_admin": false}, "created_at": "2018-02-26T19:29:03Z", "updated_at": "2018-02-26T19:29:03Z", "author_association": "CONTRIBUTOR", "body_html": "<p>I have also managed to build Tensorflow with MKL on Darwin natively (steps below), but crashes at runtime during the benchmark, even tho it works for simple tests.</p>\n<p>Here is the runtime error I get</p>\n<pre><code>$ python tf_cnn_benchmarks.py --batch_size=32 --model=resnet50 --data_format=NHWC --device=cpu\n\npython(7794,0x7fff892ed340) malloc: *** error for object 0x182655e990: pointer being freed was not allocated\n*** set a breakpoint in malloc_error_break to debug\nfish: 'python tf_cnn_benchmarks.py --b\u2026' terminated by signal SIGABRT (Abort)\n</code></pre>\n<p>Sometimes it is dealloc of already freed pointer. Not sure if it is MKL itself, or something is getting messed up in TF with such a setup.<br>\nI am going to spend next couple days trying to tough it out.<br>\nI will keep everyone posted.</p>\n<h3>How I built with MKL on macOS</h3>\n<ol>\n<li>I have implemented couple fixes to Bazel and C++ code, available in this fork/branch <a href=\"https://github.com/anton-matosov/tensorflow/tree/v1.5.0-mkl-mac-build\">https://github.com/anton-matosov/tensorflow/tree/v1.5.0-mkl-mac-build</a></li>\n<li>Download MKL for Mac archive from <a href=\"https://github.com/intel/mkl-dnn/releases\">https://github.com/intel/mkl-dnn/releases</a> and extract it (I have used v0.12 release)</li>\n<li>Run build using the following command <code>env TF_MKL_ROOT=/Users/antonmatosov/Downloads/mklml_mac_2018.0.1.20171227  bazel build --config=mkl --config=\"opt\" --copt=\"-march=native\" --copt=\"-O3\" //tensorflow/tools/pip_package:build_pip_packag</code></li>\n</ol>", "body_text": "I have also managed to build Tensorflow with MKL on Darwin natively (steps below), but crashes at runtime during the benchmark, even tho it works for simple tests.\nHere is the runtime error I get\n$ python tf_cnn_benchmarks.py --batch_size=32 --model=resnet50 --data_format=NHWC --device=cpu\n\npython(7794,0x7fff892ed340) malloc: *** error for object 0x182655e990: pointer being freed was not allocated\n*** set a breakpoint in malloc_error_break to debug\nfish: 'python tf_cnn_benchmarks.py --b\u2026' terminated by signal SIGABRT (Abort)\n\nSometimes it is dealloc of already freed pointer. Not sure if it is MKL itself, or something is getting messed up in TF with such a setup.\nI am going to spend next couple days trying to tough it out.\nI will keep everyone posted.\nHow I built with MKL on macOS\n\nI have implemented couple fixes to Bazel and C++ code, available in this fork/branch https://github.com/anton-matosov/tensorflow/tree/v1.5.0-mkl-mac-build\nDownload MKL for Mac archive from https://github.com/intel/mkl-dnn/releases and extract it (I have used v0.12 release)\nRun build using the following command env TF_MKL_ROOT=/Users/antonmatosov/Downloads/mklml_mac_2018.0.1.20171227  bazel build --config=mkl --config=\"opt\" --copt=\"-march=native\" --copt=\"-O3\" //tensorflow/tools/pip_package:build_pip_packag", "body": "I have also managed to build Tensorflow with MKL on Darwin natively (steps below), but crashes at runtime during the benchmark, even tho it works for simple tests.\r\n\r\nHere is the runtime error I get\r\n```\r\n$ python tf_cnn_benchmarks.py --batch_size=32 --model=resnet50 --data_format=NHWC --device=cpu\r\n\r\npython(7794,0x7fff892ed340) malloc: *** error for object 0x182655e990: pointer being freed was not allocated\r\n*** set a breakpoint in malloc_error_break to debug\r\nfish: 'python tf_cnn_benchmarks.py --b\u2026' terminated by signal SIGABRT (Abort)\r\n```\r\nSometimes it is dealloc of already freed pointer. Not sure if it is MKL itself, or something is getting messed up in TF with such a setup.\r\nI am going to spend next couple days trying to tough it out. \r\nI will keep everyone posted.\r\n\r\n### How I built with MKL on macOS\r\n1. I have implemented couple fixes to Bazel and C++ code, available in this fork/branch https://github.com/anton-matosov/tensorflow/tree/v1.5.0-mkl-mac-build\r\n2. Download MKL for Mac archive from https://github.com/intel/mkl-dnn/releases and extract it (I have used v0.12 release)\r\n3. Run build using the following command `env TF_MKL_ROOT=/Users/antonmatosov/Downloads/mklml_mac_2018.0.1.20171227  bazel build --config=mkl --config=\"opt\" --copt=\"-march=native\" --copt=\"-O3\" //tensorflow/tools/pip_package:build_pip_packag`"}