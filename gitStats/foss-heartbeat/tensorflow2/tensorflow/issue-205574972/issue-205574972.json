{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7288", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7288/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7288/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/7288/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/7288", "id": 205574972, "node_id": "MDU6SXNzdWUyMDU1NzQ5NzI=", "number": 7288, "title": "Are linkopts propagated from copts and/or deps ?", "user": {"login": "riless", "id": 1511944, "node_id": "MDQ6VXNlcjE1MTE5NDQ=", "avatar_url": "https://avatars3.githubusercontent.com/u/1511944?v=4", "gravatar_id": "", "url": "https://api.github.com/users/riless", "html_url": "https://github.com/riless", "followers_url": "https://api.github.com/users/riless/followers", "following_url": "https://api.github.com/users/riless/following{/other_user}", "gists_url": "https://api.github.com/users/riless/gists{/gist_id}", "starred_url": "https://api.github.com/users/riless/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/riless/subscriptions", "organizations_url": "https://api.github.com/users/riless/orgs", "repos_url": "https://api.github.com/users/riless/repos", "events_url": "https://api.github.com/users/riless/events{/privacy}", "received_events_url": "https://api.github.com/users/riless/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}, {"id": 473173351, "node_id": "MDU6TGFiZWw0NzMxNzMzNTE=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:build/install", "name": "type:build/install", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2017-02-06T12:52:53Z", "updated_at": "2017-02-08T14:08:24Z", "closed_at": "2017-02-08T14:08:24Z", "author_association": "NONE", "body_html": "<p>The linker complains about not finding <code>-lpthread</code>, while I didn't add this flag to linkopts.</p>\n<p>I've checked the executed command, and in fact there is extra flags on it <code>-lz  -lpthread ...</code>.</p>\n<p>Where did they came from ? Is there a workaround for this ?</p>\n<h1>More details</h1>\n<h2>BUILD file</h2>\n<pre><code>cc_binary(\n    name = \"libfoo.so\",\n    srcs = glob([\n         \"jni/**/*.cc\",\n         \"jni/**/*.h\",\n    ]),\n    copts = [ \"-fexceptions\", \"-DEIGEN_AVOID_STL_ARRAY\",\n              \"-mfpu=neon\", \"-std=c++11\",\n              \"-DMIN_LOG_LEVEL=0\", \"-DTF_LEAN_BINARY\",\n              \"-O2\", ],\n    linkopts = [\n        \"-llog\",\n        \"-lm\",\n    ],\n    linkshared = 1,\n    deps = [\n        \"@org_tensorflow//tensorflow/core:android_tensorflow_lib\",\n        \"@boringssl//:crypto\",\n    ],\n)\n</code></pre>\n<h2>Command</h2>\n<p><code>bazel build -c opt //:libfoo.so --crosstool_top=//external:android/crosstool --cpu=armeabi-v7a --host_crosstool_top=@bazel_tools//tools/cpp:toolchain --verbose_failures --sandbox_debug --strategy=CppLink=standalone</code></p>\n<h2>Full error</h2>\n<pre><code>...\n  external/bazel_tools/tools/cpp/link_dynamic_library.sh no ignored ignored ignored external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/arm-linux-androideabi-gcc -shared -o bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/libfoo.so -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libandroid_tensorflow_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/kernels/libandroid_tensorflow_kernels.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libandroid_tensorflow_lib_lite.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libprotos_all_cc.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/protobuf/libprotobuf.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/protobuf/libprotobuf_lite.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/boringssl/libcrypto.a -Wl,-no-whole-archive external/androidndk/ndk/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/libgnustl_static.a external/androidndk/ndk/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/libsupc++.a -llog -lm -lz -lpthread -static-libgcc -no-canonical-prefixes '-march=armv7-a' -Wl,--fix-cortex-a8 '--sysroot=external/androidndk/ndk/platforms/android-21/arch-arm'): com.google.devtools.build.lib.shell.BadExitStatusException: Process exited with status 1.\nexternal/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: cannot find -lpthread\ncollect2: error: ld returned 1 exit status\nTarget //:libfoo.so failed to build\n\n</code></pre>", "body_text": "The linker complains about not finding -lpthread, while I didn't add this flag to linkopts.\nI've checked the executed command, and in fact there is extra flags on it -lz  -lpthread ....\nWhere did they came from ? Is there a workaround for this ?\nMore details\nBUILD file\ncc_binary(\n    name = \"libfoo.so\",\n    srcs = glob([\n         \"jni/**/*.cc\",\n         \"jni/**/*.h\",\n    ]),\n    copts = [ \"-fexceptions\", \"-DEIGEN_AVOID_STL_ARRAY\",\n              \"-mfpu=neon\", \"-std=c++11\",\n              \"-DMIN_LOG_LEVEL=0\", \"-DTF_LEAN_BINARY\",\n              \"-O2\", ],\n    linkopts = [\n        \"-llog\",\n        \"-lm\",\n    ],\n    linkshared = 1,\n    deps = [\n        \"@org_tensorflow//tensorflow/core:android_tensorflow_lib\",\n        \"@boringssl//:crypto\",\n    ],\n)\n\nCommand\nbazel build -c opt //:libfoo.so --crosstool_top=//external:android/crosstool --cpu=armeabi-v7a --host_crosstool_top=@bazel_tools//tools/cpp:toolchain --verbose_failures --sandbox_debug --strategy=CppLink=standalone\nFull error\n...\n  external/bazel_tools/tools/cpp/link_dynamic_library.sh no ignored ignored ignored external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/arm-linux-androideabi-gcc -shared -o bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/libfoo.so -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libandroid_tensorflow_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/kernels/libandroid_tensorflow_kernels.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libandroid_tensorflow_lib_lite.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libprotos_all_cc.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/protobuf/libprotobuf.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/protobuf/libprotobuf_lite.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/boringssl/libcrypto.a -Wl,-no-whole-archive external/androidndk/ndk/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/libgnustl_static.a external/androidndk/ndk/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/libsupc++.a -llog -lm -lz -lpthread -static-libgcc -no-canonical-prefixes '-march=armv7-a' -Wl,--fix-cortex-a8 '--sysroot=external/androidndk/ndk/platforms/android-21/arch-arm'): com.google.devtools.build.lib.shell.BadExitStatusException: Process exited with status 1.\nexternal/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: cannot find -lpthread\ncollect2: error: ld returned 1 exit status\nTarget //:libfoo.so failed to build", "body": "The linker complains about not finding `-lpthread`, while I didn't add this flag to linkopts.\r\n\r\nI've checked the executed command, and in fact there is extra flags on it `-lz  -lpthread ...`.\r\n\r\nWhere did they came from ? Is there a workaround for this ?\r\n\r\n\r\nMore details\r\n====\r\n\r\nBUILD file\r\n---\r\n\r\n```\r\ncc_binary(\r\n    name = \"libfoo.so\",\r\n    srcs = glob([\r\n         \"jni/**/*.cc\",\r\n         \"jni/**/*.h\",\r\n    ]),\r\n    copts = [ \"-fexceptions\", \"-DEIGEN_AVOID_STL_ARRAY\",\r\n              \"-mfpu=neon\", \"-std=c++11\",\r\n              \"-DMIN_LOG_LEVEL=0\", \"-DTF_LEAN_BINARY\",\r\n              \"-O2\", ],\r\n    linkopts = [\r\n        \"-llog\",\r\n        \"-lm\",\r\n    ],\r\n    linkshared = 1,\r\n    deps = [\r\n        \"@org_tensorflow//tensorflow/core:android_tensorflow_lib\",\r\n        \"@boringssl//:crypto\",\r\n    ],\r\n)\r\n```\r\n\r\nCommand\r\n---\r\n`bazel build -c opt //:libfoo.so --crosstool_top=//external:android/crosstool --cpu=armeabi-v7a --host_crosstool_top=@bazel_tools//tools/cpp:toolchain --verbose_failures --sandbox_debug --strategy=CppLink=standalone`\r\n\r\n\r\nFull error\r\n---\r\n\r\n```\r\n...\r\n  external/bazel_tools/tools/cpp/link_dynamic_library.sh no ignored ignored ignored external/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/arm-linux-androideabi-gcc -shared -o bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/libfoo.so -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libandroid_tensorflow_lib.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/kernels/libandroid_tensorflow_kernels.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libandroid_tensorflow_lib_lite.lo -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/org_tensorflow/tensorflow/core/libprotos_all_cc.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/protobuf/libprotobuf.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/protobuf/libprotobuf_lite.a -Wl,-no-whole-archive -Wl,-whole-archive bazel-out/arm-linux-androideabi-4.9-v7a-gnu-libstdcpp-opt/bin/external/boringssl/libcrypto.a -Wl,-no-whole-archive external/androidndk/ndk/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/libgnustl_static.a external/androidndk/ndk/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/libsupc++.a -llog -lm -lz -lpthread -static-libgcc -no-canonical-prefixes '-march=armv7-a' -Wl,--fix-cortex-a8 '--sysroot=external/androidndk/ndk/platforms/android-21/arch-arm'): com.google.devtools.build.lib.shell.BadExitStatusException: Process exited with status 1.\r\nexternal/androidndk/ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: cannot find -lpthread\r\ncollect2: error: ld returned 1 exit status\r\nTarget //:libfoo.so failed to build\r\n\r\n```\r\n"}