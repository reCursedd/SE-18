{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/228408030", "pull_request_review_id": 168674433, "id": 228408030, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyODQwODAzMA==", "diff_hunk": "@@ -815,6 +885,121 @@ class MklLayoutRewritePass : public GraphOptimizationPass {\n     return n;\n   }\n \n+  // Return a node that can be fused with input node 'n'\n+  //\n+  // @return tuple. If we can find such nodes, the first\n+  // element of the tuple is a true. Otherwise, it's false.\n+  std::tuple<bool, std::vector<Node *>, const MklLayoutRewritePass::FusionInfo>\n+      CheckForNodeFusion(Node *n) const;\n+\n+  // Fuse nodes in the vector \"nodes\"\n+  Status FuseNode(std::unique_ptr<Graph> *g, std::vector<Node *> &nodes,\n+                  const MklLayoutRewritePass::FusionInfo fi);\n+\n+  static Status FuseTransposeMklOpTranspose(\n+      std::unique_ptr<Graph> *g, std::vector<Node *> &nodes,\n+      std::function<void(const Node *, NodeBuilder *nb, bool)> copy_attrs,\n+      string data_format);\n+\n+  static bool CheckForTranspose(const Node *node, std::vector<int> perm) {\n+    //\n+    // Check node node, to see if it's \"Transpose\"\n+    //\n+    if (node->type_string() != \"Transpose\")\n+      return false;\n+\n+    //\n+    // Check if has out control edge. If true, this is a training graph.\n+    // Currently we focus on inference and do no fusion in training.\n+    //\n+    for (const Edge *e : node->out_edges()) {\n+      if (e->IsControlEdge()) {\n+        return false;\n+      }\n+    }\n+\n+    //\n+    // If \"Transpose\" has input control edges, don't fuse on it.\n+    //\n+    for (const Edge *e : node->in_edges()) {\n+      if (e->IsControlEdge()) {\n+        return false;\n+      }\n+    }\n+\n+    //\n+    // If \"Transpose\" has multiple output data edges, also don't fuse it.\n+    //\n+    if (node->num_outputs() > 1 || node->out_edges().size() > 1)\n+      return false;\n+\n+    // Check \"perm\" attribute, make sure it's what we want.\n+    //\n+    for (const Edge *e : node->in_edges()) {\n+      if (!e->IsControlEdge()) {", "path": "tensorflow/core/graph/mkl_layout_pass.cc", "position": 184, "original_position": 176, "commit_id": "88b2369fe7c4451c63ff0599f7477897dabff2e0", "original_commit_id": "4f9d57337b71fe0ab3f25696db456e6a446ef54a", "user": {"login": "wenxizhu", "id": 33611326, "node_id": "MDQ6VXNlcjMzNjExMzI2", "avatar_url": "https://avatars1.githubusercontent.com/u/33611326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wenxizhu", "html_url": "https://github.com/wenxizhu", "followers_url": "https://api.github.com/users/wenxizhu/followers", "following_url": "https://api.github.com/users/wenxizhu/following{/other_user}", "gists_url": "https://api.github.com/users/wenxizhu/gists{/gist_id}", "starred_url": "https://api.github.com/users/wenxizhu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wenxizhu/subscriptions", "organizations_url": "https://api.github.com/users/wenxizhu/orgs", "repos_url": "https://api.github.com/users/wenxizhu/repos", "events_url": "https://api.github.com/users/wenxizhu/events{/privacy}", "received_events_url": "https://api.github.com/users/wenxizhu/received_events", "type": "User", "site_admin": false}, "body": "@penpornk I prefer to preserve this check. The assumption \"no input control edges\" is merely a temporary safe guard to stop this PR work on a training graph, and we will eventually remove this constraint when we find its safe to do this fusion in training. At that time, this check will be necessary because the \"no input control edges\" constraint has been removed. ", "created_at": "2018-10-26T05:20:03Z", "updated_at": "2018-11-14T06:34:27Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/23152#discussion_r228408030", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/23152", "author_association": "NONE", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/228408030"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/23152#discussion_r228408030"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/23152"}}, "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=38085909\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/penpornk\">@penpornk</a> I prefer to preserve this check. The assumption \"no input control edges\" is merely a temporary safe guard to stop this PR work on a training graph, and we will eventually remove this constraint when we find its safe to do this fusion in training. At that time, this check will be necessary because the \"no input control edges\" constraint has been removed.</p>", "body_text": "@penpornk I prefer to preserve this check. The assumption \"no input control edges\" is merely a temporary safe guard to stop this PR work on a training graph, and we will eventually remove this constraint when we find its safe to do this fusion in training. At that time, this check will be necessary because the \"no input control edges\" constraint has been removed.", "in_reply_to_id": 228323446}