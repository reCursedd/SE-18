{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19397", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19397/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19397/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/19397/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/19397", "id": 324536941, "node_id": "MDU6SXNzdWUzMjQ1MzY5NDE=", "number": 19397, "title": "[Bug] tf.shape does not return correct value when using tf.cond and tf.reshape", "user": {"login": "chmod644", "id": 4951782, "node_id": "MDQ6VXNlcjQ5NTE3ODI=", "avatar_url": "https://avatars1.githubusercontent.com/u/4951782?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chmod644", "html_url": "https://github.com/chmod644", "followers_url": "https://api.github.com/users/chmod644/followers", "following_url": "https://api.github.com/users/chmod644/following{/other_user}", "gists_url": "https://api.github.com/users/chmod644/gists{/gist_id}", "starred_url": "https://api.github.com/users/chmod644/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chmod644/subscriptions", "organizations_url": "https://api.github.com/users/chmod644/orgs", "repos_url": "https://api.github.com/users/chmod644/repos", "events_url": "https://api.github.com/users/chmod644/events{/privacy}", "received_events_url": "https://api.github.com/users/chmod644/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586594, "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower", "name": "stat:awaiting tensorflower", "color": "f4b400", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "bignamehyp", "id": 3474655, "node_id": "MDQ6VXNlcjM0NzQ2NTU=", "avatar_url": "https://avatars2.githubusercontent.com/u/3474655?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bignamehyp", "html_url": "https://github.com/bignamehyp", "followers_url": "https://api.github.com/users/bignamehyp/followers", "following_url": "https://api.github.com/users/bignamehyp/following{/other_user}", "gists_url": "https://api.github.com/users/bignamehyp/gists{/gist_id}", "starred_url": "https://api.github.com/users/bignamehyp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bignamehyp/subscriptions", "organizations_url": "https://api.github.com/users/bignamehyp/orgs", "repos_url": "https://api.github.com/users/bignamehyp/repos", "events_url": "https://api.github.com/users/bignamehyp/events{/privacy}", "received_events_url": "https://api.github.com/users/bignamehyp/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "bignamehyp", "id": 3474655, "node_id": "MDQ6VXNlcjM0NzQ2NTU=", "avatar_url": "https://avatars2.githubusercontent.com/u/3474655?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bignamehyp", "html_url": "https://github.com/bignamehyp", "followers_url": "https://api.github.com/users/bignamehyp/followers", "following_url": "https://api.github.com/users/bignamehyp/following{/other_user}", "gists_url": "https://api.github.com/users/bignamehyp/gists{/gist_id}", "starred_url": "https://api.github.com/users/bignamehyp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bignamehyp/subscriptions", "organizations_url": "https://api.github.com/users/bignamehyp/orgs", "repos_url": "https://api.github.com/users/bignamehyp/repos", "events_url": "https://api.github.com/users/bignamehyp/events{/privacy}", "received_events_url": "https://api.github.com/users/bignamehyp/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2018-05-18T20:09:07Z", "updated_at": "2018-11-07T22:29:33Z", "closed_at": "2018-11-07T22:29:33Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Y</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 18.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: binary</li>\n<li><strong>TensorFlow version (use command below)</strong>: ('v1.8.0-0-g93bc2e2072', '1.8.0')</li>\n<li><strong>Python version</strong>: 2.7.15</li>\n<li><strong>Bazel version (if compiling from source)</strong>:</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0/7.0</li>\n<li><strong>GPU model and memory</strong>: GeForce GTX 1060 6GB</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>When  all of below conditions is true, tf.shape return NOT correct value.</p>\n<ul>\n<li>use <code>tf.reshape</code> in and out of <code>tf.cond</code> and</li>\n<li><code>tf.reshape</code> inside of <code>tf.cond</code> has unknown shape (-1)</li>\n<li><code>tf.reshape</code> inside of <code>tf.cond</code> reduces or increases rank of tensor</li>\n</ul>\n<p>I have checked that same code doesn't cause error  in TensorFlow 1.7. But TensorFlow 1.8 cause this error.</p>\n<p>I guess this phenomena caused by a failure of branch prediction or error of graph-optimization.</p>\n<h3>Source code / logs</h3>\n<h4>Source code</h4>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">init</span>(<span class=\"pl-smi\">height</span>):\n    orig <span class=\"pl-k\">=</span> tf.zeros(<span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[height])\n    reshaped <span class=\"pl-k\">=</span> tf.reshape(orig, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>[<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>])\n\n    <span class=\"pl-c\"><span class=\"pl-c\">#</span> tf.shape(reshaped) must return [1, 2]. But this actually return [2, 2]. It's WRONG!!</span>\n    reshaped <span class=\"pl-k\">=</span> tf.Print(reshaped, [tf.shape(reshaped)], <span class=\"pl-v\">message</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>tf.shape(reshaped) before tf.cond: <span class=\"pl-pds\">\"</span></span>)\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">true_fn</span>(<span class=\"pl-smi\">t</span>):\n        t <span class=\"pl-k\">=</span> tf.Print(t, [], <span class=\"pl-v\">message</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pass in true_fn<span class=\"pl-pds\">\"</span></span>)\n        <span class=\"pl-k\">return</span> tf.reshape(t, (<span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">1</span>))\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">false_fn</span>(<span class=\"pl-smi\">t</span>):\n        t <span class=\"pl-k\">=</span> tf.Print(t, [], <span class=\"pl-v\">message</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pass in false_fn<span class=\"pl-pds\">\"</span></span>)\n        <span class=\"pl-k\">return</span> tf.reshape(t, (<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">1</span>))\n\n    reshaped <span class=\"pl-k\">=</span> tf.cond(\n        tf.equal(tf.shape(reshaped)[<span class=\"pl-c1\">0</span>], <span class=\"pl-c1\">2</span>), <span class=\"pl-k\">lambda</span>: true_fn(reshaped), <span class=\"pl-k\">lambda</span>: false_fn(reshaped), <span class=\"pl-v\">strict</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)\n\n    reshaped <span class=\"pl-k\">=</span> tf.Print(reshaped, [tf.shape(reshaped)], <span class=\"pl-v\">message</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>tf.shape(reshaped) after tf.cond: <span class=\"pl-pds\">\"</span></span>)\n\n    <span class=\"pl-k\">return</span> reshaped\n\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">main</span>():\n\n    height <span class=\"pl-k\">=</span> tf.placeholder(<span class=\"pl-v\">dtype</span><span class=\"pl-k\">=</span>tf.int32, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span>())\n    reshaped <span class=\"pl-k\">=</span> init(height)\n\n    <span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n        sess.run(reshaped, <span class=\"pl-v\">feed_dict</span><span class=\"pl-k\">=</span>{height: <span class=\"pl-c1\">1</span>})\n\n\n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">__name__</span> <span class=\"pl-k\">==</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>__main__<span class=\"pl-pds\">'</span></span>:\n    main()</pre></div>\n<h4>Log</h4>\n<pre><code>2018-05-19 04:54:10.722065: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning\n NUMA node zero\n2018-05-19 04:54:10.722448: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1356] Found device 0 with properties:\nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7845\npciBusID: 0000:01:00.0\ntotalMemory: 5.94GiB freeMemory: 4.86GiB\n2018-05-19 04:54:10.722467: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1435] Adding visible gpu devices: 0\n2018-05-19 04:54:10.911223: I tensorflow/core/common_runtime/gpu/gpu_device.cc:923] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-05-19 04:54:10.911263: I tensorflow/core/common_runtime/gpu/gpu_device.cc:929]      0\n2018-05-19 04:54:10.911271: I tensorflow/core/common_runtime/gpu/gpu_device.cc:942] 0:   N\n2018-05-19 04:54:10.911466: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1053] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 4623 MB memory) -&gt; physical GPU (device: 0\n, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\ntf.shape(reshaped) before tf.cond: [2]\npass in true_fn\nTraceback (most recent call last):\n  File \"./main.py\", line 40, in &lt;module&gt;\n    main()\n  File \"./main.py\", line 36, in main\n    sess.run(reshaped, feed_dict={height: 1})\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 900, in run\n    run_metadata_ptr)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\n    run_metadata)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1 values, but the requested shape has 2\n         [[Node: cond/Reshape = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](cond/Print/_19, cond/Reshape/shape)]]\n         [[Node: Shape_2/_25 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_26_Shape_2\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n\nCaused by op u'cond/Reshape', defined at:\n  File \"./main.py\", line 40, in &lt;module&gt;\n    main()\n  File \"./main.py\", line 33, in main\n    reshaped = init(height)\n  File \"./main.py\", line 23, in init\n    tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 432, in new_func\n    return func(*args, **kwargs)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2063, in cond\n    orig_res_t, res_t = context_t.BuildCondBranch(true_fn)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1913, in BuildCondBranch\n    original_result = fn()\n  File \"./main.py\", line 23, in &lt;lambda&gt;\n    tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\n  File \"./main.py\", line 16, in true_fn\n    return tf.reshape(t, (2, 1))\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 6113, in reshape\n    \"Reshape\", tensor=tensor, shape=shape, name=name)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\n    op_def=op_def)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): Input to reshape is a tensor with 1 values, but the requested shape has 2\n         [[Node: cond/Reshape = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](cond/Print/_19, cond/Reshape/shape)]]\n         [[Node: Shape_2/_25 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_26_Shape_2\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Y\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 18.04\nTensorFlow installed from (source or binary): binary\nTensorFlow version (use command below): ('v1.8.0-0-g93bc2e2072', '1.8.0')\nPython version: 2.7.15\nBazel version (if compiling from source):\nGCC/Compiler version (if compiling from source):\nCUDA/cuDNN version: 9.0/7.0\nGPU model and memory: GeForce GTX 1060 6GB\nExact command to reproduce:\n\nDescribe the problem\nWhen  all of below conditions is true, tf.shape return NOT correct value.\n\nuse tf.reshape in and out of tf.cond and\ntf.reshape inside of tf.cond has unknown shape (-1)\ntf.reshape inside of tf.cond reduces or increases rank of tensor\n\nI have checked that same code doesn't cause error  in TensorFlow 1.7. But TensorFlow 1.8 cause this error.\nI guess this phenomena caused by a failure of branch prediction or error of graph-optimization.\nSource code / logs\nSource code\nimport tensorflow as tf\n\n\ndef init(height):\n    orig = tf.zeros(shape=[height])\n    reshaped = tf.reshape(orig, shape=[-1])\n\n    # tf.shape(reshaped) must return [1, 2]. But this actually return [2, 2]. It's WRONG!!\n    reshaped = tf.Print(reshaped, [tf.shape(reshaped)], message=\"tf.shape(reshaped) before tf.cond: \")\n\n    def true_fn(t):\n        t = tf.Print(t, [], message=\"pass in true_fn\")\n        return tf.reshape(t, (2, 1))\n\n    def false_fn(t):\n        t = tf.Print(t, [], message=\"pass in false_fn\")\n        return tf.reshape(t, (-1, 1))\n\n    reshaped = tf.cond(\n        tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\n\n    reshaped = tf.Print(reshaped, [tf.shape(reshaped)], message=\"tf.shape(reshaped) after tf.cond: \")\n\n    return reshaped\n\n\ndef main():\n\n    height = tf.placeholder(dtype=tf.int32, shape=())\n    reshaped = init(height)\n\n    with tf.Session() as sess:\n        sess.run(reshaped, feed_dict={height: 1})\n\n\nif __name__ == '__main__':\n    main()\nLog\n2018-05-19 04:54:10.722065: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning\n NUMA node zero\n2018-05-19 04:54:10.722448: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1356] Found device 0 with properties:\nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7845\npciBusID: 0000:01:00.0\ntotalMemory: 5.94GiB freeMemory: 4.86GiB\n2018-05-19 04:54:10.722467: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1435] Adding visible gpu devices: 0\n2018-05-19 04:54:10.911223: I tensorflow/core/common_runtime/gpu/gpu_device.cc:923] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-05-19 04:54:10.911263: I tensorflow/core/common_runtime/gpu/gpu_device.cc:929]      0\n2018-05-19 04:54:10.911271: I tensorflow/core/common_runtime/gpu/gpu_device.cc:942] 0:   N\n2018-05-19 04:54:10.911466: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1053] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 4623 MB memory) -> physical GPU (device: 0\n, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\ntf.shape(reshaped) before tf.cond: [2]\npass in true_fn\nTraceback (most recent call last):\n  File \"./main.py\", line 40, in <module>\n    main()\n  File \"./main.py\", line 36, in main\n    sess.run(reshaped, feed_dict={height: 1})\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 900, in run\n    run_metadata_ptr)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\n    run_metadata)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1 values, but the requested shape has 2\n         [[Node: cond/Reshape = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](cond/Print/_19, cond/Reshape/shape)]]\n         [[Node: Shape_2/_25 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_26_Shape_2\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n\nCaused by op u'cond/Reshape', defined at:\n  File \"./main.py\", line 40, in <module>\n    main()\n  File \"./main.py\", line 33, in main\n    reshaped = init(height)\n  File \"./main.py\", line 23, in init\n    tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 432, in new_func\n    return func(*args, **kwargs)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2063, in cond\n    orig_res_t, res_t = context_t.BuildCondBranch(true_fn)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1913, in BuildCondBranch\n    original_result = fn()\n  File \"./main.py\", line 23, in <lambda>\n    tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\n  File \"./main.py\", line 16, in true_fn\n    return tf.reshape(t, (2, 1))\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 6113, in reshape\n    \"Reshape\", tensor=tensor, shape=shape, name=name)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\n    op_def=op_def)\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\n\nInvalidArgumentError (see above for traceback): Input to reshape is a tensor with 1 values, but the requested shape has 2\n         [[Node: cond/Reshape = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](cond/Print/_19, cond/Reshape/shape)]]\n         [[Node: Shape_2/_25 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_26_Shape_2\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Y\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 18.04\r\n- **TensorFlow installed from (source or binary)**: binary\r\n- **TensorFlow version (use command below)**: ('v1.8.0-0-g93bc2e2072', '1.8.0')\r\n- **Python version**: 2.7.15\r\n- **Bazel version (if compiling from source)**:\r\n- **GCC/Compiler version (if compiling from source)**:\r\n- **CUDA/cuDNN version**: 9.0/7.0\r\n- **GPU model and memory**: GeForce GTX 1060 6GB\r\n- **Exact command to reproduce**:\r\n\r\n### Describe the problem\r\n\r\nWhen  all of below conditions is true, tf.shape return NOT correct value.\r\n* use `tf.reshape` in and out of `tf.cond` and \r\n* `tf.reshape` inside of `tf.cond` has unknown shape (-1)\r\n* `tf.reshape` inside of `tf.cond` reduces or increases rank of tensor\r\n\r\n\r\n\r\nI have checked that same code doesn't cause error  in TensorFlow 1.7. But TensorFlow 1.8 cause this error.\r\n\r\nI guess this phenomena caused by a failure of branch prediction or error of graph-optimization.\r\n\r\n### Source code / logs\r\n\r\n#### Source code\r\n```python\r\nimport tensorflow as tf\r\n\r\n\r\ndef init(height):\r\n    orig = tf.zeros(shape=[height])\r\n    reshaped = tf.reshape(orig, shape=[-1])\r\n\r\n    # tf.shape(reshaped) must return [1, 2]. But this actually return [2, 2]. It's WRONG!!\r\n    reshaped = tf.Print(reshaped, [tf.shape(reshaped)], message=\"tf.shape(reshaped) before tf.cond: \")\r\n\r\n    def true_fn(t):\r\n        t = tf.Print(t, [], message=\"pass in true_fn\")\r\n        return tf.reshape(t, (2, 1))\r\n\r\n    def false_fn(t):\r\n        t = tf.Print(t, [], message=\"pass in false_fn\")\r\n        return tf.reshape(t, (-1, 1))\r\n\r\n    reshaped = tf.cond(\r\n        tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\r\n\r\n    reshaped = tf.Print(reshaped, [tf.shape(reshaped)], message=\"tf.shape(reshaped) after tf.cond: \")\r\n\r\n    return reshaped\r\n\r\n\r\ndef main():\r\n\r\n    height = tf.placeholder(dtype=tf.int32, shape=())\r\n    reshaped = init(height)\r\n\r\n    with tf.Session() as sess:\r\n        sess.run(reshaped, feed_dict={height: 1})\r\n\r\n\r\nif __name__ == '__main__':\r\n    main()\r\n```\r\n\r\n#### Log\r\n```\r\n2018-05-19 04:54:10.722065: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:898] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning\r\n NUMA node zero\r\n2018-05-19 04:54:10.722448: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1356] Found device 0 with properties:\r\nname: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7845\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 5.94GiB freeMemory: 4.86GiB\r\n2018-05-19 04:54:10.722467: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1435] Adding visible gpu devices: 0\r\n2018-05-19 04:54:10.911223: I tensorflow/core/common_runtime/gpu/gpu_device.cc:923] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-05-19 04:54:10.911263: I tensorflow/core/common_runtime/gpu/gpu_device.cc:929]      0\r\n2018-05-19 04:54:10.911271: I tensorflow/core/common_runtime/gpu/gpu_device.cc:942] 0:   N\r\n2018-05-19 04:54:10.911466: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1053] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 4623 MB memory) -> physical GPU (device: 0\r\n, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\ntf.shape(reshaped) before tf.cond: [2]\r\npass in true_fn\r\nTraceback (most recent call last):\r\n  File \"./main.py\", line 40, in <module>\r\n    main()\r\n  File \"./main.py\", line 36, in main\r\n    sess.run(reshaped, feed_dict={height: 1})\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 900, in run\r\n    run_metadata_ptr)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1135, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1316, in _do_run\r\n    run_metadata)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/client/session.py\", line 1335, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1 values, but the requested shape has 2\r\n         [[Node: cond/Reshape = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](cond/Print/_19, cond/Reshape/shape)]]\r\n         [[Node: Shape_2/_25 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_26_Shape_2\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\r\n\r\nCaused by op u'cond/Reshape', defined at:\r\n  File \"./main.py\", line 40, in <module>\r\n    main()\r\n  File \"./main.py\", line 33, in main\r\n    reshaped = init(height)\r\n  File \"./main.py\", line 23, in init\r\n    tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/util/deprecation.py\", line 432, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2063, in cond\r\n    orig_res_t, res_t = context_t.BuildCondBranch(true_fn)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 1913, in BuildCondBranch\r\n    original_result = fn()\r\n  File \"./main.py\", line 23, in <lambda>\r\n    tf.equal(tf.shape(reshaped)[0], 2), lambda: true_fn(reshaped), lambda: false_fn(reshaped), strict=True)\r\n  File \"./main.py\", line 16, in true_fn\r\n    return tf.reshape(t, (2, 1))\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 6113, in reshape\r\n    \"Reshape\", tensor=tensor, shape=shape, name=name)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 3392, in create_op\r\n    op_def=op_def)\r\n  File \"/home/n/anaconda2/envs/tf18/lib/python2.7/site-packages/tensorflow/python/framework/ops.py\", line 1718, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nInvalidArgumentError (see above for traceback): Input to reshape is a tensor with 1 values, but the requested shape has 2\r\n         [[Node: cond/Reshape = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](cond/Print/_19, cond/Reshape/shape)]]\r\n         [[Node: Shape_2/_25 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_26_Shape_2\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\r\n```\r\n\r\n"}