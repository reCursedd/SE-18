{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20566", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20566/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20566/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/20566/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/20566", "id": 338572618, "node_id": "MDU6SXNzdWUzMzg1NzI2MTg=", "number": 20566, "title": "Cannot use warm startup of an estimator with MirroredStrategy", "user": {"login": "jdvylder", "id": 30600355, "node_id": "MDQ6VXNlcjMwNjAwMzU1", "avatar_url": "https://avatars1.githubusercontent.com/u/30600355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jdvylder", "html_url": "https://github.com/jdvylder", "followers_url": "https://api.github.com/users/jdvylder/followers", "following_url": "https://api.github.com/users/jdvylder/following{/other_user}", "gists_url": "https://api.github.com/users/jdvylder/gists{/gist_id}", "starred_url": "https://api.github.com/users/jdvylder/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jdvylder/subscriptions", "organizations_url": "https://api.github.com/users/jdvylder/orgs", "repos_url": "https://api.github.com/users/jdvylder/repos", "events_url": "https://api.github.com/users/jdvylder/events{/privacy}", "received_events_url": "https://api.github.com/users/jdvylder/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 996845227, "node_id": "MDU6TGFiZWw5OTY4NDUyMjc=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:dist-strat", "name": "comp:dist-strat", "color": "0052cc", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "guptapriya", "id": 14104855, "node_id": "MDQ6VXNlcjE0MTA0ODU1", "avatar_url": "https://avatars1.githubusercontent.com/u/14104855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guptapriya", "html_url": "https://github.com/guptapriya", "followers_url": "https://api.github.com/users/guptapriya/followers", "following_url": "https://api.github.com/users/guptapriya/following{/other_user}", "gists_url": "https://api.github.com/users/guptapriya/gists{/gist_id}", "starred_url": "https://api.github.com/users/guptapriya/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guptapriya/subscriptions", "organizations_url": "https://api.github.com/users/guptapriya/orgs", "repos_url": "https://api.github.com/users/guptapriya/repos", "events_url": "https://api.github.com/users/guptapriya/events{/privacy}", "received_events_url": "https://api.github.com/users/guptapriya/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2018-07-05T13:22:14Z", "updated_at": "2018-07-18T18:24:33Z", "closed_at": "2018-07-18T18:24:33Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>:  using nvidia containter: <a href=\"https://docs.nvidia.com/deeplearning/dgx/tensorflow-release-notes/rel_18.06.html#rel_18.06\" rel=\"nofollow\">https://docs.nvidia.com/deeplearning/dgx/tensorflow-release-notes/rel_18.06.html#rel_18.06</a></li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.8.0</li>\n<li><strong>Python version</strong>: 3.5</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>:N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: 9.0.176</li>\n<li><strong>GPU model and memory</strong>: nvidia tesla v100</li>\n<li><strong>Exact command to reproduce</strong>:N/A</li>\n</ul>\n<h3>Describe the problem</h3>\n<p>I'm training an network using tf.estimator where I load a set of variables from an existing checkpoint. This is done using the warm start-up option from the estimator class. While the code works when running on a single GPU, It generates an error when I use the MirroredStrategy.</p>\n<h3>Source code / logs</h3>\n<p>The code:</p>\n<pre><code>ws = tf.estimator.WarmStartSettings(ckpt_to_initialize_from=\"init_checkpoint.ckpt\"),\n                                                vars_to_warm_start=\"^((?!Logits).)*$\"\n                                                )\nself.trainer = tf.estimator.Estimator(\n            model_fn=self.get_model_fn,  # First-class function\n            params=None,  # HParams are passed using the config file\n            config=run_config,\n            warm_start_from=ws\n        )\n</code></pre>\n<p>This generate the following trace:</p>\n<pre><code>Traceback (most recent call last):\n  File \"train.py\", line 37, in &lt;module&gt;\n    experimenter.run_training_experiment(config)\n  File \"/media/local/BDA_tf_framework/neuralnetwork/trainingexperimenter.py\", line 39, in run_training_experiment\n    tf.estimator.train_and_evaluate(self.trainer, self.training_specs, self.eval_specs)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 439, in train_and_evaluate\n    executor.run()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 518, in run\n    self.run_local()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 650, in run_local\n    hooks=train_hooks)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 363, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 841, in _train_model\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 977, in _train_model_distributed\n    saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 986, in _train_with_estimator_spec\n    warm_starting_util.warm_start(*self._warm_start_settings)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/warm_starting_util.py\", line 342, in warm_start\n    _warm_start_var(variable, ckpt_to_initialize_from, prev_var_name)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/warm_starting_util.py\", line 139, in _warm_start_var\n    \"PartitionedVariable, but is {}\".format(type(var)))\nTypeError: var MUST be one of the following: a Variable, list of Variable or PartitionedVariable, but is &lt;class 'tensorflow.contrib.distribute.python.values.MirroredVariable'&gt;\nMakefile:19: recipe for target 'train_gpu' failed\nmake: *** [train_gpu] Error 1\n</code></pre>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\nTensorFlow installed from (source or binary):  using nvidia containter: https://docs.nvidia.com/deeplearning/dgx/tensorflow-release-notes/rel_18.06.html#rel_18.06\nTensorFlow version (use command below): 1.8.0\nPython version: 3.5\nBazel version (if compiling from source): N/A\nGCC/Compiler version (if compiling from source):N/A\nCUDA/cuDNN version: 9.0.176\nGPU model and memory: nvidia tesla v100\nExact command to reproduce:N/A\n\nDescribe the problem\nI'm training an network using tf.estimator where I load a set of variables from an existing checkpoint. This is done using the warm start-up option from the estimator class. While the code works when running on a single GPU, It generates an error when I use the MirroredStrategy.\nSource code / logs\nThe code:\nws = tf.estimator.WarmStartSettings(ckpt_to_initialize_from=\"init_checkpoint.ckpt\"),\n                                                vars_to_warm_start=\"^((?!Logits).)*$\"\n                                                )\nself.trainer = tf.estimator.Estimator(\n            model_fn=self.get_model_fn,  # First-class function\n            params=None,  # HParams are passed using the config file\n            config=run_config,\n            warm_start_from=ws\n        )\n\nThis generate the following trace:\nTraceback (most recent call last):\n  File \"train.py\", line 37, in <module>\n    experimenter.run_training_experiment(config)\n  File \"/media/local/BDA_tf_framework/neuralnetwork/trainingexperimenter.py\", line 39, in run_training_experiment\n    tf.estimator.train_and_evaluate(self.trainer, self.training_specs, self.eval_specs)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 439, in train_and_evaluate\n    executor.run()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 518, in run\n    self.run_local()\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 650, in run_local\n    hooks=train_hooks)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 363, in train\n    loss = self._train_model(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 841, in _train_model\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 977, in _train_model_distributed\n    saving_listeners)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 986, in _train_with_estimator_spec\n    warm_starting_util.warm_start(*self._warm_start_settings)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/warm_starting_util.py\", line 342, in warm_start\n    _warm_start_var(variable, ckpt_to_initialize_from, prev_var_name)\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/warm_starting_util.py\", line 139, in _warm_start_var\n    \"PartitionedVariable, but is {}\".format(type(var)))\nTypeError: var MUST be one of the following: a Variable, list of Variable or PartitionedVariable, but is <class 'tensorflow.contrib.distribute.python.values.MirroredVariable'>\nMakefile:19: recipe for target 'train_gpu' failed\nmake: *** [train_gpu] Error 1", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: yes\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04\r\n- **TensorFlow installed from (source or binary)**:  using nvidia containter: https://docs.nvidia.com/deeplearning/dgx/tensorflow-release-notes/rel_18.06.html#rel_18.06 \r\n- **TensorFlow version (use command below)**: 1.8.0\r\n- **Python version**: 3.5\r\n- **Bazel version (if compiling from source)**: N/A\r\n- **GCC/Compiler version (if compiling from source)**:N/A\r\n- **CUDA/cuDNN version**: 9.0.176\r\n- **GPU model and memory**: nvidia tesla v100\r\n- **Exact command to reproduce**:N/A\r\n\r\n### Describe the problem\r\nI'm training an network using tf.estimator where I load a set of variables from an existing checkpoint. This is done using the warm start-up option from the estimator class. While the code works when running on a single GPU, It generates an error when I use the MirroredStrategy.\r\n\r\n### Source code / logs\r\nThe code:\r\n```\r\nws = tf.estimator.WarmStartSettings(ckpt_to_initialize_from=\"init_checkpoint.ckpt\"),\r\n                                                vars_to_warm_start=\"^((?!Logits).)*$\"\r\n                                                )\r\nself.trainer = tf.estimator.Estimator(\r\n            model_fn=self.get_model_fn,  # First-class function\r\n            params=None,  # HParams are passed using the config file\r\n            config=run_config,\r\n            warm_start_from=ws\r\n        )\r\n```\r\n\r\nThis generate the following trace:\r\n```\r\nTraceback (most recent call last):\r\n  File \"train.py\", line 37, in <module>\r\n    experimenter.run_training_experiment(config)\r\n  File \"/media/local/BDA_tf_framework/neuralnetwork/trainingexperimenter.py\", line 39, in run_training_experiment\r\n    tf.estimator.train_and_evaluate(self.trainer, self.training_specs, self.eval_specs)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 439, in train_and_evaluate\r\n    executor.run()\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 518, in run\r\n    self.run_local()\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/training.py\", line 650, in run_local\r\n    hooks=train_hooks)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 363, in train\r\n    loss = self._train_model(input_fn, hooks, saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 841, in _train_model\r\n    return self._train_model_distributed(input_fn, hooks, saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 977, in _train_model_distributed\r\n    saving_listeners)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/estimator/estimator.py\", line 986, in _train_with_estimator_spec\r\n    warm_starting_util.warm_start(*self._warm_start_settings)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/warm_starting_util.py\", line 342, in warm_start\r\n    _warm_start_var(variable, ckpt_to_initialize_from, prev_var_name)\r\n  File \"/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/warm_starting_util.py\", line 139, in _warm_start_var\r\n    \"PartitionedVariable, but is {}\".format(type(var)))\r\nTypeError: var MUST be one of the following: a Variable, list of Variable or PartitionedVariable, but is <class 'tensorflow.contrib.distribute.python.values.MirroredVariable'>\r\nMakefile:19: recipe for target 'train_gpu' failed\r\nmake: *** [train_gpu] Error 1\r\n```"}