{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/111073133", "pull_request_review_id": 32280177, "id": 111073133, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExMTA3MzEzMw==", "diff_hunk": "@@ -1049,81 +1536,84 @@ Status MklLayoutRewritePass::RewriteNode(std::unique_ptr<Graph>* g, Node* orign,\n   }\n \n   // Get all inputs.\n-  const int num = orign->num_inputs();\n-  CHECK_EQ(num, ri->numins);\n+  const int num = orig_node->in_edges().size();\n+  // Check the number of inputs against the user-specified value for non-vararg\n+  // nodes.\n+  if (!IsVarArgNode(orig_node)) {\n+    CHECK_EQ(num, ri->num_ins);\n+  }\n   gtl::InlinedVector<Node*, 4> control_edges;\n   gtl::InlinedVector<std::pair<Node*, int>, 4> inputs(num);\n-  FillInputs(orign, &control_edges, &inputs);\n+  FillInputs(orig_node, &control_edges, &inputs);\n \n   // Build new node. We use same name as original node, but change the op name.\n-  NodeBuilder nb(orign->name().c_str(), ri->newname.c_str());\n+  NodeBuilder nb(orig_node->name().c_str(), ri->new_name.c_str());\n   // Copy user-specified device assigned to original node to new node.\n-  nb.Device(orign->def().device());\n+  nb.Device(orig_node->def().device());\n   // Set up new inputs to the rewritten node.\n-  Status s = SetUpInputs(g, inputs, &nb, orign);\n+  Status s = SetUpInputs(g, inputs, &nb, orig_node);\n   if (s != Status::OK()) {\n     return s;\n   }\n \n   // Copy attributes from original node to new node (for scenario 1).\n   // For context-based rewrite, we use context to copy the attributes.\n   if (is_context_based_rewrite) {\n-    if (orign->type_string() == csinfo_.biasaddgrad &&\n-        ri->newname == csinfo_.mklconv2dwithbiasbackpropbias) {\n-      CHECK_NOTNULL(fwdn);\n-      ri->copyattrs(fwdn, &nb);\n+    if (orig_node->type_string() == csinfo_.bias_add_grad &&\n+        ri->new_name == csinfo_.mkl_conv2d_with_bias_backprop_bias) {\n+      CHECK_NOTNULL(fwd_node);\n+      ri->copy_attrs(fwd_node, &nb);\n     } else {\n       return Status(error::Code::UNIMPLEMENTED,\n                     \"Unimplemented case for node rewrite optimization.\");\n     }\n   } else {\n-    ri->copyattrs(const_cast<const Node*>(orign), &nb);\n+    ri->copy_attrs(const_cast<const Node*>(orig_node), &nb);\n   }\n   // Set the Mkl layer label for this op.\n-  nb.Attr(\"_kernel\", mkl_layer_registry::kMklLayerLabel);\n-\n-  // Add workspace edge to this node if needed.\n-  // We add workspace edge only for MaxPool, LRN and BatchNorm.\n-  AddWorkSpaceEdgeIfNeeded(g, orign, &nb);\n+  nb.Attr(\"_kernel\", mkl_op_registry::kMklOpLabel);\n \n   // Finalize graph and get new node.\n   Node* newn = nullptr;", "path": "tensorflow/core/graph/mkl_layout_pass.cc", "position": null, "original_position": 1441, "commit_id": "b5ef5bfcb39a0ba0cef4e1f7e9d766344f918ab2", "original_commit_id": "67f9925ef9ceed02892c200a3122092ab497943a", "user": {"login": "zhangyaobit", "id": 1034716, "node_id": "MDQ6VXNlcjEwMzQ3MTY=", "avatar_url": "https://avatars3.githubusercontent.com/u/1034716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zhangyaobit", "html_url": "https://github.com/zhangyaobit", "followers_url": "https://api.github.com/users/zhangyaobit/followers", "following_url": "https://api.github.com/users/zhangyaobit/following{/other_user}", "gists_url": "https://api.github.com/users/zhangyaobit/gists{/gist_id}", "starred_url": "https://api.github.com/users/zhangyaobit/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zhangyaobit/subscriptions", "organizations_url": "https://api.github.com/users/zhangyaobit/orgs", "repos_url": "https://api.github.com/users/zhangyaobit/repos", "events_url": "https://api.github.com/users/zhangyaobit/events{/privacy}", "received_events_url": "https://api.github.com/users/zhangyaobit/received_events", "type": "User", "site_admin": false}, "body": "newn->new_node?", "created_at": "2017-04-12T06:31:37Z", "updated_at": "2017-04-13T23:37:54Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/8968#discussion_r111073133", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/8968", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/111073133"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/8968#discussion_r111073133"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/8968"}}, "body_html": "<p>newn-&gt;new_node?</p>", "body_text": "newn->new_node?"}