{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16856", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16856/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16856/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16856/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/16856", "id": 295414601, "node_id": "MDU6SXNzdWUyOTU0MTQ2MDE=", "number": 16856, "title": "Loading model from local in RNN prediction is slower than from HDFS due to page fault ", "user": {"login": "kdmxen", "id": 36218095, "node_id": "MDQ6VXNlcjM2MjE4MDk1", "avatar_url": "https://avatars0.githubusercontent.com/u/36218095?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kdmxen", "html_url": "https://github.com/kdmxen", "followers_url": "https://api.github.com/users/kdmxen/followers", "following_url": "https://api.github.com/users/kdmxen/following{/other_user}", "gists_url": "https://api.github.com/users/kdmxen/gists{/gist_id}", "starred_url": "https://api.github.com/users/kdmxen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kdmxen/subscriptions", "organizations_url": "https://api.github.com/users/kdmxen/orgs", "repos_url": "https://api.github.com/users/kdmxen/repos", "events_url": "https://api.github.com/users/kdmxen/events{/privacy}", "received_events_url": "https://api.github.com/users/kdmxen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 404586558, "node_id": "MDU6TGFiZWw0MDQ1ODY1NTg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:community%20support", "name": "stat:community support", "color": "f4b400", "default": false}, {"id": 299643928, "node_id": "MDU6TGFiZWwyOTk2NDM5Mjg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:contributions%20welcome", "name": "stat:contributions welcome", "color": "f4b400", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2018-02-08T07:49:10Z", "updated_at": "2018-07-12T14:18:08Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>We have trained a RNN model and use it to predict. We feed some data and calculate QPS in prediction. We find that when CPU usage is above than 30%, the QPS always stayed in 900+. And not increasing linearly by CPU usage. But if we put the model in HDFS, The QPS can reach 2400+.</p>\n<p>Our system infomation:</p>\n<pre><code>    OS:  RedHat 7.2\n    CPU:  2 * 16 core * 2 thread\n    Memory: 512G in 1 node\n</code></pre>\n<p>In local model case, we use performance tool to trace function call time and find nearly 20% time hanged in page fault which lead to spin_lock.  Those page fault occurs less than 1% in hdfs situation.</p>\n<p>Our performance result listed as below:</p>\n<p><strong>model loading from local</strong>:<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/36218095/35960886-6ab0bbf6-0ce6-11e8-9923-63fc9257112f.png\"><img src=\"https://user-images.githubusercontent.com/36218095/35960886-6ab0bbf6-0ce6-11e8-9923-63fc9257112f.png\" alt=\"local\" style=\"max-width:100%;\"></a></p>\n<p><strong>model loading from hdfs</strong>:<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/36218095/35960906-7e8d9158-0ce6-11e8-896e-a52fced8c02a.png\"><img src=\"https://user-images.githubusercontent.com/36218095/35960906-7e8d9158-0ce6-11e8-896e-a52fced8c02a.png\" alt=\"hdfs\" style=\"max-width:100%;\"></a></p>\n<p>We check the source code (both eigen and tensorflow ) again and again and can not find any suspectable code which lead to page fault. we test loading model (wide and deep, cnn), page fault not happened. In RNN model we modify the code use HDFS file sytem instead of posix file system. page fault not happend too. we print log in every function in core/platform/posix/posix_file_system.cc. The log is only displayed in model loading, not occurs in prediction process.</p>\n<p>Is anyone can help us to find out this problem? Thank you!</p>", "body_text": "We have trained a RNN model and use it to predict. We feed some data and calculate QPS in prediction. We find that when CPU usage is above than 30%, the QPS always stayed in 900+. And not increasing linearly by CPU usage. But if we put the model in HDFS, The QPS can reach 2400+.\nOur system infomation:\n    OS:  RedHat 7.2\n    CPU:  2 * 16 core * 2 thread\n    Memory: 512G in 1 node\n\nIn local model case, we use performance tool to trace function call time and find nearly 20% time hanged in page fault which lead to spin_lock.  Those page fault occurs less than 1% in hdfs situation.\nOur performance result listed as below:\nmodel loading from local:\n\nmodel loading from hdfs:\n\nWe check the source code (both eigen and tensorflow ) again and again and can not find any suspectable code which lead to page fault. we test loading model (wide and deep, cnn), page fault not happened. In RNN model we modify the code use HDFS file sytem instead of posix file system. page fault not happend too. we print log in every function in core/platform/posix/posix_file_system.cc. The log is only displayed in model loading, not occurs in prediction process.\nIs anyone can help us to find out this problem? Thank you!", "body": "We have trained a RNN model and use it to predict. We feed some data and calculate QPS in prediction. We find that when CPU usage is above than 30%, the QPS always stayed in 900+. And not increasing linearly by CPU usage. But if we put the model in HDFS, The QPS can reach 2400+.\r\n\r\nOur system infomation:\r\n```\r\n    OS:  RedHat 7.2\r\n    CPU:  2 * 16 core * 2 thread\r\n    Memory: 512G in 1 node\r\n```\r\n\r\nIn local model case, we use performance tool to trace function call time and find nearly 20% time hanged in page fault which lead to spin_lock.  Those page fault occurs less than 1% in hdfs situation. \r\n\r\nOur performance result listed as below:\r\n\r\n**model loading from local**:\r\n![local](https://user-images.githubusercontent.com/36218095/35960886-6ab0bbf6-0ce6-11e8-9923-63fc9257112f.png)\r\n\r\n**model loading from hdfs**:\r\n![hdfs](https://user-images.githubusercontent.com/36218095/35960906-7e8d9158-0ce6-11e8-896e-a52fced8c02a.png)\r\n\r\nWe check the source code (both eigen and tensorflow ) again and again and can not find any suspectable code which lead to page fault. we test loading model (wide and deep, cnn), page fault not happened. In RNN model we modify the code use HDFS file sytem instead of posix file system. page fault not happend too. we print log in every function in core/platform/posix/posix_file_system.cc. The log is only displayed in model loading, not occurs in prediction process. \r\n\r\nIs anyone can help us to find out this problem? Thank you!\r\n\r\n\r\n"}