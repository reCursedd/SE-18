{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22723", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22723/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22723/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/22723/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/22723", "id": 366718886, "node_id": "MDU6SXNzdWUzNjY3MTg4ODY=", "number": 22723, "title": "bug: tf.train.Saver.save() fails if 2 tf.contrib.cudnn_rnn.cudnnLSTM instances passed to saver are built with build() method", "user": {"login": "PeganovAnton", "id": 10737305, "node_id": "MDQ6VXNlcjEwNzM3MzA1", "avatar_url": "https://avatars3.githubusercontent.com/u/10737305?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PeganovAnton", "html_url": "https://github.com/PeganovAnton", "followers_url": "https://api.github.com/users/PeganovAnton/followers", "following_url": "https://api.github.com/users/PeganovAnton/following{/other_user}", "gists_url": "https://api.github.com/users/PeganovAnton/gists{/gist_id}", "starred_url": "https://api.github.com/users/PeganovAnton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PeganovAnton/subscriptions", "organizations_url": "https://api.github.com/users/PeganovAnton/orgs", "repos_url": "https://api.github.com/users/PeganovAnton/repos", "events_url": "https://api.github.com/users/PeganovAnton/events{/privacy}", "received_events_url": "https://api.github.com/users/PeganovAnton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1097547147, "node_id": "MDU6TGFiZWwxMDk3NTQ3MTQ3", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:ops", "name": "comp:ops", "color": "0052cc", "default": false}, {"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "protoget", "id": 5117188, "node_id": "MDQ6VXNlcjUxMTcxODg=", "avatar_url": "https://avatars1.githubusercontent.com/u/5117188?v=4", "gravatar_id": "", "url": "https://api.github.com/users/protoget", "html_url": "https://github.com/protoget", "followers_url": "https://api.github.com/users/protoget/followers", "following_url": "https://api.github.com/users/protoget/following{/other_user}", "gists_url": "https://api.github.com/users/protoget/gists{/gist_id}", "starred_url": "https://api.github.com/users/protoget/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/protoget/subscriptions", "organizations_url": "https://api.github.com/users/protoget/orgs", "repos_url": "https://api.github.com/users/protoget/repos", "events_url": "https://api.github.com/users/protoget/events{/privacy}", "received_events_url": "https://api.github.com/users/protoget/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "protoget", "id": 5117188, "node_id": "MDQ6VXNlcjUxMTcxODg=", "avatar_url": "https://avatars1.githubusercontent.com/u/5117188?v=4", "gravatar_id": "", "url": "https://api.github.com/users/protoget", "html_url": "https://github.com/protoget", "followers_url": "https://api.github.com/users/protoget/followers", "following_url": "https://api.github.com/users/protoget/following{/other_user}", "gists_url": "https://api.github.com/users/protoget/gists{/gist_id}", "starred_url": "https://api.github.com/users/protoget/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/protoget/subscriptions", "organizations_url": "https://api.github.com/users/protoget/orgs", "repos_url": "https://api.github.com/users/protoget/repos", "events_url": "https://api.github.com/users/protoget/events{/privacy}", "received_events_url": "https://api.github.com/users/protoget/received_events", "type": "User", "site_admin": false}, {"login": "harshini-gadige", "id": 42781361, "node_id": "MDQ6VXNlcjQyNzgxMzYx", "avatar_url": "https://avatars1.githubusercontent.com/u/42781361?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harshini-gadige", "html_url": "https://github.com/harshini-gadige", "followers_url": "https://api.github.com/users/harshini-gadige/followers", "following_url": "https://api.github.com/users/harshini-gadige/following{/other_user}", "gists_url": "https://api.github.com/users/harshini-gadige/gists{/gist_id}", "starred_url": "https://api.github.com/users/harshini-gadige/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harshini-gadige/subscriptions", "organizations_url": "https://api.github.com/users/harshini-gadige/orgs", "repos_url": "https://api.github.com/users/harshini-gadige/repos", "events_url": "https://api.github.com/users/harshini-gadige/events{/privacy}", "received_events_url": "https://api.github.com/users/harshini-gadige/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2018-10-04T10:17:11Z", "updated_at": "2018-10-23T11:38:26Z", "closed_at": "2018-10-23T11:38:26Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li>\n<p><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</p>\n</li>\n<li>\n<p><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux Ubuntu 16.04.5 LTS</p>\n</li>\n<li>\n<p><strong>Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy)</strong>: N/A</p>\n</li>\n<li>\n<p><strong>TensorFlow installed from (source or binary)</strong>: binary</p>\n</li>\n<li>\n<p><strong>TensorFlow version (use command below)</strong>: v1.10.1-0-g4dcfddc5d1 1.10.1</p>\n</li>\n<li>\n<p><strong>Python version</strong>: 3.6.0</p>\n</li>\n<li>\n<p><strong>Bazel version (if compiling from source)</strong>: N/A</p>\n</li>\n<li>\n<p><strong>CUDA/cuDNN version</strong>:<br>\nCUDA Version 9.0.176<br>\ncudnn: 7.1.4</p>\n</li>\n<li>\n<p><strong>GPU model and memory</strong>:<br>\nNVIDIA GeForce GTX 1080 Ti<br>\n11GB</p>\n</li>\n<li>\n<p><strong>Exact command to reproduce</strong>:<br>\n<code>python test.py</code></p>\n</li>\n</ul>\n<h3>Describe the problem</h3>\n<p><strong>Description</strong><br>\nIf 2 instances of <code>tensorflow.contrib.cudnn_rnn.CudnnLSTM</code> are built via <code>build()</code> method they can not be saved together in a checkpoint.</p>\n<p><strong>Bug borders</strong><br>\nIf instances are built implicitly in <code>__call__()</code>, no exceptions are thrown. Next code executes OK.</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> os\n<span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> tensorflow.contrib.cudnn_rnn <span class=\"pl-k\">import</span> CudnnLSTM <span class=\"pl-k\">as</span> CudnnLSTM\ninp <span class=\"pl-k\">=</span> tf.zeros([<span class=\"pl-c1\">10</span>, <span class=\"pl-c1\">32</span>, <span class=\"pl-c1\">100</span>])\nlstm1 <span class=\"pl-k\">=</span> CudnnLSTM(<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">128</span>)\nlstm2 <span class=\"pl-k\">=</span> CudnnLSTM(<span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">256</span>)\nlstm1(inp)\nlstm2(inp)\nsaver <span class=\"pl-k\">=</span> tf.train.Saver()\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    sess.run(tf.global_variables_initializer())\n    save_path <span class=\"pl-k\">=</span> os.path.join(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test_cudnn_lstm_save<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>1<span class=\"pl-pds\">'</span></span>)\n    <span class=\"pl-k\">if</span> <span class=\"pl-k\">not</span> os.path.exists(save_path):\n        os.makedirs(os.path.join(save_path))\n    saver.save(sess, save_path)</pre></div>\n<p>Also if only 1 instance is built using <code>build()</code> or if only 1 instance is passed to saver in <code>var_list</code> (see ex\u0441erpt below), save op is executed without exceptions.</p>\n<div class=\"highlight highlight-source-python\"><pre>saver <span class=\"pl-k\">=</span> tf.train.Saver([lstm1.saveable])</pre></div>\n<p><strong>Relevance</strong><br>\nI ran into this problem when tried to train my net on several GPUs. Shared CudnnLSTM params are built on CPU, while computations are made on GPUs.</p>\n<p>Thank you in advance for any help!</p>\n<h3>Source code / logs</h3>\n<p>Code to reproduce the bug</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> os\n<span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> tensorflow.contrib.cudnn_rnn <span class=\"pl-k\">import</span> CudnnLSTM <span class=\"pl-k\">as</span> CudnnLSTM\ninp <span class=\"pl-k\">=</span> tf.zeros([<span class=\"pl-c1\">10</span>, <span class=\"pl-c1\">32</span>, <span class=\"pl-c1\">100</span>])\nlstm1 <span class=\"pl-k\">=</span> CudnnLSTM(<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">128</span>)\nlstm2 <span class=\"pl-k\">=</span> CudnnLSTM(<span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">256</span>)\nlstm1.build(inp.shape)\nlstm2.build(inp.shape)\nsaver <span class=\"pl-k\">=</span> tf.train.Saver()\n<span class=\"pl-k\">with</span> tf.Session() <span class=\"pl-k\">as</span> sess:\n    sess.run(tf.global_variables_initializer())\n    save_path <span class=\"pl-k\">=</span> os.path.join(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test_cudnn_lstm_save<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>1<span class=\"pl-pds\">'</span></span>)\n    <span class=\"pl-k\">if</span> <span class=\"pl-k\">not</span> os.path.exists(save_path):\n        os.makedirs(os.path.join(save_path))\n    saver.save(sess, save_path)</pre></div>\n<p>Here is a traceback</p>\n<pre><code>2018-10-04 12:59:46.556727: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-10-04 12:59:46.635329: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-10-04 12:59:46.635669: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 0 with properties: \nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\npciBusID: 0000:01:00.0\ntotalMemory: 10.92GiB freeMemory: 10.01GiB\n2018-10-04 12:59:46.635682: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0\n2018-10-04 12:59:46.841898: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-10-04 12:59:46.841930: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 \n2018-10-04 12:59:46.841937: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N \n2018-10-04 12:59:46.842099: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9673 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:01:00.0, compute capability: 6.1)\n2018-10-04 12:59:47.465382: W tensorflow/core/framework/op_kernel.cc:1275] OP_REQUIRES failed at save_restore_v2_ops.cc:134 : Invalid argument: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\nTraceback (most recent call last):\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1278, in _do_call\n    return fn(*args)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1263, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1350, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"test.py\", line 17, in &lt;module&gt;\n    saver.save(sess, save_path)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1620, in save\n    {self.saver_def.filename_tensor_name: checkpoint_file})\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 877, in run\n    run_metadata_ptr)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1100, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1272, in _do_run\n    run_metadata)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1291, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\n\nCaused by op 'save/SaveV2', defined at:\n  File \"test.py\", line 11, in &lt;module&gt;\n    saver = tf.train.Saver()\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1281, in __init__\n    self.build()\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1293, in build\n    self._build(self._filename, build_save=True, build_restore=True)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1330, in _build\n    build_save=build_save, build_restore=build_restore)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 775, in _build_internal\n    save_tensor = self._AddSaveOps(filename_tensor, saveables)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 275, in _AddSaveOps\n    save = self.save_op(filename_tensor, saveables)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 193, in save_op\n    tensors)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/ops/gen_io_ops.py\", line 1687, in save_v2\n    shape_and_slices=shape_and_slices, tensors=tensors, name=name)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 454, in new_func\n    return func(*args, **kwargs)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3155, in create_op\n    op_def=op_def)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1717, in __init__\n    self._traceback = tf_stack.extract_stack()\n\nInvalidArgumentError (see above for traceback): Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\n</code></pre>", "body_text": "System information\n\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\n\n\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04.5 LTS\n\n\nMobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy): N/A\n\n\nTensorFlow installed from (source or binary): binary\n\n\nTensorFlow version (use command below): v1.10.1-0-g4dcfddc5d1 1.10.1\n\n\nPython version: 3.6.0\n\n\nBazel version (if compiling from source): N/A\n\n\nCUDA/cuDNN version:\nCUDA Version 9.0.176\ncudnn: 7.1.4\n\n\nGPU model and memory:\nNVIDIA GeForce GTX 1080 Ti\n11GB\n\n\nExact command to reproduce:\npython test.py\n\n\nDescribe the problem\nDescription\nIf 2 instances of tensorflow.contrib.cudnn_rnn.CudnnLSTM are built via build() method they can not be saved together in a checkpoint.\nBug borders\nIf instances are built implicitly in __call__(), no exceptions are thrown. Next code executes OK.\nimport os\nimport tensorflow as tf\nfrom tensorflow.contrib.cudnn_rnn import CudnnLSTM as CudnnLSTM\ninp = tf.zeros([10, 32, 100])\nlstm1 = CudnnLSTM(1, 128)\nlstm2 = CudnnLSTM(2, 256)\nlstm1(inp)\nlstm2(inp)\nsaver = tf.train.Saver()\nwith tf.Session() as sess:\n    sess.run(tf.global_variables_initializer())\n    save_path = os.path.join('test_cudnn_lstm_save', '1')\n    if not os.path.exists(save_path):\n        os.makedirs(os.path.join(save_path))\n    saver.save(sess, save_path)\nAlso if only 1 instance is built using build() or if only 1 instance is passed to saver in var_list (see ex\u0441erpt below), save op is executed without exceptions.\nsaver = tf.train.Saver([lstm1.saveable])\nRelevance\nI ran into this problem when tried to train my net on several GPUs. Shared CudnnLSTM params are built on CPU, while computations are made on GPUs.\nThank you in advance for any help!\nSource code / logs\nCode to reproduce the bug\nimport os\nimport tensorflow as tf\nfrom tensorflow.contrib.cudnn_rnn import CudnnLSTM as CudnnLSTM\ninp = tf.zeros([10, 32, 100])\nlstm1 = CudnnLSTM(1, 128)\nlstm2 = CudnnLSTM(2, 256)\nlstm1.build(inp.shape)\nlstm2.build(inp.shape)\nsaver = tf.train.Saver()\nwith tf.Session() as sess:\n    sess.run(tf.global_variables_initializer())\n    save_path = os.path.join('test_cudnn_lstm_save', '1')\n    if not os.path.exists(save_path):\n        os.makedirs(os.path.join(save_path))\n    saver.save(sess, save_path)\nHere is a traceback\n2018-10-04 12:59:46.556727: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n2018-10-04 12:59:46.635329: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\n2018-10-04 12:59:46.635669: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 0 with properties: \nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\npciBusID: 0000:01:00.0\ntotalMemory: 10.92GiB freeMemory: 10.01GiB\n2018-10-04 12:59:46.635682: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0\n2018-10-04 12:59:46.841898: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\n2018-10-04 12:59:46.841930: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 \n2018-10-04 12:59:46.841937: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N \n2018-10-04 12:59:46.842099: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9673 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:01:00.0, compute capability: 6.1)\n2018-10-04 12:59:47.465382: W tensorflow/core/framework/op_kernel.cc:1275] OP_REQUIRES failed at save_restore_v2_ops.cc:134 : Invalid argument: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\nTraceback (most recent call last):\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1278, in _do_call\n    return fn(*args)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1263, in _run_fn\n    options, feed_dict, fetch_list, target_list, run_metadata)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1350, in _call_tf_sessionrun\n    run_metadata)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"test.py\", line 17, in <module>\n    saver.save(sess, save_path)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1620, in save\n    {self.saver_def.filename_tensor_name: checkpoint_file})\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 877, in run\n    run_metadata_ptr)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1100, in _run\n    feed_dict_tensor, options, run_metadata)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1272, in _do_run\n    run_metadata)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1291, in _do_call\n    raise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\n\nCaused by op 'save/SaveV2', defined at:\n  File \"test.py\", line 11, in <module>\n    saver = tf.train.Saver()\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1281, in __init__\n    self.build()\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1293, in build\n    self._build(self._filename, build_save=True, build_restore=True)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1330, in _build\n    build_save=build_save, build_restore=build_restore)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 775, in _build_internal\n    save_tensor = self._AddSaveOps(filename_tensor, saveables)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 275, in _AddSaveOps\n    save = self.save_op(filename_tensor, saveables)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 193, in save_op\n    tensors)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/ops/gen_io_ops.py\", line 1687, in save_v2\n    shape_and_slices=shape_and_slices, tensors=tensors, name=name)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n    op_def=op_def)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 454, in new_func\n    return func(*args, **kwargs)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3155, in create_op\n    op_def=op_def)\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1717, in __init__\n    self._traceback = tf_stack.extract_stack()\n\nInvalidArgumentError (see above for traceback): Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes\r\n\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux Ubuntu 16.04.5 LTS\r\n\r\n- **Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy)**: N/A\r\n\r\n- **TensorFlow installed from (source or binary)**: binary\r\n\r\n- **TensorFlow version (use command below)**: v1.10.1-0-g4dcfddc5d1 1.10.1\r\n\r\n- **Python version**: 3.6.0\r\n\r\n- **Bazel version (if compiling from source)**: N/A\r\n\r\n- **CUDA/cuDNN version**:\r\nCUDA Version 9.0.176\r\ncudnn: 7.1.4\r\n\r\n- **GPU model and memory**:\r\nNVIDIA GeForce GTX 1080 Ti\r\n11GB\r\n\r\n- **Exact command to reproduce**:\r\n`python test.py`\r\n\r\n\r\n### Describe the problem\r\n**Description** \r\nIf 2 instances of `tensorflow.contrib.cudnn_rnn.CudnnLSTM` are built via `build()` method they can not be saved together in a checkpoint. \r\n\r\n**Bug borders**\r\nIf instances are built implicitly in `__call__()`, no exceptions are thrown. Next code executes OK.\r\n\r\n```python\r\nimport os\r\nimport tensorflow as tf\r\nfrom tensorflow.contrib.cudnn_rnn import CudnnLSTM as CudnnLSTM\r\ninp = tf.zeros([10, 32, 100])\r\nlstm1 = CudnnLSTM(1, 128)\r\nlstm2 = CudnnLSTM(2, 256)\r\nlstm1(inp)\r\nlstm2(inp)\r\nsaver = tf.train.Saver()\r\nwith tf.Session() as sess:\r\n    sess.run(tf.global_variables_initializer())\r\n    save_path = os.path.join('test_cudnn_lstm_save', '1')\r\n    if not os.path.exists(save_path):\r\n        os.makedirs(os.path.join(save_path))\r\n    saver.save(sess, save_path)\r\n```\r\n\r\n Also if only 1 instance is built using `build()` or if only 1 instance is passed to saver in `var_list` (see ex\u0441erpt below), save op is executed without exceptions.\r\n\r\n```python\r\nsaver = tf.train.Saver([lstm1.saveable])\r\n```\r\n\r\n**Relevance**\r\nI ran into this problem when tried to train my net on several GPUs. Shared CudnnLSTM params are built on CPU, while computations are made on GPUs.\r\n\r\nThank you in advance for any help!\r\n\r\n### Source code / logs\r\nCode to reproduce the bug\r\n\r\n```python\r\nimport os\r\nimport tensorflow as tf\r\nfrom tensorflow.contrib.cudnn_rnn import CudnnLSTM as CudnnLSTM\r\ninp = tf.zeros([10, 32, 100])\r\nlstm1 = CudnnLSTM(1, 128)\r\nlstm2 = CudnnLSTM(2, 256)\r\nlstm1.build(inp.shape)\r\nlstm2.build(inp.shape)\r\nsaver = tf.train.Saver()\r\nwith tf.Session() as sess:\r\n    sess.run(tf.global_variables_initializer())\r\n    save_path = os.path.join('test_cudnn_lstm_save', '1')\r\n    if not os.path.exists(save_path):\r\n        os.makedirs(os.path.join(save_path))\r\n    saver.save(sess, save_path)\r\n```\r\n\r\nHere is a traceback\r\n```\r\n2018-10-04 12:59:46.556727: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\r\n2018-10-04 12:59:46.635329: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:897] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero\r\n2018-10-04 12:59:46.635669: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1405] Found device 0 with properties: \r\nname: GeForce GTX 1080 Ti major: 6 minor: 1 memoryClockRate(GHz): 1.582\r\npciBusID: 0000:01:00.0\r\ntotalMemory: 10.92GiB freeMemory: 10.01GiB\r\n2018-10-04 12:59:46.635682: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1484] Adding visible gpu devices: 0\r\n2018-10-04 12:59:46.841898: I tensorflow/core/common_runtime/gpu/gpu_device.cc:965] Device interconnect StreamExecutor with strength 1 edge matrix:\r\n2018-10-04 12:59:46.841930: I tensorflow/core/common_runtime/gpu/gpu_device.cc:971]      0 \r\n2018-10-04 12:59:46.841937: I tensorflow/core/common_runtime/gpu/gpu_device.cc:984] 0:   N \r\n2018-10-04 12:59:46.842099: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1097] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 9673 MB memory) -> physical GPU (device: 0, name: GeForce GTX 1080 Ti, pci bus id: 0000:01:00.0, compute capability: 6.1)\r\n2018-10-04 12:59:47.465382: W tensorflow/core/framework/op_kernel.cc:1275] OP_REQUIRES failed at save_restore_v2_ops.cc:134 : Invalid argument: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\r\nTraceback (most recent call last):\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1278, in _do_call\r\n    return fn(*args)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1263, in _run_fn\r\n    options, feed_dict, fetch_list, target_list, run_metadata)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1350, in _call_tf_sessionrun\r\n    run_metadata)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\r\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 17, in <module>\r\n    saver.save(sess, save_path)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1620, in save\r\n    {self.saver_def.filename_tensor_name: checkpoint_file})\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 877, in run\r\n    run_metadata_ptr)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1100, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1272, in _do_run\r\n    run_metadata)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1291, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\r\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\r\n\r\nCaused by op 'save/SaveV2', defined at:\r\n  File \"test.py\", line 11, in <module>\r\n    saver = tf.train.Saver()\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1281, in __init__\r\n    self.build()\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1293, in build\r\n    self._build(self._filename, build_save=True, build_restore=True)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 1330, in _build\r\n    build_save=build_save, build_restore=build_restore)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 775, in _build_internal\r\n    save_tensor = self._AddSaveOps(filename_tensor, saveables)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 275, in _AddSaveOps\r\n    save = self.save_op(filename_tensor, saveables)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/training/saver.py\", line 193, in save_op\r\n    tensors)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/ops/gen_io_ops.py\", line 1687, in save_v2\r\n    shape_and_slices=shape_and_slices, tensors=tensors, name=name)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 454, in new_func\r\n    return func(*args, **kwargs)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3155, in create_op\r\n    op_def=op_def)\r\n  File \"/home/anton/dpenv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1717, in __init__\r\n    self._traceback = tf_stack.extract_stack()\r\n\r\nInvalidArgumentError (see above for traceback): Adding duplicate key: rnn/multi_rnn_cell/cell_0/cudnn_compatible_lstm_cell/kernel\r\n         [[Node: save/SaveV2 = SaveV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](_arg_save/Const_0_0, save/SaveV2/tensor_names, save/SaveV2/shape_and_slices, cudnn_lstm/opaque_kernel/_1, transpose/_3, concat_5/_5, cudnn_lstm_1/opaque_kernel/_7, transpose_1/_9, transpose_2/_11, concat_11/_13, concat_17/_15)]]\r\n```"}