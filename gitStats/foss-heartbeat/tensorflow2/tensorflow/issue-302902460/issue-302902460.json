{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17494", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17494/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17494/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/17494/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/17494", "id": 302902460, "node_id": "MDU6SXNzdWUzMDI5MDI0NjA=", "number": 17494, "title": "TF1.6 MKL bug in concatenation op", "user": {"login": "mas-dse-greina", "id": 22306322, "node_id": "MDQ6VXNlcjIyMzA2MzIy", "avatar_url": "https://avatars0.githubusercontent.com/u/22306322?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mas-dse-greina", "html_url": "https://github.com/mas-dse-greina", "followers_url": "https://api.github.com/users/mas-dse-greina/followers", "following_url": "https://api.github.com/users/mas-dse-greina/following{/other_user}", "gists_url": "https://api.github.com/users/mas-dse-greina/gists{/gist_id}", "starred_url": "https://api.github.com/users/mas-dse-greina/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mas-dse-greina/subscriptions", "organizations_url": "https://api.github.com/users/mas-dse-greina/orgs", "repos_url": "https://api.github.com/users/mas-dse-greina/repos", "events_url": "https://api.github.com/users/mas-dse-greina/events{/privacy}", "received_events_url": "https://api.github.com/users/mas-dse-greina/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 57, "created_at": "2018-03-06T23:05:29Z", "updated_at": "2018-11-15T17:09:11Z", "closed_at": "2018-08-07T20:25:49Z", "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes.</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux CentOS 7</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: Binary (Intel MKL wheel) <a href=\"https://software.intel.com/en-us/articles/intel-optimized-tensorflow-wheel-now-available\" rel=\"nofollow\">https://software.intel.com/en-us/articles/intel-optimized-tensorflow-wheel-now-available</a></li>\n<li><strong>TensorFlow version (use command below)</strong>: b'unknown' 1.6.0</li>\n<li><strong>Python version</strong>: 3.6</li>\n<li><strong>Bazel version (if compiling from source)</strong>: N/A</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: N/A</li>\n<li><strong>CUDA/cuDNN version</strong>: N/A</li>\n<li><strong>GPU model and memory</strong>: N/A</li>\n<li><strong>Exact command to reproduce</strong>:<br>\nU-Net model graph compiles but error during training from concatenation op.<br>\nThe code is here: <a href=\"https://github.com/mas-dse-greina/unet/blob/master/train.py\">https://github.com/mas-dse-greina/unet/blob/master/train.py</a></li>\n</ul>\n<p>You can collect some of this information using our environment capture script:<br>\n== cat /etc/issue ===============================================<br>\nLinux lancelot24 3.10.0-693.11.6.el7.x86_64 <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP Thu Jan 4 01:06:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux<br>\nVERSION=\"7 (Core)\"<br>\nVERSION_ID=\"7\"<br>\nCENTOS_MANTISBT_PROJECT_VERSION=\"7\"<br>\nREDHAT_SUPPORT_PRODUCT_VERSION=\"7\"</p>\n<p>== are we in docker =============================================<br>\nNo</p>\n<p>== compiler =====================================================<br>\nc++ (GCC) 4.8.5 20150623 (Red Hat 4.8.5-16)<br>\nCopyright (C) 2015 Free Software Foundation, Inc.<br>\nThis is free software; see the source for copying conditions.  There is NO<br>\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</p>\n<p>== uname -a =====================================================<br>\nLinux lancelot24 3.10.0-693.11.6.el7.x86_64 <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"115886302\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/1\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/1/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/1\">#1</a> SMP Thu Jan 4 01:06:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</p>\n<p>== check pips ===================================================<br>\nnumpy (1.14.1)<br>\nprotobuf (3.5.1)<br>\ntensorflow (1.6.0)</p>\n<p>== check for virtualenv =========================================<br>\nFalse</p>\n<p>== tensorflow import ============================================<br>\ntf.VERSION = 1.6.0<br>\ntf.GIT_VERSION = v1.6.0-0-gd2e24b6039<br>\ntf.COMPILER_VERSION = v1.6.0-0-gd2e24b6039<br>\nSanity check: array([1], dtype=int32)<br>\n/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/h5py/<strong>init</strong>.py:36: FutureWarning: Conversion of the second argument of issubdtype from <code>float</code> to <code>np.floating</code> is deprecated. In future, it will be treated as <code>np.float64 == np.dtype(float).type</code>.<br>\nfrom ._conv import register_converters as _register_converters</p>\n<p>== env ==========================================================<br>\nLD_LIBRARY_PATH is unset<br>\nDYLD_LIBRARY_PATH is unset</p>\n<p>== nvidia-smi ===================================================<br>\n./p.sh: line 105: nvidia-smi: command not found</p>\n<p>== cuda libs  ===================================================</p>\n<p><a href=\"https://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh\">https://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh</a></p>\n<p>You can obtain the TensorFlow version with</p>\n<p>python -c \"import tensorflow as tf; print(tf.GIT_VERSION, tf.VERSION)\"</p>\n<h3>Describe the problem</h3>\n<p>Describe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.</p>\n<p>This is a bug in the TensorFlow 1.6. I am using the Intel-supplied pip wheel for MKL optimization. I ran the same code with the TF1.4 MKL wheel and my code worked just fine. The error messages indicate that there is a problem with the concatenation operation. I am not seeing this error with the generic TensorFlow 1.6 (i.e. pip install tensorflow). I believe it is limited to the MKL op for concatenation.</p>\n<h3>Source code / logs</h3>\n<p>Include any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.</p>\n<p>WARNING:tensorflow:Variable *= will be deprecated. Use variable.assign_mul if you want assignment to the variable value or 'x = x * y' if you want a new python Tensor object.<br>\nTrain on 24800 samples, validate on 6200 samples<br>\nEpoch 1/10<br>\nTraceback (most recent call last):<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1361, in _do_call<br>\nreturn fn(*args)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _run_fn<br>\ntarget_list, status, run_metadata)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 516, in <strong>exit</strong><br>\nc_api.TF_GetCode(self.status.status))<br>\ntensorflow.python.framework.errors_impl.AbortedError: Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777<br>\n[[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]</p>\n<p>During handling of the above exception, another exception occurred:</p>\n<p>Traceback (most recent call last):<br>\nFile \"train.py\", line 571, in <br>\nsettings.OUT_CHANNEL_NO, settings.MODEL_FN, settings.MODE, args)<br>\nFile \"train.py\", line 510, in train_and_predict<br>\ncallbacks=[model_checkpoint, tensorboard_checkpoint])<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py\", line 1793, in fit<br>\nvalidation_steps=validation_steps)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py\", line 1283, in _fit_loop<br>\nouts = f(ins_batch)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py\", line 2663, in <strong>call</strong><br>\nfetches=fetches, feed_dict=feed_dict, **self.session_kwargs)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 905, in run<br>\nrun_metadata_ptr)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1137, in _run<br>\nfeed_dict_tensor, options, run_metadata)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1355, in _do_run<br>\noptions, run_metadata)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1374, in _do_call<br>\nraise type(e)(node_def, op, message)<br>\ntensorflow.python.framework.errors_impl.AbortedError: Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777<br>\n[[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]</p>\n<p>Caused by op 'concatenate/concat', defined at:<br>\nFile \"train.py\", line 571, in <br>\nsettings.OUT_CHANNEL_NO, settings.MODEL_FN, settings.MODE, args)<br>\nFile \"train.py\", line 443, in train_and_predict<br>\nmodel = model5_MultiLayer(args, False, False, img_rows, img_cols, input_no, output_no, print_summary=True)<br>\nFile \"train.py\", line 183, in model5_MultiLayer<br>\nkernel_size=(3, 3), strides=(2, 2), padding='same')(conv5), conv4], axis=concat_axis)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 665, in concatenate<br>\nreturn Concatenate(axis=axis, **kwargs)(inputs)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/topology.py\", line 258, in <strong>call</strong><br>\noutput = super(Layer, self).<strong>call</strong>(inputs, **kwargs)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/layers/base.py\", line 696, in <strong>call</strong><br>\noutputs = self.call(inputs, *args, **kwargs)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 174, in call<br>\nreturn self._merge_function(inputs)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 380, in _merge_function<br>\nreturn K.concatenate(inputs, axis=self.axis)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py\", line 2083, in concatenate<br>\nreturn array_ops.concat([to_dense(x) for x in tensors], axis)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 1175, in concat<br>\nreturn gen_array_ops._concat_v2(values=values, axis=axis, name=name)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 625, in _concat_v2<br>\n\"ConcatV2\", values=values, axis=axis, name=name)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper<br>\nop_def=op_def)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3271, in create_op<br>\nop_def=op_def)<br>\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in <strong>init</strong><br>\nself._traceback = self._graph._extract_stack()  # pylint: disable=protected-access</p>\n<p>AbortedError (see above for traceback): Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777<br>\n[[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes.\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux CentOS 7\nTensorFlow installed from (source or binary): Binary (Intel MKL wheel) https://software.intel.com/en-us/articles/intel-optimized-tensorflow-wheel-now-available\nTensorFlow version (use command below): b'unknown' 1.6.0\nPython version: 3.6\nBazel version (if compiling from source): N/A\nGCC/Compiler version (if compiling from source): N/A\nCUDA/cuDNN version: N/A\nGPU model and memory: N/A\nExact command to reproduce:\nU-Net model graph compiles but error during training from concatenation op.\nThe code is here: https://github.com/mas-dse-greina/unet/blob/master/train.py\n\nYou can collect some of this information using our environment capture script:\n== cat /etc/issue ===============================================\nLinux lancelot24 3.10.0-693.11.6.el7.x86_64 #1 SMP Thu Jan 4 01:06:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\nVERSION=\"7 (Core)\"\nVERSION_ID=\"7\"\nCENTOS_MANTISBT_PROJECT_VERSION=\"7\"\nREDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\n== are we in docker =============================================\nNo\n== compiler =====================================================\nc++ (GCC) 4.8.5 20150623 (Red Hat 4.8.5-16)\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n== uname -a =====================================================\nLinux lancelot24 3.10.0-693.11.6.el7.x86_64 #1 SMP Thu Jan 4 01:06:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n== check pips ===================================================\nnumpy (1.14.1)\nprotobuf (3.5.1)\ntensorflow (1.6.0)\n== check for virtualenv =========================================\nFalse\n== tensorflow import ============================================\ntf.VERSION = 1.6.0\ntf.GIT_VERSION = v1.6.0-0-gd2e24b6039\ntf.COMPILER_VERSION = v1.6.0-0-gd2e24b6039\nSanity check: array([1], dtype=int32)\n/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/h5py/init.py:36: FutureWarning: Conversion of the second argument of issubdtype from float to np.floating is deprecated. In future, it will be treated as np.float64 == np.dtype(float).type.\nfrom ._conv import register_converters as _register_converters\n== env ==========================================================\nLD_LIBRARY_PATH is unset\nDYLD_LIBRARY_PATH is unset\n== nvidia-smi ===================================================\n./p.sh: line 105: nvidia-smi: command not found\n== cuda libs  ===================================================\nhttps://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh\nYou can obtain the TensorFlow version with\npython -c \"import tensorflow as tf; print(tf.GIT_VERSION, tf.VERSION)\"\nDescribe the problem\nDescribe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.\nThis is a bug in the TensorFlow 1.6. I am using the Intel-supplied pip wheel for MKL optimization. I ran the same code with the TF1.4 MKL wheel and my code worked just fine. The error messages indicate that there is a problem with the concatenation operation. I am not seeing this error with the generic TensorFlow 1.6 (i.e. pip install tensorflow). I believe it is limited to the MKL op for concatenation.\nSource code / logs\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.\nWARNING:tensorflow:Variable *= will be deprecated. Use variable.assign_mul if you want assignment to the variable value or 'x = x * y' if you want a new python Tensor object.\nTrain on 24800 samples, validate on 6200 samples\nEpoch 1/10\nTraceback (most recent call last):\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1361, in _do_call\nreturn fn(*args)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _run_fn\ntarget_list, status, run_metadata)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 516, in exit\nc_api.TF_GetCode(self.status.status))\ntensorflow.python.framework.errors_impl.AbortedError: Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777\n[[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]\nDuring handling of the above exception, another exception occurred:\nTraceback (most recent call last):\nFile \"train.py\", line 571, in \nsettings.OUT_CHANNEL_NO, settings.MODEL_FN, settings.MODE, args)\nFile \"train.py\", line 510, in train_and_predict\ncallbacks=[model_checkpoint, tensorboard_checkpoint])\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py\", line 1793, in fit\nvalidation_steps=validation_steps)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py\", line 1283, in _fit_loop\nouts = f(ins_batch)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py\", line 2663, in call\nfetches=fetches, feed_dict=feed_dict, **self.session_kwargs)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 905, in run\nrun_metadata_ptr)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1137, in _run\nfeed_dict_tensor, options, run_metadata)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1355, in _do_run\noptions, run_metadata)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1374, in _do_call\nraise type(e)(node_def, op, message)\ntensorflow.python.framework.errors_impl.AbortedError: Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777\n[[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]\nCaused by op 'concatenate/concat', defined at:\nFile \"train.py\", line 571, in \nsettings.OUT_CHANNEL_NO, settings.MODEL_FN, settings.MODE, args)\nFile \"train.py\", line 443, in train_and_predict\nmodel = model5_MultiLayer(args, False, False, img_rows, img_cols, input_no, output_no, print_summary=True)\nFile \"train.py\", line 183, in model5_MultiLayer\nkernel_size=(3, 3), strides=(2, 2), padding='same')(conv5), conv4], axis=concat_axis)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 665, in concatenate\nreturn Concatenate(axis=axis, **kwargs)(inputs)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/topology.py\", line 258, in call\noutput = super(Layer, self).call(inputs, **kwargs)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/layers/base.py\", line 696, in call\noutputs = self.call(inputs, *args, **kwargs)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 174, in call\nreturn self._merge_function(inputs)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 380, in _merge_function\nreturn K.concatenate(inputs, axis=self.axis)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py\", line 2083, in concatenate\nreturn array_ops.concat([to_dense(x) for x in tensors], axis)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 1175, in concat\nreturn gen_array_ops._concat_v2(values=values, axis=axis, name=name)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 625, in _concat_v2\n\"ConcatV2\", values=values, axis=axis, name=name)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\nop_def=op_def)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3271, in create_op\nop_def=op_def)\nFile \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in init\nself._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\nAbortedError (see above for traceback): Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777\n[[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes.\r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux CentOS 7\r\n- **TensorFlow installed from (source or binary)**: Binary (Intel MKL wheel) https://software.intel.com/en-us/articles/intel-optimized-tensorflow-wheel-now-available\r\n- **TensorFlow version (use command below)**: b'unknown' 1.6.0\r\n- **Python version**: 3.6 \r\n- **Bazel version (if compiling from source)**: N/A\r\n- **GCC/Compiler version (if compiling from source)**: N/A\r\n- **CUDA/cuDNN version**: N/A\r\n- **GPU model and memory**: N/A\r\n- **Exact command to reproduce**:\r\nU-Net model graph compiles but error during training from concatenation op.\r\nThe code is here: https://github.com/mas-dse-greina/unet/blob/master/train.py\r\n\r\n\r\nYou can collect some of this information using our environment capture script:\r\n== cat /etc/issue ===============================================\r\nLinux lancelot24 3.10.0-693.11.6.el7.x86_64 #1 SMP Thu Jan 4 01:06:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\nVERSION=\"7 (Core)\"\r\nVERSION_ID=\"7\"\r\nCENTOS_MANTISBT_PROJECT_VERSION=\"7\"\r\nREDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\r\n\r\n== are we in docker =============================================\r\nNo\r\n\r\n== compiler =====================================================\r\nc++ (GCC) 4.8.5 20150623 (Red Hat 4.8.5-16)\r\nCopyright (C) 2015 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n\r\n\r\n== uname -a =====================================================\r\nLinux lancelot24 3.10.0-693.11.6.el7.x86_64 #1 SMP Thu Jan 4 01:06:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n== check pips ===================================================\r\nnumpy (1.14.1)\r\nprotobuf (3.5.1)\r\ntensorflow (1.6.0)\r\n\r\n== check for virtualenv =========================================\r\nFalse\r\n\r\n== tensorflow import ============================================\r\ntf.VERSION = 1.6.0\r\ntf.GIT_VERSION = v1.6.0-0-gd2e24b6039\r\ntf.COMPILER_VERSION = v1.6.0-0-gd2e24b6039\r\nSanity check: array([1], dtype=int32)\r\n/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\r\n  from ._conv import register_converters as _register_converters\r\n\r\n== env ==========================================================\r\nLD_LIBRARY_PATH is unset\r\nDYLD_LIBRARY_PATH is unset\r\n\r\n== nvidia-smi ===================================================\r\n./p.sh: line 105: nvidia-smi: command not found\r\n\r\n== cuda libs  ===================================================\r\n\r\nhttps://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh\r\n\r\nYou can obtain the TensorFlow version with\r\n\r\npython -c \"import tensorflow as tf; print(tf.GIT_VERSION, tf.VERSION)\"\r\n\r\n### Describe the problem\r\nDescribe the problem clearly here. Be sure to convey here why it's a bug in TensorFlow or a feature request.\r\n\r\nThis is a bug in the TensorFlow 1.6. I am using the Intel-supplied pip wheel for MKL optimization. I ran the same code with the TF1.4 MKL wheel and my code worked just fine. The error messages indicate that there is a problem with the concatenation operation. I am not seeing this error with the generic TensorFlow 1.6 (i.e. pip install tensorflow). I believe it is limited to the MKL op for concatenation.\r\n\r\n### Source code / logs\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached. Try to provide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\nWARNING:tensorflow:Variable *= will be deprecated. Use variable.assign_mul if you want assignment to the variable value or 'x = x * y' if you want a new python Tensor object.\r\nTrain on 24800 samples, validate on 6200 samples\r\nEpoch 1/10\r\nTraceback (most recent call last):\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1361, in _do_call\r\n    return fn(*args)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1340, in _run_fn\r\n    target_list, status, run_metadata)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/errors_impl.py\", line 516, in __exit__\r\n    c_api.TF_GetCode(self.status.status))\r\ntensorflow.python.framework.errors_impl.AbortedError: Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777\r\n\t [[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"train.py\", line 571, in <module>\r\n    settings.OUT_CHANNEL_NO, settings.MODEL_FN, settings.MODE, args)\r\n  File \"train.py\", line 510, in train_and_predict\r\n    callbacks=[model_checkpoint, tensorboard_checkpoint])\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py\", line 1793, in fit\r\n    validation_steps=validation_steps)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/training.py\", line 1283, in _fit_loop\r\n    outs = f(ins_batch)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py\", line 2663, in __call__\r\n    fetches=fetches, feed_dict=feed_dict, **self.session_kwargs)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 905, in run\r\n    run_metadata_ptr)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1137, in _run\r\n    feed_dict_tensor, options, run_metadata)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1355, in _do_run\r\n    options, run_metadata)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1374, in _do_call\r\n    raise type(e)(node_def, op, message)\r\ntensorflow.python.framework.errors_impl.AbortedError: Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777\r\n\t [[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]\r\n\r\nCaused by op 'concatenate/concat', defined at:\r\n  File \"train.py\", line 571, in <module>\r\n    settings.OUT_CHANNEL_NO, settings.MODEL_FN, settings.MODE, args)\r\n  File \"train.py\", line 443, in train_and_predict\r\n    model = model5_MultiLayer(args, False, False, img_rows, img_cols, input_no, output_no, print_summary=True)\r\n  File \"train.py\", line 183, in model5_MultiLayer\r\n    kernel_size=(3, 3), strides=(2, 2), padding='same')(conv5), conv4], axis=concat_axis)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 665, in concatenate\r\n    return Concatenate(axis=axis, **kwargs)(inputs)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/engine/topology.py\", line 258, in __call__\r\n    output = super(Layer, self).__call__(inputs, **kwargs)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/layers/base.py\", line 696, in __call__\r\n    outputs = self.call(inputs, *args, **kwargs)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 174, in call\r\n    return self._merge_function(inputs)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/layers/merge.py\", line 380, in _merge_function\r\n    return K.concatenate(inputs, axis=self.axis)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/keras/_impl/keras/backend.py\", line 2083, in concatenate\r\n    return array_ops.concat([to_dense(x) for x in tensors], axis)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py\", line 1175, in concat\r\n    return gen_array_ops._concat_v2(values=values, axis=axis, name=name)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 625, in _concat_v2\r\n    \"ConcatV2\", values=values, axis=axis, name=name)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\r\n    op_def=op_def)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3271, in create_op\r\n    op_def=op_def)\r\n  File \"/home/bduser/anaconda3/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1650, in __init__\r\n    self._traceback = self._graph._extract_stack()  # pylint: disable=protected-access\r\n\r\nAbortedError (see above for traceback): Operation received an exception:Status: 3, message: could not create a concat primitive descriptor, in file tensorflow/core/kernels/mkl_concat_op.cc:777\r\n\t [[Node: concatenate/concat = _MklConcatV2[N=2, T=DT_FLOAT, Tidx=DT_INT32, _kernel=\"MklOp\", _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](transConv6/BiasAdd, conv4b/Relu, concatenate/concat/axis, DMT/_29, conv4b/Relu:1, DMT/_30)]]\r\n"}