{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/comments/379397232", "html_url": "https://github.com/tensorflow/tensorflow/issues/18300#issuecomment-379397232", "issue_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/18300", "id": 379397232, "node_id": "MDEyOklzc3VlQ29tbWVudDM3OTM5NzIzMg==", "user": {"login": "mrry", "id": 192142, "node_id": "MDQ6VXNlcjE5MjE0Mg==", "avatar_url": "https://avatars1.githubusercontent.com/u/192142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mrry", "html_url": "https://github.com/mrry", "followers_url": "https://api.github.com/users/mrry/followers", "following_url": "https://api.github.com/users/mrry/following{/other_user}", "gists_url": "https://api.github.com/users/mrry/gists{/gist_id}", "starred_url": "https://api.github.com/users/mrry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mrry/subscriptions", "organizations_url": "https://api.github.com/users/mrry/orgs", "repos_url": "https://api.github.com/users/mrry/repos", "events_url": "https://api.github.com/users/mrry/events{/privacy}", "received_events_url": "https://api.github.com/users/mrry/received_events", "type": "User", "site_admin": false}, "created_at": "2018-04-06T22:03:40Z", "updated_at": "2018-04-06T22:03:40Z", "author_association": "CONTRIBUTOR", "body_html": "<p>While driving by, I noticed that the threads are being created when the C API's <code>TF_Graph</code> is being constructed, with a stack like this:</p>\n<pre><code>#0  __pthread_create_2_1 (newthread=0x5555566085d8, attr=0x0, start_routine=0x7fffd0ac0b10, arg=0x5555561f70f8) at pthread_create.c:511\n#1  0x00007fffd0ac0c4c in std::thread::_M_start_thread(std::shared_ptr&lt;std::thread::_Impl_base&gt;, void (*)()) () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#2  0x00007fffd0ac0d51 in std::thread::_M_start_thread(std::shared_ptr&lt;std::thread::_Impl_base&gt;) () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#3  0x00007fffd1512720 in tensorflow::(anonymous namespace)::PosixEnv::StartThread(tensorflow::ThreadOptions const&amp;, std::string const&amp;, std::function&lt;void ()&gt;) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#4  0x00007fffd14e4467 in tensorflow::thread::ThreadPool::ThreadPool(tensorflow::Env*, tensorflow::ThreadOptions const&amp;, std::string const&amp;, int, bool) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#5  0x00007fffd14e4710 in tensorflow::thread::ThreadPool::ThreadPool(tensorflow::Env*, std::string const&amp;, int) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#6  0x00007fffd188dfdd in tensorflow::LocalDevice::EigenThreadPoolInfo::EigenThreadPoolInfo(tensorflow::SessionOptions const&amp;) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#7  0x00007fffd188e158 in tensorflow::LocalDevice::LocalDevice(tensorflow::SessionOptions const&amp;, tensorflow::DeviceAttributes const&amp;) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#8  0x00007fffd18b475b in tensorflow::ThreadPoolDevice::ThreadPoolDevice(tensorflow::SessionOptions const&amp;, std::string const&amp;, tensorflow::gtl::IntType&lt;tensorflow::Bytes_tag_, long long&gt;, tensorflow::DeviceLocality const&amp;, tensorflow::Allocator*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#9  0x00007fffd18b4e06 in tensorflow::ThreadPoolDeviceFactory::CreateDevices(tensorflow::SessionOptions const&amp;, std::string const&amp;, std::vector&lt;tensorflow::Device*, std::allocator&lt;tensorflow::Device*&gt; &gt;*) () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#10 0x00007fffd188bd3a in tensorflow::(anonymous namespace)::GetCPUDevice(tensorflow::Env*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#11 0x00007fffd188bf11 in tensorflow::GraphRunner::GraphRunner(tensorflow::Env*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#12 0x00007fffd5aa13f7 in tensorflow::ShapeRefiner::ShapeRefiner(int, tensorflow::OpRegistryInterface const*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#13 0x00007fffd33d197d in TF_Graph::TF_Graph() () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#14 0x00007fffd33d1a8e in TF_NewGraph () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#15 0x00007fffd3036169 in _wrap_TF_NewGraph () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n[Python guff]\n</code></pre>\n<p>It looks like that call to <code>GetCPUDevice()</code> (frame 10) is default initializing a SessionOptions and using it to create the CPU device's threadpool. Since the threadpools are static by default, by the time you come to create the session, it's too late. Strangely, adding <code>use_per_session_threads=True</code> to the <code>ConfigProto</code> didn't fix it for me. Setting the environment variable <code>TF_C_API_GRAPH_CONSTRUCTION=0</code> did reduce the CPU usage to the intended single core.</p>\n<p>/cc <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=88808\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/skye\">@skye</a></p>", "body_text": "While driving by, I noticed that the threads are being created when the C API's TF_Graph is being constructed, with a stack like this:\n#0  __pthread_create_2_1 (newthread=0x5555566085d8, attr=0x0, start_routine=0x7fffd0ac0b10, arg=0x5555561f70f8) at pthread_create.c:511\n#1  0x00007fffd0ac0c4c in std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>, void (*)()) () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#2  0x00007fffd0ac0d51 in std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>) () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#3  0x00007fffd1512720 in tensorflow::(anonymous namespace)::PosixEnv::StartThread(tensorflow::ThreadOptions const&, std::string const&, std::function<void ()>) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#4  0x00007fffd14e4467 in tensorflow::thread::ThreadPool::ThreadPool(tensorflow::Env*, tensorflow::ThreadOptions const&, std::string const&, int, bool) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#5  0x00007fffd14e4710 in tensorflow::thread::ThreadPool::ThreadPool(tensorflow::Env*, std::string const&, int) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#6  0x00007fffd188dfdd in tensorflow::LocalDevice::EigenThreadPoolInfo::EigenThreadPoolInfo(tensorflow::SessionOptions const&) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#7  0x00007fffd188e158 in tensorflow::LocalDevice::LocalDevice(tensorflow::SessionOptions const&, tensorflow::DeviceAttributes const&) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#8  0x00007fffd18b475b in tensorflow::ThreadPoolDevice::ThreadPoolDevice(tensorflow::SessionOptions const&, std::string const&, tensorflow::gtl::IntType<tensorflow::Bytes_tag_, long long>, tensorflow::DeviceLocality const&, tensorflow::Allocator*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#9  0x00007fffd18b4e06 in tensorflow::ThreadPoolDeviceFactory::CreateDevices(tensorflow::SessionOptions const&, std::string const&, std::vector<tensorflow::Device*, std::allocator<tensorflow::Device*> >*) () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#10 0x00007fffd188bd3a in tensorflow::(anonymous namespace)::GetCPUDevice(tensorflow::Env*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#11 0x00007fffd188bf11 in tensorflow::GraphRunner::GraphRunner(tensorflow::Env*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\n#12 0x00007fffd5aa13f7 in tensorflow::ShapeRefiner::ShapeRefiner(int, tensorflow::OpRegistryInterface const*) ()\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#13 0x00007fffd33d197d in TF_Graph::TF_Graph() () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#14 0x00007fffd33d1a8e in TF_NewGraph () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n#15 0x00007fffd3036169 in _wrap_TF_NewGraph () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\n[Python guff]\n\nIt looks like that call to GetCPUDevice() (frame 10) is default initializing a SessionOptions and using it to create the CPU device's threadpool. Since the threadpools are static by default, by the time you come to create the session, it's too late. Strangely, adding use_per_session_threads=True to the ConfigProto didn't fix it for me. Setting the environment variable TF_C_API_GRAPH_CONSTRUCTION=0 did reduce the CPU usage to the intended single core.\n/cc @skye", "body": "While driving by, I noticed that the threads are being created when the C API's `TF_Graph` is being constructed, with a stack like this:\r\n\r\n```\r\n#0  __pthread_create_2_1 (newthread=0x5555566085d8, attr=0x0, start_routine=0x7fffd0ac0b10, arg=0x5555561f70f8) at pthread_create.c:511\r\n#1  0x00007fffd0ac0c4c in std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>, void (*)()) () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#2  0x00007fffd0ac0d51 in std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>) () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#3  0x00007fffd1512720 in tensorflow::(anonymous namespace)::PosixEnv::StartThread(tensorflow::ThreadOptions const&, std::string const&, std::function<void ()>) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#4  0x00007fffd14e4467 in tensorflow::thread::ThreadPool::ThreadPool(tensorflow::Env*, tensorflow::ThreadOptions const&, std::string const&, int, bool) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#5  0x00007fffd14e4710 in tensorflow::thread::ThreadPool::ThreadPool(tensorflow::Env*, std::string const&, int) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#6  0x00007fffd188dfdd in tensorflow::LocalDevice::EigenThreadPoolInfo::EigenThreadPoolInfo(tensorflow::SessionOptions const&) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#7  0x00007fffd188e158 in tensorflow::LocalDevice::LocalDevice(tensorflow::SessionOptions const&, tensorflow::DeviceAttributes const&) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#8  0x00007fffd18b475b in tensorflow::ThreadPoolDevice::ThreadPoolDevice(tensorflow::SessionOptions const&, std::string const&, tensorflow::gtl::IntType<tensorflow::Bytes_tag_, long long>, tensorflow::DeviceLocality const&, tensorflow::Allocator*) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#9  0x00007fffd18b4e06 in tensorflow::ThreadPoolDeviceFactory::CreateDevices(tensorflow::SessionOptions const&, std::string const&, std::vector<tensorflow::Device*, std::allocator<tensorflow::Device*> >*) () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#10 0x00007fffd188bd3a in tensorflow::(anonymous namespace)::GetCPUDevice(tensorflow::Env*) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#11 0x00007fffd188bf11 in tensorflow::GraphRunner::GraphRunner(tensorflow::Env*) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/../libtensorflow_framework.so\r\n#12 0x00007fffd5aa13f7 in tensorflow::ShapeRefiner::ShapeRefiner(int, tensorflow::OpRegistryInterface const*) ()\r\n   from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#13 0x00007fffd33d197d in TF_Graph::TF_Graph() () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#14 0x00007fffd33d1a8e in TF_NewGraph () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n#15 0x00007fffd3036169 in _wrap_TF_NewGraph () from /usr/local/google/home/mrry/tf-nightly/local/lib/python2.7/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so\r\n[Python guff]\r\n```\r\n\r\nIt looks like that call to `GetCPUDevice()` (frame 10) is default initializing a SessionOptions and using it to create the CPU device's threadpool. Since the threadpools are static by default, by the time you come to create the session, it's too late. Strangely, adding `use_per_session_threads=True` to the `ConfigProto` didn't fix it for me. Setting the environment variable `TF_C_API_GRAPH_CONSTRUCTION=0` did reduce the CPU usage to the intended single core.\r\n\r\n/cc @skye "}