{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/208469536", "pull_request_review_id": 143365835, "id": 208469536, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwODQ2OTUzNg==", "diff_hunk": "@@ -937,13 +963,53 @@ class MklConv2DOp : public OpKernel {\n         errors::Aborted(\"Operation received an exception:\", error_msg));\n     }\n   }\n+  \n+  void PadWithConvFusion(OpKernelContext* context, memory::dims &padding_left,\n+                         memory::dims &padding_right){\n+    const Tensor& paddings_tf = MklGetInput(context, 2);\n+    OP_REQUIRES(context, paddings_tf.dims() == 2,\n+                errors::InvalidArgument(\"paddings must be 2-dimensional: \",\n+                                        paddings_tf.shape().DebugString()));\n+    Tpadding* paddings = nullptr;\n+    // To get individual pad, need to flatten the tensor\n+    paddings = static_cast<Tpadding*>(const_cast<Tpadding*>\n+                                     (paddings_tf.flat<Tpadding>().data())); \n+    // For NHWC format:\n+    // paddings[0], paddings[1], paddings[6], paddings[7] should be zero \n+    // if the paddings_tf is [ [0, 0] [1,2] [3,4] [0,0] ]\n+    // paddings = {0, 0, 1, 2, 3, 4, 0, 0} ; flat method is row major\n+    // then, values are: top = 1, bottom =2, left=3, right=4\n+    // For NCHW format, \n+    // paddings[0], paddings[1], paddings[2], paddings[3] should be zero \n+    // similar explanation as NHWC format will apply.\n+    string data_format = ToString(data_format_);\n+    if(data_format == \"NHWC\"){\n+      pad_top = paddings[2]; \n+      pad_bottom = paddings[3]; \n+      pad_left = paddings[4]; \n+      pad_right = paddings[5]; \n+    }\n+    else if (data_format == \"NCHW\"){\n+      pad_top = paddings[4]; \n+      pad_bottom = paddings[5]; \n+      pad_left = paddings[6]; \n+      pad_right = paddings[7]; \n+    }\n+    // Create padding arrays for MKL DNN convolutions.\n+    // MKL-DNN uses asymetric padding.\n+    padding_left = {static_cast<int>(pad_top), static_cast<int>(pad_left)};\n+    padding_right = {static_cast<int>(pad_bottom), static_cast<int>(pad_right)};\n+  }\n \n  private:\n   std::vector<int32> strides_;\n   std::vector<int32> dilations_;\n+  int64 pad_top, pad_left; ", "path": "tensorflow/core/kernels/mkl_conv_ops.cc", "position": null, "original_position": 107, "commit_id": "48809b87793882266f01b7b40bc9e4a6e0f18f57", "original_commit_id": "dd63093a599081accfe2a2d2ca8c029d413a15d7", "user": {"login": "penpornk", "id": 38085909, "node_id": "MDQ6VXNlcjM4MDg1OTA5", "avatar_url": "https://avatars3.githubusercontent.com/u/38085909?v=4", "gravatar_id": "", "url": "https://api.github.com/users/penpornk", "html_url": "https://github.com/penpornk", "followers_url": "https://api.github.com/users/penpornk/followers", "following_url": "https://api.github.com/users/penpornk/following{/other_user}", "gists_url": "https://api.github.com/users/penpornk/gists{/gist_id}", "starred_url": "https://api.github.com/users/penpornk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/penpornk/subscriptions", "organizations_url": "https://api.github.com/users/penpornk/orgs", "repos_url": "https://api.github.com/users/penpornk/repos", "events_url": "https://api.github.com/users/penpornk/events{/privacy}", "received_events_url": "https://api.github.com/users/penpornk/received_events", "type": "User", "site_admin": false}, "body": "Why do we need to store `pad_top`, `pad_left`, `pad_bottom`, and `pad_right` as class members?", "created_at": "2018-08-08T06:34:19Z", "updated_at": "2018-11-23T19:46:17Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/21318#discussion_r208469536", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/21318", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/208469536"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/21318#discussion_r208469536"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/21318"}}, "body_html": "<p>Why do we need to store <code>pad_top</code>, <code>pad_left</code>, <code>pad_bottom</code>, and <code>pad_right</code> as class members?</p>", "body_text": "Why do we need to store pad_top, pad_left, pad_bottom, and pad_right as class members?"}