{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16545", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16545/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16545/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/16545/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/16545", "id": 292458835, "node_id": "MDU6SXNzdWUyOTI0NTg4MzU=", "number": 16545, "title": "Graph transform : fold_constant issue since tf v 1.5", "user": {"login": "LucasMahieu", "id": 12006816, "node_id": "MDQ6VXNlcjEyMDA2ODE2", "avatar_url": "https://avatars3.githubusercontent.com/u/12006816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LucasMahieu", "html_url": "https://github.com/LucasMahieu", "followers_url": "https://api.github.com/users/LucasMahieu/followers", "following_url": "https://api.github.com/users/LucasMahieu/following{/other_user}", "gists_url": "https://api.github.com/users/LucasMahieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/LucasMahieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LucasMahieu/subscriptions", "organizations_url": "https://api.github.com/users/LucasMahieu/orgs", "repos_url": "https://api.github.com/users/LucasMahieu/repos", "events_url": "https://api.github.com/users/LucasMahieu/events{/privacy}", "received_events_url": "https://api.github.com/users/LucasMahieu/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": {"login": "tatianashp", "id": 986732, "node_id": "MDQ6VXNlcjk4NjczMg==", "avatar_url": "https://avatars2.githubusercontent.com/u/986732?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatianashp", "html_url": "https://github.com/tatianashp", "followers_url": "https://api.github.com/users/tatianashp/followers", "following_url": "https://api.github.com/users/tatianashp/following{/other_user}", "gists_url": "https://api.github.com/users/tatianashp/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatianashp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatianashp/subscriptions", "organizations_url": "https://api.github.com/users/tatianashp/orgs", "repos_url": "https://api.github.com/users/tatianashp/repos", "events_url": "https://api.github.com/users/tatianashp/events{/privacy}", "received_events_url": "https://api.github.com/users/tatianashp/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "tatianashp", "id": 986732, "node_id": "MDQ6VXNlcjk4NjczMg==", "avatar_url": "https://avatars2.githubusercontent.com/u/986732?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tatianashp", "html_url": "https://github.com/tatianashp", "followers_url": "https://api.github.com/users/tatianashp/followers", "following_url": "https://api.github.com/users/tatianashp/following{/other_user}", "gists_url": "https://api.github.com/users/tatianashp/gists{/gist_id}", "starred_url": "https://api.github.com/users/tatianashp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tatianashp/subscriptions", "organizations_url": "https://api.github.com/users/tatianashp/orgs", "repos_url": "https://api.github.com/users/tatianashp/repos", "events_url": "https://api.github.com/users/tatianashp/events{/privacy}", "received_events_url": "https://api.github.com/users/tatianashp/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2018-01-29T15:53:38Z", "updated_at": "2018-11-22T18:53:56Z", "closed_at": null, "author_association": "NONE", "body_html": "<h3>System information</h3>\n<ul>\n<li><strong>Have I written custom code (as opposed to using a stock example script provided in TensorFlow)</strong>: Yes</li>\n<li><strong>OS Platform and Distribution (e.g., Linux Ubuntu 16.04)</strong>: Linux centos 7</li>\n<li><strong>TensorFlow installed from (source or binary)</strong>: with pip</li>\n<li><strong>TensorFlow version (use command below)</strong>: 1.5.0 (vs 1.4.1)</li>\n<li><strong>Python version</strong>: 2.7.5</li>\n<li><strong>Bazel version (if compiling from source)</strong>: No</li>\n<li><strong>GCC/Compiler version (if compiling from source)</strong>: No</li>\n<li><strong>CUDA/cuDNN version</strong>: No</li>\n<li><strong>GPU model and memory</strong>: No</li>\n<li><strong>Exact command to reproduce</strong>:</li>\n</ul>\n<p>Clone the tensorflow/models repo.<br>\nthen</p>\n<pre><code>cd models/research/slim/\npython export_inference_graph.py \\\n  --model_name=inception_v1 \\\n  --image_size=224 \\\n  --output_file=/tmp/inception_v1.pb\n</code></pre>\n<p>Then freeze the graph :</p>\n<pre><code>cd tensorflow/tensorflow/python/tools/\npython freeze_graph.py \\\n--input_graph /tmp/inception_v1.pb \\\n--input_checkpoint /tmp/inception_v1.ckpt \\\n--output_graph /tmp/inception_v1_frozen.pb \\\n--input_binary True \\\n--output_node_names \"InceptionV1/Logits/Predictions/Reshape_1\"\n</code></pre>\n<p>Then in python do :</p>\n<pre><code>import tensorflow as tf\nfrom tensorflow.core.framework import graph_pb2\nfrom tensorflow.python.platform import gfile\nimport tensorflow.tools.graph_transforms as graph_transforms\ngraph = graph_pb2.GraphDef()\nwith open(\"/tmp/inception_v1_frozen.pb\", 'rb') as f:\n    s = f.read()\n    graph.ParseFromString(s)\ngraph = graph_transforms.TransformGraph(graph,\n            [\"input\"], # inputs nodes\n            [\"InceptionV1/Logits/Predictions/Reshape_1\"], # outputs nodes\n            ['fold_constants()'])\nwith gfile.FastGFile(\"/tmp/inception_v1_frozen\"+\"_optimized.pbtxt\", \"w\") as f:\n    f.write(str(graph))\n</code></pre>\n<h3>Describe the problem</h3>\n<p>I am using the graph_transform to fold constants in by graph saved as .pb.<br>\nWhen I use the fold_constants() transformation, some inputs of some nodes are renamed but not the corresponding nodes in the whole graph. So the graph is no longer valid...</p>\n<p>I have an \"input\" placeholder in the graph.<br>\nAnd the node connected to this placeholder as an input name \"input:0\" instead of \"input\".</p>\n<p>With the version 1.4.1 of tensorflow, I didn't have this issue.</p>\n<p>To reproduce, follow the instructions below, and take a look to the /tmp/inception_v1_frozen_optimized.pbtxt graph. And search le node named \"input\" it is the input placeholder. Then search node which has an input named \"input:0\". This name (\"input:0\") is node a node of the graph.</p>", "body_text": "System information\n\nHave I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\nOS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux centos 7\nTensorFlow installed from (source or binary): with pip\nTensorFlow version (use command below): 1.5.0 (vs 1.4.1)\nPython version: 2.7.5\nBazel version (if compiling from source): No\nGCC/Compiler version (if compiling from source): No\nCUDA/cuDNN version: No\nGPU model and memory: No\nExact command to reproduce:\n\nClone the tensorflow/models repo.\nthen\ncd models/research/slim/\npython export_inference_graph.py \\\n  --model_name=inception_v1 \\\n  --image_size=224 \\\n  --output_file=/tmp/inception_v1.pb\n\nThen freeze the graph :\ncd tensorflow/tensorflow/python/tools/\npython freeze_graph.py \\\n--input_graph /tmp/inception_v1.pb \\\n--input_checkpoint /tmp/inception_v1.ckpt \\\n--output_graph /tmp/inception_v1_frozen.pb \\\n--input_binary True \\\n--output_node_names \"InceptionV1/Logits/Predictions/Reshape_1\"\n\nThen in python do :\nimport tensorflow as tf\nfrom tensorflow.core.framework import graph_pb2\nfrom tensorflow.python.platform import gfile\nimport tensorflow.tools.graph_transforms as graph_transforms\ngraph = graph_pb2.GraphDef()\nwith open(\"/tmp/inception_v1_frozen.pb\", 'rb') as f:\n    s = f.read()\n    graph.ParseFromString(s)\ngraph = graph_transforms.TransformGraph(graph,\n            [\"input\"], # inputs nodes\n            [\"InceptionV1/Logits/Predictions/Reshape_1\"], # outputs nodes\n            ['fold_constants()'])\nwith gfile.FastGFile(\"/tmp/inception_v1_frozen\"+\"_optimized.pbtxt\", \"w\") as f:\n    f.write(str(graph))\n\nDescribe the problem\nI am using the graph_transform to fold constants in by graph saved as .pb.\nWhen I use the fold_constants() transformation, some inputs of some nodes are renamed but not the corresponding nodes in the whole graph. So the graph is no longer valid...\nI have an \"input\" placeholder in the graph.\nAnd the node connected to this placeholder as an input name \"input:0\" instead of \"input\".\nWith the version 1.4.1 of tensorflow, I didn't have this issue.\nTo reproduce, follow the instructions below, and take a look to the /tmp/inception_v1_frozen_optimized.pbtxt graph. And search le node named \"input\" it is the input placeholder. Then search node which has an input named \"input:0\". This name (\"input:0\") is node a node of the graph.", "body": "### System information\r\n- **Have I written custom code (as opposed to using a stock example script provided in TensorFlow)**: Yes \r\n- **OS Platform and Distribution (e.g., Linux Ubuntu 16.04)**: Linux centos 7\r\n- **TensorFlow installed from (source or binary)**: with pip\r\n- **TensorFlow version (use command below)**: 1.5.0 (vs 1.4.1)\r\n- **Python version**: 2.7.5\r\n- **Bazel version (if compiling from source)**: No\r\n- **GCC/Compiler version (if compiling from source)**: No\r\n- **CUDA/cuDNN version**: No\r\n- **GPU model and memory**: No\r\n- **Exact command to reproduce**:\r\n\r\nClone the tensorflow/models repo.\r\nthen \r\n```\r\ncd models/research/slim/\r\npython export_inference_graph.py \\\r\n  --model_name=inception_v1 \\\r\n  --image_size=224 \\\r\n  --output_file=/tmp/inception_v1.pb\r\n```\r\nThen freeze the graph : \r\n```\r\ncd tensorflow/tensorflow/python/tools/\r\npython freeze_graph.py \\\r\n--input_graph /tmp/inception_v1.pb \\\r\n--input_checkpoint /tmp/inception_v1.ckpt \\\r\n--output_graph /tmp/inception_v1_frozen.pb \\\r\n--input_binary True \\\r\n--output_node_names \"InceptionV1/Logits/Predictions/Reshape_1\"\r\n```\r\n\r\nThen in python do : \r\n```\r\nimport tensorflow as tf\r\nfrom tensorflow.core.framework import graph_pb2\r\nfrom tensorflow.python.platform import gfile\r\nimport tensorflow.tools.graph_transforms as graph_transforms\r\ngraph = graph_pb2.GraphDef()\r\nwith open(\"/tmp/inception_v1_frozen.pb\", 'rb') as f:\r\n    s = f.read()\r\n    graph.ParseFromString(s)\r\ngraph = graph_transforms.TransformGraph(graph,\r\n            [\"input\"], # inputs nodes\r\n            [\"InceptionV1/Logits/Predictions/Reshape_1\"], # outputs nodes\r\n            ['fold_constants()'])\r\nwith gfile.FastGFile(\"/tmp/inception_v1_frozen\"+\"_optimized.pbtxt\", \"w\") as f:\r\n    f.write(str(graph))\r\n```\r\n\r\n### Describe the problem\r\nI am using the graph_transform to fold constants in by graph saved as .pb.\r\nWhen I use the fold_constants() transformation, some inputs of some nodes are renamed but not the corresponding nodes in the whole graph. So the graph is no longer valid... \r\n\r\nI have an \"input\" placeholder in the graph.\r\nAnd the node connected to this placeholder as an input name \"input:0\" instead of \"input\".\r\n\r\nWith the version 1.4.1 of tensorflow, I didn't have this issue.\r\n\r\nTo reproduce, follow the instructions below, and take a look to the /tmp/inception_v1_frozen_optimized.pbtxt graph. And search le node named \"input\" it is the input placeholder. Then search node which has an input named \"input:0\". This name (\"input:0\") is node a node of the graph."}