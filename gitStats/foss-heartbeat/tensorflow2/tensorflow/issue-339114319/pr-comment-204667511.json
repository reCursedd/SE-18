{"url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/204667511", "pull_request_review_id": 139781983, "id": 204667511, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwNDY2NzUxMQ==", "diff_hunk": "@@ -2399,9 +2405,24 @@ void TF_AddGradients(TF_Graph* g, TF_Output* y, int ny, TF_Output* x, int nx,\n \n     const int first_new_node_id = g->graph.num_node_ids();\n \n+    const char* child_scope_name = prefix;\n+    if (child_scope_name != nullptr) {\n+      // The operation should fail if the provided name prefix has already been\n+      // used in this graph\n+      for (const auto& pair: g->name_map) {\n+        const string& name = pair.first;\n+        if (name.compare(0, name.find_last_of('/'), prefix) == 0) {\n+          status->status =\n+              InvalidArgument(\"Duplicate node name in graph: '\", prefix, \"'\");\n+          return;\n+        }\n+      }\n+    } else {\n+      child_scope_name = \"gradients\";\n+    }\n     tensorflow::Scope scope =\n         NewInternalScope(&g->graph, &status->status, &g->refiner)\n-            .NewSubScope(\"gradients\");\n+            .NewSubScope(child_scope_name);", "path": "tensorflow/c/c_api.cc", "position": 48, "original_position": 35, "commit_id": "c01cfe7ced91dabc19b2392696cf0598a5df70f9", "original_commit_id": "b211dcad9200bdef33f51442aecf4f82dea1c984", "user": {"login": "asimshankar", "id": 16018, "node_id": "MDQ6VXNlcjE2MDE4", "avatar_url": "https://avatars2.githubusercontent.com/u/16018?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asimshankar", "html_url": "https://github.com/asimshankar", "followers_url": "https://api.github.com/users/asimshankar/followers", "following_url": "https://api.github.com/users/asimshankar/following{/other_user}", "gists_url": "https://api.github.com/users/asimshankar/gists{/gist_id}", "starred_url": "https://api.github.com/users/asimshankar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asimshankar/subscriptions", "organizations_url": "https://api.github.com/users/asimshankar/orgs", "repos_url": "https://api.github.com/users/asimshankar/repos", "events_url": "https://api.github.com/users/asimshankar/events{/privacy}", "received_events_url": "https://api.github.com/users/asimshankar/received_events", "type": "User", "site_admin": false}, "body": "This is a bit subtle - that we're relying on `NewSubScope` to adding the \"_1\", \"_2\" etc. when `child_scope_name == nullptr`, but *not* do so when a `prefix` is provided.\r\n\r\nTo ensure that this is the case, perhaps we should validate (around like 2445) that the added nodes meet the expectation that their name begins with `<prefix>/`?", "created_at": "2018-07-24T08:32:03Z", "updated_at": "2018-07-27T22:06:32Z", "html_url": "https://github.com/tensorflow/tensorflow/pull/20609#discussion_r204667511", "pull_request_url": "https://api.github.com/repos/tensorflow/tensorflow/pulls/20609", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/comments/204667511"}, "html": {"href": "https://github.com/tensorflow/tensorflow/pull/20609#discussion_r204667511"}, "pull_request": {"href": "https://api.github.com/repos/tensorflow/tensorflow/pulls/20609"}}, "body_html": "<p>This is a bit subtle - that we're relying on <code>NewSubScope</code> to adding the \"_1\", \"_2\" etc. when <code>child_scope_name == nullptr</code>, but <em>not</em> do so when a <code>prefix</code> is provided.</p>\n<p>To ensure that this is the case, perhaps we should validate (around like 2445) that the added nodes meet the expectation that their name begins with <code>&lt;prefix&gt;/</code>?</p>", "body_text": "This is a bit subtle - that we're relying on NewSubScope to adding the \"_1\", \"_2\" etc. when child_scope_name == nullptr, but not do so when a prefix is provided.\nTo ensure that this is the case, perhaps we should validate (around like 2445) that the added nodes meet the expectation that their name begins with <prefix>/?"}