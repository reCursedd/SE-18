{"url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4044", "repository_url": "https://api.github.com/repos/tensorflow/tensorflow", "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4044/labels{/name}", "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4044/comments", "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/4044/events", "html_url": "https://github.com/tensorflow/tensorflow/issues/4044", "id": 173286340, "node_id": "MDU6SXNzdWUxNzMyODYzNDA=", "number": 4044, "title": "tf.import_graph_def: graph_def is invalid at node", "user": {"login": "cardshuffle", "id": 10469216, "node_id": "MDQ6VXNlcjEwNDY5MjE2", "avatar_url": "https://avatars0.githubusercontent.com/u/10469216?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cardshuffle", "html_url": "https://github.com/cardshuffle", "followers_url": "https://api.github.com/users/cardshuffle/followers", "following_url": "https://api.github.com/users/cardshuffle/following{/other_user}", "gists_url": "https://api.github.com/users/cardshuffle/gists{/gist_id}", "starred_url": "https://api.github.com/users/cardshuffle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cardshuffle/subscriptions", "organizations_url": "https://api.github.com/users/cardshuffle/orgs", "repos_url": "https://api.github.com/users/cardshuffle/repos", "events_url": "https://api.github.com/users/cardshuffle/events{/privacy}", "received_events_url": "https://api.github.com/users/cardshuffle/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 473172988, "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=", "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug/performance", "name": "type:bug/performance", "color": "159b2e", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "petewarden", "id": 161459, "node_id": "MDQ6VXNlcjE2MTQ1OQ==", "avatar_url": "https://avatars0.githubusercontent.com/u/161459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petewarden", "html_url": "https://github.com/petewarden", "followers_url": "https://api.github.com/users/petewarden/followers", "following_url": "https://api.github.com/users/petewarden/following{/other_user}", "gists_url": "https://api.github.com/users/petewarden/gists{/gist_id}", "starred_url": "https://api.github.com/users/petewarden/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petewarden/subscriptions", "organizations_url": "https://api.github.com/users/petewarden/orgs", "repos_url": "https://api.github.com/users/petewarden/repos", "events_url": "https://api.github.com/users/petewarden/events{/privacy}", "received_events_url": "https://api.github.com/users/petewarden/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "petewarden", "id": 161459, "node_id": "MDQ6VXNlcjE2MTQ1OQ==", "avatar_url": "https://avatars0.githubusercontent.com/u/161459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petewarden", "html_url": "https://github.com/petewarden", "followers_url": "https://api.github.com/users/petewarden/followers", "following_url": "https://api.github.com/users/petewarden/following{/other_user}", "gists_url": "https://api.github.com/users/petewarden/gists{/gist_id}", "starred_url": "https://api.github.com/users/petewarden/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petewarden/subscriptions", "organizations_url": "https://api.github.com/users/petewarden/orgs", "repos_url": "https://api.github.com/users/petewarden/repos", "events_url": "https://api.github.com/users/petewarden/events{/privacy}", "received_events_url": "https://api.github.com/users/petewarden/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 16, "created_at": "2016-08-25T19:16:03Z", "updated_at": "2018-09-12T12:02:39Z", "closed_at": "2018-09-11T22:34:28Z", "author_association": "NONE", "body_html": "<p>I've been trying to import a frozen graph into a new program, and do a simple forward pass, but <code>tf.import_graph_def</code> has been throwing a ValueError that I really can't make sense of.</p>\n<h3>Environment info</h3>\n<p>Operating System: Ubuntu 14.04 LTS 64-bit</p>\n<p>Installed version of CUDA and cuDNN: none</p>\n<p>If installed from source, provide</p>\n<ol>\n<li>The commit hash (<code>git rev-parse HEAD</code>): <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/tensorflow/tensorflow/commit/fc9162975e52978d3af38549b570cc3cc5f0ab66/hovercard\" href=\"https://github.com/tensorflow/tensorflow/commit/fc9162975e52978d3af38549b570cc3cc5f0ab66\"><tt>fc91629</tt></a></li>\n<li>The output of <code>bazel version</code></li>\n</ol>\n<pre><code>Build label: 0.3.0\nBuild target: bazel-out/local-fastbuild/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar\nBuild time: Fri Jun 10 11:38:23 2016 (1465558703)\nBuild timestamp: 1465558703\nBuild timestamp as int: 1465558703\n</code></pre>\n<h3>Steps to reproduce</h3>\n<ol>\n<li>Copy the IPython Notebook from <a href=\"https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/udacity/6_lstm.ipynb\">here</a></li>\n<li>Change <code>sample_prediction = tf.nn.softmax(tf.nn.xw_plus_b(sample_output, w, b))</code> to <code>sample_prediction = tf.nn.softmax(tf.nn.xw_plus_b(sample_output, w, b), name=\"sample_prediction\")</code></li>\n<li>Modify the code like so:</li>\n</ol>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">with</span> tf.Session(<span class=\"pl-v\">graph</span><span class=\"pl-k\">=</span>graph) <span class=\"pl-k\">as</span> session:\n  tf.initialize_all_variables().run()\n  <span class=\"pl-c1\">print</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>Initialized<span class=\"pl-pds\">'</span></span>)\n  mean_loss <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> code omitted (no changes)</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> new code below:</span>\n  saver <span class=\"pl-k\">=</span> tf.train.Saver(tf.all_variables())\n  saver.save(session, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>/home/me/Documents/checkpoint.ckpt<span class=\"pl-pds\">'</span></span>, <span class=\"pl-v\">write_meta_graph</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">False</span>)\n  tf.train.write_graph(graph.as_graph_def(), <span class=\"pl-s\"><span class=\"pl-pds\">'</span>/home/me/Documents<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>graph.pb<span class=\"pl-pds\">'</span></span>)</pre></div>\n<ol>\n<li>Run, and verify that <code>checkpoint.ckpt</code> and <code>graph.pb</code> have been created</li>\n<li>Run <code>bazel build tensorflow/python/tools:freeze_graph &amp;&amp; bazel-bin/tensorflow/python/tools/freeze_graph --input_graph=/home/me/Documents/graph.pb --input_checkpoint=/home/me/Documents/checkpoint.ckpt --output_graph=/home/me/Documents/frozen_graph.pb --output_node_names=sample_prediction</code></li>\n<li>Verify that <code>frozen_graph.pb</code> has been created</li>\n<li>Create a new IPython Notebook with the following code:</li>\n</ol>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">from</span> <span class=\"pl-c1\">__future__</span> <span class=\"pl-k\">import</span> print_function\n<span class=\"pl-k\">import</span> os\n<span class=\"pl-k\">import</span> numpy <span class=\"pl-k\">as</span> np\n<span class=\"pl-k\">import</span> random\n<span class=\"pl-k\">import</span> string\n<span class=\"pl-k\">import</span> tensorflow <span class=\"pl-k\">as</span> tf\n<span class=\"pl-k\">from</span> tensorflow.python.platform <span class=\"pl-k\">import</span> gfile\n<span class=\"pl-k\">import</span> zipfile\n<span class=\"pl-k\">from</span> six.moves <span class=\"pl-k\">import</span> <span class=\"pl-c1\">range</span>\n<span class=\"pl-k\">from</span> six.moves.urllib.request <span class=\"pl-k\">import</span> urlretrieve\n\ngraph <span class=\"pl-k\">=</span> tf.Graph()\n<span class=\"pl-k\">with</span> graph.as_default():\n    graph_def <span class=\"pl-k\">=</span> tf.GraphDef()\n    <span class=\"pl-k\">with</span> <span class=\"pl-c1\">open</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>/home/me/Documents/frozen_graph.pb<span class=\"pl-pds\">'</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>rb<span class=\"pl-pds\">\"</span></span>) <span class=\"pl-k\">as</span> f:\n        graph_def.ParseFromString(f.read())\n        sample_prediction <span class=\"pl-k\">=</span> tf.import_graph_def(graph_def, <span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-v\">return_elements</span><span class=\"pl-k\">=</span>[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>sample_prediction:0<span class=\"pl-pds\">'</span></span>])</pre></div>\n<ol>\n<li>Run</li>\n</ol>\n<h3>What have you tried?</h3>\n<ol>\n<li>Originally, the graph also contained a node named <code>saved_sample_output</code>, and when I tried importing that frozen graph, the error complained about <code>saved_sample_output:0</code>. I tried removing the name, re-writing the checkpoint and graph files, re-freezing, and re-running the code. It then complained about <code>Variable_17:0</code>, which, after checking <code>graph.pb</code>, was what had originally been named <code>saved_sample_output</code>. Other than that, I haven't been able to find anything else out.</li>\n<li>Checked out <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"123865155\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/616\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/616/hovercard\" href=\"https://github.com/tensorflow/tensorflow/issues/616\">#616</a> and looked at the solutions suggested for similar errors, but my <code>import_graph_def</code> never had an input map to begin with.</li>\n<li>Removing the name parameter, or the return_elements parameter, or both, hasn't made a difference.</li>\n</ol>\n<h3>Logs or other output that would be helpful</h3>\n<pre><code>ValueError                                Traceback (most recent call last)\n&lt;ipython-input-46-3423c2073e62&gt; in &lt;module&gt;()\n     53     with open('/home/me/Documents/frozen_graph.pb', \"rb\") as f:\n     54         graph_def.ParseFromString(f.read())\n---&gt; 55         sample_prediction = tf.import_graph_def(graph_def, name=\"\", return_elements=['sample_prediction:0'])\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.pyc in import_graph_def(graph_def, input_map, return_elements, name, op_dict)\n    318           except TypeError as te:\n    319             raise ValueError(_InvalidNodeMessage(\n--&gt; 320                 node, 'Input tensor %r %s' % (input_name, te)))\n    321 \n    322       # pylint: disable=protected_access\n\nValueError: graph_def is invalid at node u'Assign_4': Input tensor 'Variable_17:0' Cannot convert a tensor of type float32 to an input of type float32_ref.\n</code></pre>", "body_text": "I've been trying to import a frozen graph into a new program, and do a simple forward pass, but tf.import_graph_def has been throwing a ValueError that I really can't make sense of.\nEnvironment info\nOperating System: Ubuntu 14.04 LTS 64-bit\nInstalled version of CUDA and cuDNN: none\nIf installed from source, provide\n\nThe commit hash (git rev-parse HEAD): fc91629\nThe output of bazel version\n\nBuild label: 0.3.0\nBuild target: bazel-out/local-fastbuild/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar\nBuild time: Fri Jun 10 11:38:23 2016 (1465558703)\nBuild timestamp: 1465558703\nBuild timestamp as int: 1465558703\n\nSteps to reproduce\n\nCopy the IPython Notebook from here\nChange sample_prediction = tf.nn.softmax(tf.nn.xw_plus_b(sample_output, w, b)) to sample_prediction = tf.nn.softmax(tf.nn.xw_plus_b(sample_output, w, b), name=\"sample_prediction\")\nModify the code like so:\n\nwith tf.Session(graph=graph) as session:\n  tf.initialize_all_variables().run()\n  print('Initialized')\n  mean_loss = 0\n  # code omitted (no changes)\n  # new code below:\n  saver = tf.train.Saver(tf.all_variables())\n  saver.save(session, '/home/me/Documents/checkpoint.ckpt', write_meta_graph=False)\n  tf.train.write_graph(graph.as_graph_def(), '/home/me/Documents', 'graph.pb')\n\nRun, and verify that checkpoint.ckpt and graph.pb have been created\nRun bazel build tensorflow/python/tools:freeze_graph && bazel-bin/tensorflow/python/tools/freeze_graph --input_graph=/home/me/Documents/graph.pb --input_checkpoint=/home/me/Documents/checkpoint.ckpt --output_graph=/home/me/Documents/frozen_graph.pb --output_node_names=sample_prediction\nVerify that frozen_graph.pb has been created\nCreate a new IPython Notebook with the following code:\n\nfrom __future__ import print_function\nimport os\nimport numpy as np\nimport random\nimport string\nimport tensorflow as tf\nfrom tensorflow.python.platform import gfile\nimport zipfile\nfrom six.moves import range\nfrom six.moves.urllib.request import urlretrieve\n\ngraph = tf.Graph()\nwith graph.as_default():\n    graph_def = tf.GraphDef()\n    with open('/home/me/Documents/frozen_graph.pb', \"rb\") as f:\n        graph_def.ParseFromString(f.read())\n        sample_prediction = tf.import_graph_def(graph_def, name=\"\", return_elements=['sample_prediction:0'])\n\nRun\n\nWhat have you tried?\n\nOriginally, the graph also contained a node named saved_sample_output, and when I tried importing that frozen graph, the error complained about saved_sample_output:0. I tried removing the name, re-writing the checkpoint and graph files, re-freezing, and re-running the code. It then complained about Variable_17:0, which, after checking graph.pb, was what had originally been named saved_sample_output. Other than that, I haven't been able to find anything else out.\nChecked out #616 and looked at the solutions suggested for similar errors, but my import_graph_def never had an input map to begin with.\nRemoving the name parameter, or the return_elements parameter, or both, hasn't made a difference.\n\nLogs or other output that would be helpful\nValueError                                Traceback (most recent call last)\n<ipython-input-46-3423c2073e62> in <module>()\n     53     with open('/home/me/Documents/frozen_graph.pb', \"rb\") as f:\n     54         graph_def.ParseFromString(f.read())\n---> 55         sample_prediction = tf.import_graph_def(graph_def, name=\"\", return_elements=['sample_prediction:0'])\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.pyc in import_graph_def(graph_def, input_map, return_elements, name, op_dict)\n    318           except TypeError as te:\n    319             raise ValueError(_InvalidNodeMessage(\n--> 320                 node, 'Input tensor %r %s' % (input_name, te)))\n    321 \n    322       # pylint: disable=protected_access\n\nValueError: graph_def is invalid at node u'Assign_4': Input tensor 'Variable_17:0' Cannot convert a tensor of type float32 to an input of type float32_ref.", "body": "I've been trying to import a frozen graph into a new program, and do a simple forward pass, but `tf.import_graph_def` has been throwing a ValueError that I really can't make sense of.\n### Environment info\n\nOperating System: Ubuntu 14.04 LTS 64-bit\n\nInstalled version of CUDA and cuDNN: none\n\nIf installed from source, provide \n1. The commit hash (`git rev-parse HEAD`): fc9162975e52978d3af38549b570cc3cc5f0ab66\n2. The output of `bazel version`\n\n```\nBuild label: 0.3.0\nBuild target: bazel-out/local-fastbuild/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar\nBuild time: Fri Jun 10 11:38:23 2016 (1465558703)\nBuild timestamp: 1465558703\nBuild timestamp as int: 1465558703\n```\n### Steps to reproduce\n1. Copy the IPython Notebook from [here](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/udacity/6_lstm.ipynb)\n2. Change `sample_prediction = tf.nn.softmax(tf.nn.xw_plus_b(sample_output, w, b))` to `sample_prediction = tf.nn.softmax(tf.nn.xw_plus_b(sample_output, w, b), name=\"sample_prediction\")`\n3. Modify the code like so:\n\n``` python\nwith tf.Session(graph=graph) as session:\n  tf.initialize_all_variables().run()\n  print('Initialized')\n  mean_loss = 0\n  # code omitted (no changes)\n  # new code below:\n  saver = tf.train.Saver(tf.all_variables())\n  saver.save(session, '/home/me/Documents/checkpoint.ckpt', write_meta_graph=False)\n  tf.train.write_graph(graph.as_graph_def(), '/home/me/Documents', 'graph.pb')\n```\n1. Run, and verify that `checkpoint.ckpt` and `graph.pb` have been created\n2. Run `bazel build tensorflow/python/tools:freeze_graph && bazel-bin/tensorflow/python/tools/freeze_graph --input_graph=/home/me/Documents/graph.pb --input_checkpoint=/home/me/Documents/checkpoint.ckpt --output_graph=/home/me/Documents/frozen_graph.pb --output_node_names=sample_prediction`\n3. Verify that `frozen_graph.pb` has been created\n4. Create a new IPython Notebook with the following code:\n\n``` python\nfrom __future__ import print_function\nimport os\nimport numpy as np\nimport random\nimport string\nimport tensorflow as tf\nfrom tensorflow.python.platform import gfile\nimport zipfile\nfrom six.moves import range\nfrom six.moves.urllib.request import urlretrieve\n\ngraph = tf.Graph()\nwith graph.as_default():\n    graph_def = tf.GraphDef()\n    with open('/home/me/Documents/frozen_graph.pb', \"rb\") as f:\n        graph_def.ParseFromString(f.read())\n        sample_prediction = tf.import_graph_def(graph_def, name=\"\", return_elements=['sample_prediction:0'])\n```\n1. Run\n### What have you tried?\n1. Originally, the graph also contained a node named `saved_sample_output`, and when I tried importing that frozen graph, the error complained about `saved_sample_output:0`. I tried removing the name, re-writing the checkpoint and graph files, re-freezing, and re-running the code. It then complained about `Variable_17:0`, which, after checking `graph.pb`, was what had originally been named `saved_sample_output`. Other than that, I haven't been able to find anything else out.\n2. Checked out #616 and looked at the solutions suggested for similar errors, but my `import_graph_def` never had an input map to begin with.\n3. Removing the name parameter, or the return_elements parameter, or both, hasn't made a difference.\n### Logs or other output that would be helpful\n\n```\nValueError                                Traceback (most recent call last)\n<ipython-input-46-3423c2073e62> in <module>()\n     53     with open('/home/me/Documents/frozen_graph.pb', \"rb\") as f:\n     54         graph_def.ParseFromString(f.read())\n---> 55         sample_prediction = tf.import_graph_def(graph_def, name=\"\", return_elements=['sample_prediction:0'])\n\n/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/importer.pyc in import_graph_def(graph_def, input_map, return_elements, name, op_dict)\n    318           except TypeError as te:\n    319             raise ValueError(_InvalidNodeMessage(\n--> 320                 node, 'Input tensor %r %s' % (input_name, te)))\n    321 \n    322       # pylint: disable=protected_access\n\nValueError: graph_def is invalid at node u'Assign_4': Input tensor 'Variable_17:0' Cannot convert a tensor of type float32 to an input of type float32_ref.\n```\n"}