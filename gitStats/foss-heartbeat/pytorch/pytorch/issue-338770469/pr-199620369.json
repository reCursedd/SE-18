{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/9199", "id": 199620369, "node_id": "MDExOlB1bGxSZXF1ZXN0MTk5NjIwMzY5", "html_url": "https://github.com/pytorch/pytorch/pull/9199", "diff_url": "https://github.com/pytorch/pytorch/pull/9199.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/9199.patch", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/9199", "number": 9199, "state": "closed", "locked": false, "title": "Fix shape inference bug", "user": {"login": "hlu1", "id": 14827759, "node_id": "MDQ6VXNlcjE0ODI3NzU5", "avatar_url": "https://avatars2.githubusercontent.com/u/14827759?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hlu1", "html_url": "https://github.com/hlu1", "followers_url": "https://api.github.com/users/hlu1/followers", "following_url": "https://api.github.com/users/hlu1/following{/other_user}", "gists_url": "https://api.github.com/users/hlu1/gists{/gist_id}", "starred_url": "https://api.github.com/users/hlu1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hlu1/subscriptions", "organizations_url": "https://api.github.com/users/hlu1/orgs", "repos_url": "https://api.github.com/users/hlu1/repos", "events_url": "https://api.github.com/users/hlu1/events{/privacy}", "received_events_url": "https://api.github.com/users/hlu1/received_events", "type": "User", "site_admin": false}, "body": "Summary:\nThe input shapes are not logged correctly in production because `PerfNetObserver::Stop()` only gets called after the inference is done for the net and in the mobile models, it's common practice to reuse the blobs as much as possible to save memory. And the shapes of the blobs keep changing during inference. By the time you you query `InputTensorShapes()` in `PerfNetObserver::Stop()`, you only get the final shape of the blobs.\n\nTo fix this bug, I moved the 'InputTensorShapes()' query from `PerfNetObserver::Stop()` to `PerfOperatorObserver::Stop()`. The latter gets called at the end of operator->run() whereas `PerfNetObserver::Stop()` gets called at the end of net->run().\n\nAlso remove `PerfOperatorObserver::getAnalyticalCost()` since it's now done on the server side and no longer needed on mobile\n\nDifferential Revision: D8743346\n", "created_at": "2018-07-06T00:54:15Z", "updated_at": "2018-07-06T22:17:12Z", "closed_at": "2018-07-06T22:17:12Z", "merged_at": null, "merge_commit_sha": "34739db0bce86a465c47a84f6211a39484fcffca", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "commits_url": "https://api.github.com/repos/pytorch/pytorch/pulls/9199/commits", "review_comments_url": "https://api.github.com/repos/pytorch/pytorch/pulls/9199/comments", "review_comment_url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/9199/comments", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/e511aeb6000c3a87c829e65e1b9bd81ac11d4962", "head": {"label": "hlu1:export-D8743346", "ref": "export-D8743346", "sha": "e511aeb6000c3a87c829e65e1b9bd81ac11d4962", "user": {"login": "hlu1", "id": 14827759, "node_id": "MDQ6VXNlcjE0ODI3NzU5", "avatar_url": "https://avatars2.githubusercontent.com/u/14827759?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hlu1", "html_url": "https://github.com/hlu1", "followers_url": "https://api.github.com/users/hlu1/followers", "following_url": "https://api.github.com/users/hlu1/following{/other_user}", "gists_url": "https://api.github.com/users/hlu1/gists{/gist_id}", "starred_url": "https://api.github.com/users/hlu1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hlu1/subscriptions", "organizations_url": "https://api.github.com/users/hlu1/orgs", "repos_url": "https://api.github.com/users/hlu1/repos", "events_url": "https://api.github.com/users/hlu1/events{/privacy}", "received_events_url": "https://api.github.com/users/hlu1/received_events", "type": "User", "site_admin": false}, "repo": {"id": 127819967, "node_id": "MDEwOlJlcG9zaXRvcnkxMjc4MTk5Njc=", "name": "pytorch", "full_name": "hlu1/pytorch", "private": false, "owner": {"login": "hlu1", "id": 14827759, "node_id": "MDQ6VXNlcjE0ODI3NzU5", "avatar_url": "https://avatars2.githubusercontent.com/u/14827759?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hlu1", "html_url": "https://github.com/hlu1", "followers_url": "https://api.github.com/users/hlu1/followers", "following_url": "https://api.github.com/users/hlu1/following{/other_user}", "gists_url": "https://api.github.com/users/hlu1/gists{/gist_id}", "starred_url": "https://api.github.com/users/hlu1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hlu1/subscriptions", "organizations_url": "https://api.github.com/users/hlu1/orgs", "repos_url": "https://api.github.com/users/hlu1/repos", "events_url": "https://api.github.com/users/hlu1/events{/privacy}", "received_events_url": "https://api.github.com/users/hlu1/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/hlu1/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": true, "url": "https://api.github.com/repos/hlu1/pytorch", "forks_url": "https://api.github.com/repos/hlu1/pytorch/forks", "keys_url": "https://api.github.com/repos/hlu1/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/hlu1/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/hlu1/pytorch/teams", "hooks_url": "https://api.github.com/repos/hlu1/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/hlu1/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/hlu1/pytorch/events", "assignees_url": "https://api.github.com/repos/hlu1/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/hlu1/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/hlu1/pytorch/tags", "blobs_url": "https://api.github.com/repos/hlu1/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/hlu1/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/hlu1/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/hlu1/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/hlu1/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/hlu1/pytorch/languages", "stargazers_url": "https://api.github.com/repos/hlu1/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/hlu1/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/hlu1/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/hlu1/pytorch/subscription", "commits_url": "https://api.github.com/repos/hlu1/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/hlu1/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/hlu1/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/hlu1/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/hlu1/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/hlu1/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/hlu1/pytorch/merges", "archive_url": "https://api.github.com/repos/hlu1/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/hlu1/pytorch/downloads", "issues_url": "https://api.github.com/repos/hlu1/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/hlu1/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/hlu1/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/hlu1/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/hlu1/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/hlu1/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/hlu1/pytorch/deployments", "created_at": "2018-04-02T22:34:42Z", "updated_at": "2018-09-26T21:12:32Z", "pushed_at": "2018-09-26T21:11:39Z", "git_url": "git://github.com/hlu1/pytorch.git", "ssh_url": "git@github.com:hlu1/pytorch.git", "clone_url": "https://github.com/hlu1/pytorch.git", "svn_url": "https://github.com/hlu1/pytorch", "homepage": "http://pytorch.org", "size": 75417, "stargazers_count": 0, "watchers_count": 0, "language": "C++", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 0, "mirror_url": null, "archived": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "pytorch:master", "ref": "master", "sha": "da39c2497115cf3fd88256ece14a92d1d6446d56", "user": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 65600975, "node_id": "MDEwOlJlcG9zaXRvcnk2NTYwMDk3NQ==", "name": "pytorch", "full_name": "pytorch/pytorch", "private": false, "owner": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/pytorch/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": false, "url": "https://api.github.com/repos/pytorch/pytorch", "forks_url": "https://api.github.com/repos/pytorch/pytorch/forks", "keys_url": "https://api.github.com/repos/pytorch/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/pytorch/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/pytorch/pytorch/teams", "hooks_url": "https://api.github.com/repos/pytorch/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/pytorch/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/pytorch/pytorch/events", "assignees_url": "https://api.github.com/repos/pytorch/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/pytorch/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/pytorch/pytorch/tags", "blobs_url": "https://api.github.com/repos/pytorch/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/pytorch/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/pytorch/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/pytorch/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/pytorch/pytorch/languages", "stargazers_url": "https://api.github.com/repos/pytorch/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/pytorch/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/pytorch/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/pytorch/pytorch/subscription", "commits_url": "https://api.github.com/repos/pytorch/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/pytorch/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/pytorch/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/pytorch/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/pytorch/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/pytorch/pytorch/merges", "archive_url": "https://api.github.com/repos/pytorch/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/pytorch/pytorch/downloads", "issues_url": "https://api.github.com/repos/pytorch/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/pytorch/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/pytorch/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/pytorch/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/pytorch/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/pytorch/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/pytorch/pytorch/deployments", "created_at": "2016-08-13T05:26:41Z", "updated_at": "2018-11-24T12:35:43Z", "pushed_at": "2018-11-24T12:42:01Z", "git_url": "git://github.com/pytorch/pytorch.git", "ssh_url": "git@github.com:pytorch/pytorch.git", "clone_url": "https://github.com/pytorch/pytorch.git", "svn_url": "https://github.com/pytorch/pytorch", "homepage": "http://pytorch.org", "size": 89656, "stargazers_count": 21589, "watchers_count": 21589, "language": "C++", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 5153, "mirror_url": null, "archived": false, "open_issues_count": 2196, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 5153, "open_issues": 2196, "watchers": 21589, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/9199"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/9199"}, "issue": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/9199"}, "comments": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/9199/comments"}, "review_comments": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/9199/comments"}, "review_comment": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/9199/commits"}, "statuses": {"href": "https://api.github.com/repos/pytorch/pytorch/statuses/e511aeb6000c3a87c829e65e1b9bd81ac11d4962"}}, "author_association": "CONTRIBUTOR", "body_html": "<p>Summary:<br>\nThe input shapes are not logged correctly in production because <code>PerfNetObserver::Stop()</code> only gets called after the inference is done for the net and in the mobile models, it's common practice to reuse the blobs as much as possible to save memory. And the shapes of the blobs keep changing during inference. By the time you you query <code>InputTensorShapes()</code> in <code>PerfNetObserver::Stop()</code>, you only get the final shape of the blobs.</p>\n<p>To fix this bug, I moved the 'InputTensorShapes()' query from <code>PerfNetObserver::Stop()</code> to <code>PerfOperatorObserver::Stop()</code>. The latter gets called at the end of operator-&gt;run() whereas <code>PerfNetObserver::Stop()</code> gets called at the end of net-&gt;run().</p>\n<p>Also remove <code>PerfOperatorObserver::getAnalyticalCost()</code> since it's now done on the server side and no longer needed on mobile</p>\n<p>Differential Revision: D8743346</p>", "body_text": "Summary:\nThe input shapes are not logged correctly in production because PerfNetObserver::Stop() only gets called after the inference is done for the net and in the mobile models, it's common practice to reuse the blobs as much as possible to save memory. And the shapes of the blobs keep changing during inference. By the time you you query InputTensorShapes() in PerfNetObserver::Stop(), you only get the final shape of the blobs.\nTo fix this bug, I moved the 'InputTensorShapes()' query from PerfNetObserver::Stop() to PerfOperatorObserver::Stop(). The latter gets called at the end of operator->run() whereas PerfNetObserver::Stop() gets called at the end of net->run().\nAlso remove PerfOperatorObserver::getAnalyticalCost() since it's now done on the server side and no longer needed on mobile\nDifferential Revision: D8743346", "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 0, "review_comments": 0, "maintainer_can_modify": false, "commits": 1, "additions": 9, "deletions": 26, "changed_files": 2}