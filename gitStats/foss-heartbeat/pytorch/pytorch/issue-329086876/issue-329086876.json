{"url": "https://api.github.com/repos/pytorch/pytorch/issues/8111", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/8111/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/8111/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/8111/events", "html_url": "https://github.com/pytorch/pytorch/issues/8111", "id": 329086876, "node_id": "MDU6SXNzdWUzMjkwODY4NzY=", "number": 8111, "title": "[Bug] Weird bug when using ATen __rshift__() on cuda tensors", "user": {"login": "xxtemp", "id": 7406398, "node_id": "MDQ6VXNlcjc0MDYzOTg=", "avatar_url": "https://avatars1.githubusercontent.com/u/7406398?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xxtemp", "html_url": "https://github.com/xxtemp", "followers_url": "https://api.github.com/users/xxtemp/followers", "following_url": "https://api.github.com/users/xxtemp/following{/other_user}", "gists_url": "https://api.github.com/users/xxtemp/gists{/gist_id}", "starred_url": "https://api.github.com/users/xxtemp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xxtemp/subscriptions", "organizations_url": "https://api.github.com/users/xxtemp/orgs", "repos_url": "https://api.github.com/users/xxtemp/repos", "events_url": "https://api.github.com/users/xxtemp/events{/privacy}", "received_events_url": "https://api.github.com/users/xxtemp/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 424131847, "node_id": "MDU6TGFiZWw0MjQxMzE4NDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/bug", "name": "bug", "color": "b60205", "default": true}, {"id": 443483881, "node_id": "MDU6TGFiZWw0NDM0ODM4ODE=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/todo", "name": "todo", "color": "c2e0c6", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-06-04T14:45:24Z", "updated_at": "2018-06-05T18:30:03Z", "closed_at": "2018-06-05T18:30:03Z", "author_association": "NONE", "body_html": "<h2>Issue description</h2>\n<p>I've been writing C++/CUDA extensions (based on this tutorial <a href=\"https://github.com/pytorch/extension-cpp\">https://github.com/pytorch/extension-cpp</a>) and I encountered a weird bug.<br>\nUsing the function <strong>rshift</strong>() (declared in ATen/Functions.h) works on CPU tensors, but fails (returns the same result as <strong>lshift</strong>()) on CUDA tensors.</p>\n<h2>Code example</h2>\n<p>Cpp file (shifts.cpp):</p>\n<pre><code>#include &lt;torch/torch.h&gt;\n#include &lt;ATen/Functions.h&gt;\n\nat::Tensor shift_left(at::Tensor x, int n)\n{\n\treturn x.__lshift__(n);\n}\n\nat::Tensor shift_right(at::Tensor x, int n)\n{\n\treturn x.__rshift__(n);\n}\n\nPYBIND11_MODULE(TORCH_EXTENSION_NAME, m) {\n\tm.def(\"lshift\", &amp;shift_left, \"left shift\");\n\tm.def(\"rshift\", &amp;shift_right, \"right shift\");\n}\n</code></pre>\n<p>After exporting the functions to a module called cuda_if I ran this test:</p>\n<pre><code>import torch\nimport cuda_if\n\n#CPU Tensor, works as expected\na = torch.Tensor(1).fill_(4.0)\nprint(cuda_if.lshift(a, 1)) #tensor([ 8.]) as expected\nprint(cuda_if.rshift(a, 1)) #tensor([ 2.]) as expected\n\n#CUDA Tensor, **BUG in rshift(!!!)**\na = torch.Tensor(1).fill_(4.0).cuda()\nprint(cuda_if.lshift(a, 1)) #tensor([ 8.], device='cuda:0') as expected\nprint(cuda_if.rshift(a, 1)) #tensor([ 8.], device='cuda:0') (**BUG!!!** expected 2)\n</code></pre>\n<p>In order to create the module I used this setup file (setup.py, run: python3 setup.py install):</p>\n<pre><code>from setuptools import setup\nfrom torch.utils.cpp_extension import BuildExtension, CUDAExtension\n\nsetup(\n    name='cuda_if',\n    ext_modules=[\n        CUDAExtension('cuda_if', [\n            'shifts.cpp',\n        ]),\n    ],\n    cmdclass={\n        'build_ext': BuildExtension\n    })\n</code></pre>\n<h2>System Info</h2>\n<ul>\n<li>PyTorch or Caffe2: PyTorch</li>\n<li>How you installed PyTorch (conda, pip, source): pip</li>\n<li>Build command you used (if compiling from source):</li>\n<li>OS: Ubuntu 16.04</li>\n<li>PyTorch version: 0.4.0</li>\n<li>Python version: 3.5</li>\n<li>CUDA/cuDNN version: 9</li>\n<li>GPU models and configuration: GeForce GTX 1060</li>\n<li>GCC version (if compiling from source):</li>\n<li>CMake version:</li>\n<li>Versions of any other relevant libraries:</li>\n</ul>", "body_text": "Issue description\nI've been writing C++/CUDA extensions (based on this tutorial https://github.com/pytorch/extension-cpp) and I encountered a weird bug.\nUsing the function rshift() (declared in ATen/Functions.h) works on CPU tensors, but fails (returns the same result as lshift()) on CUDA tensors.\nCode example\nCpp file (shifts.cpp):\n#include <torch/torch.h>\n#include <ATen/Functions.h>\n\nat::Tensor shift_left(at::Tensor x, int n)\n{\n\treturn x.__lshift__(n);\n}\n\nat::Tensor shift_right(at::Tensor x, int n)\n{\n\treturn x.__rshift__(n);\n}\n\nPYBIND11_MODULE(TORCH_EXTENSION_NAME, m) {\n\tm.def(\"lshift\", &shift_left, \"left shift\");\n\tm.def(\"rshift\", &shift_right, \"right shift\");\n}\n\nAfter exporting the functions to a module called cuda_if I ran this test:\nimport torch\nimport cuda_if\n\n#CPU Tensor, works as expected\na = torch.Tensor(1).fill_(4.0)\nprint(cuda_if.lshift(a, 1)) #tensor([ 8.]) as expected\nprint(cuda_if.rshift(a, 1)) #tensor([ 2.]) as expected\n\n#CUDA Tensor, **BUG in rshift(!!!)**\na = torch.Tensor(1).fill_(4.0).cuda()\nprint(cuda_if.lshift(a, 1)) #tensor([ 8.], device='cuda:0') as expected\nprint(cuda_if.rshift(a, 1)) #tensor([ 8.], device='cuda:0') (**BUG!!!** expected 2)\n\nIn order to create the module I used this setup file (setup.py, run: python3 setup.py install):\nfrom setuptools import setup\nfrom torch.utils.cpp_extension import BuildExtension, CUDAExtension\n\nsetup(\n    name='cuda_if',\n    ext_modules=[\n        CUDAExtension('cuda_if', [\n            'shifts.cpp',\n        ]),\n    ],\n    cmdclass={\n        'build_ext': BuildExtension\n    })\n\nSystem Info\n\nPyTorch or Caffe2: PyTorch\nHow you installed PyTorch (conda, pip, source): pip\nBuild command you used (if compiling from source):\nOS: Ubuntu 16.04\nPyTorch version: 0.4.0\nPython version: 3.5\nCUDA/cuDNN version: 9\nGPU models and configuration: GeForce GTX 1060\nGCC version (if compiling from source):\nCMake version:\nVersions of any other relevant libraries:", "body": "## Issue description\r\n\r\nI've been writing C++/CUDA extensions (based on this tutorial https://github.com/pytorch/extension-cpp) and I encountered a weird bug.\r\nUsing the function __rshift__() (declared in ATen/Functions.h) works on CPU tensors, but fails (returns the same result as __lshift__()) on CUDA tensors.\r\n\r\n## Code example\r\nCpp file (shifts.cpp):\r\n```\r\n#include <torch/torch.h>\r\n#include <ATen/Functions.h>\r\n\r\nat::Tensor shift_left(at::Tensor x, int n)\r\n{\r\n\treturn x.__lshift__(n);\r\n}\r\n\r\nat::Tensor shift_right(at::Tensor x, int n)\r\n{\r\n\treturn x.__rshift__(n);\r\n}\r\n\r\nPYBIND11_MODULE(TORCH_EXTENSION_NAME, m) {\r\n\tm.def(\"lshift\", &shift_left, \"left shift\");\r\n\tm.def(\"rshift\", &shift_right, \"right shift\");\r\n}\r\n```\r\n\r\nAfter exporting the functions to a module called cuda_if I ran this test:\r\n```\r\nimport torch\r\nimport cuda_if\r\n\r\n#CPU Tensor, works as expected\r\na = torch.Tensor(1).fill_(4.0)\r\nprint(cuda_if.lshift(a, 1)) #tensor([ 8.]) as expected\r\nprint(cuda_if.rshift(a, 1)) #tensor([ 2.]) as expected\r\n\r\n#CUDA Tensor, **BUG in rshift(!!!)**\r\na = torch.Tensor(1).fill_(4.0).cuda()\r\nprint(cuda_if.lshift(a, 1)) #tensor([ 8.], device='cuda:0') as expected\r\nprint(cuda_if.rshift(a, 1)) #tensor([ 8.], device='cuda:0') (**BUG!!!** expected 2)\r\n```\r\n\r\n\r\nIn order to create the module I used this setup file (setup.py, run: python3 setup.py install):\r\n```\r\nfrom setuptools import setup\r\nfrom torch.utils.cpp_extension import BuildExtension, CUDAExtension\r\n\r\nsetup(\r\n    name='cuda_if',\r\n    ext_modules=[\r\n        CUDAExtension('cuda_if', [\r\n            'shifts.cpp',\r\n        ]),\r\n    ],\r\n    cmdclass={\r\n        'build_ext': BuildExtension\r\n    })\r\n```\r\n\r\n## System Info\r\n- PyTorch or Caffe2: PyTorch\r\n- How you installed PyTorch (conda, pip, source): pip\r\n- Build command you used (if compiling from source):\r\n- OS: Ubuntu 16.04\r\n- PyTorch version: 0.4.0\r\n- Python version: 3.5\r\n- CUDA/cuDNN version: 9\r\n- GPU models and configuration: GeForce GTX 1060\r\n- GCC version (if compiling from source):\r\n- CMake version:\r\n- Versions of any other relevant libraries:\r\n"}