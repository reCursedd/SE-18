{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/232754423", "pull_request_review_id": 174021494, "id": 232754423, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMjc1NDQyMw==", "diff_hunk": "@@ -5,90 +5,38 @@\n \n #include <torch/csrc/python_headers.h>\n #include <torch/csrc/utils/pybind.h>\n-#include <torch/types.h>\n-#include <torch/ordered_dict.h>\n \n-#include <iterator>\n-#include <string>\n-#include <unordered_map>\n-#include <utility>\n-#include <vector>\n+#include <memory>\n \n namespace torch {\n namespace python {\n namespace detail {\n-inline std::unordered_map<std::string, Tensor> ordered_dict_to_map(\n-    const OrderedDict<std::string, torch::Tensor>& dict) {\n-  auto pairs = dict.pairs();\n-  return {pairs.begin(), pairs.end()};\n-}\n+// The first template argument is the ModuleType we are binding, the second is\n+// the base class and the last is the holder type for the created object when\n+// going between C++ and Python.\n+template <typename ModuleType>\n+using ModulePybindClass =\n+    py::class_<ModuleType, torch::nn::Module, std::shared_ptr<ModuleType>>;\n } // namespace detail\n \n-/// Adds method bindings for a pybind11 `class_` that binds an `nn::Module`\n-/// subclass.\n-///\n-/// Say you have a pybind11 class object created with `py::class_<Net>(m,\n-/// \"Net\")`. This function will add all the necessary `.def()` calls to bind the\n-/// `nn::Module` base class' methods, such as `train()`, `eval()` etc. into\n-/// Python. The exact list of supported methods and their Python signatures are:\n-/// - `train()`\n-/// - `eval()`\n-/// - `is_training() -> bool`\n-/// - `zero_grad()`\n-/// - `cuda()`\n-/// - `cpu()`\n-/// - `parameters() -> List<Tensor>`\n-/// - `named_parameters() -> Dict<String, Tensor>`\n-/// - `buffers() -> List<Tensor>`\n-/// - `named_buffers() -> Dict<String, Tensor>`\n-template <typename M, typename... Extra>\n-py::class_<M, Extra...> add_module_bindings(py::class_<M, Extra...> module) {\n-  return module.def(\"train\", [](M& module) { module.train(); })\n-      .def(\"eval\", [](M& module) { module.eval(); })\n-      .def(\"clone\", [](M& module) { return module.clone(); })\n-      .def_property_readonly(\n-          \"training\", [](M& module) { return module.is_training(); })\n-      .def(\"zero_grad\", [](M& module) { module.zero_grad(); })\n-      .def(\"cuda\", [](M& module) { module.to(torch::kCUDA); })\n-      .def(\"cpu\", [](M& module) { module.to(torch::kCPU); })\n-      .def(\"parameters\", [](M& module) { return module.parameters(); })\n-      .def(\n-          \"named_parameters\",\n-          [](M& module) {\n-            return detail::ordered_dict_to_map(module.named_parameters());\n-          })\n-      .def(\"buffers\", [](M& module) { return module.buffers(); })\n-      .def(\"named_buffers\", [](M& module) {\n-        return detail::ordered_dict_to_map(module.named_buffers());\n-      });\n+template <typename ModuleType>\n+torch::disable_if_t<\n+    torch::detail::has_forward<ModuleType>::value,\n+    detail::ModulePybindClass<ModuleType>>\n+bind_module(py::module module, const char* name) {\n+  return {module, name};\n }\n \n-/// Creates a pybind11 class object for an `nn::Module` subclass type and adds\n-/// default bindings.\n-///\n-/// After adding the default bindings, the class object is returned, such that\n-/// you can add more bindings.\n-///\n-/// Example usage:\n-/// \\rst\n-/// .. code-block:: cpp\n-///\n-///   struct Net : torch::nn::Module {\n-///     Net(int in, int out) { }\n-///     torch::Tensor forward(torch::Tensor x) { return x; }\n-///   };\n-///\n-///   PYBIND11_MODULE(my_module, m) {\n-///     torch::python::bind_module<Net>(m, \"Net\")\n-///       .def(py::init<int, int>())\n-///       .def(\"forward\", &Net::forward);\n-///  }\n-/// \\endrst\n-template <typename M>\n-py::class_<M, std::shared_ptr<M>> bind_module(\n+template <\n+    typename ModuleType,\n+    typename =\n+        torch::enable_if_t<torch::detail::has_forward<ModuleType>::value>>\n+detail::ModulePybindClass<ModuleType> bind_module(", "path": "torch/csrc/api/include/torch/python.h", "position": 102, "original_position": 102, "commit_id": "b38180fbf8e52215fc06471dc6a0261f6d0324eb", "original_commit_id": "39a7e0b6b7de2f0d0c7da98036dad157eb87909b", "user": {"login": "goldsborough", "id": 6429851, "node_id": "MDQ6VXNlcjY0Mjk4NTE=", "avatar_url": "https://avatars3.githubusercontent.com/u/6429851?v=4", "gravatar_id": "", "url": "https://api.github.com/users/goldsborough", "html_url": "https://github.com/goldsborough", "followers_url": "https://api.github.com/users/goldsborough/followers", "following_url": "https://api.github.com/users/goldsborough/following{/other_user}", "gists_url": "https://api.github.com/users/goldsborough/gists{/gist_id}", "starred_url": "https://api.github.com/users/goldsborough/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/goldsborough/subscriptions", "organizations_url": "https://api.github.com/users/goldsborough/orgs", "repos_url": "https://api.github.com/users/goldsborough/repos", "events_url": "https://api.github.com/users/goldsborough/events{/privacy}", "received_events_url": "https://api.github.com/users/goldsborough/received_events", "type": "User", "site_admin": false}, "body": "It works out of the box in the sense that the user would just have to write \r\n```cpp\r\nm.class_<Net, torch::nn::Module, std::shared_ptr<Net>(\"Net\")\r\n```\r\nif he/she wanted to just use pybind11. This method now is just a convenience wrapper to spare the user from writing those last two template arguments", "created_at": "2018-11-12T17:50:05Z", "updated_at": "2018-11-23T15:54:39Z", "html_url": "https://github.com/pytorch/pytorch/pull/13481#discussion_r232754423", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/13481", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/232754423"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/13481#discussion_r232754423"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/13481"}}, "body_html": "<p>It works out of the box in the sense that the user would just have to write</p>\n<div class=\"highlight highlight-source-c++\"><pre>m.class_&lt;Net, torch::nn::Module, std::shared_ptr&lt;Net&gt;(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Net<span class=\"pl-pds\">\"</span></span>)</pre></div>\n<p>if he/she wanted to just use pybind11. This method now is just a convenience wrapper to spare the user from writing those last two template arguments</p>", "body_text": "It works out of the box in the sense that the user would just have to write\nm.class_<Net, torch::nn::Module, std::shared_ptr<Net>(\"Net\")\nif he/she wanted to just use pybind11. This method now is just a convenience wrapper to spare the user from writing those last two template arguments", "in_reply_to_id": 232263974}