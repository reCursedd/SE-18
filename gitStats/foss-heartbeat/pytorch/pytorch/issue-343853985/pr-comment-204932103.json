{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/204932103", "pull_request_review_id": 140034348, "id": 204932103, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwNDkzMjEwMw==", "diff_hunk": "@@ -155,27 +161,162 @@ void buildBlock(const onnx_torch::GraphProto& graph_proto, Block* block,\n   }\n }\n \n-std::shared_ptr<Graph> buildGraph(const onnx_torch::GraphProto& graph_proto, std::vector<at::Tensor>& initializers) {\n+class GraphDecoder : JitDecoder {\n+ public:\n+  std::shared_ptr<Graph> decode(const std::string& serialized_graph,\n+                                std::vector<at::Tensor>& initializers);\n+};\n \n-  auto graph = buildGraph(graph_proto);\n+std::shared_ptr<Graph> GraphDecoder::decode(\n+    const std::string& serialized_graph,\n+    std::vector<at::Tensor>& initializers) {\n+  auto model_proto = onnx_torch::ModelProto();\n+  model_proto.ParseFromString(serialized_graph);\n \n-  for (auto tensor_ : graph_proto.initializer()) {\n+  auto graph_proto = model_proto.graph();\n+  auto graph = buildGraph(graph_proto);\n+  for (auto &tensor_ : graph_proto.initializer()) {\n     initializers.push_back(buildTensor(tensor_));\n   }\n-\n   return graph;\n }\n \n+class ModuleDecoder : JitDecoder {\n+ public:\n+  std::shared_ptr<script::Module> decode(\n+      std::shared_ptr<script::Module> root_module,\n+      const std::string& serialized_module,\n+      const std::unordered_map<std::string, std::string>& storage_map);\n+\n+ private:\n+  at::Tensor buildTensor(const onnx_torch::TensorProto& tensor_proto);\n+\n+  at::Tensor buildParameter(const onnx_torch::TensorProto& tensor_proto);\n+\n+  at::Storage* getStorage(at::ScalarType type, std::string name);\n+\n+  std::pair<std::shared_ptr<script::Module>, std::string> parseFullName(\n+      std::shared_ptr<script::Module> root_module,\n+      const std::string fullname);\n+\n+  const std::unordered_map<std::string, std::string> *storage_export_map_;\n+  std::unordered_map<std::string, std::unique_ptr<at::Storage>> storage_map_;\n+};\n+\n+at::Tensor ModuleDecoder::buildParameter(const onnx_torch::TensorProto& tensor_proto) {", "path": "torch/csrc/jit/import.cpp", "position": null, "original_position": 171, "commit_id": "f622bcc6b1e23e942cca8615b87321ebc91e4273", "original_commit_id": "dfe899efbacf40f945fd85e4d49e3d0748317f4d", "user": {"login": "zdevito", "id": 370202, "node_id": "MDQ6VXNlcjM3MDIwMg==", "avatar_url": "https://avatars0.githubusercontent.com/u/370202?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zdevito", "html_url": "https://github.com/zdevito", "followers_url": "https://api.github.com/users/zdevito/followers", "following_url": "https://api.github.com/users/zdevito/following{/other_user}", "gists_url": "https://api.github.com/users/zdevito/gists{/gist_id}", "starred_url": "https://api.github.com/users/zdevito/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zdevito/subscriptions", "organizations_url": "https://api.github.com/users/zdevito/orgs", "repos_url": "https://api.github.com/users/zdevito/repos", "events_url": "https://api.github.com/users/zdevito/events{/privacy}", "received_events_url": "https://api.github.com/users/zdevito/received_events", "type": "User", "site_admin": false}, "body": "similar to encoder, we should not duplicate the logic between buildTensor and buildParameter.", "created_at": "2018-07-24T22:31:24Z", "updated_at": "2018-11-23T15:48:02Z", "html_url": "https://github.com/pytorch/pytorch/pull/9746#discussion_r204932103", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/9746", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/204932103"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/9746#discussion_r204932103"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/9746"}}, "body_html": "<p>similar to encoder, we should not duplicate the logic between buildTensor and buildParameter.</p>", "body_text": "similar to encoder, we should not duplicate the logic between buildTensor and buildParameter."}