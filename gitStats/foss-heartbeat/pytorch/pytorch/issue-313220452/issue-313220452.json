{"url": "https://api.github.com/repos/pytorch/pytorch/issues/6502", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/6502/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/6502/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/6502/events", "html_url": "https://github.com/pytorch/pytorch/issues/6502", "id": 313220452, "node_id": "MDU6SXNzdWUzMTMyMjA0NTI=", "number": 6502, "title": "[Caffe2] Boolean Tensor not supported for mobile_exporter.Export", "user": {"login": "rillomas", "id": 889809, "node_id": "MDQ6VXNlcjg4OTgwOQ==", "avatar_url": "https://avatars2.githubusercontent.com/u/889809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rillomas", "html_url": "https://github.com/rillomas", "followers_url": "https://api.github.com/users/rillomas/followers", "following_url": "https://api.github.com/users/rillomas/following{/other_user}", "gists_url": "https://api.github.com/users/rillomas/gists{/gist_id}", "starred_url": "https://api.github.com/users/rillomas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rillomas/subscriptions", "organizations_url": "https://api.github.com/users/rillomas/orgs", "repos_url": "https://api.github.com/users/rillomas/repos", "events_url": "https://api.github.com/users/rillomas/events{/privacy}", "received_events_url": "https://api.github.com/users/rillomas/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-04-11T08:24:20Z", "updated_at": "2018-04-11T13:52:38Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>The following sample results in an error.</p>\n<h1>Code</h1>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c\"><span class=\"pl-c\">#</span>!/usr/bin/env python</span>\n<span class=\"pl-k\">import</span> onnx\n<span class=\"pl-k\">import</span> numpy <span class=\"pl-k\">as</span> np\n<span class=\"pl-k\">import</span> caffe2.python.onnx.frontend <span class=\"pl-k\">as</span> oc2f\n<span class=\"pl-k\">import</span> caffe2.python.predictor.predictor_exporter <span class=\"pl-k\">as</span> pe\n<span class=\"pl-k\">import</span> caffe2.python.predictor.mobile_exporter <span class=\"pl-k\">as</span> c2me\n<span class=\"pl-k\">from</span> caffe2.python <span class=\"pl-k\">import</span> model_helper, workspace, brew, utils\n<span class=\"pl-c1\">IN_DATA_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>in_data<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-c1\">OUT_DATA_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>out_data<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-c1\">DATA_SHAPE</span> <span class=\"pl-k\">=</span> (<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">3</span>)\n\nmodel <span class=\"pl-k\">=</span> model_helper.ModelHelper(<span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>not_net<span class=\"pl-pds\">\"</span></span>)\nmodel.net.Not(<span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-c1\">OUT_DATA_NAME</span>)\nval <span class=\"pl-k\">=</span> (np.random.standard_normal(<span class=\"pl-c1\">DATA_SHAPE</span>) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>).astype(np.bool)\nmodel.param_init_net.GivenTensorBoolFill([], <span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-v\">values</span><span class=\"pl-k\">=</span>val, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">DATA_SHAPE</span>)\nworkspace.RunNetOnce(model.param_init_net)\n\ninit_net, predict_net <span class=\"pl-k\">=</span> c2me.Export(workspace, model.net, [<span class=\"pl-c1\">IN_DATA_NAME</span>])\n\nvalue_info <span class=\"pl-k\">=</span> {\n}\n\nonnx_model <span class=\"pl-k\">=</span> oc2f.caffe2_net_to_onnx_model(\n        predict_net,\n        init_net,\n        value_info)\nonnx.checker.check_model(onnx_model)\n<span class=\"pl-c1\">print</span>(onnx_model)\n<span class=\"pl-k\">with</span> <span class=\"pl-c1\">open</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>not.onnx<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>wb<span class=\"pl-pds\">'</span></span>) <span class=\"pl-k\">as</span> f:\n    f.write(onnx_model.SerializeToString())</pre></div>\n<h1>Error</h1>\n<pre><code>Traceback (most recent call last):\n  File \"./gen_not.py\", line 33, in &lt;module&gt;\n    init_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\n  File \"/home/masato/repo/pytorch/build/caffe2/python/predictor/mobile_exporter.py\", line 70, in Export\n    add_tensor(init_net, blob_name, blob)\n  File \"/home/masato/repo/pytorch/build/caffe2/python/predictor/mobile_exporter.py\", line 35, in add_tensor\n    kTypeNameMapper[blob.dtype],\nKeyError: dtype('bool')\n</code></pre>\n<p>I am able to finish properly by adding the following line to mobile_exporter.py, but I'm not sure if this is the correct fix.</p>\n<div class=\"highlight highlight-source-diff\"><pre><span class=\"pl-c1\">diff --git a/caffe2/python/predictor/mobile_exporter.py b/caffe2/python/predictor/mobile_exporter.py</span>\nindex 07f88def0..9095f9c10 100644\n<span class=\"pl-md\">--- a/caffe2/python/predictor/mobile_exporter.py</span>\n<span class=\"pl-mi1\">+++ b/caffe2/python/predictor/mobile_exporter.py</span>\n<span class=\"pl-mdr\">@@ -20,6 +20,7 @@</span> def add_tensor(net, name, blob):\n         np.dtype('int32'): \"GivenTensorIntFill\",\n         np.dtype('int64'): \"GivenTensorInt64Fill\",\n         np.dtype('uint8'): \"GivenTensorStringFill\",\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        np.dtype('bool'): \"GivenTensorBoolFill\",</span>\n     }\n\n     shape = blob.shape</pre></div>\n<h1>Environment</h1>\n<ul>\n<li>OS: Ubuntu 16.04.4 x86_64</li>\n<li>Python: 3.5.2</li>\n<li>Pytorch version: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/2e156f3eabb6fa4ae88c2e831aea7da344cf43a3/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/2e156f3eabb6fa4ae88c2e831aea7da344cf43a3\"><tt>2e156f3</tt></a></li>\n<li>onnx version: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/b8c423889b3d15825e90fd5bd8fa1766ba2200ce/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/b8c423889b3d15825e90fd5bd8fa1766ba2200ce\"><tt>b8c4238</tt></a></li>\n</ul>", "body_text": "The following sample results in an error.\nCode\n#!/usr/bin/env python\nimport onnx\nimport numpy as np\nimport caffe2.python.onnx.frontend as oc2f\nimport caffe2.python.predictor.predictor_exporter as pe\nimport caffe2.python.predictor.mobile_exporter as c2me\nfrom caffe2.python import model_helper, workspace, brew, utils\nIN_DATA_NAME = \"in_data\"\nOUT_DATA_NAME = \"out_data\"\nDATA_SHAPE = (1, 3, 3, 3)\n\nmodel = model_helper.ModelHelper(name=\"not_net\")\nmodel.net.Not(IN_DATA_NAME, OUT_DATA_NAME)\nval = (np.random.standard_normal(DATA_SHAPE) > 0).astype(np.bool)\nmodel.param_init_net.GivenTensorBoolFill([], IN_DATA_NAME, values=val, shape=DATA_SHAPE)\nworkspace.RunNetOnce(model.param_init_net)\n\ninit_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\n\nvalue_info = {\n}\n\nonnx_model = oc2f.caffe2_net_to_onnx_model(\n        predict_net,\n        init_net,\n        value_info)\nonnx.checker.check_model(onnx_model)\nprint(onnx_model)\nwith open(\"not.onnx\", 'wb') as f:\n    f.write(onnx_model.SerializeToString())\nError\nTraceback (most recent call last):\n  File \"./gen_not.py\", line 33, in <module>\n    init_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\n  File \"/home/masato/repo/pytorch/build/caffe2/python/predictor/mobile_exporter.py\", line 70, in Export\n    add_tensor(init_net, blob_name, blob)\n  File \"/home/masato/repo/pytorch/build/caffe2/python/predictor/mobile_exporter.py\", line 35, in add_tensor\n    kTypeNameMapper[blob.dtype],\nKeyError: dtype('bool')\n\nI am able to finish properly by adding the following line to mobile_exporter.py, but I'm not sure if this is the correct fix.\ndiff --git a/caffe2/python/predictor/mobile_exporter.py b/caffe2/python/predictor/mobile_exporter.py\nindex 07f88def0..9095f9c10 100644\n--- a/caffe2/python/predictor/mobile_exporter.py\n+++ b/caffe2/python/predictor/mobile_exporter.py\n@@ -20,6 +20,7 @@ def add_tensor(net, name, blob):\n         np.dtype('int32'): \"GivenTensorIntFill\",\n         np.dtype('int64'): \"GivenTensorInt64Fill\",\n         np.dtype('uint8'): \"GivenTensorStringFill\",\n+        np.dtype('bool'): \"GivenTensorBoolFill\",\n     }\n\n     shape = blob.shape\nEnvironment\n\nOS: Ubuntu 16.04.4 x86_64\nPython: 3.5.2\nPytorch version: 2e156f3\nonnx version: b8c4238", "body": "The following sample results in an error.\r\n\r\n# Code\r\n```python\r\n#!/usr/bin/env python\r\nimport onnx\r\nimport numpy as np\r\nimport caffe2.python.onnx.frontend as oc2f\r\nimport caffe2.python.predictor.predictor_exporter as pe\r\nimport caffe2.python.predictor.mobile_exporter as c2me\r\nfrom caffe2.python import model_helper, workspace, brew, utils\r\nIN_DATA_NAME = \"in_data\"\r\nOUT_DATA_NAME = \"out_data\"\r\nDATA_SHAPE = (1, 3, 3, 3)\r\n\r\nmodel = model_helper.ModelHelper(name=\"not_net\")\r\nmodel.net.Not(IN_DATA_NAME, OUT_DATA_NAME)\r\nval = (np.random.standard_normal(DATA_SHAPE) > 0).astype(np.bool)\r\nmodel.param_init_net.GivenTensorBoolFill([], IN_DATA_NAME, values=val, shape=DATA_SHAPE)\r\nworkspace.RunNetOnce(model.param_init_net)\r\n\r\ninit_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\r\n\r\nvalue_info = {\r\n}\r\n\r\nonnx_model = oc2f.caffe2_net_to_onnx_model(\r\n        predict_net,\r\n        init_net,\r\n        value_info)\r\nonnx.checker.check_model(onnx_model)\r\nprint(onnx_model)\r\nwith open(\"not.onnx\", 'wb') as f:\r\n    f.write(onnx_model.SerializeToString())\r\n```\r\n\r\n# Error\r\n```\r\nTraceback (most recent call last):\r\n  File \"./gen_not.py\", line 33, in <module>\r\n    init_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\r\n  File \"/home/masato/repo/pytorch/build/caffe2/python/predictor/mobile_exporter.py\", line 70, in Export\r\n    add_tensor(init_net, blob_name, blob)\r\n  File \"/home/masato/repo/pytorch/build/caffe2/python/predictor/mobile_exporter.py\", line 35, in add_tensor\r\n    kTypeNameMapper[blob.dtype],\r\nKeyError: dtype('bool')\r\n```\r\n\r\nI am able to finish properly by adding the following line to mobile_exporter.py, but I'm not sure if this is the correct fix.\r\n\r\n```diff\r\ndiff --git a/caffe2/python/predictor/mobile_exporter.py b/caffe2/python/predictor/mobile_exporter.py\r\nindex 07f88def0..9095f9c10 100644\r\n--- a/caffe2/python/predictor/mobile_exporter.py\r\n+++ b/caffe2/python/predictor/mobile_exporter.py\r\n@@ -20,6 +20,7 @@ def add_tensor(net, name, blob):\r\n         np.dtype('int32'): \"GivenTensorIntFill\",\r\n         np.dtype('int64'): \"GivenTensorInt64Fill\",\r\n         np.dtype('uint8'): \"GivenTensorStringFill\",\r\n+        np.dtype('bool'): \"GivenTensorBoolFill\",\r\n     }\r\n\r\n     shape = blob.shape\r\n```\r\n\r\n\r\n\r\n# Environment\r\n- OS: Ubuntu 16.04.4 x86_64\r\n- Python: 3.5.2\r\n- Pytorch version: 2e156f3eabb6fa4ae88c2e831aea7da344cf43a3\r\n- onnx version: b8c423889b3d15825e90fd5bd8fa1766ba2200ce\r\n"}