{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/180235999", "pull_request_review_id": 110623290, "id": 180235999, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MDIzNTk5OQ==", "diff_hunk": "@@ -0,0 +1,390 @@\n+#include \"caffe2/opt/backend_cutting.h\"\n+#include \"caffe2/core/logging.h\"\n+#include \"nomnigraph/Converters/Caffe2.h\"\n+#include \"nomnigraph/Converters/Dot.h\"\n+#include \"nomnigraph/Representations/NeuralNet.h\"\n+\n+#include <algorithm>\n+#include <fstream>\n+#include <queue>\n+\n+namespace caffe2 {\n+namespace opt {\n+\n+namespace {\n+\n+using namespace nom::repr;\n+using NodeRef = NNGraph::NodeRef;\n+using EdgeRef = NNGraph::EdgeRef;\n+\n+class GroupAnnotation {\n+ public:\n+  GroupAnnotation(int i, int g = -1) : group(g), in_degree(i) {}\n+  int group;\n+  int in_degree;\n+  bool needs_transform{true};\n+};\n+\n+struct VisitorContext {\n+  VisitorContext(std::function<bool(const caffe2::OperatorDef&)> func)\n+      : predicate(func) {}\n+  std::unordered_map<NodeRef, GroupAnnotation> infos;\n+  std::unordered_set<NodeRef> frontier;\n+  std::vector<NodeRef> current_group;\n+  std::function<bool(const caffe2::OperatorDef&)> predicate;\n+\n+  int group{0};\n+  bool find_supported{true};\n+};\n+\n+std::string ShowNode(NodeRef node) {\n+  if (nn::is<NeuralNetData>(node)) {\n+    const auto* nn_tensor = nn::get<NeuralNetData>(node); \n+    return MakeString(\"Tensor: \", nn_tensor->getName());\n+  } else if (nn::is<NeuralNetOperator>(node)) {\n+    const auto* nn_op = nn::get<NeuralNetOperator>(node); \n+    const auto* op_def = reinterpret_cast<const caffe2::OperatorDef*>(\n+        nn_op->getAnnotation()->getSaved());\n+    CAFFE_ENFORCE(op_def);\n+    return MakeString(\"Op: \", op_def->type());\n+  } else {\n+    CAFFE_THROW(\"Known node\");\n+  }\n+}\n+\n+void DumpGraph(NNGraph* g) {\n+  auto nnprinter = [](typename NNGraph::NodeRef node) {\n+    std::map<std::string, std::string> labelMap;\n+    assert(node->data() && \"Node doesn't have data, can't render it\");\n+    if (isa<NeuralNetOperator>(node->data())) {\n+      auto* op = dyn_cast<NeuralNetOperator>(node->data().get());\n+      labelMap[\"label\"] =\n+          op->getName() + \" (\" + std::to_string((unsigned long long)node) + \")\";", "path": "caffe2/opt/backend_cutting.cc", "position": null, "original_position": 62, "commit_id": "1ee73c81942d0c6028cb697cbce6d1bc59ddf91b", "original_commit_id": "55688abe358302514e2eee1fb8d63826e84898e2", "user": {"login": "bwasti", "id": 4842908, "node_id": "MDQ6VXNlcjQ4NDI5MDg=", "avatar_url": "https://avatars2.githubusercontent.com/u/4842908?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bwasti", "html_url": "https://github.com/bwasti", "followers_url": "https://api.github.com/users/bwasti/followers", "following_url": "https://api.github.com/users/bwasti/following{/other_user}", "gists_url": "https://api.github.com/users/bwasti/gists{/gist_id}", "starred_url": "https://api.github.com/users/bwasti/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bwasti/subscriptions", "organizations_url": "https://api.github.com/users/bwasti/orgs", "repos_url": "https://api.github.com/users/bwasti/repos", "events_url": "https://api.github.com/users/bwasti/events{/privacy}", "received_events_url": "https://api.github.com/users/bwasti/received_events", "type": "User", "site_admin": false}, "body": "you'll need to use caffe2' to_string (there is an issue with to_string on android that is breaking the build: https://ci.pytorch.org/jenkins/job/caffe2-builds/job/py2-android-ubuntu16.04-build/2863/console)", "created_at": "2018-04-09T21:26:18Z", "updated_at": "2018-11-23T15:42:06Z", "html_url": "https://github.com/pytorch/pytorch/pull/6368#discussion_r180235999", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/6368", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/180235999"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/6368#discussion_r180235999"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/6368"}}, "body_html": "<p>you'll need to use caffe2' to_string (there is an issue with to_string on android that is breaking the build: <a href=\"https://ci.pytorch.org/jenkins/job/caffe2-builds/job/py2-android-ubuntu16.04-build/2863/console\" rel=\"nofollow\">https://ci.pytorch.org/jenkins/job/caffe2-builds/job/py2-android-ubuntu16.04-build/2863/console</a>)</p>", "body_text": "you'll need to use caffe2' to_string (there is an issue with to_string on android that is breaking the build: https://ci.pytorch.org/jenkins/job/caffe2-builds/job/py2-android-ubuntu16.04-build/2863/console)"}