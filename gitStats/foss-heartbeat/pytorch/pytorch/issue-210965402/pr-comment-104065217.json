{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/104065217", "pull_request_review_id": 24880383, "id": 104065217, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwNDA2NTIxNw==", "diff_hunk": "@@ -1,42 +1,73 @@\n-from copy import copy\n-from collections import OrderedDict\n-\n-from ..modules import Module\n import torch.cuda.comm as comm\n \n \n-def _replicate_module(module, gpu, param_remap):\n-    if module is None:\n-        return module\n-    replica = copy(module)\n-    replica._parameters = OrderedDict()\n-    for key, param in module._parameters.items():\n-        replica._parameters[key] = param_remap.get(param)\n-    replica._buffers = {}\n-    for key, buffer in module._buffers.items():\n-        replica._buffers[key] = param_remap.get(buffer)\n-    if replica._modules:\n-        replica._modules = OrderedDict()\n-        for name, child in module._modules.items():\n-            replica._modules[name] = _replicate_module(child, gpu, param_remap)\n-    return replica\n-\n-\n-def replicate(module, device_ids):\n+def replicate(network, devices):\n     from ._functions import Broadcast\n-    seen_params = set()\n-    param_remap = [{} for dev_id in device_ids]\n-    for param in module.parameters():\n-        if param in seen_params:\n-            continue\n-        seen_params.add(param)\n-        param_copies = Broadcast(device_ids)(param)\n-        for param_copy, remap in zip(param_copies, param_remap):\n-            remap[param] = param_copy\n-    for m in module.modules():\n-        for buffer in m._buffers.values():\n-            copies = comm.broadcast(buffer, device_ids)\n-            for buf_copy, remap in zip(copies, param_remap):\n-                remap[buffer] = buf_copy\n-    return [_replicate_module(module, device_id, remap)\n-            for device_id, remap in zip(device_ids, param_remap)]\n+\n+    devices = tuple(devices)\n+    num_replicas = len(devices)\n+\n+    params = list(network.parameters())\n+    param_indices = {param: idx for idx, param in enumerate(params)}\n+    param_copies = Broadcast(devices)(*params)\n+    if len(params) > 0:\n+        param_copies = [param_copies[i:i+len(params)]\n+                        for i in range(0, len(param_copies), len(params))]\n+\n+    buffers = _buffers(network)\n+    buffer_indices = {buf: idx for idx, buf in enumerate(buffers)}\n+    buffer_copies = comm.broadcast_coalesced(buffers, devices)\n+\n+    modules = list(network.modules())\n+    module_copies = [[] for device in devices]\n+    module_indices = {}\n+\n+    for i, module in enumerate(modules):\n+        module_indices[module] = i\n+        for j in range(num_replicas):\n+            replica = module.__new__(type(module))\n+            replica.__dict__ = module.__dict__.copy()\n+            replica._parameters = replica._parameters.copy()\n+            replica._buffers = replica._buffers.copy()\n+            replica._modules = replica._modules.copy()\n+            module_copies[j].append(replica)\n+\n+    for i, module in enumerate(modules):\n+        for key, child in module._modules.items():\n+            module_idx = module_indices[child]\n+            for j in range(num_replicas):\n+                replica = module_copies[j][i]\n+                replica._modules[key] = module_copies[j][module_idx]\n+        for key, param in module._parameters.items():\n+            if param is None:\n+                for j in range(num_replicas):\n+                    replica = module_copies[j][i]\n+                    replica._parameters[key] = None\n+            else:\n+                param_idx = param_indices[param]\n+                for j in range(num_replicas):\n+                    replica = module_copies[j][i]\n+                    replica._parameters[key] = param_copies[j][param_idx]\n+        for key, buf in module._buffers.items():\n+            if buf is None:\n+                for j in range(num_replicas):\n+                    replica = module_copies[j][i]\n+                    replica._buffers[key] = None\n+            else:\n+                buffer_idx = buffer_indices[buf]\n+                for j in range(num_replicas):\n+                    replica = module_copies[j][i]\n+                    replica._buffers[key] = buffer_copies[j][buffer_idx]\n+\n+    return [module_copies[j][0] for j in range(num_replicas)]", "path": "torch/nn/parallel/replicate.py", "position": 100, "original_position": 100, "commit_id": "6336300880349038c5bf6f5dfe3b37864eb39acb", "original_commit_id": "b132877316ccb20083d70b969d96c0a7d6420cc2", "user": {"login": "colesbury", "id": 655866, "node_id": "MDQ6VXNlcjY1NTg2Ng==", "avatar_url": "https://avatars1.githubusercontent.com/u/655866?v=4", "gravatar_id": "", "url": "https://api.github.com/users/colesbury", "html_url": "https://github.com/colesbury", "followers_url": "https://api.github.com/users/colesbury/followers", "following_url": "https://api.github.com/users/colesbury/following{/other_user}", "gists_url": "https://api.github.com/users/colesbury/gists{/gist_id}", "starred_url": "https://api.github.com/users/colesbury/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/colesbury/subscriptions", "organizations_url": "https://api.github.com/users/colesbury/orgs", "repos_url": "https://api.github.com/users/colesbury/repos", "events_url": "https://api.github.com/users/colesbury/events{/privacy}", "received_events_url": "https://api.github.com/users/colesbury/received_events", "type": "User", "site_admin": false}, "body": "The first module is the outermost module (i.e. `list(network.modules())[0] == network`), which is the same module that the user passed as an argument to replicate.\r\n\r\nThis is the same behavior that replicate had before:\r\n```\r\n  replicate(network, devices) -> replicas\r\n```\r\nwhere replicas is a list of copies of the module `network` (i.e.`len(replicas) == len(devices)`)", "created_at": "2017-03-03T00:32:03Z", "updated_at": "2018-11-23T15:32:42Z", "html_url": "https://github.com/pytorch/pytorch/pull/881#discussion_r104065217", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/881", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/104065217"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/881#discussion_r104065217"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/881"}}, "body_html": "<p>The first module is the outermost module (i.e. <code>list(network.modules())[0] == network</code>), which is the same module that the user passed as an argument to replicate.</p>\n<p>This is the same behavior that replicate had before:</p>\n<pre><code>  replicate(network, devices) -&gt; replicas\n</code></pre>\n<p>where replicas is a list of copies of the module <code>network</code> (i.e.<code>len(replicas) == len(devices)</code>)</p>", "body_text": "The first module is the outermost module (i.e. list(network.modules())[0] == network), which is the same module that the user passed as an argument to replicate.\nThis is the same behavior that replicate had before:\n  replicate(network, devices) -> replicas\n\nwhere replicas is a list of copies of the module network (i.e.len(replicas) == len(devices))", "in_reply_to_id": 104061211}