{"url": "https://api.github.com/repos/pytorch/pytorch/issues/6898", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/6898/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/6898/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/6898/events", "html_url": "https://github.com/pytorch/pytorch/issues/6898", "id": 317208485, "node_id": "MDU6SXNzdWUzMTcyMDg0ODU=", "number": 6898, "title": "[Caffe2] cudnn versions compatibility issue.", "user": {"login": "MalKeshar", "id": 13730780, "node_id": "MDQ6VXNlcjEzNzMwNzgw", "avatar_url": "https://avatars1.githubusercontent.com/u/13730780?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MalKeshar", "html_url": "https://github.com/MalKeshar", "followers_url": "https://api.github.com/users/MalKeshar/followers", "following_url": "https://api.github.com/users/MalKeshar/following{/other_user}", "gists_url": "https://api.github.com/users/MalKeshar/gists{/gist_id}", "starred_url": "https://api.github.com/users/MalKeshar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MalKeshar/subscriptions", "organizations_url": "https://api.github.com/users/MalKeshar/orgs", "repos_url": "https://api.github.com/users/MalKeshar/repos", "events_url": "https://api.github.com/users/MalKeshar/events{/privacy}", "received_events_url": "https://api.github.com/users/MalKeshar/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 424131847, "node_id": "MDU6TGFiZWw0MjQxMzE4NDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/bug", "name": "bug", "color": "b60205", "default": true}, {"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}, {"id": 806617721, "node_id": "MDU6TGFiZWw4MDY2MTc3MjE=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/cudnn", "name": "cudnn", "color": "fbca04", "default": false}], "state": "open", "locked": false, "assignee": {"login": "pjh5", "id": 6456020, "node_id": "MDQ6VXNlcjY0NTYwMjA=", "avatar_url": "https://avatars1.githubusercontent.com/u/6456020?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pjh5", "html_url": "https://github.com/pjh5", "followers_url": "https://api.github.com/users/pjh5/followers", "following_url": "https://api.github.com/users/pjh5/following{/other_user}", "gists_url": "https://api.github.com/users/pjh5/gists{/gist_id}", "starred_url": "https://api.github.com/users/pjh5/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pjh5/subscriptions", "organizations_url": "https://api.github.com/users/pjh5/orgs", "repos_url": "https://api.github.com/users/pjh5/repos", "events_url": "https://api.github.com/users/pjh5/events{/privacy}", "received_events_url": "https://api.github.com/users/pjh5/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pjh5", "id": 6456020, "node_id": "MDQ6VXNlcjY0NTYwMjA=", "avatar_url": "https://avatars1.githubusercontent.com/u/6456020?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pjh5", "html_url": "https://github.com/pjh5", "followers_url": "https://api.github.com/users/pjh5/followers", "following_url": "https://api.github.com/users/pjh5/following{/other_user}", "gists_url": "https://api.github.com/users/pjh5/gists{/gist_id}", "starred_url": "https://api.github.com/users/pjh5/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pjh5/subscriptions", "organizations_url": "https://api.github.com/users/pjh5/orgs", "repos_url": "https://api.github.com/users/pjh5/repos", "events_url": "https://api.github.com/users/pjh5/events{/privacy}", "received_events_url": "https://api.github.com/users/pjh5/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2018-04-24T12:44:51Z", "updated_at": "2018-04-25T17:49:35Z", "closed_at": null, "author_association": "NONE", "body_html": "<h2>Issue description</h2>\n<p>For any cudnn update (minor or patch level) user have to rebuild caffe2. This is wrong from cudnn7 and on. Please, take a look: <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"303577664\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/tensorflow/tensorflow/issues/17566\" data-hovercard-type=\"issue\" data-hovercard-url=\"/tensorflow/tensorflow/issues/17566/hovercard?comment_id=372749050&amp;comment_type=issue_comment\" href=\"https://github.com/tensorflow/tensorflow/issues/17566#issuecomment-372749050\">tensorflow/tensorflow#17566 (comment)</a><br>\nIn short:<br>\ncudnn 7.0.x is backward compatible with cudnn 7.0.1. cudnn 7.1.x is also backward compatible down to cudnn 7.0.1.</p>\n<p>This code from caffe2/core/common_cudnn.h is root of problem:</p>\n<pre><code>// report the version of cuDNN Caffe2 was compiled with\ninline size_t cudnnCompiledVersion() {\n  return CUDNN_VERSION;\n}\n// report the runtime version of cuDNN\ninline size_t cudnnRuntimeVersion() {\n  return cudnnGetVersion();\n}\n\n// Check compatibility of compiled and runtime cuDNN versions\ninline void CheckCuDNNVersions() {\n  // Version format is major*1000 + minor*100 + patch\n  // Major, minor and patch versions must all match\n  bool version_match = cudnnCompiledVersion() == cudnnRuntimeVersion();\n  CAFFE_ENFORCE(version_match,\n                \"cuDNN compiled (\", cudnnCompiledVersion(), \") and \"\n                \"runtime (\", cudnnRuntimeVersion(), \") versions mismatch\");\n\n\n}\n\n</code></pre>\n<p>For now we have a little bit hackish workaround for this:</p>\n<pre><code>diff --git a/caffe2/core/context_gpu.cu b/caffe2/core/context_gpu.cu\nindex 46e73f3..56a4ed5 100644\n--- a/caffe2/core/context_gpu.cu\n+++ b/caffe2/core/context_gpu.cu\n@@ -183,8 +183,10 @@ static void Caffe2InitializeCuda() {\n   RegisterTensorInfoFunction(\n       TypeMeta::Id&lt;Tensor&lt;CUDAContext&gt;&gt;(), GetCUDATensorInfo);\n \n+#if CUDNN_MAJOR &lt; 7\n   // Check the versions of cuDNN that were compiled and linked with are compatible\n   CheckCuDNNVersions();\n+#endif\n }\n \n #ifdef CAFFE2_USE_CNMEM\n</code></pre>", "body_text": "Issue description\nFor any cudnn update (minor or patch level) user have to rebuild caffe2. This is wrong from cudnn7 and on. Please, take a look: tensorflow/tensorflow#17566 (comment)\nIn short:\ncudnn 7.0.x is backward compatible with cudnn 7.0.1. cudnn 7.1.x is also backward compatible down to cudnn 7.0.1.\nThis code from caffe2/core/common_cudnn.h is root of problem:\n// report the version of cuDNN Caffe2 was compiled with\ninline size_t cudnnCompiledVersion() {\n  return CUDNN_VERSION;\n}\n// report the runtime version of cuDNN\ninline size_t cudnnRuntimeVersion() {\n  return cudnnGetVersion();\n}\n\n// Check compatibility of compiled and runtime cuDNN versions\ninline void CheckCuDNNVersions() {\n  // Version format is major*1000 + minor*100 + patch\n  // Major, minor and patch versions must all match\n  bool version_match = cudnnCompiledVersion() == cudnnRuntimeVersion();\n  CAFFE_ENFORCE(version_match,\n                \"cuDNN compiled (\", cudnnCompiledVersion(), \") and \"\n                \"runtime (\", cudnnRuntimeVersion(), \") versions mismatch\");\n\n\n}\n\n\nFor now we have a little bit hackish workaround for this:\ndiff --git a/caffe2/core/context_gpu.cu b/caffe2/core/context_gpu.cu\nindex 46e73f3..56a4ed5 100644\n--- a/caffe2/core/context_gpu.cu\n+++ b/caffe2/core/context_gpu.cu\n@@ -183,8 +183,10 @@ static void Caffe2InitializeCuda() {\n   RegisterTensorInfoFunction(\n       TypeMeta::Id<Tensor<CUDAContext>>(), GetCUDATensorInfo);\n \n+#if CUDNN_MAJOR < 7\n   // Check the versions of cuDNN that were compiled and linked with are compatible\n   CheckCuDNNVersions();\n+#endif\n }\n \n #ifdef CAFFE2_USE_CNMEM", "body": "## Issue description\r\nFor any cudnn update (minor or patch level) user have to rebuild caffe2. This is wrong from cudnn7 and on. Please, take a look: https://github.com/tensorflow/tensorflow/issues/17566#issuecomment-372749050\r\nIn short:\r\ncudnn 7.0.x is backward compatible with cudnn 7.0.1. cudnn 7.1.x is also backward compatible down to cudnn 7.0.1.\r\n\r\nThis code from caffe2/core/common_cudnn.h is root of problem:\r\n\r\n```\r\n// report the version of cuDNN Caffe2 was compiled with\r\ninline size_t cudnnCompiledVersion() {\r\n  return CUDNN_VERSION;\r\n}\r\n// report the runtime version of cuDNN\r\ninline size_t cudnnRuntimeVersion() {\r\n  return cudnnGetVersion();\r\n}\r\n\r\n// Check compatibility of compiled and runtime cuDNN versions\r\ninline void CheckCuDNNVersions() {\r\n  // Version format is major*1000 + minor*100 + patch\r\n  // Major, minor and patch versions must all match\r\n  bool version_match = cudnnCompiledVersion() == cudnnRuntimeVersion();\r\n  CAFFE_ENFORCE(version_match,\r\n                \"cuDNN compiled (\", cudnnCompiledVersion(), \") and \"\r\n                \"runtime (\", cudnnRuntimeVersion(), \") versions mismatch\");\r\n\r\n\r\n}\r\n\r\n```\r\n\r\nFor now we have a little bit hackish workaround for this:\r\n\r\n```\r\ndiff --git a/caffe2/core/context_gpu.cu b/caffe2/core/context_gpu.cu\r\nindex 46e73f3..56a4ed5 100644\r\n--- a/caffe2/core/context_gpu.cu\r\n+++ b/caffe2/core/context_gpu.cu\r\n@@ -183,8 +183,10 @@ static void Caffe2InitializeCuda() {\r\n   RegisterTensorInfoFunction(\r\n       TypeMeta::Id<Tensor<CUDAContext>>(), GetCUDATensorInfo);\r\n \r\n+#if CUDNN_MAJOR < 7\r\n   // Check the versions of cuDNN that were compiled and linked with are compatible\r\n   CheckCuDNNVersions();\r\n+#endif\r\n }\r\n \r\n #ifdef CAFFE2_USE_CNMEM\r\n```\r\n\r\n"}