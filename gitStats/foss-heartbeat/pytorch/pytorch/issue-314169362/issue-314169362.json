{"url": "https://api.github.com/repos/pytorch/pytorch/issues/6590", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/6590/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/6590/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/6590/events", "html_url": "https://github.com/pytorch/pytorch/issues/6590", "id": 314169362, "node_id": "MDU6SXNzdWUzMTQxNjkzNjI=", "number": 6590, "title": "When building from source THD does not link with Gloo", "user": {"login": "agayev", "id": 434474, "node_id": "MDQ6VXNlcjQzNDQ3NA==", "avatar_url": "https://avatars1.githubusercontent.com/u/434474?v=4", "gravatar_id": "", "url": "https://api.github.com/users/agayev", "html_url": "https://github.com/agayev", "followers_url": "https://api.github.com/users/agayev/followers", "following_url": "https://api.github.com/users/agayev/following{/other_user}", "gists_url": "https://api.github.com/users/agayev/gists{/gist_id}", "starred_url": "https://api.github.com/users/agayev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/agayev/subscriptions", "organizations_url": "https://api.github.com/users/agayev/orgs", "repos_url": "https://api.github.com/users/agayev/repos", "events_url": "https://api.github.com/users/agayev/events{/privacy}", "received_events_url": "https://api.github.com/users/agayev/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 545367190, "node_id": "MDU6TGFiZWw1NDUzNjcxOTA=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/awaiting%20response", "name": "awaiting response", "color": "5319e7", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-04-13T16:18:22Z", "updated_at": "2018-05-14T20:36:30Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>This is on Centos 7.4.1708 with kernel 3.10.</p>\n<p>The first issue is compilation fails with the following error:</p>\n<div class=\"highlight highlight-source-makefile\"><pre><span class=\"pl-en\">/homes/foo/pytorch/third_party/gloo/gloo/common/linux.cc</span>:248:13: note: suggested alternative: 'DT_UNKNOWN'                                                                                                                                 \n   if (rv != SPEED_UNKNOWN) {                                                                                                                                                                                                                 \n             ^~~~~~~~~~~~~                                                                                                                                                                                                                    \n             DT_UNKNOWN                                                                                                                                                                                                                       \n<span class=\"pl-en\">make[2]</span>: <span class=\"pl-c1\">***</span> [gloo/CMakeFiles/gloo.dir/common/linux.cc.o] Error 1                                                                                                                                                                             \n<span class=\"pl-en\">make[2]</span>: <span class=\"pl-c1\">***</span> Waiting for unfinished jobs....                                                                                                                                                                                                  \n<span class=\"pl-en\">make[1]</span>: <span class=\"pl-c1\">***</span> [gloo/CMakeFiles/gloo.dir/all] Error 2                                                                                                                                                                                           \n<span class=\"pl-en\">make</span>: <span class=\"pl-c1\">***</span> [all] Error 2    </pre></div>\n<p>But that can be fixed by adding \"#define SPEED_UNKNOWN -1\" to linux.cc.  After it is fixed, the build completes successfully.  Now when trying to run a distributed code, we get the following error:</p>\n<div class=\"highlight highlight-source-python\"><pre>Python <span class=\"pl-c1\">3.6</span>.4 <span class=\"pl-k\">|</span>Anaconda, Inc.<span class=\"pl-k\">|</span> (default, Mar <span class=\"pl-c1\">13</span> <span class=\"pl-c1\">2018</span>, <span class=\"pl-c1\">0<span class=\"pl-ii\">1</span></span>:<span class=\"pl-c1\">15</span>:<span class=\"pl-c1\">57</span>)                                                                                                                                                                                \n[<span class=\"pl-c1\">GCC</span> <span class=\"pl-c1\">7.2</span>.0] on linux                                                                                                                                                                                                                          \nType <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>help<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>copyright<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>credits<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">or</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>license<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">for</span> more information.                                                                                                                                                                        \n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">import</span> torch                                                                                                                                                                                                                              \n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> torch._C._dist_init_process_group(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>gloo<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>tcp://<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">2</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>foo<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">0</span>)                                                                                                                                                                          \nTraceback (most recent call last):                                                                                                                                                                                                            \n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;stdin&gt;<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">1</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>                                                                                                                                                                                                         \n<span class=\"pl-c1\">RuntimeError</span>: the Gloo backend <span class=\"pl-k\">is</span> <span class=\"pl-k\">not</span> available; <span class=\"pl-k\">try</span> to recompile the <span class=\"pl-c1\">THD</span> package <span class=\"pl-k\">with</span> Gloo support at <span class=\"pl-k\">/</span>homes<span class=\"pl-k\">/</span>foo<span class=\"pl-k\">/</span>sp<span class=\"pl-k\">/</span>torch<span class=\"pl-k\">/</span>lib<span class=\"pl-k\">/</span><span class=\"pl-c1\">THD</span><span class=\"pl-k\">/</span>process_group<span class=\"pl-k\">/</span>General.cpp:<span class=\"pl-c1\">17</span></pre></div>\n<p>Looking at the build log, we can see that somehow Gloo is not found when building THD -- see the last line:</p>\n<div class=\"highlight highlight-source-makefile\"><pre>+ mkdir -p build/THD\n+ pushd build/THD\n~/pytorch/torch/lib/build/THD ~/pytorch/torch/lib ~/pytorch\n+ BUILD_C_FLAGS=\n+ case $1 in\n+ BUILD_C_FLAGS=' -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytor\\\nch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_\\\n<span class=\"pl-smi\">MPICXX</span>=1 -fexceptions'\n+ cmake ../../THD -DCMAKE_MODULE_PATH=/homes/foo/pytorch/cmake/FindCUDA -DTorch_FOUND=1 -DCMAKE_INSTALL_PREFIX=/homes/foo/pytorch/torch/lib/tmp_install '-DCMAKE_C_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_inst\\\nall/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_in\\\nstall/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1 -fexceptions  -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fst\\\nack-protector-strong -fno-plt -O2 -pipe' '-DCMAKE_CXX_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_in\\\nstall/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/l\\\nib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1 -fexceptions  -std=c++11   -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe' '-DCMAKE_EXE_LINKER_FLAGS=-L\"/homes/foo/pytorch/torch/lib/\\\ntmp_install/lib\"  -Wl,-rpath,$ORIGIN  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -DNDEBUG -D_FORTIFY_SOURCE=2 -O2' '-D\\\n<span class=\"pl-smi\">CMAKE_SHARED_LINKER_FLAGS</span>=-L\"/homes/foo/pytorch/torch/lib/tmp_install/lib\"  -Wl,-rpath,$ORIGIN  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-st<span class=\"pl-cce\">\\</span>\nrong -fno-plt -O2 -pipe -DNDEBUG -D_FORTIFY_SOURCE=2 -O2' -DCMAKE_INSTALL_LIBDIR=/homes/foo/pytorch/torch/lib/tmp_install/lib '-DCUDA_NVCC_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/ag<span class=\"pl-cce\">\\</span>\nayev/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/h<span class=\"pl-cce\">\\</span>\nomes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1' -DCMAKE_PREFIX_PATH=/homes/foo/pytorch/torch/lib/tmp_install '-Dcwrap_files=/homes/foo/pyt<span class=\"pl-cce\">\\</span>\norch/torch/lib/ATen/Declarations.cwrap;/homes/foo/pytorch/torch/lib/THNN/generic/THNN.h;/homes/foo/pytorch/torch/lib/THCUNN/generic/THCUNN.h;/homes/foo/pytorch/torch/lib/ATen/nn.yaml' -DTH_INCLUDE_PATH=/homes/foo/pytorch/torc<span class=\"pl-cce\">\\</span>\nh/lib/tmp_install/include -DTH_LIB_PATH=/homes/foo/pytorch/torch/lib/tmp_install/lib -DTH_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTH.so.1 -DATEN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libATen.so<span class=\"pl-cce\">\\</span>\n.1 -DTHNN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHNN.so.1 -DTHCUNN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHCUNN.so.1 -DTHS_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHS.so.<span class=\"pl-cce\">\\</span>\n1 -DTHC_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHC.so.1 -DTHCS_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHCS.so.1 -DTH_SO_VERSION=1 -DTHC_SO_VERSION=1 -DTHNN_SO_VERSION=1 -DTHCUNN_SO_VERSION=1 -D<span class=\"pl-cce\">\\</span>\nTHD_SO_VERSION=1 -DNO_CUDA=1 -DNO_NNPACK=0 -DNCCL_EXTERNAL=1 -Dnanopb_BUILD_GENERATOR=0 -DCMAKE_DEBUG_POSTFIX= -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=1\n-- The C compiler identification is GNU 7.2.0\n-- The CXX compiler identification is GNU 7.2.0\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Check</span> <span class=\"pl-en\">for</span> <span class=\"pl-en\">working</span> <span class=\"pl-en\">C</span> <span class=\"pl-en\">compiler</span>: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-cc\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Check</span> <span class=\"pl-en\">for</span> <span class=\"pl-en\">working</span> <span class=\"pl-en\">C</span> <span class=\"pl-en\">compiler</span>: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-cc -- works\n-- Detecting C compiler ABI info\n-- Detecting C compiler ABI info - done\n-- Detecting C compile features\n-- Detecting C compile features - done\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Check</span> <span class=\"pl-en\">for</span> <span class=\"pl-en\">working</span> <span class=\"pl-en\">CXX</span> <span class=\"pl-en\">compiler</span>: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-c++\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Check</span> <span class=\"pl-en\">for</span> <span class=\"pl-en\">working</span> <span class=\"pl-en\">CXX</span> <span class=\"pl-en\">compiler</span>: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-c++ -- works\n-- Detecting CXX compiler ABI info\n-- Detecting CXX compiler ABI info - done\n-- Detecting CXX compile features\n-- Detecting CXX compile features - done\n-- Performing Test HAS_THREAD_LOCAL\n-- Performing Test HAS_THREAD_LOCAL - Success\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Could</span> <span class=\"pl-en\">NOT</span> <span class=\"pl-en\">find</span> <span class=\"pl-en\">NCCL</span> <span class=\"pl-en\">(missing</span>: NCCL_INCLUDE_DIR NCCL_LIBRARY)\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Found</span> <span class=\"pl-en\">MPI_C</span>: /homes/foo/miniconda3/envs/sp/lib/libmpi.so\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Found</span> <span class=\"pl-en\">MPI_CXX</span>: /homes/foo/miniconda3/envs/sp/lib/libmpicxx.so;/homes/foo/miniconda3/envs/sp/lib/libmpi.so\n<span class=\"pl-en\">--</span> <span class=\"pl-en\">Found</span> <span class=\"pl-en\">Gloo</span>: FALSE</pre></div>", "body_text": "This is on Centos 7.4.1708 with kernel 3.10.\nThe first issue is compilation fails with the following error:\n/homes/foo/pytorch/third_party/gloo/gloo/common/linux.cc:248:13: note: suggested alternative: 'DT_UNKNOWN'                                                                                                                                 \n   if (rv != SPEED_UNKNOWN) {                                                                                                                                                                                                                 \n             ^~~~~~~~~~~~~                                                                                                                                                                                                                    \n             DT_UNKNOWN                                                                                                                                                                                                                       \nmake[2]: *** [gloo/CMakeFiles/gloo.dir/common/linux.cc.o] Error 1                                                                                                                                                                             \nmake[2]: *** Waiting for unfinished jobs....                                                                                                                                                                                                  \nmake[1]: *** [gloo/CMakeFiles/gloo.dir/all] Error 2                                                                                                                                                                                           \nmake: *** [all] Error 2    \nBut that can be fixed by adding \"#define SPEED_UNKNOWN -1\" to linux.cc.  After it is fixed, the build completes successfully.  Now when trying to run a distributed code, we get the following error:\nPython 3.6.4 |Anaconda, Inc.| (default, Mar 13 2018, 01:15:57)                                                                                                                                                                                \n[GCC 7.2.0] on linux                                                                                                                                                                                                                          \nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.                                                                                                                                                                        \n>>> import torch                                                                                                                                                                                                                              \n>>> torch._C._dist_init_process_group(\"gloo\", \"tcp://\", 2, \"foo\", 0)                                                                                                                                                                          \nTraceback (most recent call last):                                                                                                                                                                                                            \n  File \"<stdin>\", line 1, in <module>                                                                                                                                                                                                         \nRuntimeError: the Gloo backend is not available; try to recompile the THD package with Gloo support at /homes/foo/sp/torch/lib/THD/process_group/General.cpp:17\nLooking at the build log, we can see that somehow Gloo is not found when building THD -- see the last line:\n+ mkdir -p build/THD\n+ pushd build/THD\n~/pytorch/torch/lib/build/THD ~/pytorch/torch/lib ~/pytorch\n+ BUILD_C_FLAGS=\n+ case $1 in\n+ BUILD_C_FLAGS=' -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytor\\\nch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_\\\nMPICXX=1 -fexceptions'\n+ cmake ../../THD -DCMAKE_MODULE_PATH=/homes/foo/pytorch/cmake/FindCUDA -DTorch_FOUND=1 -DCMAKE_INSTALL_PREFIX=/homes/foo/pytorch/torch/lib/tmp_install '-DCMAKE_C_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_inst\\\nall/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_in\\\nstall/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1 -fexceptions  -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fst\\\nack-protector-strong -fno-plt -O2 -pipe' '-DCMAKE_CXX_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_in\\\nstall/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/l\\\nib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1 -fexceptions  -std=c++11   -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe' '-DCMAKE_EXE_LINKER_FLAGS=-L\"/homes/foo/pytorch/torch/lib/\\\ntmp_install/lib\"  -Wl,-rpath,$ORIGIN  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -DNDEBUG -D_FORTIFY_SOURCE=2 -O2' '-D\\\nCMAKE_SHARED_LINKER_FLAGS=-L\"/homes/foo/pytorch/torch/lib/tmp_install/lib\"  -Wl,-rpath,$ORIGIN  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-st\\\nrong -fno-plt -O2 -pipe -DNDEBUG -D_FORTIFY_SOURCE=2 -O2' -DCMAKE_INSTALL_LIBDIR=/homes/foo/pytorch/torch/lib/tmp_install/lib '-DCUDA_NVCC_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/ag\\\nayev/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/h\\\nomes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1' -DCMAKE_PREFIX_PATH=/homes/foo/pytorch/torch/lib/tmp_install '-Dcwrap_files=/homes/foo/pyt\\\norch/torch/lib/ATen/Declarations.cwrap;/homes/foo/pytorch/torch/lib/THNN/generic/THNN.h;/homes/foo/pytorch/torch/lib/THCUNN/generic/THCUNN.h;/homes/foo/pytorch/torch/lib/ATen/nn.yaml' -DTH_INCLUDE_PATH=/homes/foo/pytorch/torc\\\nh/lib/tmp_install/include -DTH_LIB_PATH=/homes/foo/pytorch/torch/lib/tmp_install/lib -DTH_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTH.so.1 -DATEN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libATen.so\\\n.1 -DTHNN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHNN.so.1 -DTHCUNN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHCUNN.so.1 -DTHS_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHS.so.\\\n1 -DTHC_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHC.so.1 -DTHCS_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHCS.so.1 -DTH_SO_VERSION=1 -DTHC_SO_VERSION=1 -DTHNN_SO_VERSION=1 -DTHCUNN_SO_VERSION=1 -D\\\nTHD_SO_VERSION=1 -DNO_CUDA=1 -DNO_NNPACK=0 -DNCCL_EXTERNAL=1 -Dnanopb_BUILD_GENERATOR=0 -DCMAKE_DEBUG_POSTFIX= -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=1\n-- The C compiler identification is GNU 7.2.0\n-- The CXX compiler identification is GNU 7.2.0\n-- Check for working C compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-cc\n-- Check for working C compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-cc -- works\n-- Detecting C compiler ABI info\n-- Detecting C compiler ABI info - done\n-- Detecting C compile features\n-- Detecting C compile features - done\n-- Check for working CXX compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-c++\n-- Check for working CXX compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-c++ -- works\n-- Detecting CXX compiler ABI info\n-- Detecting CXX compiler ABI info - done\n-- Detecting CXX compile features\n-- Detecting CXX compile features - done\n-- Performing Test HAS_THREAD_LOCAL\n-- Performing Test HAS_THREAD_LOCAL - Success\n-- Could NOT find NCCL (missing: NCCL_INCLUDE_DIR NCCL_LIBRARY)\n-- Found MPI_C: /homes/foo/miniconda3/envs/sp/lib/libmpi.so\n-- Found MPI_CXX: /homes/foo/miniconda3/envs/sp/lib/libmpicxx.so;/homes/foo/miniconda3/envs/sp/lib/libmpi.so\n-- Found Gloo: FALSE", "body": "This is on Centos 7.4.1708 with kernel 3.10.\r\n\r\nThe first issue is compilation fails with the following error:\r\n\r\n```make\r\n/homes/foo/pytorch/third_party/gloo/gloo/common/linux.cc:248:13: note: suggested alternative: 'DT_UNKNOWN'                                                                                                                                 \r\n   if (rv != SPEED_UNKNOWN) {                                                                                                                                                                                                                 \r\n             ^~~~~~~~~~~~~                                                                                                                                                                                                                    \r\n             DT_UNKNOWN                                                                                                                                                                                                                       \r\nmake[2]: *** [gloo/CMakeFiles/gloo.dir/common/linux.cc.o] Error 1                                                                                                                                                                             \r\nmake[2]: *** Waiting for unfinished jobs....                                                                                                                                                                                                  \r\nmake[1]: *** [gloo/CMakeFiles/gloo.dir/all] Error 2                                                                                                                                                                                           \r\nmake: *** [all] Error 2    \r\n```\r\n\r\nBut that can be fixed by adding \"#define SPEED_UNKNOWN -1\" to linux.cc.  After it is fixed, the build completes successfully.  Now when trying to run a distributed code, we get the following error:\r\n\r\n```python\r\nPython 3.6.4 |Anaconda, Inc.| (default, Mar 13 2018, 01:15:57)                                                                                                                                                                                \r\n[GCC 7.2.0] on linux                                                                                                                                                                                                                          \r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.                                                                                                                                                                        \r\n>>> import torch                                                                                                                                                                                                                              \r\n>>> torch._C._dist_init_process_group(\"gloo\", \"tcp://\", 2, \"foo\", 0)                                                                                                                                                                          \r\nTraceback (most recent call last):                                                                                                                                                                                                            \r\n  File \"<stdin>\", line 1, in <module>                                                                                                                                                                                                         \r\nRuntimeError: the Gloo backend is not available; try to recompile the THD package with Gloo support at /homes/foo/sp/torch/lib/THD/process_group/General.cpp:17\r\n```  \r\n\r\n\r\nLooking at the build log, we can see that somehow Gloo is not found when building THD -- see the last line:\r\n\r\n\r\n```make\r\n+ mkdir -p build/THD\r\n+ pushd build/THD\r\n~/pytorch/torch/lib/build/THD ~/pytorch/torch/lib ~/pytorch\r\n+ BUILD_C_FLAGS=\r\n+ case $1 in\r\n+ BUILD_C_FLAGS=' -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytor\\\r\nch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_\\\r\nMPICXX=1 -fexceptions'\r\n+ cmake ../../THD -DCMAKE_MODULE_PATH=/homes/foo/pytorch/cmake/FindCUDA -DTorch_FOUND=1 -DCMAKE_INSTALL_PREFIX=/homes/foo/pytorch/torch/lib/tmp_install '-DCMAKE_C_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_inst\\\r\nall/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_in\\\r\nstall/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1 -fexceptions  -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fst\\\r\nack-protector-strong -fno-plt -O2 -pipe' '-DCMAKE_CXX_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_in\\\r\nstall/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/l\\\r\nib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1 -fexceptions  -std=c++11   -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe' '-DCMAKE_EXE_LINKER_FLAGS=-L\"/homes/foo/pytorch/torch/lib/\\\r\ntmp_install/lib\"  -Wl,-rpath,$ORIGIN  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -DNDEBUG -D_FORTIFY_SOURCE=2 -O2' '-D\\\r\nCMAKE_SHARED_LINKER_FLAGS=-L\"/homes/foo/pytorch/torch/lib/tmp_install/lib\"  -Wl,-rpath,$ORIGIN  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-st\\\r\nrong -fno-plt -O2 -pipe -DNDEBUG -D_FORTIFY_SOURCE=2 -O2' -DCMAKE_INSTALL_LIBDIR=/homes/foo/pytorch/torch/lib/tmp_install/lib '-DCUDA_NVCC_FLAGS= -DTH_INDEX_BASE=0 -I\"/homes/foo/pytorch/torch/lib/tmp_install/include\"   -I\"/homes/ag\\\r\nayev/pytorch/torch/lib/tmp_install/include/TH\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THC\"   -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THS\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCS\"   -I\"/h\\\r\nomes/foo/pytorch/torch/lib/tmp_install/include/THNN\" -I\"/homes/foo/pytorch/torch/lib/tmp_install/include/THCUNN\" -DOMPI_SKIP_MPICXX=1' -DCMAKE_PREFIX_PATH=/homes/foo/pytorch/torch/lib/tmp_install '-Dcwrap_files=/homes/foo/pyt\\\r\norch/torch/lib/ATen/Declarations.cwrap;/homes/foo/pytorch/torch/lib/THNN/generic/THNN.h;/homes/foo/pytorch/torch/lib/THCUNN/generic/THCUNN.h;/homes/foo/pytorch/torch/lib/ATen/nn.yaml' -DTH_INCLUDE_PATH=/homes/foo/pytorch/torc\\\r\nh/lib/tmp_install/include -DTH_LIB_PATH=/homes/foo/pytorch/torch/lib/tmp_install/lib -DTH_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTH.so.1 -DATEN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libATen.so\\\r\n.1 -DTHNN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHNN.so.1 -DTHCUNN_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHCUNN.so.1 -DTHS_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHS.so.\\\r\n1 -DTHC_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHC.so.1 -DTHCS_LIBRARIES=/homes/foo/pytorch/torch/lib/tmp_install/lib/libTHCS.so.1 -DTH_SO_VERSION=1 -DTHC_SO_VERSION=1 -DTHNN_SO_VERSION=1 -DTHCUNN_SO_VERSION=1 -D\\\r\nTHD_SO_VERSION=1 -DNO_CUDA=1 -DNO_NNPACK=0 -DNCCL_EXTERNAL=1 -Dnanopb_BUILD_GENERATOR=0 -DCMAKE_DEBUG_POSTFIX= -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=1\r\n-- The C compiler identification is GNU 7.2.0\r\n-- The CXX compiler identification is GNU 7.2.0\r\n-- Check for working C compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-cc\r\n-- Check for working C compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-cc -- works\r\n-- Detecting C compiler ABI info\r\n-- Detecting C compiler ABI info - done\r\n-- Detecting C compile features\r\n-- Detecting C compile features - done\r\n-- Check for working CXX compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-c++\r\n-- Check for working CXX compiler: /homes/foo/miniconda3/envs/sp/bin/x86_64-conda_cos6-linux-gnu-c++ -- works\r\n-- Detecting CXX compiler ABI info\r\n-- Detecting CXX compiler ABI info - done\r\n-- Detecting CXX compile features\r\n-- Detecting CXX compile features - done\r\n-- Performing Test HAS_THREAD_LOCAL\r\n-- Performing Test HAS_THREAD_LOCAL - Success\r\n-- Could NOT find NCCL (missing: NCCL_INCLUDE_DIR NCCL_LIBRARY)\r\n-- Found MPI_C: /homes/foo/miniconda3/envs/sp/lib/libmpi.so\r\n-- Found MPI_CXX: /homes/foo/miniconda3/envs/sp/lib/libmpicxx.so;/homes/foo/miniconda3/envs/sp/lib/libmpi.so\r\n-- Found Gloo: FALSE\r\n"}