{"url": "https://api.github.com/repos/pytorch/pytorch/issues/11887", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/11887/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/11887/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/11887/events", "html_url": "https://github.com/pytorch/pytorch/issues/11887", "id": 362131696, "node_id": "MDU6SXNzdWUzNjIxMzE2OTY=", "number": 11887, "title": "DataLoader, when num_worker is great than 1, the data loaded are wrong, or a error a reported!", "user": {"login": "yunyundong", "id": 24907398, "node_id": "MDQ6VXNlcjI0OTA3Mzk4", "avatar_url": "https://avatars2.githubusercontent.com/u/24907398?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yunyundong", "html_url": "https://github.com/yunyundong", "followers_url": "https://api.github.com/users/yunyundong/followers", "following_url": "https://api.github.com/users/yunyundong/following{/other_user}", "gists_url": "https://api.github.com/users/yunyundong/gists{/gist_id}", "starred_url": "https://api.github.com/users/yunyundong/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yunyundong/subscriptions", "organizations_url": "https://api.github.com/users/yunyundong/orgs", "repos_url": "https://api.github.com/users/yunyundong/repos", "events_url": "https://api.github.com/users/yunyundong/events{/privacy}", "received_events_url": "https://api.github.com/users/yunyundong/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2018-09-20T10:53:55Z", "updated_at": "2018-09-21T01:53:14Z", "closed_at": "2018-09-20T15:50:32Z", "author_association": "NONE", "body_html": "<pre><code>class DeephomographyDataset(Dataset):\n    '''\n    DeepHomography Dataset\n    '''\n    def __init__(self,hdf5file,imgs_key='images',labels_key='labels',\n                 transform=None):\n        '''\n        :argument\n        :param hdf5file: the hdf5 file including the images and the label.\n        :param transform (callable, optional): Optional transform to be\n        applied on a sample\n        '''\n        self.db=h5py.File(hdf5file,'r') # store the images and the labels\n        keys=list(self.db.keys())\n        if imgs_key not in keys:\n            raise(' the ims_key should not be {}, should be one of {}'\n                  .format(imgs_key,keys))\n        if labels_key not in keys:\n            raise(' the labels_key should not be {}, should be one of {}'\n                  .format(labels_key,keys))\n        self.imgs_key=imgs_key\n        self.labels_key=labels_key\n        self.transform=transform\n    def __len__(self):\n        return len(self.db[self.labels_key])\n    def __getitem__(self, idx):\n        image=self.db[self.imgs_key][idx]\n        label=self.db[self.labels_key][idx]\n        sample={'images':image,'labels':label}\n        if self.transform:\n            sample=self.transform(sample)\n        return sample\n\n</code></pre>\n<pre><code>batchSize=30\n    trainDataset=DeephomographyDataset(pth_config.TRAIN_H5_FILE,\n                                       transform=transforms.Lambda(\n                                           lambda x: toTensor(x)))\n\n\n    traindataloader=DataLoader(trainDataset,batch_size=batchSize,shuffle=True,\n                          num_workers=20)\n</code></pre>\n<pre><code>#   samplesss=trainDataset[0]\n</code></pre>\n<pre><code>for i, sample in enumerate(trainDataset):\n      ....\n</code></pre>\n<p>some errors are repoted as follows:</p>\n<pre><code>Traceback (most recent call last):\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/my_Model/training_deephomography.py\", line 138, in &lt;module&gt;\n    epoch_num)\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/my_Model/training_deephomography.py\", line 49, in train_model\n    for i, sample in enumerate(dataloaders[phase]):\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 322, in __next__\n    return self._process_next_batch(batch)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 357, in _process_next_batch\n    raise batch.exc_type(batch.exc_msg)\nKeyError: 'Traceback (most recent call last):\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 106, in _worker_loop\\n    samples = collate_fn([dataset[i] for i in batch_indices])\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 106, in &lt;listcomp&gt;\\n    samples = collate_fn([dataset[i] for i in batch_indices])\\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/preprocessing/generate_dataset.py\", line 34, in __getitem__\\n    label=self.db[self.labels_key][idx]\\n  File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\\n  File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/h5py/_hl/group.py\", line 167, in __getitem__\\n    oid = h5o.open(self.id, self._e(name), lapl=self._lapl)\\n  File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\\n  File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\\n  File \"h5py/h5o.pyx\", line 190, in h5py.h5o.open\\nKeyError: \\'Unable to open object (bad object header version number)\\'\\n'\nException ignored in: &lt;bound method _DataLoaderIter.__del__ of &lt;torch.utils.data.dataloader._DataLoaderIter object at 0x7f09bc58dac8&gt;&gt;\nTraceback (most recent call last):\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\n    self._shutdown_workers()\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\n    self.worker_result_queue.get()\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/queues.py\", line 337, in get\n    return _ForkingPickler.loads(res)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 151, in rebuild_storage_fd\n    fd = df.detach()\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/resource_sharer.py\", line 57, in detach\n    with _resource_sharer.get_connection(self._id) as conn:\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/resource_sharer.py\", line 87, in get_connection\n    c = Client(address, authkey=process.current_process().authkey)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/connection.py\", line 487, in Client\n    c = SocketClient(address)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/connection.py\", line 614, in SocketClient\n    s.connect(address)\nConnectionRefusedError: [Errno 111] Connection refused\n\nProcess finished with exit code 1\n</code></pre>\n<blockquote>\n</blockquote>\n<p>Interestingly,  when the code  <code>samplesss=trainDataset[0];</code> ` uncomment,  there is no error reported! But, the dataset traindataloader returned by the DataLoader is wrong, namely some data is not the raw data.</p>\n<p>So, I know how the num_wokers in DataLoader affect the code?<br>\nin addition, my computer have 32  cpu cores. I set num_workers to 20.<br>\nMy OS is unbuntu 16.0, the version of pytorch is 0.4! python is 3.6</p>", "body_text": "class DeephomographyDataset(Dataset):\n    '''\n    DeepHomography Dataset\n    '''\n    def __init__(self,hdf5file,imgs_key='images',labels_key='labels',\n                 transform=None):\n        '''\n        :argument\n        :param hdf5file: the hdf5 file including the images and the label.\n        :param transform (callable, optional): Optional transform to be\n        applied on a sample\n        '''\n        self.db=h5py.File(hdf5file,'r') # store the images and the labels\n        keys=list(self.db.keys())\n        if imgs_key not in keys:\n            raise(' the ims_key should not be {}, should be one of {}'\n                  .format(imgs_key,keys))\n        if labels_key not in keys:\n            raise(' the labels_key should not be {}, should be one of {}'\n                  .format(labels_key,keys))\n        self.imgs_key=imgs_key\n        self.labels_key=labels_key\n        self.transform=transform\n    def __len__(self):\n        return len(self.db[self.labels_key])\n    def __getitem__(self, idx):\n        image=self.db[self.imgs_key][idx]\n        label=self.db[self.labels_key][idx]\n        sample={'images':image,'labels':label}\n        if self.transform:\n            sample=self.transform(sample)\n        return sample\n\n\nbatchSize=30\n    trainDataset=DeephomographyDataset(pth_config.TRAIN_H5_FILE,\n                                       transform=transforms.Lambda(\n                                           lambda x: toTensor(x)))\n\n\n    traindataloader=DataLoader(trainDataset,batch_size=batchSize,shuffle=True,\n                          num_workers=20)\n\n#   samplesss=trainDataset[0]\n\nfor i, sample in enumerate(trainDataset):\n      ....\n\nsome errors are repoted as follows:\nTraceback (most recent call last):\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/my_Model/training_deephomography.py\", line 138, in <module>\n    epoch_num)\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/my_Model/training_deephomography.py\", line 49, in train_model\n    for i, sample in enumerate(dataloaders[phase]):\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 322, in __next__\n    return self._process_next_batch(batch)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 357, in _process_next_batch\n    raise batch.exc_type(batch.exc_msg)\nKeyError: 'Traceback (most recent call last):\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 106, in _worker_loop\\n    samples = collate_fn([dataset[i] for i in batch_indices])\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 106, in <listcomp>\\n    samples = collate_fn([dataset[i] for i in batch_indices])\\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/preprocessing/generate_dataset.py\", line 34, in __getitem__\\n    label=self.db[self.labels_key][idx]\\n  File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\\n  File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/h5py/_hl/group.py\", line 167, in __getitem__\\n    oid = h5o.open(self.id, self._e(name), lapl=self._lapl)\\n  File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\\n  File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\\n  File \"h5py/h5o.pyx\", line 190, in h5py.h5o.open\\nKeyError: \\'Unable to open object (bad object header version number)\\'\\n'\nException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x7f09bc58dac8>>\nTraceback (most recent call last):\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\n    self._shutdown_workers()\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\n    self.worker_result_queue.get()\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/queues.py\", line 337, in get\n    return _ForkingPickler.loads(res)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 151, in rebuild_storage_fd\n    fd = df.detach()\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/resource_sharer.py\", line 57, in detach\n    with _resource_sharer.get_connection(self._id) as conn:\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/resource_sharer.py\", line 87, in get_connection\n    c = Client(address, authkey=process.current_process().authkey)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/connection.py\", line 487, in Client\n    c = SocketClient(address)\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/connection.py\", line 614, in SocketClient\n    s.connect(address)\nConnectionRefusedError: [Errno 111] Connection refused\n\nProcess finished with exit code 1\n\n\n\nInterestingly,  when the code  samplesss=trainDataset[0]; ` uncomment,  there is no error reported! But, the dataset traindataloader returned by the DataLoader is wrong, namely some data is not the raw data.\nSo, I know how the num_wokers in DataLoader affect the code?\nin addition, my computer have 32  cpu cores. I set num_workers to 20.\nMy OS is unbuntu 16.0, the version of pytorch is 0.4! python is 3.6", "body": "```\r\nclass DeephomographyDataset(Dataset):\r\n    '''\r\n    DeepHomography Dataset\r\n    '''\r\n    def __init__(self,hdf5file,imgs_key='images',labels_key='labels',\r\n                 transform=None):\r\n        '''\r\n        :argument\r\n        :param hdf5file: the hdf5 file including the images and the label.\r\n        :param transform (callable, optional): Optional transform to be\r\n        applied on a sample\r\n        '''\r\n        self.db=h5py.File(hdf5file,'r') # store the images and the labels\r\n        keys=list(self.db.keys())\r\n        if imgs_key not in keys:\r\n            raise(' the ims_key should not be {}, should be one of {}'\r\n                  .format(imgs_key,keys))\r\n        if labels_key not in keys:\r\n            raise(' the labels_key should not be {}, should be one of {}'\r\n                  .format(labels_key,keys))\r\n        self.imgs_key=imgs_key\r\n        self.labels_key=labels_key\r\n        self.transform=transform\r\n    def __len__(self):\r\n        return len(self.db[self.labels_key])\r\n    def __getitem__(self, idx):\r\n        image=self.db[self.imgs_key][idx]\r\n        label=self.db[self.labels_key][idx]\r\n        sample={'images':image,'labels':label}\r\n        if self.transform:\r\n            sample=self.transform(sample)\r\n        return sample\r\n\r\n```\r\n```\r\nbatchSize=30\r\n    trainDataset=DeephomographyDataset(pth_config.TRAIN_H5_FILE,\r\n                                       transform=transforms.Lambda(\r\n                                           lambda x: toTensor(x)))\r\n\r\n\r\n    traindataloader=DataLoader(trainDataset,batch_size=batchSize,shuffle=True,\r\n                          num_workers=20)\r\n```\r\n```\r\n#   samplesss=trainDataset[0]\r\n```\r\n\r\n```\r\nfor i, sample in enumerate(trainDataset):\r\n      ....\r\n```\r\n\r\nsome errors are repoted as follows:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/my_Model/training_deephomography.py\", line 138, in <module>\r\n    epoch_num)\r\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/my_Model/training_deephomography.py\", line 49, in train_model\r\n    for i, sample in enumerate(dataloaders[phase]):\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 322, in __next__\r\n    return self._process_next_batch(batch)\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 357, in _process_next_batch\r\n    raise batch.exc_type(batch.exc_msg)\r\nKeyError: 'Traceback (most recent call last):\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 106, in _worker_loop\\n    samples = collate_fn([dataset[i] for i in batch_indices])\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 106, in <listcomp>\\n    samples = collate_fn([dataset[i] for i in batch_indices])\\n  File \"/home/dler/pytorch_codes_from_pc4/DeepHomography/preprocessing/generate_dataset.py\", line 34, in __getitem__\\n    label=self.db[self.labels_key][idx]\\n  File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\\n  File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/h5py/_hl/group.py\", line 167, in __getitem__\\n    oid = h5o.open(self.id, self._e(name), lapl=self._lapl)\\n  File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\\n  File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\\n  File \"h5py/h5o.pyx\", line 190, in h5py.h5o.open\\nKeyError: \\'Unable to open object (bad object header version number)\\'\\n'\r\nException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x7f09bc58dac8>>\r\nTraceback (most recent call last):\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\r\n    self._shutdown_workers()\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\r\n    self.worker_result_queue.get()\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/queues.py\", line 337, in get\r\n    return _ForkingPickler.loads(res)\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 151, in rebuild_storage_fd\r\n    fd = df.detach()\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/resource_sharer.py\", line 57, in detach\r\n    with _resource_sharer.get_connection(self._id) as conn:\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/resource_sharer.py\", line 87, in get_connection\r\n    c = Client(address, authkey=process.current_process().authkey)\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/connection.py\", line 487, in Client\r\n    c = SocketClient(address)\r\n  File \"/home/dler/anaconda3/envs/pytorch4/lib/python3.6/multiprocessing/connection.py\", line 614, in SocketClient\r\n    s.connect(address)\r\nConnectionRefusedError: [Errno 111] Connection refused\r\n\r\nProcess finished with exit code 1\r\n```\r\n\r\n>\r\nInterestingly,  when the code  `samplesss=trainDataset[0];` ` uncomment,  there is no error reported! But, the dataset traindataloader returned by the DataLoader is wrong, namely some data is not the raw data.\r\n\r\nSo, I know how the num_wokers in DataLoader affect the code?\r\nin addition, my computer have 32  cpu cores. I set num_workers to 20.\r\nMy OS is unbuntu 16.0, the version of pytorch is 0.4! python is 3.6"}