{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/213550302", "pull_request_review_id": 150401250, "id": 213550302, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzU1MDMwMg==", "diff_hunk": "@@ -11,69 +16,377 @@ template <class Context>\n class SpatialBNOp : public Operator<Context> {\n  public:\n   USE_OPERATOR_CONTEXT_FUNCTIONS;\n+\n   SpatialBNOp(const OperatorDef& operator_def, Workspace* ws)\n       : Operator<Context>(operator_def, ws),\n-        is_test_(this->template GetSingleArgument<int>(OpSchema::Arg_IsTest, 0)),\n-        epsilon_(this->template GetSingleArgument<float>(\"epsilon\", 1e-5f)),\n-        momentum_(this->template GetSingleArgument<float>(\"momentum\", 0.9f)),\n+        OP_SINGLE_ARG(bool, OpSchema::Arg_IsTest, is_test_, false),\n+        OP_SINGLE_ARG(double, \"epsilon\", epsilon_, 1e-5),\n+        OP_SINGLE_ARG(float, \"momentum\", momentum_, 0.9f),\n         order_(StringToStorageOrder(\n-            this->template GetSingleArgument<string>(\"order\", \"NCHW\"))),\n-        num_batches_(this->template GetSingleArgument<int>(\"num_batches\", 1)) {\n-    // TODO(jiayq): update the input and output size checks.\n+            OperatorBase::GetSingleArgument<string>(\"order\", \"NCHW\"))),\n+        OP_SINGLE_ARG(int, \"num_batches\", num_batches_, 1) {\n+    CAFFE_ENFORCE_NE(\n+        order_,\n+        StorageOrder::UNKNOWN,\n+        \"order should be either \\\"NCHW\\\" or \\\"NHWC\\\".\");\n     CAFFE_ENFORCE(\n         (is_test_ && OutputSize() == 1) || (!is_test_ && OutputSize() == 5));\n     CAFFE_ENFORCE_GT(epsilon_, 0);\n     CAFFE_ENFORCE_GE(momentum_, 0);\n     CAFFE_ENFORCE_LE(momentum_, 1);\n   }\n-  ~SpatialBNOp() {}\n+\n+  virtual ~SpatialBNOp() = default;\n \n   bool RunOnDevice() override {\n+    return DispatchHelper<TensorTypes<float>>::call(this, Input(0));\n+  }\n+\n+  template <typename T>\n+  bool DoRunWithType() {\n+    const auto& X = Input(INPUT);\n+    const auto& scale = Input(SCALE);\n+    const auto& bias = Input(BIAS);\n+    auto* Y = Output(OUTPUT);\n+\n+    const int ndim = X.ndim();\n+    CAFFE_ENFORCE_GE(ndim, 3);\n+    const int N = X.dim32(0);\n+    const int C =\n+        (order_ == StorageOrder::NCHW ? X.dim32(1) : X.dim32(ndim - 1));\n+    const std::vector<int> X_dims(X.dims().cbegin(), X.dims().cend());\n+    const int HxW =\n+        std::accumulate(\n+            X_dims.cbegin() + 1, X_dims.cend(), 1, std::multiplies<int>()) /\n+        C;\n+    CAFFE_ENFORCE_EQ(scale.size(), C);\n+    CAFFE_ENFORCE_EQ(bias.size(), C);\n+\n+    Y->ResizeLike(X);\n+    const T* X_data = X.template data<T>();\n+    const T* scale_data = scale.template data<T>();\n+    const T* bias_data = bias.template data<T>();\n+    T* Y_data = Y->template mutable_data<T>();\n+    alpha_.Resize(C);\n+    beta_.Resize(C);\n+    T* alpha_data = alpha_.template mutable_data<T>();\n+    T* beta_data = beta_.template mutable_data<T>();\n+    if (is_test_) {\n+      if (N == 0) {\n+        return true;\n+      }\n+      const auto& mean = Input(EST_MEAN);\n+      const auto& var = Input(EST_VAR);\n+      CAFFE_ENFORCE_EQ(mean.size(), C);\n+      CAFFE_ENFORCE_EQ(var.size(), C);\n+      ComputeFusedParam<T>(\n+          C,\n+          scale_data,\n+          bias_data,\n+          mean.template data<T>(),\n+          var.template data<T>(),\n+          alpha_data,\n+          beta_data);\n+    } else {\n+      auto* saved_mean = Output(SAVED_MEAN);\n+      auto* saved_rstd = Output(SAVED_INV_STD);\n+      saved_mean->Resize(C);\n+      saved_rstd->Resize(C);\n+      T* saved_mean_data = saved_mean->template mutable_data<T>();\n+      T* saved_rstd_data = saved_rstd->template mutable_data<T>();\n+      auto* running_mean = Output(RUNNING_MEAN);\n+      auto* running_var = Output(RUNNING_VAR);\n+      if (running_mean->size() != C) {\n+        running_mean->Resize(C);\n+        math::Set<T, Context>(\n+            C, T(0), running_mean->template mutable_data<T>(), &context_);\n+      }\n+      if (running_var->size() != C) {\n+        running_var->Resize(C);\n+        math::Set<T, Context>(\n+            C, T(0), running_var->template mutable_data<T>(), &context_);\n+      }\n+      T* running_mean_data = running_mean->template mutable_data<T>();\n+      T* running_var_data = running_var->template mutable_data<T>();\n+      if (N == 0) {\n+        math::Set<T, Context>(C, T(0), saved_mean_data, &context_);\n+        math::Set<T, Context>(C, T(0), saved_rstd_data, &context_);\n+        return true;\n+      }\n+      if (num_batches_ > 1) {", "path": "caffe2/operators/spatial_batch_norm_op.h", "position": 132, "original_position": 120, "commit_id": "2a46f10abbe471e5e67a16273600edb3baccf1d7", "original_commit_id": "1d6906f2c2122b83c7aaf2a15f69f8f1fea73ab0", "user": {"login": "houseroad", "id": 30275821, "node_id": "MDQ6VXNlcjMwMjc1ODIx", "avatar_url": "https://avatars0.githubusercontent.com/u/30275821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/houseroad", "html_url": "https://github.com/houseroad", "followers_url": "https://api.github.com/users/houseroad/followers", "following_url": "https://api.github.com/users/houseroad/following{/other_user}", "gists_url": "https://api.github.com/users/houseroad/gists{/gist_id}", "starred_url": "https://api.github.com/users/houseroad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/houseroad/subscriptions", "organizations_url": "https://api.github.com/users/houseroad/orgs", "repos_url": "https://api.github.com/users/houseroad/repos", "events_url": "https://api.github.com/users/houseroad/events{/privacy}", "received_events_url": "https://api.github.com/users/houseroad/received_events", "type": "User", "site_admin": false}, "body": "Add some comments about the computation equation here?", "created_at": "2018-08-29T05:42:01Z", "updated_at": "2018-11-23T15:50:14Z", "html_url": "https://github.com/pytorch/pytorch/pull/10888#discussion_r213550302", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/10888", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/213550302"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/10888#discussion_r213550302"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/10888"}}, "body_html": "<p>Add some comments about the computation equation here?</p>", "body_text": "Add some comments about the computation equation here?"}