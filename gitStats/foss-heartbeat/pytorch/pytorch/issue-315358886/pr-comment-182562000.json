{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/182562000", "pull_request_review_id": 113381082, "id": 182562000, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MjU2MjAwMA==", "diff_hunk": "@@ -467,102 +435,47 @@ void TensorRTTransformer::Transform(\n       SsaRewriteAndMapIO(ws, pred_net, input_shape_hints);\n   auto shape_hints = InferShapes(ws, pred_net, &shape_hints_ordered);\n \n-  std::unordered_set<std::string> weights;\n-  const std::vector<string>& ws_blobs = ws->Blobs();\n-  for (const auto& s : ws_blobs) {\n-    weights.emplace(s);\n-  }\n-\n   CAFFE_ENFORCE(pred_net, \"Predict net cannot be nullptr\");\n-  ::ONNX_NAMESPACE::ModelProto onnx_model;\n-  FillModelInfo(&onnx_model);\n-\n-  std::vector<OperatorDef> new_ops;\n-  bool trt_group = false;\n-  auto importer = tensorrt::TrtObject(onnx2trt::createImporter(nullptr));\n-  int op_idx = 0;\n-  int start = 0;\n-  int end = 0;\n   onnx::OnnxExporter exporter(nullptr, true);\n-  for (const OperatorDef& op : pred_net->op()) {\n-    bool support_trt = true;\n-    const OpSchema* schema = OpSchemaRegistry::Schema(op.type());\n-    caffe2::onnx::ConvertedResult results;\n-    if (!schema || schema->onnx_schema().empty()) {\n-      LOG(INFO) << \"Cannot export c2 op \" << op.type() << \" to onnx\";\n-      support_trt = false;\n-    } else {\n-      // One c2 op can be converted into multiple onnx nodes. For simplicity, we\n-      // enforce all or nothing here\n-      results = exporter.Caffe2OpToOnnxNodes(op, shape_hints);\n-      for (const auto& n : results.first) {\n-        if (!importer->supports(n)) {\n-          LOG(INFO) << \"TRT does not support ONNX node \" << n.op_type();\n-          support_trt = false;\n-          break;\n-        }\n-      }\n-    }\n+  auto importer = tensorrt::TrtObject(onnx2trt::createImporter(nullptr));\n \n-    if (support_trt) {\n-      const auto& node_protos = results.first;\n-      if (!trt_group) {\n-        trt_group = true;\n-        start = op_idx;\n-      }\n-      for (const auto& n : node_protos) {\n-        onnx_model.mutable_graph()->add_node()->CopyFrom(n);\n-      }\n+  // function to tell whether TensorRT supports a given C2 op or not\n+  auto supports =\n+      [&exporter, &shape_hints, importer](const caffe2::OperatorDef& op) {", "path": "caffe2/contrib/tensorrt/tensorrt_tranformer.cc", "position": null, "original_position": 347, "commit_id": "f5557d66938f4b650f59ef0df73276bbb4401fb1", "original_commit_id": "1befdbf81796cfb902b8be63d2a848ba4bed5e65", "user": {"login": "bwasti", "id": 4842908, "node_id": "MDQ6VXNlcjQ4NDI5MDg=", "avatar_url": "https://avatars2.githubusercontent.com/u/4842908?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bwasti", "html_url": "https://github.com/bwasti", "followers_url": "https://api.github.com/users/bwasti/followers", "following_url": "https://api.github.com/users/bwasti/following{/other_user}", "gists_url": "https://api.github.com/users/bwasti/gists{/gist_id}", "starred_url": "https://api.github.com/users/bwasti/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bwasti/subscriptions", "organizations_url": "https://api.github.com/users/bwasti/orgs", "repos_url": "https://api.github.com/users/bwasti/repos", "events_url": "https://api.github.com/users/bwasti/events{/privacy}", "received_events_url": "https://api.github.com/users/bwasti/received_events", "type": "User", "site_admin": false}, "body": "why is `importer` captured by copy?", "created_at": "2018-04-18T20:39:21Z", "updated_at": "2018-11-23T15:42:47Z", "html_url": "https://github.com/pytorch/pytorch/pull/6696#discussion_r182562000", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/6696", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/182562000"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/6696#discussion_r182562000"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/6696"}}, "body_html": "<p>why is <code>importer</code> captured by copy?</p>", "body_text": "why is importer captured by copy?"}