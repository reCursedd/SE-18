{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/1493", "id": 119272129, "node_id": "MDExOlB1bGxSZXF1ZXN0MTE5MjcyMTI5", "html_url": "https://github.com/pytorch/pytorch/pull/1493", "diff_url": "https://github.com/pytorch/pytorch/pull/1493.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/1493.patch", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/1493", "number": 1493, "state": "closed", "locked": false, "title": "Avoid segfault when calling join_with with self as arg", "user": {"login": "lantiga", "id": 191033, "node_id": "MDQ6VXNlcjE5MTAzMw==", "avatar_url": "https://avatars2.githubusercontent.com/u/191033?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lantiga", "html_url": "https://github.com/lantiga", "followers_url": "https://api.github.com/users/lantiga/followers", "following_url": "https://api.github.com/users/lantiga/following{/other_user}", "gists_url": "https://api.github.com/users/lantiga/gists{/gist_id}", "starred_url": "https://api.github.com/users/lantiga/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lantiga/subscriptions", "organizations_url": "https://api.github.com/users/lantiga/orgs", "repos_url": "https://api.github.com/users/lantiga/repos", "events_url": "https://api.github.com/users/lantiga/events{/privacy}", "received_events_url": "https://api.github.com/users/lantiga/received_events", "type": "User", "site_admin": false}, "body": "This PR solves #1480 and potentially similar corner cases.\r\n\r\nWith reference to #1480, when permute is called, the input and the result are marked as sharing storage (https://github.com/pytorch/pytorch/blob/master/torch/autograd/_functions/tensor.py#L161).\r\nWhen identity indices (e.g. `(0,1,2)`) are provided, `input` and `result` are the same object, i.e. marking causes the segfault.\r\n\r\nMarking leads to this call:\r\nhttps://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/python_function.cpp#L479\r\n```\r\nv2->cdata->version_counter->join_with(*v1->cdata->version_counter);\r\n```\r\nwith `v1` and `v2` now being the same object.\r\n\r\nWhich in turn leads to https://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/variable_version.h#L20-L25\r\n```\r\n  void join_with(VariableVersion &other) {\r\n    cleanup(); // <------- version_block deallocated and set to null here \r\n    version_block = other.version_block; <------- other is the same object, so other.version_block is null now\r\n    version_block[1]++; // <------- segfault!\r\n    version_block[2]++;\r\n  }\r\n```\r\n\r\nWith this PR, `join_with` simply returns (no need to increase versions, @apaszke @soumith please check that my assumption is correct) when `this == &other`.", "created_at": "2017-05-05T22:53:30Z", "updated_at": "2017-05-09T20:31:11Z", "closed_at": "2017-05-06T22:35:11Z", "merged_at": "2017-05-06T22:35:11Z", "merge_commit_sha": "90e9f8a476cebce2af5e615385edd62794609e2f", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "commits_url": "https://api.github.com/repos/pytorch/pytorch/pulls/1493/commits", "review_comments_url": "https://api.github.com/repos/pytorch/pytorch/pulls/1493/comments", "review_comment_url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/1493/comments", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/225fc5c576586db6589655468c64412abe3850de", "head": {"label": "lantiga:join_with_fix", "ref": "join_with_fix", "sha": "225fc5c576586db6589655468c64412abe3850de", "user": {"login": "lantiga", "id": 191033, "node_id": "MDQ6VXNlcjE5MTAzMw==", "avatar_url": "https://avatars2.githubusercontent.com/u/191033?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lantiga", "html_url": "https://github.com/lantiga", "followers_url": "https://api.github.com/users/lantiga/followers", "following_url": "https://api.github.com/users/lantiga/following{/other_user}", "gists_url": "https://api.github.com/users/lantiga/gists{/gist_id}", "starred_url": "https://api.github.com/users/lantiga/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lantiga/subscriptions", "organizations_url": "https://api.github.com/users/lantiga/orgs", "repos_url": "https://api.github.com/users/lantiga/repos", "events_url": "https://api.github.com/users/lantiga/events{/privacy}", "received_events_url": "https://api.github.com/users/lantiga/received_events", "type": "User", "site_admin": false}, "repo": {"id": 87643601, "node_id": "MDEwOlJlcG9zaXRvcnk4NzY0MzYwMQ==", "name": "pytorch", "full_name": "lantiga/pytorch", "private": false, "owner": {"login": "lantiga", "id": 191033, "node_id": "MDQ6VXNlcjE5MTAzMw==", "avatar_url": "https://avatars2.githubusercontent.com/u/191033?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lantiga", "html_url": "https://github.com/lantiga", "followers_url": "https://api.github.com/users/lantiga/followers", "following_url": "https://api.github.com/users/lantiga/following{/other_user}", "gists_url": "https://api.github.com/users/lantiga/gists{/gist_id}", "starred_url": "https://api.github.com/users/lantiga/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lantiga/subscriptions", "organizations_url": "https://api.github.com/users/lantiga/orgs", "repos_url": "https://api.github.com/users/lantiga/repos", "events_url": "https://api.github.com/users/lantiga/events{/privacy}", "received_events_url": "https://api.github.com/users/lantiga/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/lantiga/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": true, "url": "https://api.github.com/repos/lantiga/pytorch", "forks_url": "https://api.github.com/repos/lantiga/pytorch/forks", "keys_url": "https://api.github.com/repos/lantiga/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/lantiga/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/lantiga/pytorch/teams", "hooks_url": "https://api.github.com/repos/lantiga/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/lantiga/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/lantiga/pytorch/events", "assignees_url": "https://api.github.com/repos/lantiga/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/lantiga/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/lantiga/pytorch/tags", "blobs_url": "https://api.github.com/repos/lantiga/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/lantiga/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/lantiga/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/lantiga/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/lantiga/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/lantiga/pytorch/languages", "stargazers_url": "https://api.github.com/repos/lantiga/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/lantiga/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/lantiga/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/lantiga/pytorch/subscription", "commits_url": "https://api.github.com/repos/lantiga/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/lantiga/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/lantiga/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/lantiga/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/lantiga/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/lantiga/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/lantiga/pytorch/merges", "archive_url": "https://api.github.com/repos/lantiga/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/lantiga/pytorch/downloads", "issues_url": "https://api.github.com/repos/lantiga/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/lantiga/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/lantiga/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/lantiga/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/lantiga/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/lantiga/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/lantiga/pytorch/deployments", "created_at": "2017-04-08T15:26:35Z", "updated_at": "2017-04-08T15:26:40Z", "pushed_at": "2018-09-27T14:17:29Z", "git_url": "git://github.com/lantiga/pytorch.git", "ssh_url": "git@github.com:lantiga/pytorch.git", "clone_url": "https://github.com/lantiga/pytorch.git", "svn_url": "https://github.com/lantiga/pytorch", "homepage": "http://pytorch.org", "size": 75447, "stargazers_count": 0, "watchers_count": 0, "language": "Python", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 0, "mirror_url": null, "archived": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "pytorch:master", "ref": "master", "sha": "ff0ff33a1128b29ce909e71116e1d5ab1c79b752", "user": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 65600975, "node_id": "MDEwOlJlcG9zaXRvcnk2NTYwMDk3NQ==", "name": "pytorch", "full_name": "pytorch/pytorch", "private": false, "owner": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/pytorch/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": false, "url": "https://api.github.com/repos/pytorch/pytorch", "forks_url": "https://api.github.com/repos/pytorch/pytorch/forks", "keys_url": "https://api.github.com/repos/pytorch/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/pytorch/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/pytorch/pytorch/teams", "hooks_url": "https://api.github.com/repos/pytorch/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/pytorch/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/pytorch/pytorch/events", "assignees_url": "https://api.github.com/repos/pytorch/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/pytorch/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/pytorch/pytorch/tags", "blobs_url": "https://api.github.com/repos/pytorch/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/pytorch/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/pytorch/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/pytorch/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/pytorch/pytorch/languages", "stargazers_url": "https://api.github.com/repos/pytorch/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/pytorch/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/pytorch/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/pytorch/pytorch/subscription", "commits_url": "https://api.github.com/repos/pytorch/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/pytorch/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/pytorch/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/pytorch/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/pytorch/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/pytorch/pytorch/merges", "archive_url": "https://api.github.com/repos/pytorch/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/pytorch/pytorch/downloads", "issues_url": "https://api.github.com/repos/pytorch/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/pytorch/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/pytorch/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/pytorch/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/pytorch/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/pytorch/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/pytorch/pytorch/deployments", "created_at": "2016-08-13T05:26:41Z", "updated_at": "2018-11-24T12:35:43Z", "pushed_at": "2018-11-24T12:42:01Z", "git_url": "git://github.com/pytorch/pytorch.git", "ssh_url": "git@github.com:pytorch/pytorch.git", "clone_url": "https://github.com/pytorch/pytorch.git", "svn_url": "https://github.com/pytorch/pytorch", "homepage": "http://pytorch.org", "size": 89656, "stargazers_count": 21589, "watchers_count": 21589, "language": "C++", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 5153, "mirror_url": null, "archived": false, "open_issues_count": 2197, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 5153, "open_issues": 2197, "watchers": 21589, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/1493"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/1493"}, "issue": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/1493"}, "comments": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/1493/comments"}, "review_comments": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/1493/comments"}, "review_comment": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/1493/commits"}, "statuses": {"href": "https://api.github.com/repos/pytorch/pytorch/statuses/225fc5c576586db6589655468c64412abe3850de"}}, "author_association": "COLLABORATOR", "body_html": "<p>This PR solves <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"226480266\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/1480\" data-hovercard-type=\"issue\" data-hovercard-url=\"/pytorch/pytorch/issues/1480/hovercard\" href=\"https://github.com/pytorch/pytorch/issues/1480\">#1480</a> and potentially similar corner cases.</p>\n<p>With reference to <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"226480266\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/1480\" data-hovercard-type=\"issue\" data-hovercard-url=\"/pytorch/pytorch/issues/1480/hovercard\" href=\"https://github.com/pytorch/pytorch/issues/1480\">#1480</a>, when permute is called, the input and the result are marked as sharing storage (<a href=\"https://github.com/pytorch/pytorch/blob/master/torch/autograd/_functions/tensor.py#L161\">https://github.com/pytorch/pytorch/blob/master/torch/autograd/_functions/tensor.py#L161</a>).<br>\nWhen identity indices (e.g. <code>(0,1,2)</code>) are provided, <code>input</code> and <code>result</code> are the same object, i.e. marking causes the segfault.</p>\n<p>Marking leads to this call:<br>\n<a href=\"https://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/python_function.cpp#L479\">https://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/python_function.cpp#L479</a></p>\n<pre><code>v2-&gt;cdata-&gt;version_counter-&gt;join_with(*v1-&gt;cdata-&gt;version_counter);\n</code></pre>\n<p>with <code>v1</code> and <code>v2</code> now being the same object.</p>\n<p>Which in turn leads to <a href=\"https://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/variable_version.h#L20-L25\">https://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/variable_version.h#L20-L25</a></p>\n<pre><code>  void join_with(VariableVersion &amp;other) {\n    cleanup(); // &lt;------- version_block deallocated and set to null here \n    version_block = other.version_block; &lt;------- other is the same object, so other.version_block is null now\n    version_block[1]++; // &lt;------- segfault!\n    version_block[2]++;\n  }\n</code></pre>\n<p>With this PR, <code>join_with</code> simply returns (no need to increase versions, <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=4583066\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/apaszke\">@apaszke</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1310570\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/soumith\">@soumith</a> please check that my assumption is correct) when <code>this == &amp;other</code>.</p>", "body_text": "This PR solves #1480 and potentially similar corner cases.\nWith reference to #1480, when permute is called, the input and the result are marked as sharing storage (https://github.com/pytorch/pytorch/blob/master/torch/autograd/_functions/tensor.py#L161).\nWhen identity indices (e.g. (0,1,2)) are provided, input and result are the same object, i.e. marking causes the segfault.\nMarking leads to this call:\nhttps://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/python_function.cpp#L479\nv2->cdata->version_counter->join_with(*v1->cdata->version_counter);\n\nwith v1 and v2 now being the same object.\nWhich in turn leads to https://github.com/pytorch/pytorch/blob/master/torch/csrc/autograd/variable_version.h#L20-L25\n  void join_with(VariableVersion &other) {\n    cleanup(); // <------- version_block deallocated and set to null here \n    version_block = other.version_block; <------- other is the same object, so other.version_block is null now\n    version_block[1]++; // <------- segfault!\n    version_block[2]++;\n  }\n\nWith this PR, join_with simply returns (no need to increase versions, @apaszke @soumith please check that my assumption is correct) when this == &other.", "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "apaszke", "id": 4583066, "node_id": "MDQ6VXNlcjQ1ODMwNjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/4583066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apaszke", "html_url": "https://github.com/apaszke", "followers_url": "https://api.github.com/users/apaszke/followers", "following_url": "https://api.github.com/users/apaszke/following{/other_user}", "gists_url": "https://api.github.com/users/apaszke/gists{/gist_id}", "starred_url": "https://api.github.com/users/apaszke/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apaszke/subscriptions", "organizations_url": "https://api.github.com/users/apaszke/orgs", "repos_url": "https://api.github.com/users/apaszke/repos", "events_url": "https://api.github.com/users/apaszke/events{/privacy}", "received_events_url": "https://api.github.com/users/apaszke/received_events", "type": "User", "site_admin": false}, "comments": 6, "review_comments": 0, "maintainer_can_modify": false, "commits": 2, "additions": 7, "deletions": 3, "changed_files": 1}