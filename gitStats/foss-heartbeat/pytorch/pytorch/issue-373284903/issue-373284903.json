{"url": "https://api.github.com/repos/pytorch/pytorch/issues/13034", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/13034/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/13034/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/13034/events", "html_url": "https://github.com/pytorch/pytorch/issues/13034", "id": 373284903, "node_id": "MDU6SXNzdWUzNzMyODQ5MDM=", "number": 13034, "title": "[caffe2]How can I export init_net.pb and predict_net.pb files on my own?", "user": {"login": "arenchdlaam", "id": 29936982, "node_id": "MDQ6VXNlcjI5OTM2OTgy", "avatar_url": "https://avatars0.githubusercontent.com/u/29936982?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arenchdlaam", "html_url": "https://github.com/arenchdlaam", "followers_url": "https://api.github.com/users/arenchdlaam/followers", "following_url": "https://api.github.com/users/arenchdlaam/following{/other_user}", "gists_url": "https://api.github.com/users/arenchdlaam/gists{/gist_id}", "starred_url": "https://api.github.com/users/arenchdlaam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arenchdlaam/subscriptions", "organizations_url": "https://api.github.com/users/arenchdlaam/orgs", "repos_url": "https://api.github.com/users/arenchdlaam/repos", "events_url": "https://api.github.com/users/arenchdlaam/events{/privacy}", "received_events_url": "https://api.github.com/users/arenchdlaam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-10-24T03:03:13Z", "updated_at": "2018-10-24T03:04:09Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>I want to convert the retinanet in Caffe2/Detectron to an onnx model, but I need to prepare init_net.pb and predict_net.pb files first. Followed by the script bellow I got these two files, but when I tried to run the convert procedure an error occured and I don't know how to handle this. Can anybody help me with this problem?<br>\n####################<br>\nscript to generate .pb files:</p>\n<p>def SaveNet(INIT_NET, PREDICT_NET, workspace, model):<br>\ninit_net, predict_net = mobile_exporter.Export(<br>\nworkspace, model.net, model.params<br>\n)<br>\nwith open(PREDICT_NET, 'wb') as f:<br>\nf.write(model.net._net.SerializeToString())<br>\nwith open(INIT_NET, 'wb') as f:<br>\nf.write(init_net.SerializeToString())<br>\nprint(\"== saved init_net and predict_net. ==\")</p>\n<p>#############################<br>\nscript to convert files to onnx:<br>\nimport os<br>\nos.environ['CUDA_VISIBLE_DEVICES']='0'<br>\nimport onnx<br>\nimport caffe2.python.onnx.frontend<br>\nfrom caffe2.proto import caffe2_pb2<br>\ndata_type = onnx.TensorProto.FLOAT<br>\ndata_shape = (1, 3, 480, 640)<br>\nvalue_info = {<br>\n'gpu_0/data': (data_type, data_shape)<br>\n}<br>\npredict_net = caffe2_pb2.NetDef()<br>\nwith open('predict_net.pb', 'rb') as f:<br>\npredict_net.ParseFromString(f.read())<br>\ninit_net = caffe2_pb2.NetDef()<br>\nwith open('init_net.pb', 'rb') as f:<br>\ninit_net.ParseFromString(f.read())<br>\nonnx_model = caffe2.python.onnx.frontend.caffe2_net_to_onnx_model(<br>\npredict_net,<br>\ninit_net,<br>\nvalue_info,<br>\n)<br>\nonnx.checker.check_model(onnx_model)</p>\n<p>##############################<br>\nERROR:<br>\n[E net_async_base.cc:422] [enforce fail at context_gpu.cu:343] error == cudaSuccess. 77 vs 0. Error at: /home/bjtu/Downloads/pytorch/caffe2/core/context_gpu.cu:343: an illegal memory access was encounteredError from operator:<br>\ninput: \"gpu_0/conv1_3\" output: \"gpu_0/pool1_1\" name: \"\" type: \"MaxPool\" arg { name: \"kernel\" i: 3 } arg { name: \"order\" s: \"NCHW\" } arg { name: \"pad\" i: 1 } arg { name: \"cudnn_exhaustive_search\" i: 0 } arg { name: \"stride\" i: 2 } device_option { device_type: 1 device_id: 0 } engine: \"CUDNN\", op MaxPool<br>\n[F context_gpu.h:118] Check failed: error == cudaSuccess an illegal memory access was encountered</p>\n<p>System information<br>\nOperating system: ubuntu16.04<br>\nCompiler version: gcc 5.4.0<br>\nCUDA version: 8.0<br>\ncuDNN version: 7.1.4<br>\nNVIDIA driver version: 384.130<br>\nGPU models (for all devices if they are not all the same): quadro m5000<br>\nPYTHONPATH environment variable: ?<br>\npython --version output: 2.7<br>\nAnything else that seems relevant: ?</p>", "body_text": "I want to convert the retinanet in Caffe2/Detectron to an onnx model, but I need to prepare init_net.pb and predict_net.pb files first. Followed by the script bellow I got these two files, but when I tried to run the convert procedure an error occured and I don't know how to handle this. Can anybody help me with this problem?\n####################\nscript to generate .pb files:\ndef SaveNet(INIT_NET, PREDICT_NET, workspace, model):\ninit_net, predict_net = mobile_exporter.Export(\nworkspace, model.net, model.params\n)\nwith open(PREDICT_NET, 'wb') as f:\nf.write(model.net._net.SerializeToString())\nwith open(INIT_NET, 'wb') as f:\nf.write(init_net.SerializeToString())\nprint(\"== saved init_net and predict_net. ==\")\n#############################\nscript to convert files to onnx:\nimport os\nos.environ['CUDA_VISIBLE_DEVICES']='0'\nimport onnx\nimport caffe2.python.onnx.frontend\nfrom caffe2.proto import caffe2_pb2\ndata_type = onnx.TensorProto.FLOAT\ndata_shape = (1, 3, 480, 640)\nvalue_info = {\n'gpu_0/data': (data_type, data_shape)\n}\npredict_net = caffe2_pb2.NetDef()\nwith open('predict_net.pb', 'rb') as f:\npredict_net.ParseFromString(f.read())\ninit_net = caffe2_pb2.NetDef()\nwith open('init_net.pb', 'rb') as f:\ninit_net.ParseFromString(f.read())\nonnx_model = caffe2.python.onnx.frontend.caffe2_net_to_onnx_model(\npredict_net,\ninit_net,\nvalue_info,\n)\nonnx.checker.check_model(onnx_model)\n##############################\nERROR:\n[E net_async_base.cc:422] [enforce fail at context_gpu.cu:343] error == cudaSuccess. 77 vs 0. Error at: /home/bjtu/Downloads/pytorch/caffe2/core/context_gpu.cu:343: an illegal memory access was encounteredError from operator:\ninput: \"gpu_0/conv1_3\" output: \"gpu_0/pool1_1\" name: \"\" type: \"MaxPool\" arg { name: \"kernel\" i: 3 } arg { name: \"order\" s: \"NCHW\" } arg { name: \"pad\" i: 1 } arg { name: \"cudnn_exhaustive_search\" i: 0 } arg { name: \"stride\" i: 2 } device_option { device_type: 1 device_id: 0 } engine: \"CUDNN\", op MaxPool\n[F context_gpu.h:118] Check failed: error == cudaSuccess an illegal memory access was encountered\nSystem information\nOperating system: ubuntu16.04\nCompiler version: gcc 5.4.0\nCUDA version: 8.0\ncuDNN version: 7.1.4\nNVIDIA driver version: 384.130\nGPU models (for all devices if they are not all the same): quadro m5000\nPYTHONPATH environment variable: ?\npython --version output: 2.7\nAnything else that seems relevant: ?", "body": "I want to convert the retinanet in Caffe2/Detectron to an onnx model, but I need to prepare init_net.pb and predict_net.pb files first. Followed by the script bellow I got these two files, but when I tried to run the convert procedure an error occured and I don't know how to handle this. Can anybody help me with this problem?\r\n####################\r\nscript to generate .pb files:\r\n\r\ndef SaveNet(INIT_NET, PREDICT_NET, workspace, model):\r\n      init_net, predict_net = mobile_exporter.Export(\r\n         workspace, model.net, model.params\r\n      )\r\n      with open(PREDICT_NET, 'wb') as f:\r\n              f.write(model.net._net.SerializeToString())\r\n      with open(INIT_NET, 'wb') as f:\r\n              f.write(init_net.SerializeToString())\r\n      print(\"== saved init_net and predict_net. ==\")\r\n\r\n#############################\r\nscript to convert files to onnx:\r\nimport os\r\nos.environ['CUDA_VISIBLE_DEVICES']='0'\r\nimport onnx\r\nimport caffe2.python.onnx.frontend\r\nfrom caffe2.proto import caffe2_pb2\r\ndata_type = onnx.TensorProto.FLOAT\r\ndata_shape = (1, 3, 480, 640)\r\nvalue_info = {\r\n          'gpu_0/data': (data_type, data_shape)\r\n       }\r\npredict_net = caffe2_pb2.NetDef()\r\nwith open('predict_net.pb', 'rb') as f:\r\n         predict_net.ParseFromString(f.read())\r\ninit_net = caffe2_pb2.NetDef()\r\nwith open('init_net.pb', 'rb') as f:\r\n         init_net.ParseFromString(f.read())\r\nonnx_model = caffe2.python.onnx.frontend.caffe2_net_to_onnx_model(\r\n                         predict_net,\r\n                         init_net,\r\n                         value_info,\r\n                        )\r\nonnx.checker.check_model(onnx_model)\r\n\r\n##############################\r\nERROR:\r\n[E net_async_base.cc:422] [enforce fail at context_gpu.cu:343] error == cudaSuccess. 77 vs 0. Error at: /home/bjtu/Downloads/pytorch/caffe2/core/context_gpu.cu:343: an illegal memory access was encounteredError from operator:\r\ninput: \"gpu_0/conv1_3\" output: \"gpu_0/pool1_1\" name: \"\" type: \"MaxPool\" arg { name: \"kernel\" i: 3 } arg { name: \"order\" s: \"NCHW\" } arg { name: \"pad\" i: 1 } arg { name: \"cudnn_exhaustive_search\" i: 0 } arg { name: \"stride\" i: 2 } device_option { device_type: 1 device_id: 0 } engine: \"CUDNN\", op MaxPool\r\n[F context_gpu.h:118] Check failed: error == cudaSuccess an illegal memory access was encountered\r\n\r\nSystem information\r\nOperating system: ubuntu16.04\r\nCompiler version: gcc 5.4.0\r\nCUDA version: 8.0\r\ncuDNN version: 7.1.4\r\nNVIDIA driver version: 384.130\r\nGPU models (for all devices if they are not all the same): quadro m5000\r\nPYTHONPATH environment variable: ?\r\npython --version output: 2.7\r\nAnything else that seems relevant: ?"}