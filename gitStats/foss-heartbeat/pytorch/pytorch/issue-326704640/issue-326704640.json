{"url": "https://api.github.com/repos/pytorch/pytorch/issues/7868", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/7868/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/7868/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/7868/events", "html_url": "https://github.com/pytorch/pytorch/issues/7868", "id": 326704640, "node_id": "MDU6SXNzdWUzMjY3MDQ2NDA=", "number": 7868, "title": "[PyTorch] [ONNX] Peephole optimizer transpose fusion broken", "user": {"login": "jekbradbury", "id": 11729078, "node_id": "MDQ6VXNlcjExNzI5MDc4", "avatar_url": "https://avatars2.githubusercontent.com/u/11729078?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jekbradbury", "html_url": "https://github.com/jekbradbury", "followers_url": "https://api.github.com/users/jekbradbury/followers", "following_url": "https://api.github.com/users/jekbradbury/following{/other_user}", "gists_url": "https://api.github.com/users/jekbradbury/gists{/gist_id}", "starred_url": "https://api.github.com/users/jekbradbury/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jekbradbury/subscriptions", "organizations_url": "https://api.github.com/users/jekbradbury/orgs", "repos_url": "https://api.github.com/users/jekbradbury/repos", "events_url": "https://api.github.com/users/jekbradbury/events{/privacy}", "received_events_url": "https://api.github.com/users/jekbradbury/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-05-26T03:01:40Z", "updated_at": "2018-05-26T15:13:49Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<p>With</p>\n<pre><code>class Test(torch.nn.Module):\n    def forward(self, x):\n        return x.transpose(1, 2).transpose(0, 1)\n</code></pre>\n<p>we have</p>\n<pre><code>&gt;&gt;&gt; torch.onnx.export(Test(), torch.rand(2, 3, 5), 'test.onnx', verbose=True)\ngraph(%0 : Float(2, 3, 5)) {\n  %1 : Float(5!, 2, 3!) = onnx::Transpose[perm=[1, 2, 0]](%0), scope: Test\n  return (%1);\n}\n</code></pre>\n<p>when we expect <code>Transpose[perm=[2, 0, 1]](%0)</code> or an equivalent.<br>\nSo one of the transformations in <a href=\"https://github.com/pytorch/pytorch/blob/master/torch/csrc/jit/passes/onnx/peephole.cpp\">https://github.com/pytorch/pytorch/blob/master/torch/csrc/jit/passes/onnx/peephole.cpp</a> is wrong.</p>\n<p>cc <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=2212584\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ryanleary\">@ryanleary</a></p>", "body_text": "With\nclass Test(torch.nn.Module):\n    def forward(self, x):\n        return x.transpose(1, 2).transpose(0, 1)\n\nwe have\n>>> torch.onnx.export(Test(), torch.rand(2, 3, 5), 'test.onnx', verbose=True)\ngraph(%0 : Float(2, 3, 5)) {\n  %1 : Float(5!, 2, 3!) = onnx::Transpose[perm=[1, 2, 0]](%0), scope: Test\n  return (%1);\n}\n\nwhen we expect Transpose[perm=[2, 0, 1]](%0) or an equivalent.\nSo one of the transformations in https://github.com/pytorch/pytorch/blob/master/torch/csrc/jit/passes/onnx/peephole.cpp is wrong.\ncc @ryanleary", "body": "With\r\n```\r\nclass Test(torch.nn.Module):\r\n    def forward(self, x):\r\n        return x.transpose(1, 2).transpose(0, 1)\r\n```\r\nwe have\r\n```\r\n>>> torch.onnx.export(Test(), torch.rand(2, 3, 5), 'test.onnx', verbose=True)\r\ngraph(%0 : Float(2, 3, 5)) {\r\n  %1 : Float(5!, 2, 3!) = onnx::Transpose[perm=[1, 2, 0]](%0), scope: Test\r\n  return (%1);\r\n}\r\n```\r\nwhen we expect `Transpose[perm=[2, 0, 1]](%0)` or an equivalent.\r\nSo one of the transformations in https://github.com/pytorch/pytorch/blob/master/torch/csrc/jit/passes/onnx/peephole.cpp is wrong.\r\n\r\ncc @ryanleary"}