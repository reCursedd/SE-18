{"url": "https://api.github.com/repos/pytorch/pytorch/issues/10875", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/10875/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/10875/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/10875/events", "html_url": "https://github.com/pytorch/pytorch/issues/10875", "id": 353997238, "node_id": "MDU6SXNzdWUzNTM5OTcyMzg=", "number": 10875, "title": "how can i run two model in a simple project?", "user": {"login": "JaosonMa", "id": 23551774, "node_id": "MDQ6VXNlcjIzNTUxNzc0", "avatar_url": "https://avatars1.githubusercontent.com/u/23551774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JaosonMa", "html_url": "https://github.com/JaosonMa", "followers_url": "https://api.github.com/users/JaosonMa/followers", "following_url": "https://api.github.com/users/JaosonMa/following{/other_user}", "gists_url": "https://api.github.com/users/JaosonMa/gists{/gist_id}", "starred_url": "https://api.github.com/users/JaosonMa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JaosonMa/subscriptions", "organizations_url": "https://api.github.com/users/JaosonMa/orgs", "repos_url": "https://api.github.com/users/JaosonMa/repos", "events_url": "https://api.github.com/users/JaosonMa/events{/privacy}", "received_events_url": "https://api.github.com/users/JaosonMa/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-08-25T09:06:04Z", "updated_at": "2018-09-18T12:59:21Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>I have two models trained with caffe2 - detectron , i  have convert the detectron model( pkl) to caffe2 models(pbtxt), and i have test the models succsssfully.<br>\nbut i need run the two models one by one in a same project , so i can get the infor of the image,<br>\nbut here is the problem<br>\nhow can i Realization the function ?<br>\nwhat i want realization most like this,<br>\nclass get_info:<br>\ndef <em>init</em>():<br>\ninit the network<br>\ndef classify_img():<br>\nget_img_info()<br>\nmain():<br>\nmodel_a = get_info()<br>\nmodel_b = get_info()<br>\nfor( listdir()):<br>\nmodel_a.classify_img()<br>\nmodel_b.classify_img()<br>\nbut now i can't realization this , here is my code</p>\n<p>class caffe2DetectronClassify:<br>\ndef _create_input_blobs_for_net(self,net_def):<br>\nfor op in net_def.op:<br>\nfor blob_in in op.input:<br>\nif not workspace.HasBlob(blob_in):<br>\nworkspace.CreateBlob(blob_in)<br>\ndef <strong>init</strong>(self, path_model_init, path_model_weights, scale, max_size, mean_file,root_dir):<br>\ndetectron_ops_lib = _get_detectron_ops_lib()<br>\ndyndep.InitOpsLibrary(detectron_ops_lib)</p>\n<pre><code>    self.init_net = caffe2_pb2.NetDef()\n    with open(path_model_init, 'rb') as f:\n        self.init_net.ParseFromString(f.read())\n    self.net = caffe2_pb2.NetDef()\n    with open(path_model_weights, 'rb') as f:\n        self.net.ParseFromString(f.read())\n\n    self.scale = scale\n    self.max_size = max_size\n    self.mean_file = mean_file\n\n    **workspace.ResetWorkspace()**\n    workspace.RunNetOnce(self.init_net)\n    self._create_input_blobs_for_net(self.net)\n    workspace.CreateNet(self.net)\n    print(\"net create over ...\")\n\n\ndef img_classify(self,img_path):\n    if(not os.path.exists(img_path)):\n        return [],[],[]\n    im = cv2.imread(img_path)\n    if(im.any() == None):\n        print('None image')\n        return [],[],[]\n    input_blob = self._prepare_blobs(im,self.mean_file,self.scale,self.max_size)\n    gpu_blobs = ['data']\n    for k,v in input_blob.items():\n        workspace.FeedBlob(\n            core.ScopedName(k),\n            v,\n            self._get_device_option_cuda() if k in gpu_blobs else\n            self._get_device_option_cpu()\n        )\n    try:\n        workspace.RunNet(self.net.name)\n        scores = workspace.FetchBlob('score_nms')\n        classids = workspace.FetchBlob('class_nms')\n        boxes = workspace.FetchBlob('bbox_nms')\n    except Exception as e:\n        print('error with {}'.format(e))\n        R = 0\n        scores = np.zeros((R,), dtype=np.float32)\n        boxes = np.zeros((R, 4), dtype=np.float32)\n        classids = np.zeros((R,), dtype=np.float32)\n    return scores,classids,boxes\n</code></pre>\n<p>when i run ,got error</p>\n<h2>Found Detectron ops lib: /home/jansonm/caffe2/pytorch/build/lib/libcaffe2_detectron_ops_gpu.so<br>\nWARNING: Logging before InitGoogleLogging() is written to STDERR<br>\nW0825 16:40:33.968032 21053 init.h:99] Caffe2 GlobalInit should be run before any other API calls.<br>\nW0825 16:40:34.370723 21053 init.h:99] Caffe2 GlobalInit should be run before any other API calls.<br>\nnet create over ...<br>\nFound Detectron ops lib: /home/jansonm/caffe2/pytorch/build/lib/libcaffe2_detectron_ops_gpu.so<br>\nnet create over ...<br>\n++++++++++++++++++++++++++++++++++++++++++++++++<br>\n/home/jansonm/detectron/test_img/5498233_1012130_1530585802475_10606738.jpeg<br>\n[]<br>\npre imag time:1.59693694115</h2>\n<h2>No handlers could be found for logger \"caffe2.python.workspace\"<br>\nerror with [enforce fail at pybind_state.cc:1054] gWorkspace-&gt;GetNet(name). Can't find net detectron_detect_box<br>\n[]<br>\npre imag time:0.141842126846<br>\n++++++++++++++++++++++++++++++++++++++++++++++++<br>\nsh: pause: command not found<br>\n++++++++++++++++++++++++++++++++++++++++++++++++<br>\n/home/jansonm/detectron/test_img/5498235_1023198_1530580487026_19862435.jpeg<br>\n[]<br>\npre imag time:0.643126964569</h2>\n<p>error with [enforce fail at pybind_state.cc:1054] gWorkspace-&gt;GetNet(name). Can't find net detectron_detect_box<br>\n[]<br>\npre imag time:0.144562005997<br>\n++++++++++++++++++++++++++++++++++++++++++++++++<br>\nsh: pause: command not found</p>\n<p>you see , the second model can not work, can not found its model by name<br>\ni think it is because when init the model<br>\n<strong>workspace.ResetWorkspace()</strong><br>\nworkspace.RunNetOnce(self.init_net)<br>\nself._create_input_blobs_for_net(self.net)<br>\nworkspace.CreateNet(self.net)<br>\nwhen i init workspace.ResetWorkspace() , it recover the first model, how can i let then work at the same time in a sample project,??<br>\n<a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=2734\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/eklitzke\">@eklitzke</a><br>\n<a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=3768583\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/gchanan\">@gchanan</a></p>", "body_text": "I have two models trained with caffe2 - detectron , i  have convert the detectron model( pkl) to caffe2 models(pbtxt), and i have test the models succsssfully.\nbut i need run the two models one by one in a same project , so i can get the infor of the image,\nbut here is the problem\nhow can i Realization the function ?\nwhat i want realization most like this,\nclass get_info:\ndef init():\ninit the network\ndef classify_img():\nget_img_info()\nmain():\nmodel_a = get_info()\nmodel_b = get_info()\nfor( listdir()):\nmodel_a.classify_img()\nmodel_b.classify_img()\nbut now i can't realization this , here is my code\nclass caffe2DetectronClassify:\ndef _create_input_blobs_for_net(self,net_def):\nfor op in net_def.op:\nfor blob_in in op.input:\nif not workspace.HasBlob(blob_in):\nworkspace.CreateBlob(blob_in)\ndef init(self, path_model_init, path_model_weights, scale, max_size, mean_file,root_dir):\ndetectron_ops_lib = _get_detectron_ops_lib()\ndyndep.InitOpsLibrary(detectron_ops_lib)\n    self.init_net = caffe2_pb2.NetDef()\n    with open(path_model_init, 'rb') as f:\n        self.init_net.ParseFromString(f.read())\n    self.net = caffe2_pb2.NetDef()\n    with open(path_model_weights, 'rb') as f:\n        self.net.ParseFromString(f.read())\n\n    self.scale = scale\n    self.max_size = max_size\n    self.mean_file = mean_file\n\n    **workspace.ResetWorkspace()**\n    workspace.RunNetOnce(self.init_net)\n    self._create_input_blobs_for_net(self.net)\n    workspace.CreateNet(self.net)\n    print(\"net create over ...\")\n\n\ndef img_classify(self,img_path):\n    if(not os.path.exists(img_path)):\n        return [],[],[]\n    im = cv2.imread(img_path)\n    if(im.any() == None):\n        print('None image')\n        return [],[],[]\n    input_blob = self._prepare_blobs(im,self.mean_file,self.scale,self.max_size)\n    gpu_blobs = ['data']\n    for k,v in input_blob.items():\n        workspace.FeedBlob(\n            core.ScopedName(k),\n            v,\n            self._get_device_option_cuda() if k in gpu_blobs else\n            self._get_device_option_cpu()\n        )\n    try:\n        workspace.RunNet(self.net.name)\n        scores = workspace.FetchBlob('score_nms')\n        classids = workspace.FetchBlob('class_nms')\n        boxes = workspace.FetchBlob('bbox_nms')\n    except Exception as e:\n        print('error with {}'.format(e))\n        R = 0\n        scores = np.zeros((R,), dtype=np.float32)\n        boxes = np.zeros((R, 4), dtype=np.float32)\n        classids = np.zeros((R,), dtype=np.float32)\n    return scores,classids,boxes\n\nwhen i run ,got error\nFound Detectron ops lib: /home/jansonm/caffe2/pytorch/build/lib/libcaffe2_detectron_ops_gpu.so\nWARNING: Logging before InitGoogleLogging() is written to STDERR\nW0825 16:40:33.968032 21053 init.h:99] Caffe2 GlobalInit should be run before any other API calls.\nW0825 16:40:34.370723 21053 init.h:99] Caffe2 GlobalInit should be run before any other API calls.\nnet create over ...\nFound Detectron ops lib: /home/jansonm/caffe2/pytorch/build/lib/libcaffe2_detectron_ops_gpu.so\nnet create over ...\n++++++++++++++++++++++++++++++++++++++++++++++++\n/home/jansonm/detectron/test_img/5498233_1012130_1530585802475_10606738.jpeg\n[]\npre imag time:1.59693694115\nNo handlers could be found for logger \"caffe2.python.workspace\"\nerror with [enforce fail at pybind_state.cc:1054] gWorkspace->GetNet(name). Can't find net detectron_detect_box\n[]\npre imag time:0.141842126846\n++++++++++++++++++++++++++++++++++++++++++++++++\nsh: pause: command not found\n++++++++++++++++++++++++++++++++++++++++++++++++\n/home/jansonm/detectron/test_img/5498235_1023198_1530580487026_19862435.jpeg\n[]\npre imag time:0.643126964569\nerror with [enforce fail at pybind_state.cc:1054] gWorkspace->GetNet(name). Can't find net detectron_detect_box\n[]\npre imag time:0.144562005997\n++++++++++++++++++++++++++++++++++++++++++++++++\nsh: pause: command not found\nyou see , the second model can not work, can not found its model by name\ni think it is because when init the model\nworkspace.ResetWorkspace()\nworkspace.RunNetOnce(self.init_net)\nself._create_input_blobs_for_net(self.net)\nworkspace.CreateNet(self.net)\nwhen i init workspace.ResetWorkspace() , it recover the first model, how can i let then work at the same time in a sample project,??\n@eklitzke\n@gchanan", "body": "I have two models trained with caffe2 - detectron , i  have convert the detectron model( pkl) to caffe2 models(pbtxt), and i have test the models succsssfully.\r\nbut i need run the two models one by one in a same project , so i can get the infor of the image,\r\nbut here is the problem\r\nhow can i Realization the function ? \r\nwhat i want realization most like this,\r\nclass get_info:\r\n    def _init_():\r\n          init the network\r\n    def classify_img():\r\n          get_img_info()\r\nmain():\r\n  model_a = get_info()\r\n  model_b = get_info()\r\n  for( listdir()):\r\n      model_a.classify_img()\r\n      model_b.classify_img()\r\nbut now i can't realization this , here is my code \r\n\r\nclass caffe2DetectronClassify:\r\n    def _create_input_blobs_for_net(self,net_def):\r\n        for op in net_def.op:\r\n            for blob_in in op.input:\r\n                if not workspace.HasBlob(blob_in):\r\n                    workspace.CreateBlob(blob_in)\r\n    def __init__(self, path_model_init, path_model_weights, scale, max_size, mean_file,root_dir):\r\n        detectron_ops_lib = _get_detectron_ops_lib()\r\n        dyndep.InitOpsLibrary(detectron_ops_lib)\r\n\r\n        self.init_net = caffe2_pb2.NetDef()\r\n        with open(path_model_init, 'rb') as f:\r\n            self.init_net.ParseFromString(f.read())\r\n        self.net = caffe2_pb2.NetDef()\r\n        with open(path_model_weights, 'rb') as f:\r\n            self.net.ParseFromString(f.read())\r\n\r\n        self.scale = scale\r\n        self.max_size = max_size\r\n        self.mean_file = mean_file\r\n\r\n        **workspace.ResetWorkspace()**\r\n        workspace.RunNetOnce(self.init_net)\r\n        self._create_input_blobs_for_net(self.net)\r\n        workspace.CreateNet(self.net)\r\n        print(\"net create over ...\")\r\n\r\n\r\n    def img_classify(self,img_path):\r\n        if(not os.path.exists(img_path)):\r\n            return [],[],[]\r\n        im = cv2.imread(img_path)\r\n        if(im.any() == None):\r\n            print('None image')\r\n            return [],[],[]\r\n        input_blob = self._prepare_blobs(im,self.mean_file,self.scale,self.max_size)\r\n        gpu_blobs = ['data']\r\n        for k,v in input_blob.items():\r\n            workspace.FeedBlob(\r\n                core.ScopedName(k),\r\n                v,\r\n                self._get_device_option_cuda() if k in gpu_blobs else\r\n                self._get_device_option_cpu()\r\n            )\r\n        try:\r\n            workspace.RunNet(self.net.name)\r\n            scores = workspace.FetchBlob('score_nms')\r\n            classids = workspace.FetchBlob('class_nms')\r\n            boxes = workspace.FetchBlob('bbox_nms')\r\n        except Exception as e:\r\n            print('error with {}'.format(e))\r\n            R = 0\r\n            scores = np.zeros((R,), dtype=np.float32)\r\n            boxes = np.zeros((R, 4), dtype=np.float32)\r\n            classids = np.zeros((R,), dtype=np.float32)\r\n        return scores,classids,boxes\r\n\r\nwhen i run ,got error\r\n\r\nFound Detectron ops lib: /home/jansonm/caffe2/pytorch/build/lib/libcaffe2_detectron_ops_gpu.so\r\nWARNING: Logging before InitGoogleLogging() is written to STDERR\r\nW0825 16:40:33.968032 21053 init.h:99] Caffe2 GlobalInit should be run before any other API calls.\r\nW0825 16:40:34.370723 21053 init.h:99] Caffe2 GlobalInit should be run before any other API calls.\r\nnet create over ...\r\nFound Detectron ops lib: /home/jansonm/caffe2/pytorch/build/lib/libcaffe2_detectron_ops_gpu.so\r\nnet create over ...\r\n++++++++++++++++++++++++++++++++++++++++++++++++\r\n/home/jansonm/detectron/test_img/5498233_1012130_1530585802475_10606738.jpeg\r\n[]\r\npre imag time:1.59693694115\r\n-----------------------------------------------\r\nNo handlers could be found for logger \"caffe2.python.workspace\"\r\nerror with [enforce fail at pybind_state.cc:1054] gWorkspace->GetNet(name). Can't find net detectron_detect_box \r\n[]\r\npre imag time:0.141842126846\r\n++++++++++++++++++++++++++++++++++++++++++++++++\r\nsh: pause: command not found\r\n++++++++++++++++++++++++++++++++++++++++++++++++\r\n/home/jansonm/detectron/test_img/5498235_1023198_1530580487026_19862435.jpeg\r\n[]\r\npre imag time:0.643126964569\r\n-----------------------------------------------\r\nerror with [enforce fail at pybind_state.cc:1054] gWorkspace->GetNet(name). Can't find net detectron_detect_box \r\n[]\r\npre imag time:0.144562005997\r\n++++++++++++++++++++++++++++++++++++++++++++++++\r\nsh: pause: command not found\r\n\r\nyou see , the second model can not work, can not found its model by name\r\ni think it is because when init the model\r\n **workspace.ResetWorkspace()**\r\n        workspace.RunNetOnce(self.init_net)\r\n        self._create_input_blobs_for_net(self.net)\r\n        workspace.CreateNet(self.net)\r\nwhen i init workspace.ResetWorkspace() , it recover the first model, how can i let then work at the same time in a sample project,??\r\n@eklitzke \r\n@gchanan \r\n\r\n"}