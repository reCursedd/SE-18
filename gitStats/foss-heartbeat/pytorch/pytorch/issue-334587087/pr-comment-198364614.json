{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/198364614", "pull_request_review_id": 132282374, "id": 198364614, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5ODM2NDYxNA==", "diff_hunk": "@@ -0,0 +1,55 @@\n+#include \"caffe2/onnx/onnxifi_manager.h\"\n+\n+#include <mutex>\n+\n+#include \"caffe2/core/logging.h\"\n+\n+namespace caffe2 {\n+namespace onnx {\n+\n+onnxifi_library* OnnxifiManager::AddOnnxifiLibrary(\n+    const std::string& name) {\n+  auto it = onnxifi_interfaces_.find(name);\n+  if (it != onnxifi_interfaces_.end()) {\n+    LOG(INFO) << \"Onnx interface \" << name <<  \" already exists\";\n+    return &it->second;\n+  }\n+\n+  onnxifi_library lib;\n+  auto ret = onnxifi_load(\n+      ONNXIFI_LOADER_FLAG_VERSION_1_0, nullptr, nullptr, &lib);\n+  if (!ret) {\n+    CAFFE_THROW(\"Cannot load onnxifi lib \", name);\n+  }\n+  return &onnxifi_interfaces_.emplace(name, lib).first->second;\n+}\n+\n+void OnnxifiManager::RemoveOnnxifiLibrary(const std::string& name) {\n+  auto it = onnxifi_interfaces_.find(name);\n+  if (it == onnxifi_interfaces_.end()) {\n+    LOG(WARNING) << \"Onnxifi lib \" << name << \"has not been registered\";\n+  }\n+  onnxifi_unload(&it->second);\n+  onnxifi_interfaces_.erase(it);\n+}\n+\n+void OnnxifiManager::ClearAll() {\n+  for (auto& kv : onnxifi_interfaces_) {\n+    onnxifi_unload(&kv.second);\n+  }\n+  onnxifi_interfaces_.clear();\n+}\n+\n+OnnxifiManager* OnnxifiManager::get_onnxifi_manager() {\n+  static OnnxifiManager* core = nullptr;\n+  static std::mutex m;\n+  std::lock_guard<std::mutex> lock(m);", "path": "caffe2/onnx/onnxifi_manager.cc", "position": null, "original_position": 46, "commit_id": "d441bb622ebb16bcc309e6ffb07b51ed43f161ce", "original_commit_id": "c633cc25ea4e14b9b343092a1d2b464c41abaab8", "user": {"login": "yinghai", "id": 1100089, "node_id": "MDQ6VXNlcjExMDAwODk=", "avatar_url": "https://avatars1.githubusercontent.com/u/1100089?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yinghai", "html_url": "https://github.com/yinghai", "followers_url": "https://api.github.com/users/yinghai/followers", "following_url": "https://api.github.com/users/yinghai/following{/other_user}", "gists_url": "https://api.github.com/users/yinghai/gists{/gist_id}", "starred_url": "https://api.github.com/users/yinghai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yinghai/subscriptions", "organizations_url": "https://api.github.com/users/yinghai/orgs", "repos_url": "https://api.github.com/users/yinghai/repos", "events_url": "https://api.github.com/users/yinghai/events{/privacy}", "received_events_url": "https://api.github.com/users/yinghai/received_events", "type": "User", "site_admin": false}, "body": "Yes, but the whole `OnnxifiManager` will go away once Marat has updated his onnxifi wrapper to onnx repo. ", "created_at": "2018-06-27T04:35:37Z", "updated_at": "2018-11-23T15:46:26Z", "html_url": "https://github.com/pytorch/pytorch/pull/8749#discussion_r198364614", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/8749", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/198364614"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/8749#discussion_r198364614"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/8749"}}, "body_html": "<p>Yes, but the whole <code>OnnxifiManager</code> will go away once Marat has updated his onnxifi wrapper to onnx repo.</p>", "body_text": "Yes, but the whole OnnxifiManager will go away once Marat has updated his onnxifi wrapper to onnx repo.", "in_reply_to_id": 198362262}