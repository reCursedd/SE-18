{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/227013394", "pull_request_review_id": 166958325, "id": 227013394, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNzAxMzM5NA==", "diff_hunk": "@@ -0,0 +1,50 @@\n+#include \"ATen/ATen.h\"\n+#include \"THC.h\"  // for USE_MAGMA\n+\n+#ifdef USE_MAGMA\n+#include <magma.h>\n+#include <magma_types.h>\n+#endif\n+\n+namespace at {\n+namespace native {\n+\n+#ifdef USE_MAGMA\n+static magma_queue_t createMagmaQueue(const Tensor& tensor) {", "path": "aten/src/ATen/native/cuda/MiscUtils.h", "position": null, "original_position": 13, "commit_id": "8cc65045618a15a741a33ac31a59edbbc7279290", "original_commit_id": "f675f7030428da308b1b89ffb7045ceb1529668f", "user": {"login": "zou3519", "id": 5652049, "node_id": "MDQ6VXNlcjU2NTIwNDk=", "avatar_url": "https://avatars3.githubusercontent.com/u/5652049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zou3519", "html_url": "https://github.com/zou3519", "followers_url": "https://api.github.com/users/zou3519/followers", "following_url": "https://api.github.com/users/zou3519/following{/other_user}", "gists_url": "https://api.github.com/users/zou3519/gists{/gist_id}", "starred_url": "https://api.github.com/users/zou3519/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zou3519/subscriptions", "organizations_url": "https://api.github.com/users/zou3519/orgs", "repos_url": "https://api.github.com/users/zou3519/repos", "events_url": "https://api.github.com/users/zou3519/events{/privacy}", "received_events_url": "https://api.github.com/users/zou3519/received_events", "type": "User", "site_admin": false}, "body": "Sorry, I'm not following: the magma queue seems local to the function, so wouldn't getri and getrf use different queues regardless of if magma queue creation is RAII or not?\r\n\r\nTo clarify with gesv as an example, the code currently looks like this:\r\n```\r\n  magma_queue_t gesv_magma_queue = createMagmaQueue(b);\r\n   magmaGesvBatched<scalar_t>(\r\n      n, nrhs, A_array, n, ipiv_array, b_array, n,\r\n      info_array, batch_size, gesv_magma_queue);\r\n   destroyMagmaQueue(gesv_magma_queue);\r\n```\r\nbut we could prevent future contributors from accidentally forgetting to free the queue with something like the following:\r\n```\r\n  MagmaQueue gesv_magma_queue;\r\n   magmaGesvBatched<scalar_t>(\r\n      n, nrhs, A_array, n, ipiv_array, b_array, n,\r\n      info_array, batch_size, gesv_magma_queue);\r\n  // no need to destory gesv_magma_queue, it will be cleaned up when it goes out of scope\r\n```", "created_at": "2018-10-22T14:57:55Z", "updated_at": "2018-11-23T15:53:20Z", "html_url": "https://github.com/pytorch/pytorch/pull/9949#discussion_r227013394", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/9949", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/227013394"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/9949#discussion_r227013394"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/9949"}}, "body_html": "<p>Sorry, I'm not following: the magma queue seems local to the function, so wouldn't getri and getrf use different queues regardless of if magma queue creation is RAII or not?</p>\n<p>To clarify with gesv as an example, the code currently looks like this:</p>\n<pre><code>  magma_queue_t gesv_magma_queue = createMagmaQueue(b);\n   magmaGesvBatched&lt;scalar_t&gt;(\n      n, nrhs, A_array, n, ipiv_array, b_array, n,\n      info_array, batch_size, gesv_magma_queue);\n   destroyMagmaQueue(gesv_magma_queue);\n</code></pre>\n<p>but we could prevent future contributors from accidentally forgetting to free the queue with something like the following:</p>\n<pre><code>  MagmaQueue gesv_magma_queue;\n   magmaGesvBatched&lt;scalar_t&gt;(\n      n, nrhs, A_array, n, ipiv_array, b_array, n,\n      info_array, batch_size, gesv_magma_queue);\n  // no need to destory gesv_magma_queue, it will be cleaned up when it goes out of scope\n</code></pre>", "body_text": "Sorry, I'm not following: the magma queue seems local to the function, so wouldn't getri and getrf use different queues regardless of if magma queue creation is RAII or not?\nTo clarify with gesv as an example, the code currently looks like this:\n  magma_queue_t gesv_magma_queue = createMagmaQueue(b);\n   magmaGesvBatched<scalar_t>(\n      n, nrhs, A_array, n, ipiv_array, b_array, n,\n      info_array, batch_size, gesv_magma_queue);\n   destroyMagmaQueue(gesv_magma_queue);\n\nbut we could prevent future contributors from accidentally forgetting to free the queue with something like the following:\n  MagmaQueue gesv_magma_queue;\n   magmaGesvBatched<scalar_t>(\n      n, nrhs, A_array, n, ipiv_array, b_array, n,\n      info_array, batch_size, gesv_magma_queue);\n  // no need to destory gesv_magma_queue, it will be cleaned up when it goes out of scope", "in_reply_to_id": 226988900}