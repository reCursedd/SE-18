{"url": "https://api.github.com/repos/pytorch/pytorch/issues/10902", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/10902/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/10902/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/10902/events", "html_url": "https://github.com/pytorch/pytorch/issues/10902", "id": 354351548, "node_id": "MDU6SXNzdWUzNTQzNTE1NDg=", "number": 10902, "title": "LNK2019 error when linking with MSVC [Caffe2]", "user": {"login": "Palmitoxico", "id": 8903198, "node_id": "MDQ6VXNlcjg5MDMxOTg=", "avatar_url": "https://avatars2.githubusercontent.com/u/8903198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Palmitoxico", "html_url": "https://github.com/Palmitoxico", "followers_url": "https://api.github.com/users/Palmitoxico/followers", "following_url": "https://api.github.com/users/Palmitoxico/following{/other_user}", "gists_url": "https://api.github.com/users/Palmitoxico/gists{/gist_id}", "starred_url": "https://api.github.com/users/Palmitoxico/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Palmitoxico/subscriptions", "organizations_url": "https://api.github.com/users/Palmitoxico/orgs", "repos_url": "https://api.github.com/users/Palmitoxico/repos", "events_url": "https://api.github.com/users/Palmitoxico/events{/privacy}", "received_events_url": "https://api.github.com/users/Palmitoxico/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-08-27T14:51:00Z", "updated_at": "2018-08-28T18:28:02Z", "closed_at": null, "author_association": "NONE", "body_html": "<h2>Issue description</h2>\n<p>I've been trying to build a simple C++ program using the Caffe2 library (statically linked) since last week and it has been a painful experience. I couldn't find any information on how to properly build the Caffe2 library so I've had to figure it out through trial and error. I managed to compile and install the caffe2 lib with these commands (powershell):</p>\n<pre><code>&gt; cd pytorch\n&gt; mkdir build\n&gt; cd build\n&gt; cmake ../.. -DCMAKE_INSTALL_PREFIX=\"${HOME}/caffe2-static-minimal\" -DBUILD_PYTHON=OFF -DUSE_CUDA=OFF  -DUSE_GFLAGS=OFF -DUSE_GLOG=OFF -DUSE_GLOO=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_TEST=OFF -DBUILD_BINARY=OFF -DUSE_LMDB=OFF -DUSE_LEVELDB=OFF -DUSE_MPI=OFF -DUSE_OPENMP=OFF -DUSE_OPENCV=OFF -DBUILD_ATEN=ON -DCAFFE2_DISABLE_NUMA=1 -G \"Visual Studio 15 2017 Win64\"\n&gt; cmake --build . --config Release --target install\n&gt; # For some reason the caffe2_protos.lib and onnxifi_loader.lib files aren't installed, so I've to manually copy then:\n&gt; cp lib/Release/caffe2_protos.lib \"${HOME}/caffe2-static-minimal/lib/\"\n&gt; cp lib/Release/onnxifi_loader.lib \"${HOME}/caffe2-static-minimal/lib/\"\n&gt; # The protobuf library shouldn't start with 'lib' when building in a Windows enviroment:\n&gt; pushd \"${HOME}/caffe2-static-minimal/lib/\"\n&gt; mv libprotobuf.lib protobuf.lib\n&gt; popd\n</code></pre>\n<p>When I try to build the simple example listed bellow I get a bunch of link errors, MSVC output:</p>\n<pre><code>(Link target) -&gt; \n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) private: __cdecl caffe2::TypeIdentifier::TypeIdentifier(unsigned short)\" (__imp_??0TypeIdentifier@caffe2@@AEAA@G@Z) referenced in function \"public: __cdecl caffe2::Tensor::Tensor&lt;float&gt;(class std::vector&lt;__int64,class std::allocator&lt;__int64&gt; &gt; const &amp;,class std::vector&lt;float,class std::allocator&lt;float&gt; &gt; const &amp;,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) private: __cdecl caffe2::TypeMeta::TypeMeta(class caffe2::TypeIdentifier,unsigned __int64,void (__cdecl*)(void *,unsigned __int64),void (__cdecl*)(void const *,void *,unsigned __int64),void (__cdecl*)(void *,unsigned __int64))\" (__imp_??0TypeMeta@caffe2@@AEAA@VTypeIdentifier@1@_KP6AXPEAX1@ZP6AXPEBX21@Z3@Z) referenced in function \"public: __cdecl caffe2::Tensor::Tensor&lt;float&gt;(class std::vector&lt;__int64,class std::allocator&lt;__int64&gt; &gt; const &amp;,class std::vector&lt;float,class std::allocator&lt;float&gt; &gt; const &amp;,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: unsigned __int64 const &amp; __cdecl caffe2::TypeMeta::itemsize(void)const \" (__imp_?itemsize@TypeMeta@caffe2@@QEBAAEB_KXZ) referenced in function \"public: __cdecl caffe2::Tensor::Tensor&lt;float&gt;(class std::vector&lt;__int64,class std::allocator&lt;__int64&gt; &gt; const &amp;,class std::vector&lt;float,class std::allocator&lt;float&gt; &gt; const &amp;,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::ctor(void)const )(void *,unsigned __int64)\" (__imp_?ctor@TypeMeta@caffe2@@QEBAP6AXPEAX_K@ZXZ) referenced in function \"public: void * __cdecl caffe2::Tensor::raw_mutable_data(class caffe2::TypeMeta const &amp;)\" (?raw_mutable_data@Tensor@caffe2@@QEAAPEAXAEBVTypeMeta@2@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::copy(void)const )(void const *,void *,unsigned __int64)\" (__imp_?copy@TypeMeta@caffe2@@QEBAP6AXPEBXPEAX_K@ZXZ) referenced in function \"public: __cdecl caffe2::Tensor::Tensor&lt;float&gt;(class std::vector&lt;__int64,class std::allocator&lt;__int64&gt; &gt; const &amp;,class std::vector&lt;float,class std::allocator&lt;float&gt; &gt; const &amp;,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::dtor(void)const )(void *,unsigned __int64)\" (__imp_?dtor@TypeMeta@caffe2@@QEBAP6AXPEAX_K@ZXZ) referenced in function \"public: void * __cdecl caffe2::Tensor::raw_mutable_data(class caffe2::TypeMeta const &amp;)\" (?raw_mutable_data@Tensor@caffe2@@QEAAPEAXAEBVTypeMeta@2@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  C:\\Users\\Administrator\\repos\\test-caffe2\\build\\Release\\test-caffe2.exe : fatal error LNK1120: 6 unresolved externals [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n\n    45 Warning(s)\n    7 Error(s)\n</code></pre>\n<p>I've tried applying  <a href=\"https://github.com/pytorch/pytorch/pull/10652\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/10652/hovercard\">#10652</a> and <a href=\"https://github.com/pytorch/pytorch/pull/10765\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/10765/hovercard\">#10765</a> but I've got the same results.</p>\n<h2>Code example</h2>\n<p>Here is a minimal example to reproduce the link problems:</p>\n<p>test-caffe2.cpp:</p>\n<pre><code>#include &lt;caffe2/core/init.h&gt;\n#include &lt;caffe2/core/net.h&gt;\n#include &lt;caffe2/utils/proto_utils.h&gt;\n\nint main(int argc, char **argv) {\n\tcaffe2::GlobalInit();\n\n\tstd::vector&lt;float&gt; data;\n\tstd::vector&lt;caffe2::TIndex&gt; dims({1, 3, 224, 224});\n\tcaffe2::CPUContext context;\n\tvolatile caffe2::Tensor tensor(dims, data, &amp;context);\n\n\tgoogle::protobuf::ShutdownProtobufLibrary();\n\treturn 0;\n}\n</code></pre>\n<p>CMakeLists.txt:</p>\n<pre><code>cmake_minimum_required(VERSION 2.6)\n\nproject (caffe2_test)\n\nset(CMAKE_CXX_FLAGS_RELEASE \"${CMAKE_CXX_FLAGS_RELEASE} /MT\")\n\nfind_package(Threads)\n\nset(ALL_LIBRARIES)\nlist(APPEND ALL_LIBRARIES ${CMAKE_THREAD_LIBS_INIT})\n\nfind_library(CAFFE2_LIB caffe2)\nlist(APPEND ALL_LIBRARIES ${CAFFE2_LIB})\n\nfind_library(PROTOBUF_LIB protobuf)\nlist(APPEND ALL_LIBRARIES ${PROTOBUF_LIB})\n\nfind_library(ONNX_PROTO_LIB onnx_proto)\nlist(APPEND ALL_LIBRARIES ${ONNX_PROTO_LIB})\n\nfind_library(ONNX_LIB onnx)\nlist(APPEND ALL_LIBRARIES ${ONNX_LIB})\n\nfind_library(ONNXIFI_LOADER_LIB onnxifi_loader)\nlist(APPEND ALL_LIBRARIES ${ONNXIFI_LOADER_LIB})\n\nfind_library(NOMNIGRAPH_LIB nomnigraph)\nlist(APPEND ALL_LIBRARIES ${NOMNIGRAPH_LIB})\n\nfind_library(CAFFE2_PROTO_LIB caffe2_protos)\nlist(APPEND ALL_LIBRARIES ${CAFFE2_PROTO_LIB})\n\nfind_library(CPUINFO_LIB cpuinfo)\nlist(APPEND ALL_LIBRARIES ${CPUINFO_LIB})\n\nfind_library(CLOG_LIB clog)\nlist(APPEND ALL_LIBRARIES ${CLOG_LIB})\n\ninclude_directories(${CAFFE2_INCLUDE_DIR})\n\nif(NOT CAFFE2_LIB)\n  message(FATAL_ERROR \"Caffe2 lib not found\")\nendif()\n\nset(CMAKE_CXX_STANDARD 11)\n\nadd_executable(test-caffe2 test-caffe2.cpp)\n\ntarget_link_libraries(test-caffe2 ${ALL_LIBRARIES} ${CMAKE_DL_LIBS})\n\n</code></pre>\n<p>Build instructions (powershell):</p>\n<pre><code>&gt; mkdir build\n&gt; cd build\n&gt; cmake ..  -DCMAKE_PREFIX_PATH=\"${HOME}/caffe2-static-minimal/lib\" -DCAFFE2_INCLUDE_DIR=\"${HOME}/caffe2-static-minimal/include/\" -DCMAKE_BUILD_TYPE=Release -G \"Visual Studio 15 2017 Win64\"\n&gt; cmake --build . --config Release\n</code></pre>\n<p>Any hints?</p>\n<h2>System Info</h2>\n<ul>\n<li>PyTorch / Caffe2: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/c8b246abf31a8717105622077bc7669e2dc753a9/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/c8b246abf31a8717105622077bc7669e2dc753a9\"><tt>c8b246a</tt></a> with <a href=\"https://github.com/pytorch/pytorch/pull/10652\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/10652/hovercard\">#10652</a> and <a href=\"https://github.com/pytorch/pytorch/pull/10765\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/10765/hovercard\">#10765</a> applyed</li>\n<li>Build command: <code>cmake ../.. -DCMAKE_INSTALL_PREFIX=\"${HOME}/caffe2-static-minimal\" -DBUILD_PYTHON=OFF -DUSE_CUDA=OFF  -DUSE_GFLAGS=OFF -DUSE_GLOG=OFF -DUSE_GLOO=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_TEST=OFF -DBUILD_BINARY=OFF -DUSE_LMDB=OFF -DUSE_LEVELDB=OFF -DUSE_MPI=OFF -DUSE_OPENMP=OFF -DUSE_OPENCV=OFF -DBUILD_ATEN=ON -DCAFFE2_DISABLE_NUMA=1 -G \"Visual Studio 15 2017 Win64\"</code></li>\n<li>OS: Windows Server 2016 1607</li>\n<li>MSVC version: 19.15.26726.0</li>\n<li>CMake version: 3.11.18040201-MSVC_2</li>\n</ul>", "body_text": "Issue description\nI've been trying to build a simple C++ program using the Caffe2 library (statically linked) since last week and it has been a painful experience. I couldn't find any information on how to properly build the Caffe2 library so I've had to figure it out through trial and error. I managed to compile and install the caffe2 lib with these commands (powershell):\n> cd pytorch\n> mkdir build\n> cd build\n> cmake ../.. -DCMAKE_INSTALL_PREFIX=\"${HOME}/caffe2-static-minimal\" -DBUILD_PYTHON=OFF -DUSE_CUDA=OFF  -DUSE_GFLAGS=OFF -DUSE_GLOG=OFF -DUSE_GLOO=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_TEST=OFF -DBUILD_BINARY=OFF -DUSE_LMDB=OFF -DUSE_LEVELDB=OFF -DUSE_MPI=OFF -DUSE_OPENMP=OFF -DUSE_OPENCV=OFF -DBUILD_ATEN=ON -DCAFFE2_DISABLE_NUMA=1 -G \"Visual Studio 15 2017 Win64\"\n> cmake --build . --config Release --target install\n> # For some reason the caffe2_protos.lib and onnxifi_loader.lib files aren't installed, so I've to manually copy then:\n> cp lib/Release/caffe2_protos.lib \"${HOME}/caffe2-static-minimal/lib/\"\n> cp lib/Release/onnxifi_loader.lib \"${HOME}/caffe2-static-minimal/lib/\"\n> # The protobuf library shouldn't start with 'lib' when building in a Windows enviroment:\n> pushd \"${HOME}/caffe2-static-minimal/lib/\"\n> mv libprotobuf.lib protobuf.lib\n> popd\n\nWhen I try to build the simple example listed bellow I get a bunch of link errors, MSVC output:\n(Link target) -> \n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) private: __cdecl caffe2::TypeIdentifier::TypeIdentifier(unsigned short)\" (__imp_??0TypeIdentifier@caffe2@@AEAA@G@Z) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) private: __cdecl caffe2::TypeMeta::TypeMeta(class caffe2::TypeIdentifier,unsigned __int64,void (__cdecl*)(void *,unsigned __int64),void (__cdecl*)(void const *,void *,unsigned __int64),void (__cdecl*)(void *,unsigned __int64))\" (__imp_??0TypeMeta@caffe2@@AEAA@VTypeIdentifier@1@_KP6AXPEAX1@ZP6AXPEBX21@Z3@Z) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: unsigned __int64 const & __cdecl caffe2::TypeMeta::itemsize(void)const \" (__imp_?itemsize@TypeMeta@caffe2@@QEBAAEB_KXZ) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::ctor(void)const )(void *,unsigned __int64)\" (__imp_?ctor@TypeMeta@caffe2@@QEBAP6AXPEAX_K@ZXZ) referenced in function \"public: void * __cdecl caffe2::Tensor::raw_mutable_data(class caffe2::TypeMeta const &)\" (?raw_mutable_data@Tensor@caffe2@@QEAAPEAXAEBVTypeMeta@2@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::copy(void)const )(void const *,void *,unsigned __int64)\" (__imp_?copy@TypeMeta@caffe2@@QEBAP6AXPEBXPEAX_K@ZXZ) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::dtor(void)const )(void *,unsigned __int64)\" (__imp_?dtor@TypeMeta@caffe2@@QEBAP6AXPEAX_K@ZXZ) referenced in function \"public: void * __cdecl caffe2::Tensor::raw_mutable_data(class caffe2::TypeMeta const &)\" (?raw_mutable_data@Tensor@caffe2@@QEAAPEAXAEBVTypeMeta@2@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n  C:\\Users\\Administrator\\repos\\test-caffe2\\build\\Release\\test-caffe2.exe : fatal error LNK1120: 6 unresolved externals [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\n\n    45 Warning(s)\n    7 Error(s)\n\nI've tried applying  #10652 and #10765 but I've got the same results.\nCode example\nHere is a minimal example to reproduce the link problems:\ntest-caffe2.cpp:\n#include <caffe2/core/init.h>\n#include <caffe2/core/net.h>\n#include <caffe2/utils/proto_utils.h>\n\nint main(int argc, char **argv) {\n\tcaffe2::GlobalInit();\n\n\tstd::vector<float> data;\n\tstd::vector<caffe2::TIndex> dims({1, 3, 224, 224});\n\tcaffe2::CPUContext context;\n\tvolatile caffe2::Tensor tensor(dims, data, &context);\n\n\tgoogle::protobuf::ShutdownProtobufLibrary();\n\treturn 0;\n}\n\nCMakeLists.txt:\ncmake_minimum_required(VERSION 2.6)\n\nproject (caffe2_test)\n\nset(CMAKE_CXX_FLAGS_RELEASE \"${CMAKE_CXX_FLAGS_RELEASE} /MT\")\n\nfind_package(Threads)\n\nset(ALL_LIBRARIES)\nlist(APPEND ALL_LIBRARIES ${CMAKE_THREAD_LIBS_INIT})\n\nfind_library(CAFFE2_LIB caffe2)\nlist(APPEND ALL_LIBRARIES ${CAFFE2_LIB})\n\nfind_library(PROTOBUF_LIB protobuf)\nlist(APPEND ALL_LIBRARIES ${PROTOBUF_LIB})\n\nfind_library(ONNX_PROTO_LIB onnx_proto)\nlist(APPEND ALL_LIBRARIES ${ONNX_PROTO_LIB})\n\nfind_library(ONNX_LIB onnx)\nlist(APPEND ALL_LIBRARIES ${ONNX_LIB})\n\nfind_library(ONNXIFI_LOADER_LIB onnxifi_loader)\nlist(APPEND ALL_LIBRARIES ${ONNXIFI_LOADER_LIB})\n\nfind_library(NOMNIGRAPH_LIB nomnigraph)\nlist(APPEND ALL_LIBRARIES ${NOMNIGRAPH_LIB})\n\nfind_library(CAFFE2_PROTO_LIB caffe2_protos)\nlist(APPEND ALL_LIBRARIES ${CAFFE2_PROTO_LIB})\n\nfind_library(CPUINFO_LIB cpuinfo)\nlist(APPEND ALL_LIBRARIES ${CPUINFO_LIB})\n\nfind_library(CLOG_LIB clog)\nlist(APPEND ALL_LIBRARIES ${CLOG_LIB})\n\ninclude_directories(${CAFFE2_INCLUDE_DIR})\n\nif(NOT CAFFE2_LIB)\n  message(FATAL_ERROR \"Caffe2 lib not found\")\nendif()\n\nset(CMAKE_CXX_STANDARD 11)\n\nadd_executable(test-caffe2 test-caffe2.cpp)\n\ntarget_link_libraries(test-caffe2 ${ALL_LIBRARIES} ${CMAKE_DL_LIBS})\n\n\nBuild instructions (powershell):\n> mkdir build\n> cd build\n> cmake ..  -DCMAKE_PREFIX_PATH=\"${HOME}/caffe2-static-minimal/lib\" -DCAFFE2_INCLUDE_DIR=\"${HOME}/caffe2-static-minimal/include/\" -DCMAKE_BUILD_TYPE=Release -G \"Visual Studio 15 2017 Win64\"\n> cmake --build . --config Release\n\nAny hints?\nSystem Info\n\nPyTorch / Caffe2: c8b246a with #10652 and #10765 applyed\nBuild command: cmake ../.. -DCMAKE_INSTALL_PREFIX=\"${HOME}/caffe2-static-minimal\" -DBUILD_PYTHON=OFF -DUSE_CUDA=OFF  -DUSE_GFLAGS=OFF -DUSE_GLOG=OFF -DUSE_GLOO=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_TEST=OFF -DBUILD_BINARY=OFF -DUSE_LMDB=OFF -DUSE_LEVELDB=OFF -DUSE_MPI=OFF -DUSE_OPENMP=OFF -DUSE_OPENCV=OFF -DBUILD_ATEN=ON -DCAFFE2_DISABLE_NUMA=1 -G \"Visual Studio 15 2017 Win64\"\nOS: Windows Server 2016 1607\nMSVC version: 19.15.26726.0\nCMake version: 3.11.18040201-MSVC_2", "body": "## Issue description\r\nI've been trying to build a simple C++ program using the Caffe2 library (statically linked) since last week and it has been a painful experience. I couldn't find any information on how to properly build the Caffe2 library so I've had to figure it out through trial and error. I managed to compile and install the caffe2 lib with these commands (powershell):\r\n\r\n```\r\n> cd pytorch\r\n> mkdir build\r\n> cd build\r\n> cmake ../.. -DCMAKE_INSTALL_PREFIX=\"${HOME}/caffe2-static-minimal\" -DBUILD_PYTHON=OFF -DUSE_CUDA=OFF  -DUSE_GFLAGS=OFF -DUSE_GLOG=OFF -DUSE_GLOO=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_TEST=OFF -DBUILD_BINARY=OFF -DUSE_LMDB=OFF -DUSE_LEVELDB=OFF -DUSE_MPI=OFF -DUSE_OPENMP=OFF -DUSE_OPENCV=OFF -DBUILD_ATEN=ON -DCAFFE2_DISABLE_NUMA=1 -G \"Visual Studio 15 2017 Win64\"\r\n> cmake --build . --config Release --target install\r\n> # For some reason the caffe2_protos.lib and onnxifi_loader.lib files aren't installed, so I've to manually copy then:\r\n> cp lib/Release/caffe2_protos.lib \"${HOME}/caffe2-static-minimal/lib/\"\r\n> cp lib/Release/onnxifi_loader.lib \"${HOME}/caffe2-static-minimal/lib/\"\r\n> # The protobuf library shouldn't start with 'lib' when building in a Windows enviroment:\r\n> pushd \"${HOME}/caffe2-static-minimal/lib/\"\r\n> mv libprotobuf.lib protobuf.lib\r\n> popd\r\n```\r\nWhen I try to build the simple example listed bellow I get a bunch of link errors, MSVC output:\r\n```\r\n(Link target) -> \r\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) private: __cdecl caffe2::TypeIdentifier::TypeIdentifier(unsigned short)\" (__imp_??0TypeIdentifier@caffe2@@AEAA@G@Z) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) private: __cdecl caffe2::TypeMeta::TypeMeta(class caffe2::TypeIdentifier,unsigned __int64,void (__cdecl*)(void *,unsigned __int64),void (__cdecl*)(void const *,void *,unsigned __int64),void (__cdecl*)(void *,unsigned __int64))\" (__imp_??0TypeMeta@caffe2@@AEAA@VTypeIdentifier@1@_KP6AXPEAX1@ZP6AXPEBX21@Z3@Z) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: unsigned __int64 const & __cdecl caffe2::TypeMeta::itemsize(void)const \" (__imp_?itemsize@TypeMeta@caffe2@@QEBAAEB_KXZ) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::ctor(void)const )(void *,unsigned __int64)\" (__imp_?ctor@TypeMeta@caffe2@@QEBAP6AXPEAX_K@ZXZ) referenced in function \"public: void * __cdecl caffe2::Tensor::raw_mutable_data(class caffe2::TypeMeta const &)\" (?raw_mutable_data@Tensor@caffe2@@QEAAPEAXAEBVTypeMeta@2@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::copy(void)const )(void const *,void *,unsigned __int64)\" (__imp_?copy@TypeMeta@caffe2@@QEBAP6AXPEBXPEAX_K@ZXZ) referenced in function \"public: __cdecl caffe2::Tensor::Tensor<float>(class std::vector<__int64,class std::allocator<__int64> > const &,class std::vector<float,class std::allocator<float> > const &,class caffe2::BaseContext *)\" (??$?0M@Tensor@caffe2@@QEAA@AEBV?$vector@_JV?$allocator@_J@std@@@std@@AEBV?$vector@MV?$allocator@M@std@@@3@PEAVBaseContext@1@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n  test-caffe2.obj : error LNK2019: unresolved external symbol \"__declspec(dllimport) public: void (__cdecl*__cdecl caffe2::TypeMeta::dtor(void)const )(void *,unsigned __int64)\" (__imp_?dtor@TypeMeta@caffe2@@QEBAP6AXPEAX_K@ZXZ) referenced in function \"public: void * __cdecl caffe2::Tensor::raw_mutable_data(class caffe2::TypeMeta const &)\" (?raw_mutable_data@Tensor@caffe2@@QEAAPEAXAEBVTypeMeta@2@@Z) [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n  C:\\Users\\Administrator\\repos\\test-caffe2\\build\\Release\\test-caffe2.exe : fatal error LNK1120: 6 unresolved externals [C:\\Users\\Administrator\\repos\\test-caffe2\\build\\test-caffe2.vcxproj]\r\n\r\n    45 Warning(s)\r\n    7 Error(s)\r\n```\r\n\r\nI've tried applying  [#10652](https://github.com/pytorch/pytorch/pull/10652) and [#10765](https://github.com/pytorch/pytorch/pull/10765) but I've got the same results.\r\n\r\n## Code example\r\nHere is a minimal example to reproduce the link problems:\r\n\r\ntest-caffe2.cpp:\r\n```\r\n#include <caffe2/core/init.h>\r\n#include <caffe2/core/net.h>\r\n#include <caffe2/utils/proto_utils.h>\r\n\r\nint main(int argc, char **argv) {\r\n\tcaffe2::GlobalInit();\r\n\r\n\tstd::vector<float> data;\r\n\tstd::vector<caffe2::TIndex> dims({1, 3, 224, 224});\r\n\tcaffe2::CPUContext context;\r\n\tvolatile caffe2::Tensor tensor(dims, data, &context);\r\n\r\n\tgoogle::protobuf::ShutdownProtobufLibrary();\r\n\treturn 0;\r\n}\r\n```\r\n\r\nCMakeLists.txt:\r\n```\r\ncmake_minimum_required(VERSION 2.6)\r\n\r\nproject (caffe2_test)\r\n\r\nset(CMAKE_CXX_FLAGS_RELEASE \"${CMAKE_CXX_FLAGS_RELEASE} /MT\")\r\n\r\nfind_package(Threads)\r\n\r\nset(ALL_LIBRARIES)\r\nlist(APPEND ALL_LIBRARIES ${CMAKE_THREAD_LIBS_INIT})\r\n\r\nfind_library(CAFFE2_LIB caffe2)\r\nlist(APPEND ALL_LIBRARIES ${CAFFE2_LIB})\r\n\r\nfind_library(PROTOBUF_LIB protobuf)\r\nlist(APPEND ALL_LIBRARIES ${PROTOBUF_LIB})\r\n\r\nfind_library(ONNX_PROTO_LIB onnx_proto)\r\nlist(APPEND ALL_LIBRARIES ${ONNX_PROTO_LIB})\r\n\r\nfind_library(ONNX_LIB onnx)\r\nlist(APPEND ALL_LIBRARIES ${ONNX_LIB})\r\n\r\nfind_library(ONNXIFI_LOADER_LIB onnxifi_loader)\r\nlist(APPEND ALL_LIBRARIES ${ONNXIFI_LOADER_LIB})\r\n\r\nfind_library(NOMNIGRAPH_LIB nomnigraph)\r\nlist(APPEND ALL_LIBRARIES ${NOMNIGRAPH_LIB})\r\n\r\nfind_library(CAFFE2_PROTO_LIB caffe2_protos)\r\nlist(APPEND ALL_LIBRARIES ${CAFFE2_PROTO_LIB})\r\n\r\nfind_library(CPUINFO_LIB cpuinfo)\r\nlist(APPEND ALL_LIBRARIES ${CPUINFO_LIB})\r\n\r\nfind_library(CLOG_LIB clog)\r\nlist(APPEND ALL_LIBRARIES ${CLOG_LIB})\r\n\r\ninclude_directories(${CAFFE2_INCLUDE_DIR})\r\n\r\nif(NOT CAFFE2_LIB)\r\n  message(FATAL_ERROR \"Caffe2 lib not found\")\r\nendif()\r\n\r\nset(CMAKE_CXX_STANDARD 11)\r\n\r\nadd_executable(test-caffe2 test-caffe2.cpp)\r\n\r\ntarget_link_libraries(test-caffe2 ${ALL_LIBRARIES} ${CMAKE_DL_LIBS})\r\n\r\n```\r\nBuild instructions (powershell):\r\n```\r\n> mkdir build\r\n> cd build\r\n> cmake ..  -DCMAKE_PREFIX_PATH=\"${HOME}/caffe2-static-minimal/lib\" -DCAFFE2_INCLUDE_DIR=\"${HOME}/caffe2-static-minimal/include/\" -DCMAKE_BUILD_TYPE=Release -G \"Visual Studio 15 2017 Win64\"\r\n> cmake --build . --config Release\r\n```\r\n\r\nAny hints?\r\n\r\n## System Info\r\n- PyTorch / Caffe2: c8b246abf31a8717105622077bc7669e2dc753a9 with [#10652](https://github.com/pytorch/pytorch/pull/10652) and [#10765](https://github.com/pytorch/pytorch/pull/10765) applyed\r\n- Build command: ```cmake ../.. -DCMAKE_INSTALL_PREFIX=\"${HOME}/caffe2-static-minimal\" -DBUILD_PYTHON=OFF -DUSE_CUDA=OFF  -DUSE_GFLAGS=OFF -DUSE_GLOG=OFF -DUSE_GLOO=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_TEST=OFF -DBUILD_BINARY=OFF -DUSE_LMDB=OFF -DUSE_LEVELDB=OFF -DUSE_MPI=OFF -DUSE_OPENMP=OFF -DUSE_OPENCV=OFF -DBUILD_ATEN=ON -DCAFFE2_DISABLE_NUMA=1 -G \"Visual Studio 15 2017 Win64\"```\r\n- OS: Windows Server 2016 1607\r\n- MSVC version: 19.15.26726.0\r\n- CMake version: 3.11.18040201-MSVC_2\r\n"}