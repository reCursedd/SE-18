{"url": "https://api.github.com/repos/pytorch/pytorch/issues/4333", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/4333/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/4333/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/4333/events", "html_url": "https://github.com/pytorch/pytorch/issues/4333", "id": 284296204, "node_id": "MDU6SXNzdWUyODQyOTYyMDQ=", "number": 4333, "title": "Model behaves differently after saving and loading", "user": {"login": "magic282", "id": 2285145, "node_id": "MDQ6VXNlcjIyODUxNDU=", "avatar_url": "https://avatars1.githubusercontent.com/u/2285145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/magic282", "html_url": "https://github.com/magic282", "followers_url": "https://api.github.com/users/magic282/followers", "following_url": "https://api.github.com/users/magic282/following{/other_user}", "gists_url": "https://api.github.com/users/magic282/gists{/gist_id}", "starred_url": "https://api.github.com/users/magic282/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/magic282/subscriptions", "organizations_url": "https://api.github.com/users/magic282/orgs", "repos_url": "https://api.github.com/users/magic282/repos", "events_url": "https://api.github.com/users/magic282/events{/privacy}", "received_events_url": "https://api.github.com/users/magic282/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2017-12-23T09:15:44Z", "updated_at": "2018-05-04T04:44:12Z", "closed_at": "2017-12-29T11:26:49Z", "author_association": "NONE", "body_html": "<p>Hi,</p>\n<p>Recently I am working on a summarization project. During training, I saved the best model on the development set. However, loading the best model and testing again on the dev set gives me different ROUGE result (0.18218091939853281 -&gt; 0.18217045231619222 ). Although the difference is small, it raises much concerns. And my colleagues told me that they have also encountered this issue (they observed about 2 points drop on their QA task). So I wrote a small <a href=\"https://gist.github.com/magic282/94bdbb3b9ddef891d7aa40f0b0069a0f\">script</a>, and found that the parameters are identical, but the result is different after saving and loading.</p>\n<p>And I also found this thread <a href=\"https://discuss.pytorch.org/t/saving-and-loading-a-model-in-pytorch/2610/21\" rel=\"nofollow\">https://discuss.pytorch.org/t/saving-and-loading-a-model-in-pytorch/2610/21</a></p>\n<p>The code on github gist runs on Windows (peterjc123\u2019s 0.3.0 build). On linux (also 0.3.0 , I built a docker image myself by installing pytorch through conda) it raises an error that I don\u2019t understand why:</p>\n<div class=\"highlight highlight-source-python\"><pre>THCudaCheck <span class=\"pl-c1\">FAIL</span> <span class=\"pl-v\">file</span><span class=\"pl-k\">=</span><span class=\"pl-k\">/</span>opt<span class=\"pl-k\">/</span>conda<span class=\"pl-k\">/</span>conda<span class=\"pl-k\">-</span>bld<span class=\"pl-k\">/</span>pytorch_1512386481460<span class=\"pl-k\">/</span>work<span class=\"pl-k\">/</span>torch<span class=\"pl-k\">/</span>lib<span class=\"pl-k\">/</span><span class=\"pl-c1\">THC</span><span class=\"pl-k\">/</span>THCTensorCopy.cu line<span class=\"pl-k\">=</span><span class=\"pl-c1\">204</span> error<span class=\"pl-k\">=</span><span class=\"pl-c1\">59</span> : device<span class=\"pl-k\">-</span>side <span class=\"pl-k\">assert</span> triggered\nTraceback (most recent call last):\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>test.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">120</span>, <span class=\"pl-k\">in</span> <span class=\"pl-k\">&lt;</span>module<span class=\"pl-k\">&gt;</span>\n    main()\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>test.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">76</span>, <span class=\"pl-k\">in</span> main\n    hidden <span class=\"pl-k\">=</span> hidden.transpose(<span class=\"pl-c1\">0</span>, <span class=\"pl-c1\">1</span>).contiguous().view(hidden.size(<span class=\"pl-c1\">1</span>), <span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>)\n  File <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/opt/conda/envs/pytorch-py3.6/lib/python3.6/site-packages/torch/autograd/variable.py<span class=\"pl-pds\">\"</span></span>, line <span class=\"pl-c1\">280</span>, <span class=\"pl-k\">in</span> contiguous\n    <span class=\"pl-c1\">self</span>.data <span class=\"pl-k\">=</span> <span class=\"pl-c1\">self</span>.data.contiguous()\n<span class=\"pl-c1\">RuntimeError</span>: cuda runtime error (<span class=\"pl-c1\">59</span>) : device<span class=\"pl-k\">-</span>side <span class=\"pl-k\">assert</span> triggered at <span class=\"pl-k\">/</span>opt<span class=\"pl-k\">/</span>conda<span class=\"pl-k\">/</span>conda<span class=\"pl-k\">-</span>bld<span class=\"pl-k\">/</span>pytorch_1512386481460<span class=\"pl-k\">/</span>work<span class=\"pl-k\">/</span>torch<span class=\"pl-k\">/</span>lib<span class=\"pl-k\">/</span><span class=\"pl-c1\">THC</span><span class=\"pl-k\">/</span>THCTensorCopy.cu:<span class=\"pl-c1\">204</span></pre></div>\n<p>The thread I posted <a href=\"https://discuss.pytorch.org/t/parameters-are-different-after-loading-model/11457\" rel=\"nofollow\">https://discuss.pytorch.org/t/parameters-are-different-after-loading-model/11457</a></p>", "body_text": "Hi,\nRecently I am working on a summarization project. During training, I saved the best model on the development set. However, loading the best model and testing again on the dev set gives me different ROUGE result (0.18218091939853281 -> 0.18217045231619222 ). Although the difference is small, it raises much concerns. And my colleagues told me that they have also encountered this issue (they observed about 2 points drop on their QA task). So I wrote a small script, and found that the parameters are identical, but the result is different after saving and loading.\nAnd I also found this thread https://discuss.pytorch.org/t/saving-and-loading-a-model-in-pytorch/2610/21\nThe code on github gist runs on Windows (peterjc123\u2019s 0.3.0 build). On linux (also 0.3.0 , I built a docker image myself by installing pytorch through conda) it raises an error that I don\u2019t understand why:\nTHCudaCheck FAIL file=/opt/conda/conda-bld/pytorch_1512386481460/work/torch/lib/THC/THCTensorCopy.cu line=204 error=59 : device-side assert triggered\nTraceback (most recent call last):\n  File \"test.py\", line 120, in <module>\n    main()\n  File \"test.py\", line 76, in main\n    hidden = hidden.transpose(0, 1).contiguous().view(hidden.size(1), -1)\n  File \"/opt/conda/envs/pytorch-py3.6/lib/python3.6/site-packages/torch/autograd/variable.py\", line 280, in contiguous\n    self.data = self.data.contiguous()\nRuntimeError: cuda runtime error (59) : device-side assert triggered at /opt/conda/conda-bld/pytorch_1512386481460/work/torch/lib/THC/THCTensorCopy.cu:204\nThe thread I posted https://discuss.pytorch.org/t/parameters-are-different-after-loading-model/11457", "body": "Hi,\r\n\r\nRecently I am working on a summarization project. During training, I saved the best model on the development set. However, loading the best model and testing again on the dev set gives me different ROUGE result (0.18218091939853281 -> 0.18217045231619222 ). Although the difference is small, it raises much concerns. And my colleagues told me that they have also encountered this issue (they observed about 2 points drop on their QA task). So I wrote a small [script](https://gist.github.com/magic282/94bdbb3b9ddef891d7aa40f0b0069a0f), and found that the parameters are identical, but the result is different after saving and loading.\r\n\r\nAnd I also found this thread https://discuss.pytorch.org/t/saving-and-loading-a-model-in-pytorch/2610/21\r\n\r\nThe code on github gist runs on Windows (peterjc123\u2019s 0.3.0 build). On linux (also 0.3.0 , I built a docker image myself by installing pytorch through conda) it raises an error that I don\u2019t understand why:\r\n\r\n```python\r\nTHCudaCheck FAIL file=/opt/conda/conda-bld/pytorch_1512386481460/work/torch/lib/THC/THCTensorCopy.cu line=204 error=59 : device-side assert triggered\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 120, in <module>\r\n    main()\r\n  File \"test.py\", line 76, in main\r\n    hidden = hidden.transpose(0, 1).contiguous().view(hidden.size(1), -1)\r\n  File \"/opt/conda/envs/pytorch-py3.6/lib/python3.6/site-packages/torch/autograd/variable.py\", line 280, in contiguous\r\n    self.data = self.data.contiguous()\r\nRuntimeError: cuda runtime error (59) : device-side assert triggered at /opt/conda/conda-bld/pytorch_1512386481460/work/torch/lib/THC/THCTensorCopy.cu:204\r\n```\r\n\r\nThe thread I posted https://discuss.pytorch.org/t/parameters-are-different-after-loading-model/11457"}