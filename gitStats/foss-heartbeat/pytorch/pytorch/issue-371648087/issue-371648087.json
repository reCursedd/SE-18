{"url": "https://api.github.com/repos/pytorch/pytorch/issues/12829", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/12829/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/12829/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/12829/events", "html_url": "https://github.com/pytorch/pytorch/issues/12829", "id": 371648087, "node_id": "MDU6SXNzdWUzNzE2NDgwODc=", "number": 12829, "title": "Gloo detection is improperly looking for headers in torch/lib/tmp_install/include", "user": {"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-10-18T18:09:46Z", "updated_at": "2018-10-18T18:54:43Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<h2><g-emoji class=\"g-emoji\" alias=\"bug\" fallback-src=\"https://assets-cdn.github.com/images/icons/emoji/unicode/1f41b.png\">\ud83d\udc1b</g-emoji> Bug</h2>\n<p>Under some circumstances, we search for gloo headers in <code>torch/lib/tmp_install/include</code>, which can lead us to erroneously conclude that Gloo is available, when it is not.</p>\n<h2>To Reproduce</h2>\n<p>Steps to reproduce the behavior:</p>\n<ol start=\"0\">\n<li>Make sure you have ninja installed</li>\n<li><code>python setup.py build_deps develop</code></li>\n<li><code>(cd build &amp;&amp; ninja)</code></li>\n</ol>\n<p>Original cmake logs:</p>\n<pre><code>-- Could NOT find Gloo (missing: Gloo_INCLUDE_DIR Gloo_LIBRARY)\u00b7\n...\n--   USE_DISTRIBUTED       : ON\n--     USE_MPI             : ON\n--     USE_GLOO            : ON\n--     USE_GLOO_IBVERBS    : OFF\n--   Public Dependencies  : Threads::Threads;caffe2::mkl\n--   Private Dependencies : nnpack;cpuinfo;/usr/lib/x86_64-linux-gnu/libnuma.so;fp16;/usr/lib/openmpi/lib/libmpi_cxx.so;/usr/lib/openmpi/lib/libmpi.so;gloo;aten_op_header_gen;onnxifi_loader;rt;gcc_s;gcc;dl\n-- Configuring done\n</code></pre>\n<p>Cmake logs when ninja re-cmakes:</p>\n<pre><code>-- Found Gloo: /scratch/ezyang/pytorch-tmp/torch/lib/tmp_install/include\u00b7\u00b7\n...\n--     USE_GLOO            : ON\n--     USE_GLOO_IBVERBS    : OFF\n--   Public Dependencies  : Threads::Threads;caffe2::mkl\n--   Private Dependencies : nnpack;cpuinfo;/usr/lib/x86_64-linux-gnu/libnuma.so;fp16;/usr/lib/openmpi/lib/libmpi_cxx.so;/usr/lib/openmpi/lib/libmpi.so;gloo;gloo;aten_op_header_gen;onnxifi_loader;rt;gcc_s;gcc;dl\n-- Configuring done\n</code></pre>\n<p>Fails with:</p>\n<pre><code>/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll&lt;long, gloo::CudaHostWorkspace&lt;long&gt; &gt;::CudaBroadcastOneToAll(std::shared_ptr&lt;gloo::Context&gt; const&amp;, std::vector&lt;long*, std::allocator&lt;long*&gt; &gt; const&amp;, int, int, int, std::vector&lt;CUstream_st*, std::allocator&lt;CUstream_st*&gt; &gt; const&amp;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::Context::Context(int, int, int)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll&lt;float, gloo::CudaHostWorkspace&lt;float&gt; &gt;::CudaBroadcastOneToAll(std::shared_ptr&lt;gloo::Context&gt; const&amp;, std::vector&lt;float*, std::allocator&lt;float*&gt; &gt; const&amp;, int, int, int, std::vector&lt;CUstream_st*, std::allocator&lt;CUstream_st*&gt; &gt; const&amp;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::transport::tcp::CreateDevice(gloo::transport::tcp::attr const&amp;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Context::setTimeout(std::chrono::duration&lt;long, std::ratio&lt;1l, 1000l&gt; &gt;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `void gloo::cudaSum&lt;float&gt;(float*, float const*, unsigned long, CUstream_st*)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling&lt;float, gloo::CudaHostWorkspace&lt;float&gt; &gt;::CudaAllreduceHalvingDoubling(std::shared_ptr&lt;gloo::Context&gt; const&amp;, std::vector&lt;float*, std::allocator&lt;float*&gt; &gt; const&amp;, int, std::vector&lt;CUstream_st*, std::allocator&lt;CUstream_st*&gt; &gt; const&amp;, bool)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `vtable for gloo::EnforceNotMet'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::Store::kDefaultTimeout'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll&lt;gloo::float16, gloo::CudaHostWorkspace&lt;gloo::float16&gt; &gt;::CudaBroadcastOneToAll(std::shared_ptr&lt;gloo::Context&gt; const&amp;, std::vector&lt;gloo::float16*, std::allocator&lt;gloo::float16*&gt; &gt; const&amp;, int, int, int, std::vector&lt;CUstream_st*, std::allocator&lt;CUstream_st*&gt; &gt; const&amp;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling&lt;float, gloo::CudaDeviceWorkspace&lt;float&gt; &gt;::CudaAllreduceHalvingDoubling(std::shared_ptr&lt;gloo::Context&gt; const&amp;, std::vector&lt;float*, std::allocator&lt;float*&gt; &gt; const&amp;, int, std::vector&lt;CUstream_st*, std::allocator&lt;CUstream_st*&gt; &gt; const&amp;, bool)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Algorithm::getPair(int)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Context::closeConnections()'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Algorithm::~Algorithm()'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::ContextFactory::ContextFactory(std::shared_ptr&lt;gloo::Context&gt;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::ContextFactory::makeContext(std::shared_ptr&lt;gloo::transport::Device&gt;&amp;)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling&lt;gloo::float16, gloo::CudaDeviceWorkspace&lt;gloo::float16&gt; &gt;::CudaAllreduceHalvingDoubling(std::shared_ptr&lt;gloo::Context&gt; const&amp;, std::vector&lt;gloo::float16*, std::allocator&lt;gloo::float16*&gt; &gt; const&amp;, int, std::vector&lt;CUstream_st*, std::allocator&lt;CUstream_st*&gt; &gt; const&amp;, bool)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::PrefixStore::PrefixStore(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, gloo::rendezvous::Store&amp;)'\ncollect2: error: ld returned 1 exit status\nninja: build stopped: subcommand failed.\n</code></pre>\n<h2>Expected behavior</h2>\n<p>It works.</p>\n<h2>Environment</h2>\n<p>This is on a devfair.</p>", "body_text": "\ud83d\udc1b Bug\nUnder some circumstances, we search for gloo headers in torch/lib/tmp_install/include, which can lead us to erroneously conclude that Gloo is available, when it is not.\nTo Reproduce\nSteps to reproduce the behavior:\n\nMake sure you have ninja installed\npython setup.py build_deps develop\n(cd build && ninja)\n\nOriginal cmake logs:\n-- Could NOT find Gloo (missing: Gloo_INCLUDE_DIR Gloo_LIBRARY)\u00b7\n...\n--   USE_DISTRIBUTED       : ON\n--     USE_MPI             : ON\n--     USE_GLOO            : ON\n--     USE_GLOO_IBVERBS    : OFF\n--   Public Dependencies  : Threads::Threads;caffe2::mkl\n--   Private Dependencies : nnpack;cpuinfo;/usr/lib/x86_64-linux-gnu/libnuma.so;fp16;/usr/lib/openmpi/lib/libmpi_cxx.so;/usr/lib/openmpi/lib/libmpi.so;gloo;aten_op_header_gen;onnxifi_loader;rt;gcc_s;gcc;dl\n-- Configuring done\n\nCmake logs when ninja re-cmakes:\n-- Found Gloo: /scratch/ezyang/pytorch-tmp/torch/lib/tmp_install/include\u00b7\u00b7\n...\n--     USE_GLOO            : ON\n--     USE_GLOO_IBVERBS    : OFF\n--   Public Dependencies  : Threads::Threads;caffe2::mkl\n--   Private Dependencies : nnpack;cpuinfo;/usr/lib/x86_64-linux-gnu/libnuma.so;fp16;/usr/lib/openmpi/lib/libmpi_cxx.so;/usr/lib/openmpi/lib/libmpi.so;gloo;gloo;aten_op_header_gen;onnxifi_loader;rt;gcc_s;gcc;dl\n-- Configuring done\n\nFails with:\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll<long, gloo::CudaHostWorkspace<long> >::CudaBroadcastOneToAll(std::shared_ptr<gloo::Context> const&, std::vector<long*, std::allocator<long*> > const&, int, int, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::Context::Context(int, int, int)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll<float, gloo::CudaHostWorkspace<float> >::CudaBroadcastOneToAll(std::shared_ptr<gloo::Context> const&, std::vector<float*, std::allocator<float*> > const&, int, int, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::transport::tcp::CreateDevice(gloo::transport::tcp::attr const&)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Context::setTimeout(std::chrono::duration<long, std::ratio<1l, 1000l> >)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `void gloo::cudaSum<float>(float*, float const*, unsigned long, CUstream_st*)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling<float, gloo::CudaHostWorkspace<float> >::CudaAllreduceHalvingDoubling(std::shared_ptr<gloo::Context> const&, std::vector<float*, std::allocator<float*> > const&, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&, bool)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `vtable for gloo::EnforceNotMet'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::Store::kDefaultTimeout'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll<gloo::float16, gloo::CudaHostWorkspace<gloo::float16> >::CudaBroadcastOneToAll(std::shared_ptr<gloo::Context> const&, std::vector<gloo::float16*, std::allocator<gloo::float16*> > const&, int, int, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling<float, gloo::CudaDeviceWorkspace<float> >::CudaAllreduceHalvingDoubling(std::shared_ptr<gloo::Context> const&, std::vector<float*, std::allocator<float*> > const&, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&, bool)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Algorithm::getPair(int)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Context::closeConnections()'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Algorithm::~Algorithm()'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::ContextFactory::ContextFactory(std::shared_ptr<gloo::Context>)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::ContextFactory::makeContext(std::shared_ptr<gloo::transport::Device>&)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling<gloo::float16, gloo::CudaDeviceWorkspace<gloo::float16> >::CudaAllreduceHalvingDoubling(std::shared_ptr<gloo::Context> const&, std::vector<gloo::float16*, std::allocator<gloo::float16*> > const&, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&, bool)'\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::PrefixStore::PrefixStore(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&, gloo::rendezvous::Store&)'\ncollect2: error: ld returned 1 exit status\nninja: build stopped: subcommand failed.\n\nExpected behavior\nIt works.\nEnvironment\nThis is on a devfair.", "body": "## \ud83d\udc1b Bug\r\n\r\nUnder some circumstances, we search for gloo headers in `torch/lib/tmp_install/include`, which can lead us to erroneously conclude that Gloo is available, when it is not.\r\n\r\n## To Reproduce\r\n\r\nSteps to reproduce the behavior:\r\n\r\n0. Make sure you have ninja installed\r\n1. `python setup.py build_deps develop`\r\n2. `(cd build && ninja)`\r\n\r\nOriginal cmake logs:\r\n\r\n```\r\n-- Could NOT find Gloo (missing: Gloo_INCLUDE_DIR Gloo_LIBRARY)\u00b7\r\n...\r\n--   USE_DISTRIBUTED       : ON\r\n--     USE_MPI             : ON\r\n--     USE_GLOO            : ON\r\n--     USE_GLOO_IBVERBS    : OFF\r\n--   Public Dependencies  : Threads::Threads;caffe2::mkl\r\n--   Private Dependencies : nnpack;cpuinfo;/usr/lib/x86_64-linux-gnu/libnuma.so;fp16;/usr/lib/openmpi/lib/libmpi_cxx.so;/usr/lib/openmpi/lib/libmpi.so;gloo;aten_op_header_gen;onnxifi_loader;rt;gcc_s;gcc;dl\r\n-- Configuring done\r\n```\r\n\r\nCmake logs when ninja re-cmakes:\r\n\r\n```\r\n-- Found Gloo: /scratch/ezyang/pytorch-tmp/torch/lib/tmp_install/include\u00b7\u00b7\r\n...\r\n--     USE_GLOO            : ON\r\n--     USE_GLOO_IBVERBS    : OFF\r\n--   Public Dependencies  : Threads::Threads;caffe2::mkl\r\n--   Private Dependencies : nnpack;cpuinfo;/usr/lib/x86_64-linux-gnu/libnuma.so;fp16;/usr/lib/openmpi/lib/libmpi_cxx.so;/usr/lib/openmpi/lib/libmpi.so;gloo;gloo;aten_op_header_gen;onnxifi_loader;rt;gcc_s;gcc;dl\r\n-- Configuring done\r\n```\r\n\r\nFails with:\r\n\r\n```\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll<long, gloo::CudaHostWorkspace<long> >::CudaBroadcastOneToAll(std::shared_ptr<gloo::Context> const&, std::vector<long*, std::allocator<long*> > const&, int, int, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::Context::Context(int, int, int)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll<float, gloo::CudaHostWorkspace<float> >::CudaBroadcastOneToAll(std::shared_ptr<gloo::Context> const&, std::vector<float*, std::allocator<float*> > const&, int, int, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::transport::tcp::CreateDevice(gloo::transport::tcp::attr const&)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Context::setTimeout(std::chrono::duration<long, std::ratio<1l, 1000l> >)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `void gloo::cudaSum<float>(float*, float const*, unsigned long, CUstream_st*)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling<float, gloo::CudaHostWorkspace<float> >::CudaAllreduceHalvingDoubling(std::shared_ptr<gloo::Context> const&, std::vector<float*, std::allocator<float*> > const&, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&, bool)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `vtable for gloo::EnforceNotMet'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::Store::kDefaultTimeout'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaBroadcastOneToAll<gloo::float16, gloo::CudaHostWorkspace<gloo::float16> >::CudaBroadcastOneToAll(std::shared_ptr<gloo::Context> const&, std::vector<gloo::float16*, std::allocator<gloo::float16*> > const&, int, int, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling<float, gloo::CudaDeviceWorkspace<float> >::CudaAllreduceHalvingDoubling(std::shared_ptr<gloo::Context> const&, std::vector<float*, std::allocator<float*> > const&, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&, bool)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Algorithm::getPair(int)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Context::closeConnections()'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::Algorithm::~Algorithm()'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::ContextFactory::ContextFactory(std::shared_ptr<gloo::Context>)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::ContextFactory::makeContext(std::shared_ptr<gloo::transport::Device>&)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2_gpu.so: undefined reference to `gloo::CudaAllreduceHalvingDoubling<gloo::float16, gloo::CudaDeviceWorkspace<gloo::float16> >::CudaAllreduceHalvingDoubling(std::shared_ptr<gloo::Context> const&, std::vector<gloo::float16*, std::allocator<gloo::float16*> > const&, int, std::vector<CUstream_st*, std::allocator<CUstream_st*> > const&, bool)'\r\n/scratch/ezyang/pytorch-tmp/build/lib/libcaffe2.so: undefined reference to `gloo::rendezvous::PrefixStore::PrefixStore(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&, gloo::rendezvous::Store&)'\r\ncollect2: error: ld returned 1 exit status\r\nninja: build stopped: subcommand failed.\r\n```\r\n\r\n## Expected behavior\r\n\r\nIt works.\r\n\r\n## Environment\r\n\r\nThis is on a devfair."}