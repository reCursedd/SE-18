{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/181512008", "pull_request_review_id": 112157105, "id": 181512008, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MTUxMjAwOA==", "diff_hunk": "@@ -64,150 +64,254 @@ string FormatDoc() {\n   return doc;\n }\n \n+// Helper function to enforce naming conventions at compile time.\n+constexpr bool equal(\n+    char const* lhs,\n+    char const* rhs1,\n+    char const* rhs2,\n+    char const* rhs3 = \"\") {\n+  return (*lhs == 0 && *rhs1 == 0 && *rhs2 == 0 && *rhs3 == 0) ||\n+      (*rhs1 != 0 && *lhs == *rhs1 && equal(lhs + 1, rhs1 + 1, rhs2, rhs3)) ||\n+      (*rhs1 == 0 && *rhs2 != 0 && *lhs == *rhs2 &&\n+       equal(lhs + 1, rhs1, rhs2 + 1, rhs3)) ||\n+      (*rhs1 == 0 && *rhs2 == 0 && *rhs3 != 0 && *lhs == *rhs3 &&\n+       equal(lhs + 1, rhs1, rhs2, rhs3 + 1));\n+}\n+\n // Helper macro when the main op is defined elsewhere, and we only need to\n // define the schema, and the gradient op.\n-#define REGISTER_SEGMENT_DEF_SCHEMA_GRADIENT_ONLY(...)                         \\\n-  OPERATOR_SCHEMA_STR(                                                         \\\n-      string(__VA_ARGS__::basename) + (__VA_ARGS__::OpDef::name))              \\\n-      .NumInputs(__VA_ARGS__::ForwardOp::kNumInputs)                           \\\n-      .NumOutputs(1)                                                           \\\n-      .SetDoc(FormatDoc<__VA_ARGS__>())                                        \\\n-      .Output(0, \"OUTPUT\", \"Aggregated tensor\")                                \\\n-      .FillUsing(__VA_ARGS__::PopulateSchema);                                 \\\n-  REGISTER_CPU_OPERATOR_STR(                                                   \\\n-      string(__VA_ARGS__::basename) + (__VA_ARGS__::OpDef::name) + \"Gradient\", \\\n-      __VA_ARGS__::BackwardOp);                                                \\\n-  OPERATOR_SCHEMA_STR(                                                         \\\n-      string(__VA_ARGS__::basename) + (__VA_ARGS__::OpDef::name) + \"Gradient\") \\\n-      .NumInputs(__VA_ARGS__::BackwardOp::kNumInputs)                          \\\n-      .NumOutputs(1);                                                          \\\n-  REGISTER_GRADIENT_STR(                                                       \\\n-      string(__VA_ARGS__::basename) + (__VA_ARGS__::OpDef::name),              \\\n-      __VA_ARGS__::GetGradient)\n-\n-#define REGISTER_SEGMENT_DEF(...)                                 \\\n-  REGISTER_CPU_OPERATOR_STR(                                      \\\n-      string(__VA_ARGS__::basename) + (__VA_ARGS__::OpDef::name), \\\n-      __VA_ARGS__::ForwardOp);                                    \\\n-  REGISTER_SEGMENT_DEF_SCHEMA_GRADIENT_ONLY(__VA_ARGS__)\n+#define REGISTER_SEGMENT_DEF_SCHEMA_GRADIENT_ONLY(                           \\\n+    segment_name, gradient_name, ...)                                        \\\n+  static_assert(                                                             \\\n+      equal(segment_name, __VA_ARGS__::basename, __VA_ARGS__::OpDef::name),  \\\n+      segment_name);                                                         \\\n+  static_assert(                                                             \\\n+      equal(                                                                 \\\n+          gradient_name,                                                     \\\n+          __VA_ARGS__::basename,                                             \\\n+          __VA_ARGS__::OpDef::name,                                          \\\n+          \"Gradient\"),                                                       \\\n+      gradient_name);                                                        \\\n+  OPERATOR_SCHEMA_STR(string(segment_name))                                  \\", "path": "caffe2/operators/segment_reduction_op.cc", "position": null, "original_position": 56, "commit_id": "89eae9ad0a3f25303def951716595b047358fe2a", "original_commit_id": "6298889dbebfb58a0bfb0f20047aa8d84f325535", "user": {"login": "dzhulgakov", "id": 17890620, "node_id": "MDQ6VXNlcjE3ODkwNjIw", "avatar_url": "https://avatars2.githubusercontent.com/u/17890620?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dzhulgakov", "html_url": "https://github.com/dzhulgakov", "followers_url": "https://api.github.com/users/dzhulgakov/followers", "following_url": "https://api.github.com/users/dzhulgakov/following{/other_user}", "gists_url": "https://api.github.com/users/dzhulgakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/dzhulgakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dzhulgakov/subscriptions", "organizations_url": "https://api.github.com/users/dzhulgakov/orgs", "repos_url": "https://api.github.com/users/dzhulgakov/repos", "events_url": "https://api.github.com/users/dzhulgakov/events{/privacy}", "received_events_url": "https://api.github.com/users/dzhulgakov/received_events", "type": "User", "site_admin": false}, "body": "`OPERATOR_SCHEMA_STR(string(segment_name)) -> OPERATOR_SCHEMA(segment_name)`\r\n\r\nCan you also remove OPERATOR_SCHEMA_STR macro for better please? It's not used any more: https://sourcegraph.com/github.com/pytorch/pytorch/-/blob/caffe2/core/operator_schema.h", "created_at": "2018-04-13T21:16:01Z", "updated_at": "2018-11-23T15:42:26Z", "html_url": "https://github.com/pytorch/pytorch/pull/6513#discussion_r181512008", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/6513", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/181512008"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/6513#discussion_r181512008"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/6513"}}, "body_html": "<p><code>OPERATOR_SCHEMA_STR(string(segment_name)) -&gt; OPERATOR_SCHEMA(segment_name)</code></p>\n<p>Can you also remove OPERATOR_SCHEMA_STR macro for better please? It's not used any more: <a href=\"https://sourcegraph.com/github.com/pytorch/pytorch/-/blob/caffe2/core/operator_schema.h\" rel=\"nofollow\">https://sourcegraph.com/github.com/pytorch/pytorch/-/blob/caffe2/core/operator_schema.h</a></p>", "body_text": "OPERATOR_SCHEMA_STR(string(segment_name)) -> OPERATOR_SCHEMA(segment_name)\nCan you also remove OPERATOR_SCHEMA_STR macro for better please? It's not used any more: https://sourcegraph.com/github.com/pytorch/pytorch/-/blob/caffe2/core/operator_schema.h"}