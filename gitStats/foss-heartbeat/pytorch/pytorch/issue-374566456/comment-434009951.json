{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/434009951", "html_url": "https://github.com/pytorch/pytorch/pull/13191#issuecomment-434009951", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/13191", "id": 434009951, "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDAwOTk1MQ==", "user": {"login": "t-vi", "id": 20787943, "node_id": "MDQ6VXNlcjIwNzg3OTQz", "avatar_url": "https://avatars2.githubusercontent.com/u/20787943?v=4", "gravatar_id": "", "url": "https://api.github.com/users/t-vi", "html_url": "https://github.com/t-vi", "followers_url": "https://api.github.com/users/t-vi/followers", "following_url": "https://api.github.com/users/t-vi/following{/other_user}", "gists_url": "https://api.github.com/users/t-vi/gists{/gist_id}", "starred_url": "https://api.github.com/users/t-vi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/t-vi/subscriptions", "organizations_url": "https://api.github.com/users/t-vi/orgs", "repos_url": "https://api.github.com/users/t-vi/repos", "events_url": "https://api.github.com/users/t-vi/events{/privacy}", "received_events_url": "https://api.github.com/users/t-vi/received_events", "type": "User", "site_admin": false}, "created_at": "2018-10-29T17:46:31Z", "updated_at": "2018-10-29T17:46:31Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Thank you for this! I can reproduce the error. Whyever it seemed a good idea at the time, not using sum inside parallel_for seems to fix the problem:</p>\n<pre><code>diff --git a/aten/src/ATen/native/Normalization.cpp b/aten/src/ATen/native/Normalization.cpp\nindex ca5f4ae..1774ec6 100644\n--- a/aten/src/ATen/native/Normalization.cpp\n+++ b/aten/src/ATen/native/Normalization.cpp\n@@ -69,9 +69,12 @@ std::tuple&lt;Tensor,Tensor,Tensor&gt; batch_norm_cpu_template(const Tensor&amp; input, co\n \n \tif (train) {\n \t  // compute mean per input\n-\t  accscalar_t sum = in.sum()._local_scalar().to&lt;accscalar_t&gt;(); // accumulation dtype ?\n+\t  accscalar_t sum = 0;\n+\t  CPU_tensor_apply1&lt;scalar_t&gt;(in, [&amp;] (const scalar_t&amp; i) {\n+\t      sum += i;\n+\t    });\n \n-\t  mean = (scalar_t) sum / n;\n+\t  mean = (scalar_t) (sum / n);\n \t  save_mean_a[f] = mean;\n \n \t  // compute variance per input\n</code></pre>\n<p>If it does for you, too, I'd have another go at the PR.</p>", "body_text": "Thank you for this! I can reproduce the error. Whyever it seemed a good idea at the time, not using sum inside parallel_for seems to fix the problem:\ndiff --git a/aten/src/ATen/native/Normalization.cpp b/aten/src/ATen/native/Normalization.cpp\nindex ca5f4ae..1774ec6 100644\n--- a/aten/src/ATen/native/Normalization.cpp\n+++ b/aten/src/ATen/native/Normalization.cpp\n@@ -69,9 +69,12 @@ std::tuple<Tensor,Tensor,Tensor> batch_norm_cpu_template(const Tensor& input, co\n \n \tif (train) {\n \t  // compute mean per input\n-\t  accscalar_t sum = in.sum()._local_scalar().to<accscalar_t>(); // accumulation dtype ?\n+\t  accscalar_t sum = 0;\n+\t  CPU_tensor_apply1<scalar_t>(in, [&] (const scalar_t& i) {\n+\t      sum += i;\n+\t    });\n \n-\t  mean = (scalar_t) sum / n;\n+\t  mean = (scalar_t) (sum / n);\n \t  save_mean_a[f] = mean;\n \n \t  // compute variance per input\n\nIf it does for you, too, I'd have another go at the PR.", "body": "Thank you for this! I can reproduce the error. Whyever it seemed a good idea at the time, not using sum inside parallel_for seems to fix the problem:\r\n```\r\ndiff --git a/aten/src/ATen/native/Normalization.cpp b/aten/src/ATen/native/Normalization.cpp\r\nindex ca5f4ae..1774ec6 100644\r\n--- a/aten/src/ATen/native/Normalization.cpp\r\n+++ b/aten/src/ATen/native/Normalization.cpp\r\n@@ -69,9 +69,12 @@ std::tuple<Tensor,Tensor,Tensor> batch_norm_cpu_template(const Tensor& input, co\r\n \r\n \tif (train) {\r\n \t  // compute mean per input\r\n-\t  accscalar_t sum = in.sum()._local_scalar().to<accscalar_t>(); // accumulation dtype ?\r\n+\t  accscalar_t sum = 0;\r\n+\t  CPU_tensor_apply1<scalar_t>(in, [&] (const scalar_t& i) {\r\n+\t      sum += i;\r\n+\t    });\r\n \r\n-\t  mean = (scalar_t) sum / n;\r\n+\t  mean = (scalar_t) (sum / n);\r\n \t  save_mean_a[f] = mean;\r\n \r\n \t  // compute variance per input\r\n```\r\nIf it does for you, too, I'd have another go at the PR."}