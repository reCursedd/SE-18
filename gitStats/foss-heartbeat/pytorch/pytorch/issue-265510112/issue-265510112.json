{"url": "https://api.github.com/repos/pytorch/pytorch/issues/3120", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/3120/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/3120/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/3120/events", "html_url": "https://github.com/pytorch/pytorch/pull/3120", "id": 265510112, "node_id": "MDExOlB1bGxSZXF1ZXN0MTQ2NjEzNDc0", "number": 3120, "title": "Fix nvprof mode in autograd profiler", "user": {"login": "apaszke", "id": 4583066, "node_id": "MDQ6VXNlcjQ1ODMwNjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/4583066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apaszke", "html_url": "https://github.com/apaszke", "followers_url": "https://api.github.com/users/apaszke/followers", "following_url": "https://api.github.com/users/apaszke/following{/other_user}", "gists_url": "https://api.github.com/users/apaszke/gists{/gist_id}", "starred_url": "https://api.github.com/users/apaszke/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apaszke/subscriptions", "organizations_url": "https://api.github.com/users/apaszke/orgs", "repos_url": "https://api.github.com/users/apaszke/repos", "events_url": "https://api.github.com/users/apaszke/events{/privacy}", "received_events_url": "https://api.github.com/users/apaszke/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-10-14T17:48:33Z", "updated_at": "2018-11-23T15:35:23Z", "closed_at": "2017-10-20T14:22:55Z", "author_association": "MEMBER", "pull_request": {"url": "https://api.github.com/repos/pytorch/pytorch/pulls/3120", "html_url": "https://github.com/pytorch/pytorch/pull/3120", "diff_url": "https://github.com/pytorch/pytorch/pull/3120.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/3120.patch"}, "body_html": "<p>I realized that the <code>use_nvprof</code> mode of autograd profiler can't be implemented to return summary in the profiled process, because there's no way to force nvprof to flush data to disk. Instead, the trace has to be loaded offline using <code>torch.autograd.profiler.load_nvprof(path)</code>.</p>\n<hr>\n<p>Tested by running this script:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> torch\n<span class=\"pl-k\">from</span> torch.autograd <span class=\"pl-k\">import</span> Variable\n<span class=\"pl-k\">from</span> torchvision <span class=\"pl-k\">import</span> models\n\nx <span class=\"pl-k\">=</span> Variable(torch.randn(<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">224</span>, <span class=\"pl-c1\">224</span>).cuda())\nmodel <span class=\"pl-k\">=</span> models.resnet18()\nmodel.cuda()\n\n<span class=\"pl-k\">with</span> torch.cuda.profiler.profile():\n    model(x) <span class=\"pl-c\"><span class=\"pl-c\">#</span> Run once, to pre-allocate memory, and initialize CUDA profiler</span>\n    <span class=\"pl-k\">with</span> torch.autograd.profiler.emit_nvtx() <span class=\"pl-k\">as</span> p:\n        model(x)</pre></div>\n<p>with this command:</p>\n<pre><code>nvprof --profile-from-start off -f -o out.prof python3 tmp.py\n</code></pre>\n<p>and checked that</p>\n<pre><code>ipython3 -c \"torch.autograd.profiler.open_nvprof('out.prof')\" | head\n</code></pre>\n<p>prints</p>\n<pre><code>[&lt;FunctionEvent id=2 cpu_time=108.569us cuda_time=269.342us name=ConvForward&gt;,                       \n &lt;FunctionEvent id=3 cpu_time=43.092us cuda_time=331.935us name=N5torch8autograd16BatchNormForwardE&gt;,\n &lt;FunctionEvent id=4 cpu_time=77.851us cuda_time=47.744us name=Threshold&gt;,                           \n &lt;FunctionEvent id=5 cpu_time=125.062us cuda_time=124.159us name=MaxPool2d&gt;,                         \n &lt;FunctionEvent id=6 cpu_time=52.249us cuda_time=147.103us name=ConvForward&gt;,                        \n &lt;FunctionEvent id=7 cpu_time=35.582us cuda_time=98.656us name=N5torch8autograd16BatchNormForwardE&gt;, \n &lt;FunctionEvent id=8 cpu_time=46.830us cuda_time=14.752us name=Threshold&gt;,                           \n &lt;FunctionEvent id=9 cpu_time=44.941us cuda_time=138.559us name=ConvForward&gt;,                        \n &lt;FunctionEvent id=10 cpu_time=33.857us cuda_time=98.112us name=N5torch8autograd16BatchNormForwardE&gt;,\n</code></pre>", "body_text": "I realized that the use_nvprof mode of autograd profiler can't be implemented to return summary in the profiled process, because there's no way to force nvprof to flush data to disk. Instead, the trace has to be loaded offline using torch.autograd.profiler.load_nvprof(path).\n\nTested by running this script:\nimport torch\nfrom torch.autograd import Variable\nfrom torchvision import models\n\nx = Variable(torch.randn(1, 3, 224, 224).cuda())\nmodel = models.resnet18()\nmodel.cuda()\n\nwith torch.cuda.profiler.profile():\n    model(x) # Run once, to pre-allocate memory, and initialize CUDA profiler\n    with torch.autograd.profiler.emit_nvtx() as p:\n        model(x)\nwith this command:\nnvprof --profile-from-start off -f -o out.prof python3 tmp.py\n\nand checked that\nipython3 -c \"torch.autograd.profiler.open_nvprof('out.prof')\" | head\n\nprints\n[<FunctionEvent id=2 cpu_time=108.569us cuda_time=269.342us name=ConvForward>,                       \n <FunctionEvent id=3 cpu_time=43.092us cuda_time=331.935us name=N5torch8autograd16BatchNormForwardE>,\n <FunctionEvent id=4 cpu_time=77.851us cuda_time=47.744us name=Threshold>,                           \n <FunctionEvent id=5 cpu_time=125.062us cuda_time=124.159us name=MaxPool2d>,                         \n <FunctionEvent id=6 cpu_time=52.249us cuda_time=147.103us name=ConvForward>,                        \n <FunctionEvent id=7 cpu_time=35.582us cuda_time=98.656us name=N5torch8autograd16BatchNormForwardE>, \n <FunctionEvent id=8 cpu_time=46.830us cuda_time=14.752us name=Threshold>,                           \n <FunctionEvent id=9 cpu_time=44.941us cuda_time=138.559us name=ConvForward>,                        \n <FunctionEvent id=10 cpu_time=33.857us cuda_time=98.112us name=N5torch8autograd16BatchNormForwardE>,", "body": "I realized that the `use_nvprof` mode of autograd profiler can't be implemented to return summary in the profiled process, because there's no way to force nvprof to flush data to disk. Instead, the trace has to be loaded offline using `torch.autograd.profiler.load_nvprof(path)`.\r\n\r\n---\r\n\r\nTested by running this script:\r\n```python\r\nimport torch\r\nfrom torch.autograd import Variable\r\nfrom torchvision import models\r\n\r\nx = Variable(torch.randn(1, 3, 224, 224).cuda())\r\nmodel = models.resnet18()\r\nmodel.cuda()\r\n\r\nwith torch.cuda.profiler.profile():\r\n    model(x) # Run once, to pre-allocate memory, and initialize CUDA profiler\r\n    with torch.autograd.profiler.emit_nvtx() as p:\r\n        model(x)\r\n```\r\nwith this command:\r\n```\r\nnvprof --profile-from-start off -f -o out.prof python3 tmp.py\r\n```\r\n\r\nand checked that\r\n```\r\nipython3 -c \"torch.autograd.profiler.open_nvprof('out.prof')\" | head\r\n```\r\nprints\r\n```\r\n[<FunctionEvent id=2 cpu_time=108.569us cuda_time=269.342us name=ConvForward>,                       \r\n <FunctionEvent id=3 cpu_time=43.092us cuda_time=331.935us name=N5torch8autograd16BatchNormForwardE>,\r\n <FunctionEvent id=4 cpu_time=77.851us cuda_time=47.744us name=Threshold>,                           \r\n <FunctionEvent id=5 cpu_time=125.062us cuda_time=124.159us name=MaxPool2d>,                         \r\n <FunctionEvent id=6 cpu_time=52.249us cuda_time=147.103us name=ConvForward>,                        \r\n <FunctionEvent id=7 cpu_time=35.582us cuda_time=98.656us name=N5torch8autograd16BatchNormForwardE>, \r\n <FunctionEvent id=8 cpu_time=46.830us cuda_time=14.752us name=Threshold>,                           \r\n <FunctionEvent id=9 cpu_time=44.941us cuda_time=138.559us name=ConvForward>,                        \r\n <FunctionEvent id=10 cpu_time=33.857us cuda_time=98.112us name=N5torch8autograd16BatchNormForwardE>,\r\n```"}