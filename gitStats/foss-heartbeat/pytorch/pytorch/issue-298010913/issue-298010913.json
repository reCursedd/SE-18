{"url": "https://api.github.com/repos/pytorch/pytorch/issues/5286", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/5286/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/5286/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/5286/events", "html_url": "https://github.com/pytorch/pytorch/issues/5286", "id": 298010913, "node_id": "MDU6SXNzdWUyOTgwMTA5MTM=", "number": 5286, "title": "[Bug] Model restoration on non cuda computer", "user": {"login": "EKami", "id": 4030626, "node_id": "MDQ6VXNlcjQwMzA2MjY=", "avatar_url": "https://avatars1.githubusercontent.com/u/4030626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EKami", "html_url": "https://github.com/EKami", "followers_url": "https://api.github.com/users/EKami/followers", "following_url": "https://api.github.com/users/EKami/following{/other_user}", "gists_url": "https://api.github.com/users/EKami/gists{/gist_id}", "starred_url": "https://api.github.com/users/EKami/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EKami/subscriptions", "organizations_url": "https://api.github.com/users/EKami/orgs", "repos_url": "https://api.github.com/users/EKami/repos", "events_url": "https://api.github.com/users/EKami/events{/privacy}", "received_events_url": "https://api.github.com/users/EKami/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-02-17T15:03:52Z", "updated_at": "2018-07-16T16:51:31Z", "closed_at": "2018-02-17T19:48:06Z", "author_association": "NONE", "body_html": "<ul>\n<li>OS: macOS 10.13.3</li>\n<li>PyTorch version: 0.3.1</li>\n<li>How you installed PyTorch (conda, pip, source): pip</li>\n<li>Python version: 3.6.4</li>\n<li>CUDA/cuDNN version: NA</li>\n<li>GPU models and configuration: NA</li>\n</ul>\n<p>Hello,<br>\nI'm trying to restore a trained model with:</p>\n<pre><code>model.load_state_dict(torch.load(file))\n</code></pre>\n<p>But I'm getting a:</p>\n<pre><code>Traceback (most recent call last):\n  File \"srgan.py\", line 160, in &lt;module&gt;\n    main()\n  File \"srgan.py\", line 154, in main\n    evaluate(args)\n  File \"srgan.py\", line 75, in evaluate\n    ModelSaverCallback.restore_model([netG], saved_model_dir.absolute())\n  File \"/Users/Ekami/workspace/Torchlight/examples/torchlight/nn/train_callbacks.py\", line 269, in restore_model\n    model.load_state_dict(torch.load(file))\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 267, in load\n    return _load(f, map_location, pickle_module)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 420, in _load\n    result = unpickler.load()\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 389, in persistent_load\n    data_type(size), location)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 87, in default_restore_location\n    result = fn(storage, location)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 69, in _cuda_deserialize\n    return obj.cuda(device)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/_utils.py\", line 61, in _cuda\n    with torch.cuda.device(device):\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/cuda/__init__.py\", line 207, in __enter__\n    self.prev_idx = torch._C._cuda_getDevice()\nAttributeError: module 'torch._C' has no attribute '_cuda_getDevice'\n</code></pre>\n<p>The model was trained on a cuda device but it shouldn't be an issue to restore it from a non-cuda device right? It seems to be an internal error where <code>_cuda_getDevice</code> is called but it shouldn't. The error is very easily reproductible as my code is <a href=\"https://github.com/EKami/Torchlight/tree/showcase/memory-leak\">here</a>. All you have to do is to clone it with: <code>git clone -b showcase/memory-leak git@github.com:EKami/Torchlight.git</code>, cd into the <code>examples</code> folder and run the script on a non-cuda computer with <code>python srgan.py eval --on_cpu</code>. You should get the error immediately.</p>", "body_text": "OS: macOS 10.13.3\nPyTorch version: 0.3.1\nHow you installed PyTorch (conda, pip, source): pip\nPython version: 3.6.4\nCUDA/cuDNN version: NA\nGPU models and configuration: NA\n\nHello,\nI'm trying to restore a trained model with:\nmodel.load_state_dict(torch.load(file))\n\nBut I'm getting a:\nTraceback (most recent call last):\n  File \"srgan.py\", line 160, in <module>\n    main()\n  File \"srgan.py\", line 154, in main\n    evaluate(args)\n  File \"srgan.py\", line 75, in evaluate\n    ModelSaverCallback.restore_model([netG], saved_model_dir.absolute())\n  File \"/Users/Ekami/workspace/Torchlight/examples/torchlight/nn/train_callbacks.py\", line 269, in restore_model\n    model.load_state_dict(torch.load(file))\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 267, in load\n    return _load(f, map_location, pickle_module)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 420, in _load\n    result = unpickler.load()\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 389, in persistent_load\n    data_type(size), location)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 87, in default_restore_location\n    result = fn(storage, location)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 69, in _cuda_deserialize\n    return obj.cuda(device)\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/_utils.py\", line 61, in _cuda\n    with torch.cuda.device(device):\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/cuda/__init__.py\", line 207, in __enter__\n    self.prev_idx = torch._C._cuda_getDevice()\nAttributeError: module 'torch._C' has no attribute '_cuda_getDevice'\n\nThe model was trained on a cuda device but it shouldn't be an issue to restore it from a non-cuda device right? It seems to be an internal error where _cuda_getDevice is called but it shouldn't. The error is very easily reproductible as my code is here. All you have to do is to clone it with: git clone -b showcase/memory-leak git@github.com:EKami/Torchlight.git, cd into the examples folder and run the script on a non-cuda computer with python srgan.py eval --on_cpu. You should get the error immediately.", "body": "- OS: macOS 10.13.3\r\n- PyTorch version: 0.3.1\r\n- How you installed PyTorch (conda, pip, source): pip\r\n- Python version: 3.6.4\r\n- CUDA/cuDNN version: NA\r\n- GPU models and configuration: NA\r\n\r\nHello,\r\nI'm trying to restore a trained model with:\r\n```\r\nmodel.load_state_dict(torch.load(file))\r\n```\r\n\r\nBut I'm getting a:\r\n```\r\nTraceback (most recent call last):\r\n  File \"srgan.py\", line 160, in <module>\r\n    main()\r\n  File \"srgan.py\", line 154, in main\r\n    evaluate(args)\r\n  File \"srgan.py\", line 75, in evaluate\r\n    ModelSaverCallback.restore_model([netG], saved_model_dir.absolute())\r\n  File \"/Users/Ekami/workspace/Torchlight/examples/torchlight/nn/train_callbacks.py\", line 269, in restore_model\r\n    model.load_state_dict(torch.load(file))\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 267, in load\r\n    return _load(f, map_location, pickle_module)\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 420, in _load\r\n    result = unpickler.load()\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 389, in persistent_load\r\n    data_type(size), location)\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 87, in default_restore_location\r\n    result = fn(storage, location)\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/serialization.py\", line 69, in _cuda_deserialize\r\n    return obj.cuda(device)\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/_utils.py\", line 61, in _cuda\r\n    with torch.cuda.device(device):\r\n  File \"/Users/Ekami/Programs/anaconda/envs/dl/lib/python3.6/site-packages/torch/cuda/__init__.py\", line 207, in __enter__\r\n    self.prev_idx = torch._C._cuda_getDevice()\r\nAttributeError: module 'torch._C' has no attribute '_cuda_getDevice'\r\n```\r\nThe model was trained on a cuda device but it shouldn't be an issue to restore it from a non-cuda device right? It seems to be an internal error where `_cuda_getDevice` is called but it shouldn't. The error is very easily reproductible as my code is [here](https://github.com/EKami/Torchlight/tree/showcase/memory-leak). All you have to do is to clone it with: `git clone -b showcase/memory-leak git@github.com:EKami/Torchlight.git`, cd into the `examples` folder and run the script on a non-cuda computer with `python srgan.py eval --on_cpu`. You should get the error immediately.\r\n\r\n"}