{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/159088163", "pull_request_review_id": 85991943, "id": 159088163, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1OTA4ODE2Mw==", "diff_hunk": "@@ -522,6 +530,63 @@ def test_gamma_sample_grad(self):\n                                        'rel error {}'.format(rel_error),\n                                        'max error {}'.format(rel_error.max())]))\n \n+    # This is a randomized test.\n+    @unittest.skipIf(not TEST_NUMPY, \"Numpy not found\")\n+    def test_chi2_shape(self):\n+        df = Variable(torch.exp(torch.randn(2, 3)), requires_grad=True)\n+        df_1d = Variable(torch.exp(torch.randn(1)), requires_grad=True)\n+        self.assertEqual(Chi2(df).sample().size(), (2, 3))\n+        self.assertEqual(Chi2(df).sample_n(5).size(), (5, 2, 3))\n+        self.assertEqual(Chi2(df_1d).sample_n(1).size(), (1, 1))\n+        self.assertEqual(Chi2(df_1d).sample().size(), (1,))\n+        self.assertEqual(Chi2(0.5).sample().size(), (1,))\n+        self.assertEqual(Chi2(0.5).sample_n(1).size(), (1,))\n+\n+        def ref_log_prob(idx, x, log_prob):\n+            d = df.data.view(-1)[idx]\n+            expected = scipy.stats.chi2.logpdf(x, d)\n+            self.assertAlmostEqual(log_prob, expected, places=3)\n+\n+        self._check_log_prob(Chi2(df), ref_log_prob)\n+\n+    # This is a randomized test.\n+    @unittest.skipIf(not TEST_NUMPY, \"Numpy not found\")\n+    def test_chi2_sample(self):\n+        set_rng_seed(0)\n+        for df in [0.1, 1.0, 5.0]:\n+            self._check_sampler_sampler(Chi2(df),\n+                                        scipy.stats.chi2(df),\n+                                        'Chi2(df={})'.format(df))\n+\n+        # This is a randomized test.\n+    @unittest.skipIf(not TEST_NUMPY, \"Numpy not found\")\n+    def test_chi2_sample_grad(self):\n+        set_rng_seed(1)\n+        num_samples = 100\n+        for df in [1e-3, 1e-1, 1e0, 1e1, 1e2, 1e3, 1e4]:\n+            # NOTE: for some reason test fails for df = 1e-2", "path": "test/test_distributions.py", "position": 62, "original_position": 62, "commit_id": "dfc3ab220d3b89793bd656ae9c58bc8aeb875901", "original_commit_id": "e90d721100acb8391202b02ca89f93ed5ff08822", "user": {"login": "fritzo", "id": 648532, "node_id": "MDQ6VXNlcjY0ODUzMg==", "avatar_url": "https://avatars0.githubusercontent.com/u/648532?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fritzo", "html_url": "https://github.com/fritzo", "followers_url": "https://api.github.com/users/fritzo/followers", "following_url": "https://api.github.com/users/fritzo/following{/other_user}", "gists_url": "https://api.github.com/users/fritzo/gists{/gist_id}", "starred_url": "https://api.github.com/users/fritzo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fritzo/subscriptions", "organizations_url": "https://api.github.com/users/fritzo/orgs", "repos_url": "https://api.github.com/users/fritzo/repos", "events_url": "https://api.github.com/users/fritzo/events{/privacy}", "received_events_url": "https://api.github.com/users/fritzo/received_events", "type": "User", "site_admin": false}, "body": "I suspect this is due to underflow in the underlying `Gamma` sampler: when `alpha<=0.01` lots of mass ends up at zero (or near zero #4262). I'm even surprised the 1e-3 case passes. For example [these plots](https://github.com/fritzo/notebooks/blob/master/debug-gamma-sampler.ipynb) show the difference between the double-precision scipy sampler and single-precision `torch.distributions.Gamma` sampler. Maybe this test will pass if you use `DoubleTensor` instead of `FloatTensor`?\r\n\r\nI doubt this numerical instability it's an issue in practice since `Chi2` is usually created with `df >= 1` (at least in my experience).", "created_at": "2017-12-29T18:02:38Z", "updated_at": "2018-11-23T15:37:42Z", "html_url": "https://github.com/pytorch/pytorch/pull/4346#discussion_r159088163", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/4346", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/159088163"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/4346#discussion_r159088163"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/4346"}}, "body_html": "<p>I suspect this is due to underflow in the underlying <code>Gamma</code> sampler: when <code>alpha&lt;=0.01</code> lots of mass ends up at zero (or near zero <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"283411157\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/4262\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/4262/hovercard\" href=\"https://github.com/pytorch/pytorch/pull/4262\">#4262</a>). I'm even surprised the 1e-3 case passes. For example <a href=\"https://github.com/fritzo/notebooks/blob/master/debug-gamma-sampler.ipynb\">these plots</a> show the difference between the double-precision scipy sampler and single-precision <code>torch.distributions.Gamma</code> sampler. Maybe this test will pass if you use <code>DoubleTensor</code> instead of <code>FloatTensor</code>?</p>\n<p>I doubt this numerical instability it's an issue in practice since <code>Chi2</code> is usually created with <code>df &gt;= 1</code> (at least in my experience).</p>", "body_text": "I suspect this is due to underflow in the underlying Gamma sampler: when alpha<=0.01 lots of mass ends up at zero (or near zero #4262). I'm even surprised the 1e-3 case passes. For example these plots show the difference between the double-precision scipy sampler and single-precision torch.distributions.Gamma sampler. Maybe this test will pass if you use DoubleTensor instead of FloatTensor?\nI doubt this numerical instability it's an issue in practice since Chi2 is usually created with df >= 1 (at least in my experience).", "in_reply_to_id": 159044168}