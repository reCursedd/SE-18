{"url": "https://api.github.com/repos/pytorch/pytorch/issues/9784", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/9784/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/9784/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/9784/events", "html_url": "https://github.com/pytorch/pytorch/issues/9784", "id": 344187342, "node_id": "MDU6SXNzdWUzNDQxODczNDI=", "number": 9784, "title": "globalContext() deadlock if Context is not initialized before libtorch (variable hooks) is loaded", "user": {"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-07-24T20:15:44Z", "updated_at": "2018-08-04T01:26:34Z", "closed_at": "2018-08-04T01:26:34Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Steps to reproduce:</p>\n<ol>\n<li>Write a patch that eliminates <code>globalContext()</code> initialization from the static initializers of <code>libcaffe2.so</code>. Here is one sample branch: <a href=\"https://github.com/ezyang/pytorch/tree/issue/deadlocks\">https://github.com/ezyang/pytorch/tree/issue/deadlocks</a></li>\n<li>Build and run</li>\n</ol>\n<p>It deadlocks in the following trace:</p>\n<pre><code>#0  0x00007ffff78eaec9 in syscall () from /lib64/libc.so.6\n#1  0x00007fffcbf4c57e in __cxxabiv1::__cxa_guard_acquire (g=0x7fffdf70fb08 &lt;guard variable for at::globalContext()::globalContext_&gt;) at /opt/conda/conda-bld/comp\nilers_linux-64_1520532893746/work/.build/src/gcc-7.2.0/libstdc++-v3/libsupc++/guard.cc:307\n#2  0x00007fffddd812d0 in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#3  0x00007fffccef089b in torch::autograd::register_variable_type_for (baseType=0x5555566f78b0) at ../torch/csrc/autograd/generated/VariableType.cpp:171\n#4  0x00007fffcce46588 in torch::autograd::VariableHooks::registerVariableTypeFor (this=0x5555566f7920, context=0x7fffdf70fb20 &lt;at::globalContext()::globalContext\n_&gt;, backend=at::Backend::CPU, scalar_type=at::ScalarType::Byte) at ../torch/csrc/autograd/aten_variable_hooks.cpp:21\n#5  0x00007fffddfb3e43 in at::Type::registerCPU (context=0x7fffdf70fb20 &lt;at::globalContext()::globalContext_&gt;) at aten/src/ATen/Type.cpp:40\n#6  0x00007fffddd8120f in at::Context::Context (this=0x7fffdf70fb20 &lt;at::globalContext()::globalContext_&gt;) at ../aten/src/ATen/Context.cpp:37\n#7  0x00007fffddd812eb in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#8  0x00007fffcd04c2f5 in torch::autograd::VariableTypeRegistry::VariableTypeRegistry (this=0x7fffcdce60e8 &lt;torch::autograd::registry&gt;) at ../torch/csrc/autograd/\ngenerated/VariableType.cpp:176\n#9  0x00007fffcd0491ef in __static_initialization_and_destruction_0 (__initialize_p=1, __priority=65535) at ../torch/csrc/autograd/generated/VariableType.cpp:188\n#10 0x00007fffcd049225 in _GLOBAL__sub_I_VariableType.cpp(void) () at ../torch/csrc/autograd/generated/VariableType.cpp:31075\n#11 0x00007ffff7deab03 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2\n(More stack frames follow...)\n(gdb) bt\n#0  0x00007ffff78eaec9 in syscall () from /lib64/libc.so.6\n#1  0x00007fffcbf4c57e in __cxxabiv1::__cxa_guard_acquire (g=0x7fffdf70fb08 &lt;guard variable for at::globalContext()::globalContext_&gt;) at /opt/conda/conda-bld/comp\nilers_linux-64_1520532893746/work/.build/src/gcc-7.2.0/libstdc++-v3/libsupc++/guard.cc:307\n#2  0x00007fffddd812d0 in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#3  0x00007fffccef089b in torch::autograd::register_variable_type_for (baseType=0x5555566f78b0) at ../torch/csrc/autograd/generated/VariableType.cpp:171\n#4  0x00007fffcce46588 in torch::autograd::VariableHooks::registerVariableTypeFor (this=0x5555566f7920, context=0x7fffdf70fb20 &lt;at::globalContext()::globalContext\n_&gt;, backend=at::Backend::CPU, scalar_type=at::ScalarType::Byte) at ../torch/csrc/autograd/aten_variable_hooks.cpp:21\n#5  0x00007fffddfb3e43 in at::Type::registerCPU (context=0x7fffdf70fb20 &lt;at::globalContext()::globalContext_&gt;) at aten/src/ATen/Type.cpp:40\n#6  0x00007fffddd8120f in at::Context::Context (this=0x7fffdf70fb20 &lt;at::globalContext()::globalContext_&gt;) at ../aten/src/ATen/Context.cpp:37\n#7  0x00007fffddd812eb in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#8  0x00007fffcd04c2f5 in torch::autograd::VariableTypeRegistry::VariableTypeRegistry (this=0x7fffcdce60e8 &lt;torch::autograd::registry&gt;) at ../torch/csrc/autograd/\ngenerated/VariableType.cpp:176\n#9  0x00007fffcd0491ef in __static_initialization_and_destruction_0 (__initialize_p=1, __priority=65535) at ../torch/csrc/autograd/generated/VariableType.cpp:188\n#10 0x00007fffcd049225 in _GLOBAL__sub_I_VariableType.cpp(void) () at ../torch/csrc/autograd/generated/VariableType.cpp:31075\n#11 0x00007ffff7deab03 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2\n#12 0x00007ffff7def6de in dl_open_worker () from /lib64/ld-linux-x86-64.so.2\n#13 0x00007ffff7dea914 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2\n#14 0x00007ffff7deeccb in _dl_open () from /lib64/ld-linux-x86-64.so.2\n#15 0x00007ffff75eefbb in dlopen_doit () from /lib64/libdl.so.2\n#16 0x00007ffff7dea914 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2\n#17 0x00007ffff75ef5bd in _dlerror_run () from /lib64/libdl.so.2\n#18 0x00007ffff75ef051 in dlopen@@GLIBC_2.2.5 () from /lib64/libdl.so.2\n</code></pre>\n<p>So there is a circular call of <code>globalContext()</code>, but ONLY if the variable registration static initializer is called before the Context static initializer. Ugh.</p>", "body_text": "Steps to reproduce:\n\nWrite a patch that eliminates globalContext() initialization from the static initializers of libcaffe2.so. Here is one sample branch: https://github.com/ezyang/pytorch/tree/issue/deadlocks\nBuild and run\n\nIt deadlocks in the following trace:\n#0  0x00007ffff78eaec9 in syscall () from /lib64/libc.so.6\n#1  0x00007fffcbf4c57e in __cxxabiv1::__cxa_guard_acquire (g=0x7fffdf70fb08 <guard variable for at::globalContext()::globalContext_>) at /opt/conda/conda-bld/comp\nilers_linux-64_1520532893746/work/.build/src/gcc-7.2.0/libstdc++-v3/libsupc++/guard.cc:307\n#2  0x00007fffddd812d0 in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#3  0x00007fffccef089b in torch::autograd::register_variable_type_for (baseType=0x5555566f78b0) at ../torch/csrc/autograd/generated/VariableType.cpp:171\n#4  0x00007fffcce46588 in torch::autograd::VariableHooks::registerVariableTypeFor (this=0x5555566f7920, context=0x7fffdf70fb20 <at::globalContext()::globalContext\n_>, backend=at::Backend::CPU, scalar_type=at::ScalarType::Byte) at ../torch/csrc/autograd/aten_variable_hooks.cpp:21\n#5  0x00007fffddfb3e43 in at::Type::registerCPU (context=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at aten/src/ATen/Type.cpp:40\n#6  0x00007fffddd8120f in at::Context::Context (this=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at ../aten/src/ATen/Context.cpp:37\n#7  0x00007fffddd812eb in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#8  0x00007fffcd04c2f5 in torch::autograd::VariableTypeRegistry::VariableTypeRegistry (this=0x7fffcdce60e8 <torch::autograd::registry>) at ../torch/csrc/autograd/\ngenerated/VariableType.cpp:176\n#9  0x00007fffcd0491ef in __static_initialization_and_destruction_0 (__initialize_p=1, __priority=65535) at ../torch/csrc/autograd/generated/VariableType.cpp:188\n#10 0x00007fffcd049225 in _GLOBAL__sub_I_VariableType.cpp(void) () at ../torch/csrc/autograd/generated/VariableType.cpp:31075\n#11 0x00007ffff7deab03 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2\n(More stack frames follow...)\n(gdb) bt\n#0  0x00007ffff78eaec9 in syscall () from /lib64/libc.so.6\n#1  0x00007fffcbf4c57e in __cxxabiv1::__cxa_guard_acquire (g=0x7fffdf70fb08 <guard variable for at::globalContext()::globalContext_>) at /opt/conda/conda-bld/comp\nilers_linux-64_1520532893746/work/.build/src/gcc-7.2.0/libstdc++-v3/libsupc++/guard.cc:307\n#2  0x00007fffddd812d0 in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#3  0x00007fffccef089b in torch::autograd::register_variable_type_for (baseType=0x5555566f78b0) at ../torch/csrc/autograd/generated/VariableType.cpp:171\n#4  0x00007fffcce46588 in torch::autograd::VariableHooks::registerVariableTypeFor (this=0x5555566f7920, context=0x7fffdf70fb20 <at::globalContext()::globalContext\n_>, backend=at::Backend::CPU, scalar_type=at::ScalarType::Byte) at ../torch/csrc/autograd/aten_variable_hooks.cpp:21\n#5  0x00007fffddfb3e43 in at::Type::registerCPU (context=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at aten/src/ATen/Type.cpp:40\n#6  0x00007fffddd8120f in at::Context::Context (this=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at ../aten/src/ATen/Context.cpp:37\n#7  0x00007fffddd812eb in at::globalContext () at ../aten/src/ATen/Context.cpp:41\n#8  0x00007fffcd04c2f5 in torch::autograd::VariableTypeRegistry::VariableTypeRegistry (this=0x7fffcdce60e8 <torch::autograd::registry>) at ../torch/csrc/autograd/\ngenerated/VariableType.cpp:176\n#9  0x00007fffcd0491ef in __static_initialization_and_destruction_0 (__initialize_p=1, __priority=65535) at ../torch/csrc/autograd/generated/VariableType.cpp:188\n#10 0x00007fffcd049225 in _GLOBAL__sub_I_VariableType.cpp(void) () at ../torch/csrc/autograd/generated/VariableType.cpp:31075\n#11 0x00007ffff7deab03 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2\n#12 0x00007ffff7def6de in dl_open_worker () from /lib64/ld-linux-x86-64.so.2\n#13 0x00007ffff7dea914 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2\n#14 0x00007ffff7deeccb in _dl_open () from /lib64/ld-linux-x86-64.so.2\n#15 0x00007ffff75eefbb in dlopen_doit () from /lib64/libdl.so.2\n#16 0x00007ffff7dea914 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2\n#17 0x00007ffff75ef5bd in _dlerror_run () from /lib64/libdl.so.2\n#18 0x00007ffff75ef051 in dlopen@@GLIBC_2.2.5 () from /lib64/libdl.so.2\n\nSo there is a circular call of globalContext(), but ONLY if the variable registration static initializer is called before the Context static initializer. Ugh.", "body": "Steps to reproduce:\r\n1. Write a patch that eliminates `globalContext()` initialization from the static initializers of `libcaffe2.so`. Here is one sample branch: https://github.com/ezyang/pytorch/tree/issue/deadlocks\r\n2. Build and run\r\n\r\nIt deadlocks in the following trace:\r\n\r\n```\r\n#0  0x00007ffff78eaec9 in syscall () from /lib64/libc.so.6\r\n#1  0x00007fffcbf4c57e in __cxxabiv1::__cxa_guard_acquire (g=0x7fffdf70fb08 <guard variable for at::globalContext()::globalContext_>) at /opt/conda/conda-bld/comp\r\nilers_linux-64_1520532893746/work/.build/src/gcc-7.2.0/libstdc++-v3/libsupc++/guard.cc:307\r\n#2  0x00007fffddd812d0 in at::globalContext () at ../aten/src/ATen/Context.cpp:41\r\n#3  0x00007fffccef089b in torch::autograd::register_variable_type_for (baseType=0x5555566f78b0) at ../torch/csrc/autograd/generated/VariableType.cpp:171\r\n#4  0x00007fffcce46588 in torch::autograd::VariableHooks::registerVariableTypeFor (this=0x5555566f7920, context=0x7fffdf70fb20 <at::globalContext()::globalContext\r\n_>, backend=at::Backend::CPU, scalar_type=at::ScalarType::Byte) at ../torch/csrc/autograd/aten_variable_hooks.cpp:21\r\n#5  0x00007fffddfb3e43 in at::Type::registerCPU (context=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at aten/src/ATen/Type.cpp:40\r\n#6  0x00007fffddd8120f in at::Context::Context (this=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at ../aten/src/ATen/Context.cpp:37\r\n#7  0x00007fffddd812eb in at::globalContext () at ../aten/src/ATen/Context.cpp:41\r\n#8  0x00007fffcd04c2f5 in torch::autograd::VariableTypeRegistry::VariableTypeRegistry (this=0x7fffcdce60e8 <torch::autograd::registry>) at ../torch/csrc/autograd/\r\ngenerated/VariableType.cpp:176\r\n#9  0x00007fffcd0491ef in __static_initialization_and_destruction_0 (__initialize_p=1, __priority=65535) at ../torch/csrc/autograd/generated/VariableType.cpp:188\r\n#10 0x00007fffcd049225 in _GLOBAL__sub_I_VariableType.cpp(void) () at ../torch/csrc/autograd/generated/VariableType.cpp:31075\r\n#11 0x00007ffff7deab03 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2\r\n(More stack frames follow...)\r\n(gdb) bt\r\n#0  0x00007ffff78eaec9 in syscall () from /lib64/libc.so.6\r\n#1  0x00007fffcbf4c57e in __cxxabiv1::__cxa_guard_acquire (g=0x7fffdf70fb08 <guard variable for at::globalContext()::globalContext_>) at /opt/conda/conda-bld/comp\r\nilers_linux-64_1520532893746/work/.build/src/gcc-7.2.0/libstdc++-v3/libsupc++/guard.cc:307\r\n#2  0x00007fffddd812d0 in at::globalContext () at ../aten/src/ATen/Context.cpp:41\r\n#3  0x00007fffccef089b in torch::autograd::register_variable_type_for (baseType=0x5555566f78b0) at ../torch/csrc/autograd/generated/VariableType.cpp:171\r\n#4  0x00007fffcce46588 in torch::autograd::VariableHooks::registerVariableTypeFor (this=0x5555566f7920, context=0x7fffdf70fb20 <at::globalContext()::globalContext\r\n_>, backend=at::Backend::CPU, scalar_type=at::ScalarType::Byte) at ../torch/csrc/autograd/aten_variable_hooks.cpp:21\r\n#5  0x00007fffddfb3e43 in at::Type::registerCPU (context=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at aten/src/ATen/Type.cpp:40\r\n#6  0x00007fffddd8120f in at::Context::Context (this=0x7fffdf70fb20 <at::globalContext()::globalContext_>) at ../aten/src/ATen/Context.cpp:37\r\n#7  0x00007fffddd812eb in at::globalContext () at ../aten/src/ATen/Context.cpp:41\r\n#8  0x00007fffcd04c2f5 in torch::autograd::VariableTypeRegistry::VariableTypeRegistry (this=0x7fffcdce60e8 <torch::autograd::registry>) at ../torch/csrc/autograd/\r\ngenerated/VariableType.cpp:176\r\n#9  0x00007fffcd0491ef in __static_initialization_and_destruction_0 (__initialize_p=1, __priority=65535) at ../torch/csrc/autograd/generated/VariableType.cpp:188\r\n#10 0x00007fffcd049225 in _GLOBAL__sub_I_VariableType.cpp(void) () at ../torch/csrc/autograd/generated/VariableType.cpp:31075\r\n#11 0x00007ffff7deab03 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2\r\n#12 0x00007ffff7def6de in dl_open_worker () from /lib64/ld-linux-x86-64.so.2\r\n#13 0x00007ffff7dea914 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2\r\n#14 0x00007ffff7deeccb in _dl_open () from /lib64/ld-linux-x86-64.so.2\r\n#15 0x00007ffff75eefbb in dlopen_doit () from /lib64/libdl.so.2\r\n#16 0x00007ffff7dea914 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2\r\n#17 0x00007ffff75ef5bd in _dlerror_run () from /lib64/libdl.so.2\r\n#18 0x00007ffff75ef051 in dlopen@@GLIBC_2.2.5 () from /lib64/libdl.so.2\r\n```\r\n\r\nSo there is a circular call of `globalContext()`, but ONLY if the variable registration static initializer is called before the Context static initializer. Ugh."}