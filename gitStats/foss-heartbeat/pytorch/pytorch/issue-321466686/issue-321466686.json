{"url": "https://api.github.com/repos/pytorch/pytorch/issues/7414", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/7414/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/7414/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/7414/events", "html_url": "https://github.com/pytorch/pytorch/issues/7414", "id": 321466686, "node_id": "MDU6SXNzdWUzMjE0NjY2ODY=", "number": 7414, "title": "[Caffe2] Negative export to ONNX fails", "user": {"login": "rillomas", "id": 889809, "node_id": "MDQ6VXNlcjg4OTgwOQ==", "avatar_url": "https://avatars2.githubusercontent.com/u/889809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rillomas", "html_url": "https://github.com/rillomas", "followers_url": "https://api.github.com/users/rillomas/followers", "following_url": "https://api.github.com/users/rillomas/following{/other_user}", "gists_url": "https://api.github.com/users/rillomas/gists{/gist_id}", "starred_url": "https://api.github.com/users/rillomas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rillomas/subscriptions", "organizations_url": "https://api.github.com/users/rillomas/orgs", "repos_url": "https://api.github.com/users/rillomas/repos", "events_url": "https://api.github.com/users/rillomas/events{/privacy}", "received_events_url": "https://api.github.com/users/rillomas/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-05-09T07:52:04Z", "updated_at": "2018-05-14T19:02:03Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>The following sample fails. The error seems to be coming from the exact same cause of <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"318248707\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/7020\" data-hovercard-type=\"issue\" data-hovercard-url=\"/pytorch/pytorch/issues/7020/hovercard\" href=\"https://github.com/pytorch/pytorch/issues/7020\">#7020</a>, but I cannot workaround the error with the same fix in frontend.py.</p>\n<p>After some debugging I found out that for <code>Negative</code>, the export process goes through <code>C.support_onnx_export()</code> and <code>C.export_to_onnx()</code> unlike <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"318248707\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/7020\" data-hovercard-type=\"issue\" data-hovercard-url=\"/pytorch/pytorch/issues/7020/hovercard\" href=\"https://github.com/pytorch/pytorch/issues/7020\">#7020</a>. These functions checks the schema in <a href=\"https://github.com/pytorch/pytorch/blob/master/caffe2/operators/negative_op.cc\">https://github.com/pytorch/pytorch/blob/master/caffe2/operators/negative_op.cc</a> to return the corresponding name for ONNX, but for some reason returning the wrong name.</p>\n<h2>Sample</h2>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c\"><span class=\"pl-c\">#</span>!/usr/bin/env python</span>\n<span class=\"pl-k\">import</span> onnx\n<span class=\"pl-k\">import</span> caffe2.python.onnx.frontend <span class=\"pl-k\">as</span> oc2f\n<span class=\"pl-k\">import</span> caffe2.python.predictor.predictor_exporter <span class=\"pl-k\">as</span> pe\n<span class=\"pl-k\">import</span> caffe2.python.predictor.mobile_exporter <span class=\"pl-k\">as</span> c2me\n<span class=\"pl-k\">from</span> caffe2.python <span class=\"pl-k\">import</span> model_helper, workspace, brew, utils\n<span class=\"pl-c1\">IN_DATA_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>in_data<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-c1\">OUT_DATA_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>out_data<span class=\"pl-pds\">\"</span></span>\n\n<span class=\"pl-c1\">DATA_SHAPE</span> <span class=\"pl-k\">=</span> (<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">3</span>, <span class=\"pl-c1\">3</span>)\n\nmodel <span class=\"pl-k\">=</span> model_helper.ModelHelper(<span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>neg_net<span class=\"pl-pds\">\"</span></span>)\nmodel.net.Negative(<span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-c1\">OUT_DATA_NAME</span>)\n\nmodel.param_init_net.UniformFill([], <span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">DATA_SHAPE</span>)\nworkspace.RunNetOnce(model.param_init_net)\n\ninit_net, predict_net <span class=\"pl-k\">=</span> c2me.Export(workspace, model.net, [<span class=\"pl-c1\">IN_DATA_NAME</span>])\n\nvalue_info <span class=\"pl-k\">=</span> {\n}\n\nonnx_model <span class=\"pl-k\">=</span> oc2f.caffe2_net_to_onnx_model(\n        predict_net,\n        init_net,\n        value_info)\nonnx.checker.check_model(onnx_model)\n<span class=\"pl-c1\">print</span>(onnx_model)\n<span class=\"pl-k\">with</span> <span class=\"pl-c1\">open</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>neg.onnx<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>wb<span class=\"pl-pds\">'</span></span>) <span class=\"pl-k\">as</span> f:\n    f.write(onnx_model.SerializeToString())</pre></div>\n<h2>Error</h2>\n<pre><code>Traceback (most recent call last):\n  File \"./gen_neg.py\", line 38, in &lt;module&gt;\n    value_info)\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 337, in caffe2_net_to_onnx_model\n    model = make_model(cls.caffe2_net_to_onnx_graph(*args, **kwargs),\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 273, in caffe2_net_to_onnx_graph\n    checker.check_graph(graph_def)\n  File \"/home/masato/repo/onnx/onnx/checker.py\", line 45, in checker\n    proto.SerializeToString(), ctx)\nonnx.onnx_cpp2py_export.checker.ValidationError: No Schema registered for Negative with domain_version of 7\n\n==&gt; Context: Bad node spec: input: \"in_data_0\" output: \"out_data_1\" name: \"\" op_type: \"Negative\"\n</code></pre>\n<ul>\n<li>OS: Ubuntu 16.04.4 x86_64</li>\n<li>PyTorch version: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/5c2015d133d1a6c54b4daba35e54fd0c84806463/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/5c2015d133d1a6c54b4daba35e54fd0c84806463\"><tt>5c2015d</tt></a></li>\n<li>ONNX version: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/dee6d89781fb885d1ed3b935992b27338befe1cd/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/dee6d89781fb885d1ed3b935992b27338befe1cd\"><tt>dee6d89</tt></a></li>\n<li>Python version: 3.5.2</li>\n</ul>", "body_text": "The following sample fails. The error seems to be coming from the exact same cause of #7020, but I cannot workaround the error with the same fix in frontend.py.\nAfter some debugging I found out that for Negative, the export process goes through C.support_onnx_export() and C.export_to_onnx() unlike #7020. These functions checks the schema in https://github.com/pytorch/pytorch/blob/master/caffe2/operators/negative_op.cc to return the corresponding name for ONNX, but for some reason returning the wrong name.\nSample\n#!/usr/bin/env python\nimport onnx\nimport caffe2.python.onnx.frontend as oc2f\nimport caffe2.python.predictor.predictor_exporter as pe\nimport caffe2.python.predictor.mobile_exporter as c2me\nfrom caffe2.python import model_helper, workspace, brew, utils\nIN_DATA_NAME = \"in_data\"\nOUT_DATA_NAME = \"out_data\"\n\nDATA_SHAPE = (1, 3, 3, 3)\n\nmodel = model_helper.ModelHelper(name=\"neg_net\")\nmodel.net.Negative(IN_DATA_NAME, OUT_DATA_NAME)\n\nmodel.param_init_net.UniformFill([], IN_DATA_NAME, shape=DATA_SHAPE)\nworkspace.RunNetOnce(model.param_init_net)\n\ninit_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\n\nvalue_info = {\n}\n\nonnx_model = oc2f.caffe2_net_to_onnx_model(\n        predict_net,\n        init_net,\n        value_info)\nonnx.checker.check_model(onnx_model)\nprint(onnx_model)\nwith open(\"neg.onnx\", 'wb') as f:\n    f.write(onnx_model.SerializeToString())\nError\nTraceback (most recent call last):\n  File \"./gen_neg.py\", line 38, in <module>\n    value_info)\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 337, in caffe2_net_to_onnx_model\n    model = make_model(cls.caffe2_net_to_onnx_graph(*args, **kwargs),\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 273, in caffe2_net_to_onnx_graph\n    checker.check_graph(graph_def)\n  File \"/home/masato/repo/onnx/onnx/checker.py\", line 45, in checker\n    proto.SerializeToString(), ctx)\nonnx.onnx_cpp2py_export.checker.ValidationError: No Schema registered for Negative with domain_version of 7\n\n==> Context: Bad node spec: input: \"in_data_0\" output: \"out_data_1\" name: \"\" op_type: \"Negative\"\n\n\nOS: Ubuntu 16.04.4 x86_64\nPyTorch version: 5c2015d\nONNX version: dee6d89\nPython version: 3.5.2", "body": "The following sample fails. The error seems to be coming from the exact same cause of #7020, but I cannot workaround the error with the same fix in frontend.py.\r\n\r\nAfter some debugging I found out that for `Negative`, the export process goes through `C.support_onnx_export()` and `C.export_to_onnx()` unlike #7020. These functions checks the schema in https://github.com/pytorch/pytorch/blob/master/caffe2/operators/negative_op.cc to return the corresponding name for ONNX, but for some reason returning the wrong name.\r\n\r\n## Sample\r\n```python\r\n#!/usr/bin/env python\r\nimport onnx\r\nimport caffe2.python.onnx.frontend as oc2f\r\nimport caffe2.python.predictor.predictor_exporter as pe\r\nimport caffe2.python.predictor.mobile_exporter as c2me\r\nfrom caffe2.python import model_helper, workspace, brew, utils\r\nIN_DATA_NAME = \"in_data\"\r\nOUT_DATA_NAME = \"out_data\"\r\n\r\nDATA_SHAPE = (1, 3, 3, 3)\r\n\r\nmodel = model_helper.ModelHelper(name=\"neg_net\")\r\nmodel.net.Negative(IN_DATA_NAME, OUT_DATA_NAME)\r\n\r\nmodel.param_init_net.UniformFill([], IN_DATA_NAME, shape=DATA_SHAPE)\r\nworkspace.RunNetOnce(model.param_init_net)\r\n\r\ninit_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME])\r\n\r\nvalue_info = {\r\n}\r\n\r\nonnx_model = oc2f.caffe2_net_to_onnx_model(\r\n        predict_net,\r\n        init_net,\r\n        value_info)\r\nonnx.checker.check_model(onnx_model)\r\nprint(onnx_model)\r\nwith open(\"neg.onnx\", 'wb') as f:\r\n    f.write(onnx_model.SerializeToString())\r\n```\r\n\r\n## Error\r\n```\r\nTraceback (most recent call last):\r\n  File \"./gen_neg.py\", line 38, in <module>\r\n    value_info)\r\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 337, in caffe2_net_to_onnx_model\r\n    model = make_model(cls.caffe2_net_to_onnx_graph(*args, **kwargs),\r\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 273, in caffe2_net_to_onnx_graph\r\n    checker.check_graph(graph_def)\r\n  File \"/home/masato/repo/onnx/onnx/checker.py\", line 45, in checker\r\n    proto.SerializeToString(), ctx)\r\nonnx.onnx_cpp2py_export.checker.ValidationError: No Schema registered for Negative with domain_version of 7\r\n\r\n==> Context: Bad node spec: input: \"in_data_0\" output: \"out_data_1\" name: \"\" op_type: \"Negative\"\r\n```\r\n- OS: Ubuntu 16.04.4 x86_64\r\n- PyTorch version: 5c2015d133d1a6c54b4daba35e54fd0c84806463\r\n- ONNX version: dee6d89781fb885d1ed3b935992b27338befe1cd\r\n- Python version: 3.5.2"}