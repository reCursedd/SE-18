{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/189058375", "pull_request_review_id": 121164218, "id": 189058375, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4OTA1ODM3NQ==", "diff_hunk": "@@ -168,7 +211,10 @@ void THTensor_(copy##TYPENAMESRC)(THTensor *tensor, TH##TYPENAMESRC##Tensor *src\n #define IMPLEMENT_THTensor_COPY_FROM_HALF(TYPENAMESRC, TYPE_SRC) \\\n void THTensor_(copy##TYPENAMESRC)(THTensor *tensor, TH##TYPENAMESRC##Tensor *src) \\\n { \\\n- TH_TENSOR_APPLY2(real, tensor, TYPE_SRC, src, *tensor_data = (real)TH_half2float(*src_data);) \\\n+ TH_TENSOR_APPLY2(real, tensor, TYPE_SRC, src, \\\n+                  *tensor_data = static_cast<real>( \\\n+                      static_cast<inter_copy_type_t<real>>( \\\n+                          TH_half2float(*src_data)));) \\", "path": "aten/src/TH/generic/THTensorCopy.cpp", "position": 63, "original_position": 63, "commit_id": "15261de7bdeec415dddbeecb459ab0721de44775", "original_commit_id": "15261de7bdeec415dddbeecb459ab0721de44775", "user": {"login": "Maratyszcza", "id": 1093985, "node_id": "MDQ6VXNlcjEwOTM5ODU=", "avatar_url": "https://avatars1.githubusercontent.com/u/1093985?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Maratyszcza", "html_url": "https://github.com/Maratyszcza", "followers_url": "https://api.github.com/users/Maratyszcza/followers", "following_url": "https://api.github.com/users/Maratyszcza/following{/other_user}", "gists_url": "https://api.github.com/users/Maratyszcza/gists{/gist_id}", "starred_url": "https://api.github.com/users/Maratyszcza/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Maratyszcza/subscriptions", "organizations_url": "https://api.github.com/users/Maratyszcza/orgs", "repos_url": "https://api.github.com/users/Maratyszcza/repos", "events_url": "https://api.github.com/users/Maratyszcza/events{/privacy}", "received_events_url": "https://api.github.com/users/Maratyszcza/received_events", "type": "User", "site_admin": false}, "body": "Can we replace `TH_half2float` with `third-party/FP16`? It is ~10x faster:\r\n```\r\n------------------------------------------------------------------------------------\r\nBenchmark                                             Time           CPU Iterations\r\n------------------------------------------------------------------------------------\r\nfp16_ieee_from_fp32_value/1024                      620 ns        618 ns     973101   1.54214G items/s\r\nfp16_ieee_from_fp32_value/2048                     1243 ns       1238 ns     556975   1.54092G items/s\r\nfp16_ieee_from_fp32_value/4096                     2785 ns       2772 ns     268393   1.37594G items/s\r\nfp16_ieee_from_fp32_value/8192                     5496 ns       5478 ns     112730   1.39285G items/s\r\nfp16_ieee_from_fp32_value/16384                   10374 ns      10334 ns      69485   1.47659G items/s\r\nfp16_ieee_from_fp32_value/32768                   21962 ns      21896 ns      34861   1.39373G items/s\r\nfp16_ieee_from_fp32_value/65536                   41284 ns      41183 ns      17295   1.48203G items/s\r\nfp16_ieee_from_fp32_value/131072                  91013 ns      90671 ns       8482   1.34629G items/s\r\nfp16_ieee_from_fp32_value/262144                 164736 ns     164216 ns       4392   1.48671G items/s\r\nfp16_ieee_from_fp32_value/524288                 367715 ns     366340 ns       2184   1.33286G items/s\r\nfp16_ieee_from_fp32_value/1048576                698081 ns     695605 ns       1051    1.4039G items/s\r\nfp16_ieee_from_fp32_value/2097152               1578999 ns    1571951 ns        514   1.24248G items/s\r\nfp16_ieee_from_fp32_value/4194304               2850102 ns    2842571 ns        247    1.3742G items/s\r\nfp16_ieee_from_fp32_value/8388608               6331782 ns    6313632 ns        125    1.2374G items/s\r\nfp16_ieee_from_fp32_value/16777216             11198616 ns   11159426 ns         54   1.40016G items/s\r\nfp16_ieee_from_fp32_value/33554432             22762770 ns   22615500 ns         28    1.3818G items/s\r\nfp16_ieee_from_fp32_value/67108864             47413263 ns   47269067 ns         15   1.32222G items/s\r\nTH_float2halfbits/1024                             9221 ns       9192 ns      76206   106.241M items/s\r\nTH_float2halfbits/2048                            18048 ns      17946 ns      31116   108.836M items/s\r\nTH_float2halfbits/4096                            39222 ns      38943 ns      17863   100.308M items/s\r\nTH_float2halfbits/8192                            80322 ns      79696 ns       7534   98.0287M items/s\r\nTH_float2halfbits/16384                          153586 ns     152481 ns       4773   102.471M items/s\r\nTH_float2halfbits/32768                          331251 ns     328730 ns       2234   95.0629M items/s\r\nTH_float2halfbits/65536                          616999 ns     612308 ns       1178   102.073M items/s\r\nTH_float2halfbits/131072                        1354763 ns    1346316 ns        564    92.846M items/s\r\nTH_float2halfbits/262144                        2431000 ns    2420878 ns        295   103.268M items/s\r\nTH_float2halfbits/524288                        5440403 ns    5386276 ns        145   92.8285M items/s\r\nTH_float2halfbits/1048576                       9934961 ns    9841889 ns         72   101.607M items/s\r\nTH_float2halfbits/2097152                      24216690 ns   24046892 ns         37   83.1708M items/s\r\nTH_float2halfbits/4194304                      43080896 ns   42981000 ns         17   93.0644M items/s\r\nTH_float2halfbits/8388608                      79912380 ns   79677571 ns          7   100.405M items/s\r\nTH_float2halfbits/16777216                    153481303 ns  152754500 ns          4   104.743M items/s\r\nTH_float2halfbits/33554432                    315509706 ns  314010000 ns          2   101.908M items/s\r\nTH_float2halfbits/67108864                    621931326 ns  620039000 ns          1   103.219M items/s\r\n```", "created_at": "2018-05-17T18:31:08Z", "updated_at": "2018-11-23T15:44:14Z", "html_url": "https://github.com/pytorch/pytorch/pull/7644#discussion_r189058375", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/7644", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/189058375"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/7644#discussion_r189058375"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/7644"}}, "body_html": "<p>Can we replace <code>TH_half2float</code> with <code>third-party/FP16</code>? It is ~10x faster:</p>\n<pre><code>------------------------------------------------------------------------------------\nBenchmark                                             Time           CPU Iterations\n------------------------------------------------------------------------------------\nfp16_ieee_from_fp32_value/1024                      620 ns        618 ns     973101   1.54214G items/s\nfp16_ieee_from_fp32_value/2048                     1243 ns       1238 ns     556975   1.54092G items/s\nfp16_ieee_from_fp32_value/4096                     2785 ns       2772 ns     268393   1.37594G items/s\nfp16_ieee_from_fp32_value/8192                     5496 ns       5478 ns     112730   1.39285G items/s\nfp16_ieee_from_fp32_value/16384                   10374 ns      10334 ns      69485   1.47659G items/s\nfp16_ieee_from_fp32_value/32768                   21962 ns      21896 ns      34861   1.39373G items/s\nfp16_ieee_from_fp32_value/65536                   41284 ns      41183 ns      17295   1.48203G items/s\nfp16_ieee_from_fp32_value/131072                  91013 ns      90671 ns       8482   1.34629G items/s\nfp16_ieee_from_fp32_value/262144                 164736 ns     164216 ns       4392   1.48671G items/s\nfp16_ieee_from_fp32_value/524288                 367715 ns     366340 ns       2184   1.33286G items/s\nfp16_ieee_from_fp32_value/1048576                698081 ns     695605 ns       1051    1.4039G items/s\nfp16_ieee_from_fp32_value/2097152               1578999 ns    1571951 ns        514   1.24248G items/s\nfp16_ieee_from_fp32_value/4194304               2850102 ns    2842571 ns        247    1.3742G items/s\nfp16_ieee_from_fp32_value/8388608               6331782 ns    6313632 ns        125    1.2374G items/s\nfp16_ieee_from_fp32_value/16777216             11198616 ns   11159426 ns         54   1.40016G items/s\nfp16_ieee_from_fp32_value/33554432             22762770 ns   22615500 ns         28    1.3818G items/s\nfp16_ieee_from_fp32_value/67108864             47413263 ns   47269067 ns         15   1.32222G items/s\nTH_float2halfbits/1024                             9221 ns       9192 ns      76206   106.241M items/s\nTH_float2halfbits/2048                            18048 ns      17946 ns      31116   108.836M items/s\nTH_float2halfbits/4096                            39222 ns      38943 ns      17863   100.308M items/s\nTH_float2halfbits/8192                            80322 ns      79696 ns       7534   98.0287M items/s\nTH_float2halfbits/16384                          153586 ns     152481 ns       4773   102.471M items/s\nTH_float2halfbits/32768                          331251 ns     328730 ns       2234   95.0629M items/s\nTH_float2halfbits/65536                          616999 ns     612308 ns       1178   102.073M items/s\nTH_float2halfbits/131072                        1354763 ns    1346316 ns        564    92.846M items/s\nTH_float2halfbits/262144                        2431000 ns    2420878 ns        295   103.268M items/s\nTH_float2halfbits/524288                        5440403 ns    5386276 ns        145   92.8285M items/s\nTH_float2halfbits/1048576                       9934961 ns    9841889 ns         72   101.607M items/s\nTH_float2halfbits/2097152                      24216690 ns   24046892 ns         37   83.1708M items/s\nTH_float2halfbits/4194304                      43080896 ns   42981000 ns         17   93.0644M items/s\nTH_float2halfbits/8388608                      79912380 ns   79677571 ns          7   100.405M items/s\nTH_float2halfbits/16777216                    153481303 ns  152754500 ns          4   104.743M items/s\nTH_float2halfbits/33554432                    315509706 ns  314010000 ns          2   101.908M items/s\nTH_float2halfbits/67108864                    621931326 ns  620039000 ns          1   103.219M items/s\n</code></pre>", "body_text": "Can we replace TH_half2float with third-party/FP16? It is ~10x faster:\n------------------------------------------------------------------------------------\nBenchmark                                             Time           CPU Iterations\n------------------------------------------------------------------------------------\nfp16_ieee_from_fp32_value/1024                      620 ns        618 ns     973101   1.54214G items/s\nfp16_ieee_from_fp32_value/2048                     1243 ns       1238 ns     556975   1.54092G items/s\nfp16_ieee_from_fp32_value/4096                     2785 ns       2772 ns     268393   1.37594G items/s\nfp16_ieee_from_fp32_value/8192                     5496 ns       5478 ns     112730   1.39285G items/s\nfp16_ieee_from_fp32_value/16384                   10374 ns      10334 ns      69485   1.47659G items/s\nfp16_ieee_from_fp32_value/32768                   21962 ns      21896 ns      34861   1.39373G items/s\nfp16_ieee_from_fp32_value/65536                   41284 ns      41183 ns      17295   1.48203G items/s\nfp16_ieee_from_fp32_value/131072                  91013 ns      90671 ns       8482   1.34629G items/s\nfp16_ieee_from_fp32_value/262144                 164736 ns     164216 ns       4392   1.48671G items/s\nfp16_ieee_from_fp32_value/524288                 367715 ns     366340 ns       2184   1.33286G items/s\nfp16_ieee_from_fp32_value/1048576                698081 ns     695605 ns       1051    1.4039G items/s\nfp16_ieee_from_fp32_value/2097152               1578999 ns    1571951 ns        514   1.24248G items/s\nfp16_ieee_from_fp32_value/4194304               2850102 ns    2842571 ns        247    1.3742G items/s\nfp16_ieee_from_fp32_value/8388608               6331782 ns    6313632 ns        125    1.2374G items/s\nfp16_ieee_from_fp32_value/16777216             11198616 ns   11159426 ns         54   1.40016G items/s\nfp16_ieee_from_fp32_value/33554432             22762770 ns   22615500 ns         28    1.3818G items/s\nfp16_ieee_from_fp32_value/67108864             47413263 ns   47269067 ns         15   1.32222G items/s\nTH_float2halfbits/1024                             9221 ns       9192 ns      76206   106.241M items/s\nTH_float2halfbits/2048                            18048 ns      17946 ns      31116   108.836M items/s\nTH_float2halfbits/4096                            39222 ns      38943 ns      17863   100.308M items/s\nTH_float2halfbits/8192                            80322 ns      79696 ns       7534   98.0287M items/s\nTH_float2halfbits/16384                          153586 ns     152481 ns       4773   102.471M items/s\nTH_float2halfbits/32768                          331251 ns     328730 ns       2234   95.0629M items/s\nTH_float2halfbits/65536                          616999 ns     612308 ns       1178   102.073M items/s\nTH_float2halfbits/131072                        1354763 ns    1346316 ns        564    92.846M items/s\nTH_float2halfbits/262144                        2431000 ns    2420878 ns        295   103.268M items/s\nTH_float2halfbits/524288                        5440403 ns    5386276 ns        145   92.8285M items/s\nTH_float2halfbits/1048576                       9934961 ns    9841889 ns         72   101.607M items/s\nTH_float2halfbits/2097152                      24216690 ns   24046892 ns         37   83.1708M items/s\nTH_float2halfbits/4194304                      43080896 ns   42981000 ns         17   93.0644M items/s\nTH_float2halfbits/8388608                      79912380 ns   79677571 ns          7   100.405M items/s\nTH_float2halfbits/16777216                    153481303 ns  152754500 ns          4   104.743M items/s\nTH_float2halfbits/33554432                    315509706 ns  314010000 ns          2   101.908M items/s\nTH_float2halfbits/67108864                    621931326 ns  620039000 ns          1   103.219M items/s"}