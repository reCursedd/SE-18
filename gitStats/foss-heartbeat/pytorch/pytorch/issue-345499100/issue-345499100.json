{"url": "https://api.github.com/repos/pytorch/pytorch/issues/9985", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/9985/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/9985/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/9985/events", "html_url": "https://github.com/pytorch/pytorch/issues/9985", "id": 345499100, "node_id": "MDU6SXNzdWUzNDU0OTkxMDA=", "number": 9985, "title": "DataLoader Multiprocessing Problems", "user": {"login": "PetrochukM", "id": 7424737, "node_id": "MDQ6VXNlcjc0MjQ3Mzc=", "avatar_url": "https://avatars2.githubusercontent.com/u/7424737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PetrochukM", "html_url": "https://github.com/PetrochukM", "followers_url": "https://api.github.com/users/PetrochukM/followers", "following_url": "https://api.github.com/users/PetrochukM/following{/other_user}", "gists_url": "https://api.github.com/users/PetrochukM/gists{/gist_id}", "starred_url": "https://api.github.com/users/PetrochukM/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PetrochukM/subscriptions", "organizations_url": "https://api.github.com/users/PetrochukM/orgs", "repos_url": "https://api.github.com/users/PetrochukM/repos", "events_url": "https://api.github.com/users/PetrochukM/events{/privacy}", "received_events_url": "https://api.github.com/users/PetrochukM/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 696160151, "node_id": "MDU6TGFiZWw2OTYxNjAxNTE=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/nightly-announce", "name": "nightly-announce", "color": "fbca04", "default": false}], "state": "closed", "locked": false, "assignee": {"login": "SsnL", "id": 5674597, "node_id": "MDQ6VXNlcjU2NzQ1OTc=", "avatar_url": "https://avatars2.githubusercontent.com/u/5674597?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SsnL", "html_url": "https://github.com/SsnL", "followers_url": "https://api.github.com/users/SsnL/followers", "following_url": "https://api.github.com/users/SsnL/following{/other_user}", "gists_url": "https://api.github.com/users/SsnL/gists{/gist_id}", "starred_url": "https://api.github.com/users/SsnL/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SsnL/subscriptions", "organizations_url": "https://api.github.com/users/SsnL/orgs", "repos_url": "https://api.github.com/users/SsnL/repos", "events_url": "https://api.github.com/users/SsnL/events{/privacy}", "received_events_url": "https://api.github.com/users/SsnL/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "SsnL", "id": 5674597, "node_id": "MDQ6VXNlcjU2NzQ1OTc=", "avatar_url": "https://avatars2.githubusercontent.com/u/5674597?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SsnL", "html_url": "https://github.com/SsnL", "followers_url": "https://api.github.com/users/SsnL/followers", "following_url": "https://api.github.com/users/SsnL/following{/other_user}", "gists_url": "https://api.github.com/users/SsnL/gists{/gist_id}", "starred_url": "https://api.github.com/users/SsnL/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SsnL/subscriptions", "organizations_url": "https://api.github.com/users/SsnL/orgs", "repos_url": "https://api.github.com/users/SsnL/repos", "events_url": "https://api.github.com/users/SsnL/events{/privacy}", "received_events_url": "https://api.github.com/users/SsnL/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 11, "created_at": "2018-07-29T03:56:51Z", "updated_at": "2018-09-15T03:07:55Z", "closed_at": "2018-08-13T17:33:47Z", "author_association": "NONE", "body_html": "<h2>Issue description</h2>\n<p>DataLoader for me has been erroring upon a shut down after calling <code>break</code>.</p>\n<h2>Error 1</h2>\n<pre><code>from torch.utils.data import DataLoader\n\niterator = DataLoader([1, 2, 3, 4, 5, 6, 7, 8, 9, 10], batch_size=2, num_workers=12, drop_last=True)\nfor _ in iterator:\n    break\n</code></pre>\n<pre><code>Exception ignored in: &lt;bound method _DataLoaderIter.__del__ of &lt;torch.utils.data.dataloader._DataLoaderIter object at 0x10cf0ddd8&gt;&gt;\nTraceback (most recent call last):\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\n    self._shutdown_workers()\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\n    self.worker_result_queue.get()\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/queues.py\", line 337, in get\n    return _ForkingPickler.loads(res)\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 167, in rebuild_storage_filename\n    storage = cls._new_shared_filename(manager, handle, size)\nRuntimeError: Interrupted system call at /Users/soumith/code/builder/wheel/pytorch-src/torch/lib/libshm/core.cpp:99\n</code></pre>\n<h2>Error 2</h2>\n<p>I was unable to come up with a simple code example to replicate this error but this frequently occurs with these settings:</p>\n<pre><code>DataLoader(\n            large_dataset,\n            batch_size=64,\n            pin_memory=True,\n            num_workers=12,\n            drop_last=True)\n</code></pre>\n<p>The execution of my program would get stuck until I issue a keyboard interrupt.</p>\n<pre><code>^CException ignored in: &lt;bound method _DataLoaderIter.__del__ of &lt;torch.utils.data.dataloader._DataLoaderIter object at 0x7f70709f5550&gt;&gt;\nTraceback (most recent call last):\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\nProcess Process-1:\n    self._shutdown_workers()\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 390, in _shutdown_workers\n    self.worker_result_queue.put(None)\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 354, in put\n    with self._wlock:\n  File \"/usr/lib/python3.5/multiprocessing/synchronize.py\", line 96, in __enter__\n    return self._semlock.__enter__()\nKeyboardInterrupt:\nTraceback (most recent call last):\n  File \"/usr/lib/python3.5/multiprocessing/process.py\", line 249, in _bootstrap\n    self.run()\n  File \"/usr/lib/python3.5/multiprocessing/process.py\", line 93, in run\n    self._target(*self._args, **self._kwargs)\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 110, in _worker_loop\n    data_queue.put((idx, samples))\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 355, in put\n    self._writer.send_bytes(obj)\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 200, in send_bytes\n    self._send_bytes(m[offset:offset + size])\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 404, in _send_bytes\n    self._send(header + buf)\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 368, in _send\n    n = write(self._handle, buf)\nKeyboardInterrupt\n</code></pre>\n<h1>Error 3</h1>\n<pre><code>Exception ignored in: &lt;bound method _DataLoaderIter.__del__ of &lt;torch.utils.data.dataloader._DataLoaderIter object at 0x7fe8f3c9e5c0&gt;&gt;\nTraceback (most recent call last):\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\n    self._shutdown_workers()\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\n    self.worker_result_queue.get()\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 345, in get\n    return ForkingPickler.loads(res)\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/multiprocessing/reductions.py\", line 151, in rebuild_storage_fd\n    fd = df.detach()\n  File \"/usr/lib/python3.5/multiprocessing/resource_sharer.py\", line 58, in detach\n    return reduction.recv_handle(conn)\n  File \"/usr/lib/python3.5/multiprocessing/reduction.py\", line 181, in recv_handle\n    return recvfds(s, 1)[0]\n  File \"/usr/lib/python3.5/multiprocessing/reduction.py\", line 152, in recvfds\n    msg, ancdata, flags, addr = sock.recvmsg(1, socket.CMSG_LEN(bytes_size))\nConnectionResetError: [Errno 104] Connection reset by peer\n</code></pre>\n<h2>System Info</h2>\n<ul>\n<li>PyTorch or Caffe2: PyTorch</li>\n<li>How you installed PyTorch (conda, pip, source): pip</li>\n<li>PyTorch version: 0.4.1</li>\n<li>Python version: 3.5.2</li>\n</ul>", "body_text": "Issue description\nDataLoader for me has been erroring upon a shut down after calling break.\nError 1\nfrom torch.utils.data import DataLoader\n\niterator = DataLoader([1, 2, 3, 4, 5, 6, 7, 8, 9, 10], batch_size=2, num_workers=12, drop_last=True)\nfor _ in iterator:\n    break\n\nException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x10cf0ddd8>>\nTraceback (most recent call last):\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\n    self._shutdown_workers()\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\n    self.worker_result_queue.get()\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/queues.py\", line 337, in get\n    return _ForkingPickler.loads(res)\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 167, in rebuild_storage_filename\n    storage = cls._new_shared_filename(manager, handle, size)\nRuntimeError: Interrupted system call at /Users/soumith/code/builder/wheel/pytorch-src/torch/lib/libshm/core.cpp:99\n\nError 2\nI was unable to come up with a simple code example to replicate this error but this frequently occurs with these settings:\nDataLoader(\n            large_dataset,\n            batch_size=64,\n            pin_memory=True,\n            num_workers=12,\n            drop_last=True)\n\nThe execution of my program would get stuck until I issue a keyboard interrupt.\n^CException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x7f70709f5550>>\nTraceback (most recent call last):\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\nProcess Process-1:\n    self._shutdown_workers()\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 390, in _shutdown_workers\n    self.worker_result_queue.put(None)\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 354, in put\n    with self._wlock:\n  File \"/usr/lib/python3.5/multiprocessing/synchronize.py\", line 96, in __enter__\n    return self._semlock.__enter__()\nKeyboardInterrupt:\nTraceback (most recent call last):\n  File \"/usr/lib/python3.5/multiprocessing/process.py\", line 249, in _bootstrap\n    self.run()\n  File \"/usr/lib/python3.5/multiprocessing/process.py\", line 93, in run\n    self._target(*self._args, **self._kwargs)\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 110, in _worker_loop\n    data_queue.put((idx, samples))\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 355, in put\n    self._writer.send_bytes(obj)\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 200, in send_bytes\n    self._send_bytes(m[offset:offset + size])\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 404, in _send_bytes\n    self._send(header + buf)\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 368, in _send\n    n = write(self._handle, buf)\nKeyboardInterrupt\n\nError 3\nException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x7fe8f3c9e5c0>>\nTraceback (most recent call last):\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\n    self._shutdown_workers()\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\n    self.worker_result_queue.get()\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 345, in get\n    return ForkingPickler.loads(res)\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/multiprocessing/reductions.py\", line 151, in rebuild_storage_fd\n    fd = df.detach()\n  File \"/usr/lib/python3.5/multiprocessing/resource_sharer.py\", line 58, in detach\n    return reduction.recv_handle(conn)\n  File \"/usr/lib/python3.5/multiprocessing/reduction.py\", line 181, in recv_handle\n    return recvfds(s, 1)[0]\n  File \"/usr/lib/python3.5/multiprocessing/reduction.py\", line 152, in recvfds\n    msg, ancdata, flags, addr = sock.recvmsg(1, socket.CMSG_LEN(bytes_size))\nConnectionResetError: [Errno 104] Connection reset by peer\n\nSystem Info\n\nPyTorch or Caffe2: PyTorch\nHow you installed PyTorch (conda, pip, source): pip\nPyTorch version: 0.4.1\nPython version: 3.5.2", "body": "## Issue description\r\n\r\nDataLoader for me has been erroring upon a shut down after calling ``break``.\r\n\r\n## Error 1\r\n\r\n```\r\nfrom torch.utils.data import DataLoader\r\n\r\niterator = DataLoader([1, 2, 3, 4, 5, 6, 7, 8, 9, 10], batch_size=2, num_workers=12, drop_last=True)\r\nfor _ in iterator:\r\n    break\r\n```\r\n\r\n```\r\nException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x10cf0ddd8>>\r\nTraceback (most recent call last):\r\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\r\n    self._shutdown_workers()\r\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\r\n    self.worker_result_queue.get()\r\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/queues.py\", line 337, in get\r\n    return _ForkingPickler.loads(res)\r\n  File \"/Users/michaelp/.pyenv/versions/3.6.5/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 167, in rebuild_storage_filename\r\n    storage = cls._new_shared_filename(manager, handle, size)\r\nRuntimeError: Interrupted system call at /Users/soumith/code/builder/wheel/pytorch-src/torch/lib/libshm/core.cpp:99\r\n```\r\n\r\n## Error 2\r\n\r\nI was unable to come up with a simple code example to replicate this error but this frequently occurs with these settings:\r\n\r\n```\r\nDataLoader(\r\n            large_dataset,\r\n            batch_size=64,\r\n            pin_memory=True,\r\n            num_workers=12,\r\n            drop_last=True)\r\n```\r\n\r\nThe execution of my program would get stuck until I issue a keyboard interrupt.\r\n\r\n```\r\n^CException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x7f70709f5550>>\r\nTraceback (most recent call last):\r\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\r\nProcess Process-1:\r\n    self._shutdown_workers()\r\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 390, in _shutdown_workers\r\n    self.worker_result_queue.put(None)\r\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 354, in put\r\n    with self._wlock:\r\n  File \"/usr/lib/python3.5/multiprocessing/synchronize.py\", line 96, in __enter__\r\n    return self._semlock.__enter__()\r\nKeyboardInterrupt:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.5/multiprocessing/process.py\", line 249, in _bootstrap\r\n    self.run()\r\n  File \"/usr/lib/python3.5/multiprocessing/process.py\", line 93, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 110, in _worker_loop\r\n    data_queue.put((idx, samples))\r\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 355, in put\r\n    self._writer.send_bytes(obj)\r\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 200, in send_bytes\r\n    self._send_bytes(m[offset:offset + size])\r\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 404, in _send_bytes\r\n    self._send(header + buf)\r\n  File \"/usr/lib/python3.5/multiprocessing/connection.py\", line 368, in _send\r\n    n = write(self._handle, buf)\r\nKeyboardInterrupt\r\n```\r\n\r\n# Error 3\r\n\r\n```\r\nException ignored in: <bound method _DataLoaderIter.__del__ of <torch.utils.data.dataloader._DataLoaderIter object at 0x7fe8f3c9e5c0>>\r\nTraceback (most recent call last):\r\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 399, in __del__\r\n    self._shutdown_workers()\r\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/utils/data/dataloader.py\", line 378, in _shutdown_workers\r\n    self.worker_result_queue.get()\r\n  File \"/usr/lib/python3.5/multiprocessing/queues.py\", line 345, in get\r\n    return ForkingPickler.loads(res)\r\n  File \"/home/michaelp/.local/lib/python3.5/site-packages/torch/multiprocessing/reductions.py\", line 151, in rebuild_storage_fd\r\n    fd = df.detach()\r\n  File \"/usr/lib/python3.5/multiprocessing/resource_sharer.py\", line 58, in detach\r\n    return reduction.recv_handle(conn)\r\n  File \"/usr/lib/python3.5/multiprocessing/reduction.py\", line 181, in recv_handle\r\n    return recvfds(s, 1)[0]\r\n  File \"/usr/lib/python3.5/multiprocessing/reduction.py\", line 152, in recvfds\r\n    msg, ancdata, flags, addr = sock.recvmsg(1, socket.CMSG_LEN(bytes_size))\r\nConnectionResetError: [Errno 104] Connection reset by peer\r\n```\r\n\r\n## System Info\r\n\r\n- PyTorch or Caffe2: PyTorch\r\n- How you installed PyTorch (conda, pip, source): pip\r\n- PyTorch version: 0.4.1\r\n- Python version: 3.5.2\r\n\r\n"}