{"url": "https://api.github.com/repos/pytorch/pytorch/issues/7020", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/7020/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/7020/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/7020/events", "html_url": "https://github.com/pytorch/pytorch/issues/7020", "id": 318248707, "node_id": "MDU6SXNzdWUzMTgyNDg3MDc=", "number": 7020, "title": "[Caffe2] LT and GT cannot be exported to ONNX", "user": {"login": "rillomas", "id": 889809, "node_id": "MDQ6VXNlcjg4OTgwOQ==", "avatar_url": "https://avatars2.githubusercontent.com/u/889809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rillomas", "html_url": "https://github.com/rillomas", "followers_url": "https://api.github.com/users/rillomas/followers", "following_url": "https://api.github.com/users/rillomas/following{/other_user}", "gists_url": "https://api.github.com/users/rillomas/gists{/gist_id}", "starred_url": "https://api.github.com/users/rillomas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rillomas/subscriptions", "organizations_url": "https://api.github.com/users/rillomas/orgs", "repos_url": "https://api.github.com/users/rillomas/repos", "events_url": "https://api.github.com/users/rillomas/events{/privacy}", "received_events_url": "https://api.github.com/users/rillomas/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}, {"id": 693805995, "node_id": "MDU6TGFiZWw2OTM4MDU5OTU=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/onnx", "name": "onnx", "color": "e99695", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-04-27T01:31:55Z", "updated_at": "2018-05-11T17:33:15Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>When I try to export a simple network using LT (or GT) to ONNX, I get the following error:</p>\n<h2>Error log</h2>\n<pre><code>Traceback (most recent call last):\n...\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 346, in caffe2_net_to_onnx_model\n    model = make_model(cls.caffe2_net_to_onnx_graph(*args, **kwargs),\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 262, in caffe2_net_to_onnx_graph\n    checker.check_graph(graph_def)\n  File \"/home/masato/repo/onnx/onnx/checker.py\", line 45, in checker\n    proto.SerializeToString(), ctx)\nonnx.onnx_cpp2py_export.checker.ValidationError: No Schema registered for LT with domain_version of 6\n\n==&gt; Context: Bad node spec: input: \"in_data_0\" input: \"bias_0\" output: \"out_data_1\" name: \"\" op_type: \"LT\n</code></pre>\n<h2>Sample Code</h2>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-c\"><span class=\"pl-c\">#</span>!/usr/bin/env python</span>\n<span class=\"pl-k\">import</span> onnx\n<span class=\"pl-k\">import</span> caffe2.python.onnx.frontend <span class=\"pl-k\">as</span> oc2f\n<span class=\"pl-k\">import</span> caffe2.python.predictor.predictor_exporter <span class=\"pl-k\">as</span> pe\n<span class=\"pl-k\">import</span> caffe2.python.predictor.mobile_exporter <span class=\"pl-k\">as</span> c2me\n<span class=\"pl-k\">from</span> caffe2.python <span class=\"pl-k\">import</span> model_helper, workspace, brew, utils\n<span class=\"pl-c1\">IN_DATA_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>in_data<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-c1\">IN_BIAS_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>bias<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-c1\">OUT_DATA_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>out_data<span class=\"pl-pds\">\"</span></span>\n\n<span class=\"pl-c1\">WIDTH</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">3</span>\n<span class=\"pl-c1\">HEIGHT</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">4</span>\n<span class=\"pl-c1\">CHAN</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">2</span>\n<span class=\"pl-c1\">AXIS</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">1</span>\n<span class=\"pl-c1\">DATA_SHAPE</span> <span class=\"pl-k\">=</span> (<span class=\"pl-c1\">1</span>, <span class=\"pl-c1\">CHAN</span>, <span class=\"pl-c1\">HEIGHT</span>, <span class=\"pl-c1\">WIDTH</span>)\n\nmodel <span class=\"pl-k\">=</span> model_helper.ModelHelper(<span class=\"pl-v\">name</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>less_net<span class=\"pl-pds\">\"</span></span>)\nmodel.net.LT([<span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-c1\">IN_BIAS_NAME</span>], <span class=\"pl-c1\">OUT_DATA_NAME</span>)\nmodel.param_init_net.UniformFill([], <span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">DATA_SHAPE</span>)\nmodel.param_init_net.UniformFill([], <span class=\"pl-c1\">IN_BIAS_NAME</span>, <span class=\"pl-v\">shape</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">DATA_SHAPE</span>)\nworkspace.RunNetOnce(model.param_init_net)\n\ninit_net, predict_net <span class=\"pl-k\">=</span> c2me.Export(workspace, model.net, [<span class=\"pl-c1\">IN_DATA_NAME</span>, <span class=\"pl-c1\">IN_BIAS_NAME</span>])\n\nvalue_info <span class=\"pl-k\">=</span> {\n}\nonnx_model <span class=\"pl-k\">=</span> oc2f.caffe2_net_to_onnx_model(\n        predict_net,\n        init_net,\n        value_info)\nonnx.checker.check_model(onnx_model)\n<span class=\"pl-c1\">print</span>(onnx_model)\noutname <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>less_no_broadcast.onnx<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-k\">with</span> <span class=\"pl-c1\">open</span>(outname, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>wb<span class=\"pl-pds\">'</span></span>) <span class=\"pl-k\">as</span> f:\n    f.write(onnx_model.SerializeToString())</pre></div>\n<h2>Possible Fix?</h2>\n<p>If I change Caffe2 like the following, it works. The error seems to be coming from <code>LT</code> not being converted to its appropriate ONNX counterpart name <code>Less</code></p>\n<div class=\"highlight highlight-source-diff\"><pre><span class=\"pl-c1\">diff --git a/caffe2/python/onnx/frontend.py b/caffe2/python/onnx/frontend.py</span>\nindex c96b86143..b5106d337 100644\n<span class=\"pl-md\">--- a/caffe2/python/onnx/frontend.py</span>\n<span class=\"pl-mi1\">+++ b/caffe2/python/onnx/frontend.py</span>\n<span class=\"pl-mdr\">@@ -54,6 +54,8 @@</span> class Caffe2Frontend(object):\n         'AveragePool1D': 'AveragePool',\n         'AveragePool2D': 'AveragePool',\n         'AveragePool3D': 'AveragePool',\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        'LT': 'Less',</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        'GT': 'Greater',</span>\n     }\n\n     # caffe2 arguments that are completely removed in onnx</pre></div>\n<h2>System Info</h2>\n<ul>\n<li>OS: Ubuntu 16.04.4 x86_64</li>\n<li>pytorch: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/2e156f3eabb6fa4ae88c2e831aea7da344cf43a3/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/2e156f3eabb6fa4ae88c2e831aea7da344cf43a3\"><tt>2e156f3</tt></a></li>\n<li>onnx: <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pytorch/pytorch/commit/b8c423889b3d15825e90fd5bd8fa1766ba2200ce/hovercard\" href=\"https://github.com/pytorch/pytorch/commit/b8c423889b3d15825e90fd5bd8fa1766ba2200ce\"><tt>b8c4238</tt></a></li>\n<li>Python: 3.5.2</li>\n</ul>", "body_text": "When I try to export a simple network using LT (or GT) to ONNX, I get the following error:\nError log\nTraceback (most recent call last):\n...\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 346, in caffe2_net_to_onnx_model\n    model = make_model(cls.caffe2_net_to_onnx_graph(*args, **kwargs),\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 262, in caffe2_net_to_onnx_graph\n    checker.check_graph(graph_def)\n  File \"/home/masato/repo/onnx/onnx/checker.py\", line 45, in checker\n    proto.SerializeToString(), ctx)\nonnx.onnx_cpp2py_export.checker.ValidationError: No Schema registered for LT with domain_version of 6\n\n==> Context: Bad node spec: input: \"in_data_0\" input: \"bias_0\" output: \"out_data_1\" name: \"\" op_type: \"LT\n\nSample Code\n#!/usr/bin/env python\nimport onnx\nimport caffe2.python.onnx.frontend as oc2f\nimport caffe2.python.predictor.predictor_exporter as pe\nimport caffe2.python.predictor.mobile_exporter as c2me\nfrom caffe2.python import model_helper, workspace, brew, utils\nIN_DATA_NAME = \"in_data\"\nIN_BIAS_NAME = \"bias\"\nOUT_DATA_NAME = \"out_data\"\n\nWIDTH = 3\nHEIGHT = 4\nCHAN = 2\nAXIS = 1\nDATA_SHAPE = (1, CHAN, HEIGHT, WIDTH)\n\nmodel = model_helper.ModelHelper(name=\"less_net\")\nmodel.net.LT([IN_DATA_NAME, IN_BIAS_NAME], OUT_DATA_NAME)\nmodel.param_init_net.UniformFill([], IN_DATA_NAME, shape=DATA_SHAPE)\nmodel.param_init_net.UniformFill([], IN_BIAS_NAME, shape=DATA_SHAPE)\nworkspace.RunNetOnce(model.param_init_net)\n\ninit_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME, IN_BIAS_NAME])\n\nvalue_info = {\n}\nonnx_model = oc2f.caffe2_net_to_onnx_model(\n        predict_net,\n        init_net,\n        value_info)\nonnx.checker.check_model(onnx_model)\nprint(onnx_model)\noutname = \"less_no_broadcast.onnx\"\nwith open(outname, 'wb') as f:\n    f.write(onnx_model.SerializeToString())\nPossible Fix?\nIf I change Caffe2 like the following, it works. The error seems to be coming from LT not being converted to its appropriate ONNX counterpart name Less\ndiff --git a/caffe2/python/onnx/frontend.py b/caffe2/python/onnx/frontend.py\nindex c96b86143..b5106d337 100644\n--- a/caffe2/python/onnx/frontend.py\n+++ b/caffe2/python/onnx/frontend.py\n@@ -54,6 +54,8 @@ class Caffe2Frontend(object):\n         'AveragePool1D': 'AveragePool',\n         'AveragePool2D': 'AveragePool',\n         'AveragePool3D': 'AveragePool',\n+        'LT': 'Less',\n+        'GT': 'Greater',\n     }\n\n     # caffe2 arguments that are completely removed in onnx\nSystem Info\n\nOS: Ubuntu 16.04.4 x86_64\npytorch: 2e156f3\nonnx: b8c4238\nPython: 3.5.2", "body": "When I try to export a simple network using LT (or GT) to ONNX, I get the following error:\r\n\r\n## Error log\r\n```\r\nTraceback (most recent call last):\r\n...\r\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 346, in caffe2_net_to_onnx_model\r\n    model = make_model(cls.caffe2_net_to_onnx_graph(*args, **kwargs),\r\n  File \"/home/masato/repo/pytorch/build/caffe2/python/onnx/frontend.py\", line 262, in caffe2_net_to_onnx_graph\r\n    checker.check_graph(graph_def)\r\n  File \"/home/masato/repo/onnx/onnx/checker.py\", line 45, in checker\r\n    proto.SerializeToString(), ctx)\r\nonnx.onnx_cpp2py_export.checker.ValidationError: No Schema registered for LT with domain_version of 6\r\n\r\n==> Context: Bad node spec: input: \"in_data_0\" input: \"bias_0\" output: \"out_data_1\" name: \"\" op_type: \"LT\r\n```\r\n\r\n## Sample Code\r\n\r\n```python\r\n#!/usr/bin/env python\r\nimport onnx\r\nimport caffe2.python.onnx.frontend as oc2f\r\nimport caffe2.python.predictor.predictor_exporter as pe\r\nimport caffe2.python.predictor.mobile_exporter as c2me\r\nfrom caffe2.python import model_helper, workspace, brew, utils\r\nIN_DATA_NAME = \"in_data\"\r\nIN_BIAS_NAME = \"bias\"\r\nOUT_DATA_NAME = \"out_data\"\r\n\r\nWIDTH = 3\r\nHEIGHT = 4\r\nCHAN = 2\r\nAXIS = 1\r\nDATA_SHAPE = (1, CHAN, HEIGHT, WIDTH)\r\n\r\nmodel = model_helper.ModelHelper(name=\"less_net\")\r\nmodel.net.LT([IN_DATA_NAME, IN_BIAS_NAME], OUT_DATA_NAME)\r\nmodel.param_init_net.UniformFill([], IN_DATA_NAME, shape=DATA_SHAPE)\r\nmodel.param_init_net.UniformFill([], IN_BIAS_NAME, shape=DATA_SHAPE)\r\nworkspace.RunNetOnce(model.param_init_net)\r\n\r\ninit_net, predict_net = c2me.Export(workspace, model.net, [IN_DATA_NAME, IN_BIAS_NAME])\r\n\r\nvalue_info = {\r\n}\r\nonnx_model = oc2f.caffe2_net_to_onnx_model(\r\n        predict_net,\r\n        init_net,\r\n        value_info)\r\nonnx.checker.check_model(onnx_model)\r\nprint(onnx_model)\r\noutname = \"less_no_broadcast.onnx\"\r\nwith open(outname, 'wb') as f:\r\n    f.write(onnx_model.SerializeToString())\r\n```\r\n\r\n## Possible Fix?\r\nIf I change Caffe2 like the following, it works. The error seems to be coming from `LT` not being converted to its appropriate ONNX counterpart name `Less`\r\n\r\n```diff\r\ndiff --git a/caffe2/python/onnx/frontend.py b/caffe2/python/onnx/frontend.py\r\nindex c96b86143..b5106d337 100644\r\n--- a/caffe2/python/onnx/frontend.py\r\n+++ b/caffe2/python/onnx/frontend.py\r\n@@ -54,6 +54,8 @@ class Caffe2Frontend(object):\r\n         'AveragePool1D': 'AveragePool',\r\n         'AveragePool2D': 'AveragePool',\r\n         'AveragePool3D': 'AveragePool',\r\n+        'LT': 'Less',\r\n+        'GT': 'Greater',\r\n     }\r\n\r\n     # caffe2 arguments that are completely removed in onnx\r\n```\r\n\r\n## System Info\r\n- OS: Ubuntu 16.04.4 x86_64\r\n- pytorch: 2e156f3eabb6fa4ae88c2e831aea7da344cf43a3\r\n- onnx: b8c423889b3d15825e90fd5bd8fa1766ba2200ce\r\n- Python: 3.5.2"}