{"url": "https://api.github.com/repos/pytorch/pytorch/issues/11254", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/11254/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/11254/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/11254/events", "html_url": "https://github.com/pytorch/pytorch/pull/11254", "id": 357019514, "node_id": "MDExOlB1bGxSZXF1ZXN0MjEzMTM2MTY0", "number": 11254, "title": "[pt1][tensor] caffe2::DeviceType -> at::DeviceType", "user": {"login": "jerryzh168", "id": 4958441, "node_id": "MDQ6VXNlcjQ5NTg0NDE=", "avatar_url": "https://avatars0.githubusercontent.com/u/4958441?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jerryzh168", "html_url": "https://github.com/jerryzh168", "followers_url": "https://api.github.com/users/jerryzh168/followers", "following_url": "https://api.github.com/users/jerryzh168/following{/other_user}", "gists_url": "https://api.github.com/users/jerryzh168/gists{/gist_id}", "starred_url": "https://api.github.com/users/jerryzh168/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jerryzh168/subscriptions", "organizations_url": "https://api.github.com/users/jerryzh168/orgs", "repos_url": "https://api.github.com/users/jerryzh168/repos", "events_url": "https://api.github.com/users/jerryzh168/events{/privacy}", "received_events_url": "https://api.github.com/users/jerryzh168/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-09-05T00:10:02Z", "updated_at": "2018-11-23T15:50:37Z", "closed_at": "2018-09-05T23:29:20Z", "author_association": "CONTRIBUTOR", "pull_request": {"url": "https://api.github.com/repos/pytorch/pytorch/pulls/11254", "html_url": "https://github.com/pytorch/pytorch/pull/11254", "diff_url": "https://github.com/pytorch/pytorch/pull/11254.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/11254.patch"}, "body_html": "<p>[pt1][tensor] caffe2::DeviceType -&gt; at::DeviceType</p>\n<p>Previously we use DeviceType in caffe2.proto directly, but it's an <code>enum</code> and have implicit conversion to int, which does not have type safety, e.g. we have to explicitly check for a device type is valid in event.h:</p>\n<pre><code>template &lt;int d&gt;\nstruct EventCreateFunctionRegisterer {\n  explicit EventCreateFunctionRegisterer(EventCreateFunction f) {\n    static_assert(d &lt; MaxDeviceTypes, \"\");\n    Event::event_creator_[d] = f;\n  }\n};\n</code></pre>\n<p>at::DeviceType is an <code>enum class</code>, and it does not have implicit conversion to int, and provides better type safety guarantees. In this diff we have done the following refactor(taking CPU as an example):</p>\n<pre><code>1. caffe2::DeviceType \u2192 caffe2::DeviceTypeProto\n2. caffe2::CPU \u2192 caffe2::PROTO_CPU\n3. caffe2::DeviceType = at::DeviceType\n4. caffe2::CPU = at::DeviceType::CPU\n</code></pre>\n<p>codemod -d caffe2/caffe2 --extensions h,cc,cpp 'device_type(), ' 'device_type(), PROTO_'</p>\n<ul>\n<li>some manual changes</li>\n</ul>\n<p>In short, after this diff, in c++, caffe2::CPU refers to the at::DeviceType::CPU and the old proto caffe2::CPU will be caffe2::PROTO_CPU.<br>\nIn python side, we have a temporary workaround that alias <code>caffe2_pb2.CPU = caffe2_pb2.PROOT_CPU</code> to make the change easier to review and this will be removed later.</p>\n<p>Differential Revision: D9545704</p>", "body_text": "[pt1][tensor] caffe2::DeviceType -> at::DeviceType\nPreviously we use DeviceType in caffe2.proto directly, but it's an enum and have implicit conversion to int, which does not have type safety, e.g. we have to explicitly check for a device type is valid in event.h:\ntemplate <int d>\nstruct EventCreateFunctionRegisterer {\n  explicit EventCreateFunctionRegisterer(EventCreateFunction f) {\n    static_assert(d < MaxDeviceTypes, \"\");\n    Event::event_creator_[d] = f;\n  }\n};\n\nat::DeviceType is an enum class, and it does not have implicit conversion to int, and provides better type safety guarantees. In this diff we have done the following refactor(taking CPU as an example):\n1. caffe2::DeviceType \u2192 caffe2::DeviceTypeProto\n2. caffe2::CPU \u2192 caffe2::PROTO_CPU\n3. caffe2::DeviceType = at::DeviceType\n4. caffe2::CPU = at::DeviceType::CPU\n\ncodemod -d caffe2/caffe2 --extensions h,cc,cpp 'device_type(), ' 'device_type(), PROTO_'\n\nsome manual changes\n\nIn short, after this diff, in c++, caffe2::CPU refers to the at::DeviceType::CPU and the old proto caffe2::CPU will be caffe2::PROTO_CPU.\nIn python side, we have a temporary workaround that alias caffe2_pb2.CPU = caffe2_pb2.PROOT_CPU to make the change easier to review and this will be removed later.\nDifferential Revision: D9545704", "body": "[pt1][tensor] caffe2::DeviceType -> at::DeviceType\n\nPreviously we use DeviceType in caffe2.proto directly, but it's an `enum` and have implicit conversion to int, which does not have type safety, e.g. we have to explicitly check for a device type is valid in event.h:\n```\ntemplate <int d>\nstruct EventCreateFunctionRegisterer {\n  explicit EventCreateFunctionRegisterer(EventCreateFunction f) {\n    static_assert(d < MaxDeviceTypes, \"\");\n    Event::event_creator_[d] = f;\n  }\n};\n```\nat::DeviceType is an `enum class`, and it does not have implicit conversion to int, and provides better type safety guarantees. In this diff we have done the following refactor(taking CPU as an example):\n\n    1. caffe2::DeviceType \u2192 caffe2::DeviceTypeProto\n    2. caffe2::CPU \u2192 caffe2::PROTO_CPU\n    3. caffe2::DeviceType = at::DeviceType\n    4. caffe2::CPU = at::DeviceType::CPU\n\ncodemod -d caffe2/caffe2 --extensions h,cc,cpp 'device_type\\(\\), ' 'device_type(), PROTO_'\n+ some manual changes\n\nIn short, after this diff, in c++, caffe2::CPU refers to the at::DeviceType::CPU and the old proto caffe2::CPU will be caffe2::PROTO_CPU.\nIn python side, we have a temporary workaround that alias `caffe2_pb2.CPU = caffe2_pb2.PROOT_CPU` to make the change easier to review and this will be removed later.\n\nDifferential Revision: D9545704\n\n"}