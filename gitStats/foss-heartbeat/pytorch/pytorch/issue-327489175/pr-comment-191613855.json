{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/191613855", "pull_request_review_id": 124182729, "id": 191613855, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE5MTYxMzg1NQ==", "diff_hunk": "@@ -72,40 +73,83 @@ class Observable {\n       if (it->get() == observer_ptr) {\n         auto res = std::move(*it);\n         observers_list_.erase(it);\n+        UpdateCache();\n         return res;\n       }\n     }\n     return nullptr;\n   }\n \n   virtual size_t NumObservers() {\n-    return observers_list_.size();\n+    return num_observers_;\n   }\n \n+ private:\n+  inline static void StartObserver(Observer* observer) {\n+    try {\n+      observer->Start();\n+    } catch (const std::exception& e) {\n+      LOG(ERROR) << \"Exception from observer: \" << e.what();\n+    } catch (...) {\n+      LOG(ERROR) << \"Exception from observer: unknown\";\n+    }\n+  }\n+\n+  inline static void StopObserver(Observer* observer) {\n+    try {\n+      observer->Stop();\n+    } catch (const std::exception& e) {\n+      LOG(ERROR) << \"Exception from observer: \" << e.what();\n+    } catch (...) {\n+      LOG(ERROR) << \"Exception from observer: unknown\";\n+    }\n+  }\n+\n+  void UpdateCache() {\n+    num_observers_ = observers_list_.size();\n+    if (num_observers_ != 1) {\n+      // we cannot take advantage of the cache\n+      return;\n+    }\n+    observer_cache_ = observers_list_[0].get();\n+  }\n+\n+ public:\n   void StartAllObservers() {\n+    // do not access observers_list_ unless necessary\n+    if (num_observers_ == 0) {\n+      return;\n+    }\n+    if (num_observers_ == 1) {", "path": "caffe2/core/observer.h", "position": null, "original_position": 60, "commit_id": "05b4a83bc074ded8af99790b3f727b9b4bae87ff", "original_commit_id": "70ad19b5c2ed5d1d7eb2261213b70c6c2960da38", "user": {"login": "salexspb", "id": 20307328, "node_id": "MDQ6VXNlcjIwMzA3MzI4", "avatar_url": "https://avatars2.githubusercontent.com/u/20307328?v=4", "gravatar_id": "", "url": "https://api.github.com/users/salexspb", "html_url": "https://github.com/salexspb", "followers_url": "https://api.github.com/users/salexspb/followers", "following_url": "https://api.github.com/users/salexspb/following{/other_user}", "gists_url": "https://api.github.com/users/salexspb/gists{/gist_id}", "starred_url": "https://api.github.com/users/salexspb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/salexspb/subscriptions", "organizations_url": "https://api.github.com/users/salexspb/orgs", "repos_url": "https://api.github.com/users/salexspb/repos", "events_url": "https://api.github.com/users/salexspb/events{/privacy}", "received_events_url": "https://api.github.com/users/salexspb/received_events", "type": "User", "site_admin": false}, "body": "else if", "created_at": "2018-05-30T00:30:44Z", "updated_at": "2018-11-23T15:44:42Z", "html_url": "https://github.com/pytorch/pytorch/pull/7931#discussion_r191613855", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/7931", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/191613855"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/7931#discussion_r191613855"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/7931"}}, "body_html": "<p>else if</p>", "body_text": "else if"}