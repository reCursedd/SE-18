{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/159056263", "pull_request_review_id": 85949035, "id": 159056263, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE1OTA1NjI2Mw==", "diff_hunk": "@@ -61,10 +62,57 @@ def patch(obj, attr_name, val):\n             finally:\n                 setattr(obj, attr_name, orig_val)\n \n-        orig_compile = distutils.unixccompiler.UnixCCompiler._compile\n-        orig_link = distutils.unixccompiler.UnixCCompiler.link\n+        if self.compiler.compiler_type == 'msvc':\n+            import distutils.msvccompiler\n+            import distutils.msvc9compiler\n+            if sys.version[0] == 2:\n+                orig_compiler = distutils.msvc9compiler.MSVCCompiler\n+            else:\n+                orig_compiler = distutils._msvccompiler.MSVCCompiler\n+            orig_compile = orig_compiler.compile\n+            orig_link = orig_compiler.link\n+            orig_spawn = orig_compiler.spawn\n+        else:\n+            orig_compiler = distutils.unixccompiler.UnixCCompiler\n+            orig_compile = orig_compiler._compile\n+            orig_link = orig_compiler.link\n+\n+        def win_compile(self, sources,\n+                        output_dir=None, macros=None, include_dirs=None, debug=0,\n+                        extra_preargs=None, extra_postargs=None, depends=None):\n \n-        def _compile(self, obj, src, ext, cc_args, extra_postargs, pp_opts):\n+            def spawn(cmd):\n+                # Using regex to match src and obj\n+\n+                src_regex = re.compile('/T(p|c)(.*)')\n+                src_list = [m.group(2) for m in (\n+                    src_regex.match(elem) for elem in cmd) if m]\n+\n+                obj_regex = re.compile('/Fo(.*)')\n+                obj_list = [m.group(1) for m in (\n+                    obj_regex.match(elem) for elem in cmd) if m]\n+\n+                if len(src_list) >= 1 and len(obj_list) >= 1:\n+                    src = src_list[0]\n+                    obj = obj_list[0]\n+                else:\n+                    # Cannot find src or obj, revert back to original style\n+                    orig_spawn(cmd)\n+                    return\n+\n+                builder.writer.build(\n+                    [obj], 'compile', [src],\n+                    variables={\n+                        'cmd': cmd,\n+                        'deps': 'msvc'", "path": "tools/setup_helpers/ninja_builder.py", "position": 53, "original_position": 54, "commit_id": "369577127ba8c78cf42931b68058d83b3b647206", "original_commit_id": "c496e6f5bf1769547d73969a851dda307287e726", "user": {"login": "peterjc123", "id": 9998726, "node_id": "MDQ6VXNlcjk5OTg3MjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/9998726?v=4", "gravatar_id": "", "url": "https://api.github.com/users/peterjc123", "html_url": "https://github.com/peterjc123", "followers_url": "https://api.github.com/users/peterjc123/followers", "following_url": "https://api.github.com/users/peterjc123/following{/other_user}", "gists_url": "https://api.github.com/users/peterjc123/gists{/gist_id}", "starred_url": "https://api.github.com/users/peterjc123/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/peterjc123/subscriptions", "organizations_url": "https://api.github.com/users/peterjc123/orgs", "repos_url": "https://api.github.com/users/peterjc123/repos", "events_url": "https://api.github.com/users/peterjc123/events{/privacy}", "received_events_url": "https://api.github.com/users/peterjc123/received_events", "type": "User", "site_admin": false}, "body": "@apaszke [This](https://ninja-build.org/manual.html#_deps) is the discussion about it in the manual of Ninja build. The flag `deps=msvc` here has nothing to do with dependencies, it just makes the build process faster according to the description in the manual.", "created_at": "2017-12-29T12:30:46Z", "updated_at": "2018-11-23T15:37:42Z", "html_url": "https://github.com/pytorch/pytorch/pull/3993#discussion_r159056263", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/3993", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/159056263"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/3993#discussion_r159056263"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/3993"}}, "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=4583066\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/apaszke\">@apaszke</a> <a href=\"https://ninja-build.org/manual.html#_deps\" rel=\"nofollow\">This</a> is the discussion about it in the manual of Ninja build. The flag <code>deps=msvc</code> here has nothing to do with dependencies, it just makes the build process faster according to the description in the manual.</p>", "body_text": "@apaszke This is the discussion about it in the manual of Ninja build. The flag deps=msvc here has nothing to do with dependencies, it just makes the build process faster according to the description in the manual.", "in_reply_to_id": 159041928}