{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/14253", "id": 232492842, "node_id": "MDExOlB1bGxSZXF1ZXN0MjMyNDkyODQy", "html_url": "https://github.com/pytorch/pytorch/pull/14253", "diff_url": "https://github.com/pytorch/pytorch/pull/14253.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/14253.patch", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/14253", "number": 14253, "state": "closed", "locked": false, "title": "Option to preserve bitwise accuracy of gradient checkpointed vs non-checkpointed dropout", "user": {"login": "mcarilli", "id": 7799218, "node_id": "MDQ6VXNlcjc3OTkyMTg=", "avatar_url": "https://avatars0.githubusercontent.com/u/7799218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarilli", "html_url": "https://github.com/mcarilli", "followers_url": "https://api.github.com/users/mcarilli/followers", "following_url": "https://api.github.com/users/mcarilli/following{/other_user}", "gists_url": "https://api.github.com/users/mcarilli/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarilli/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarilli/subscriptions", "organizations_url": "https://api.github.com/users/mcarilli/orgs", "repos_url": "https://api.github.com/users/mcarilli/repos", "events_url": "https://api.github.com/users/mcarilli/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarilli/received_events", "type": "User", "site_admin": false}, "body": "This issue was noticed, and fix proposed, by @raulpuric.\r\n\r\nCheckpointing is implemented by rerunning a forward-pass segment for each checkpointed segment during backward.  This can result in the RNG state advancing more than it would without checkpointing, which can cause checkpoints that include dropout invocations to lose end-to-end bitwise accuracy as compared to non-checkpointed passes.  \r\n\r\nThe present PR contains optional logic to juggle the RNG states such that checkpointed passes containing dropout achieve bitwise accuracy with non-checkpointed equivalents.**  The user requests this behavior by supplying `preserve_rng_state=True` to `torch.utils.checkpoint` or `torch.utils.checkpoint_sequential`.\r\n\r\nCurrently, `preserve_rng_state=True` may incur a moderate performance hit because restoring MTGP states can be expensive.  However, restoring Philox states is dirt cheap, so @syed-ahmed's [RNG refactor](https://github.com/pytorch/pytorch/pull/13070#discussion_r235179882), once merged, will make this option more or less free.\r\n\r\nI'm a little wary of the [def checkpoint(function, *args, preserve_rng_state=False):](https://github.com/pytorch/pytorch/pull/14253/files#diff-58da227fc9b1d56752b7dfad90428fe0R75) argument-passing method (specifically, putting a kwarg after a variable argument list).  Python 3 seems happy with it.\r\nEdit:  It appears Python 2.7 is NOT happy with a [kwarg after *args](https://travis-ci.org/pytorch/pytorch/builds/457706518?utm_source=github_status&utm_medium=notification).  `preserve_rng_state` also needs to be communicated in a way that doesn't break any existing usage.  I'm open to suggestions (a global flag perhaps)?\r\n\r\n\r\n**Batchnorm may still be an issue, but that's a battle for another day.", "created_at": "2018-11-20T23:33:00Z", "updated_at": "2018-11-23T16:11:20Z", "closed_at": "2018-11-23T16:11:20Z", "merged_at": null, "merge_commit_sha": "552df25a2581bf1575dc08ab25d57486129ef680", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "commits_url": "https://api.github.com/repos/pytorch/pytorch/pulls/14253/commits", "review_comments_url": "https://api.github.com/repos/pytorch/pytorch/pulls/14253/comments", "review_comment_url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/14253/comments", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/59515c827f6d7ddbef509e5bcf199b0ee1308297", "head": {"label": "mcarilli:checkpointing_preserve_rng_state", "ref": "checkpointing_preserve_rng_state", "sha": "59515c827f6d7ddbef509e5bcf199b0ee1308297", "user": {"login": "mcarilli", "id": 7799218, "node_id": "MDQ6VXNlcjc3OTkyMTg=", "avatar_url": "https://avatars0.githubusercontent.com/u/7799218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarilli", "html_url": "https://github.com/mcarilli", "followers_url": "https://api.github.com/users/mcarilli/followers", "following_url": "https://api.github.com/users/mcarilli/following{/other_user}", "gists_url": "https://api.github.com/users/mcarilli/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarilli/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarilli/subscriptions", "organizations_url": "https://api.github.com/users/mcarilli/orgs", "repos_url": "https://api.github.com/users/mcarilli/repos", "events_url": "https://api.github.com/users/mcarilli/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarilli/received_events", "type": "User", "site_admin": false}, "repo": {"id": 154756068, "node_id": "MDEwOlJlcG9zaXRvcnkxNTQ3NTYwNjg=", "name": "pytorch", "full_name": "mcarilli/pytorch", "private": false, "owner": {"login": "mcarilli", "id": 7799218, "node_id": "MDQ6VXNlcjc3OTkyMTg=", "avatar_url": "https://avatars0.githubusercontent.com/u/7799218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarilli", "html_url": "https://github.com/mcarilli", "followers_url": "https://api.github.com/users/mcarilli/followers", "following_url": "https://api.github.com/users/mcarilli/following{/other_user}", "gists_url": "https://api.github.com/users/mcarilli/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarilli/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarilli/subscriptions", "organizations_url": "https://api.github.com/users/mcarilli/orgs", "repos_url": "https://api.github.com/users/mcarilli/repos", "events_url": "https://api.github.com/users/mcarilli/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarilli/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/mcarilli/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": true, "url": "https://api.github.com/repos/mcarilli/pytorch", "forks_url": "https://api.github.com/repos/mcarilli/pytorch/forks", "keys_url": "https://api.github.com/repos/mcarilli/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/mcarilli/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/mcarilli/pytorch/teams", "hooks_url": "https://api.github.com/repos/mcarilli/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/mcarilli/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/mcarilli/pytorch/events", "assignees_url": "https://api.github.com/repos/mcarilli/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/mcarilli/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/mcarilli/pytorch/tags", "blobs_url": "https://api.github.com/repos/mcarilli/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/mcarilli/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/mcarilli/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/mcarilli/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/mcarilli/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/mcarilli/pytorch/languages", "stargazers_url": "https://api.github.com/repos/mcarilli/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/mcarilli/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/mcarilli/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/mcarilli/pytorch/subscription", "commits_url": "https://api.github.com/repos/mcarilli/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/mcarilli/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/mcarilli/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/mcarilli/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/mcarilli/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/mcarilli/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/mcarilli/pytorch/merges", "archive_url": "https://api.github.com/repos/mcarilli/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/mcarilli/pytorch/downloads", "issues_url": "https://api.github.com/repos/mcarilli/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/mcarilli/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/mcarilli/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/mcarilli/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/mcarilli/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/mcarilli/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/mcarilli/pytorch/deployments", "created_at": "2018-10-26T00:47:39Z", "updated_at": "2018-10-26T00:47:53Z", "pushed_at": "2018-11-21T22:22:36Z", "git_url": "git://github.com/mcarilli/pytorch.git", "ssh_url": "git@github.com:mcarilli/pytorch.git", "clone_url": "https://github.com/mcarilli/pytorch.git", "svn_url": "https://github.com/mcarilli/pytorch", "homepage": "http://pytorch.org", "size": 88212, "stargazers_count": 0, "watchers_count": 0, "language": "C++", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 0, "mirror_url": null, "archived": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "pytorch:master", "ref": "master", "sha": "d6bfc53b9e31fe2201c2a4025c8a0ffc7c093088", "user": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 65600975, "node_id": "MDEwOlJlcG9zaXRvcnk2NTYwMDk3NQ==", "name": "pytorch", "full_name": "pytorch/pytorch", "private": false, "owner": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/pytorch/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": false, "url": "https://api.github.com/repos/pytorch/pytorch", "forks_url": "https://api.github.com/repos/pytorch/pytorch/forks", "keys_url": "https://api.github.com/repos/pytorch/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/pytorch/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/pytorch/pytorch/teams", "hooks_url": "https://api.github.com/repos/pytorch/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/pytorch/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/pytorch/pytorch/events", "assignees_url": "https://api.github.com/repos/pytorch/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/pytorch/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/pytorch/pytorch/tags", "blobs_url": "https://api.github.com/repos/pytorch/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/pytorch/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/pytorch/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/pytorch/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/pytorch/pytorch/languages", "stargazers_url": "https://api.github.com/repos/pytorch/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/pytorch/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/pytorch/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/pytorch/pytorch/subscription", "commits_url": "https://api.github.com/repos/pytorch/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/pytorch/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/pytorch/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/pytorch/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/pytorch/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/pytorch/pytorch/merges", "archive_url": "https://api.github.com/repos/pytorch/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/pytorch/pytorch/downloads", "issues_url": "https://api.github.com/repos/pytorch/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/pytorch/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/pytorch/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/pytorch/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/pytorch/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/pytorch/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/pytorch/pytorch/deployments", "created_at": "2016-08-13T05:26:41Z", "updated_at": "2018-11-24T05:35:41Z", "pushed_at": "2018-11-24T05:34:07Z", "git_url": "git://github.com/pytorch/pytorch.git", "ssh_url": "git@github.com:pytorch/pytorch.git", "clone_url": "https://github.com/pytorch/pytorch.git", "svn_url": "https://github.com/pytorch/pytorch", "homepage": "http://pytorch.org", "size": 89651, "stargazers_count": 21577, "watchers_count": 21577, "language": "C++", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 5149, "mirror_url": null, "archived": false, "open_issues_count": 2193, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 5149, "open_issues": 2193, "watchers": 21577, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/14253"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/14253"}, "issue": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/14253"}, "comments": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/14253/comments"}, "review_comments": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/14253/comments"}, "review_comment": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/14253/commits"}, "statuses": {"href": "https://api.github.com/repos/pytorch/pytorch/statuses/59515c827f6d7ddbef509e5bcf199b0ee1308297"}}, "author_association": "CONTRIBUTOR", "body_html": "<p>This issue was noticed, and fix proposed, by <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=9101033\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/raulpuric\">@raulpuric</a>.</p>\n<p>Checkpointing is implemented by rerunning a forward-pass segment for each checkpointed segment during backward.  This can result in the RNG state advancing more than it would without checkpointing, which can cause checkpoints that include dropout invocations to lose end-to-end bitwise accuracy as compared to non-checkpointed passes.</p>\n<p>The present PR contains optional logic to juggle the RNG states such that checkpointed passes containing dropout achieve bitwise accuracy with non-checkpointed equivalents.**  The user requests this behavior by supplying <code>preserve_rng_state=True</code> to <code>torch.utils.checkpoint</code> or <code>torch.utils.checkpoint_sequential</code>.</p>\n<p>Currently, <code>preserve_rng_state=True</code> may incur a moderate performance hit because restoring MTGP states can be expensive.  However, restoring Philox states is dirt cheap, so <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=8906225\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/syed-ahmed\">@syed-ahmed</a>'s <a href=\"https://github.com/pytorch/pytorch/pull/13070#discussion_r235179882\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/13070/hovercard\">RNG refactor</a>, once merged, will make this option more or less free.</p>\n<p>I'm a little wary of the <a href=\"https://github.com/pytorch/pytorch/pull/14253/files#diff-58da227fc9b1d56752b7dfad90428fe0R75\">def checkpoint(function, *args, preserve_rng_state=False):</a> argument-passing method (specifically, putting a kwarg after a variable argument list).  Python 3 seems happy with it.<br>\nEdit:  It appears Python 2.7 is NOT happy with a <a href=\"https://travis-ci.org/pytorch/pytorch/builds/457706518?utm_source=github_status&amp;utm_medium=notification\" rel=\"nofollow\">kwarg after *args</a>.  <code>preserve_rng_state</code> also needs to be communicated in a way that doesn't break any existing usage.  I'm open to suggestions (a global flag perhaps)?</p>\n<p>**Batchnorm may still be an issue, but that's a battle for another day.</p>", "body_text": "This issue was noticed, and fix proposed, by @raulpuric.\nCheckpointing is implemented by rerunning a forward-pass segment for each checkpointed segment during backward.  This can result in the RNG state advancing more than it would without checkpointing, which can cause checkpoints that include dropout invocations to lose end-to-end bitwise accuracy as compared to non-checkpointed passes.\nThe present PR contains optional logic to juggle the RNG states such that checkpointed passes containing dropout achieve bitwise accuracy with non-checkpointed equivalents.**  The user requests this behavior by supplying preserve_rng_state=True to torch.utils.checkpoint or torch.utils.checkpoint_sequential.\nCurrently, preserve_rng_state=True may incur a moderate performance hit because restoring MTGP states can be expensive.  However, restoring Philox states is dirt cheap, so @syed-ahmed's RNG refactor, once merged, will make this option more or less free.\nI'm a little wary of the def checkpoint(function, *args, preserve_rng_state=False): argument-passing method (specifically, putting a kwarg after a variable argument list).  Python 3 seems happy with it.\nEdit:  It appears Python 2.7 is NOT happy with a kwarg after *args.  preserve_rng_state also needs to be communicated in a way that doesn't break any existing usage.  I'm open to suggestions (a global flag perhaps)?\n**Batchnorm may still be an issue, but that's a battle for another day.", "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 0, "review_comments": 13, "maintainer_can_modify": false, "commits": 6, "additions": 108, "deletions": 3, "changed_files": 3}