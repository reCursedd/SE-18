{"url": "https://api.github.com/repos/pytorch/pytorch/issues/9375", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/9375/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/9375/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/9375/events", "html_url": "https://github.com/pytorch/pytorch/issues/9375", "id": 340482936, "node_id": "MDU6SXNzdWUzNDA0ODI5MzY=", "number": 9375, "title": "[Caffe2] Not handle attribute 'spatial' of ONNX operator 'BatchNormalization'", "user": {"login": "rockindy", "id": 37647490, "node_id": "MDQ6VXNlcjM3NjQ3NDkw", "avatar_url": "https://avatars2.githubusercontent.com/u/37647490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rockindy", "html_url": "https://github.com/rockindy", "followers_url": "https://api.github.com/users/rockindy/followers", "following_url": "https://api.github.com/users/rockindy/following{/other_user}", "gists_url": "https://api.github.com/users/rockindy/gists{/gist_id}", "starred_url": "https://api.github.com/users/rockindy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rockindy/subscriptions", "organizations_url": "https://api.github.com/users/rockindy/orgs", "repos_url": "https://api.github.com/users/rockindy/repos", "events_url": "https://api.github.com/users/rockindy/events{/privacy}", "received_events_url": "https://api.github.com/users/rockindy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-07-12T04:12:05Z", "updated_at": "2018-07-17T16:36:57Z", "closed_at": null, "author_association": "NONE", "body_html": "<h2>Issue description</h2>\n<p>If I run a ONNX model contains 'BatchNormalization' operator and it has 'spatial' attribute, caffe2 will give me an error message:</p>\n<pre><code>terminate called after throwing an instance of 'caffe2::EnforceNotMet'\n  what():  [enforce fail at backend.cc:1057] . Don't know how to map unexpected argument spatial (from operator SpatialBN)\n</code></pre>\n<p>I found that caffe2 do not handle attribute 'spatial' in Caffe2Backend::CreateBatchNormalization:</p>\n<div class=\"highlight highlight-source-c++\"><pre>Caffe2Ops <span class=\"pl-en\">Caffe2Backend::CreateBatchNormalization</span>(\n    OnnxNode* onnx_node,\n    <span class=\"pl-k\">int</span> opset_version) {\n  <span class=\"pl-k\">if</span> (opset_version &lt; <span class=\"pl-c1\">6</span>) { \n    <span class=\"pl-k\">auto</span>&amp; attributes = onnx_node-&gt;<span class=\"pl-smi\">attributes</span>;\n    attributes.<span class=\"pl-c1\">remove</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>consumed_inputs<span class=\"pl-pds\">\"</span></span>);\n  }\n\n  <span class=\"pl-k\">if</span> (opset_version &gt;= <span class=\"pl-c1\">7</span>) { \n    <span class=\"pl-k\">auto</span>&amp; attributes = onnx_node-&gt;<span class=\"pl-smi\">attributes</span>;\n    <span class=\"pl-k\">auto</span>* attr = attributes.<span class=\"pl-c1\">AddRewrittenAttribute</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>is_test<span class=\"pl-pds\">\"</span></span>);\n    attr-&gt;<span class=\"pl-c1\">set_i</span>(<span class=\"pl-c1\">1</span>);\n  }\n\n  <span class=\"pl-k\">return</span> <span class=\"pl-c1\">CommonOnnxNodeToCaffe2Ops</span>(onnx_node, opset_version);\n}</pre></div>", "body_text": "Issue description\nIf I run a ONNX model contains 'BatchNormalization' operator and it has 'spatial' attribute, caffe2 will give me an error message:\nterminate called after throwing an instance of 'caffe2::EnforceNotMet'\n  what():  [enforce fail at backend.cc:1057] . Don't know how to map unexpected argument spatial (from operator SpatialBN)\n\nI found that caffe2 do not handle attribute 'spatial' in Caffe2Backend::CreateBatchNormalization:\nCaffe2Ops Caffe2Backend::CreateBatchNormalization(\n    OnnxNode* onnx_node,\n    int opset_version) {\n  if (opset_version < 6) { \n    auto& attributes = onnx_node->attributes;\n    attributes.remove(\"consumed_inputs\");\n  }\n\n  if (opset_version >= 7) { \n    auto& attributes = onnx_node->attributes;\n    auto* attr = attributes.AddRewrittenAttribute(\"is_test\");\n    attr->set_i(1);\n  }\n\n  return CommonOnnxNodeToCaffe2Ops(onnx_node, opset_version);\n}", "body": "## Issue description\r\n\r\nIf I run a ONNX model contains 'BatchNormalization' operator and it has 'spatial' attribute, caffe2 will give me an error message:\r\n```\r\nterminate called after throwing an instance of 'caffe2::EnforceNotMet'\r\n  what():  [enforce fail at backend.cc:1057] . Don't know how to map unexpected argument spatial (from operator SpatialBN)\r\n```\r\n\r\nI found that caffe2 do not handle attribute 'spatial' in Caffe2Backend::CreateBatchNormalization:\r\n```C++\r\nCaffe2Ops Caffe2Backend::CreateBatchNormalization(\r\n    OnnxNode* onnx_node,\r\n    int opset_version) {\r\n  if (opset_version < 6) { \r\n    auto& attributes = onnx_node->attributes;\r\n    attributes.remove(\"consumed_inputs\");\r\n  }\r\n\r\n  if (opset_version >= 7) { \r\n    auto& attributes = onnx_node->attributes;\r\n    auto* attr = attributes.AddRewrittenAttribute(\"is_test\");\r\n    attr->set_i(1);\r\n  }\r\n\r\n  return CommonOnnxNodeToCaffe2Ops(onnx_node, opset_version);\r\n}\r\n```\r\n"}