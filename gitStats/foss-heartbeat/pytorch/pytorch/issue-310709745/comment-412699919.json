{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/412699919", "html_url": "https://github.com/pytorch/pytorch/issues/6219#issuecomment-412699919", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/6219", "id": 412699919, "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjY5OTkxOQ==", "user": {"login": "weiyangfb", "id": 38509346, "node_id": "MDQ6VXNlcjM4NTA5MzQ2", "avatar_url": "https://avatars1.githubusercontent.com/u/38509346?v=4", "gravatar_id": "", "url": "https://api.github.com/users/weiyangfb", "html_url": "https://github.com/weiyangfb", "followers_url": "https://api.github.com/users/weiyangfb/followers", "following_url": "https://api.github.com/users/weiyangfb/following{/other_user}", "gists_url": "https://api.github.com/users/weiyangfb/gists{/gist_id}", "starred_url": "https://api.github.com/users/weiyangfb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/weiyangfb/subscriptions", "organizations_url": "https://api.github.com/users/weiyangfb/orgs", "repos_url": "https://api.github.com/users/weiyangfb/repos", "events_url": "https://api.github.com/users/weiyangfb/events{/privacy}", "received_events_url": "https://api.github.com/users/weiyangfb/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-13T23:27:49Z", "updated_at": "2018-08-14T00:31:49Z", "author_association": "CONTRIBUTOR", "body_html": "<p>This issue is caused by the following:</p>\n<ul>\n<li><code>t()</code> because it swaps the indices of a sparse tensor without setting <code>coalesce=false</code></li>\n<li>calling <code>coalesce()</code> sets <code>coalesce=true</code></li>\n<li><code>mm(Sparse, Dense)</code> doesn't really sort the sparse tensor - the <a href=\"https://github.com/pytorch/pytorch/blob/216961b7bf59577cee7d3e47c2eef6243ae187d8/aten/src/ATen/native/sparse/SparseTensorMath.cpp#L528\">call to <code>coalesce()</code></a> doesn't do anything.</li>\n</ul>\n<p><del>A simple fix will be to set <code>coalesce=false</code> at <code>t()</code></del></p>\n<p><del>This is related to the invariants of <code>transpose()</code>: <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"289316757\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/4707\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/pytorch/pytorch/pull/4707/hovercard\" href=\"https://github.com/pytorch/pytorch/pull/4707\">#4707</a>, maybe should change <code>coalesce</code> slight to get around it.</del></p>\n<p>After chatted to <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=5652049\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/zou3519\">@zou3519</a>, we can define a sparse tensor with coalesced=true when:</p>\n<ol>\n<li>its elements are unique and</li>\n<li>the indices are in sorted order</li>\n</ol>\n<p>And set <code>coalesce=false</code> whenever the conditions are not held, e.g. <code>t()</code>. This should solve the issue.</p>", "body_text": "This issue is caused by the following:\n\nt() because it swaps the indices of a sparse tensor without setting coalesce=false\ncalling coalesce() sets coalesce=true\nmm(Sparse, Dense) doesn't really sort the sparse tensor - the call to coalesce() doesn't do anything.\n\nA simple fix will be to set coalesce=false at t()\nThis is related to the invariants of transpose(): #4707, maybe should change coalesce slight to get around it.\nAfter chatted to @zou3519, we can define a sparse tensor with coalesced=true when:\n\nits elements are unique and\nthe indices are in sorted order\n\nAnd set coalesce=false whenever the conditions are not held, e.g. t(). This should solve the issue.", "body": "This issue is caused by the following:\r\n- `t()` because it swaps the indices of a sparse tensor without setting `coalesce=false`\r\n- calling `coalesce()` sets `coalesce=true`\r\n- `mm(Sparse, Dense)` doesn't really sort the sparse tensor - the [call to `coalesce()`](https://github.com/pytorch/pytorch/blob/216961b7bf59577cee7d3e47c2eef6243ae187d8/aten/src/ATen/native/sparse/SparseTensorMath.cpp#L528) doesn't do anything.\r\n\r\n~~A simple fix will be to set `coalesce=false` at `t()`~~\r\n\r\n~~This is related to the invariants of `transpose()`: https://github.com/pytorch/pytorch/pull/4707, maybe should change `coalesce` slight to get around it.~~\r\n\r\nAfter chatted to @zou3519, we can define a sparse tensor with coalesced=true when:\r\n1) its elements are unique and \r\n2) the indices are in sorted order\r\n\r\nAnd set `coalesce=false` whenever the conditions are not held, e.g. `t()`. This should solve the issue."}