{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/440148159", "html_url": "https://github.com/pytorch/pytorch/issues/8978#issuecomment-440148159", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/8978", "id": 440148159, "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MDE0ODE1OQ==", "user": {"login": "kwon-young", "id": 2647934, "node_id": "MDQ6VXNlcjI2NDc5MzQ=", "avatar_url": "https://avatars1.githubusercontent.com/u/2647934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kwon-young", "html_url": "https://github.com/kwon-young", "followers_url": "https://api.github.com/users/kwon-young/followers", "following_url": "https://api.github.com/users/kwon-young/following{/other_user}", "gists_url": "https://api.github.com/users/kwon-young/gists{/gist_id}", "starred_url": "https://api.github.com/users/kwon-young/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kwon-young/subscriptions", "organizations_url": "https://api.github.com/users/kwon-young/orgs", "repos_url": "https://api.github.com/users/kwon-young/repos", "events_url": "https://api.github.com/users/kwon-young/events{/privacy}", "received_events_url": "https://api.github.com/users/kwon-young/received_events", "type": "User", "site_admin": false}, "created_at": "2018-11-20T05:40:25Z", "updated_at": "2018-11-20T05:41:12Z", "author_association": "NONE", "body_html": "<p>Thank you <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=1310570\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/soumith\">@soumith</a> for your fast reply!<br>\nI can confirm that using PyTorch 1.0 preview build doesn't raise the RuntimeError anymore.<br>\nHowever, trying to export the model using onnx doesn't work:</p>\n<pre><code>torch.Size([16, 1, 64, 64])\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py:501: UserWarning: ONNX export failed on ATen operator grid_sampler because torch.onnx.symbolic.grid_sampler does not exist\n  .format(op_name, op_name))\nTraceback (most recent call last):\n  File \"test.py\", line 59, in &lt;module&gt;\n    torch.onnx.export(net, torch.rand(16, 1, 64, 64), \"mymodel\", export_params=True)\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/__init__.py\", line 27, in export\n    return utils.export(*args, **kwargs)\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py\", line 104, in export\n    operator_export_type=operator_export_type)\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py\", line 287, in _export\n    proto, export_map = graph.export(params, _onnx_opset_version, defer_weight_export, operator_export_type)\nRuntimeError: ONNX export failed: Couldn't export Python operator AffineGridGenerator\n\nDefined at:\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/_functions/vision.py(14): affine_grid_generator\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/functional.py(2348): affine_grid\ntest.py(42): forward\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(467): _slow_forward\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(477): __call__\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/jit/__init__.py(225): forward\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(479): __call__\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/jit/__init__.py(172): get_trace_graph\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(192): _trace_and_get_graph_from_model\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(224): _model_to_graph\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(281): _export\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(104): export\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/__init__.py(27): export\ntest.py(59): &lt;module&gt;\n\n\nGraph we tried to export:\ngraph(%x : Float(16, 1, 64, 64)\n      %1 : Float(8, 1, 5, 5)\n      %2 : Float(16, 8, 5, 5)\n      %3 : Float(32, 1024)\n      %4 : Float(32)\n      %5 : Float(6, 32)\n      %6 : Float(6)) {\n  %7 : Float(16, 8, 60, 60) = onnx::Conv[dilations=[1, 1], group=1, kernel_shape=[5, 5], pads=[0, 0, 0, 0], strides=[1, 1]](%x, %1), scope: STN/Localizer[localizer]/Conv2d[conv1]\n  %8 : Float(16, 8, 20, 20) = onnx::MaxPool[kernel_shape=[3, 3], pads=[0, 0, 0, 0], strides=[3, 3]](%7), scope: STN/Localizer[localizer]\n  %9 : Float(16, 8, 20, 20) = onnx::Relu(%8), scope: STN/Localizer[localizer]\n  %10 : Float(16, 16, 16, 16) = onnx::Conv[dilations=[1, 1], group=1, kernel_shape=[5, 5], pads=[0, 0, 0, 0], strides=[1, 1]](%9, %2), scope: STN/Localizer[localizer]/Conv2d[conv2]\n  %11 : Float(16, 16, 8, 8) = onnx::MaxPool[kernel_shape=[2, 2], pads=[0, 0, 0, 0], strides=[2, 2]](%10), scope: STN/Localizer[localizer]\n  %12 : Float(16, 16, 8, 8) = onnx::Relu(%11), scope: STN/Localizer[localizer]\n  %13 : Dynamic = onnx::Constant[value=   -1  1024 [ CPULongType{2} ]](), scope: STN/Localizer[localizer]\n  %14 : Float(16, 1024) = onnx::Reshape(%12, %13), scope: STN/Localizer[localizer]\n  %15 : Float(16, 32) = onnx::Gemm[alpha=1, beta=1, transB=1](%14, %3, %4), scope: STN/Localizer[localizer]/Linear[fc1]\n  %16 : Float(16, 32) = onnx::Relu(%15), scope: STN/Localizer[localizer]\n  %17 : Float(16, 6) = onnx::Gemm[alpha=1, beta=1, transB=1](%16, %5, %6), scope: STN/Localizer[localizer]/Linear[fc2]\n  %18 : Dynamic = onnx::Constant[value=-1  2  3 [ CPULongType{3} ]](), scope: STN/Localizer[localizer]\n  %19 : Float(16, 2, 3) = onnx::Reshape(%17, %18), scope: STN/Localizer[localizer]\n  %20 : Dynamic = onnx::Constant[value=-1  2  3 [ CPULongType{3} ]](), scope: STN\n  %21 : Float(16, 2, 3) = onnx::Reshape(%19, %20), scope: STN\n  %grid : Float(16, 64, 64, 2) = ^AffineGridGenerator((tensor(16), tensor(1), tensor(64), tensor(64)))(%21), scope: STN\n  %23 : Long() = onnx::Constant[value={0}](), scope: STN\n  %24 : Long() = onnx::Constant[value={0}](), scope: STN\n  %25 : Float(16, 1, 64, 64) = aten::grid_sampler(%x, %grid, %23, %24), scope: STN\n  return (%25);\n}\n</code></pre>\n<p>It seems that it is because the AffineGridGenerator is not a supported operator.<br>\nWill this operator be implemented eventually?</p>", "body_text": "Thank you @soumith for your fast reply!\nI can confirm that using PyTorch 1.0 preview build doesn't raise the RuntimeError anymore.\nHowever, trying to export the model using onnx doesn't work:\ntorch.Size([16, 1, 64, 64])\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py:501: UserWarning: ONNX export failed on ATen operator grid_sampler because torch.onnx.symbolic.grid_sampler does not exist\n  .format(op_name, op_name))\nTraceback (most recent call last):\n  File \"test.py\", line 59, in <module>\n    torch.onnx.export(net, torch.rand(16, 1, 64, 64), \"mymodel\", export_params=True)\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/__init__.py\", line 27, in export\n    return utils.export(*args, **kwargs)\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py\", line 104, in export\n    operator_export_type=operator_export_type)\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py\", line 287, in _export\n    proto, export_map = graph.export(params, _onnx_opset_version, defer_weight_export, operator_export_type)\nRuntimeError: ONNX export failed: Couldn't export Python operator AffineGridGenerator\n\nDefined at:\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/_functions/vision.py(14): affine_grid_generator\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/functional.py(2348): affine_grid\ntest.py(42): forward\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(467): _slow_forward\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(477): __call__\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/jit/__init__.py(225): forward\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(479): __call__\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/jit/__init__.py(172): get_trace_graph\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(192): _trace_and_get_graph_from_model\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(224): _model_to_graph\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(281): _export\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(104): export\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/__init__.py(27): export\ntest.py(59): <module>\n\n\nGraph we tried to export:\ngraph(%x : Float(16, 1, 64, 64)\n      %1 : Float(8, 1, 5, 5)\n      %2 : Float(16, 8, 5, 5)\n      %3 : Float(32, 1024)\n      %4 : Float(32)\n      %5 : Float(6, 32)\n      %6 : Float(6)) {\n  %7 : Float(16, 8, 60, 60) = onnx::Conv[dilations=[1, 1], group=1, kernel_shape=[5, 5], pads=[0, 0, 0, 0], strides=[1, 1]](%x, %1), scope: STN/Localizer[localizer]/Conv2d[conv1]\n  %8 : Float(16, 8, 20, 20) = onnx::MaxPool[kernel_shape=[3, 3], pads=[0, 0, 0, 0], strides=[3, 3]](%7), scope: STN/Localizer[localizer]\n  %9 : Float(16, 8, 20, 20) = onnx::Relu(%8), scope: STN/Localizer[localizer]\n  %10 : Float(16, 16, 16, 16) = onnx::Conv[dilations=[1, 1], group=1, kernel_shape=[5, 5], pads=[0, 0, 0, 0], strides=[1, 1]](%9, %2), scope: STN/Localizer[localizer]/Conv2d[conv2]\n  %11 : Float(16, 16, 8, 8) = onnx::MaxPool[kernel_shape=[2, 2], pads=[0, 0, 0, 0], strides=[2, 2]](%10), scope: STN/Localizer[localizer]\n  %12 : Float(16, 16, 8, 8) = onnx::Relu(%11), scope: STN/Localizer[localizer]\n  %13 : Dynamic = onnx::Constant[value=   -1  1024 [ CPULongType{2} ]](), scope: STN/Localizer[localizer]\n  %14 : Float(16, 1024) = onnx::Reshape(%12, %13), scope: STN/Localizer[localizer]\n  %15 : Float(16, 32) = onnx::Gemm[alpha=1, beta=1, transB=1](%14, %3, %4), scope: STN/Localizer[localizer]/Linear[fc1]\n  %16 : Float(16, 32) = onnx::Relu(%15), scope: STN/Localizer[localizer]\n  %17 : Float(16, 6) = onnx::Gemm[alpha=1, beta=1, transB=1](%16, %5, %6), scope: STN/Localizer[localizer]/Linear[fc2]\n  %18 : Dynamic = onnx::Constant[value=-1  2  3 [ CPULongType{3} ]](), scope: STN/Localizer[localizer]\n  %19 : Float(16, 2, 3) = onnx::Reshape(%17, %18), scope: STN/Localizer[localizer]\n  %20 : Dynamic = onnx::Constant[value=-1  2  3 [ CPULongType{3} ]](), scope: STN\n  %21 : Float(16, 2, 3) = onnx::Reshape(%19, %20), scope: STN\n  %grid : Float(16, 64, 64, 2) = ^AffineGridGenerator((tensor(16), tensor(1), tensor(64), tensor(64)))(%21), scope: STN\n  %23 : Long() = onnx::Constant[value={0}](), scope: STN\n  %24 : Long() = onnx::Constant[value={0}](), scope: STN\n  %25 : Float(16, 1, 64, 64) = aten::grid_sampler(%x, %grid, %23, %24), scope: STN\n  return (%25);\n}\n\nIt seems that it is because the AffineGridGenerator is not a supported operator.\nWill this operator be implemented eventually?", "body": "Thank you @soumith for your fast reply!\r\nI can confirm that using PyTorch 1.0 preview build doesn't raise the RuntimeError anymore.\r\nHowever, trying to export the model using onnx doesn't work:\r\n```\r\ntorch.Size([16, 1, 64, 64])\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py:501: UserWarning: ONNX export failed on ATen operator grid_sampler because torch.onnx.symbolic.grid_sampler does not exist\r\n  .format(op_name, op_name))\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 59, in <module>\r\n    torch.onnx.export(net, torch.rand(16, 1, 64, 64), \"mymodel\", export_params=True)\r\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/__init__.py\", line 27, in export\r\n    return utils.export(*args, **kwargs)\r\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py\", line 104, in export\r\n    operator_export_type=operator_export_type)\r\n  File \"/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py\", line 287, in _export\r\n    proto, export_map = graph.export(params, _onnx_opset_version, defer_weight_export, operator_export_type)\r\nRuntimeError: ONNX export failed: Couldn't export Python operator AffineGridGenerator\r\n\r\nDefined at:\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/_functions/vision.py(14): affine_grid_generator\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/functional.py(2348): affine_grid\r\ntest.py(42): forward\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(467): _slow_forward\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(477): __call__\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/jit/__init__.py(225): forward\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py(479): __call__\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/jit/__init__.py(172): get_trace_graph\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(192): _trace_and_get_graph_from_model\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(224): _model_to_graph\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(281): _export\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/utils.py(104): export\r\n/home/kyc/miniconda3/envs/pytorch/lib/python3.7/site-packages/torch/onnx/__init__.py(27): export\r\ntest.py(59): <module>\r\n\r\n\r\nGraph we tried to export:\r\ngraph(%x : Float(16, 1, 64, 64)\r\n      %1 : Float(8, 1, 5, 5)\r\n      %2 : Float(16, 8, 5, 5)\r\n      %3 : Float(32, 1024)\r\n      %4 : Float(32)\r\n      %5 : Float(6, 32)\r\n      %6 : Float(6)) {\r\n  %7 : Float(16, 8, 60, 60) = onnx::Conv[dilations=[1, 1], group=1, kernel_shape=[5, 5], pads=[0, 0, 0, 0], strides=[1, 1]](%x, %1), scope: STN/Localizer[localizer]/Conv2d[conv1]\r\n  %8 : Float(16, 8, 20, 20) = onnx::MaxPool[kernel_shape=[3, 3], pads=[0, 0, 0, 0], strides=[3, 3]](%7), scope: STN/Localizer[localizer]\r\n  %9 : Float(16, 8, 20, 20) = onnx::Relu(%8), scope: STN/Localizer[localizer]\r\n  %10 : Float(16, 16, 16, 16) = onnx::Conv[dilations=[1, 1], group=1, kernel_shape=[5, 5], pads=[0, 0, 0, 0], strides=[1, 1]](%9, %2), scope: STN/Localizer[localizer]/Conv2d[conv2]\r\n  %11 : Float(16, 16, 8, 8) = onnx::MaxPool[kernel_shape=[2, 2], pads=[0, 0, 0, 0], strides=[2, 2]](%10), scope: STN/Localizer[localizer]\r\n  %12 : Float(16, 16, 8, 8) = onnx::Relu(%11), scope: STN/Localizer[localizer]\r\n  %13 : Dynamic = onnx::Constant[value=   -1  1024 [ CPULongType{2} ]](), scope: STN/Localizer[localizer]\r\n  %14 : Float(16, 1024) = onnx::Reshape(%12, %13), scope: STN/Localizer[localizer]\r\n  %15 : Float(16, 32) = onnx::Gemm[alpha=1, beta=1, transB=1](%14, %3, %4), scope: STN/Localizer[localizer]/Linear[fc1]\r\n  %16 : Float(16, 32) = onnx::Relu(%15), scope: STN/Localizer[localizer]\r\n  %17 : Float(16, 6) = onnx::Gemm[alpha=1, beta=1, transB=1](%16, %5, %6), scope: STN/Localizer[localizer]/Linear[fc2]\r\n  %18 : Dynamic = onnx::Constant[value=-1  2  3 [ CPULongType{3} ]](), scope: STN/Localizer[localizer]\r\n  %19 : Float(16, 2, 3) = onnx::Reshape(%17, %18), scope: STN/Localizer[localizer]\r\n  %20 : Dynamic = onnx::Constant[value=-1  2  3 [ CPULongType{3} ]](), scope: STN\r\n  %21 : Float(16, 2, 3) = onnx::Reshape(%19, %20), scope: STN\r\n  %grid : Float(16, 64, 64, 2) = ^AffineGridGenerator((tensor(16), tensor(1), tensor(64), tensor(64)))(%21), scope: STN\r\n  %23 : Long() = onnx::Constant[value={0}](), scope: STN\r\n  %24 : Long() = onnx::Constant[value={0}](), scope: STN\r\n  %25 : Float(16, 1, 64, 64) = aten::grid_sampler(%x, %grid, %23, %24), scope: STN\r\n  return (%25);\r\n}\r\n```\r\nIt seems that it is because the AffineGridGenerator is not a supported operator.\r\nWill this operator be implemented eventually?"}