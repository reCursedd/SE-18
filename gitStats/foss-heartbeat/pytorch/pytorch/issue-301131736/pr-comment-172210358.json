{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/172210358", "pull_request_review_id": 101188089, "id": 172210358, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE3MjIxMDM1OA==", "diff_hunk": "@@ -8,3 +8,129 @@\n \n #include \"generic/serialization.cpp\"\n #include <TH/THGenerateHalfType.h>\n+\n+#include \"serialization.h\"\n+\n+ssize_t doPythonReadBuffered(PyObject* fildes, void* buf, size_t nbytes);\n+ssize_t doPythonReadInto(PyObject* fildes, void* buf, size_t nbytes);\n+ssize_t doPythonWrite(PyObject* fildes, void* buf, size_t nbytes);\n+\n+template <>\n+inline ssize_t doRead<int>(int fildes, void* buf, size_t nbytes) {\n+  return read(fildes, buf, nbytes);\n+}\n+\n+template <>\n+inline ssize_t doRead<PyObject*>(PyObject* fildes, void* buf, size_t nbytes) {\n+  // Try to use fildes.readinto() instead of fildes.read()\n+  // because it is more memory efficient.\n+  auto has_readinto = PyObject_HasAttrString(fildes, \"readinto\") == 1;\n+  if (has_readinto) {\n+    return doPythonReadInto(fildes, buf, nbytes);\n+  }\n+  return doPythonReadBuffered(fildes, buf, nbytes);\n+}\n+\n+template <>\n+inline ssize_t doWrite<int>(int fildes, void* buf, size_t nbytes) {\n+  return write(fildes, buf, nbytes);\n+}\n+\n+template <>\n+inline ssize_t doWrite<PyObject*>(PyObject* fildes, void* buf, size_t nbytes) {\n+  return doPythonWrite(fildes, buf, nbytes);\n+}\n+\n+static inline bool isUnsupportedOperation() {\n+  THPObjectPtr io(PyImport_ImportModule(\"io\"));\n+  if (!io) throw python_error();\n+  THPObjectPtr exception(PyObject_GetAttrString(io, \"UnsupportedOperation\"));\n+  if (!exception) python_error();\n+  return PyErr_ExceptionMatches(exception.get());\n+}\n+\n+// Call Python fildes.read(nbytes) and copy it to buf.\n+inline ssize_t doPythonReadBuffered(PyObject* fildes, void* buf, size_t nbytes) {\n+  const size_t buffer_size = 262144;  // 2^18\n+  size_t read_bytes = 0;\n+\n+  while (read_bytes < nbytes) {\n+    auto remaining = nbytes - read_bytes;\n+    auto to_read = remaining > buffer_size ? buffer_size : remaining;\n+    THPObjectPtr r(PyObject_CallMethod(fildes, \"read\", \"i\", to_read));\n+    if (!r) throw python_error();\n+\n+    // read output is String (Python 2) / Bytes (Python 3)\n+#if PY_MAJOR_VERSION >= 3\n+    auto size = PyBytes_GET_SIZE(r.get());\n+    const void* bytes = PyBytes_AsString(r.get());\n+#else\n+    auto size = PyString_GET_SIZE(r.get());\n+    const void* bytes = PyString_AsString(r.get());\n+#endif\n+\n+    // we read EOF\n+    if (size == 0) {\n+      return read_bytes;\n+    }\n+\n+    memcpy(reinterpret_cast<char*>(buf) + read_bytes, bytes, size);\n+    read_bytes += size;\n+  } // Reading loop\n+\n+  return read_bytes;\n+}\n+\n+// Either does fildes.readinto(buf) or fildes.write(buf)\n+static inline ssize_t doPythonIO(PyObject* fildes, void* buf, size_t nbytes, bool is_read) {\n+#if PY_MAJOR_VERSION >= 3\n+  auto rw_flag = is_read ? PyBUF_WRITE : PyBUF_READ;\n+  THPObjectPtr memview(PyMemoryView_FromMemory(\n+      reinterpret_cast<char*>(buf), nbytes, rw_flag));\n+#else\n+  // PyMemoryView_FromMemory doesn't exist in Python 2.7, so we manually\n+  // create a Py_buffer that describes the memory and create a memoryview from it.\n+  auto readonly_flag = is_read ? 1 : 0;\n+  Py_buffer pyBuf;\n+  pyBuf.buf = buf;\n+  pyBuf.obj = nullptr;\n+  pyBuf.len = (Py_ssize_t)nbytes;\n+  pyBuf.itemsize = 1;\n+  pyBuf.readonly = readonly_flag;\n+  pyBuf.ndim = 0;\n+  pyBuf.format = nullptr;\n+  pyBuf.shape = nullptr;\n+  pyBuf.strides = nullptr;\n+  pyBuf.suboffsets = nullptr;\n+  pyBuf.internal = nullptr;\n+\n+  THPObjectPtr memview(PyMemoryView_FromBuffer(&pyBuf));", "path": "torch/csrc/serialization.cpp", "position": null, "original_position": 100, "commit_id": "bdaf61fb52ecadc1e0f83be28ea738ad2635257d", "original_commit_id": "f00e98c068bee467fbdd233717d3cd2a9f8df509", "user": {"login": "zou3519", "id": 5652049, "node_id": "MDQ6VXNlcjU2NTIwNDk=", "avatar_url": "https://avatars3.githubusercontent.com/u/5652049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zou3519", "html_url": "https://github.com/zou3519", "followers_url": "https://api.github.com/users/zou3519/followers", "following_url": "https://api.github.com/users/zou3519/following{/other_user}", "gists_url": "https://api.github.com/users/zou3519/gists{/gist_id}", "starred_url": "https://api.github.com/users/zou3519/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zou3519/subscriptions", "organizations_url": "https://api.github.com/users/zou3519/orgs", "repos_url": "https://api.github.com/users/zou3519/repos", "events_url": "https://api.github.com/users/zou3519/events{/privacy}", "received_events_url": "https://api.github.com/users/zou3519/received_events", "type": "User", "site_admin": false}, "body": "Good point, I didn't catch `PyBuffer_FromReadWriteMemory` when I was going through the docs. Let me try to use it.", "created_at": "2018-03-05T14:49:53Z", "updated_at": "2018-11-23T15:40:22Z", "html_url": "https://github.com/pytorch/pytorch/pull/5466#discussion_r172210358", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/5466", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/172210358"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/5466#discussion_r172210358"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/5466"}}, "body_html": "<p>Good point, I didn't catch <code>PyBuffer_FromReadWriteMemory</code> when I was going through the docs. Let me try to use it.</p>", "body_text": "Good point, I didn't catch PyBuffer_FromReadWriteMemory when I was going through the docs. Let me try to use it.", "in_reply_to_id": 172141590}