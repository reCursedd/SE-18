{"url": "https://api.github.com/repos/pytorch/pytorch/issues/5585", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/5585/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/5585/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/5585/events", "html_url": "https://github.com/pytorch/pytorch/pull/5585", "id": 302569438, "node_id": "MDExOlB1bGxSZXF1ZXN0MTczMDYyMDAy", "number": 5585, "title": "Fix memory leak when using multiple workers on Windows", "user": {"login": "peterjc123", "id": 9998726, "node_id": "MDQ6VXNlcjk5OTg3MjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/9998726?v=4", "gravatar_id": "", "url": "https://api.github.com/users/peterjc123", "html_url": "https://github.com/peterjc123", "followers_url": "https://api.github.com/users/peterjc123/followers", "following_url": "https://api.github.com/users/peterjc123/following{/other_user}", "gists_url": "https://api.github.com/users/peterjc123/gists{/gist_id}", "starred_url": "https://api.github.com/users/peterjc123/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/peterjc123/subscriptions", "organizations_url": "https://api.github.com/users/peterjc123/orgs", "repos_url": "https://api.github.com/users/peterjc123/repos", "events_url": "https://api.github.com/users/peterjc123/events{/privacy}", "received_events_url": "https://api.github.com/users/peterjc123/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2018-03-06T05:31:56Z", "updated_at": "2018-11-23T15:41:11Z", "closed_at": "2018-03-28T08:35:29Z", "author_association": "CONTRIBUTOR", "pull_request": {"url": "https://api.github.com/repos/pytorch/pytorch/pulls/5585", "html_url": "https://github.com/pytorch/pytorch/pull/5585", "diff_url": "https://github.com/pytorch/pytorch/pull/5585.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/5585.patch"}, "body_html": "<p>The memory leak is caused by the difference in using FileMapping(mmap) on Windows. On Windows, FileMapping objects should be closed by all related processes and then it can be released. And there's no other way to explicitly delete it.(Like shm_unlink)<br>\nWhen multiprocessing is on, the child process will create a FileMapping and then the main process will open it. After that, at some time, the child process will try to release it but it's reference count is non-zero so it cannot be released at that time. But the current code does not provide a chance to let it close again when possible.<br>\nThis PR targets <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"302637847\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/5590\" data-hovercard-type=\"issue\" data-hovercard-url=\"/pytorch/pytorch/issues/5590/hovercard\" href=\"https://github.com/pytorch/pytorch/issues/5590\">#5590</a>.<br>\nCurrent Progress:<br>\nThe memory leak when num_worker=1 should be solved. However, further work has to be done for more workers.<br>\nError type 1(unrelated filemapping handle get killed):</p>\n<div class=\"highlight highlight-text-python-traceback\"><pre>Traceback (most recent call last):\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\process.py\"</span>, line <span class=\"pl-c1\">258</span>, in <span class=\"pl-en\">_bootstrap</span>\n    <span class=\"pl-c1\">self</span>.run()\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\process.py\"</span>, line <span class=\"pl-c1\">93</span>, in <span class=\"pl-en\">run</span>\n    <span class=\"pl-c1\">self</span>._target(<span class=\"pl-k\">*</span><span class=\"pl-c1\">self</span>._args, <span class=\"pl-k\">**</span><span class=\"pl-c1\">self</span>._kwargs)\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\"</span>, line <span class=\"pl-c1\">61</span>, in <span class=\"pl-en\">_worker_loop</span>\n    data_queue.put((idx, samples))\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\"</span>, line <span class=\"pl-c1\">344</span>, in <span class=\"pl-en\">put</span>\n    <span class=\"pl-c1\">self</span>._writer.send_bytes(obj)\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\connection.py\"</span>, line <span class=\"pl-c1\">200</span>, in <span class=\"pl-en\">send_bytes</span>\n    <span class=\"pl-c1\">self</span>._send_bytes(m[offset:offset <span class=\"pl-k\">+</span> size])\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\connection.py\"</span>, line <span class=\"pl-c1\">280</span>, in <span class=\"pl-en\">_send_bytes</span>\n    ov, err <span class=\"pl-k\">=</span> _winapi.WriteFile(<span class=\"pl-c1\">self</span>._handle, buf, <span class=\"pl-v\">overlapped</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">True</span>)\n<span class=\"pl-en\">OSError</span>: <span class=\"pl-s\">[WinError 6] The handle is invalid</span></pre></div>\n<p>Error type 2(unrelated event handle get killed):</p>\n<div class=\"highlight highlight-text-python-traceback\"><pre>Traceback (most recent call last):\n  File <span class=\"pl-s\">\"test.py\"</span>, line <span class=\"pl-c1\">22</span>, in <span class=\"pl-en\">&lt;module&gt;</span>\n    memory_error()\n  File <span class=\"pl-s\">\"test.py\"</span>, line <span class=\"pl-c1\">17</span>, in <span class=\"pl-en\">memory_error</span>\n    <span class=\"pl-k\">for</span> i <span class=\"pl-k\">in</span> dl:\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\"</span>, line <span class=\"pl-c1\">277</span>, in <span class=\"pl-en\">__next__</span>\n    idx, batch <span class=\"pl-k\">=</span> <span class=\"pl-c1\">self</span>._get_batch()\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\"</span>, line <span class=\"pl-c1\">256</span>, in <span class=\"pl-en\">_get_batch</span>\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">self</span>.data_queue.get()\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\"</span>, line <span class=\"pl-c1\">337</span>, in <span class=\"pl-en\">get</span>\n    <span class=\"pl-k\">return</span> _ForkingPickler.loads(res)\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\multiprocessing\\reductions.py\"</span>, line <span class=\"pl-c1\">86</span>, in <span class=\"pl-en\">rebuild_storage_filename</span>\n    storage <span class=\"pl-k\">=</span> <span class=\"pl-c1\">cls</span>._new_shared_filename(manager, handle, size)\n<span class=\"pl-en\">RuntimeError</span>: <span class=\"pl-s\">Couldn't open shared event: &lt;torch_17608_4052021606_event&gt;, error code: &lt;2&gt; at D:\\Projects\\pytorch-scripts\\pytorch\\aten\\src\\TH\\THAllocator.c:245</span>\nException ignored in: &lt;bound method DataLoaderIter.__del__ of &lt;torch.utils.data.dataloader.DataLoaderIter object at 0x000002303FB255C0&gt;&gt;\nTraceback (most recent call last):\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\"</span>, line <span class=\"pl-c1\">341</span>, in <span class=\"pl-en\">__del__</span>\n    <span class=\"pl-c1\">self</span>._shutdown_workers()\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\"</span>, line <span class=\"pl-c1\">322</span>, in <span class=\"pl-en\">_shutdown_workers</span>\n    <span class=\"pl-c1\">self</span>.data_queue.get()\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\"</span>, line <span class=\"pl-c1\">337</span>, in <span class=\"pl-en\">get</span>\n    <span class=\"pl-k\">return</span> _ForkingPickler.loads(res)\n  File <span class=\"pl-s\">\"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\multiprocessing\\reductions.py\"</span>, line <span class=\"pl-c1\">86</span>, in <span class=\"pl-en\">rebuild_storage_filename</span>\n    storage <span class=\"pl-k\">=</span> <span class=\"pl-c1\">cls</span>._new_shared_filename(manager, handle, size)\n<span class=\"pl-en\">RuntimeError</span>: <span class=\"pl-s\">Couldn't open shared event: &lt;torch_18984_3257952678_event&gt;, error code: &lt;2&gt; at D:\\Projects\\pytorch-scripts\\pytorch\\aten\\src\\TH\\THAllocator.c:245</span></pre></div>", "body_text": "The memory leak is caused by the difference in using FileMapping(mmap) on Windows. On Windows, FileMapping objects should be closed by all related processes and then it can be released. And there's no other way to explicitly delete it.(Like shm_unlink)\nWhen multiprocessing is on, the child process will create a FileMapping and then the main process will open it. After that, at some time, the child process will try to release it but it's reference count is non-zero so it cannot be released at that time. But the current code does not provide a chance to let it close again when possible.\nThis PR targets #5590.\nCurrent Progress:\nThe memory leak when num_worker=1 should be solved. However, further work has to be done for more workers.\nError type 1(unrelated filemapping handle get killed):\nTraceback (most recent call last):\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\process.py\", line 258, in _bootstrap\n    self.run()\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\process.py\", line 93, in run\n    self._target(*self._args, **self._kwargs)\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 61, in _worker_loop\n    data_queue.put((idx, samples))\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\", line 344, in put\n    self._writer.send_bytes(obj)\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\connection.py\", line 200, in send_bytes\n    self._send_bytes(m[offset:offset + size])\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\connection.py\", line 280, in _send_bytes\n    ov, err = _winapi.WriteFile(self._handle, buf, overlapped=True)\nOSError: [WinError 6] The handle is invalid\nError type 2(unrelated event handle get killed):\nTraceback (most recent call last):\n  File \"test.py\", line 22, in <module>\n    memory_error()\n  File \"test.py\", line 17, in memory_error\n    for i in dl:\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 277, in __next__\n    idx, batch = self._get_batch()\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 256, in _get_batch\n    return self.data_queue.get()\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\", line 337, in get\n    return _ForkingPickler.loads(res)\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\multiprocessing\\reductions.py\", line 86, in rebuild_storage_filename\n    storage = cls._new_shared_filename(manager, handle, size)\nRuntimeError: Couldn't open shared event: <torch_17608_4052021606_event>, error code: <2> at D:\\Projects\\pytorch-scripts\\pytorch\\aten\\src\\TH\\THAllocator.c:245\nException ignored in: <bound method DataLoaderIter.__del__ of <torch.utils.data.dataloader.DataLoaderIter object at 0x000002303FB255C0>>\nTraceback (most recent call last):\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 341, in __del__\n    self._shutdown_workers()\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 322, in _shutdown_workers\n    self.data_queue.get()\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\", line 337, in get\n    return _ForkingPickler.loads(res)\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\multiprocessing\\reductions.py\", line 86, in rebuild_storage_filename\n    storage = cls._new_shared_filename(manager, handle, size)\nRuntimeError: Couldn't open shared event: <torch_18984_3257952678_event>, error code: <2> at D:\\Projects\\pytorch-scripts\\pytorch\\aten\\src\\TH\\THAllocator.c:245", "body": "The memory leak is caused by the difference in using FileMapping(mmap) on Windows. On Windows, FileMapping objects should be closed by all related processes and then it can be released. And there's no other way to explicitly delete it.(Like shm_unlink)\r\nWhen multiprocessing is on, the child process will create a FileMapping and then the main process will open it. After that, at some time, the child process will try to release it but it's reference count is non-zero so it cannot be released at that time. But the current code does not provide a chance to let it close again when possible.\r\nThis PR targets #5590.\r\nCurrent Progress:\r\nThe memory leak when num_worker=1 should be solved. However, further work has to be done for more workers.\r\nError type 1(unrelated filemapping handle get killed):\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\process.py\", line 258, in _bootstrap\r\n    self.run()\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\process.py\", line 93, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 61, in _worker_loop\r\n    data_queue.put((idx, samples))\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\", line 344, in put\r\n    self._writer.send_bytes(obj)\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\connection.py\", line 200, in send_bytes\r\n    self._send_bytes(m[offset:offset + size])\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\connection.py\", line 280, in _send_bytes\r\n    ov, err = _winapi.WriteFile(self._handle, buf, overlapped=True)\r\nOSError: [WinError 6] The handle is invalid\r\n```\r\nError type 2(unrelated event handle get killed):\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 22, in <module>\r\n    memory_error()\r\n  File \"test.py\", line 17, in memory_error\r\n    for i in dl:\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 277, in __next__\r\n    idx, batch = self._get_batch()\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 256, in _get_batch\r\n    return self.data_queue.get()\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\", line 337, in get\r\n    return _ForkingPickler.loads(res)\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\multiprocessing\\reductions.py\", line 86, in rebuild_storage_filename\r\n    storage = cls._new_shared_filename(manager, handle, size)\r\nRuntimeError: Couldn't open shared event: <torch_17608_4052021606_event>, error code: <2> at D:\\Projects\\pytorch-scripts\\pytorch\\aten\\src\\TH\\THAllocator.c:245\r\nException ignored in: <bound method DataLoaderIter.__del__ of <torch.utils.data.dataloader.DataLoaderIter object at 0x000002303FB255C0>>\r\nTraceback (most recent call last):\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 341, in __del__\r\n    self._shutdown_workers()\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\utils\\data\\dataloader.py\", line 322, in _shutdown_workers\r\n    self.data_queue.get()\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\multiprocessing\\queues.py\", line 337, in get\r\n    return _ForkingPickler.loads(res)\r\n  File \"C:\\Anaconda2\\envs\\test_new\\lib\\site-packages\\torch\\multiprocessing\\reductions.py\", line 86, in rebuild_storage_filename\r\n    storage = cls._new_shared_filename(manager, handle, size)\r\nRuntimeError: Couldn't open shared event: <torch_18984_3257952678_event>, error code: <2> at D:\\Projects\\pytorch-scripts\\pytorch\\aten\\src\\TH\\THAllocator.c:245\r\n```"}