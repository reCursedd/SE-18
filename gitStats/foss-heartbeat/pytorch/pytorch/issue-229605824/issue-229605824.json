{"url": "https://api.github.com/repos/pytorch/pytorch/issues/1584", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/1584/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/1584/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/1584/events", "html_url": "https://github.com/pytorch/pytorch/issues/1584", "id": 229605824, "node_id": "MDU6SXNzdWUyMjk2MDU4MjQ=", "number": 1584, "title": "Operation is not cleaned up when exception raised in file THTensorRandom.c", "user": {"login": "xmfbit", "id": 6002490, "node_id": "MDQ6VXNlcjYwMDI0OTA=", "avatar_url": "https://avatars2.githubusercontent.com/u/6002490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xmfbit", "html_url": "https://github.com/xmfbit", "followers_url": "https://api.github.com/users/xmfbit/followers", "following_url": "https://api.github.com/users/xmfbit/following{/other_user}", "gists_url": "https://api.github.com/users/xmfbit/gists{/gist_id}", "starred_url": "https://api.github.com/users/xmfbit/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xmfbit/subscriptions", "organizations_url": "https://api.github.com/users/xmfbit/orgs", "repos_url": "https://api.github.com/users/xmfbit/repos", "events_url": "https://api.github.com/users/xmfbit/events{/privacy}", "received_events_url": "https://api.github.com/users/xmfbit/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-05-18T09:20:41Z", "updated_at": "2017-09-28T16:07:17Z", "closed_at": "2017-09-28T16:07:16Z", "author_association": "NONE", "body_html": "<p>I was reading the documentation of <code>torch.multinomial()</code> method in the <a href=\"http://pytorch.org/docs/torch.html?highlight=multinomial#torch.multinomial\" rel=\"nofollow\">online documentation</a>.</p>\n<p>I tried this in IPython environment.</p>\n<pre><code>weights = torch.Tensor([0, 10, 3, 0])\nprint weights   # out: [torch.FloatTensor of size 4]\ntorch.multinomial(weights, 5)\n</code></pre>\n<p>Of course, error occurs because 5 is larger than the size of weights and I didn't set <code>replacement=True</code>. The error message is like this:</p>\n<pre><code>RuntimeError: cannot sample n_sample &gt; prob_dist:size(1) samples without replacement at /home/me/pytorch/pytorch/torch/lib/TH/generic/THTensorRandom.c:94\n</code></pre>\n<p>But after this, the dimensions of weights changed.</p>\n<pre><code>print weights  # out: [torch.FloatTensor of size 1x4]\n</code></pre>\n<p>If I run as following without runtime exception, then the dimensions of weights do not change.</p>\n<pre><code>weights = torch.Tensor([0, 10, 3, 0]) \nprint weights # out: [torch.FloatTensor of size 4]\ntorch.multinomial(weights, 4)\nprint weights # out: [torch.FloatTensor of size 4]\n</code></pre>\n<p>This is caused by not cleaning up after exception raised in this <a href=\"https://github.com/pytorch/pytorch/blob/156fe2866665c55557e41bb46603fef3e39bfb35/torch/lib/TH/generic/THTensorRandom.c#L81-L84\">operation</a>.</p>\n<p>Maybe the solution is adding cleaning up code in the <a href=\"https://github.com/pytorch/pytorch/blob/156fe2866665c55557e41bb46603fef3e39bfb35/torch/lib/TH/generic/THTensorRandom.c#L91-L95\">code block</a>.</p>", "body_text": "I was reading the documentation of torch.multinomial() method in the online documentation.\nI tried this in IPython environment.\nweights = torch.Tensor([0, 10, 3, 0])\nprint weights   # out: [torch.FloatTensor of size 4]\ntorch.multinomial(weights, 5)\n\nOf course, error occurs because 5 is larger than the size of weights and I didn't set replacement=True. The error message is like this:\nRuntimeError: cannot sample n_sample > prob_dist:size(1) samples without replacement at /home/me/pytorch/pytorch/torch/lib/TH/generic/THTensorRandom.c:94\n\nBut after this, the dimensions of weights changed.\nprint weights  # out: [torch.FloatTensor of size 1x4]\n\nIf I run as following without runtime exception, then the dimensions of weights do not change.\nweights = torch.Tensor([0, 10, 3, 0]) \nprint weights # out: [torch.FloatTensor of size 4]\ntorch.multinomial(weights, 4)\nprint weights # out: [torch.FloatTensor of size 4]\n\nThis is caused by not cleaning up after exception raised in this operation.\nMaybe the solution is adding cleaning up code in the code block.", "body": "I was reading the documentation of `torch.multinomial()` method in the [online documentation](http://pytorch.org/docs/torch.html?highlight=multinomial#torch.multinomial).\r\n\r\nI tried this in IPython environment.\r\n\r\n```\r\nweights = torch.Tensor([0, 10, 3, 0])\r\nprint weights   # out: [torch.FloatTensor of size 4]\r\ntorch.multinomial(weights, 5)\r\n```\r\n\r\nOf course, error occurs because 5 is larger than the size of weights and I didn't set `replacement=True`. The error message is like this:\r\n```\r\nRuntimeError: cannot sample n_sample > prob_dist:size(1) samples without replacement at /home/me/pytorch/pytorch/torch/lib/TH/generic/THTensorRandom.c:94\r\n```\r\nBut after this, the dimensions of weights changed.\r\n```\r\nprint weights  # out: [torch.FloatTensor of size 1x4]\r\n```\r\n\r\nIf I run as following without runtime exception, then the dimensions of weights do not change.\r\n```\r\nweights = torch.Tensor([0, 10, 3, 0]) \r\nprint weights # out: [torch.FloatTensor of size 4]\r\ntorch.multinomial(weights, 4)\r\nprint weights # out: [torch.FloatTensor of size 4]\r\n```\r\n\r\nThis is caused by not cleaning up after exception raised in this [operation](https://github.com/pytorch/pytorch/blob/156fe2866665c55557e41bb46603fef3e39bfb35/torch/lib/TH/generic/THTensorRandom.c#L81-L84).\r\n\r\nMaybe the solution is adding cleaning up code in the [code block](https://github.com/pytorch/pytorch/blob/156fe2866665c55557e41bb46603fef3e39bfb35/torch/lib/TH/generic/THTensorRandom.c#L91-L95)."}