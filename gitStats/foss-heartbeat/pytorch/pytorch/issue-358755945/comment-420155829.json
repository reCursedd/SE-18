{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/420155829", "html_url": "https://github.com/pytorch/pytorch/pull/11473#issuecomment-420155829", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/11473", "id": 420155829, "node_id": "MDEyOklzc3VlQ29tbWVudDQyMDE1NTgyOQ==", "user": {"login": "jamesr66a", "id": 4685384, "node_id": "MDQ6VXNlcjQ2ODUzODQ=", "avatar_url": "https://avatars2.githubusercontent.com/u/4685384?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamesr66a", "html_url": "https://github.com/jamesr66a", "followers_url": "https://api.github.com/users/jamesr66a/followers", "following_url": "https://api.github.com/users/jamesr66a/following{/other_user}", "gists_url": "https://api.github.com/users/jamesr66a/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamesr66a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamesr66a/subscriptions", "organizations_url": "https://api.github.com/users/jamesr66a/orgs", "repos_url": "https://api.github.com/users/jamesr66a/repos", "events_url": "https://api.github.com/users/jamesr66a/events{/privacy}", "received_events_url": "https://api.github.com/users/jamesr66a/received_events", "type": "User", "site_admin": false}, "created_at": "2018-09-11T05:56:46Z", "updated_at": "2018-09-11T06:11:47Z", "author_association": "CONTRIBUTOR", "body_html": "<p>DOCUMENTING PYBIND11 FIX:</p>\n<p>Updating pybind11 to the current master introduced a regression in the <code>caffe2/python/dataio_test.py</code> <code>TestReaderWithLimit</code> suite of tests. Patching to pybind11/b4719a6 introduced the following segfault:</p>\n<pre><code>$ python -m pytest -v caffe2/python/dataio_test.py\n========================================================= test session starts =========================================================\nplatform linux2 -- Python 2.7.15, pytest-3.7.4, py-1.6.0, pluggy-0.7.1 -- /home/jamesreed/local/miniconda3/envs/py2/bin/python\ncachedir: .pytest_cache\nrootdir: /data/users/jamesreed/pytorch, inifile:\ncollected 12 items\n\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader PASSED                                                 [  8%]\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader_builder PASSED                                         [ 16%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_high_limit PASSED                               [ 25%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_low_limit PASSED                                [ 33%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_zero_limit PASSED                               [ 41%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_without_limit PASSED                                 [ 50%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_runtime_threads PASSED                                                  [ 58%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_long_limit Segmentation fault (core dumped)\n\n</code></pre>\n<p>Threads:</p>\n<pre><code>Thread 65 (LWP 906378):\n#0  0x00007ffff77eeafb in do_futex_wait.constprop () from /lib64/libpthread.so.0\n#1  0x00007ffff77eeb8f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0\n#2  0x00007ffff77eec2b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0\n#3  0x00007ffff7b0caa6 in PyThread_acquire_lock () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7ad718b in PyEval_AcquireThread () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007fffde330c3f in pybind11::gil_scoped_acquire::gil_scoped_acquire (this=0x7fffd3ffb320)\n    at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/pybind11.h:1797\n#6  0x00007fffde3f4dac in caffe2::python::PythonOpBase&lt;caffe2::CPUContext, false&gt;::RunOnDevice (this=0x7fffb400a650)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:312\n#7  0x00007fffde3f3d3f in caffe2::Operator&lt;caffe2::CPUContext&gt;::Run (this=0x7fffb400a650, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#8  0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffb40015c0) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#9  0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#10 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#11 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#12 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93a90)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#13 0x00007fffdc061adc in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x555555b93a90) at /usr/include/c++/4.8.2/functional:1732\n#14 0x00007fffdc061981 in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::operator()(void) (this=0x555555b93a90) at /usr/include/c++/4.8.2/functional:1720\n#15 0x00007fffdc06177c in std::thread::_Impl&lt;std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt; &gt;::_M_run(void) (this=0x555555b93a78) at /usr/include/c++/4.8.2/thread:115\n#16 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=&lt;optimized out&gt;)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#17 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n#18 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\n\nThread 64 (LWP 906377):\n#0  0x00007ffff7ae98cd in PyErr_Restore () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#1  0x00007ffff7a7c3a5 in PyDict_GetItem () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#2  0x00007ffff7a6995e in PyFrame_New () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#3  0x00007ffff7ae0d7a in PyEval_EvalCodeEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7a6a28a in function_call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007ffff7a457a3 in PyObject_Call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#6  0x00007ffff7ad7a58 in PyEval_CallObjectWithKeywords ()\n   from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#7  0x00007fffde353dd3 in pybind11::detail::simple_collector&lt;(pybind11::return_value_policy)1&gt;::call (this=0x7fffd0fb50c0,\n    ptr=0x7fffd870c320) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:1941\n#8  0x00007fffde3f5d3c in pybind11::detail::object_api&lt;pybind11::handle&gt;::operator()&lt;(pybind11::return_value_policy)1, std::vector&lt;pybind11::object, std::allocator&lt;pybind11::object&gt; &gt;&amp;, std::vector&lt;pybind11::object, std::allocator&lt;pybind11::object&gt; &gt;&amp;&gt; (\n    this=0x555555b39560) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:2096\n#9  0x00007fffde3f5226 in caffe2::python::PythonOpBase&lt;caffe2::CPUContext, false&gt;::RunOnDevice (this=0x7fffcc0013e0)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:404\n#10 0x00007fffde3f3d3f in caffe2::Operator&lt;caffe2::CPUContext&gt;::Run (this=0x7fffcc0013e0, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#11 0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffcc001310) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#12 0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#13 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#14 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#15 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b939f0)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#16 0x00007fffdc061adc in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x555555b939f0) at /usr/include/c++/4.8.2/functional:1732\n#17 0x00007fffdc061981 in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::operator()(void) (this=0x555555b939f0) at /usr/include/c++/4.8.2/functional:1720\n#18 0x00007fffdc06177c in std::thread::_Impl&lt;std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt; &gt;::_M_run(void) (this=0x555555b939d8) at /usr/include/c++/4.8.2/thread:115\n#19 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=&lt;optimized out&gt;)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#20 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n#21 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\n\nThread 63 (LWP 906376):\n#0  0x00007ffff77eeafb in do_futex_wait.constprop () from /lib64/libpthread.so.0\n#1  0x00007ffff77eeb8f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0\n#2  0x00007ffff77eec2b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0\n#3  0x00007ffff7b0caa6 in PyThread_acquire_lock () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7ad718b in PyEval_AcquireThread () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007fffde330c3f in pybind11::gil_scoped_acquire::gil_scoped_acquire (this=0x7fffd17b6320)\n    at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/pybind11.h:1797\n#6  0x00007fffde3f4dac in caffe2::python::PythonOpBase&lt;caffe2::CPUContext, false&gt;::RunOnDevice (this=0x7fffc40075b0)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:312\n#7  0x00007fffde3f3d3f in caffe2::Operator&lt;caffe2::CPUContext&gt;::Run (this=0x7fffc40075b0, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#8  0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffc4001440) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#9  0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#10 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#11 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#12 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93990)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#13 0x00007fffdc061adc in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x555555b93990) at /usr/include/c++/4.8.2/functional:1732\n#14 0x00007fffdc061981 in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::operator()(void) (this=0x555555b93990) at /usr/include/c++/4.8.2/functional:1720\n#15 0x00007fffdc06177c in std::thread::_Impl&lt;std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt; &gt;::_M_run(void) (this=0x555555b93978) at /usr/include/c++/4.8.2/thread:115\n#16 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=&lt;optimized out&gt;)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#17 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n\nThread 62 (LWP 906375):\n#0  0x00007ffff6e00c73 in select () from /lib64/libc.so.6\n#1  0x00007fffeed86ce4 in time_sleep () from /data/users/jamesreed/miniconda3/envs/py2/lib/python2.7/lib-dynload/time.so\n#2  0x00007ffff7adfcc4 in PyEval_EvalFrameEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#3  0x00007ffff7ae14e9 in PyEval_EvalCodeEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7a6a28a in function_call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007ffff7a457a3 in PyObject_Call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#6  0x00007ffff7ad7a58 in PyEval_CallObjectWithKeywords ()\n   from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#7  0x00007fffde353dd3 in pybind11::detail::simple_collector&lt;(pybind11::return_value_policy)1&gt;::call (this=0x7fffd1fb70c0,\n    ptr=0x7fffd870c320) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:1941\n#8  0x00007fffde3f5d3c in pybind11::detail::object_api&lt;pybind11::handle&gt;::operator()&lt;(pybind11::return_value_policy)1, std::vector&lt;pybind11::object, std::allocator&lt;pybind11::object&gt; &gt;&amp;, std::vector&lt;pybind11::object, std::allocator&lt;pybind11::object&gt; &gt;&amp;&gt; (\n    this=0x555555b39560) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:2096\n#9  0x00007fffde3f5226 in caffe2::python::PythonOpBase&lt;caffe2::CPUContext, false&gt;::RunOnDevice (this=0x7fffd4001440)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:404\n#10 0x00007fffde3f3d3f in caffe2::Operator&lt;caffe2::CPUContext&gt;::Run (this=0x7fffd4001440, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#11 0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffd4005170) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#12 0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#13 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#14 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#15 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93910)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#16 0x00007fffdc061adc in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x555555b93910) at /usr/include/c++/4.8.2/functional:1732\n#17 0x00007fffdc061981 in std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt;::operator()(void) (this=0x555555b93910) at /usr/include/c++/4.8.2/functional:1720\n#18 0x00007fffdc06177c in std::thread::_Impl&lt;std::_Bind_simple&lt;caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&amp;)::__lambda22()&gt; &gt;::_M_run(void) (this=0x555555b938f8) at /usr/include/c++/4.8.2/thread:115\n#19 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=&lt;optimized out&gt;)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#20 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n#21 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\n\nThread 1 (LWP 905523):\n#0  0x00007ffff77e9f97 in pthread_join () from /lib64/libpthread.so.0\n#1  0x00007fffeaa6352f in __gthread_join (__value_ptr=0x0, __threadid=&lt;optimized out&gt;)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/build/build-cc-gcc-final/x86_64-conda_cos6-linux-gnu/libstdc++-v3/include/x86_64-conda_cos6-linux-gnu/bits/gthr-default.h:681\n#2  std::thread::join (this=0x555555b93780)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:110\n#3  0x00007fffdc058562 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:443\n#4  0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n&lt;snip&gt;\n\n</code></pre>\n<p>In particular it looks as though we have multiple <code>std::thread</code>s (<a href=\"https://github.com/pytorch/pytorch/blob/master/caffe2/core/plan_executor.cc#L434\">https://github.com/pytorch/pytorch/blob/master/caffe2/core/plan_executor.cc#L434</a>) calling into the same Python code via PythonOp <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/pytorch/pytorch/blob/c9e66351a7080d11a746a0794fa833437015c1a8/caffe2/python/pybind_state.h#L312\">pytorch/caffe2/python/pybind_state.h</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 312\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/pytorch/pytorch/commit/c9e66351a7080d11a746a0794fa833437015c1a8\">c9e6635</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L312\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"312\"></td>\n          <td id=\"LC312\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> py::gil_scoped_acquire g; </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n concurrently, and this test case happened to use sleep as a test payload <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom bg-gray-light\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/pytorch/pytorch/blob/c37fac4d50a62c5a3d374c745661ad41a199fd17/caffe2/python/dataio.py#L512\">pytorch/caffe2/python/dataio.py</a>\n    </p>\n    <p class=\"mb-0 text-gray-light\">\n         Line 512\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/pytorch/pytorch/commit/c37fac4d50a62c5a3d374c745661ad41a199fd17\">c37fac4</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L512\" class=\"blob-num border-0 px-3 py-0 bg-white js-line-number\" data-line-number=\"512\"></td>\n          <td id=\"LC512\" class=\"blob-code border-0 px-3 py-0 bg-white blob-code-inner js-file-line\"> <span class=\"pl-k\">def</span> <span class=\"pl-en\">sleep_op</span>(<span class=\"pl-k\">*</span><span class=\"pl-smi\">args</span>, <span class=\"pl-k\">**</span><span class=\"pl-smi\">argd</span>): </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n ensuring that they contend over the GIL. The <code>tstate</code> pointers that <code>gil_scoped_acquire</code> are receiving appear corrupted to me (it seems like they point to random stack addresses). I isolated it down to this line <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/pybind/pybind11/commit/b4719a60d32821fa47aaaba7c1035cb447bab386#diff-2443092219154d8d844074fa320e45f7R1825/hovercard\" href=\"https://github.com/pybind/pybind11/commit/b4719a60d32821fa47aaaba7c1035cb447bab386#diff-2443092219154d8d844074fa320e45f7R1825\">pybind/pybind11@<tt>b4719a6</tt>#diff-2443092219154d8d844074fa320e45f7R1825</a> which the aforementioned patch fixes</p>\n<p>Patching the fix yields runs without the segmentation fault:</p>\n<pre><code>============================= test session starts ==============================\nplatform linux2 -- Python 2.7.15, pytest-3.7.4, py-1.6.0, pluggy-0.7.1 -- /home/jamesreed/local/miniconda3/envs/py2/bin/python\ncachedir: .pytest_cache\nrootdir: /data/users/jamesreed/pytorch, inifile:\ncollecting ... collected 12 items\n\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader PASSED [  8%]\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader_builder PASSED [ 16%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_high_limit PASSED [ 25%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_low_limit PASSED [ 33%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_zero_limit PASSED [ 41%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_without_limit PASSED [ 50%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_runtime_threads PASSED [ 58%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_long_limit PASSED [ 66%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_short_limit PASSED [ 75%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_without_limit PASSED [ 83%]\n</code></pre>", "body_text": "DOCUMENTING PYBIND11 FIX:\nUpdating pybind11 to the current master introduced a regression in the caffe2/python/dataio_test.py TestReaderWithLimit suite of tests. Patching to pybind11/b4719a6 introduced the following segfault:\n$ python -m pytest -v caffe2/python/dataio_test.py\n========================================================= test session starts =========================================================\nplatform linux2 -- Python 2.7.15, pytest-3.7.4, py-1.6.0, pluggy-0.7.1 -- /home/jamesreed/local/miniconda3/envs/py2/bin/python\ncachedir: .pytest_cache\nrootdir: /data/users/jamesreed/pytorch, inifile:\ncollected 12 items\n\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader PASSED                                                 [  8%]\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader_builder PASSED                                         [ 16%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_high_limit PASSED                               [ 25%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_low_limit PASSED                                [ 33%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_zero_limit PASSED                               [ 41%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_without_limit PASSED                                 [ 50%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_runtime_threads PASSED                                                  [ 58%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_long_limit Segmentation fault (core dumped)\n\n\nThreads:\nThread 65 (LWP 906378):\n#0  0x00007ffff77eeafb in do_futex_wait.constprop () from /lib64/libpthread.so.0\n#1  0x00007ffff77eeb8f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0\n#2  0x00007ffff77eec2b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0\n#3  0x00007ffff7b0caa6 in PyThread_acquire_lock () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7ad718b in PyEval_AcquireThread () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007fffde330c3f in pybind11::gil_scoped_acquire::gil_scoped_acquire (this=0x7fffd3ffb320)\n    at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/pybind11.h:1797\n#6  0x00007fffde3f4dac in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffb400a650)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:312\n#7  0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffb400a650, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#8  0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffb40015c0) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#9  0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#10 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#11 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#12 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93a90)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#13 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b93a90) at /usr/include/c++/4.8.2/functional:1732\n#14 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b93a90) at /usr/include/c++/4.8.2/functional:1720\n#15 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b93a78) at /usr/include/c++/4.8.2/thread:115\n#16 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#17 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n#18 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\n\nThread 64 (LWP 906377):\n#0  0x00007ffff7ae98cd in PyErr_Restore () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#1  0x00007ffff7a7c3a5 in PyDict_GetItem () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#2  0x00007ffff7a6995e in PyFrame_New () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#3  0x00007ffff7ae0d7a in PyEval_EvalCodeEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7a6a28a in function_call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007ffff7a457a3 in PyObject_Call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#6  0x00007ffff7ad7a58 in PyEval_CallObjectWithKeywords ()\n   from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#7  0x00007fffde353dd3 in pybind11::detail::simple_collector<(pybind11::return_value_policy)1>::call (this=0x7fffd0fb50c0,\n    ptr=0x7fffd870c320) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:1941\n#8  0x00007fffde3f5d3c in pybind11::detail::object_api<pybind11::handle>::operator()<(pybind11::return_value_policy)1, std::vector<pybind11::object, std::allocator<pybind11::object> >&, std::vector<pybind11::object, std::allocator<pybind11::object> >&> (\n    this=0x555555b39560) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:2096\n#9  0x00007fffde3f5226 in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffcc0013e0)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:404\n#10 0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffcc0013e0, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#11 0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffcc001310) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#12 0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#13 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#14 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#15 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b939f0)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#16 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b939f0) at /usr/include/c++/4.8.2/functional:1732\n#17 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b939f0) at /usr/include/c++/4.8.2/functional:1720\n#18 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b939d8) at /usr/include/c++/4.8.2/thread:115\n#19 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#20 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n#21 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\n\nThread 63 (LWP 906376):\n#0  0x00007ffff77eeafb in do_futex_wait.constprop () from /lib64/libpthread.so.0\n#1  0x00007ffff77eeb8f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0\n#2  0x00007ffff77eec2b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0\n#3  0x00007ffff7b0caa6 in PyThread_acquire_lock () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7ad718b in PyEval_AcquireThread () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007fffde330c3f in pybind11::gil_scoped_acquire::gil_scoped_acquire (this=0x7fffd17b6320)\n    at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/pybind11.h:1797\n#6  0x00007fffde3f4dac in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffc40075b0)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:312\n#7  0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffc40075b0, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#8  0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffc4001440) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#9  0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#10 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#11 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#12 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93990)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#13 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b93990) at /usr/include/c++/4.8.2/functional:1732\n#14 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b93990) at /usr/include/c++/4.8.2/functional:1720\n#15 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b93978) at /usr/include/c++/4.8.2/thread:115\n#16 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#17 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n\nThread 62 (LWP 906375):\n#0  0x00007ffff6e00c73 in select () from /lib64/libc.so.6\n#1  0x00007fffeed86ce4 in time_sleep () from /data/users/jamesreed/miniconda3/envs/py2/lib/python2.7/lib-dynload/time.so\n#2  0x00007ffff7adfcc4 in PyEval_EvalFrameEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#3  0x00007ffff7ae14e9 in PyEval_EvalCodeEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#4  0x00007ffff7a6a28a in function_call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#5  0x00007ffff7a457a3 in PyObject_Call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#6  0x00007ffff7ad7a58 in PyEval_CallObjectWithKeywords ()\n   from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\n#7  0x00007fffde353dd3 in pybind11::detail::simple_collector<(pybind11::return_value_policy)1>::call (this=0x7fffd1fb70c0,\n    ptr=0x7fffd870c320) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:1941\n#8  0x00007fffde3f5d3c in pybind11::detail::object_api<pybind11::handle>::operator()<(pybind11::return_value_policy)1, std::vector<pybind11::object, std::allocator<pybind11::object> >&, std::vector<pybind11::object, std::allocator<pybind11::object> >&> (\n    this=0x555555b39560) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:2096\n#9  0x00007fffde3f5226 in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffd4001440)\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:404\n#10 0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffd4001440, stream_id=0)\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\n#11 0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffd4005170) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\n#12 0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\n#13 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#14 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\n#15 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93910)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\n#16 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b93910) at /usr/include/c++/4.8.2/functional:1732\n#17 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b93910) at /usr/include/c++/4.8.2/functional:1720\n#18 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b938f8) at /usr/include/c++/4.8.2/thread:115\n#19 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\n#20 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\n#21 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\n\nThread 1 (LWP 905523):\n#0  0x00007ffff77e9f97 in pthread_join () from /lib64/libpthread.so.0\n#1  0x00007fffeaa6352f in __gthread_join (__value_ptr=0x0, __threadid=<optimized out>)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/build/build-cc-gcc-final/x86_64-conda_cos6-linux-gnu/libstdc++-v3/include/x86_64-conda_cos6-linux-gnu/bits/gthr-default.h:681\n#2  std::thread::join (this=0x555555b93780)\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:110\n#3  0x00007fffdc058562 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:443\n#4  0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\n<snip>\n\n\nIn particular it looks as though we have multiple std::threads (https://github.com/pytorch/pytorch/blob/master/caffe2/core/plan_executor.cc#L434) calling into the same Python code via PythonOp \n  \n    \n      pytorch/caffe2/python/pybind_state.h\n    \n    \n         Line 312\n      in\n      c9e6635\n    \n    \n    \n    \n\n        \n          \n           py::gil_scoped_acquire g; \n        \n    \n  \n\n concurrently, and this test case happened to use sleep as a test payload \n  \n    \n      pytorch/caffe2/python/dataio.py\n    \n    \n         Line 512\n      in\n      c37fac4\n    \n    \n    \n    \n\n        \n          \n           def sleep_op(*args, **argd): \n        \n    \n  \n\n ensuring that they contend over the GIL. The tstate pointers that gil_scoped_acquire are receiving appear corrupted to me (it seems like they point to random stack addresses). I isolated it down to this line pybind/pybind11@b4719a6#diff-2443092219154d8d844074fa320e45f7R1825 which the aforementioned patch fixes\nPatching the fix yields runs without the segmentation fault:\n============================= test session starts ==============================\nplatform linux2 -- Python 2.7.15, pytest-3.7.4, py-1.6.0, pluggy-0.7.1 -- /home/jamesreed/local/miniconda3/envs/py2/bin/python\ncachedir: .pytest_cache\nrootdir: /data/users/jamesreed/pytorch, inifile:\ncollecting ... collected 12 items\n\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader PASSED [  8%]\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader_builder PASSED [ 16%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_high_limit PASSED [ 25%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_low_limit PASSED [ 33%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_zero_limit PASSED [ 41%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_without_limit PASSED [ 50%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_runtime_threads PASSED [ 58%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_long_limit PASSED [ 66%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_short_limit PASSED [ 75%]\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_without_limit PASSED [ 83%]", "body": "DOCUMENTING PYBIND11 FIX:\r\n\r\nUpdating pybind11 to the current master introduced a regression in the `caffe2/python/dataio_test.py` `TestReaderWithLimit` suite of tests. Patching to pybind11/b4719a6 introduced the following segfault:\r\n\r\n```\r\n$ python -m pytest -v caffe2/python/dataio_test.py\r\n========================================================= test session starts =========================================================\r\nplatform linux2 -- Python 2.7.15, pytest-3.7.4, py-1.6.0, pluggy-0.7.1 -- /home/jamesreed/local/miniconda3/envs/py2/bin/python\r\ncachedir: .pytest_cache\r\nrootdir: /data/users/jamesreed/pytorch, inifile:\r\ncollected 12 items\r\n\r\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader PASSED                                                 [  8%]\r\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader_builder PASSED                                         [ 16%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_high_limit PASSED                               [ 25%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_low_limit PASSED                                [ 33%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_zero_limit PASSED                               [ 41%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_without_limit PASSED                                 [ 50%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_runtime_threads PASSED                                                  [ 58%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_long_limit Segmentation fault (core dumped)\r\n\r\n```\r\n\r\nThreads:\r\n\r\n```\r\nThread 65 (LWP 906378):\r\n#0  0x00007ffff77eeafb in do_futex_wait.constprop () from /lib64/libpthread.so.0\r\n#1  0x00007ffff77eeb8f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0\r\n#2  0x00007ffff77eec2b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0\r\n#3  0x00007ffff7b0caa6 in PyThread_acquire_lock () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#4  0x00007ffff7ad718b in PyEval_AcquireThread () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#5  0x00007fffde330c3f in pybind11::gil_scoped_acquire::gil_scoped_acquire (this=0x7fffd3ffb320)\r\n    at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/pybind11.h:1797\r\n#6  0x00007fffde3f4dac in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffb400a650)\r\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:312\r\n#7  0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffb400a650, stream_id=0)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\r\n#8  0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffb40015c0) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\r\n#9  0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\r\n#10 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#11 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#12 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93a90)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\r\n#13 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b93a90) at /usr/include/c++/4.8.2/functional:1732\r\n#14 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b93a90) at /usr/include/c++/4.8.2/functional:1720\r\n#15 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b93a78) at /usr/include/c++/4.8.2/thread:115\r\n#16 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\r\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\r\n#17 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\r\n#18 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\r\n\r\nThread 64 (LWP 906377):\r\n#0  0x00007ffff7ae98cd in PyErr_Restore () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#1  0x00007ffff7a7c3a5 in PyDict_GetItem () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#2  0x00007ffff7a6995e in PyFrame_New () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#3  0x00007ffff7ae0d7a in PyEval_EvalCodeEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#4  0x00007ffff7a6a28a in function_call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#5  0x00007ffff7a457a3 in PyObject_Call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#6  0x00007ffff7ad7a58 in PyEval_CallObjectWithKeywords ()\r\n   from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#7  0x00007fffde353dd3 in pybind11::detail::simple_collector<(pybind11::return_value_policy)1>::call (this=0x7fffd0fb50c0,\r\n    ptr=0x7fffd870c320) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:1941\r\n#8  0x00007fffde3f5d3c in pybind11::detail::object_api<pybind11::handle>::operator()<(pybind11::return_value_policy)1, std::vector<pybind11::object, std::allocator<pybind11::object> >&, std::vector<pybind11::object, std::allocator<pybind11::object> >&> (\r\n    this=0x555555b39560) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:2096\r\n#9  0x00007fffde3f5226 in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffcc0013e0)\r\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:404\r\n#10 0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffcc0013e0, stream_id=0)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\r\n#11 0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffcc001310) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\r\n#12 0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\r\n#13 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#14 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#15 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b939f0)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\r\n#16 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b939f0) at /usr/include/c++/4.8.2/functional:1732\r\n#17 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b939f0) at /usr/include/c++/4.8.2/functional:1720\r\n#18 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b939d8) at /usr/include/c++/4.8.2/thread:115\r\n#19 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\r\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\r\n#20 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\r\n#21 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\r\n\r\nThread 63 (LWP 906376):\r\n#0  0x00007ffff77eeafb in do_futex_wait.constprop () from /lib64/libpthread.so.0\r\n#1  0x00007ffff77eeb8f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0\r\n#2  0x00007ffff77eec2b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0\r\n#3  0x00007ffff7b0caa6 in PyThread_acquire_lock () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#4  0x00007ffff7ad718b in PyEval_AcquireThread () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#5  0x00007fffde330c3f in pybind11::gil_scoped_acquire::gil_scoped_acquire (this=0x7fffd17b6320)\r\n    at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/pybind11.h:1797\r\n#6  0x00007fffde3f4dac in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffc40075b0)\r\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:312\r\n#7  0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffc40075b0, stream_id=0)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\r\n#8  0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffc4001440) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\r\n#9  0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\r\n#10 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#11 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#12 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93990)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\r\n#13 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b93990) at /usr/include/c++/4.8.2/functional:1732\r\n#14 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b93990) at /usr/include/c++/4.8.2/functional:1720\r\n#15 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b93978) at /usr/include/c++/4.8.2/thread:115\r\n#16 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\r\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\r\n#17 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\r\n\r\nThread 62 (LWP 906375):\r\n#0  0x00007ffff6e00c73 in select () from /lib64/libc.so.6\r\n#1  0x00007fffeed86ce4 in time_sleep () from /data/users/jamesreed/miniconda3/envs/py2/lib/python2.7/lib-dynload/time.so\r\n#2  0x00007ffff7adfcc4 in PyEval_EvalFrameEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#3  0x00007ffff7ae14e9 in PyEval_EvalCodeEx () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#4  0x00007ffff7a6a28a in function_call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#5  0x00007ffff7a457a3 in PyObject_Call () from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#6  0x00007ffff7ad7a58 in PyEval_CallObjectWithKeywords ()\r\n   from /data/users/jamesreed/miniconda3/envs/py2/bin/../lib/libpython2.7.so.1.0\r\n#7  0x00007fffde353dd3 in pybind11::detail::simple_collector<(pybind11::return_value_policy)1>::call (this=0x7fffd1fb70c0,\r\n    ptr=0x7fffd870c320) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:1941\r\n#8  0x00007fffde3f5d3c in pybind11::detail::object_api<pybind11::handle>::operator()<(pybind11::return_value_policy)1, std::vector<pybind11::object, std::allocator<pybind11::object> >&, std::vector<pybind11::object, std::allocator<pybind11::object> >&> (\r\n    this=0x555555b39560) at /data/users/jamesreed/pytorch/third_party/pybind11/include/pybind11/cast.h:2096\r\n#9  0x00007fffde3f5226 in caffe2::python::PythonOpBase<caffe2::CPUContext, false>::RunOnDevice (this=0x7fffd4001440)\r\n    at /data/users/jamesreed/pytorch/caffe2/python/pybind_state.h:404\r\n#10 0x00007fffde3f3d3f in caffe2::Operator<caffe2::CPUContext>::Run (this=0x7fffd4001440, stream_id=0)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/operator.h:497\r\n#11 0x00007fffdc028fb9 in caffe2::SimpleNet::Run (this=0x7fffd4005170) at /data/users/jamesreed/pytorch/caffe2/core/net_simple.cc:63\r\n#12 0x00007fffdc0588c0 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:464\r\n#13 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#14 0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:394\r\n#15 0x00007fffdc057b9e in caffe2::(anonymous namespace)::__lambda22::operator() (__closure=0x555555b93910)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:414\r\n#16 0x00007fffdc061adc in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::_M_invoke<>(std::_Index_tuple<>) (this=0x555555b93910) at /usr/include/c++/4.8.2/functional:1732\r\n#17 0x00007fffdc061981 in std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()>::operator()(void) (this=0x555555b93910) at /usr/include/c++/4.8.2/functional:1720\r\n#18 0x00007fffdc06177c in std::thread::_Impl<std::_Bind_simple<caffe2::(anonymous namespace)::ExecuteStepRecursive(caffe2::(anonymous namespace)::ExecutionStepWrapper&)::__lambda22()> >::_M_run(void) (this=0x555555b938f8) at /usr/include/c++/4.8.2/thread:115\r\n#19 0x00007fffeaa63678 in std::execute_native_thread_routine_compat (__p=<optimized out>)\r\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:94\r\n#20 0x00007ffff77e8e25 in start_thread () from /lib64/libpthread.so.0\r\n#21 0x00007ffff6e09bad in clone () from /lib64/libc.so.6\r\n\r\nThread 1 (LWP 905523):\r\n#0  0x00007ffff77e9f97 in pthread_join () from /lib64/libpthread.so.0\r\n#1  0x00007fffeaa6352f in __gthread_join (__value_ptr=0x0, __threadid=<optimized out>)\r\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/build/build-cc-gcc-final/x86_64-conda_cos6-linux-gnu/libstdc++-v3/include/x86_64-conda_cos6-linux-gnu/bits/gthr-default.h:681\r\n#2  std::thread::join (this=0x555555b93780)\r\n    at /opt/conda/conda-bld/compilers_linux-64_1534514838838/work/.build/x86_64-conda_cos6-linux-gnu/src/gcc/libstdc++-v3/src/c++11/thread.cc:110\r\n#3  0x00007fffdc058562 in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n    at /data/users/jamesreed/pytorch/caffe2/core/plan_executor.cc:443\r\n#4  0x00007fffdc05822e in caffe2::(anonymous namespace)::ExecuteStepRecursive (stepWrapper=...)\r\n<snip>\r\n\r\n```\r\n\r\nIn particular it looks as though we have multiple `std::thread`s (https://github.com/pytorch/pytorch/blob/master/caffe2/core/plan_executor.cc#L434) calling into the same Python code via PythonOp https://github.com/pytorch/pytorch/blob/c9e66351a7080d11a746a0794fa833437015c1a8/caffe2/python/pybind_state.h#L312 concurrently, and this test case happened to use sleep as a test payload https://github.com/pytorch/pytorch/blob/c37fac4d50a62c5a3d374c745661ad41a199fd17/caffe2/python/dataio.py#L512 ensuring that they contend over the GIL. The `tstate` pointers that `gil_scoped_acquire` are receiving appear corrupted to me (it seems like they point to random stack addresses). I isolated it down to this line https://github.com/pybind/pybind11/commit/b4719a60d32821fa47aaaba7c1035cb447bab386#diff-2443092219154d8d844074fa320e45f7R1825 which the aforementioned patch fixes\r\n\r\nPatching the fix yields runs without the segmentation fault:\r\n\r\n```\r\n============================= test session starts ==============================\r\nplatform linux2 -- Python 2.7.15, pytest-3.7.4, py-1.6.0, pluggy-0.7.1 -- /home/jamesreed/local/miniconda3/envs/py2/bin/python\r\ncachedir: .pytest_cache\r\nrootdir: /data/users/jamesreed/pytorch, inifile:\r\ncollecting ... collected 12 items\r\n\r\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader PASSED [  8%]\r\ncaffe2/python/dataio_test.py::TestCompositeReader::test_composite_reader_builder PASSED [ 16%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_high_limit PASSED [ 25%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_low_limit PASSED [ 33%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_with_zero_limit PASSED [ 41%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_count_limit_reader_without_limit PASSED [ 50%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_runtime_threads PASSED [ 58%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_long_limit PASSED [ 66%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_with_short_limit PASSED [ 75%]\r\ncaffe2/python/dataio_test.py::TestReaderWithLimit::test_time_limit_reader_without_limit PASSED [ 83%]\r\n```\r\n\r\n"}