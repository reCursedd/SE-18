{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/379327119", "html_url": "https://github.com/pytorch/pytorch/issues/6353#issuecomment-379327119", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/6353", "id": 379327119, "node_id": "MDEyOklzc3VlQ29tbWVudDM3OTMyNzExOQ==", "user": {"login": "fmassa", "id": 9110200, "node_id": "MDQ6VXNlcjkxMTAyMDA=", "avatar_url": "https://avatars2.githubusercontent.com/u/9110200?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fmassa", "html_url": "https://github.com/fmassa", "followers_url": "https://api.github.com/users/fmassa/followers", "following_url": "https://api.github.com/users/fmassa/following{/other_user}", "gists_url": "https://api.github.com/users/fmassa/gists{/gist_id}", "starred_url": "https://api.github.com/users/fmassa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fmassa/subscriptions", "organizations_url": "https://api.github.com/users/fmassa/orgs", "repos_url": "https://api.github.com/users/fmassa/repos", "events_url": "https://api.github.com/users/fmassa/events{/privacy}", "received_events_url": "https://api.github.com/users/fmassa/received_events", "type": "User", "site_admin": false}, "created_at": "2018-04-06T17:47:35Z", "updated_at": "2018-04-06T17:48:26Z", "author_association": "MEMBER", "body_html": "<p>Here is a <code>mwe.py</code>  (note: you need to modify the path to <code>pytorch_dir</code>)</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> argparse\n\n<span class=\"pl-k\">def</span> <span class=\"pl-en\">compile_ext</span>():\n    <span class=\"pl-k\">import</span> os.path\n    <span class=\"pl-k\">from</span> torch.utils.cpp_extension <span class=\"pl-k\">import</span> load <span class=\"pl-k\">as</span> load_ext\n    pytorch_dir <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>/private/home/fmassa/github/pytorch/test/cpp_extensions<span class=\"pl-pds\">'</span></span>\n    source <span class=\"pl-k\">=</span> [\n        <span class=\"pl-s\"><span class=\"pl-pds\">'</span>extension.cpp<span class=\"pl-pds\">'</span></span>,\n    ]\n    source <span class=\"pl-k\">=</span> [os.path.join(pytorch_dir, s) <span class=\"pl-k\">for</span> s <span class=\"pl-k\">in</span> source]\n    <span class=\"pl-k\">return</span> load_ext(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>multiprocess_bug<span class=\"pl-pds\">'</span></span>, source)\n\n\n_C <span class=\"pl-k\">=</span> compile_ext()\n\n<span class=\"pl-k\">if</span> <span class=\"pl-c1\">__name__</span> <span class=\"pl-k\">==</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>__main__<span class=\"pl-pds\">\"</span></span>:\n    parser <span class=\"pl-k\">=</span> argparse.ArgumentParser(<span class=\"pl-v\">description</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>Bug!<span class=\"pl-pds\">'</span></span>)\n    parser.add_argument(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>--local_rank<span class=\"pl-pds\">'</span></span>, <span class=\"pl-v\">default</span><span class=\"pl-k\">=</span><span class=\"pl-c1\">0</span>)\n\n    args <span class=\"pl-k\">=</span> parser.parse_args()\n    <span class=\"pl-c1\">print</span>(args)</pre></div>\n<p>Run it with</p>\n<pre><code>python -m torch.distributed.launch --nproc_per_node=8 mwe.py\n</code></pre>\n<p>On the first run I tried, I got:</p>\n<pre><code>Traceback (most recent call last):\n  File \"mwe.py\", line 16, in &lt;module&gt;\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\n    return _import_module_from_library(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\n    file, path, description = imp.find_module(module_name, [path])\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\n    raise ImportError(_ERR_MSG.format(name), name=name)\nImportError: No module named 'multiprocess_bug'\nTraceback (most recent call last):\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 400, in _build_extension_module\n    ['ninja', '-v'], stderr=subprocess.STDOUT, cwd=build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/subprocess.py\", line 336, in check_output\n    **kwargs).stdout\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/subprocess.py\", line 418, in run\n    output=stdout, stderr=stderr)\nsubprocess.CalledProcessError: Command '['ninja', '-v']' returned non-zero exit status 1.\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in &lt;module&gt;\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 357, in load\n    _build_extension_module(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 406, in _build_extension_module\n    name, error.output.decode()))\nRuntimeError: Error building extension 'multiprocess_bug': [1/2] c++ -MMD -MF extension.o.d -DTORCH_EXTENSION_NAME=multiprocess_bug -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include/TH -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include/THC -I/private/home/fmassa/.conda/envs/detectron_v2/include/python3.6m -fPIC -std=c++11 -c /private/home/fmassa/github/pytorch/test/cpp_extensions/extension.cpp -o extension.o\n[2/2] c++ -shared extension.o -o multiprocess_bug.so\nFAILED: multiprocess_bug.so\nc++ -shared extension.o -o multiprocess_bug.so\nextension.o: file not recognized: File truncated\ncollect2: error: ld returned 1 exit status\nninja: build stopped: subcommand failed.\n\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in &lt;module&gt;\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\n    return _import_module_from_library(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\n    file, path, description = imp.find_module(module_name, [path])\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\n    raise ImportError(_ERR_MSG.format(name), name=name)\nImportError: No module named 'multiprocess_bug'\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in &lt;module&gt;\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\n    return _import_module_from_library(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\n    file, path, description = imp.find_module(module_name, [path])\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\n    raise ImportError(_ERR_MSG.format(name), name=name)\nImportError: No module named 'multiprocess_bug'\n</code></pre>", "body_text": "Here is a mwe.py  (note: you need to modify the path to pytorch_dir)\nimport argparse\n\ndef compile_ext():\n    import os.path\n    from torch.utils.cpp_extension import load as load_ext\n    pytorch_dir = '/private/home/fmassa/github/pytorch/test/cpp_extensions'\n    source = [\n        'extension.cpp',\n    ]\n    source = [os.path.join(pytorch_dir, s) for s in source]\n    return load_ext('multiprocess_bug', source)\n\n\n_C = compile_ext()\n\nif __name__ == \"__main__\":\n    parser = argparse.ArgumentParser(description='Bug!')\n    parser.add_argument('--local_rank', default=0)\n\n    args = parser.parse_args()\n    print(args)\nRun it with\npython -m torch.distributed.launch --nproc_per_node=8 mwe.py\n\nOn the first run I tried, I got:\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in <module>\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\n    return _import_module_from_library(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\n    file, path, description = imp.find_module(module_name, [path])\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\n    raise ImportError(_ERR_MSG.format(name), name=name)\nImportError: No module named 'multiprocess_bug'\nTraceback (most recent call last):\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 400, in _build_extension_module\n    ['ninja', '-v'], stderr=subprocess.STDOUT, cwd=build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/subprocess.py\", line 336, in check_output\n    **kwargs).stdout\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/subprocess.py\", line 418, in run\n    output=stdout, stderr=stderr)\nsubprocess.CalledProcessError: Command '['ninja', '-v']' returned non-zero exit status 1.\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in <module>\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 357, in load\n    _build_extension_module(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 406, in _build_extension_module\n    name, error.output.decode()))\nRuntimeError: Error building extension 'multiprocess_bug': [1/2] c++ -MMD -MF extension.o.d -DTORCH_EXTENSION_NAME=multiprocess_bug -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include/TH -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include/THC -I/private/home/fmassa/.conda/envs/detectron_v2/include/python3.6m -fPIC -std=c++11 -c /private/home/fmassa/github/pytorch/test/cpp_extensions/extension.cpp -o extension.o\n[2/2] c++ -shared extension.o -o multiprocess_bug.so\nFAILED: multiprocess_bug.so\nc++ -shared extension.o -o multiprocess_bug.so\nextension.o: file not recognized: File truncated\ncollect2: error: ld returned 1 exit status\nninja: build stopped: subcommand failed.\n\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in <module>\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\n    return _import_module_from_library(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\n    file, path, description = imp.find_module(module_name, [path])\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\n    raise ImportError(_ERR_MSG.format(name), name=name)\nImportError: No module named 'multiprocess_bug'\nTraceback (most recent call last):\n  File \"mwe.py\", line 16, in <module>\n    _C = compile_ext()\n  File \"mwe.py\", line 13, in compile_ext\n    return load_ext('multiprocess_bug', source)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\n    return _import_module_from_library(name, build_directory)\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\n    file, path, description = imp.find_module(module_name, [path])\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\n    raise ImportError(_ERR_MSG.format(name), name=name)\nImportError: No module named 'multiprocess_bug'", "body": "Here is a `mwe.py`  (note: you need to modify the path to `pytorch_dir`)\r\n\r\n```python\r\nimport argparse\r\n\r\ndef compile_ext():\r\n    import os.path\r\n    from torch.utils.cpp_extension import load as load_ext\r\n    pytorch_dir = '/private/home/fmassa/github/pytorch/test/cpp_extensions'\r\n    source = [\r\n        'extension.cpp',\r\n    ]\r\n    source = [os.path.join(pytorch_dir, s) for s in source]\r\n    return load_ext('multiprocess_bug', source)\r\n\r\n\r\n_C = compile_ext()\r\n\r\nif __name__ == \"__main__\":\r\n    parser = argparse.ArgumentParser(description='Bug!')\r\n    parser.add_argument('--local_rank', default=0)\r\n\r\n    args = parser.parse_args()\r\n    print(args)\r\n```\r\n\r\nRun it with\r\n```\r\npython -m torch.distributed.launch --nproc_per_node=8 mwe.py\r\n```\r\n\r\nOn the first run I tried, I got:\r\n```\r\nTraceback (most recent call last):\r\n  File \"mwe.py\", line 16, in <module>\r\n    _C = compile_ext()\r\n  File \"mwe.py\", line 13, in compile_ext\r\n    return load_ext('multiprocess_bug', source)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\r\n    return _import_module_from_library(name, build_directory)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\r\n    file, path, description = imp.find_module(module_name, [path])\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\r\n    raise ImportError(_ERR_MSG.format(name), name=name)\r\nImportError: No module named 'multiprocess_bug'\r\nTraceback (most recent call last):\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 400, in _build_extension_module\r\n    ['ninja', '-v'], stderr=subprocess.STDOUT, cwd=build_directory)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/subprocess.py\", line 336, in check_output\r\n    **kwargs).stdout\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/subprocess.py\", line 418, in run\r\n    output=stdout, stderr=stderr)\r\nsubprocess.CalledProcessError: Command '['ninja', '-v']' returned non-zero exit status 1.\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"mwe.py\", line 16, in <module>\r\n    _C = compile_ext()\r\n  File \"mwe.py\", line 13, in compile_ext\r\n    return load_ext('multiprocess_bug', source)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 357, in load\r\n    _build_extension_module(name, build_directory)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 406, in _build_extension_module\r\n    name, error.output.decode()))\r\nRuntimeError: Error building extension 'multiprocess_bug': [1/2] c++ -MMD -MF extension.o.d -DTORCH_EXTENSION_NAME=multiprocess_bug -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include/TH -I/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/lib/include/THC -I/private/home/fmassa/.conda/envs/detectron_v2/include/python3.6m -fPIC -std=c++11 -c /private/home/fmassa/github/pytorch/test/cpp_extensions/extension.cpp -o extension.o\r\n[2/2] c++ -shared extension.o -o multiprocess_bug.so\r\nFAILED: multiprocess_bug.so\r\nc++ -shared extension.o -o multiprocess_bug.so\r\nextension.o: file not recognized: File truncated\r\ncollect2: error: ld returned 1 exit status\r\nninja: build stopped: subcommand failed.\r\n\r\nTraceback (most recent call last):\r\n  File \"mwe.py\", line 16, in <module>\r\n    _C = compile_ext()\r\n  File \"mwe.py\", line 13, in compile_ext\r\n    return load_ext('multiprocess_bug', source)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\r\n    return _import_module_from_library(name, build_directory)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\r\n    file, path, description = imp.find_module(module_name, [path])\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\r\n    raise ImportError(_ERR_MSG.format(name), name=name)\r\nImportError: No module named 'multiprocess_bug'\r\nTraceback (most recent call last):\r\n  File \"mwe.py\", line 16, in <module>\r\n    _C = compile_ext()\r\n  File \"mwe.py\", line 13, in compile_ext\r\n    return load_ext('multiprocess_bug', source)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 361, in load\r\n    return _import_module_from_library(name, build_directory)\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/site-packages/torch/utils/cpp_extension.py\", line 411, in _import_module_from_library\r\n    file, path, description = imp.find_module(module_name, [path])\r\n  File \"/private/home/fmassa/.conda/envs/detectron_v2/lib/python3.6/imp.py\", line 297, in find_module\r\n    raise ImportError(_ERR_MSG.format(name), name=name)\r\nImportError: No module named 'multiprocess_bug'\r\n```"}