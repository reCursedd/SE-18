{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/424886274", "html_url": "https://github.com/pytorch/pytorch/issues/12042#issuecomment-424886274", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/12042", "id": 424886274, "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDg4NjI3NA==", "user": {"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, "created_at": "2018-09-26T22:10:18Z", "updated_at": "2018-09-26T22:10:18Z", "author_association": "CONTRIBUTOR", "body_html": "<p>Please recompile PyTorch with the following patch, which will fix write-time corruption.</p>\n<pre><code>diff --git a/torch/csrc/generic/serialization.cpp b/torch/csrc/generic/serialization.cpp\nindex 2299cce24..1e5889b15 100644\n--- a/torch/csrc/generic/serialization.cpp\n+++ b/torch/csrc/generic/serialization.cpp\n@@ -35,7 +35,7 @@ void THPStorage_(writeFileRaw)(THWStorage *self, io fd)\n       throw std::system_error(result, std::system_category());\n   } else {\n     int64_t buffer_size = std::min(size, (int64_t)5000);\n-    std::unique_ptr&lt;uint8_t[]&gt; le_buffer(new uint8_t[buffer_size * sizeof(scalar_t)]);\n+    std::unique_ptr&lt;char[]&gt; le_buffer(new char[buffer_size * sizeof(scalar_t)]);\n     for (int64_t i = 0; i &lt; size; i += buffer_size) {\n       size_t to_convert = std::min(size - i, buffer_size);\n       if (sizeof(scalar_t) == 2) {\n@@ -54,7 +54,19 @@ void THPStorage_(writeFileRaw)(THWStorage *self, io fd)\n             THPByteOrder::THP_LITTLE_ENDIAN,\n             to_convert);\n       }\n-      SYSCHECK(doWrite(fd, le_buffer.get(), to_convert * sizeof(scalar_t)));\n+      int64_t remaining = buffer_size * sizeof(scalar_t);\n+      char *bytes = le_buffer.get();\n+      while (remaining &gt; 0) {\n+        ssize_t result = doWrite(fd, bytes, to_convert * sizeof(scalar_t));\n+        if (result &lt; 0) {\n+          throw std::system_error(result, std::system_category());\n+        }\n+        bytes += result;\n+        remaining -= result;\n+      }\n+      if (remaining != 0) {\n+        throw std::system_error(result, std::system_category());\n+      }\n     }\n   }\n }\n</code></pre>\n<p>I am not 100% sure this will fix the problem, I need to audit the rest of the sites now.</p>", "body_text": "Please recompile PyTorch with the following patch, which will fix write-time corruption.\ndiff --git a/torch/csrc/generic/serialization.cpp b/torch/csrc/generic/serialization.cpp\nindex 2299cce24..1e5889b15 100644\n--- a/torch/csrc/generic/serialization.cpp\n+++ b/torch/csrc/generic/serialization.cpp\n@@ -35,7 +35,7 @@ void THPStorage_(writeFileRaw)(THWStorage *self, io fd)\n       throw std::system_error(result, std::system_category());\n   } else {\n     int64_t buffer_size = std::min(size, (int64_t)5000);\n-    std::unique_ptr<uint8_t[]> le_buffer(new uint8_t[buffer_size * sizeof(scalar_t)]);\n+    std::unique_ptr<char[]> le_buffer(new char[buffer_size * sizeof(scalar_t)]);\n     for (int64_t i = 0; i < size; i += buffer_size) {\n       size_t to_convert = std::min(size - i, buffer_size);\n       if (sizeof(scalar_t) == 2) {\n@@ -54,7 +54,19 @@ void THPStorage_(writeFileRaw)(THWStorage *self, io fd)\n             THPByteOrder::THP_LITTLE_ENDIAN,\n             to_convert);\n       }\n-      SYSCHECK(doWrite(fd, le_buffer.get(), to_convert * sizeof(scalar_t)));\n+      int64_t remaining = buffer_size * sizeof(scalar_t);\n+      char *bytes = le_buffer.get();\n+      while (remaining > 0) {\n+        ssize_t result = doWrite(fd, bytes, to_convert * sizeof(scalar_t));\n+        if (result < 0) {\n+          throw std::system_error(result, std::system_category());\n+        }\n+        bytes += result;\n+        remaining -= result;\n+      }\n+      if (remaining != 0) {\n+        throw std::system_error(result, std::system_category());\n+      }\n     }\n   }\n }\n\nI am not 100% sure this will fix the problem, I need to audit the rest of the sites now.", "body": "Please recompile PyTorch with the following patch, which will fix write-time corruption.\r\n\r\n```\r\ndiff --git a/torch/csrc/generic/serialization.cpp b/torch/csrc/generic/serialization.cpp\r\nindex 2299cce24..1e5889b15 100644\r\n--- a/torch/csrc/generic/serialization.cpp\r\n+++ b/torch/csrc/generic/serialization.cpp\r\n@@ -35,7 +35,7 @@ void THPStorage_(writeFileRaw)(THWStorage *self, io fd)\r\n       throw std::system_error(result, std::system_category());\r\n   } else {\r\n     int64_t buffer_size = std::min(size, (int64_t)5000);\r\n-    std::unique_ptr<uint8_t[]> le_buffer(new uint8_t[buffer_size * sizeof(scalar_t)]);\r\n+    std::unique_ptr<char[]> le_buffer(new char[buffer_size * sizeof(scalar_t)]);\r\n     for (int64_t i = 0; i < size; i += buffer_size) {\r\n       size_t to_convert = std::min(size - i, buffer_size);\r\n       if (sizeof(scalar_t) == 2) {\r\n@@ -54,7 +54,19 @@ void THPStorage_(writeFileRaw)(THWStorage *self, io fd)\r\n             THPByteOrder::THP_LITTLE_ENDIAN,\r\n             to_convert);\r\n       }\r\n-      SYSCHECK(doWrite(fd, le_buffer.get(), to_convert * sizeof(scalar_t)));\r\n+      int64_t remaining = buffer_size * sizeof(scalar_t);\r\n+      char *bytes = le_buffer.get();\r\n+      while (remaining > 0) {\r\n+        ssize_t result = doWrite(fd, bytes, to_convert * sizeof(scalar_t));\r\n+        if (result < 0) {\r\n+          throw std::system_error(result, std::system_category());\r\n+        }\r\n+        bytes += result;\r\n+        remaining -= result;\r\n+      }\r\n+      if (remaining != 0) {\r\n+        throw std::system_error(result, std::system_category());\r\n+      }\r\n     }\r\n   }\r\n }\r\n```\r\n\r\nI am not 100% sure this will fix the problem, I need to audit the rest of the sites now."}