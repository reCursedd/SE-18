{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/323203974", "html_url": "https://github.com/pytorch/pytorch/issues/2474#issuecomment-323203974", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/2474", "id": 323203974, "node_id": "MDEyOklzc3VlQ29tbWVudDMyMzIwMzk3NA==", "user": {"login": "vadimkantorov", "id": 1041752, "node_id": "MDQ6VXNlcjEwNDE3NTI=", "avatar_url": "https://avatars0.githubusercontent.com/u/1041752?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vadimkantorov", "html_url": "https://github.com/vadimkantorov", "followers_url": "https://api.github.com/users/vadimkantorov/followers", "following_url": "https://api.github.com/users/vadimkantorov/following{/other_user}", "gists_url": "https://api.github.com/users/vadimkantorov/gists{/gist_id}", "starred_url": "https://api.github.com/users/vadimkantorov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vadimkantorov/subscriptions", "organizations_url": "https://api.github.com/users/vadimkantorov/orgs", "repos_url": "https://api.github.com/users/vadimkantorov/repos", "events_url": "https://api.github.com/users/vadimkantorov/events{/privacy}", "received_events_url": "https://api.github.com/users/vadimkantorov/received_events", "type": "User", "site_admin": false}, "created_at": "2017-08-17T21:49:33Z", "updated_at": "2017-08-17T21:56:33Z", "author_association": "NONE", "body_html": "<p>While crafting such an example (that would immediately block worker threads by overflowing the 64Kb SimpleQueue buffer size and successifely blocking the main thread, since no worker threads would remove also large indices from indices_queue), I hit another problem, with exceptions and a deadlock too (but probably due to died worker threads).</p>\n<p>Do you understand where does <code>_run_finalizers</code> come from? Why is <code>reduce_storage</code> concerned? No tensors are used here.</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> torch.utils.data\n\ndataset <span class=\"pl-k\">=</span> <span class=\"pl-c1\">type</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, (), <span class=\"pl-c1\">dict</span>(<span class=\"pl-v\">__len__</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">self</span>: <span class=\"pl-c1\">100</span>, <span class=\"pl-v\">__getitem__</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">self</span>, <span class=\"pl-smi\">i</span>: <span class=\"pl-c1\">range</span>(<span class=\"pl-c1\">100000</span>)))()\nsampler <span class=\"pl-k\">=</span> <span class=\"pl-c1\">type</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span><span class=\"pl-pds\">'</span></span>, (), <span class=\"pl-c1\">dict</span>(<span class=\"pl-v\">__iter__</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">lambda</span> <span class=\"pl-smi\">self</span>: (<span class=\"pl-c1\">range</span>(<span class=\"pl-c1\">100000</span>) <span class=\"pl-k\">for</span> batch_ind <span class=\"pl-k\">in</span> <span class=\"pl-c1\">range</span>(<span class=\"pl-c1\">100</span>))))()\n\nd <span class=\"pl-k\">=</span> torch.utils.data.DataLoader(<span class=\"pl-v\">dataset</span> <span class=\"pl-k\">=</span> dataset, <span class=\"pl-v\">sampler</span> <span class=\"pl-k\">=</span> sampler, <span class=\"pl-v\">num_workers</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">4</span>)\n<span class=\"pl-k\">for</span> i, x <span class=\"pl-k\">in</span> <span class=\"pl-c1\">enumerate</span>(d):\n    <span class=\"pl-c1\">print</span>(i)</pre></div>\n<pre><code>Traceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-vR3nxX'\nProcess Process-1:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-QhgvsZ'\nProcess Process-2:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-duhyvc'\nProcess Process-4:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-fYDYx_'\nProcess Process-3:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\n\nHERE IS A DEADLOCK. PRESSING CTRL+C\n\nTraceback (most recent call last):\n  File \"bug.py\", line 7, in &lt;module&gt;\n    for i, x in enumerate(d):\n  File \".../torch/utils/data/dataloader.py\", line 302, in __iter__\n    return DataLoaderIter(self)\n  File \".../torch/utils/data/dataloader.py\", line 172, in __init__\n    self._put_indices()\n  File \".../torch/utils/data/dataloader.py\", line 214, in _put_indices\n    self.index_queue.put((self.send_idx, indices))\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n    return send(obj)\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n    ForkingPickler(buf, pickle.HIGHEST_PROTOCOL).dump(obj)\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n    self.save(obj)\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n    f(self, obj) # Call unbound method with explicit self\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n    save(element)\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n    f(self, obj) # Call unbound method with explicit self\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n    self._batch_appends(iter(obj))\n  File \"/usr/lib/python2.7/pickle.py\", line 630, in _batch_appends\n    x = items.next()\nKeyboardInterrupt\n</code></pre>\n<p>The base for the original deadlocking example should have been based on the fact that even this locks: <code>import torch.multiprocessing; q = torch.multiprocessing.SimpleQueue(); q.put(range(100000))</code></p>", "body_text": "While crafting such an example (that would immediately block worker threads by overflowing the 64Kb SimpleQueue buffer size and successifely blocking the main thread, since no worker threads would remove also large indices from indices_queue), I hit another problem, with exceptions and a deadlock too (but probably due to died worker threads).\nDo you understand where does _run_finalizers come from? Why is reduce_storage concerned? No tensors are used here.\nimport torch.utils.data\n\ndataset = type('', (), dict(__len__ = lambda self: 100, __getitem__ = lambda self, i: range(100000)))()\nsampler = type('', (), dict(__iter__ = lambda self: (range(100000) for batch_ind in range(100))))()\n\nd = torch.utils.data.DataLoader(dataset = dataset, sampler = sampler, num_workers = 4)\nfor i, x in enumerate(d):\n    print(i)\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-vR3nxX'\nProcess Process-1:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-QhgvsZ'\nProcess Process-2:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-duhyvc'\nProcess Process-4:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\nOSError: [Errno 24] Too many open files: '/tmp/pymp-fYDYx_'\nProcess Process-3:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\nOSError: [Errno 24] Too many open files\n\nHERE IS A DEADLOCK. PRESSING CTRL+C\n\nTraceback (most recent call last):\n  File \"bug.py\", line 7, in <module>\n    for i, x in enumerate(d):\n  File \".../torch/utils/data/dataloader.py\", line 302, in __iter__\n    return DataLoaderIter(self)\n  File \".../torch/utils/data/dataloader.py\", line 172, in __init__\n    self._put_indices()\n  File \".../torch/utils/data/dataloader.py\", line 214, in _put_indices\n    self.index_queue.put((self.send_idx, indices))\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\n    return send(obj)\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\n    ForkingPickler(buf, pickle.HIGHEST_PROTOCOL).dump(obj)\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\n    self.save(obj)\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n    f(self, obj) # Call unbound method with explicit self\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\n    save(element)\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\n    f(self, obj) # Call unbound method with explicit self\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\n    self._batch_appends(iter(obj))\n  File \"/usr/lib/python2.7/pickle.py\", line 630, in _batch_appends\n    x = items.next()\nKeyboardInterrupt\n\nThe base for the original deadlocking example should have been based on the fact that even this locks: import torch.multiprocessing; q = torch.multiprocessing.SimpleQueue(); q.put(range(100000))", "body": "While crafting such an example (that would immediately block worker threads by overflowing the 64Kb SimpleQueue buffer size and successifely blocking the main thread, since no worker threads would remove also large indices from indices_queue), I hit another problem, with exceptions and a deadlock too (but probably due to died worker threads). \r\n\r\nDo you understand where does `_run_finalizers` come from? Why is `reduce_storage` concerned? No tensors are used here.\r\n\r\n```python\r\nimport torch.utils.data\r\n\r\ndataset = type('', (), dict(__len__ = lambda self: 100, __getitem__ = lambda self, i: range(100000)))()\r\nsampler = type('', (), dict(__iter__ = lambda self: (range(100000) for batch_ind in range(100))))()\r\n\r\nd = torch.utils.data.DataLoader(dataset = dataset, sampler = sampler, num_workers = 4)\r\nfor i, x in enumerate(d):\r\n    print(i)\r\n```\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\r\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\r\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\r\nOSError: [Errno 24] Too many open files: '/tmp/pymp-vR3nxX'\r\nProcess Process-1:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\r\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\r\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\r\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\r\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\r\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\r\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\r\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\r\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\r\nOSError: [Errno 24] Too many open files\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\r\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\r\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\r\nOSError: [Errno 24] Too many open files: '/tmp/pymp-QhgvsZ'\r\nProcess Process-2:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\r\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\r\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\r\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\r\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\r\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\r\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\r\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\r\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\r\nOSError: [Errno 24] Too many open files\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\r\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\r\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\r\nOSError: [Errno 24] Too many open files: '/tmp/pymp-duhyvc'\r\nProcess Process-4:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\r\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\r\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\r\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\r\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\r\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\r\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\r\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\r\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\r\nOSError: [Errno 24] Too many open files\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 274, in _run_finalizers\r\n  File \"/usr/lib/python2.7/multiprocessing/util.py\", line 207, in __call__\r\n  File \"/usr/lib/python2.7/shutil.py\", line 239, in rmtree\r\n  File \"/usr/lib/python2.7/shutil.py\", line 237, in rmtree\r\nOSError: [Errno 24] Too many open files: '/tmp/pymp-fYDYx_'\r\nProcess Process-3:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 258, in _bootstrap\r\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\r\n  File \".../torch/utils/data/dataloader.py\", line 46, in _worker_loop\r\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\r\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\r\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\r\n  File \"/usr/lib/python2.7/pickle.py\", line 639, in _batch_appends\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 67, in dispatcher\r\n  File \"/usr/lib/python2.7/pickle.py\", line 401, in save_reduce\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n  File \"/usr/lib/python2.7/multiprocessing/forking.py\", line 66, in dispatcher\r\n  File \".../torch/multiprocessing/reductions.py\", line 115, in reduce_storage\r\n  File \"/usr/lib/python2.7/multiprocessing/reduction.py\", line 145, in reduce_handle\r\nOSError: [Errno 24] Too many open files\r\n\r\nHERE IS A DEADLOCK. PRESSING CTRL+C\r\n\r\nTraceback (most recent call last):\r\n  File \"bug.py\", line 7, in <module>\r\n    for i, x in enumerate(d):\r\n  File \".../torch/utils/data/dataloader.py\", line 302, in __iter__\r\n    return DataLoaderIter(self)\r\n  File \".../torch/utils/data/dataloader.py\", line 172, in __init__\r\n    self._put_indices()\r\n  File \".../torch/utils/data/dataloader.py\", line 214, in _put_indices\r\n    self.index_queue.put((self.send_idx, indices))\r\n  File \"/usr/lib/python2.7/multiprocessing/queues.py\", line 392, in put\r\n    return send(obj)\r\n  File \".../torch/multiprocessing/queue.py\", line 17, in send\r\n    ForkingPickler(buf, pickle.HIGHEST_PROTOCOL).dump(obj)\r\n  File \"/usr/lib/python2.7/pickle.py\", line 224, in dump\r\n    self.save(obj)\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n    f(self, obj) # Call unbound method with explicit self\r\n  File \"/usr/lib/python2.7/pickle.py\", line 554, in save_tuple\r\n    save(element)\r\n  File \"/usr/lib/python2.7/pickle.py\", line 286, in save\r\n    f(self, obj) # Call unbound method with explicit self\r\n  File \"/usr/lib/python2.7/pickle.py\", line 606, in save_list\r\n    self._batch_appends(iter(obj))\r\n  File \"/usr/lib/python2.7/pickle.py\", line 630, in _batch_appends\r\n    x = items.next()\r\nKeyboardInterrupt\r\n```\r\n\r\nThe base for the original deadlocking example should have been based on the fact that even this locks: `import torch.multiprocessing; q = torch.multiprocessing.SimpleQueue(); q.put(range(100000))`"}