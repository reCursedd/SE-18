{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/342405014", "html_url": "https://github.com/pytorch/pytorch/issues/3525#issuecomment-342405014", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/3525", "id": 342405014, "node_id": "MDEyOklzc3VlQ29tbWVudDM0MjQwNTAxNA==", "user": {"login": "MlWoo", "id": 20226293, "node_id": "MDQ6VXNlcjIwMjI2Mjkz", "avatar_url": "https://avatars2.githubusercontent.com/u/20226293?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MlWoo", "html_url": "https://github.com/MlWoo", "followers_url": "https://api.github.com/users/MlWoo/followers", "following_url": "https://api.github.com/users/MlWoo/following{/other_user}", "gists_url": "https://api.github.com/users/MlWoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/MlWoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MlWoo/subscriptions", "organizations_url": "https://api.github.com/users/MlWoo/orgs", "repos_url": "https://api.github.com/users/MlWoo/repos", "events_url": "https://api.github.com/users/MlWoo/events{/privacy}", "received_events_url": "https://api.github.com/users/MlWoo/received_events", "type": "User", "site_admin": false}, "created_at": "2017-11-07T08:05:22Z", "updated_at": "2017-11-07T08:12:41Z", "author_association": "CONTRIBUTOR", "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=5674597\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/SsnL\">@SsnL</a>  I have checked the code. <a href=\"https://github.com/pytorch/pytorch/commit/d04574b1fc73929faa1d6743e0486cda6586fd95#diff-845f134a51f3a63b10766c164a82c345\">blas modification</a> has a bug when trying to disable MKL  if stride values are not supported. The code in <a href=\"https://github.com/pytorch/pytorch/blob/d04574b1fc73929faa1d6743e0486cda6586fd95/torch/lib/TH/generic/THBlas.c#L325-L326\">lines</a></p>\n<pre><code>      (lda &gt;= THMax(1, (transa_ ? m : k))) &amp;&amp; (lda &lt;= INT_MAX) &amp;&amp;\n      (ldb &gt;= THMax(1, (transb_ ? k : n))) &amp;&amp; (ldb &lt;= INT_MAX) &amp;&amp;\n</code></pre>\n<p>has mistaken the condition so that it conflicts with the manual of <a href=\"https://software.intel.com/en-us/mkl-developer-reference-fortran-gemm\" rel=\"nofollow\">MKL</a>. it should be that</p>\n<pre><code>      (lda &gt;= THMax(1, (transa_ ? k : m))) &amp;&amp; (lda &lt;= INT_MAX) &amp;&amp;\n      (ldb &gt;= THMax(1, (transb_ ? n : k))) &amp;&amp; (ldb &lt;= INT_MAX) &amp;&amp;\n</code></pre>\n<p>The bug will disable MKL even if the stride values are legal. It will result in performance degrading in that benchmark.<br>\nPlz double check it and summit it to repo if no problems.</p>", "body_text": "@SsnL  I have checked the code. blas modification has a bug when trying to disable MKL  if stride values are not supported. The code in lines\n      (lda >= THMax(1, (transa_ ? m : k))) && (lda <= INT_MAX) &&\n      (ldb >= THMax(1, (transb_ ? k : n))) && (ldb <= INT_MAX) &&\n\nhas mistaken the condition so that it conflicts with the manual of MKL. it should be that\n      (lda >= THMax(1, (transa_ ? k : m))) && (lda <= INT_MAX) &&\n      (ldb >= THMax(1, (transb_ ? n : k))) && (ldb <= INT_MAX) &&\n\nThe bug will disable MKL even if the stride values are legal. It will result in performance degrading in that benchmark.\nPlz double check it and summit it to repo if no problems.", "body": "@SsnL  I have checked the code. [blas modification](https://github.com/pytorch/pytorch/commit/d04574b1fc73929faa1d6743e0486cda6586fd95#diff-845f134a51f3a63b10766c164a82c345) has a bug when trying to disable MKL  if stride values are not supported. The code in [lines](https://github.com/pytorch/pytorch/blob/d04574b1fc73929faa1d6743e0486cda6586fd95/torch/lib/TH/generic/THBlas.c#L325-L326) \r\n~~~\r\n      (lda >= THMax(1, (transa_ ? m : k))) && (lda <= INT_MAX) &&\r\n      (ldb >= THMax(1, (transb_ ? k : n))) && (ldb <= INT_MAX) &&\r\n~~~\r\nhas mistaken the condition so that it conflicts with the manual of [MKL](https://software.intel.com/en-us/mkl-developer-reference-fortran-gemm). it should be that\r\n~~~\r\n      (lda >= THMax(1, (transa_ ? k : m))) && (lda <= INT_MAX) &&\r\n      (ldb >= THMax(1, (transb_ ? n : k))) && (ldb <= INT_MAX) &&\r\n~~~\r\nThe bug will disable MKL even if the stride values are legal. It will result in performance degrading in that benchmark.\r\nPlz double check it and summit it to repo if no problems."}