{"url": "https://api.github.com/repos/pytorch/pytorch/issues/1636", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/1636/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/1636/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/1636/events", "html_url": "https://github.com/pytorch/pytorch/pull/1636", "id": 230849958, "node_id": "MDExOlB1bGxSZXF1ZXN0MTIyMDk3NzQy", "number": 1636, "title": "make THPPointer have explicit constructors", "user": {"login": "killeent", "id": 4529377, "node_id": "MDQ6VXNlcjQ1MjkzNzc=", "avatar_url": "https://avatars1.githubusercontent.com/u/4529377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/killeent", "html_url": "https://github.com/killeent", "followers_url": "https://api.github.com/users/killeent/followers", "following_url": "https://api.github.com/users/killeent/following{/other_user}", "gists_url": "https://api.github.com/users/killeent/gists{/gist_id}", "starred_url": "https://api.github.com/users/killeent/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/killeent/subscriptions", "organizations_url": "https://api.github.com/users/killeent/orgs", "repos_url": "https://api.github.com/users/killeent/repos", "events_url": "https://api.github.com/users/killeent/events{/privacy}", "received_events_url": "https://api.github.com/users/killeent/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-05-23T21:18:24Z", "updated_at": "2018-11-23T15:33:32Z", "closed_at": "2017-05-25T19:35:55Z", "author_association": "CONTRIBUTOR", "pull_request": {"url": "https://api.github.com/repos/pytorch/pytorch/pulls/1636", "html_url": "https://github.com/pytorch/pytorch/pull/1636", "diff_url": "https://github.com/pytorch/pytorch/pull/1636.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/1636.patch"}, "body_html": "<p>Previously, THPPointer did not have its constructors marked as explicit. As a result, something like:</p>\n<pre><code>THTensor *someIntermediateResult = THTensor_(new)(LIBRARY_STATE_NOARGS);\n// do some things to someIntermediateResult\nTHPTensor wrapped = someIntermediateResult; // calls implicit constructor\n</code></pre>\n<p>The fact that <code>THPTensor</code> takes \"ownership\" of the <code>THTensor</code> in this case is obfuscated, which could lead to double frees.</p>\n<p>This diff marks all the <code>THPTensor</code> constructors explicit, preventing this type of implicit constructor from a pointer. I followed it with the following codemod:</p>\n<pre><code>codemod -m -d torch/ --extensions h,hpp,cpp,cwrap \\\n    '(TH[a-zA-Z_]+Ptr [a-zA-Z_]+) = ([^;]*);'  \\\n    '\\1(\\2);'\n</code></pre>\n<p>To replace all assignment calls with calls to the explicit constructor. There were a couple of other places where I need to fix this, e.g. in the <code>THPPlugin.py</code> allocation template.</p>\n<p>Test Plan: Run Tests locally</p>", "body_text": "Previously, THPPointer did not have its constructors marked as explicit. As a result, something like:\nTHTensor *someIntermediateResult = THTensor_(new)(LIBRARY_STATE_NOARGS);\n// do some things to someIntermediateResult\nTHPTensor wrapped = someIntermediateResult; // calls implicit constructor\n\nThe fact that THPTensor takes \"ownership\" of the THTensor in this case is obfuscated, which could lead to double frees.\nThis diff marks all the THPTensor constructors explicit, preventing this type of implicit constructor from a pointer. I followed it with the following codemod:\ncodemod -m -d torch/ --extensions h,hpp,cpp,cwrap \\\n    '(TH[a-zA-Z_]+Ptr [a-zA-Z_]+) = ([^;]*);'  \\\n    '\\1(\\2);'\n\nTo replace all assignment calls with calls to the explicit constructor. There were a couple of other places where I need to fix this, e.g. in the THPPlugin.py allocation template.\nTest Plan: Run Tests locally", "body": "Previously, THPPointer did not have its constructors marked as explicit. As a result, something like:\r\n\r\n```\r\nTHTensor *someIntermediateResult = THTensor_(new)(LIBRARY_STATE_NOARGS);\r\n// do some things to someIntermediateResult\r\nTHPTensor wrapped = someIntermediateResult; // calls implicit constructor\r\n```\r\n\r\nThe fact that `THPTensor` takes \"ownership\" of the `THTensor` in this case is obfuscated, which could lead to double frees. \r\n\r\nThis diff marks all the `THPTensor` constructors explicit, preventing this type of implicit constructor from a pointer. I followed it with the following codemod:\r\n\r\n```\r\ncodemod -m -d torch/ --extensions h,hpp,cpp,cwrap \\\r\n    '(TH[a-zA-Z_]+Ptr [a-zA-Z_]+) = ([^;]*);'  \\\r\n    '\\1(\\2);'\r\n```\r\n\r\nTo replace all assignment calls with calls to the explicit constructor. There were a couple of other places where I need to fix this, e.g. in the `THPPlugin.py` allocation template. \r\n\r\nTest Plan: Run Tests locally"}