{"url": "https://api.github.com/repos/pytorch/pytorch/issues/5522", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/5522/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/5522/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/5522/events", "html_url": "https://github.com/pytorch/pytorch/issues/5522", "id": 301792692, "node_id": "MDU6SXNzdWUzMDE3OTI2OTI=", "number": 5522, "title": "test_nn.py CPU tests require up to 250M of memory to run (and usage increases monotonically)", "user": {"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2018-03-02T14:55:12Z", "updated_at": "2018-05-07T21:06:26Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<p>I noticed this because our ASAN CI occasionally OOMs. Example run: <a href=\"https://ci.pytorch.org/jenkins/job/pytorch-builds/job/pytorch-linux-xenial-py3-clang5-asan-test/420//consoleFull\" rel=\"nofollow\">https://ci.pytorch.org/jenkins/job/pytorch-builds/job/pytorch-linux-xenial-py3-clang5-asan-test/420//consoleFull</a></p>\n<p>Full process map:</p>\n<pre><code>[Fri Mar  2 11:34:55 2018] java invoked oom-killer: gfp_mask=0x24201ca, order=0, oom_score_adj=0\n[Fri Mar  2 11:34:55 2018] java cpuset=/ mems_allowed=0\n[Fri Mar  2 11:34:55 2018] CPU: 0 PID: 31758 Comm: java Not tainted 4.4.0-1052-aws #61-Ubuntu\n[Fri Mar  2 11:34:55 2018] Hardware name: Amazon EC2 c5.xlarge/, BIOS 1.0 10/16/2017\n[Fri Mar  2 11:34:55 2018]  0000000000000286 4b8096fcbf744f95 ffff8800bbb939d8 ffffffff813fce53\n[Fri Mar  2 11:34:55 2018]  ffff8800bbb93b90 ffff8800b37d2a00 ffff8800bbb93a48 ffffffff8120d1ba\n[Fri Mar  2 11:34:55 2018]  0000000000000015 0000000000000000 ffff880036ff6240 ffff8800bbb9bf00\n[Fri Mar  2 11:34:55 2018] Call Trace:\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff813fce53&gt;] dump_stack+0x63/0x90\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff8120d1ba&gt;] dump_header+0x5a/0x1c5\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff81394d14&gt;] ? apparmor_capable+0xc4/0x1b0\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff81193eb2&gt;] oom_kill_process+0x202/0x3c0\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff811942d9&gt;] out_of_memory+0x219/0x460\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff8119a305&gt;] __alloc_pages_slowpath.constprop.88+0x965/0xb00\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff8119a728&gt;] __alloc_pages_nodemask+0x288/0x2a0\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff811e428c&gt;] alloc_pages_current+0x8c/0x110\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff811903cb&gt;] __page_cache_alloc+0xab/0xc0\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff81192950&gt;] filemap_fault+0x150/0x400\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff812a5266&gt;] ext4_filemap_fault+0x36/0x50\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff811bf7d6&gt;] __do_fault+0x56/0xf0\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff811c3332&gt;] handle_mm_fault+0xfa2/0x1820\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff8106c737&gt;] __do_page_fault+0x197/0x400\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff8106ca07&gt;] trace_do_page_fault+0x37/0xe0\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff81064fb9&gt;] do_async_page_fault+0x19/0x70\n[Fri Mar  2 11:34:55 2018]  [&lt;ffffffff818250c8&gt;] async_page_fault+0x28/0x30\n[Fri Mar  2 11:34:55 2018] Mem-Info:\n[Fri Mar  2 11:34:55 2018] active_anon:1875155 inactive_anon:10095 isolated_anon:0\n                            active_file:59 inactive_file:0 isolated_file:0\n                            unevictable:912 dirty:0 writeback:0 unstable:0\n                            slab_reclaimable:16613 slab_unreclaimable:6392\n                            mapped:1982 shmem:10392 pagetables:4987 bounce:0\n                            free:25410 free_pcp:475 free_cma:0\n[Fri Mar  2 11:34:55 2018] Node 0 DMA32 free:44812kB min:26280kB low:32848kB high:39420kB active_anon:2923600kB inactive_anon:21992kB active_file:164kB ina\nctive_file:0kB unevictable:156kB isolated(anon):0kB isolated(file):0kB present:3129320kB managed:3048932kB mlocked:156kB dirty:0kB writeback:0kB mapped:470\n4kB shmem:22180kB slab_reclaimable:23824kB slab_unreclaimable:11292kB kernel_stack:1600kB pagetables:6760kB unstable:0kB bounce:0kB free_pcp:1032kB local_p\ncp:120kB free_cma:0kB writeback_tmp:0kB pages_scanned:4856 all_unreclaimable? yes\n[Fri Mar  2 11:34:55 2018] lowmem_reserve[]: 0 0 4638 4638 4638\n[Fri Mar  2 11:34:55 2018] Node 0 Normal free:40920kB min:41160kB low:51448kB high:61740kB active_anon:4577020kB inactive_anon:18388kB active_file:72kB ina\nctive_file:64kB unevictable:3492kB isolated(anon):0kB isolated(file):0kB present:4878336kB managed:4750040kB mlocked:3496kB dirty:0kB writeback:0kB mapped:\n3224kB shmem:19388kB slab_reclaimable:42628kB slab_unreclaimable:14276kB kernel_stack:2368kB pagetables:13188kB unstable:0kB bounce:0kB free_pcp:868kB loca\nl_pcp:120kB free_cma:0kB writeback_tmp:0kB pages_sc\nanned:5024 all_unreclaimable? yes\n[Fri Mar  2 11:34:55 2018] lowmem_reserve[]: 0 0 0 0 0\n[Fri Mar  2 11:34:55 2018] Node 0 DMA: 1*4kB (U) 0*8kB 0*16kB 1*32kB (U) 2*64kB (U) 1*128kB (U) 1*256kB (U) 0*512kB 1*1024kB (U) 1*2048kB (M) 3*4096kB (M) = 15908kB\n[Fri Mar  2 11:34:55 2018] Node 0 DMA32: 497*4kB (UE) 337*8kB (UME) 346*16kB (UME) 299*32kB (UME) 153*64kB (UME) 71*128kB (ME) 24*256kB (ME) 0*512kB 0*1024kB 0*2048kB 0*4096kB = 44812kB\n[Fri Mar  2 11:34:55 2018] Node 0 Normal: 582*4kB (UE) 259*8kB (UE) 263*16kB (UME) 234*32kB (UE) 148*64kB (UE) 76*128kB (ME) 21*256kB (E) 0*512kB 0*1024kB 0*2048kB 0*4096kB = 40672kB\n[Fri Mar  2 11:34:55 2018] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=1048576kB\n[Fri Mar  2 11:34:55 2018] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=2048kB\n[Fri Mar  2 11:34:55 2018] 11117 total pagecache pages\n[Fri Mar  2 11:34:55 2018] 0 pages in swap cache\n[Fri Mar  2 11:34:55 2018] Swap cache stats: add 0, delete 0, find 0/0\n[Fri Mar  2 11:34:55 2018] Free swap  = 0kB\n[Fri Mar  2 11:34:55 2018] Total swap = 0kB\n[Fri Mar  2 11:34:55 2018] 2005912 pages RAM\n[Fri Mar  2 11:34:55 2018] 0 pages HighMem/MovableOnly\n[Fri Mar  2 11:34:55 2018] 52192 pages reserved\n[Fri Mar  2 11:34:55 2018] 0 pages cma reserved\n[Fri Mar  2 11:34:55 2018] 0 pages hwpoisoned\n[Fri Mar  2 11:34:55 2018] [ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name\n[Fri Mar  2 11:34:55 2018] [  442]     0   442     8818     1778      21       3        0             0 systemd-journal\n[Fri Mar  2 11:34:55 2018] [  512]     0   512    23693      184      16       3        0             0 lvmetad\n[Fri Mar  2 11:34:55 2018] [  558]     0   558    10728      710      22       3        0         -1000 systemd-udevd\n[Fri Mar  2 11:34:55 2018] [  941]   100   941    25081      462      19       4        0             0 systemd-timesyn\n[Fri Mar  2 11:34:55 2018] [ 1060]     0  1060     4030      518      11       3        0             0 dhclient\n[Fri Mar  2 11:34:55 2018] [ 1253]     0  1253     1305       29       8       4        0             0 iscsid\n[Fri Mar  2 11:34:55 2018] [ 1254]     0  1254     1430      877       9       4        0           -17 iscsid\n[Fri Mar  2 11:34:55 2018] [ 1258]   107  1258    10733      535      26       3        0          -900 dbus-daemon\n[Fri Mar  2 11:34:55 2018] [ 1262]     0  1262     7136      494      19       3        0             0 systemd-logind\n[Fri Mar  2 11:34:55 2018] [ 1266]     0  1266   204840    11082     122       6        0          -500 dockerd\n[Fri Mar  2 11:34:55 2018] [ 1270]     0  1270     1099      302       8       3        0             0 acpid\n[Fri Mar  2 11:34:55 2018] [ 1274]     0  1274    16377      605      35       3        0         -1000 sshd\n[Fri Mar  2 11:34:55 2018] [ 1276]     0  1276     6511      420      17       3        0             0 atd\n[Fri Mar  2 11:34:55 2018] [ 1278]     0  1278    58693      320      16       4        0             0 lxcfs\n[Fri Mar  2 11:34:55 2018] [ 1280]   104  1280    65157      557      29       3        0             0 rsyslogd\n[Fri Mar  2 11:34:55 2018] [ 1282]     0  1282    76704     3147      37       5        0          -900 snapd\n[Fri Mar  2 11:34:55 2018] [ 1284]     0  1284    68654      458      36       3        0             0 accounts-daemon\n[Fri Mar  2 11:34:55 2018] [ 1293]     0  1293     6932      494      18       3        0             0 cron\n[Fri Mar  2 11:34:55 2018] [ 1314]     0  1314     3343       35      11       3        0             0 mdadm\n[Fri Mar  2 11:34:55 2018] [ 1322]     0  1322    69829      547      40       3        0             0 polkitd\n[Fri Mar  2 11:34:55 2018] [ 1387]     0  1387     4868       61      14       3        0             0 irqbalance\n[Fri Mar  2 11:34:55 2018] [ 1396]     0  1396     3618      372      12       3        0             0 agetty\n[Fri Mar  2 11:34:55 2018] [ 1401]     0  1401     3664      357      12       3        0             0 agetty\n[Fri Mar  2 11:34:55 2018] [ 1406]     0  1406   141074     5225      51       5        0          -500 docker-containe\n[Fri Mar  2 11:34:55 2018] [ 2311]  1014  2311  1363854   502280    1073       9        0             0 java\n[Fri Mar  2 11:34:55 2018] [15719]     0 15719     1880      425       8       5        0          -999 docker-containe\n[Fri Mar  2 11:34:55 2018] [15735]     0 15735     1133       15       8       3        0             0 cat\n[Fri Mar  2 11:34:55 2018] [11190]  1014 11190     4934      464      13       3        0             0 bash\n[Fri Mar  2 11:34:55 2018] [11524]     0 11524     1880      172       8       5        0          -999 docker-containe\n[Fri Mar  2 11:34:55 2018] [11541]     0 11541     1133       16       8       3        0             0 cat\n[Fri Mar  2 11:34:55 2018] [11597]  1014 11597    72203      832      33       5        0             0 docker\n[Fri Mar  2 11:34:55 2018] [11614]  1014 11614     4511       54      14       3        0             0 bash\n[Fri Mar  2 11:34:55 2018] [11625]  1014 11625     4520       74      14       3        0             0 test.sh\n[Fri Mar  2 11:34:55 2018] [11797]  1014 11797 5368730484     2887      36       7        0             0 bash\n[Fri Mar  2 11:34:55 2018] [12380]  1014 12380 5369079647  1344600    3139     249        0             0 python\n[Fri Mar  2 11:34:55 2018] Out of memory: Kill process 12380 (python) score 689 or sacrifice child\n[Fri Mar  2 11:34:55 2018] Killed process 12380 (python) total-vm:21476318588kB, anon-rss:5378400kB, file-rss:0kB\n</code></pre>\n<p>It is not that surprising that ASAN fails but the regular build does not, because ASAN uses more memory; however, I ran some quick tests with vanilla <code>test_nn.py</code> and noted that it also continually uses more memory as you run it.</p>\n<p>I'm going to submit a workaround for the ASAN case, and also post some extra evidence about the memory usage shortly.</p>", "body_text": "I noticed this because our ASAN CI occasionally OOMs. Example run: https://ci.pytorch.org/jenkins/job/pytorch-builds/job/pytorch-linux-xenial-py3-clang5-asan-test/420//consoleFull\nFull process map:\n[Fri Mar  2 11:34:55 2018] java invoked oom-killer: gfp_mask=0x24201ca, order=0, oom_score_adj=0\n[Fri Mar  2 11:34:55 2018] java cpuset=/ mems_allowed=0\n[Fri Mar  2 11:34:55 2018] CPU: 0 PID: 31758 Comm: java Not tainted 4.4.0-1052-aws #61-Ubuntu\n[Fri Mar  2 11:34:55 2018] Hardware name: Amazon EC2 c5.xlarge/, BIOS 1.0 10/16/2017\n[Fri Mar  2 11:34:55 2018]  0000000000000286 4b8096fcbf744f95 ffff8800bbb939d8 ffffffff813fce53\n[Fri Mar  2 11:34:55 2018]  ffff8800bbb93b90 ffff8800b37d2a00 ffff8800bbb93a48 ffffffff8120d1ba\n[Fri Mar  2 11:34:55 2018]  0000000000000015 0000000000000000 ffff880036ff6240 ffff8800bbb9bf00\n[Fri Mar  2 11:34:55 2018] Call Trace:\n[Fri Mar  2 11:34:55 2018]  [<ffffffff813fce53>] dump_stack+0x63/0x90\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8120d1ba>] dump_header+0x5a/0x1c5\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81394d14>] ? apparmor_capable+0xc4/0x1b0\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81193eb2>] oom_kill_process+0x202/0x3c0\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811942d9>] out_of_memory+0x219/0x460\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8119a305>] __alloc_pages_slowpath.constprop.88+0x965/0xb00\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8119a728>] __alloc_pages_nodemask+0x288/0x2a0\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811e428c>] alloc_pages_current+0x8c/0x110\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811903cb>] __page_cache_alloc+0xab/0xc0\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81192950>] filemap_fault+0x150/0x400\n[Fri Mar  2 11:34:55 2018]  [<ffffffff812a5266>] ext4_filemap_fault+0x36/0x50\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811bf7d6>] __do_fault+0x56/0xf0\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811c3332>] handle_mm_fault+0xfa2/0x1820\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8106c737>] __do_page_fault+0x197/0x400\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8106ca07>] trace_do_page_fault+0x37/0xe0\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81064fb9>] do_async_page_fault+0x19/0x70\n[Fri Mar  2 11:34:55 2018]  [<ffffffff818250c8>] async_page_fault+0x28/0x30\n[Fri Mar  2 11:34:55 2018] Mem-Info:\n[Fri Mar  2 11:34:55 2018] active_anon:1875155 inactive_anon:10095 isolated_anon:0\n                            active_file:59 inactive_file:0 isolated_file:0\n                            unevictable:912 dirty:0 writeback:0 unstable:0\n                            slab_reclaimable:16613 slab_unreclaimable:6392\n                            mapped:1982 shmem:10392 pagetables:4987 bounce:0\n                            free:25410 free_pcp:475 free_cma:0\n[Fri Mar  2 11:34:55 2018] Node 0 DMA32 free:44812kB min:26280kB low:32848kB high:39420kB active_anon:2923600kB inactive_anon:21992kB active_file:164kB ina\nctive_file:0kB unevictable:156kB isolated(anon):0kB isolated(file):0kB present:3129320kB managed:3048932kB mlocked:156kB dirty:0kB writeback:0kB mapped:470\n4kB shmem:22180kB slab_reclaimable:23824kB slab_unreclaimable:11292kB kernel_stack:1600kB pagetables:6760kB unstable:0kB bounce:0kB free_pcp:1032kB local_p\ncp:120kB free_cma:0kB writeback_tmp:0kB pages_scanned:4856 all_unreclaimable? yes\n[Fri Mar  2 11:34:55 2018] lowmem_reserve[]: 0 0 4638 4638 4638\n[Fri Mar  2 11:34:55 2018] Node 0 Normal free:40920kB min:41160kB low:51448kB high:61740kB active_anon:4577020kB inactive_anon:18388kB active_file:72kB ina\nctive_file:64kB unevictable:3492kB isolated(anon):0kB isolated(file):0kB present:4878336kB managed:4750040kB mlocked:3496kB dirty:0kB writeback:0kB mapped:\n3224kB shmem:19388kB slab_reclaimable:42628kB slab_unreclaimable:14276kB kernel_stack:2368kB pagetables:13188kB unstable:0kB bounce:0kB free_pcp:868kB loca\nl_pcp:120kB free_cma:0kB writeback_tmp:0kB pages_sc\nanned:5024 all_unreclaimable? yes\n[Fri Mar  2 11:34:55 2018] lowmem_reserve[]: 0 0 0 0 0\n[Fri Mar  2 11:34:55 2018] Node 0 DMA: 1*4kB (U) 0*8kB 0*16kB 1*32kB (U) 2*64kB (U) 1*128kB (U) 1*256kB (U) 0*512kB 1*1024kB (U) 1*2048kB (M) 3*4096kB (M) = 15908kB\n[Fri Mar  2 11:34:55 2018] Node 0 DMA32: 497*4kB (UE) 337*8kB (UME) 346*16kB (UME) 299*32kB (UME) 153*64kB (UME) 71*128kB (ME) 24*256kB (ME) 0*512kB 0*1024kB 0*2048kB 0*4096kB = 44812kB\n[Fri Mar  2 11:34:55 2018] Node 0 Normal: 582*4kB (UE) 259*8kB (UE) 263*16kB (UME) 234*32kB (UE) 148*64kB (UE) 76*128kB (ME) 21*256kB (E) 0*512kB 0*1024kB 0*2048kB 0*4096kB = 40672kB\n[Fri Mar  2 11:34:55 2018] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=1048576kB\n[Fri Mar  2 11:34:55 2018] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=2048kB\n[Fri Mar  2 11:34:55 2018] 11117 total pagecache pages\n[Fri Mar  2 11:34:55 2018] 0 pages in swap cache\n[Fri Mar  2 11:34:55 2018] Swap cache stats: add 0, delete 0, find 0/0\n[Fri Mar  2 11:34:55 2018] Free swap  = 0kB\n[Fri Mar  2 11:34:55 2018] Total swap = 0kB\n[Fri Mar  2 11:34:55 2018] 2005912 pages RAM\n[Fri Mar  2 11:34:55 2018] 0 pages HighMem/MovableOnly\n[Fri Mar  2 11:34:55 2018] 52192 pages reserved\n[Fri Mar  2 11:34:55 2018] 0 pages cma reserved\n[Fri Mar  2 11:34:55 2018] 0 pages hwpoisoned\n[Fri Mar  2 11:34:55 2018] [ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name\n[Fri Mar  2 11:34:55 2018] [  442]     0   442     8818     1778      21       3        0             0 systemd-journal\n[Fri Mar  2 11:34:55 2018] [  512]     0   512    23693      184      16       3        0             0 lvmetad\n[Fri Mar  2 11:34:55 2018] [  558]     0   558    10728      710      22       3        0         -1000 systemd-udevd\n[Fri Mar  2 11:34:55 2018] [  941]   100   941    25081      462      19       4        0             0 systemd-timesyn\n[Fri Mar  2 11:34:55 2018] [ 1060]     0  1060     4030      518      11       3        0             0 dhclient\n[Fri Mar  2 11:34:55 2018] [ 1253]     0  1253     1305       29       8       4        0             0 iscsid\n[Fri Mar  2 11:34:55 2018] [ 1254]     0  1254     1430      877       9       4        0           -17 iscsid\n[Fri Mar  2 11:34:55 2018] [ 1258]   107  1258    10733      535      26       3        0          -900 dbus-daemon\n[Fri Mar  2 11:34:55 2018] [ 1262]     0  1262     7136      494      19       3        0             0 systemd-logind\n[Fri Mar  2 11:34:55 2018] [ 1266]     0  1266   204840    11082     122       6        0          -500 dockerd\n[Fri Mar  2 11:34:55 2018] [ 1270]     0  1270     1099      302       8       3        0             0 acpid\n[Fri Mar  2 11:34:55 2018] [ 1274]     0  1274    16377      605      35       3        0         -1000 sshd\n[Fri Mar  2 11:34:55 2018] [ 1276]     0  1276     6511      420      17       3        0             0 atd\n[Fri Mar  2 11:34:55 2018] [ 1278]     0  1278    58693      320      16       4        0             0 lxcfs\n[Fri Mar  2 11:34:55 2018] [ 1280]   104  1280    65157      557      29       3        0             0 rsyslogd\n[Fri Mar  2 11:34:55 2018] [ 1282]     0  1282    76704     3147      37       5        0          -900 snapd\n[Fri Mar  2 11:34:55 2018] [ 1284]     0  1284    68654      458      36       3        0             0 accounts-daemon\n[Fri Mar  2 11:34:55 2018] [ 1293]     0  1293     6932      494      18       3        0             0 cron\n[Fri Mar  2 11:34:55 2018] [ 1314]     0  1314     3343       35      11       3        0             0 mdadm\n[Fri Mar  2 11:34:55 2018] [ 1322]     0  1322    69829      547      40       3        0             0 polkitd\n[Fri Mar  2 11:34:55 2018] [ 1387]     0  1387     4868       61      14       3        0             0 irqbalance\n[Fri Mar  2 11:34:55 2018] [ 1396]     0  1396     3618      372      12       3        0             0 agetty\n[Fri Mar  2 11:34:55 2018] [ 1401]     0  1401     3664      357      12       3        0             0 agetty\n[Fri Mar  2 11:34:55 2018] [ 1406]     0  1406   141074     5225      51       5        0          -500 docker-containe\n[Fri Mar  2 11:34:55 2018] [ 2311]  1014  2311  1363854   502280    1073       9        0             0 java\n[Fri Mar  2 11:34:55 2018] [15719]     0 15719     1880      425       8       5        0          -999 docker-containe\n[Fri Mar  2 11:34:55 2018] [15735]     0 15735     1133       15       8       3        0             0 cat\n[Fri Mar  2 11:34:55 2018] [11190]  1014 11190     4934      464      13       3        0             0 bash\n[Fri Mar  2 11:34:55 2018] [11524]     0 11524     1880      172       8       5        0          -999 docker-containe\n[Fri Mar  2 11:34:55 2018] [11541]     0 11541     1133       16       8       3        0             0 cat\n[Fri Mar  2 11:34:55 2018] [11597]  1014 11597    72203      832      33       5        0             0 docker\n[Fri Mar  2 11:34:55 2018] [11614]  1014 11614     4511       54      14       3        0             0 bash\n[Fri Mar  2 11:34:55 2018] [11625]  1014 11625     4520       74      14       3        0             0 test.sh\n[Fri Mar  2 11:34:55 2018] [11797]  1014 11797 5368730484     2887      36       7        0             0 bash\n[Fri Mar  2 11:34:55 2018] [12380]  1014 12380 5369079647  1344600    3139     249        0             0 python\n[Fri Mar  2 11:34:55 2018] Out of memory: Kill process 12380 (python) score 689 or sacrifice child\n[Fri Mar  2 11:34:55 2018] Killed process 12380 (python) total-vm:21476318588kB, anon-rss:5378400kB, file-rss:0kB\n\nIt is not that surprising that ASAN fails but the regular build does not, because ASAN uses more memory; however, I ran some quick tests with vanilla test_nn.py and noted that it also continually uses more memory as you run it.\nI'm going to submit a workaround for the ASAN case, and also post some extra evidence about the memory usage shortly.", "body": "I noticed this because our ASAN CI occasionally OOMs. Example run: https://ci.pytorch.org/jenkins/job/pytorch-builds/job/pytorch-linux-xenial-py3-clang5-asan-test/420//consoleFull\r\n\r\nFull process map:\r\n\r\n```\r\n[Fri Mar  2 11:34:55 2018] java invoked oom-killer: gfp_mask=0x24201ca, order=0, oom_score_adj=0\r\n[Fri Mar  2 11:34:55 2018] java cpuset=/ mems_allowed=0\r\n[Fri Mar  2 11:34:55 2018] CPU: 0 PID: 31758 Comm: java Not tainted 4.4.0-1052-aws #61-Ubuntu\r\n[Fri Mar  2 11:34:55 2018] Hardware name: Amazon EC2 c5.xlarge/, BIOS 1.0 10/16/2017\r\n[Fri Mar  2 11:34:55 2018]  0000000000000286 4b8096fcbf744f95 ffff8800bbb939d8 ffffffff813fce53\r\n[Fri Mar  2 11:34:55 2018]  ffff8800bbb93b90 ffff8800b37d2a00 ffff8800bbb93a48 ffffffff8120d1ba\r\n[Fri Mar  2 11:34:55 2018]  0000000000000015 0000000000000000 ffff880036ff6240 ffff8800bbb9bf00\r\n[Fri Mar  2 11:34:55 2018] Call Trace:\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff813fce53>] dump_stack+0x63/0x90\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8120d1ba>] dump_header+0x5a/0x1c5\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81394d14>] ? apparmor_capable+0xc4/0x1b0\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81193eb2>] oom_kill_process+0x202/0x3c0\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811942d9>] out_of_memory+0x219/0x460\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8119a305>] __alloc_pages_slowpath.constprop.88+0x965/0xb00\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8119a728>] __alloc_pages_nodemask+0x288/0x2a0\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811e428c>] alloc_pages_current+0x8c/0x110\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811903cb>] __page_cache_alloc+0xab/0xc0\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81192950>] filemap_fault+0x150/0x400\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff812a5266>] ext4_filemap_fault+0x36/0x50\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811bf7d6>] __do_fault+0x56/0xf0\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff811c3332>] handle_mm_fault+0xfa2/0x1820\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8106c737>] __do_page_fault+0x197/0x400\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff8106ca07>] trace_do_page_fault+0x37/0xe0\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff81064fb9>] do_async_page_fault+0x19/0x70\r\n[Fri Mar  2 11:34:55 2018]  [<ffffffff818250c8>] async_page_fault+0x28/0x30\r\n[Fri Mar  2 11:34:55 2018] Mem-Info:\r\n[Fri Mar  2 11:34:55 2018] active_anon:1875155 inactive_anon:10095 isolated_anon:0\r\n                            active_file:59 inactive_file:0 isolated_file:0\r\n                            unevictable:912 dirty:0 writeback:0 unstable:0\r\n                            slab_reclaimable:16613 slab_unreclaimable:6392\r\n                            mapped:1982 shmem:10392 pagetables:4987 bounce:0\r\n                            free:25410 free_pcp:475 free_cma:0\r\n[Fri Mar  2 11:34:55 2018] Node 0 DMA32 free:44812kB min:26280kB low:32848kB high:39420kB active_anon:2923600kB inactive_anon:21992kB active_file:164kB ina\r\nctive_file:0kB unevictable:156kB isolated(anon):0kB isolated(file):0kB present:3129320kB managed:3048932kB mlocked:156kB dirty:0kB writeback:0kB mapped:470\r\n4kB shmem:22180kB slab_reclaimable:23824kB slab_unreclaimable:11292kB kernel_stack:1600kB pagetables:6760kB unstable:0kB bounce:0kB free_pcp:1032kB local_p\r\ncp:120kB free_cma:0kB writeback_tmp:0kB pages_scanned:4856 all_unreclaimable? yes\r\n[Fri Mar  2 11:34:55 2018] lowmem_reserve[]: 0 0 4638 4638 4638\r\n[Fri Mar  2 11:34:55 2018] Node 0 Normal free:40920kB min:41160kB low:51448kB high:61740kB active_anon:4577020kB inactive_anon:18388kB active_file:72kB ina\r\nctive_file:64kB unevictable:3492kB isolated(anon):0kB isolated(file):0kB present:4878336kB managed:4750040kB mlocked:3496kB dirty:0kB writeback:0kB mapped:\r\n3224kB shmem:19388kB slab_reclaimable:42628kB slab_unreclaimable:14276kB kernel_stack:2368kB pagetables:13188kB unstable:0kB bounce:0kB free_pcp:868kB loca\r\nl_pcp:120kB free_cma:0kB writeback_tmp:0kB pages_sc\r\nanned:5024 all_unreclaimable? yes\r\n[Fri Mar  2 11:34:55 2018] lowmem_reserve[]: 0 0 0 0 0\r\n[Fri Mar  2 11:34:55 2018] Node 0 DMA: 1*4kB (U) 0*8kB 0*16kB 1*32kB (U) 2*64kB (U) 1*128kB (U) 1*256kB (U) 0*512kB 1*1024kB (U) 1*2048kB (M) 3*4096kB (M) = 15908kB\r\n[Fri Mar  2 11:34:55 2018] Node 0 DMA32: 497*4kB (UE) 337*8kB (UME) 346*16kB (UME) 299*32kB (UME) 153*64kB (UME) 71*128kB (ME) 24*256kB (ME) 0*512kB 0*1024kB 0*2048kB 0*4096kB = 44812kB\r\n[Fri Mar  2 11:34:55 2018] Node 0 Normal: 582*4kB (UE) 259*8kB (UE) 263*16kB (UME) 234*32kB (UE) 148*64kB (UE) 76*128kB (ME) 21*256kB (E) 0*512kB 0*1024kB 0*2048kB 0*4096kB = 40672kB\r\n[Fri Mar  2 11:34:55 2018] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=1048576kB\r\n[Fri Mar  2 11:34:55 2018] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=2048kB\r\n[Fri Mar  2 11:34:55 2018] 11117 total pagecache pages\r\n[Fri Mar  2 11:34:55 2018] 0 pages in swap cache\r\n[Fri Mar  2 11:34:55 2018] Swap cache stats: add 0, delete 0, find 0/0\r\n[Fri Mar  2 11:34:55 2018] Free swap  = 0kB\r\n[Fri Mar  2 11:34:55 2018] Total swap = 0kB\r\n[Fri Mar  2 11:34:55 2018] 2005912 pages RAM\r\n[Fri Mar  2 11:34:55 2018] 0 pages HighMem/MovableOnly\r\n[Fri Mar  2 11:34:55 2018] 52192 pages reserved\r\n[Fri Mar  2 11:34:55 2018] 0 pages cma reserved\r\n[Fri Mar  2 11:34:55 2018] 0 pages hwpoisoned\r\n[Fri Mar  2 11:34:55 2018] [ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name\r\n[Fri Mar  2 11:34:55 2018] [  442]     0   442     8818     1778      21       3        0             0 systemd-journal\r\n[Fri Mar  2 11:34:55 2018] [  512]     0   512    23693      184      16       3        0             0 lvmetad\r\n[Fri Mar  2 11:34:55 2018] [  558]     0   558    10728      710      22       3        0         -1000 systemd-udevd\r\n[Fri Mar  2 11:34:55 2018] [  941]   100   941    25081      462      19       4        0             0 systemd-timesyn\r\n[Fri Mar  2 11:34:55 2018] [ 1060]     0  1060     4030      518      11       3        0             0 dhclient\r\n[Fri Mar  2 11:34:55 2018] [ 1253]     0  1253     1305       29       8       4        0             0 iscsid\r\n[Fri Mar  2 11:34:55 2018] [ 1254]     0  1254     1430      877       9       4        0           -17 iscsid\r\n[Fri Mar  2 11:34:55 2018] [ 1258]   107  1258    10733      535      26       3        0          -900 dbus-daemon\r\n[Fri Mar  2 11:34:55 2018] [ 1262]     0  1262     7136      494      19       3        0             0 systemd-logind\r\n[Fri Mar  2 11:34:55 2018] [ 1266]     0  1266   204840    11082     122       6        0          -500 dockerd\r\n[Fri Mar  2 11:34:55 2018] [ 1270]     0  1270     1099      302       8       3        0             0 acpid\r\n[Fri Mar  2 11:34:55 2018] [ 1274]     0  1274    16377      605      35       3        0         -1000 sshd\r\n[Fri Mar  2 11:34:55 2018] [ 1276]     0  1276     6511      420      17       3        0             0 atd\r\n[Fri Mar  2 11:34:55 2018] [ 1278]     0  1278    58693      320      16       4        0             0 lxcfs\r\n[Fri Mar  2 11:34:55 2018] [ 1280]   104  1280    65157      557      29       3        0             0 rsyslogd\r\n[Fri Mar  2 11:34:55 2018] [ 1282]     0  1282    76704     3147      37       5        0          -900 snapd\r\n[Fri Mar  2 11:34:55 2018] [ 1284]     0  1284    68654      458      36       3        0             0 accounts-daemon\r\n[Fri Mar  2 11:34:55 2018] [ 1293]     0  1293     6932      494      18       3        0             0 cron\r\n[Fri Mar  2 11:34:55 2018] [ 1314]     0  1314     3343       35      11       3        0             0 mdadm\r\n[Fri Mar  2 11:34:55 2018] [ 1322]     0  1322    69829      547      40       3        0             0 polkitd\r\n[Fri Mar  2 11:34:55 2018] [ 1387]     0  1387     4868       61      14       3        0             0 irqbalance\r\n[Fri Mar  2 11:34:55 2018] [ 1396]     0  1396     3618      372      12       3        0             0 agetty\r\n[Fri Mar  2 11:34:55 2018] [ 1401]     0  1401     3664      357      12       3        0             0 agetty\r\n[Fri Mar  2 11:34:55 2018] [ 1406]     0  1406   141074     5225      51       5        0          -500 docker-containe\r\n[Fri Mar  2 11:34:55 2018] [ 2311]  1014  2311  1363854   502280    1073       9        0             0 java\r\n[Fri Mar  2 11:34:55 2018] [15719]     0 15719     1880      425       8       5        0          -999 docker-containe\r\n[Fri Mar  2 11:34:55 2018] [15735]     0 15735     1133       15       8       3        0             0 cat\r\n[Fri Mar  2 11:34:55 2018] [11190]  1014 11190     4934      464      13       3        0             0 bash\r\n[Fri Mar  2 11:34:55 2018] [11524]     0 11524     1880      172       8       5        0          -999 docker-containe\r\n[Fri Mar  2 11:34:55 2018] [11541]     0 11541     1133       16       8       3        0             0 cat\r\n[Fri Mar  2 11:34:55 2018] [11597]  1014 11597    72203      832      33       5        0             0 docker\r\n[Fri Mar  2 11:34:55 2018] [11614]  1014 11614     4511       54      14       3        0             0 bash\r\n[Fri Mar  2 11:34:55 2018] [11625]  1014 11625     4520       74      14       3        0             0 test.sh\r\n[Fri Mar  2 11:34:55 2018] [11797]  1014 11797 5368730484     2887      36       7        0             0 bash\r\n[Fri Mar  2 11:34:55 2018] [12380]  1014 12380 5369079647  1344600    3139     249        0             0 python\r\n[Fri Mar  2 11:34:55 2018] Out of memory: Kill process 12380 (python) score 689 or sacrifice child\r\n[Fri Mar  2 11:34:55 2018] Killed process 12380 (python) total-vm:21476318588kB, anon-rss:5378400kB, file-rss:0kB\r\n```\r\n\r\nIt is not that surprising that ASAN fails but the regular build does not, because ASAN uses more memory; however, I ran some quick tests with vanilla `test_nn.py` and noted that it also continually uses more memory as you run it.\r\n\r\nI'm going to submit a workaround for the ASAN case, and also post some extra evidence about the memory usage shortly."}