{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/181519011", "pull_request_review_id": 112170491, "id": 181519011, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MTUxOTAxMQ==", "diff_hunk": "@@ -23,16 +23,19 @@ bool hasUsedHandle(Node *node) {\n \n } // anonymous namespace\n \n-// Transform PythonOps and Cpp Ops into Node's that match ONNX semantics.\n-// Argument aten indicates whether we should export ops as \"ATen\" ONNX ops if possible.\n void ToONNX(std::shared_ptr<tracer::TracingState>& state, bool aten) {\n   // Check that the tracing state is live (it should be, because\n   // you were supposed to request zero derivatives.)\n   if (state->is_expired()) {\n     throw std::logic_error(\"ToONNX: tracing state is expired\");\n   }\n+  state->graph = ToONNXFromGraph(state->graph, aten);\n+}\n \n-  auto new_graph = std::make_shared<Graph>(state->graph->scope_root());\n+// Transform PythonOps and Cpp Ops into Node's that match ONNX semantics.\n+// Argument aten indicates whether we should export ops as \"ATen\" ONNX ops if possible.\n+std::shared_ptr<Graph> ToONNXFromGraph(std::shared_ptr<Graph>& graph, bool aten) {", "path": "torch/csrc/jit/passes/onnx.cpp", "position": null, "original_position": 18, "commit_id": "53856b077ab61aa429f92b21ddcf7a55390cab6d", "original_commit_id": "8c24418491ea2affbec2cd1172e585102f79da78", "user": {"login": "zdevito", "id": 370202, "node_id": "MDQ6VXNlcjM3MDIwMg==", "avatar_url": "https://avatars0.githubusercontent.com/u/370202?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zdevito", "html_url": "https://github.com/zdevito", "followers_url": "https://api.github.com/users/zdevito/followers", "following_url": "https://api.github.com/users/zdevito/following{/other_user}", "gists_url": "https://api.github.com/users/zdevito/gists{/gist_id}", "starred_url": "https://api.github.com/users/zdevito/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zdevito/subscriptions", "organizations_url": "https://api.github.com/users/zdevito/orgs", "repos_url": "https://api.github.com/users/zdevito/repos", "events_url": "https://api.github.com/users/zdevito/events{/privacy}", "received_events_url": "https://api.github.com/users/zdevito/received_events", "type": "User", "site_admin": false}, "body": "I still think it makes sense to only copy it only if requested. For instance, you might first want to apply some optimizations that you know are useful to run before going to onnx. Then you would do\r\n\r\n```\r\ngraph  = copy(orig)\r\n// these optimizations are only a good idea if we are exporting, so we first copied the graph\r\nmy_before_onnx_pre_opt(graph)\r\nto_onnx(graph)\r\n```\r\nIf this pass copies the graph, you would have to make two copies.\r\n\r\n", "created_at": "2018-04-13T21:57:35Z", "updated_at": "2018-11-23T15:42:26Z", "html_url": "https://github.com/pytorch/pytorch/pull/6598#discussion_r181519011", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/6598", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/181519011"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/6598#discussion_r181519011"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/6598"}}, "body_html": "<p>I still think it makes sense to only copy it only if requested. For instance, you might first want to apply some optimizations that you know are useful to run before going to onnx. Then you would do</p>\n<pre><code>graph  = copy(orig)\n// these optimizations are only a good idea if we are exporting, so we first copied the graph\nmy_before_onnx_pre_opt(graph)\nto_onnx(graph)\n</code></pre>\n<p>If this pass copies the graph, you would have to make two copies.</p>", "body_text": "I still think it makes sense to only copy it only if requested. For instance, you might first want to apply some optimizations that you know are useful to run before going to onnx. Then you would do\ngraph  = copy(orig)\n// these optimizations are only a good idea if we are exporting, so we first copied the graph\nmy_before_onnx_pre_opt(graph)\nto_onnx(graph)\n\nIf this pass copies the graph, you would have to make two copies.", "in_reply_to_id": 181516768}