{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/232791688", "pull_request_review_id": 174068444, "id": 232791688, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMjc5MTY4OA==", "diff_hunk": "@@ -1266,23 +1267,11 @@ bool ImageInputOp<Context>::CopyPrefetched() {\n       // data comes in as NHWC\n       const int N = X.dim32(0), C = X.dim32(3), H = X.dim32(1), W = X.dim32(2);\n       // data goes out as NCHW\n-      auto dims = std::vector<int64_t>{N, C, H, W};\n-      // GPU transform kernel allows explicitly setting output type\n-      if (output_type_ == TensorProto_DataType_FLOAT) {\n-        auto* image_output = OperatorBase::OutputTensor(\n-            0, dims, at::dtype<float>().device(type));\n-        TransformOnGPU<uint8_t,float,Context>(prefetched_image_on_device_,\n-                                              image_output, mean_gpu_,\n-                                              std_gpu_, &context_);\n-      } else if (output_type_ == TensorProto_DataType_FLOAT16) {\n-        auto* image_output = OperatorBase::OutputTensor(\n-            0, dims, at::dtype<at::Half>().device(type));\n-        TransformOnGPU<uint8_t,at::Half,Context>(prefetched_image_on_device_,\n-                                                image_output, mean_gpu_,\n-                                                std_gpu_, &context_);\n-      }  else {\n-        return false;\n+      auto dims = std::vector<int64_t>{ N, C, H, W };\n+      if (!ApplyTransformOnGPU(dims, type)) {", "path": "caffe2/image/image_input_op.h", "position": 38, "original_position": 29, "commit_id": "147c7f735d90054283afe1f78126a85fa03336bd", "original_commit_id": "6360cd9384b1884f9b166692b449294272da83f5", "user": {"login": "ArutyunovG", "id": 10763026, "node_id": "MDQ6VXNlcjEwNzYzMDI2", "avatar_url": "https://avatars0.githubusercontent.com/u/10763026?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ArutyunovG", "html_url": "https://github.com/ArutyunovG", "followers_url": "https://api.github.com/users/ArutyunovG/followers", "following_url": "https://api.github.com/users/ArutyunovG/following{/other_user}", "gists_url": "https://api.github.com/users/ArutyunovG/gists{/gist_id}", "starred_url": "https://api.github.com/users/ArutyunovG/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ArutyunovG/subscriptions", "organizations_url": "https://api.github.com/users/ArutyunovG/orgs", "repos_url": "https://api.github.com/users/ArutyunovG/repos", "events_url": "https://api.github.com/users/ArutyunovG/events{/privacy}", "received_events_url": "https://api.github.com/users/ArutyunovG/received_events", "type": "User", "site_admin": false}, "body": "This leads to link error in Debug (added log).\r\nExplanation is the following. \r\nThe idea of the author is that compiler will figure out, that if statement's argument is a constexprt, therefore at compilation time only one part of if statement will remain. Basically, there will be no real if after compilation. But MSVC in Debug compiles code as close to the original as possible, without any optimizations (/Od flag). As a result, this header is compiled in caffe2/image/image_input_op.cc \"as is\" and, as result, we get an error linking against TransformOnGPU<CPUContext>  \r\n\r\n>        \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\INSTALL.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (1) ->\r\n>        \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\ALL_BUILD.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (3) ->\r\n>        \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (14) ->\r\n>        (\u0426\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 Link) ->\r\n>          image_input_op.obj : error LNK2019: unresolved external symbol \"bool __cdecl caffe2::TransformOnGPU<unsigned char,float,class caffe2::CPUContext>(class caffe2::Tensor &,class caffe\r\n>        2::Tensor *,class caffe2::Tensor &,class caffe2::Tensor &,class caffe2::CPUContext *)\" (??$TransformOnGPU@EMVCPUContext@caffe2@@@caffe2@@YA_NAEAVTensor@0@PEAV10@00PEAVCPUContext@0@@Z\r\n>        ) referenced in function \"public: virtual bool __cdecl caffe2::ImageInputOp<class caffe2::CPUContext>::CopyPrefetched(void)\" (?CopyPrefetched@?$ImageInputOp@VCPUContext@caffe2@@@caff\r\n>        e2@@UEAA_NXZ) [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj]\r\n>          image_input_op.obj : error LNK2019: unresolved external symbol \"bool __cdecl caffe2::TransformOnGPU<unsigned char,struct c10::Half,class caffe2::CPUContext>(class caffe2::Tensor &,\r\n>        class caffe2::Tensor *,class caffe2::Tensor &,class caffe2::Tensor &,class caffe2::CPUContext *)\" (??$TransformOnGPU@EUHalf@c10@@VCPUContext@caffe2@@@caffe2@@YA_NAEAVTensor@0@PEAV10@\r\n>        00PEAVCPUContext@0@@Z) referenced in function \"public: virtual bool __cdecl caffe2::ImageInputOp<class caffe2::CPUContext>::CopyPrefetched(void)\" (?CopyPrefetched@?$ImageInputOp@VCPU\r\n>        Context@caffe2@@@caffe2@@UEAA_NXZ) [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj]\r\n>          D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\bin\\Debug\\caffe2.dll : fatal error LNK1120: 2 unresolved externals [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\buil\r\n>        d\\Debug\\caffe2\\caffe2.vcxproj]", "created_at": "2018-11-12T19:55:05Z", "updated_at": "2018-11-23T15:54:40Z", "html_url": "https://github.com/pytorch/pytorch/pull/13550#discussion_r232791688", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/13550", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/232791688"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/13550#discussion_r232791688"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/13550"}}, "body_html": "<p>This leads to link error in Debug (added log).<br>\nExplanation is the following.<br>\nThe idea of the author is that compiler will figure out, that if statement's argument is a constexprt, therefore at compilation time only one part of if statement will remain. Basically, there will be no real if after compilation. But MSVC in Debug compiles code as close to the original as possible, without any optimizations (/Od flag). As a result, this header is compiled in caffe2/image/image_input_op.cc \"as is\" and, as result, we get an error linking against TransformOnGPU</p>\n<blockquote>\n<pre><code>   \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\INSTALL.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (1) -&gt;\n   \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\ALL_BUILD.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (3) -&gt;\n   \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (14) -&gt;\n   (\u0426\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 Link) -&gt;\n     image_input_op.obj : error LNK2019: unresolved external symbol \"bool __cdecl caffe2::TransformOnGPU&lt;unsigned char,float,class caffe2::CPUContext&gt;(class caffe2::Tensor &amp;,class caffe\n   2::Tensor *,class caffe2::Tensor &amp;,class caffe2::Tensor &amp;,class caffe2::CPUContext *)\" (??$TransformOnGPU@EMVCPUContext@caffe2@@@caffe2@@YA_NAEAVTensor@0@PEAV10@00PEAVCPUContext@0@@Z\n   ) referenced in function \"public: virtual bool __cdecl caffe2::ImageInputOp&lt;class caffe2::CPUContext&gt;::CopyPrefetched(void)\" (?CopyPrefetched@?$ImageInputOp@VCPUContext@caffe2@@@caff\n   e2@@UEAA_NXZ) [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj]\n     image_input_op.obj : error LNK2019: unresolved external symbol \"bool __cdecl caffe2::TransformOnGPU&lt;unsigned char,struct c10::Half,class caffe2::CPUContext&gt;(class caffe2::Tensor &amp;,\n   class caffe2::Tensor *,class caffe2::Tensor &amp;,class caffe2::Tensor &amp;,class caffe2::CPUContext *)\" (??$TransformOnGPU@EUHalf@c10@@VCPUContext@caffe2@@@caffe2@@YA_NAEAVTensor@0@PEAV10@\n   00PEAVCPUContext@0@@Z) referenced in function \"public: virtual bool __cdecl caffe2::ImageInputOp&lt;class caffe2::CPUContext&gt;::CopyPrefetched(void)\" (?CopyPrefetched@?$ImageInputOp@VCPU\n   Context@caffe2@@@caffe2@@UEAA_NXZ) [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj]\n     D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\bin\\Debug\\caffe2.dll : fatal error LNK1120: 2 unresolved externals [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\buil\n   d\\Debug\\caffe2\\caffe2.vcxproj]\n</code></pre>\n</blockquote>", "body_text": "This leads to link error in Debug (added log).\nExplanation is the following.\nThe idea of the author is that compiler will figure out, that if statement's argument is a constexprt, therefore at compilation time only one part of if statement will remain. Basically, there will be no real if after compilation. But MSVC in Debug compiles code as close to the original as possible, without any optimizations (/Od flag). As a result, this header is compiled in caffe2/image/image_input_op.cc \"as is\" and, as result, we get an error linking against TransformOnGPU\n\n   \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\INSTALL.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (1) ->\n   \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\ALL_BUILD.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (3) ->\n   \"D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj\" (\u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e) (14) ->\n   (\u0426\u0435\u043b\u0435\u0432\u043e\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 Link) ->\n     image_input_op.obj : error LNK2019: unresolved external symbol \"bool __cdecl caffe2::TransformOnGPU<unsigned char,float,class caffe2::CPUContext>(class caffe2::Tensor &,class caffe\n   2::Tensor *,class caffe2::Tensor &,class caffe2::Tensor &,class caffe2::CPUContext *)\" (??$TransformOnGPU@EMVCPUContext@caffe2@@@caffe2@@YA_NAEAVTensor@0@PEAV10@00PEAVCPUContext@0@@Z\n   ) referenced in function \"public: virtual bool __cdecl caffe2::ImageInputOp<class caffe2::CPUContext>::CopyPrefetched(void)\" (?CopyPrefetched@?$ImageInputOp@VCPUContext@caffe2@@@caff\n   e2@@UEAA_NXZ) [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj]\n     image_input_op.obj : error LNK2019: unresolved external symbol \"bool __cdecl caffe2::TransformOnGPU<unsigned char,struct c10::Half,class caffe2::CPUContext>(class caffe2::Tensor &,\n   class caffe2::Tensor *,class caffe2::Tensor &,class caffe2::Tensor &,class caffe2::CPUContext *)\" (??$TransformOnGPU@EUHalf@c10@@VCPUContext@caffe2@@@caffe2@@YA_NAEAVTensor@0@PEAV10@\n   00PEAVCPUContext@0@@Z) referenced in function \"public: virtual bool __cdecl caffe2::ImageInputOp<class caffe2::CPUContext>::CopyPrefetched(void)\" (?CopyPrefetched@?$ImageInputOp@VCPU\n   Context@caffe2@@@caffe2@@UEAA_NXZ) [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\caffe2\\caffe2.vcxproj]\n     D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\build\\Debug\\bin\\Debug\\caffe2.dll : fatal error LNK1120: 2 unresolved externals [D:\\pytorch-scripts\\caffe2_builders\\v140\\pytorch\\buil\n   d\\Debug\\caffe2\\caffe2.vcxproj]", "in_reply_to_id": 232737861}