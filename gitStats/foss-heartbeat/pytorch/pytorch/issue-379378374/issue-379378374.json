{"url": "https://api.github.com/repos/pytorch/pytorch/issues/13801", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/13801/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/13801/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/13801/events", "html_url": "https://github.com/pytorch/pytorch/pull/13801", "id": 379378374, "node_id": "MDExOlB1bGxSZXF1ZXN0MjI5ODYyNTcy", "number": 13801, "title": "Apply weight-decay before momentum in the SGD optimizer.", "user": {"login": "LaurentMazare", "id": 1041292, "node_id": "MDQ6VXNlcjEwNDEyOTI=", "avatar_url": "https://avatars0.githubusercontent.com/u/1041292?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LaurentMazare", "html_url": "https://github.com/LaurentMazare", "followers_url": "https://api.github.com/users/LaurentMazare/followers", "following_url": "https://api.github.com/users/LaurentMazare/following{/other_user}", "gists_url": "https://api.github.com/users/LaurentMazare/gists{/gist_id}", "starred_url": "https://api.github.com/users/LaurentMazare/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LaurentMazare/subscriptions", "organizations_url": "https://api.github.com/users/LaurentMazare/orgs", "repos_url": "https://api.github.com/users/LaurentMazare/repos", "events_url": "https://api.github.com/users/LaurentMazare/events{/privacy}", "received_events_url": "https://api.github.com/users/LaurentMazare/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-11-10T01:57:34Z", "updated_at": "2018-11-12T07:56:14Z", "closed_at": "2018-11-12T07:56:14Z", "author_association": "CONTRIBUTOR", "pull_request": {"url": "https://api.github.com/repos/pytorch/pytorch/pulls/13801", "html_url": "https://github.com/pytorch/pytorch/pull/13801", "diff_url": "https://github.com/pytorch/pytorch/pull/13801.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/13801.patch"}, "body_html": "<p>While trying to understand why two implementations of the same model, one in Python, one using the C++ api (via some <a href=\"https://github.com/LaurentMazare/ocaml-torch\">ocaml wrappers</a>) did not perform equally well, I noticed that the Python and C++ implementation of SGD slightly differ on weight decay.</p>\n<ul>\n<li>In the <a href=\"https://github.com/pytorch/pytorch/blob/master/torch/optim/sgd.py#L91-L93\">Python version</a> weight decay is applied <em>before</em> momentum (and so momentum applies to the weight decay).</li>\n<li>In the C++ implementation the weight decay is applied <em>after</em> momentum.</li>\n</ul>\n<p>In the couple computer-vision models I have looked at the Python version performs a little better so this PR tweaks the C++ implementation to perform weight-decay <em>before</em> momentum. This is possibly caused by having more regularization - maybe increasing the weight decay while keeping the current code would hold the same improvements however a nice advantage of this change is to put the C++ and Python version in line. After this change my Python and C++/ocaml models performed similarly when using the same weight-decay parameter.</p>\n<p>Maybe there was some real reason to have weight decay after momentum in the C++ version but I haven't found any.</p>", "body_text": "While trying to understand why two implementations of the same model, one in Python, one using the C++ api (via some ocaml wrappers) did not perform equally well, I noticed that the Python and C++ implementation of SGD slightly differ on weight decay.\n\nIn the Python version weight decay is applied before momentum (and so momentum applies to the weight decay).\nIn the C++ implementation the weight decay is applied after momentum.\n\nIn the couple computer-vision models I have looked at the Python version performs a little better so this PR tweaks the C++ implementation to perform weight-decay before momentum. This is possibly caused by having more regularization - maybe increasing the weight decay while keeping the current code would hold the same improvements however a nice advantage of this change is to put the C++ and Python version in line. After this change my Python and C++/ocaml models performed similarly when using the same weight-decay parameter.\nMaybe there was some real reason to have weight decay after momentum in the C++ version but I haven't found any.", "body": "While trying to understand why two implementations of the same model, one in Python, one using the C++ api (via some [ocaml wrappers](https://github.com/LaurentMazare/ocaml-torch)) did not perform equally well, I noticed that the Python and C++ implementation of SGD slightly differ on weight decay.\r\n\r\n- In the [Python version](https://github.com/pytorch/pytorch/blob/master/torch/optim/sgd.py#L91-L93) weight decay is applied *before* momentum (and so momentum applies to the weight decay).\r\n- In the C++ implementation the weight decay is applied *after* momentum.\r\n\r\nIn the couple computer-vision models I have looked at the Python version performs a little better so this PR tweaks the C++ implementation to perform weight-decay *before* momentum. This is possibly caused by having more regularization - maybe increasing the weight decay while keeping the current code would hold the same improvements however a nice advantage of this change is to put the C++ and Python version in line. After this change my Python and C++/ocaml models performed similarly when using the same weight-decay parameter. \r\n\r\nMaybe there was some real reason to have weight decay after momentum in the C++ version but I haven't found any."}