{"url": "https://api.github.com/repos/pytorch/pytorch/issues/11869", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/11869/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/11869/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/11869/events", "html_url": "https://github.com/pytorch/pytorch/issues/11869", "id": 361865372, "node_id": "MDU6SXNzdWUzNjE4NjUzNzI=", "number": 11869, "title": "[caffe2] Unaligned AVX instruction operands in LayerNorm implementation in OSS build", "user": {"login": "jamesr66a", "id": 4685384, "node_id": "MDQ6VXNlcjQ2ODUzODQ=", "avatar_url": "https://avatars2.githubusercontent.com/u/4685384?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamesr66a", "html_url": "https://github.com/jamesr66a", "followers_url": "https://api.github.com/users/jamesr66a/followers", "following_url": "https://api.github.com/users/jamesr66a/following{/other_user}", "gists_url": "https://api.github.com/users/jamesr66a/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamesr66a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamesr66a/subscriptions", "organizations_url": "https://api.github.com/users/jamesr66a/orgs", "repos_url": "https://api.github.com/users/jamesr66a/repos", "events_url": "https://api.github.com/users/jamesr66a/events{/privacy}", "received_events_url": "https://api.github.com/users/jamesr66a/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-09-19T18:09:49Z", "updated_at": "2018-09-19T18:11:29Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<p>On my open source build the following program hits a segmentation fault:</p>\n<pre><code>from caffe2.python import core, workspace\n\ntest_net = core.Net(\"layer_norm_test\")\ntest_net.LayerNorm([\"input\"], [\"output\", \"mean\", \"stddev\"], epsilon=1e-5)\n\nimport numpy as np\nworkspace.FeedBlob('input', np.random.rand(20, 5, 10, 10).astype('f'))\nworkspace.CreateNet(test_net)\nworkspace.RunNet(test_net.Name())\n</code></pre>\n<p>Looking at the stack trace it looks like Eigen is attempting to do a 256-bit wide vector add between two stack-allocated operands, which are only aligned to 16 bytes:</p>\n<pre><code>#0  0x00007fffdf694ddb in Eigen::internal::padd&lt;float __vector&gt;(float __vector const&amp;, float __vector const&amp;) (a=..., b=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/arch/AVX/PacketMath.h:130\n#1  0x00007fffdf6988ae in Eigen::internal::scalar_sum_op&lt;float, float&gt;::packetOp&lt;float __vector&gt;(float __vector const&amp;, float __vector const&amp;) const (this=0x7fffffffbacf, a=..., b=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/functors/BinaryFunctors.h:45\n#2  0x00007fffe0cbbaf4 in Eigen::internal::redux_impl&lt;Eigen::internal::scalar_sum_op&lt;float, float&gt;, Eigen::internal::redux_evaluator&lt;Eigen::Block&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt; const, 1, -1, true&gt; &gt;, 3, 0&gt;::run (mat=..., func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:240\n#3  0x00007fffe0cbb6dd in Eigen::DenseBase&lt;Eigen::Block&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt; const, 1, -1, true&gt; &gt;::redux&lt;Eigen::internal::scalar_sum_op&lt;float, float&gt; &gt; (this=0x7fffffffbb80, func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:418\n#4  0x00007fffe0cbb38f in Eigen::DenseBase&lt;Eigen::Block&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt; const, 1, -1, true&gt; &gt;::mean (\n    this=0x7fffffffbb80) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:468\n#5  0x00007fffe0cbb180 in Eigen::internal::member_mean&lt;float&gt;::operator()&lt;Eigen::Block&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt; const, 1, -1, true&gt; &gt; (this=0x7fffffffbcf0, mat=...) at ../cmake/../third_party/eigen/Eigen/src/Core/VectorwiseOp.h:105\n#6  0x00007fffe0cbaff3 in Eigen::internal::evaluator&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt;::coeff (this=0x7fffffffbcd0, i=0, j=0) at ../cmake/../third_party/eigen/Eigen/src/Core/CoreEvaluators.h:1353\n#7  0x00007fffe0cbae29 in Eigen::internal::generic_dense_assignment_kernel&lt;Eigen::internal::evaluator&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt; &gt;, Eigen::internal::evaluator&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt;, Eigen::internal::assign_op&lt;float, float&gt;, 0&gt;::assignCoeff (this=0x7fffffffbcb0, row=0, col=0) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:631\n#8  0x00007fffe0cbacab in Eigen::internal::generic_dense_assignment_kernel&lt;Eigen::internal::evaluator&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt; &gt;, Eigen::internal::evaluator&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt;, Eigen::internal::assign_op&lt;float, float&gt;, 0&gt;::assignCoeffByOuterInner (this=0x7fffffffbcb0, outer=0, inner=0) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:645\n#9  0x00007fffe0cba974 in Eigen::internal::dense_assignment_loop&lt;Eigen::internal::generic_dense_assignment_kernel&lt;Eigen::internal::evaluator&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt; &gt;, Eigen::internal::evaluator&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt;, Eigen::internal::assign_op&lt;float, float&gt;, 0&gt;, 0, 0&gt;::run (kernel=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:326\n#10 0x00007fffe0cba352 in Eigen::internal::call_dense_assignment_loop&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt;, Eigen::internal::assign_op&lt;float, float&gt; &gt; (dst=..., src=..., func=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:741\n#11 0x00007fffe0cba1c8 in Eigen::internal::Assignment&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt;, Eigen::internal::assign_op&lt;float, float&gt;, Eigen::internal::Dense2Dense, void&gt;::run (dst=...,\n    src=..., func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:879\n#12 0x00007fffe0cb9ea9 in Eigen::internal::call_assignment_no_alias&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt;, Eigen::internal::assign_op&lt;float, float&gt; &gt; (dst=..., src=..., func=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:836\n#13 0x00007fffe0cb99ad in Eigen::internal::call_assignment&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt;, Eigen::internal::assign_op&lt;float, float&gt; &gt;(Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt;&amp;, Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; const&amp;, Eigen::internal::assign_op&lt;float, float&gt; const&amp;, Eigen::internal::enable_if&lt;!Eigen::internal::evaluator_assume_aliasing&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt;, Eigen::internal::evaluator_traits&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt;::Shape&gt;::value, void*&gt;::type) (dst=..., src=..., func=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:804\n#14 0x00007fffe0cb8cd5 in Eigen::internal::call_assignment&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt; (dst=..., src=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:782\n#15 0x00007fffe0cb8521 in Eigen::MatrixBase&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt;, 0, Eigen::Stride&lt;0, 0&gt; &gt; &gt;::operator=&lt;Eigen::PartialReduxExpr&lt;Eigen::Map&lt;Eigen::Matrix&lt;float, -1, -1, 1, -1, -1&gt; const, 0, Eigen::Stride&lt;0, 0&gt; &gt;, Eigen::internal::member_mean&lt;float&gt;, 1&gt; &gt; (this=0x7fffffffbea0, other=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/Assign.h:66\n#16 0x00007fffe0cabaf5 in caffe2::LayerNormOp&lt;caffe2::CPUContext&gt;::DoRunWithType&lt;float&gt; (this=0x5555562c23f0) at ../caffe2/operators/layer_norm_op.cc:52\n#17 0x00007fffe0cbd8bc in caffe2::LayerNormOp&lt;caffe2::CPUContext&gt;::RunOnDevice (this=0x5555562c23f0) at ../caffe2/operators/layer_norm_op.h:24\n</code></pre>\n<p>Current frame:</p>\n<pre><code>(gdb) f\n#0  0x00007fffdf694ddb in Eigen::internal::padd&lt;float __vector&gt;(float __vector const&amp;, float __vector const&amp;) (a=..., b=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/arch/AVX/PacketMath.h:130\n130\ttemplate&lt;&gt; EIGEN_STRONG_INLINE Packet8f padd&lt;Packet8f&gt;(const Packet8f&amp; a, const Packet8f&amp; b) { return _mm256_add_ps(a,b); }\n</code></pre>\n<p>Debug info:</p>\n<pre><code>(gdb) p &amp;a\n$1 = (const Eigen::internal::Packet8f *) 0x7fffffffb970\n(gdb) p &amp;b\n$2 = (const Eigen::internal::Packet8f *) 0x7fffffffb9b0\n</code></pre>\n<p>I've tried building with <code>-DEIGEN_FORCE_ALIGN_32</code> but it doesn't seem to make a difference.</p>", "body_text": "On my open source build the following program hits a segmentation fault:\nfrom caffe2.python import core, workspace\n\ntest_net = core.Net(\"layer_norm_test\")\ntest_net.LayerNorm([\"input\"], [\"output\", \"mean\", \"stddev\"], epsilon=1e-5)\n\nimport numpy as np\nworkspace.FeedBlob('input', np.random.rand(20, 5, 10, 10).astype('f'))\nworkspace.CreateNet(test_net)\nworkspace.RunNet(test_net.Name())\n\nLooking at the stack trace it looks like Eigen is attempting to do a 256-bit wide vector add between two stack-allocated operands, which are only aligned to 16 bytes:\n#0  0x00007fffdf694ddb in Eigen::internal::padd<float __vector>(float __vector const&, float __vector const&) (a=..., b=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/arch/AVX/PacketMath.h:130\n#1  0x00007fffdf6988ae in Eigen::internal::scalar_sum_op<float, float>::packetOp<float __vector>(float __vector const&, float __vector const&) const (this=0x7fffffffbacf, a=..., b=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/functors/BinaryFunctors.h:45\n#2  0x00007fffe0cbbaf4 in Eigen::internal::redux_impl<Eigen::internal::scalar_sum_op<float, float>, Eigen::internal::redux_evaluator<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> >, 3, 0>::run (mat=..., func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:240\n#3  0x00007fffe0cbb6dd in Eigen::DenseBase<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> >::redux<Eigen::internal::scalar_sum_op<float, float> > (this=0x7fffffffbb80, func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:418\n#4  0x00007fffe0cbb38f in Eigen::DenseBase<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> >::mean (\n    this=0x7fffffffbb80) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:468\n#5  0x00007fffe0cbb180 in Eigen::internal::member_mean<float>::operator()<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> > (this=0x7fffffffbcf0, mat=...) at ../cmake/../third_party/eigen/Eigen/src/Core/VectorwiseOp.h:105\n#6  0x00007fffe0cbaff3 in Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >::coeff (this=0x7fffffffbcd0, i=0, j=0) at ../cmake/../third_party/eigen/Eigen/src/Core/CoreEvaluators.h:1353\n#7  0x00007fffe0cbae29 in Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >, Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >, Eigen::internal::assign_op<float, float>, 0>::assignCoeff (this=0x7fffffffbcb0, row=0, col=0) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:631\n#8  0x00007fffe0cbacab in Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >, Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >, Eigen::internal::assign_op<float, float>, 0>::assignCoeffByOuterInner (this=0x7fffffffbcb0, outer=0, inner=0) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:645\n#9  0x00007fffe0cba974 in Eigen::internal::dense_assignment_loop<Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >, Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >, Eigen::internal::assign_op<float, float>, 0>, 0, 0>::run (kernel=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:326\n#10 0x00007fffe0cba352 in Eigen::internal::call_dense_assignment_loop<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float> > (dst=..., src=..., func=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:741\n#11 0x00007fffe0cba1c8 in Eigen::internal::Assignment<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float>, Eigen::internal::Dense2Dense, void>::run (dst=...,\n    src=..., func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:879\n#12 0x00007fffe0cb9ea9 in Eigen::internal::call_assignment_no_alias<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float> > (dst=..., src=..., func=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:836\n#13 0x00007fffe0cb99ad in Eigen::internal::call_assignment<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float> >(Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >&, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> const&, Eigen::internal::assign_op<float, float> const&, Eigen::internal::enable_if<!Eigen::internal::evaluator_assume_aliasing<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::evaluator_traits<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >::Shape>::value, void*>::type) (dst=..., src=..., func=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:804\n#14 0x00007fffe0cb8cd5 in Eigen::internal::call_assignment<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> > (dst=..., src=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:782\n#15 0x00007fffe0cb8521 in Eigen::MatrixBase<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >::operator=<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> > (this=0x7fffffffbea0, other=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/Assign.h:66\n#16 0x00007fffe0cabaf5 in caffe2::LayerNormOp<caffe2::CPUContext>::DoRunWithType<float> (this=0x5555562c23f0) at ../caffe2/operators/layer_norm_op.cc:52\n#17 0x00007fffe0cbd8bc in caffe2::LayerNormOp<caffe2::CPUContext>::RunOnDevice (this=0x5555562c23f0) at ../caffe2/operators/layer_norm_op.h:24\n\nCurrent frame:\n(gdb) f\n#0  0x00007fffdf694ddb in Eigen::internal::padd<float __vector>(float __vector const&, float __vector const&) (a=..., b=...)\n    at ../cmake/../third_party/eigen/Eigen/src/Core/arch/AVX/PacketMath.h:130\n130\ttemplate<> EIGEN_STRONG_INLINE Packet8f padd<Packet8f>(const Packet8f& a, const Packet8f& b) { return _mm256_add_ps(a,b); }\n\nDebug info:\n(gdb) p &a\n$1 = (const Eigen::internal::Packet8f *) 0x7fffffffb970\n(gdb) p &b\n$2 = (const Eigen::internal::Packet8f *) 0x7fffffffb9b0\n\nI've tried building with -DEIGEN_FORCE_ALIGN_32 but it doesn't seem to make a difference.", "body": "On my open source build the following program hits a segmentation fault:\r\n\r\n```\r\nfrom caffe2.python import core, workspace\r\n\r\ntest_net = core.Net(\"layer_norm_test\")\r\ntest_net.LayerNorm([\"input\"], [\"output\", \"mean\", \"stddev\"], epsilon=1e-5)\r\n\r\nimport numpy as np\r\nworkspace.FeedBlob('input', np.random.rand(20, 5, 10, 10).astype('f'))\r\nworkspace.CreateNet(test_net)\r\nworkspace.RunNet(test_net.Name())\r\n```\r\n\r\nLooking at the stack trace it looks like Eigen is attempting to do a 256-bit wide vector add between two stack-allocated operands, which are only aligned to 16 bytes:\r\n\r\n```\r\n#0  0x00007fffdf694ddb in Eigen::internal::padd<float __vector>(float __vector const&, float __vector const&) (a=..., b=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/arch/AVX/PacketMath.h:130\r\n#1  0x00007fffdf6988ae in Eigen::internal::scalar_sum_op<float, float>::packetOp<float __vector>(float __vector const&, float __vector const&) const (this=0x7fffffffbacf, a=..., b=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/functors/BinaryFunctors.h:45\r\n#2  0x00007fffe0cbbaf4 in Eigen::internal::redux_impl<Eigen::internal::scalar_sum_op<float, float>, Eigen::internal::redux_evaluator<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> >, 3, 0>::run (mat=..., func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:240\r\n#3  0x00007fffe0cbb6dd in Eigen::DenseBase<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> >::redux<Eigen::internal::scalar_sum_op<float, float> > (this=0x7fffffffbb80, func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:418\r\n#4  0x00007fffe0cbb38f in Eigen::DenseBase<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> >::mean (\r\n    this=0x7fffffffbb80) at ../cmake/../third_party/eigen/Eigen/src/Core/Redux.h:468\r\n#5  0x00007fffe0cbb180 in Eigen::internal::member_mean<float>::operator()<Eigen::Block<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> > const, 1, -1, true> > (this=0x7fffffffbcf0, mat=...) at ../cmake/../third_party/eigen/Eigen/src/Core/VectorwiseOp.h:105\r\n#6  0x00007fffe0cbaff3 in Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >::coeff (this=0x7fffffffbcd0, i=0, j=0) at ../cmake/../third_party/eigen/Eigen/src/Core/CoreEvaluators.h:1353\r\n#7  0x00007fffe0cbae29 in Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >, Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >, Eigen::internal::assign_op<float, float>, 0>::assignCoeff (this=0x7fffffffbcb0, row=0, col=0) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:631\r\n#8  0x00007fffe0cbacab in Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >, Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >, Eigen::internal::assign_op<float, float>, 0>::assignCoeffByOuterInner (this=0x7fffffffbcb0, outer=0, inner=0) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:645\r\n#9  0x00007fffe0cba974 in Eigen::internal::dense_assignment_loop<Eigen::internal::generic_dense_assignment_kernel<Eigen::internal::evaluator<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >, Eigen::internal::evaluator<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >, Eigen::internal::assign_op<float, float>, 0>, 0, 0>::run (kernel=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:326\r\n#10 0x00007fffe0cba352 in Eigen::internal::call_dense_assignment_loop<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float> > (dst=..., src=..., func=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:741\r\n#11 0x00007fffe0cba1c8 in Eigen::internal::Assignment<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float>, Eigen::internal::Dense2Dense, void>::run (dst=...,\r\n    src=..., func=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:879\r\n#12 0x00007fffe0cb9ea9 in Eigen::internal::call_assignment_no_alias<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float> > (dst=..., src=..., func=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:836\r\n#13 0x00007fffe0cb99ad in Eigen::internal::call_assignment<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::assign_op<float, float> >(Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >&, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> const&, Eigen::internal::assign_op<float, float> const&, Eigen::internal::enable_if<!Eigen::internal::evaluator_assume_aliasing<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1>, Eigen::internal::evaluator_traits<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> >::Shape>::value, void*>::type) (dst=..., src=..., func=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:804\r\n#14 0x00007fffe0cb8cd5 in Eigen::internal::call_assignment<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> >, Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> > (dst=..., src=...) at ../cmake/../third_party/eigen/Eigen/src/Core/AssignEvaluator.h:782\r\n#15 0x00007fffe0cb8521 in Eigen::MatrixBase<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1>, 0, Eigen::Stride<0, 0> > >::operator=<Eigen::PartialReduxExpr<Eigen::Map<Eigen::Matrix<float, -1, -1, 1, -1, -1> const, 0, Eigen::Stride<0, 0> >, Eigen::internal::member_mean<float>, 1> > (this=0x7fffffffbea0, other=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/Assign.h:66\r\n#16 0x00007fffe0cabaf5 in caffe2::LayerNormOp<caffe2::CPUContext>::DoRunWithType<float> (this=0x5555562c23f0) at ../caffe2/operators/layer_norm_op.cc:52\r\n#17 0x00007fffe0cbd8bc in caffe2::LayerNormOp<caffe2::CPUContext>::RunOnDevice (this=0x5555562c23f0) at ../caffe2/operators/layer_norm_op.h:24\r\n```\r\nCurrent frame:\r\n\r\n```\r\n(gdb) f\r\n#0  0x00007fffdf694ddb in Eigen::internal::padd<float __vector>(float __vector const&, float __vector const&) (a=..., b=...)\r\n    at ../cmake/../third_party/eigen/Eigen/src/Core/arch/AVX/PacketMath.h:130\r\n130\ttemplate<> EIGEN_STRONG_INLINE Packet8f padd<Packet8f>(const Packet8f& a, const Packet8f& b) { return _mm256_add_ps(a,b); }\r\n```\r\n\r\nDebug info:\r\n```\r\n(gdb) p &a\r\n$1 = (const Eigen::internal::Packet8f *) 0x7fffffffb970\r\n(gdb) p &b\r\n$2 = (const Eigen::internal::Packet8f *) 0x7fffffffb9b0\r\n```\r\n\r\nI've tried building with `-DEIGEN_FORCE_ALIGN_32` but it doesn't seem to make a difference."}