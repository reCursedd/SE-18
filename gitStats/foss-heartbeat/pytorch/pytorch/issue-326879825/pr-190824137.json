{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/7889", "id": 190824137, "node_id": "MDExOlB1bGxSZXF1ZXN0MTkwODI0MTM3", "html_url": "https://github.com/pytorch/pytorch/pull/7889", "diff_url": "https://github.com/pytorch/pytorch/pull/7889.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/7889.patch", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/7889", "number": 7889, "state": "open", "locked": false, "title": "Fix lr_scheduler's last_epoch value at the time of initialization", "user": {"login": "bado-lee", "id": 26222919, "node_id": "MDQ6VXNlcjI2MjIyOTE5", "avatar_url": "https://avatars1.githubusercontent.com/u/26222919?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bado-lee", "html_url": "https://github.com/bado-lee", "followers_url": "https://api.github.com/users/bado-lee/followers", "following_url": "https://api.github.com/users/bado-lee/following{/other_user}", "gists_url": "https://api.github.com/users/bado-lee/gists{/gist_id}", "starred_url": "https://api.github.com/users/bado-lee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bado-lee/subscriptions", "organizations_url": "https://api.github.com/users/bado-lee/orgs", "repos_url": "https://api.github.com/users/bado-lee/repos", "events_url": "https://api.github.com/users/bado-lee/events{/privacy}", "received_events_url": "https://api.github.com/users/bado-lee/received_events", "type": "User", "site_admin": false}, "body": "Hello everyone :) !!\r\n\r\nI've found that lr_scheduler was initialized with last_epoch as -1.\r\nThis causes that even after the first step (not the one in init but explicit step of scheduler),\r\nlearning rate of scheduler's optimizer remains as the previous.\r\n```python\r\n>>> import torch\r\n>>> cc = torch.nn.Conv2d(10,10,3)\r\n>>> myinitial_lr = 0.1\r\n>>> myoptimizer = torch.optim.Adam(cc.parameters(), lr=myinitial_lr)\r\n>>> mylrdecay = 0.5\r\n>>> myscheduler = torch.optim.lr_scheduler.ExponentialLR(myoptimizer,mylrdecay)\r\n\r\n# get_lr value and optimizer's lr value is not consistent, last_epoch should be 0 instead of -1\r\n>>> myscheduler.get_lr()\r\n[0.2]    # this is because of  get_lr calculates lr by 0.1 * 0.5^-1\r\n>>> myscheduler.optimizer.param_groups[0][\"lr\"]\r\n0.1    # this is not consistent with get_lr value\r\n>>> myscheduler.last_epoch\r\n-1\r\n\r\n# values seem to be in sync but should have been decayed value of 0.05 after first step(decay)\r\n>>> myscheduler.step()\r\n>>> myscheduler.get_lr()\r\n[0.1]    # this should be the value right after the init, not after first step\r\n>>> myscheduler.optimizer.param_groups[0][\"lr\"]\r\n0.1    # since this is after first step, it should have been decayed as 0.05\r\n>>> myscheduler.last_epoch\r\n0\r\n\r\n>>> myscheduler.step()\r\n>>> myscheduler.last_epoch\r\n1\r\n>>> myscheduler.get_lr()\r\n[0.05]\r\n>>> myscheduler.optimizer.param_groups[0][\"lr\"]\r\n0.05\r\n>>> myscheduler.last_epoch\r\n1\r\n```\r\n\r\nFirst problem is, even after the init of lr_scheduler, you get the inconsistent parameter values.\r\n\r\nThe second problem is, you are stuck with same learning rate in the first 2 epochs if the step function of lr_scheduler is not called in the beginning of the epoch loop.\r\nOf course, you can avoid this by calling lr_scheduler's step in the beginning,\r\nbut I don't think this is proper use since, incase of optimizer, step is called in the end of the iteration loop.\r\n\r\nI've simply avoided all above issues by setting last_epoch as 0 after the initialization.\r\n\r\nThis also makes sense when you init with some value of last_epoch which is not -1.\r\nFor example, if you want to init with last epoch 10,\r\nlr should not be set with decayed 1 step further. Which is \r\nlast_epoch gets +1 in the previous code.\r\nbase_lr * self.gamma ** self.last_epoch\r\n\r\nInstead, it should be set with step 10 exact value.\r\n\r\nI hope this fix find it's way with all your help :)\r\nI'm really looking forward & excited to become a contributor for pytorch!\r\nPytorch Rocks!!", "created_at": "2018-05-28T02:49:51Z", "updated_at": "2018-07-10T17:03:41Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "7c5bd0daf14ff42e201b6ce9fdf2072371deff57", "assignee": null, "assignees": [], "requested_reviewers": [{"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, {"login": "zdevito", "id": 370202, "node_id": "MDQ6VXNlcjM3MDIwMg==", "avatar_url": "https://avatars0.githubusercontent.com/u/370202?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zdevito", "html_url": "https://github.com/zdevito", "followers_url": "https://api.github.com/users/zdevito/followers", "following_url": "https://api.github.com/users/zdevito/following{/other_user}", "gists_url": "https://api.github.com/users/zdevito/gists{/gist_id}", "starred_url": "https://api.github.com/users/zdevito/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zdevito/subscriptions", "organizations_url": "https://api.github.com/users/zdevito/orgs", "repos_url": "https://api.github.com/users/zdevito/repos", "events_url": "https://api.github.com/users/zdevito/events{/privacy}", "received_events_url": "https://api.github.com/users/zdevito/received_events", "type": "User", "site_admin": false}, {"login": "colesbury", "id": 655866, "node_id": "MDQ6VXNlcjY1NTg2Ng==", "avatar_url": "https://avatars1.githubusercontent.com/u/655866?v=4", "gravatar_id": "", "url": "https://api.github.com/users/colesbury", "html_url": "https://github.com/colesbury", "followers_url": "https://api.github.com/users/colesbury/followers", "following_url": "https://api.github.com/users/colesbury/following{/other_user}", "gists_url": "https://api.github.com/users/colesbury/gists{/gist_id}", "starred_url": "https://api.github.com/users/colesbury/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/colesbury/subscriptions", "organizations_url": "https://api.github.com/users/colesbury/orgs", "repos_url": "https://api.github.com/users/colesbury/repos", "events_url": "https://api.github.com/users/colesbury/events{/privacy}", "received_events_url": "https://api.github.com/users/colesbury/received_events", "type": "User", "site_admin": false}, {"login": "soumith", "id": 1310570, "node_id": "MDQ6VXNlcjEzMTA1NzA=", "avatar_url": "https://avatars0.githubusercontent.com/u/1310570?v=4", "gravatar_id": "", "url": "https://api.github.com/users/soumith", "html_url": "https://github.com/soumith", "followers_url": "https://api.github.com/users/soumith/followers", "following_url": "https://api.github.com/users/soumith/following{/other_user}", "gists_url": "https://api.github.com/users/soumith/gists{/gist_id}", "starred_url": "https://api.github.com/users/soumith/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/soumith/subscriptions", "organizations_url": "https://api.github.com/users/soumith/orgs", "repos_url": "https://api.github.com/users/soumith/repos", "events_url": "https://api.github.com/users/soumith/events{/privacy}", "received_events_url": "https://api.github.com/users/soumith/received_events", "type": "User", "site_admin": false}, {"login": "gchanan", "id": 3768583, "node_id": "MDQ6VXNlcjM3Njg1ODM=", "avatar_url": "https://avatars2.githubusercontent.com/u/3768583?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gchanan", "html_url": "https://github.com/gchanan", "followers_url": "https://api.github.com/users/gchanan/followers", "following_url": "https://api.github.com/users/gchanan/following{/other_user}", "gists_url": "https://api.github.com/users/gchanan/gists{/gist_id}", "starred_url": "https://api.github.com/users/gchanan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gchanan/subscriptions", "organizations_url": "https://api.github.com/users/gchanan/orgs", "repos_url": "https://api.github.com/users/gchanan/repos", "events_url": "https://api.github.com/users/gchanan/events{/privacy}", "received_events_url": "https://api.github.com/users/gchanan/received_events", "type": "User", "site_admin": false}, {"login": "apaszke", "id": 4583066, "node_id": "MDQ6VXNlcjQ1ODMwNjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/4583066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apaszke", "html_url": "https://github.com/apaszke", "followers_url": "https://api.github.com/users/apaszke/followers", "following_url": "https://api.github.com/users/apaszke/following{/other_user}", "gists_url": "https://api.github.com/users/apaszke/gists{/gist_id}", "starred_url": "https://api.github.com/users/apaszke/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apaszke/subscriptions", "organizations_url": "https://api.github.com/users/apaszke/orgs", "repos_url": "https://api.github.com/users/apaszke/repos", "events_url": "https://api.github.com/users/apaszke/events{/privacy}", "received_events_url": "https://api.github.com/users/apaszke/received_events", "type": "User", "site_admin": false}], "requested_teams": [], "labels": [{"id": 846310180, "node_id": "MDU6TGFiZWw4NDYzMTAxODA=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/bc-breaking", "name": "bc-breaking", "color": "ed7d8a", "default": false}], "milestone": null, "commits_url": "https://api.github.com/repos/pytorch/pytorch/pulls/7889/commits", "review_comments_url": "https://api.github.com/repos/pytorch/pytorch/pulls/7889/comments", "review_comment_url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/7889/comments", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/411af2c4e8412495b48e77f1a008c62d6fb7a08f", "head": {"label": "bado-lee:master", "ref": "master", "sha": "411af2c4e8412495b48e77f1a008c62d6fb7a08f", "user": {"login": "bado-lee", "id": 26222919, "node_id": "MDQ6VXNlcjI2MjIyOTE5", "avatar_url": "https://avatars1.githubusercontent.com/u/26222919?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bado-lee", "html_url": "https://github.com/bado-lee", "followers_url": "https://api.github.com/users/bado-lee/followers", "following_url": "https://api.github.com/users/bado-lee/following{/other_user}", "gists_url": "https://api.github.com/users/bado-lee/gists{/gist_id}", "starred_url": "https://api.github.com/users/bado-lee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bado-lee/subscriptions", "organizations_url": "https://api.github.com/users/bado-lee/orgs", "repos_url": "https://api.github.com/users/bado-lee/repos", "events_url": "https://api.github.com/users/bado-lee/events{/privacy}", "received_events_url": "https://api.github.com/users/bado-lee/received_events", "type": "User", "site_admin": false}, "repo": {"id": 134822371, "node_id": "MDEwOlJlcG9zaXRvcnkxMzQ4MjIzNzE=", "name": "pytorch", "full_name": "bado-lee/pytorch", "private": false, "owner": {"login": "bado-lee", "id": 26222919, "node_id": "MDQ6VXNlcjI2MjIyOTE5", "avatar_url": "https://avatars1.githubusercontent.com/u/26222919?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bado-lee", "html_url": "https://github.com/bado-lee", "followers_url": "https://api.github.com/users/bado-lee/followers", "following_url": "https://api.github.com/users/bado-lee/following{/other_user}", "gists_url": "https://api.github.com/users/bado-lee/gists{/gist_id}", "starred_url": "https://api.github.com/users/bado-lee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bado-lee/subscriptions", "organizations_url": "https://api.github.com/users/bado-lee/orgs", "repos_url": "https://api.github.com/users/bado-lee/repos", "events_url": "https://api.github.com/users/bado-lee/events{/privacy}", "received_events_url": "https://api.github.com/users/bado-lee/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/bado-lee/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": true, "url": "https://api.github.com/repos/bado-lee/pytorch", "forks_url": "https://api.github.com/repos/bado-lee/pytorch/forks", "keys_url": "https://api.github.com/repos/bado-lee/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/bado-lee/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/bado-lee/pytorch/teams", "hooks_url": "https://api.github.com/repos/bado-lee/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/bado-lee/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/bado-lee/pytorch/events", "assignees_url": "https://api.github.com/repos/bado-lee/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/bado-lee/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/bado-lee/pytorch/tags", "blobs_url": "https://api.github.com/repos/bado-lee/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/bado-lee/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/bado-lee/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/bado-lee/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/bado-lee/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/bado-lee/pytorch/languages", "stargazers_url": "https://api.github.com/repos/bado-lee/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/bado-lee/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/bado-lee/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/bado-lee/pytorch/subscription", "commits_url": "https://api.github.com/repos/bado-lee/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/bado-lee/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/bado-lee/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/bado-lee/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/bado-lee/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/bado-lee/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/bado-lee/pytorch/merges", "archive_url": "https://api.github.com/repos/bado-lee/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/bado-lee/pytorch/downloads", "issues_url": "https://api.github.com/repos/bado-lee/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/bado-lee/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/bado-lee/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/bado-lee/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/bado-lee/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/bado-lee/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/bado-lee/pytorch/deployments", "created_at": "2018-05-25T07:50:10Z", "updated_at": "2018-06-12T04:36:52Z", "pushed_at": "2018-06-12T04:36:41Z", "git_url": "git://github.com/bado-lee/pytorch.git", "ssh_url": "git@github.com:bado-lee/pytorch.git", "clone_url": "https://github.com/bado-lee/pytorch.git", "svn_url": "https://github.com/bado-lee/pytorch", "homepage": "http://pytorch.org", "size": 55860, "stargazers_count": 0, "watchers_count": 0, "language": "C++", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 0, "mirror_url": null, "archived": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "pytorch:master", "ref": "master", "sha": "44973a06ba64fe47524716c7088aed9c501710a7", "user": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 65600975, "node_id": "MDEwOlJlcG9zaXRvcnk2NTYwMDk3NQ==", "name": "pytorch", "full_name": "pytorch/pytorch", "private": false, "owner": {"login": "pytorch", "id": 21003710, "node_id": "MDEyOk9yZ2FuaXphdGlvbjIxMDAzNzEw", "avatar_url": "https://avatars3.githubusercontent.com/u/21003710?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pytorch", "html_url": "https://github.com/pytorch", "followers_url": "https://api.github.com/users/pytorch/followers", "following_url": "https://api.github.com/users/pytorch/following{/other_user}", "gists_url": "https://api.github.com/users/pytorch/gists{/gist_id}", "starred_url": "https://api.github.com/users/pytorch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pytorch/subscriptions", "organizations_url": "https://api.github.com/users/pytorch/orgs", "repos_url": "https://api.github.com/users/pytorch/repos", "events_url": "https://api.github.com/users/pytorch/events{/privacy}", "received_events_url": "https://api.github.com/users/pytorch/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/pytorch/pytorch", "description": "Tensors and Dynamic neural networks in Python  with strong GPU acceleration", "fork": false, "url": "https://api.github.com/repos/pytorch/pytorch", "forks_url": "https://api.github.com/repos/pytorch/pytorch/forks", "keys_url": "https://api.github.com/repos/pytorch/pytorch/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/pytorch/pytorch/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/pytorch/pytorch/teams", "hooks_url": "https://api.github.com/repos/pytorch/pytorch/hooks", "issue_events_url": "https://api.github.com/repos/pytorch/pytorch/issues/events{/number}", "events_url": "https://api.github.com/repos/pytorch/pytorch/events", "assignees_url": "https://api.github.com/repos/pytorch/pytorch/assignees{/user}", "branches_url": "https://api.github.com/repos/pytorch/pytorch/branches{/branch}", "tags_url": "https://api.github.com/repos/pytorch/pytorch/tags", "blobs_url": "https://api.github.com/repos/pytorch/pytorch/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/pytorch/pytorch/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/pytorch/pytorch/git/refs{/sha}", "trees_url": "https://api.github.com/repos/pytorch/pytorch/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/pytorch/pytorch/statuses/{sha}", "languages_url": "https://api.github.com/repos/pytorch/pytorch/languages", "stargazers_url": "https://api.github.com/repos/pytorch/pytorch/stargazers", "contributors_url": "https://api.github.com/repos/pytorch/pytorch/contributors", "subscribers_url": "https://api.github.com/repos/pytorch/pytorch/subscribers", "subscription_url": "https://api.github.com/repos/pytorch/pytorch/subscription", "commits_url": "https://api.github.com/repos/pytorch/pytorch/commits{/sha}", "git_commits_url": "https://api.github.com/repos/pytorch/pytorch/git/commits{/sha}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/comments{/number}", "issue_comment_url": "https://api.github.com/repos/pytorch/pytorch/issues/comments{/number}", "contents_url": "https://api.github.com/repos/pytorch/pytorch/contents/{+path}", "compare_url": "https://api.github.com/repos/pytorch/pytorch/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/pytorch/pytorch/merges", "archive_url": "https://api.github.com/repos/pytorch/pytorch/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/pytorch/pytorch/downloads", "issues_url": "https://api.github.com/repos/pytorch/pytorch/issues{/number}", "pulls_url": "https://api.github.com/repos/pytorch/pytorch/pulls{/number}", "milestones_url": "https://api.github.com/repos/pytorch/pytorch/milestones{/number}", "notifications_url": "https://api.github.com/repos/pytorch/pytorch/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/pytorch/pytorch/labels{/name}", "releases_url": "https://api.github.com/repos/pytorch/pytorch/releases{/id}", "deployments_url": "https://api.github.com/repos/pytorch/pytorch/deployments", "created_at": "2016-08-13T05:26:41Z", "updated_at": "2018-11-24T05:35:41Z", "pushed_at": "2018-11-24T05:34:07Z", "git_url": "git://github.com/pytorch/pytorch.git", "ssh_url": "git@github.com:pytorch/pytorch.git", "clone_url": "https://github.com/pytorch/pytorch.git", "svn_url": "https://github.com/pytorch/pytorch", "homepage": "http://pytorch.org", "size": 89651, "stargazers_count": 21577, "watchers_count": 21577, "language": "C++", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "forks_count": 5149, "mirror_url": null, "archived": false, "open_issues_count": 2193, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "forks": 5149, "open_issues": 2193, "watchers": 21577, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/7889"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/7889"}, "issue": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/7889"}, "comments": {"href": "https://api.github.com/repos/pytorch/pytorch/issues/7889/comments"}, "review_comments": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/7889/comments"}, "review_comment": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/7889/commits"}, "statuses": {"href": "https://api.github.com/repos/pytorch/pytorch/statuses/411af2c4e8412495b48e77f1a008c62d6fb7a08f"}}, "author_association": "NONE", "body_html": "<p>Hello everyone :) !!</p>\n<p>I've found that lr_scheduler was initialized with last_epoch as -1.<br>\nThis causes that even after the first step (not the one in init but explicit step of scheduler),<br>\nlearning rate of scheduler's optimizer remains as the previous.</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">import</span> torch\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> cc <span class=\"pl-k\">=</span> torch.nn.Conv2d(<span class=\"pl-c1\">10</span>,<span class=\"pl-c1\">10</span>,<span class=\"pl-c1\">3</span>)\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myinitial_lr <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0.1</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myoptimizer <span class=\"pl-k\">=</span> torch.optim.Adam(cc.parameters(), <span class=\"pl-v\">lr</span><span class=\"pl-k\">=</span>myinitial_lr)\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> mylrdecay <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0.5</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler <span class=\"pl-k\">=</span> torch.optim.lr_scheduler.ExponentialLR(myoptimizer,mylrdecay)\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> get_lr value and optimizer's lr value is not consistent, last_epoch should be 0 instead of -1</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.get_lr()\n[<span class=\"pl-c1\">0.2</span>]    <span class=\"pl-c\"><span class=\"pl-c\">#</span> this is because of  get_lr calculates lr by 0.1 * 0.5^-1</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.optimizer.param_groups[<span class=\"pl-c1\">0</span>][<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>lr<span class=\"pl-pds\">\"</span></span>]\n<span class=\"pl-c1\">0.1</span>    <span class=\"pl-c\"><span class=\"pl-c\">#</span> this is not consistent with get_lr value</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.last_epoch\n<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> values seem to be in sync but should have been decayed value of 0.05 after first step(decay)</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.step()\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.get_lr()\n[<span class=\"pl-c1\">0.1</span>]    <span class=\"pl-c\"><span class=\"pl-c\">#</span> this should be the value right after the init, not after first step</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.optimizer.param_groups[<span class=\"pl-c1\">0</span>][<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>lr<span class=\"pl-pds\">\"</span></span>]\n<span class=\"pl-c1\">0.1</span>    <span class=\"pl-c\"><span class=\"pl-c\">#</span> since this is after first step, it should have been decayed as 0.05</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.last_epoch\n<span class=\"pl-c1\">0</span>\n\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.step()\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.last_epoch\n<span class=\"pl-c1\">1</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.get_lr()\n[<span class=\"pl-c1\">0.05</span>]\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.optimizer.param_groups[<span class=\"pl-c1\">0</span>][<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>lr<span class=\"pl-pds\">\"</span></span>]\n<span class=\"pl-c1\">0.05</span>\n<span class=\"pl-k\">&gt;&gt;</span><span class=\"pl-k\">&gt;</span> myscheduler.last_epoch\n<span class=\"pl-c1\">1</span></pre></div>\n<p>First problem is, even after the init of lr_scheduler, you get the inconsistent parameter values.</p>\n<p>The second problem is, you are stuck with same learning rate in the first 2 epochs if the step function of lr_scheduler is not called in the beginning of the epoch loop.<br>\nOf course, you can avoid this by calling lr_scheduler's step in the beginning,<br>\nbut I don't think this is proper use since, incase of optimizer, step is called in the end of the iteration loop.</p>\n<p>I've simply avoided all above issues by setting last_epoch as 0 after the initialization.</p>\n<p>This also makes sense when you init with some value of last_epoch which is not -1.<br>\nFor example, if you want to init with last epoch 10,<br>\nlr should not be set with decayed 1 step further. Which is<br>\nlast_epoch gets +1 in the previous code.<br>\nbase_lr * self.gamma ** self.last_epoch</p>\n<p>Instead, it should be set with step 10 exact value.</p>\n<p>I hope this fix find it's way with all your help :)<br>\nI'm really looking forward &amp; excited to become a contributor for pytorch!<br>\nPytorch Rocks!!</p>", "body_text": "Hello everyone :) !!\nI've found that lr_scheduler was initialized with last_epoch as -1.\nThis causes that even after the first step (not the one in init but explicit step of scheduler),\nlearning rate of scheduler's optimizer remains as the previous.\n>>> import torch\n>>> cc = torch.nn.Conv2d(10,10,3)\n>>> myinitial_lr = 0.1\n>>> myoptimizer = torch.optim.Adam(cc.parameters(), lr=myinitial_lr)\n>>> mylrdecay = 0.5\n>>> myscheduler = torch.optim.lr_scheduler.ExponentialLR(myoptimizer,mylrdecay)\n\n# get_lr value and optimizer's lr value is not consistent, last_epoch should be 0 instead of -1\n>>> myscheduler.get_lr()\n[0.2]    # this is because of  get_lr calculates lr by 0.1 * 0.5^-1\n>>> myscheduler.optimizer.param_groups[0][\"lr\"]\n0.1    # this is not consistent with get_lr value\n>>> myscheduler.last_epoch\n-1\n\n# values seem to be in sync but should have been decayed value of 0.05 after first step(decay)\n>>> myscheduler.step()\n>>> myscheduler.get_lr()\n[0.1]    # this should be the value right after the init, not after first step\n>>> myscheduler.optimizer.param_groups[0][\"lr\"]\n0.1    # since this is after first step, it should have been decayed as 0.05\n>>> myscheduler.last_epoch\n0\n\n>>> myscheduler.step()\n>>> myscheduler.last_epoch\n1\n>>> myscheduler.get_lr()\n[0.05]\n>>> myscheduler.optimizer.param_groups[0][\"lr\"]\n0.05\n>>> myscheduler.last_epoch\n1\nFirst problem is, even after the init of lr_scheduler, you get the inconsistent parameter values.\nThe second problem is, you are stuck with same learning rate in the first 2 epochs if the step function of lr_scheduler is not called in the beginning of the epoch loop.\nOf course, you can avoid this by calling lr_scheduler's step in the beginning,\nbut I don't think this is proper use since, incase of optimizer, step is called in the end of the iteration loop.\nI've simply avoided all above issues by setting last_epoch as 0 after the initialization.\nThis also makes sense when you init with some value of last_epoch which is not -1.\nFor example, if you want to init with last epoch 10,\nlr should not be set with decayed 1 step further. Which is\nlast_epoch gets +1 in the previous code.\nbase_lr * self.gamma ** self.last_epoch\nInstead, it should be set with step 10 exact value.\nI hope this fix find it's way with all your help :)\nI'm really looking forward & excited to become a contributor for pytorch!\nPytorch Rocks!!", "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 12, "review_comments": 0, "maintainer_can_modify": true, "commits": 1, "additions": 5, "deletions": 5, "changed_files": 1}