{"url": "https://api.github.com/repos/pytorch/pytorch/issues/5879", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/5879/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/5879/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/5879/events", "html_url": "https://github.com/pytorch/pytorch/issues/5879", "id": 306552377, "node_id": "MDU6SXNzdWUzMDY1NTIzNzc=", "number": 5879, "title": "torch.load block asyncio loop", "user": {"login": "pohmelie", "id": 2385765, "node_id": "MDQ6VXNlcjIzODU3NjU=", "avatar_url": "https://avatars2.githubusercontent.com/u/2385765?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pohmelie", "html_url": "https://github.com/pohmelie", "followers_url": "https://api.github.com/users/pohmelie/followers", "following_url": "https://api.github.com/users/pohmelie/following{/other_user}", "gists_url": "https://api.github.com/users/pohmelie/gists{/gist_id}", "starred_url": "https://api.github.com/users/pohmelie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pohmelie/subscriptions", "organizations_url": "https://api.github.com/users/pohmelie/orgs", "repos_url": "https://api.github.com/users/pohmelie/repos", "events_url": "https://api.github.com/users/pohmelie/events{/privacy}", "received_events_url": "https://api.github.com/users/pohmelie/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2018-03-19T17:09:53Z", "updated_at": "2018-08-01T20:55:39Z", "closed_at": "2018-03-29T12:48:33Z", "author_association": "CONTRIBUTOR", "body_html": "<ul>\n<li>OS: Ubuntu 16.04.4 LTS</li>\n<li>PyTorch version: 0.3.1</li>\n<li>How you installed PyTorch (conda, pip, source): pip</li>\n<li>Python version: 3.6.2</li>\n</ul>\n<p>It looks like torch (or dependencies) holds the GIL and asyncio loop is blocked.</p>\n<p>Code to reproduce:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> asyncio\n<span class=\"pl-k\">import</span> logging\n\n<span class=\"pl-k\">import</span> torch\n\n\n<span class=\"pl-k\">async</span> <span class=\"pl-k\">def</span> <span class=\"pl-en\">foo</span>():\n    <span class=\"pl-k\">while</span> <span class=\"pl-c1\">True</span>:\n        logging.info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>foo<span class=\"pl-pds\">\"</span></span>)\n        <span class=\"pl-k\">await</span> asyncio.sleep(<span class=\"pl-c1\">0.25</span>)\n\n\n<span class=\"pl-k\">async</span> <span class=\"pl-k\">def</span> <span class=\"pl-en\">yoba</span>():\n    task <span class=\"pl-k\">=</span> asyncio.ensure_future(foo())\n    <span class=\"pl-k\">await</span> asyncio.sleep(<span class=\"pl-c1\">0.5</span>)\n    <span class=\"pl-k\">await</span> loop.run_in_executor(<span class=\"pl-c1\">None</span>, torch.load, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>model.pth<span class=\"pl-pds\">\"</span></span>)\n    <span class=\"pl-k\">await</span> asyncio.sleep(<span class=\"pl-c1\">0.5</span>)\n    task.cancel()\n\n\nlogging.basicConfig(<span class=\"pl-v\">level</span><span class=\"pl-k\">=</span>logging.<span class=\"pl-c1\">DEBUG</span>, <span class=\"pl-v\">format</span><span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-c1\">%(asctime)s</span> - <span class=\"pl-c1\">%(name)s</span> - <span class=\"pl-c1\">%(levelname)s</span> - <span class=\"pl-c1\">%(message)s</span><span class=\"pl-pds\">\"</span></span>)\nasyncio.ensure_future(yoba())\nloop <span class=\"pl-k\">=</span> asyncio.get_event_loop()\nloop.run_forever()</pre></div>\n<p>Output:</p>\n<pre><code>$ PYTHONASYNCIODEBUG=1 python pytorch-block-asyncio.py\n2018-03-19 20:02:33,188 - asyncio - DEBUG - Using selector: EpollSelector\n2018-03-19 20:02:33,192 - root - INFO - foo\n2018-03-19 20:02:33,443 - root - INFO - foo\n2018-03-19 20:02:35,333 - asyncio - WARNING - Executing &lt;TimerHandle when=628364.105270115 _set_result_unless_cancelled(&lt;Future finis...events.py:275&gt;, None) at /home/broomrider/.pyenv/versions/3.6.2-kron/lib/python3.6/asyncio/futures.py:344 created at /home/broomrider/.pyenv/versions/3.6.2-kron/lib/python3.6/asyncio/tasks.py:480&gt; took 1.630 seconds\n2018-03-19 20:02:35,333 - root - INFO - foo\n2018-03-19 20:02:35,463 - asyncio - DEBUG - poll 249.905 ms took 129.609 ms: 1 events\n2018-03-19 20:02:35,584 - root - INFO - foo\n2018-03-19 20:02:35,835 - root - INFO - foo\n</code></pre>", "body_text": "OS: Ubuntu 16.04.4 LTS\nPyTorch version: 0.3.1\nHow you installed PyTorch (conda, pip, source): pip\nPython version: 3.6.2\n\nIt looks like torch (or dependencies) holds the GIL and asyncio loop is blocked.\nCode to reproduce:\nimport asyncio\nimport logging\n\nimport torch\n\n\nasync def foo():\n    while True:\n        logging.info(\"foo\")\n        await asyncio.sleep(0.25)\n\n\nasync def yoba():\n    task = asyncio.ensure_future(foo())\n    await asyncio.sleep(0.5)\n    await loop.run_in_executor(None, torch.load, \"model.pth\")\n    await asyncio.sleep(0.5)\n    task.cancel()\n\n\nlogging.basicConfig(level=logging.DEBUG, format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\")\nasyncio.ensure_future(yoba())\nloop = asyncio.get_event_loop()\nloop.run_forever()\nOutput:\n$ PYTHONASYNCIODEBUG=1 python pytorch-block-asyncio.py\n2018-03-19 20:02:33,188 - asyncio - DEBUG - Using selector: EpollSelector\n2018-03-19 20:02:33,192 - root - INFO - foo\n2018-03-19 20:02:33,443 - root - INFO - foo\n2018-03-19 20:02:35,333 - asyncio - WARNING - Executing <TimerHandle when=628364.105270115 _set_result_unless_cancelled(<Future finis...events.py:275>, None) at /home/broomrider/.pyenv/versions/3.6.2-kron/lib/python3.6/asyncio/futures.py:344 created at /home/broomrider/.pyenv/versions/3.6.2-kron/lib/python3.6/asyncio/tasks.py:480> took 1.630 seconds\n2018-03-19 20:02:35,333 - root - INFO - foo\n2018-03-19 20:02:35,463 - asyncio - DEBUG - poll 249.905 ms took 129.609 ms: 1 events\n2018-03-19 20:02:35,584 - root - INFO - foo\n2018-03-19 20:02:35,835 - root - INFO - foo", "body": "- OS: Ubuntu 16.04.4 LTS\r\n- PyTorch version: 0.3.1\r\n- How you installed PyTorch (conda, pip, source): pip\r\n- Python version: 3.6.2\r\n\r\nIt looks like torch (or dependencies) holds the GIL and asyncio loop is blocked.\r\n\r\nCode to reproduce:\r\n``` python\r\nimport asyncio\r\nimport logging\r\n\r\nimport torch\r\n\r\n\r\nasync def foo():\r\n    while True:\r\n        logging.info(\"foo\")\r\n        await asyncio.sleep(0.25)\r\n\r\n\r\nasync def yoba():\r\n    task = asyncio.ensure_future(foo())\r\n    await asyncio.sleep(0.5)\r\n    await loop.run_in_executor(None, torch.load, \"model.pth\")\r\n    await asyncio.sleep(0.5)\r\n    task.cancel()\r\n\r\n\r\nlogging.basicConfig(level=logging.DEBUG, format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\")\r\nasyncio.ensure_future(yoba())\r\nloop = asyncio.get_event_loop()\r\nloop.run_forever()\r\n```\r\n\r\nOutput:\r\n```\r\n$ PYTHONASYNCIODEBUG=1 python pytorch-block-asyncio.py\r\n2018-03-19 20:02:33,188 - asyncio - DEBUG - Using selector: EpollSelector\r\n2018-03-19 20:02:33,192 - root - INFO - foo\r\n2018-03-19 20:02:33,443 - root - INFO - foo\r\n2018-03-19 20:02:35,333 - asyncio - WARNING - Executing <TimerHandle when=628364.105270115 _set_result_unless_cancelled(<Future finis...events.py:275>, None) at /home/broomrider/.pyenv/versions/3.6.2-kron/lib/python3.6/asyncio/futures.py:344 created at /home/broomrider/.pyenv/versions/3.6.2-kron/lib/python3.6/asyncio/tasks.py:480> took 1.630 seconds\r\n2018-03-19 20:02:35,333 - root - INFO - foo\r\n2018-03-19 20:02:35,463 - asyncio - DEBUG - poll 249.905 ms took 129.609 ms: 1 events\r\n2018-03-19 20:02:35,584 - root - INFO - foo\r\n2018-03-19 20:02:35,835 - root - INFO - foo\r\n```"}