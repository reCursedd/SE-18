{"url": "https://api.github.com/repos/pytorch/pytorch/issues/10392", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/10392/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/10392/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/10392/events", "html_url": "https://github.com/pytorch/pytorch/pull/10392", "id": 349338367, "node_id": "MDExOlB1bGxSZXF1ZXN0MjA3NDgwMTM1", "number": 10392, "title": "LocalHostScheduler __exit__ terminates subprocesses rather than waiting for them on exception", "user": {"login": "xsh6528", "id": 7608630, "node_id": "MDQ6VXNlcjc2MDg2MzA=", "avatar_url": "https://avatars2.githubusercontent.com/u/7608630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xsh6528", "html_url": "https://github.com/xsh6528", "followers_url": "https://api.github.com/users/xsh6528/followers", "following_url": "https://api.github.com/users/xsh6528/following{/other_user}", "gists_url": "https://api.github.com/users/xsh6528/gists{/gist_id}", "starred_url": "https://api.github.com/users/xsh6528/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xsh6528/subscriptions", "organizations_url": "https://api.github.com/users/xsh6528/orgs", "repos_url": "https://api.github.com/users/xsh6528/repos", "events_url": "https://api.github.com/users/xsh6528/events{/privacy}", "received_events_url": "https://api.github.com/users/xsh6528/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-08-10T00:44:06Z", "updated_at": "2018-08-21T17:32:21Z", "closed_at": "2018-08-21T17:32:21Z", "author_association": "CONTRIBUTOR", "pull_request": {"url": "https://api.github.com/repos/pytorch/pytorch/pulls/10392", "html_url": "https://github.com/pytorch/pytorch/pull/10392", "diff_url": "https://github.com/pytorch/pytorch/pull/10392.diff", "patch_url": "https://github.com/pytorch/pytorch/pull/10392.patch"}, "body_html": "<p>Summary:<br>\nFor now, you can't assert in a LocalHostScheduler context. In case the assertion fails (an exception is raised), the LocalHostScheduler get stuck and prints nothing.</p>\n<p>For example, the following code will get stuck, and the assertion error is not printed in stdout.</p>\n<p>from caffe2.python import task, test_util<br>\nfrom caffe2.python.fb.distribute import runner</p>\n<p>class TestLocalHostScheduler(test_util.TestCase):<br>\ndef test_handle_exception_from_within_context(self):<br>\ntask.Node()<br>\nwith runner.LocalHostScheduler():<br>\nself.assertEqual(0, 1)</p>\n<p>Code pointer to where I hit this problem: <a href=\"https://fburl.com/l5n8nnm7\" rel=\"nofollow\">https://fburl.com/l5n8nnm7</a><br>\nI changed to 100 to another number, then the test gets stuck.</p>\n<p>This stuck problem only occurs when <code>ex_value</code> is not None.</p>\n<p><code>self.session.__exit__(ex_type, ex_value, traceback)</code> sends <code>Worker.CLOSE_CMD</code>, if <code>ex_value</code> is None.</p>\n<p>But notice <code>self.session.__exit__(ex_type, ex_value, traceback)</code> does nothing, if <code>ex_value</code> is not None.</p>\n<p>However, it is always followed by</p>\n<pre><code>for p in self._procs:\n  p.join()\n</code></pre>\n<p>In the case of being stuck, sub-processes will keep looping in <code>task_loop()</code>, because they never received the <code>Worker.CLOSE_CMD</code>.</p>\n<ul>\n<li>Only wait (<code>.join</code>) if the <code>Worker.CLOSE_CMD</code> is actually sent out.</li>\n<li>Even if wait, set a timeout.</li>\n<li>Always terminate the sub-processes at the end as gate keeper (finally).</li>\n</ul>\n<p>Differential Revision: D9256501</p>", "body_text": "Summary:\nFor now, you can't assert in a LocalHostScheduler context. In case the assertion fails (an exception is raised), the LocalHostScheduler get stuck and prints nothing.\nFor example, the following code will get stuck, and the assertion error is not printed in stdout.\nfrom caffe2.python import task, test_util\nfrom caffe2.python.fb.distribute import runner\nclass TestLocalHostScheduler(test_util.TestCase):\ndef test_handle_exception_from_within_context(self):\ntask.Node()\nwith runner.LocalHostScheduler():\nself.assertEqual(0, 1)\nCode pointer to where I hit this problem: https://fburl.com/l5n8nnm7\nI changed to 100 to another number, then the test gets stuck.\nThis stuck problem only occurs when ex_value is not None.\nself.session.__exit__(ex_type, ex_value, traceback) sends Worker.CLOSE_CMD, if ex_value is None.\nBut notice self.session.__exit__(ex_type, ex_value, traceback) does nothing, if ex_value is not None.\nHowever, it is always followed by\nfor p in self._procs:\n  p.join()\n\nIn the case of being stuck, sub-processes will keep looping in task_loop(), because they never received the Worker.CLOSE_CMD.\n\nOnly wait (.join) if the Worker.CLOSE_CMD is actually sent out.\nEven if wait, set a timeout.\nAlways terminate the sub-processes at the end as gate keeper (finally).\n\nDifferential Revision: D9256501", "body": "Summary:\nFor now, you can't assert in a LocalHostScheduler context. In case the assertion fails (an exception is raised), the LocalHostScheduler get stuck and prints nothing.\n\nFor example, the following code will get stuck, and the assertion error is not printed in stdout.\n\nfrom caffe2.python import task, test_util\nfrom caffe2.python.fb.distribute import runner\n\nclass TestLocalHostScheduler(test_util.TestCase):\n    def test_handle_exception_from_within_context(self):\n        task.Node()\n        with runner.LocalHostScheduler():\n            self.assertEqual(0, 1)\n\nCode pointer to where I hit this problem: https://fburl.com/l5n8nnm7\nI changed to 100 to another number, then the test gets stuck.\n\nThis stuck problem only occurs when `ex_value` is not None.\n\n`self.session.__exit__(ex_type, ex_value, traceback)` sends `Worker.CLOSE_CMD`, if `ex_value` is None.\n\nBut notice `self.session.__exit__(ex_type, ex_value, traceback)` does nothing, if `ex_value` is not None.\n\nHowever, it is always followed by\n```\nfor p in self._procs:\n  p.join()\n```\n\nIn the case of being stuck, sub-processes will keep looping in `task_loop()`, because they never received the `Worker.CLOSE_CMD`.\n\n- Only wait (`.join`) if the `Worker.CLOSE_CMD` is actually sent out.\n- Even if wait, set a timeout.\n- Always terminate the sub-processes at the end as gate keeper (finally).\n\nDifferential Revision: D9256501\n"}