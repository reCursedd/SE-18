{"url": "https://api.github.com/repos/pytorch/pytorch/issues/7516", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/7516/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/7516/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/7516/events", "html_url": "https://github.com/pytorch/pytorch/issues/7516", "id": 322473069, "node_id": "MDU6SXNzdWUzMjI0NzMwNjk=", "number": 7516, "title": "[bug] gCurrentWorkspaceName not switched back on exiting WorkspaceGuard context", "user": {"login": "xsh6528", "id": 7608630, "node_id": "MDQ6VXNlcjc2MDg2MzA=", "avatar_url": "https://avatars2.githubusercontent.com/u/7608630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xsh6528", "html_url": "https://github.com/xsh6528", "followers_url": "https://api.github.com/users/xsh6528/followers", "following_url": "https://api.github.com/users/xsh6528/following{/other_user}", "gists_url": "https://api.github.com/users/xsh6528/gists{/gist_id}", "starred_url": "https://api.github.com/users/xsh6528/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xsh6528/subscriptions", "organizations_url": "https://api.github.com/users/xsh6528/orgs", "repos_url": "https://api.github.com/users/xsh6528/repos", "events_url": "https://api.github.com/users/xsh6528/events{/privacy}", "received_events_url": "https://api.github.com/users/xsh6528/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-05-12T01:45:04Z", "updated_at": "2018-05-14T17:38:12Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<h1>Background</h1>\n<p><code>caffe2/python/pybind_state.cc</code> maintains the current workspace in Python environment by<br>\nvariable <code>gWorkspace</code> and <code>gCurrentWorkspaceName </code>. See <a href=\"https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L32-L38\">https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L32-L38</a></p>\n<p>These two variables should be always changed together. See <a href=\"https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L122-L123\">https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L122-L123</a></p>\n<p><code>WorkspaceGuard</code> is extensively used in <code>LocalSession</code>. See <a href=\"https://github.com/pytorch/pytorch/blob/master/caffe2/python/session.py#L209\">https://github.com/pytorch/pytorch/blob/master/caffe2/python/session.py#L209</a></p>\n<h1>Problem</h1>\n<p>When exiting the context of <code>WorkspaceGuard</code>, the <code>gCurrentWorkspaceName</code> is not set back.</p>\n<p>See <a href=\"https://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L463\">https://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L463</a></p>\n<p><a href=\"https://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L34\">https://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L34</a></p>\n<p>and</p>\n<p><a href=\"https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L915\">https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L915</a></p>\n<h1>Possible Solutions</h1>\n<ol>\n<li></li>\n</ol>\n<p>Return <code>gWorkspaceName</code> on calling <code>workspace.CurrentWorkspace(...)</code>.</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>Add a method <code>workspace.CurrentWorkspaceName()</code>, and use it in the method <code>workspace.WorkspaceGuard(...)</code>.</p>\n<h1>BTW</h1>\n<p>This line is redundant, since <code>gCurrentWorkspaceName</code> is set in <code>switchWorkspaceInternal </code>. <a href=\"https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L1441\">https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L1441</a></p>", "body_text": "Background\ncaffe2/python/pybind_state.cc maintains the current workspace in Python environment by\nvariable gWorkspace and gCurrentWorkspaceName . See https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L32-L38\nThese two variables should be always changed together. See https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L122-L123\nWorkspaceGuard is extensively used in LocalSession. See https://github.com/pytorch/pytorch/blob/master/caffe2/python/session.py#L209\nProblem\nWhen exiting the context of WorkspaceGuard, the gCurrentWorkspaceName is not set back.\nSee https://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L463\nhttps://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L34\nand\nhttps://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L915\nPossible Solutions\n\n\n\nReturn gWorkspaceName on calling workspace.CurrentWorkspace(...).\n\n\n\nAdd a method workspace.CurrentWorkspaceName(), and use it in the method workspace.WorkspaceGuard(...).\nBTW\nThis line is redundant, since gCurrentWorkspaceName is set in switchWorkspaceInternal . https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L1441", "body": "# Background\r\n\r\n`caffe2/python/pybind_state.cc` maintains the current workspace in Python environment by\r\nvariable `gWorkspace` and `gCurrentWorkspaceName `. See https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L32-L38\r\n\r\nThese two variables should be always changed together. See https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L122-L123\r\n\r\n`WorkspaceGuard` is extensively used in `LocalSession`. See https://github.com/pytorch/pytorch/blob/master/caffe2/python/session.py#L209\r\n\r\n# Problem\r\n\r\nWhen exiting the context of `WorkspaceGuard`, the `gCurrentWorkspaceName` is not set back. \r\n\r\nSee https://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L463\r\n\r\nhttps://github.com/caffe2/caffe2/blob/master/caffe2/python/workspace.py#L34\r\n\r\nand\r\n\r\nhttps://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L915\r\n\r\n\r\n# Possible Solutions\r\n\r\n1.\r\nReturn `gWorkspaceName` on calling `workspace.CurrentWorkspace(...)`.\r\n\r\n2. \r\nAdd a method `workspace.CurrentWorkspaceName()`, and use it in the method `workspace.WorkspaceGuard(...)`.\r\n\r\n# BTW\r\n\r\nThis line is redundant, since `gCurrentWorkspaceName` is set in `switchWorkspaceInternal `. https://github.com/caffe2/caffe2/blob/master/caffe2/python/pybind_state.cc#L1441\r\n"}