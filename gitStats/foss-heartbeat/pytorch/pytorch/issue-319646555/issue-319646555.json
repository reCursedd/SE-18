{"url": "https://api.github.com/repos/pytorch/pytorch/issues/7180", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/7180/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/7180/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/7180/events", "html_url": "https://github.com/pytorch/pytorch/issues/7180", "id": 319646555, "node_id": "MDU6SXNzdWUzMTk2NDY1NTU=", "number": 7180, "title": "[Caffe2 Bug] Windows timer is not accurate", "user": {"login": "xkszltl", "id": 5203025, "node_id": "MDQ6VXNlcjUyMDMwMjU=", "avatar_url": "https://avatars0.githubusercontent.com/u/5203025?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xkszltl", "html_url": "https://github.com/xkszltl", "followers_url": "https://api.github.com/users/xkszltl/followers", "following_url": "https://api.github.com/users/xkszltl/following{/other_user}", "gists_url": "https://api.github.com/users/xkszltl/gists{/gist_id}", "starred_url": "https://api.github.com/users/xkszltl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xkszltl/subscriptions", "organizations_url": "https://api.github.com/users/xkszltl/orgs", "repos_url": "https://api.github.com/users/xkszltl/repos", "events_url": "https://api.github.com/users/xkszltl/events{/privacy}", "received_events_url": "https://api.github.com/users/xkszltl/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 890282107, "node_id": "MDU6TGFiZWw4OTAyODIxMDc=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/caffe2", "name": "caffe2", "color": "210aa8", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-05-02T17:37:39Z", "updated_at": "2018-05-02T21:50:27Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<h2>Issue description</h2>\n<p>Caffe2 fails the timer related test on Windows:</p>\n<ul>\n<li>parallel_net_test.exe - This one always fail.</li>\n<li>timer_test.exe - Not always but...good luck...</li>\n</ul>\n<pre><code>PS &lt;...erase for privacy...&gt;\\pytorch\\build&gt; .\\bin\\RelWithDebInfo\\parallel_net_test.exe\nRunning main() from gtest_main.cc\n[==========] Running 10 tests from 2 test cases.\n[----------] Global test environment set-up.\n[----------] 5 tests from DAGNetTest\n[ RUN      ] DAGNetTest.TestDAGNetTiming\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nWARNING: Logging before InitGoogleLogging() is written to STDERR\nI0502 10:15:30.237299 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.8225e-05 secs\nI0502 10:15:30.237299 27072 net_dag.cc:46] Number of parallel execution chains 2 Number of operators = 3\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(108): error: The difference between ms and 200 is 21, which exceeds kTimeThreshold, where\nms evaluates to 221,\n200 evaluates to 200, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] DAGNetTest.TestDAGNetTiming (227 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingReadAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nI0502 10:15:30.475047 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.9936e-05 secs\nI0502 10:15:30.475047 27072 net_dag.cc:46] Number of parallel execution chains 3 Number of operators = 3\n[       OK ] DAGNetTest.TestDAGNetTimingReadAfterRead (267 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingWriteAfterWrite\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nI0502 10:15:30.736847 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.1098e-05 secs\nI0502 10:15:30.736847 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\n[       OK ] DAGNetTest.TestDAGNetTimingWriteAfterWrite (368 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingWriteAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nI0502 10:15:31.104876 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.1953e-05 secs\nI0502 10:15:31.104876 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(254): error: The difference between ms and 350 is 43, which exceeds kTimeThreshold, where\nms evaluates to 393,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] DAGNetTest.TestDAGNetTimingWriteAfterRead (400 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingControlDependency\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 5:3: text format contains deprecated field \"num_workers\"\nI0502 10:15:31.504611 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.2238e-05 secs\nI0502 10:15:31.504611 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(304): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\nms evaluates to 392,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] DAGNetTest.TestDAGNetTimingControlDependency (398 ms)\n[----------] 5 tests from DAGNetTest (1666 ms total)\n\n[----------] 5 tests from SimpleNetTest\n[ RUN      ] SimpleNetTest.TestSimpleNetTiming\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(115): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\nms evaluates to 392,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTiming (398 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingReadAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(164): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\nms evaluates to 392,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingReadAfterRead (398 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(212): error: The difference between ms and 350 is 21, which exceeds kTimeThreshold, where\nms evaluates to 371,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite (376 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(260): error: The difference between ms and 350 is 28, which exceeds kTimeThreshold, where\nms evaluates to 378,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead (383 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingControlDependency\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 5:3: text format contains deprecated field \"num_workers\"\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\parallel_net_test.cc(310): error: The difference between ms and 350 is 43, which exceeds kTimeThreshold, where\nms evaluates to 393,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingControlDependency (398 ms)\n[----------] 5 tests from SimpleNetTest (1962 ms total)\n\n[----------] Global test environment tear-down\n[==========] 10 tests from 2 test cases ran. (3629 ms total)\n[  PASSED  ] 2 tests.\n[  FAILED  ] 8 tests, listed below:\n[  FAILED  ] DAGNetTest.TestDAGNetTiming\n[  FAILED  ] DAGNetTest.TestDAGNetTimingWriteAfterRead\n[  FAILED  ] DAGNetTest.TestDAGNetTimingControlDependency\n[  FAILED  ] SimpleNetTest.TestSimpleNetTiming\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingReadAfterRead\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingControlDependency\n\n 8 FAILED TESTS\n</code></pre>\n<pre><code>PS &lt;...erase for privacy...&gt;\\pytorch\\build&gt; .\\bin\\RelWithDebInfo\\timer_test.exe\nRunning main() from gtest_main.cc\n[==========] Running 2 tests from 1 test case.\n[----------] Global test environment set-up.\n[----------] 2 tests from TimerTest\n[ RUN      ] TimerTest.Test\n[       OK ] TimerTest.Test (115 ms)\n[ RUN      ] TimerTest.TestLatency\nAverage nanosecond latency is: 38.775\nAverage microsecond latency is: 0.040485\nAverage millisecond latency is: 4.0208e-05\n[       OK ] TimerTest.TestLatency (3 ms)\n[----------] 2 tests from TimerTest (119 ms total)\n\n[----------] Global test environment tear-down\n[==========] 2 tests from 1 test case ran. (119 ms total)\n[  PASSED  ] 2 tests.\n</code></pre>\n<pre><code>PS &lt;...erase for privacy...&gt;\\pytorch\\build&gt; .\\bin\\RelWithDebInfo\\timer_test.exe\nRunning main() from gtest_main.cc\n[==========] Running 2 tests from 1 test case.\n[----------] Global test environment set-up.\n[----------] 2 tests from TimerTest\n[ RUN      ] TimerTest.Test\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\timer_test.cc(26): error: The difference between ns and 100000000 is 15655312, which exceeds 10000000, where\nns evaluates to 115655312,\n100000000 evaluates to 100000000, and\n10000000 evaluates to 10000000.\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\timer_test.cc(27): error: The difference between us and 100000 is 15655.3125, which exceeds 10000, where\nus evaluates to 115655.3125,\n100000 evaluates to 100000, and\n10000 evaluates to 10000.\n&lt;...erase for privacy...&gt;\\pytorch\\caffe2\\core\\timer_test.cc(28): error: The difference between ms and 100 is 15.655593872070313, which exceeds 10, where\nms evaluates to 115.65559387207031,\n100 evaluates to 100, and\n10 evaluates to 10.\n[  FAILED  ] TimerTest.Test (126 ms)\n[ RUN      ] TimerTest.TestLatency\nAverage nanosecond latency is: 37.066\nAverage microsecond latency is: 0.036486\nAverage millisecond latency is: 4.0194e-05\n[       OK ] TimerTest.TestLatency (4 ms)\n[----------] 2 tests from TimerTest (131 ms total)\n\n[----------] Global test environment tear-down\n[==========] 2 tests from 1 test case ran. (131 ms total)\n[  PASSED  ] 1 test.\n[  FAILED  ] 1 test, listed below:\n[  FAILED  ] TimerTest.Test\n\n 1 FAILED TEST\n</code></pre>\n<p>I don't think the problem is due to timer itself.<br>\nIt's more likely to be caused by Windows scheduler/time slice configuration.</p>\n<p>On my machine the timer_test almost always shows 15ms (for ns/us/ms tests) difference when failed.<br>\nSometimes it can also be 21ms or 22ms.</p>\n<p>NOTE that I'm testing with 12-thread idle machine, so no system load related issues.</p>\n<h2>System Info</h2>\n<ul>\n<li>PyTorch or Caffe2: Caffe2</li>\n<li>How you installed PyTorch (conda, pip, source): source</li>\n<li>Build command you used (if compiling from source): cmake</li>\n<li>OS: Win10</li>\n<li>PyTorch version: master</li>\n<li>CUDA/cuDNN version: 9.1/7.1.3</li>\n<li>GPU models and configuration: 1080Ti</li>\n<li>Visual Studio version (if compiling from source): 2017.6 + v140 toolchain</li>\n<li>CMake version: 3.11.1</li>\n</ul>", "body_text": "Issue description\nCaffe2 fails the timer related test on Windows:\n\nparallel_net_test.exe - This one always fail.\ntimer_test.exe - Not always but...good luck...\n\nPS <...erase for privacy...>\\pytorch\\build> .\\bin\\RelWithDebInfo\\parallel_net_test.exe\nRunning main() from gtest_main.cc\n[==========] Running 10 tests from 2 test cases.\n[----------] Global test environment set-up.\n[----------] 5 tests from DAGNetTest\n[ RUN      ] DAGNetTest.TestDAGNetTiming\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nWARNING: Logging before InitGoogleLogging() is written to STDERR\nI0502 10:15:30.237299 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.8225e-05 secs\nI0502 10:15:30.237299 27072 net_dag.cc:46] Number of parallel execution chains 2 Number of operators = 3\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(108): error: The difference between ms and 200 is 21, which exceeds kTimeThreshold, where\nms evaluates to 221,\n200 evaluates to 200, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] DAGNetTest.TestDAGNetTiming (227 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingReadAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nI0502 10:15:30.475047 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.9936e-05 secs\nI0502 10:15:30.475047 27072 net_dag.cc:46] Number of parallel execution chains 3 Number of operators = 3\n[       OK ] DAGNetTest.TestDAGNetTimingReadAfterRead (267 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingWriteAfterWrite\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nI0502 10:15:30.736847 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.1098e-05 secs\nI0502 10:15:30.736847 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\n[       OK ] DAGNetTest.TestDAGNetTimingWriteAfterWrite (368 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingWriteAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\nI0502 10:15:31.104876 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.1953e-05 secs\nI0502 10:15:31.104876 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(254): error: The difference between ms and 350 is 43, which exceeds kTimeThreshold, where\nms evaluates to 393,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] DAGNetTest.TestDAGNetTimingWriteAfterRead (400 ms)\n[ RUN      ] DAGNetTest.TestDAGNetTimingControlDependency\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 5:3: text format contains deprecated field \"num_workers\"\nI0502 10:15:31.504611 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.2238e-05 secs\nI0502 10:15:31.504611 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(304): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\nms evaluates to 392,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] DAGNetTest.TestDAGNetTimingControlDependency (398 ms)\n[----------] 5 tests from DAGNetTest (1666 ms total)\n\n[----------] 5 tests from SimpleNetTest\n[ RUN      ] SimpleNetTest.TestSimpleNetTiming\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(115): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\nms evaluates to 392,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTiming (398 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingReadAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(164): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\nms evaluates to 392,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingReadAfterRead (398 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(212): error: The difference between ms and 350 is 21, which exceeds kTimeThreshold, where\nms evaluates to 371,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite (376 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(260): error: The difference between ms and 350 is 28, which exceeds kTimeThreshold, where\nms evaluates to 378,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead (383 ms)\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingControlDependency\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 5:3: text format contains deprecated field \"num_workers\"\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(310): error: The difference between ms and 350 is 43, which exceeds kTimeThreshold, where\nms evaluates to 393,\n350 evaluates to 350, and\nkTimeThreshold evaluates to 20.\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingControlDependency (398 ms)\n[----------] 5 tests from SimpleNetTest (1962 ms total)\n\n[----------] Global test environment tear-down\n[==========] 10 tests from 2 test cases ran. (3629 ms total)\n[  PASSED  ] 2 tests.\n[  FAILED  ] 8 tests, listed below:\n[  FAILED  ] DAGNetTest.TestDAGNetTiming\n[  FAILED  ] DAGNetTest.TestDAGNetTimingWriteAfterRead\n[  FAILED  ] DAGNetTest.TestDAGNetTimingControlDependency\n[  FAILED  ] SimpleNetTest.TestSimpleNetTiming\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingReadAfterRead\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingControlDependency\n\n 8 FAILED TESTS\n\nPS <...erase for privacy...>\\pytorch\\build> .\\bin\\RelWithDebInfo\\timer_test.exe\nRunning main() from gtest_main.cc\n[==========] Running 2 tests from 1 test case.\n[----------] Global test environment set-up.\n[----------] 2 tests from TimerTest\n[ RUN      ] TimerTest.Test\n[       OK ] TimerTest.Test (115 ms)\n[ RUN      ] TimerTest.TestLatency\nAverage nanosecond latency is: 38.775\nAverage microsecond latency is: 0.040485\nAverage millisecond latency is: 4.0208e-05\n[       OK ] TimerTest.TestLatency (3 ms)\n[----------] 2 tests from TimerTest (119 ms total)\n\n[----------] Global test environment tear-down\n[==========] 2 tests from 1 test case ran. (119 ms total)\n[  PASSED  ] 2 tests.\n\nPS <...erase for privacy...>\\pytorch\\build> .\\bin\\RelWithDebInfo\\timer_test.exe\nRunning main() from gtest_main.cc\n[==========] Running 2 tests from 1 test case.\n[----------] Global test environment set-up.\n[----------] 2 tests from TimerTest\n[ RUN      ] TimerTest.Test\n<...erase for privacy...>\\pytorch\\caffe2\\core\\timer_test.cc(26): error: The difference between ns and 100000000 is 15655312, which exceeds 10000000, where\nns evaluates to 115655312,\n100000000 evaluates to 100000000, and\n10000000 evaluates to 10000000.\n<...erase for privacy...>\\pytorch\\caffe2\\core\\timer_test.cc(27): error: The difference between us and 100000 is 15655.3125, which exceeds 10000, where\nus evaluates to 115655.3125,\n100000 evaluates to 100000, and\n10000 evaluates to 10000.\n<...erase for privacy...>\\pytorch\\caffe2\\core\\timer_test.cc(28): error: The difference between ms and 100 is 15.655593872070313, which exceeds 10, where\nms evaluates to 115.65559387207031,\n100 evaluates to 100, and\n10 evaluates to 10.\n[  FAILED  ] TimerTest.Test (126 ms)\n[ RUN      ] TimerTest.TestLatency\nAverage nanosecond latency is: 37.066\nAverage microsecond latency is: 0.036486\nAverage millisecond latency is: 4.0194e-05\n[       OK ] TimerTest.TestLatency (4 ms)\n[----------] 2 tests from TimerTest (131 ms total)\n\n[----------] Global test environment tear-down\n[==========] 2 tests from 1 test case ran. (131 ms total)\n[  PASSED  ] 1 test.\n[  FAILED  ] 1 test, listed below:\n[  FAILED  ] TimerTest.Test\n\n 1 FAILED TEST\n\nI don't think the problem is due to timer itself.\nIt's more likely to be caused by Windows scheduler/time slice configuration.\nOn my machine the timer_test almost always shows 15ms (for ns/us/ms tests) difference when failed.\nSometimes it can also be 21ms or 22ms.\nNOTE that I'm testing with 12-thread idle machine, so no system load related issues.\nSystem Info\n\nPyTorch or Caffe2: Caffe2\nHow you installed PyTorch (conda, pip, source): source\nBuild command you used (if compiling from source): cmake\nOS: Win10\nPyTorch version: master\nCUDA/cuDNN version: 9.1/7.1.3\nGPU models and configuration: 1080Ti\nVisual Studio version (if compiling from source): 2017.6 + v140 toolchain\nCMake version: 3.11.1", "body": "## Issue description\r\n\r\nCaffe2 fails the timer related test on Windows:\r\n* parallel_net_test.exe - This one always fail.\r\n* timer_test.exe - Not always but...good luck...\r\n\r\n```\r\nPS <...erase for privacy...>\\pytorch\\build> .\\bin\\RelWithDebInfo\\parallel_net_test.exe\r\nRunning main() from gtest_main.cc\r\n[==========] Running 10 tests from 2 test cases.\r\n[----------] Global test environment set-up.\r\n[----------] 5 tests from DAGNetTest\r\n[ RUN      ] DAGNetTest.TestDAGNetTiming\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\nWARNING: Logging before InitGoogleLogging() is written to STDERR\r\nI0502 10:15:30.237299 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.8225e-05 secs\r\nI0502 10:15:30.237299 27072 net_dag.cc:46] Number of parallel execution chains 2 Number of operators = 3\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(108): error: The difference between ms and 200 is 21, which exceeds kTimeThreshold, where\r\nms evaluates to 221,\r\n200 evaluates to 200, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] DAGNetTest.TestDAGNetTiming (227 ms)\r\n[ RUN      ] DAGNetTest.TestDAGNetTimingReadAfterRead\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\nI0502 10:15:30.475047 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.9936e-05 secs\r\nI0502 10:15:30.475047 27072 net_dag.cc:46] Number of parallel execution chains 3 Number of operators = 3\r\n[       OK ] DAGNetTest.TestDAGNetTimingReadAfterRead (267 ms)\r\n[ RUN      ] DAGNetTest.TestDAGNetTimingWriteAfterWrite\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\nI0502 10:15:30.736847 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.1098e-05 secs\r\nI0502 10:15:30.736847 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\r\n[       OK ] DAGNetTest.TestDAGNetTimingWriteAfterWrite (368 ms)\r\n[ RUN      ] DAGNetTest.TestDAGNetTimingWriteAfterRead\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\nI0502 10:15:31.104876 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.1953e-05 secs\r\nI0502 10:15:31.104876 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(254): error: The difference between ms and 350 is 43, which exceeds kTimeThreshold, where\r\nms evaluates to 393,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] DAGNetTest.TestDAGNetTimingWriteAfterRead (400 ms)\r\n[ RUN      ] DAGNetTest.TestDAGNetTimingControlDependency\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 5:3: text format contains deprecated field \"num_workers\"\r\nI0502 10:15:31.504611 27072 net_dag_utils.cc:102] Operator graph pruning prior to chain compute took: 2.2238e-05 secs\r\nI0502 10:15:31.504611 27072 net_dag.cc:46] Number of parallel execution chains 1 Number of operators = 3\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(304): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\r\nms evaluates to 392,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] DAGNetTest.TestDAGNetTimingControlDependency (398 ms)\r\n[----------] 5 tests from DAGNetTest (1666 ms total)\r\n\r\n[----------] 5 tests from SimpleNetTest\r\n[ RUN      ] SimpleNetTest.TestSimpleNetTiming\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(115): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\r\nms evaluates to 392,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTiming (398 ms)\r\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingReadAfterRead\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(164): error: The difference between ms and 350 is 42, which exceeds kTimeThreshold, where\r\nms evaluates to 392,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingReadAfterRead (398 ms)\r\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(212): error: The difference between ms and 350 is 21, which exceeds kTimeThreshold, where\r\nms evaluates to 371,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite (376 ms)\r\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 1:50: text format contains deprecated field \"num_workers\"\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(260): error: The difference between ms and 350 is 28, which exceeds kTimeThreshold, where\r\nms evaluates to 378,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead (383 ms)\r\n[ RUN      ] SimpleNetTest.TestSimpleNetTimingControlDependency\r\n[libprotobuf WARNING C:\\Users\\tolia\\AppData\\Local\\Temp\\protobuf\\src\\google\\protobuf\\text_format.cc:305] Warning parsing text-format caffe2.NetDef: 5:3: text format contains deprecated field \"num_workers\"\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\parallel_net_test.cc(310): error: The difference between ms and 350 is 43, which exceeds kTimeThreshold, where\r\nms evaluates to 393,\r\n350 evaluates to 350, and\r\nkTimeThreshold evaluates to 20.\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingControlDependency (398 ms)\r\n[----------] 5 tests from SimpleNetTest (1962 ms total)\r\n\r\n[----------] Global test environment tear-down\r\n[==========] 10 tests from 2 test cases ran. (3629 ms total)\r\n[  PASSED  ] 2 tests.\r\n[  FAILED  ] 8 tests, listed below:\r\n[  FAILED  ] DAGNetTest.TestDAGNetTiming\r\n[  FAILED  ] DAGNetTest.TestDAGNetTimingWriteAfterRead\r\n[  FAILED  ] DAGNetTest.TestDAGNetTimingControlDependency\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTiming\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingReadAfterRead\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterWrite\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingWriteAfterRead\r\n[  FAILED  ] SimpleNetTest.TestSimpleNetTimingControlDependency\r\n\r\n 8 FAILED TESTS\r\n```\r\n\r\n```\r\nPS <...erase for privacy...>\\pytorch\\build> .\\bin\\RelWithDebInfo\\timer_test.exe\r\nRunning main() from gtest_main.cc\r\n[==========] Running 2 tests from 1 test case.\r\n[----------] Global test environment set-up.\r\n[----------] 2 tests from TimerTest\r\n[ RUN      ] TimerTest.Test\r\n[       OK ] TimerTest.Test (115 ms)\r\n[ RUN      ] TimerTest.TestLatency\r\nAverage nanosecond latency is: 38.775\r\nAverage microsecond latency is: 0.040485\r\nAverage millisecond latency is: 4.0208e-05\r\n[       OK ] TimerTest.TestLatency (3 ms)\r\n[----------] 2 tests from TimerTest (119 ms total)\r\n\r\n[----------] Global test environment tear-down\r\n[==========] 2 tests from 1 test case ran. (119 ms total)\r\n[  PASSED  ] 2 tests.\r\n```\r\n\r\n```\r\nPS <...erase for privacy...>\\pytorch\\build> .\\bin\\RelWithDebInfo\\timer_test.exe\r\nRunning main() from gtest_main.cc\r\n[==========] Running 2 tests from 1 test case.\r\n[----------] Global test environment set-up.\r\n[----------] 2 tests from TimerTest\r\n[ RUN      ] TimerTest.Test\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\timer_test.cc(26): error: The difference between ns and 100000000 is 15655312, which exceeds 10000000, where\r\nns evaluates to 115655312,\r\n100000000 evaluates to 100000000, and\r\n10000000 evaluates to 10000000.\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\timer_test.cc(27): error: The difference between us and 100000 is 15655.3125, which exceeds 10000, where\r\nus evaluates to 115655.3125,\r\n100000 evaluates to 100000, and\r\n10000 evaluates to 10000.\r\n<...erase for privacy...>\\pytorch\\caffe2\\core\\timer_test.cc(28): error: The difference between ms and 100 is 15.655593872070313, which exceeds 10, where\r\nms evaluates to 115.65559387207031,\r\n100 evaluates to 100, and\r\n10 evaluates to 10.\r\n[  FAILED  ] TimerTest.Test (126 ms)\r\n[ RUN      ] TimerTest.TestLatency\r\nAverage nanosecond latency is: 37.066\r\nAverage microsecond latency is: 0.036486\r\nAverage millisecond latency is: 4.0194e-05\r\n[       OK ] TimerTest.TestLatency (4 ms)\r\n[----------] 2 tests from TimerTest (131 ms total)\r\n\r\n[----------] Global test environment tear-down\r\n[==========] 2 tests from 1 test case ran. (131 ms total)\r\n[  PASSED  ] 1 test.\r\n[  FAILED  ] 1 test, listed below:\r\n[  FAILED  ] TimerTest.Test\r\n\r\n 1 FAILED TEST\r\n```\r\n\r\nI don't think the problem is due to timer itself.\r\nIt's more likely to be caused by Windows scheduler/time slice configuration.\r\n\r\nOn my machine the timer_test almost always shows 15ms (for ns/us/ms tests) difference when failed.\r\nSometimes it can also be 21ms or 22ms.\r\n\r\nNOTE that I'm testing with 12-thread idle machine, so no system load related issues.\r\n\r\n## System Info\r\n\r\n- PyTorch or Caffe2: Caffe2\r\n- How you installed PyTorch (conda, pip, source): source\r\n- Build command you used (if compiling from source): cmake\r\n- OS: Win10\r\n- PyTorch version: master\r\n- CUDA/cuDNN version: 9.1/7.1.3\r\n- GPU models and configuration: 1080Ti\r\n- Visual Studio version (if compiling from source): 2017.6 + v140 toolchain\r\n- CMake version: 3.11.1\r\n"}