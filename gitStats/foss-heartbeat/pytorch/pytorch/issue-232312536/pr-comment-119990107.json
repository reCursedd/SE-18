{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/119990107", "pull_request_review_id": 41923467, "id": 119990107, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExOTk5MDEwNw==", "diff_hunk": "@@ -188,59 +188,58 @@ THNN_(GRUBackward)(TensorInfo<T, IndexType> input,\n              TensorInfo<T, IndexType> hidden,\n              TensorInfo<T, IndexType> gradoutput,\n              TensorInfo<T, IndexType> gradinput,\n+             TensorInfo<T, IndexType> storage,\n              IndexType hsz,\n              IndexType totalElements)\n {\n   for (IndexType linearIndex = blockIdx.x * blockDim.x + threadIdx.x;\n        linearIndex < totalElements;\n        linearIndex += gridDim.x * blockDim.x) {\n-    IndexType offset = (linearIndex/hsz)*3*hsz+linearIndex%hsz;;\n+    IndexType offset = (linearIndex/hsz)*5*hsz+linearIndex%hsz;\n \n-    //will return input grads here\n-    T* rg = &DEVICE_LINEAR_GET(input, offset+0*hsz);\n-    T* ig = &DEVICE_LINEAR_GET(input, offset+1*hsz);\n-    T* ng = &DEVICE_LINEAR_GET(input, offset+2*hsz);\n-    //will return hidden grads here\n-    T* hx = &DEVICE_LINEAR_GET(hidden, offset+0*hsz);\n-    T* hn = &DEVICE_LINEAR_GET(hidden, offset+1*hsz);\n-    T* oghn=&DEVICE_LINEAR_GET(hidden, offset+2*hsz);\n+    T rg = DEVICE_LINEAR_GET(storage, offset+0*hsz);\n+    T ig = DEVICE_LINEAR_GET(storage, offset+1*hsz);\n+    T ng = DEVICE_LINEAR_GET(storage, offset+2*hsz);\n+    T hx = DEVICE_LINEAR_GET(storage, offset+3*hsz);\n+    T hn = DEVICE_LINEAR_GET(storage, offset+4*hsz);\n \n     T* gi = &DEVICE_LINEAR_GET(gradinput, linearIndex);\n-\n     T go = DEVICE_LINEAR_GET(gradoutput, linearIndex);\n \n+    offset = (linearIndex/hsz)*3*hsz+linearIndex%hsz;\n+\n #ifndef THC_REAL_IS_HALF\n-    T gig = (go)*(*hx-*ng)*( 1-(*ig) )*(*ig);\n-    T ghx = (go)*(*ig);\n-    T gin = (go)*(1-*ig)*( 1-(*ng)*(*ng) );\n-    T ghn = (gin) * (*rg);\n-    T grg = (gin)*(*hn)*( 1-(*rg) )*(*rg);\n+    T gig = go*(hx-ng)*(1-ig)*(ig);\n+    T ghx = go*(ig);\n+    T gin = go*(1-ig)*(1-ng*ng);\n+    T ghn = gin *rg;\n+    T grg = gin*hn*(1-rg)*rg;\n \n-    *gi = ghx;\n+    DEVICE_LINEAR_GET(gradinput, linearIndex) = ghx;\n \n-    *rg = grg;\n-    *ig = gig;\n-    *ng = gin;\n+    DEVICE_LINEAR_GET(input, offset+0*hsz) = grg;\n+    DEVICE_LINEAR_GET(input, offset+1*hsz) = gig;\n+    DEVICE_LINEAR_GET(input, offset+2*hsz) = gin;\n \n-    *hx = grg;\n-    *hn = gig;\n-    *oghn = ghn;\n+    DEVICE_LINEAR_GET(hidden, offset+0*hsz) = grg;\n+    DEVICE_LINEAR_GET(hidden, offset+1*hsz) = gig;\n+    DEVICE_LINEAR_GET(hidden, offset+2*hsz) = ghn;", "path": "torch/lib/THCUNN/generic/FusedRNNKernel.cu", "position": null, "original_position": 162, "commit_id": "05afe622e59f2c1f4184c41229bdcb37d713df62", "original_commit_id": "770314fabd484ff78485e52068d2052c64ad1d60", "user": {"login": "apaszke", "id": 4583066, "node_id": "MDQ6VXNlcjQ1ODMwNjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/4583066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apaszke", "html_url": "https://github.com/apaszke", "followers_url": "https://api.github.com/users/apaszke/followers", "following_url": "https://api.github.com/users/apaszke/following{/other_user}", "gists_url": "https://api.github.com/users/apaszke/gists{/gist_id}", "starred_url": "https://api.github.com/users/apaszke/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apaszke/subscriptions", "organizations_url": "https://api.github.com/users/apaszke/orgs", "repos_url": "https://api.github.com/users/apaszke/repos", "events_url": "https://api.github.com/users/apaszke/events{/privacy}", "received_events_url": "https://api.github.com/users/apaszke/received_events", "type": "User", "site_admin": false}, "body": "Yeah it would be helpful", "created_at": "2017-06-03T16:45:13Z", "updated_at": "2018-11-23T15:33:39Z", "html_url": "https://github.com/pytorch/pytorch/pull/1683#discussion_r119990107", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/1683", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/119990107"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/1683#discussion_r119990107"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/1683"}}, "body_html": "<p>Yeah it would be helpful</p>", "body_text": "Yeah it would be helpful", "in_reply_to_id": 119954706}