{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/224973807", "pull_request_review_id": 164478525, "id": 224973807, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNDk3MzgwNw==", "diff_hunk": "@@ -274,16 +270,27 @@ def declkey(decl):\n                 ])\n                 decl['has_tensor_options'] = True\n \n-    jit_decls = sort_decls(jit_decls)\n-    for decl in jit_decls:\n-        ops.append(OPERATOR.substitute(signature=signature(decl),\n-                                       op=emit_decl_variant(decl)))\n-\n-    # Sort the generated snippets to ensure that the generation is deterministic\n-    env = {\n-        'constructors': ops,\n-    }\n-    write(out, 'register_aten_ops.cpp', REGISTER_ATEN_OPS_CPP, env)\n+    # Group and sort the generated snippets to ensure that the\n+    # generation is deterministic\n+    jit_decl_groups = sort_decls(jit_decls)\n+\n+    # NOTE: see the comment at the top of the register_aten_ops.cpp\n+    # template regarding sharding of the generated files.\n+    num_shards = 3\n+    shards = [[] for _ in range(num_shards)]\n+\n+    # ops are assigned arbitrarily but stably to a file based on hash\n+    for group in jit_decl_groups:\n+        x = sum(ord(c) for c in group[0]['name']) % num_shards", "path": "tools/jit/gen_jit_dispatch.py", "position": 42, "original_position": 38, "commit_id": "05b09de249370f8785d4623dfc27d5d16158467d", "original_commit_id": "db57af7bb99f7c96e39500e5857aab04310623ba", "user": {"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, "body": "@zdevito, I know you suggested this sharding strategy, but wouldn't it be better to use an actual hash function here? Like, it's not like Python makes it hard to do so. (I agree that this particular use site doesn't matter how we do it; it's more of a \"is this code going to get copy pasted\" concern)", "created_at": "2018-10-13T22:31:50Z", "updated_at": "2018-11-23T15:52:58Z", "html_url": "https://github.com/pytorch/pytorch/pull/12615#discussion_r224973807", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/12615", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/224973807"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/12615#discussion_r224973807"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/12615"}}, "body_html": "<p><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/hovercards?user_id=370202\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/zdevito\">@zdevito</a>, I know you suggested this sharding strategy, but wouldn't it be better to use an actual hash function here? Like, it's not like Python makes it hard to do so. (I agree that this particular use site doesn't matter how we do it; it's more of a \"is this code going to get copy pasted\" concern)</p>", "body_text": "@zdevito, I know you suggested this sharding strategy, but wouldn't it be better to use an actual hash function here? Like, it's not like Python makes it hard to do so. (I agree that this particular use site doesn't matter how we do it; it's more of a \"is this code going to get copy pasted\" concern)"}