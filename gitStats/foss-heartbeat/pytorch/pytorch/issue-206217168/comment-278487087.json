{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/278487087", "html_url": "https://github.com/pytorch/pytorch/issues/700#issuecomment-278487087", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/700", "id": 278487087, "node_id": "MDEyOklzc3VlQ29tbWVudDI3ODQ4NzA4Nw==", "user": {"login": "apaszke", "id": 4583066, "node_id": "MDQ6VXNlcjQ1ODMwNjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/4583066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apaszke", "html_url": "https://github.com/apaszke", "followers_url": "https://api.github.com/users/apaszke/followers", "following_url": "https://api.github.com/users/apaszke/following{/other_user}", "gists_url": "https://api.github.com/users/apaszke/gists{/gist_id}", "starred_url": "https://api.github.com/users/apaszke/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apaszke/subscriptions", "organizations_url": "https://api.github.com/users/apaszke/orgs", "repos_url": "https://api.github.com/users/apaszke/repos", "events_url": "https://api.github.com/users/apaszke/events{/privacy}", "received_events_url": "https://api.github.com/users/apaszke/received_events", "type": "User", "site_admin": false}, "created_at": "2017-02-08T22:45:08Z", "updated_at": "2017-02-08T22:45:08Z", "author_association": "MEMBER", "body_html": "<p>Ok, so the problem is that our CPU code for <code>sum</code> appears to have significant cache problems, and this slows down backward of <code>expand</code> a lot. On GPU, the whole network finishes forward in 0.28s and backward in 0.17s for me. We'll have to fix that, thanks for pointing it out.</p>\n<p>A fix for now would be to replace</p>\n<div class=\"highlight highlight-source-python\"><pre>th.bmm(weights.expand(<span class=\"pl-c1\">...</span>), <span class=\"pl-c1\">input</span>)</pre></div>\n<p>with</p>\n<div class=\"highlight highlight-source-python\"><pre>th.stack([weight.mm(i) <span class=\"pl-k\">for</span> i <span class=\"pl-k\">in</span> <span class=\"pl-c1\">input</span>], <span class=\"pl-c1\">0</span>)</pre></div>\n<p>where weights should be 2d now.</p>", "body_text": "Ok, so the problem is that our CPU code for sum appears to have significant cache problems, and this slows down backward of expand a lot. On GPU, the whole network finishes forward in 0.28s and backward in 0.17s for me. We'll have to fix that, thanks for pointing it out.\nA fix for now would be to replace\nth.bmm(weights.expand(...), input)\nwith\nth.stack([weight.mm(i) for i in input], 0)\nwhere weights should be 2d now.", "body": "Ok, so the problem is that our CPU code for `sum` appears to have significant cache problems, and this slows down backward of `expand` a lot. On GPU, the whole network finishes forward in 0.28s and backward in 0.17s for me. We'll have to fix that, thanks for pointing it out.\r\n\r\nA fix for now would be to replace\r\n```python\r\nth.bmm(weights.expand(...), input)\r\n```\r\nwith\r\n```python\r\nth.stack([weight.mm(i) for i in input], 0)\r\n```\r\nwhere weights should be 2d now.\r\n"}