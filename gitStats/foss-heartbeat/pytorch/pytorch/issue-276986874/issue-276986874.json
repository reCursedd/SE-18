{"url": "https://api.github.com/repos/pytorch/pytorch/issues/3898", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/3898/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/3898/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/3898/events", "html_url": "https://github.com/pytorch/pytorch/issues/3898", "id": 276986874, "node_id": "MDU6SXNzdWUyNzY5ODY4NzQ=", "number": 3898, "title": "Sparse matrices in dataloader error", "user": {"login": "latkins", "id": 1080217, "node_id": "MDQ6VXNlcjEwODAyMTc=", "avatar_url": "https://avatars3.githubusercontent.com/u/1080217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/latkins", "html_url": "https://github.com/latkins", "followers_url": "https://api.github.com/users/latkins/followers", "following_url": "https://api.github.com/users/latkins/following{/other_user}", "gists_url": "https://api.github.com/users/latkins/gists{/gist_id}", "starred_url": "https://api.github.com/users/latkins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/latkins/subscriptions", "organizations_url": "https://api.github.com/users/latkins/orgs", "repos_url": "https://api.github.com/users/latkins/repos", "events_url": "https://api.github.com/users/latkins/events{/privacy}", "received_events_url": "https://api.github.com/users/latkins/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 679954154, "node_id": "MDU6TGFiZWw2Nzk5NTQxNTQ=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/sparse", "name": "sparse", "color": "bfd4f2", "default": false}], "state": "open", "locked": false, "assignee": {"login": "zou3519", "id": 5652049, "node_id": "MDQ6VXNlcjU2NTIwNDk=", "avatar_url": "https://avatars3.githubusercontent.com/u/5652049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zou3519", "html_url": "https://github.com/zou3519", "followers_url": "https://api.github.com/users/zou3519/followers", "following_url": "https://api.github.com/users/zou3519/following{/other_user}", "gists_url": "https://api.github.com/users/zou3519/gists{/gist_id}", "starred_url": "https://api.github.com/users/zou3519/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zou3519/subscriptions", "organizations_url": "https://api.github.com/users/zou3519/orgs", "repos_url": "https://api.github.com/users/zou3519/repos", "events_url": "https://api.github.com/users/zou3519/events{/privacy}", "received_events_url": "https://api.github.com/users/zou3519/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "zou3519", "id": 5652049, "node_id": "MDQ6VXNlcjU2NTIwNDk=", "avatar_url": "https://avatars3.githubusercontent.com/u/5652049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zou3519", "html_url": "https://github.com/zou3519", "followers_url": "https://api.github.com/users/zou3519/followers", "following_url": "https://api.github.com/users/zou3519/following{/other_user}", "gists_url": "https://api.github.com/users/zou3519/gists{/gist_id}", "starred_url": "https://api.github.com/users/zou3519/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zou3519/subscriptions", "organizations_url": "https://api.github.com/users/zou3519/orgs", "repos_url": "https://api.github.com/users/zou3519/repos", "events_url": "https://api.github.com/users/zou3519/events{/privacy}", "received_events_url": "https://api.github.com/users/zou3519/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 9, "created_at": "2017-11-27T11:32:13Z", "updated_at": "2018-09-12T21:14:45Z", "closed_at": null, "author_association": "NONE", "body_html": "<p>I have noticed that using sparse matrices with a DataLoader works only if num_processes = 0.</p>\n<p>Example:</p>\n<pre><code>import torch\nfrom torch.utils.data import DataLoader\n\nprint('torch version: ', torch.__version__)\n\ni = torch.LongTensor([[0, 1, 1], [2, 0, 2]])\nv = torch.FloatTensor([3, 4, 5])\nsparse_tensor = torch.sparse.FloatTensor(i, v, torch.Size([2, 3]))\n\ndataset_sp = 2 * [sparse_tensor]\n\n\ndef collate_fn(batch):\n    return batch[0]\n\n\nloader = DataLoader(dataset_sp, batch_size=1, collate_fn=collate_fn)\n\nprint('num_workers=0: ')\nfor i, b in enumerate(loader):\n    print(i, b.size())\n\nloader = DataLoader(dataset_sp, batch_size=1, collate_fn=collate_fn, num_workers=1)\n\nprint('num_workers=1: ')\nfor i, b in enumerate(loader):\n    print(i, b.size())\n</code></pre>\n<p>Gives the result:</p>\n<pre><code>torch version:  0.2.0+5989b05\nnum_workers=0:\n0 torch.Size([2, 3])\n1 torch.Size([2, 3])\nnum_workers=1:\nProcess Process-1:\nTraceback (most recent call last):\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/process.py\", line 249, in _bootstrap\n    self.run()\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/process.py\", line 93, in run\n    self._target(*self._args, **self._kwargs)\n  File \"/Users/liam/anaconda/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 45, in _worker_loop\n    data_queue.put((idx, samples))\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/queues.py\", line 348, in put\n    obj = _ForkingPickler.dumps(obj)\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/reduction.py\", line 51, in dumps\n    cls(buf, protocol).dump(obj)\n  File \"/Users/liam/anaconda/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 46, in reduce_tensor\n    metadata = (tensor.storage_offset(), tensor.size(), tensor.stride())\nAttributeError: 'torch.sparse.FloatTensor' object has no attribute 'storage_offset'\n</code></pre>", "body_text": "I have noticed that using sparse matrices with a DataLoader works only if num_processes = 0.\nExample:\nimport torch\nfrom torch.utils.data import DataLoader\n\nprint('torch version: ', torch.__version__)\n\ni = torch.LongTensor([[0, 1, 1], [2, 0, 2]])\nv = torch.FloatTensor([3, 4, 5])\nsparse_tensor = torch.sparse.FloatTensor(i, v, torch.Size([2, 3]))\n\ndataset_sp = 2 * [sparse_tensor]\n\n\ndef collate_fn(batch):\n    return batch[0]\n\n\nloader = DataLoader(dataset_sp, batch_size=1, collate_fn=collate_fn)\n\nprint('num_workers=0: ')\nfor i, b in enumerate(loader):\n    print(i, b.size())\n\nloader = DataLoader(dataset_sp, batch_size=1, collate_fn=collate_fn, num_workers=1)\n\nprint('num_workers=1: ')\nfor i, b in enumerate(loader):\n    print(i, b.size())\n\nGives the result:\ntorch version:  0.2.0+5989b05\nnum_workers=0:\n0 torch.Size([2, 3])\n1 torch.Size([2, 3])\nnum_workers=1:\nProcess Process-1:\nTraceback (most recent call last):\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/process.py\", line 249, in _bootstrap\n    self.run()\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/process.py\", line 93, in run\n    self._target(*self._args, **self._kwargs)\n  File \"/Users/liam/anaconda/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 45, in _worker_loop\n    data_queue.put((idx, samples))\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/queues.py\", line 348, in put\n    obj = _ForkingPickler.dumps(obj)\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/reduction.py\", line 51, in dumps\n    cls(buf, protocol).dump(obj)\n  File \"/Users/liam/anaconda/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 46, in reduce_tensor\n    metadata = (tensor.storage_offset(), tensor.size(), tensor.stride())\nAttributeError: 'torch.sparse.FloatTensor' object has no attribute 'storage_offset'", "body": "I have noticed that using sparse matrices with a DataLoader works only if num_processes = 0.\r\n\r\nExample:\r\n\r\n```\r\nimport torch\r\nfrom torch.utils.data import DataLoader\r\n\r\nprint('torch version: ', torch.__version__)\r\n\r\ni = torch.LongTensor([[0, 1, 1], [2, 0, 2]])\r\nv = torch.FloatTensor([3, 4, 5])\r\nsparse_tensor = torch.sparse.FloatTensor(i, v, torch.Size([2, 3]))\r\n\r\ndataset_sp = 2 * [sparse_tensor]\r\n\r\n\r\ndef collate_fn(batch):\r\n    return batch[0]\r\n\r\n\r\nloader = DataLoader(dataset_sp, batch_size=1, collate_fn=collate_fn)\r\n\r\nprint('num_workers=0: ')\r\nfor i, b in enumerate(loader):\r\n    print(i, b.size())\r\n\r\nloader = DataLoader(dataset_sp, batch_size=1, collate_fn=collate_fn, num_workers=1)\r\n\r\nprint('num_workers=1: ')\r\nfor i, b in enumerate(loader):\r\n    print(i, b.size())\r\n```\r\n\r\nGives the result:\r\n\r\n```\r\ntorch version:  0.2.0+5989b05\r\nnum_workers=0:\r\n0 torch.Size([2, 3])\r\n1 torch.Size([2, 3])\r\nnum_workers=1:\r\nProcess Process-1:\r\nTraceback (most recent call last):\r\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/process.py\", line 249, in _bootstrap\r\n    self.run()\r\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/process.py\", line 93, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/Users/liam/anaconda/lib/python3.6/site-packages/torch/utils/data/dataloader.py\", line 45, in _worker_loop\r\n    data_queue.put((idx, samples))\r\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/queues.py\", line 348, in put\r\n    obj = _ForkingPickler.dumps(obj)\r\n  File \"/Users/liam/anaconda/lib/python3.6/multiprocessing/reduction.py\", line 51, in dumps\r\n    cls(buf, protocol).dump(obj)\r\n  File \"/Users/liam/anaconda/lib/python3.6/site-packages/torch/multiprocessing/reductions.py\", line 46, in reduce_tensor\r\n    metadata = (tensor.storage_offset(), tensor.size(), tensor.stride())\r\nAttributeError: 'torch.sparse.FloatTensor' object has no attribute 'storage_offset'\r\n```"}