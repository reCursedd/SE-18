{"url": "https://api.github.com/repos/pytorch/pytorch/issues/11555", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/11555/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/11555/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/11555/events", "html_url": "https://github.com/pytorch/pytorch/issues/11555", "id": 359258487, "node_id": "MDU6SXNzdWUzNTkyNTg0ODc=", "number": 11555, "title": "[jit] Support tracing of Tensor.masked_fill_()", "user": {"login": "fritzo", "id": 648532, "node_id": "MDQ6VXNlcjY0ODUzMg==", "avatar_url": "https://avatars0.githubusercontent.com/u/648532?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fritzo", "html_url": "https://github.com/fritzo", "followers_url": "https://api.github.com/users/fritzo/followers", "following_url": "https://api.github.com/users/fritzo/following{/other_user}", "gists_url": "https://api.github.com/users/fritzo/gists{/gist_id}", "starred_url": "https://api.github.com/users/fritzo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fritzo/subscriptions", "organizations_url": "https://api.github.com/users/fritzo/orgs", "repos_url": "https://api.github.com/users/fritzo/repos", "events_url": "https://api.github.com/users/fritzo/events{/privacy}", "received_events_url": "https://api.github.com/users/fritzo/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 679953983, "node_id": "MDU6TGFiZWw2Nzk5NTM5ODM=", "url": "https://api.github.com/repos/pytorch/pytorch/labels/jit", "name": "jit", "color": "c5def5", "default": false}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-09-11T23:19:12Z", "updated_at": "2018-09-12T00:58:18Z", "closed_at": null, "author_association": "CONTRIBUTOR", "body_html": "<h2>Issue description</h2>\n<p>Pyro uses <code>torch.Tensor.masked_fill_()</code> as a cheap way to mask out tensors that may be filled with NANs (i.e. where multiplication would not work). Would it be possible to support <code>.masked_fill_()</code> in the PyTorch jit?</p>\n<h2>Code example</h2>\n<p>The following code fails:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">def</span> <span class=\"pl-en\">test_masked_fill</span>():\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">f</span>(<span class=\"pl-smi\">y</span>, <span class=\"pl-smi\">mask</span>):\n        <span class=\"pl-k\">return</span> y.clone().masked_fill_(mask, <span class=\"pl-c1\">0</span>.)\n\n    x <span class=\"pl-k\">=</span> torch.tensor([<span class=\"pl-k\">-</span><span class=\"pl-c1\">float</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>inf<span class=\"pl-pds\">'</span></span>), <span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>., <span class=\"pl-c1\">0</span>., <span class=\"pl-c1\">1</span>., <span class=\"pl-c1\">float</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>inf<span class=\"pl-pds\">'</span></span>)])\n    y <span class=\"pl-k\">=</span> x <span class=\"pl-k\">/</span> x.unsqueeze(<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>)\n    mask <span class=\"pl-k\">=</span> <span class=\"pl-k\">~</span>(y <span class=\"pl-k\">==</span> y)\n    f <span class=\"pl-k\">=</span> torch.jit.trace(f, (y, mask))</pre></div>\n<details>\n<pre><code>mod = f()\ninputs = (tensor([[    nan,  0.0000, -0.0000, -0.0000,     nan],\n        [    inf,  1.00...000,  1.0000,     inf],\n        [   ...       [0, 0, 0, 0, 0],\n        [0, 0, 1, 0, 0],\n        [0, 0, 0, 0, 0],\n        [1, 0, 0, 0, 1]], dtype=torch.uint8))\nrunning_what = 'trace'\n\n    def run_mod_and_filter_tensor_outputs(mod, inputs, running_what):\n        try:\n            outs = wrap_retval(mod(*_clone_inputs(inputs)))\n            outs = [out for out in outs if isinstance(out, torch.Tensor)]\n            return outs\n        except Exception as e:\n            raise TracingCheckError(*graph_diagnostic_info(),\n                                    extra_msg='Encountered an exception while running the ' + running_what +\n&gt;                                             ' with test inputs.\\nException:\\n' + indent(str(e)))\nE           TracingCheckError: Tracing failed sanity checks!\nE           Encountered an exception while running the trace with test inputs.\nE           Exception:\nE\nE\nE           \tSchema not found for node. File a bug report.\nE           \tNode: %4 : Dynamic = aten::masked_fill(%2, %1, %3)\nE\nE           \tInput types:Double(*, *), Byte(*, *), float\nE           \tcandidates were:\nE           \t:\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(126): f\nE           \t/Users/fritzobermeyer/pytorch-dev/torch/jit/__init__.py(501): trace\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(131): test_masked_fill\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(196): pytest_pyfunc_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(1431): runtest\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(111): pytest_runtest_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(183): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(201): __init__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(185): call_runtest_hook\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(161): call_and_report\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(81): runtestprotocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(66): pytest_runtest_protocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(236): pytest_runtestloop\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(215): _main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(178): wrap_session\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(208): pytest_cmdline_main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/config/__init__.py(64): main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/bin/pytest(11): &lt;module&gt;\nE           \t:\nE           \toperation failed shape propagation:\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(126): f\nE           \t/Users/fritzobermeyer/pytorch-dev/torch/jit/__init__.py(501): trace\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(131): test_masked_fill\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(196): pytest_pyfunc_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(1431): runtest\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(111): pytest_runtest_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(183): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(201): __init__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(185): call_runtest_hook\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(161): call_and_report\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(81): runtestprotocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(66): pytest_runtest_protocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(236): pytest_runtestloop\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(215): _main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(178): wrap_session\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(208): pytest_cmdline_main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): &lt;lambda&gt;\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/config/__init__.py(64): main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/bin/pytest(11): &lt;module&gt;\n\n../../../pytorch-dev/torch/jit/__init__.py:379: TracingCheckError\n</code></pre>\n</details>\n<p>The following workaround is compatible with the JIT, but is much slower than <code>.masked_fill_()</code>:</p>\n<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">def</span> <span class=\"pl-en\">test_masked_fill_workaround</span>():\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">f</span>(<span class=\"pl-smi\">y</span>, <span class=\"pl-smi\">mask</span>):\n        y <span class=\"pl-k\">=</span> y.clone()\n        y[mask] <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>.\n        <span class=\"pl-k\">return</span> y\n\n    x <span class=\"pl-k\">=</span> torch.tensor([<span class=\"pl-k\">-</span><span class=\"pl-c1\">float</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>inf<span class=\"pl-pds\">'</span></span>), <span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>., <span class=\"pl-c1\">0</span>., <span class=\"pl-c1\">1</span>., <span class=\"pl-c1\">float</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>inf<span class=\"pl-pds\">'</span></span>)])\n    y <span class=\"pl-k\">=</span> x <span class=\"pl-k\">/</span> x.unsqueeze(<span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>)\n    mask <span class=\"pl-k\">=</span> <span class=\"pl-k\">~</span>(y <span class=\"pl-k\">==</span> y)\n    f <span class=\"pl-k\">=</span> torch.jit.trace(f, (y, mask))</pre></div>\n<p>EDIT It appears the workaround is using <code>indexed_put_</code>, which seems incorrect.</p>\n<h2>System Info</h2>\n<pre><code>$ python collect_env.py\nCollecting environment information...\nPyTorch version: 0.5.0a0+f80f158\nIs debug build: No\nCUDA used to build PyTorch: None\n\nOS: Mac OSX 10.13.3\nGCC version: Could not collect\nCMake version: version 3.12.0\n\nPython version: 2.7\nIs CUDA available: No\nCUDA runtime version: No CUDA\nGPU models and configuration: No CUDA\nNvidia driver version: No CUDA\ncuDNN version: No CUDA\n\nVersions of relevant libraries:\n[pip] Could not collect\n[conda] torchfile                 0.1.0                     &lt;pip&gt;\n[conda] torchvision               0.2.0                     &lt;pip&gt;\n</code></pre>", "body_text": "Issue description\nPyro uses torch.Tensor.masked_fill_() as a cheap way to mask out tensors that may be filled with NANs (i.e. where multiplication would not work). Would it be possible to support .masked_fill_() in the PyTorch jit?\nCode example\nThe following code fails:\ndef test_masked_fill():\n\n    def f(y, mask):\n        return y.clone().masked_fill_(mask, 0.)\n\n    x = torch.tensor([-float('inf'), -1., 0., 1., float('inf')])\n    y = x / x.unsqueeze(-1)\n    mask = ~(y == y)\n    f = torch.jit.trace(f, (y, mask))\n\nmod = f()\ninputs = (tensor([[    nan,  0.0000, -0.0000, -0.0000,     nan],\n        [    inf,  1.00...000,  1.0000,     inf],\n        [   ...       [0, 0, 0, 0, 0],\n        [0, 0, 1, 0, 0],\n        [0, 0, 0, 0, 0],\n        [1, 0, 0, 0, 1]], dtype=torch.uint8))\nrunning_what = 'trace'\n\n    def run_mod_and_filter_tensor_outputs(mod, inputs, running_what):\n        try:\n            outs = wrap_retval(mod(*_clone_inputs(inputs)))\n            outs = [out for out in outs if isinstance(out, torch.Tensor)]\n            return outs\n        except Exception as e:\n            raise TracingCheckError(*graph_diagnostic_info(),\n                                    extra_msg='Encountered an exception while running the ' + running_what +\n>                                             ' with test inputs.\\nException:\\n' + indent(str(e)))\nE           TracingCheckError: Tracing failed sanity checks!\nE           Encountered an exception while running the trace with test inputs.\nE           Exception:\nE\nE\nE           \tSchema not found for node. File a bug report.\nE           \tNode: %4 : Dynamic = aten::masked_fill(%2, %1, %3)\nE\nE           \tInput types:Double(*, *), Byte(*, *), float\nE           \tcandidates were:\nE           \t:\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(126): f\nE           \t/Users/fritzobermeyer/pytorch-dev/torch/jit/__init__.py(501): trace\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(131): test_masked_fill\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(196): pytest_pyfunc_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(1431): runtest\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(111): pytest_runtest_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(183): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(201): __init__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(185): call_runtest_hook\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(161): call_and_report\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(81): runtestprotocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(66): pytest_runtest_protocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(236): pytest_runtestloop\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(215): _main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(178): wrap_session\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(208): pytest_cmdline_main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/config/__init__.py(64): main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/bin/pytest(11): <module>\nE           \t:\nE           \toperation failed shape propagation:\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(126): f\nE           \t/Users/fritzobermeyer/pytorch-dev/torch/jit/__init__.py(501): trace\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(131): test_masked_fill\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(196): pytest_pyfunc_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(1431): runtest\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(111): pytest_runtest_call\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(183): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(201): __init__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(185): call_runtest_hook\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(161): call_and_report\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(81): runtestprotocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(66): pytest_runtest_protocol\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(236): pytest_runtestloop\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(215): _main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(178): wrap_session\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(208): pytest_cmdline_main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/config/__init__.py(64): main\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/bin/pytest(11): <module>\n\n../../../pytorch-dev/torch/jit/__init__.py:379: TracingCheckError\n\n\nThe following workaround is compatible with the JIT, but is much slower than .masked_fill_():\ndef test_masked_fill_workaround():\n\n    def f(y, mask):\n        y = y.clone()\n        y[mask] = 0.\n        return y\n\n    x = torch.tensor([-float('inf'), -1., 0., 1., float('inf')])\n    y = x / x.unsqueeze(-1)\n    mask = ~(y == y)\n    f = torch.jit.trace(f, (y, mask))\nEDIT It appears the workaround is using indexed_put_, which seems incorrect.\nSystem Info\n$ python collect_env.py\nCollecting environment information...\nPyTorch version: 0.5.0a0+f80f158\nIs debug build: No\nCUDA used to build PyTorch: None\n\nOS: Mac OSX 10.13.3\nGCC version: Could not collect\nCMake version: version 3.12.0\n\nPython version: 2.7\nIs CUDA available: No\nCUDA runtime version: No CUDA\nGPU models and configuration: No CUDA\nNvidia driver version: No CUDA\ncuDNN version: No CUDA\n\nVersions of relevant libraries:\n[pip] Could not collect\n[conda] torchfile                 0.1.0                     <pip>\n[conda] torchvision               0.2.0                     <pip>", "body": "## Issue description\r\n\r\nPyro uses `torch.Tensor.masked_fill_()` as a cheap way to mask out tensors that may be filled with NANs (i.e. where multiplication would not work). Would it be possible to support `.masked_fill_()` in the PyTorch jit?\r\n\r\n## Code example\r\n\r\nThe following code fails:\r\n```py\r\ndef test_masked_fill():\r\n\r\n    def f(y, mask):\r\n        return y.clone().masked_fill_(mask, 0.)\r\n\r\n    x = torch.tensor([-float('inf'), -1., 0., 1., float('inf')])\r\n    y = x / x.unsqueeze(-1)\r\n    mask = ~(y == y)\r\n    f = torch.jit.trace(f, (y, mask))\r\n```\r\n\r\n<details>\r\n\r\n```\r\nmod = f()\r\ninputs = (tensor([[    nan,  0.0000, -0.0000, -0.0000,     nan],\r\n        [    inf,  1.00...000,  1.0000,     inf],\r\n        [   ...       [0, 0, 0, 0, 0],\r\n        [0, 0, 1, 0, 0],\r\n        [0, 0, 0, 0, 0],\r\n        [1, 0, 0, 0, 1]], dtype=torch.uint8))\r\nrunning_what = 'trace'\r\n\r\n    def run_mod_and_filter_tensor_outputs(mod, inputs, running_what):\r\n        try:\r\n            outs = wrap_retval(mod(*_clone_inputs(inputs)))\r\n            outs = [out for out in outs if isinstance(out, torch.Tensor)]\r\n            return outs\r\n        except Exception as e:\r\n            raise TracingCheckError(*graph_diagnostic_info(),\r\n                                    extra_msg='Encountered an exception while running the ' + running_what +\r\n>                                             ' with test inputs.\\nException:\\n' + indent(str(e)))\r\nE           TracingCheckError: Tracing failed sanity checks!\r\nE           Encountered an exception while running the trace with test inputs.\r\nE           Exception:\r\nE\r\nE\r\nE           \tSchema not found for node. File a bug report.\r\nE           \tNode: %4 : Dynamic = aten::masked_fill(%2, %1, %3)\r\nE\r\nE           \tInput types:Double(*, *), Byte(*, *), float\r\nE           \tcandidates were:\r\nE           \t:\r\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(126): f\r\nE           \t/Users/fritzobermeyer/pytorch-dev/torch/jit/__init__.py(501): trace\r\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(131): test_masked_fill\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(196): pytest_pyfunc_call\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(1431): runtest\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(111): pytest_runtest_call\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(183): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(201): __init__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(185): call_runtest_hook\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(161): call_and_report\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(81): runtestprotocol\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(66): pytest_runtest_protocol\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(236): pytest_runtestloop\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(215): _main\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(178): wrap_session\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(208): pytest_cmdline_main\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/config/__init__.py(64): main\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/bin/pytest(11): <module>\r\nE           \t:\r\nE           \toperation failed shape propagation:\r\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(126): f\r\nE           \t/Users/fritzobermeyer/pytorch-dev/torch/jit/__init__.py(501): trace\r\nE           \t/Users/fritzobermeyer/github/uber/pyro/tests/infer/test_jit.py(131): test_masked_fill\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(196): pytest_pyfunc_call\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/python.py(1431): runtest\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(111): pytest_runtest_call\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(183): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(201): __init__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(185): call_runtest_hook\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(161): call_and_report\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(81): runtestprotocol\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/runner.py(66): pytest_runtest_protocol\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(236): pytest_runtestloop\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(215): _main\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(178): wrap_session\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/main.py(208): pytest_cmdline_main\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/callers.py(180): _multicall\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(61): <lambda>\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/manager.py(67): _hookexec\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/pluggy/hooks.py(258): __call__\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/lib/python2.7/site-packages/_pytest/config/__init__.py(64): main\r\nE           \t/Users/fritzobermeyer/miniconda2/envs/pytorch-dev/bin/pytest(11): <module>\r\n\r\n../../../pytorch-dev/torch/jit/__init__.py:379: TracingCheckError\r\n```\r\n\r\n</details>\r\n\r\nThe following workaround is compatible with the JIT, but is much slower than `.masked_fill_()`:\r\n```py\r\ndef test_masked_fill_workaround():\r\n\r\n    def f(y, mask):\r\n        y = y.clone()\r\n        y[mask] = 0.\r\n        return y\r\n\r\n    x = torch.tensor([-float('inf'), -1., 0., 1., float('inf')])\r\n    y = x / x.unsqueeze(-1)\r\n    mask = ~(y == y)\r\n    f = torch.jit.trace(f, (y, mask))\r\n```\r\nEDIT It appears the workaround is using `indexed_put_`, which seems incorrect.\r\n\r\n## System Info\r\n```\r\n$ python collect_env.py\r\nCollecting environment information...\r\nPyTorch version: 0.5.0a0+f80f158\r\nIs debug build: No\r\nCUDA used to build PyTorch: None\r\n\r\nOS: Mac OSX 10.13.3\r\nGCC version: Could not collect\r\nCMake version: version 3.12.0\r\n\r\nPython version: 2.7\r\nIs CUDA available: No\r\nCUDA runtime version: No CUDA\r\nGPU models and configuration: No CUDA\r\nNvidia driver version: No CUDA\r\ncuDNN version: No CUDA\r\n\r\nVersions of relevant libraries:\r\n[pip] Could not collect\r\n[conda] torchfile                 0.1.0                     <pip>\r\n[conda] torchvision               0.2.0                     <pip>\r\n```"}