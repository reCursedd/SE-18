{"url": "https://api.github.com/repos/pytorch/pytorch/issues/14317", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/14317/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/14317/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/14317/events", "html_url": "https://github.com/pytorch/pytorch/issues/14317", "id": 383486569, "node_id": "MDU6SXNzdWUzODM0ODY1Njk=", "number": 14317, "title": "[Caffe2] Caffe2 built with protobuf-lite still require full protobuf library", "user": {"login": "h6197627", "id": 44726212, "node_id": "MDQ6VXNlcjQ0NzI2MjEy", "avatar_url": "https://avatars1.githubusercontent.com/u/44726212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/h6197627", "html_url": "https://github.com/h6197627", "followers_url": "https://api.github.com/users/h6197627/followers", "following_url": "https://api.github.com/users/h6197627/following{/other_user}", "gists_url": "https://api.github.com/users/h6197627/gists{/gist_id}", "starred_url": "https://api.github.com/users/h6197627/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/h6197627/subscriptions", "organizations_url": "https://api.github.com/users/h6197627/orgs", "repos_url": "https://api.github.com/users/h6197627/repos", "events_url": "https://api.github.com/users/h6197627/events{/privacy}", "received_events_url": "https://api.github.com/users/h6197627/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-11-22T11:07:28Z", "updated_at": "2018-11-22T11:07:28Z", "closed_at": null, "author_association": "NONE", "body_html": "<h2><g-emoji class=\"g-emoji\" alias=\"bug\" fallback-src=\"https://assets-cdn.github.com/images/icons/emoji/unicode/1f41b.png\">\ud83d\udc1b</g-emoji> Bug</h2>\n<p>After fixing <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"381680225\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/pytorch/pytorch/issues/14102\" data-hovercard-type=\"issue\" data-hovercard-url=\"/pytorch/pytorch/issues/14102/hovercard\" href=\"https://github.com/pytorch/pytorch/issues/14102\">#14102</a> issue it is possible to build static Caffe2 library with protobuf-lite now. However when built static caffe2 libraries are linked to user application full protobuf library is still required to be passed. It seems that despite libcaffe2.a library correctly linked with protobuf-lite, libcaffe2_protos.a library still needs full protobuf library. This behavior can be seen at least in Android ARM builds with build_android.sh script (with USE_LITE_PROTO=ON ONNX_USE_LITE_PROTO=ON cmake flags added).<br>\nAlso while building shared version of Caffe2 for Android ARM I noticed that passing USE_LITE_PROTO, ONNX_USE_LITE_PROTO cmake flags has no impact on the final library size (I guess it is due to the fact that full protobuf library is still linked to final libcaffe2.so library)</p>\n<p>Another small bug - libcaffe2_protos.a library is not included in install targets and running <strong>make install</strong> do not copy this library into install directory, however it is required by libcaffe2.a.</p>\n<h2>To Reproduce</h2>\n<p>Steps to reproduce the behavior:</p>\n<blockquote>\n<p>mkdir build &amp;&amp; cd build<br>\ncmake -D USE_LITE_PROTO=ON -D ONNX_USE_LITE_PROTO=ON ..<br>\nmake -j12</p>\n</blockquote>\n<h2>Expected behavior</h2>\n<p>Built static caffe2 library that do not require full protobuf.</p>\n<h2>Environment</h2>\n<ul>\n<li>PyTorch Version (e.g., 1.0): master</li>\n<li>OS (e.g., Linux): Android</li>\n<li>How you installed PyTorch (<code>conda</code>, <code>pip</code>, source): source</li>\n</ul>", "body_text": "\ud83d\udc1b Bug\nAfter fixing #14102 issue it is possible to build static Caffe2 library with protobuf-lite now. However when built static caffe2 libraries are linked to user application full protobuf library is still required to be passed. It seems that despite libcaffe2.a library correctly linked with protobuf-lite, libcaffe2_protos.a library still needs full protobuf library. This behavior can be seen at least in Android ARM builds with build_android.sh script (with USE_LITE_PROTO=ON ONNX_USE_LITE_PROTO=ON cmake flags added).\nAlso while building shared version of Caffe2 for Android ARM I noticed that passing USE_LITE_PROTO, ONNX_USE_LITE_PROTO cmake flags has no impact on the final library size (I guess it is due to the fact that full protobuf library is still linked to final libcaffe2.so library)\nAnother small bug - libcaffe2_protos.a library is not included in install targets and running make install do not copy this library into install directory, however it is required by libcaffe2.a.\nTo Reproduce\nSteps to reproduce the behavior:\n\nmkdir build && cd build\ncmake -D USE_LITE_PROTO=ON -D ONNX_USE_LITE_PROTO=ON ..\nmake -j12\n\nExpected behavior\nBuilt static caffe2 library that do not require full protobuf.\nEnvironment\n\nPyTorch Version (e.g., 1.0): master\nOS (e.g., Linux): Android\nHow you installed PyTorch (conda, pip, source): source", "body": "## \ud83d\udc1b Bug\r\n\r\nAfter fixing #14102 issue it is possible to build static Caffe2 library with protobuf-lite now. However when built static caffe2 libraries are linked to user application full protobuf library is still required to be passed. It seems that despite libcaffe2.a library correctly linked with protobuf-lite, libcaffe2_protos.a library still needs full protobuf library. This behavior can be seen at least in Android ARM builds with build_android.sh script (with USE_LITE_PROTO=ON ONNX_USE_LITE_PROTO=ON cmake flags added).\r\nAlso while building shared version of Caffe2 for Android ARM I noticed that passing USE_LITE_PROTO, ONNX_USE_LITE_PROTO cmake flags has no impact on the final library size (I guess it is due to the fact that full protobuf library is still linked to final libcaffe2.so library)\r\n\r\nAnother small bug - libcaffe2_protos.a library is not included in install targets and running **make install** do not copy this library into install directory, however it is required by libcaffe2.a.\r\n\r\n## To Reproduce\r\n\r\nSteps to reproduce the behavior:\r\n\r\n> mkdir build && cd build\r\n> cmake -D USE_LITE_PROTO=ON -D ONNX_USE_LITE_PROTO=ON ..\r\n> make -j12\r\n\r\n## Expected behavior\r\nBuilt static caffe2 library that do not require full protobuf.\r\n\r\n\r\n## Environment\r\n\r\n - PyTorch Version (e.g., 1.0): master\r\n - OS (e.g., Linux): Android\r\n - How you installed PyTorch (`conda`, `pip`, source): source\r\n"}