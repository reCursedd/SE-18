{"url": "https://api.github.com/repos/pytorch/pytorch/issues/comments/305922453", "html_url": "https://github.com/pytorch/pytorch/issues/1707#issuecomment-305922453", "issue_url": "https://api.github.com/repos/pytorch/pytorch/issues/1707", "id": 305922453, "node_id": "MDEyOklzc3VlQ29tbWVudDMwNTkyMjQ1Mw==", "user": {"login": "ngimel", "id": 15841449, "node_id": "MDQ6VXNlcjE1ODQxNDQ5", "avatar_url": "https://avatars3.githubusercontent.com/u/15841449?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ngimel", "html_url": "https://github.com/ngimel", "followers_url": "https://api.github.com/users/ngimel/followers", "following_url": "https://api.github.com/users/ngimel/following{/other_user}", "gists_url": "https://api.github.com/users/ngimel/gists{/gist_id}", "starred_url": "https://api.github.com/users/ngimel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ngimel/subscriptions", "organizations_url": "https://api.github.com/users/ngimel/orgs", "repos_url": "https://api.github.com/users/ngimel/repos", "events_url": "https://api.github.com/users/ngimel/events{/privacy}", "received_events_url": "https://api.github.com/users/ngimel/received_events", "type": "User", "site_admin": false}, "created_at": "2017-06-02T22:21:33Z", "updated_at": "2017-06-02T22:21:33Z", "author_association": "CONTRIBUTOR", "body_html": "<p>That happens because context is incorrectly set on the 0-th device.<br>\nReplacing this <a href=\"https://github.com/pytorch/pytorch/blob/master/torch/multiprocessing/reductions.py#L104-L106\">https://github.com/pytorch/pytorch/blob/master/torch/multiprocessing/reductions.py#L104-L106</a><br>\nwith</p>\n<div class=\"highlight highlight-source-python\"><pre>       <span class=\"pl-k\">with</span> torch.cuda.device(storage.get_device()):\n            metadata <span class=\"pl-k\">=</span> storage._share_cuda_()\n            cache_key <span class=\"pl-k\">=</span> metadata[<span class=\"pl-c1\">1</span>]\n            rebuild <span class=\"pl-k\">=</span> rebuild_storage_cuda</pre></div>\n<p>gets you further, but there's still an error when shared tensor gets freed (also because of an incorrectly set device):</p>\n<pre lang=\"THCudaCheck\" data-meta=\"FAIL file=/tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c line=182 error=11 : invalid argument\"><code>terminate called after throwing an instance of 'THException'\n  what():  cuda runtime error (11) : invalid argument at /tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c:182\nTHCudaCheck FAIL file=/tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c line=182 error=11 : invalid argument\nterminate called after throwing an instance of 'THException'\n  what():  cuda runtime error (11) : invalid argument at /tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c:182\n</code></pre>", "body_text": "That happens because context is incorrectly set on the 0-th device.\nReplacing this https://github.com/pytorch/pytorch/blob/master/torch/multiprocessing/reductions.py#L104-L106\nwith\n       with torch.cuda.device(storage.get_device()):\n            metadata = storage._share_cuda_()\n            cache_key = metadata[1]\n            rebuild = rebuild_storage_cuda\ngets you further, but there's still an error when shared tensor gets freed (also because of an incorrectly set device):\nterminate called after throwing an instance of 'THException'\n  what():  cuda runtime error (11) : invalid argument at /tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c:182\nTHCudaCheck FAIL file=/tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c line=182 error=11 : invalid argument\nterminate called after throwing an instance of 'THException'\n  what():  cuda runtime error (11) : invalid argument at /tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c:182", "body": "That happens because context is incorrectly set on the 0-th device. \r\nReplacing this https://github.com/pytorch/pytorch/blob/master/torch/multiprocessing/reductions.py#L104-L106\r\nwith \r\n```.py\r\n       with torch.cuda.device(storage.get_device()):\r\n            metadata = storage._share_cuda_()\r\n            cache_key = metadata[1]\r\n            rebuild = rebuild_storage_cuda\r\n```\r\ngets you further, but there's still an error when shared tensor gets freed (also because of an incorrectly set device):\r\n```THCudaCheck FAIL file=/tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c line=182 error=11 : invalid argument\r\nterminate called after throwing an instance of 'THException'\r\n  what():  cuda runtime error (11) : invalid argument at /tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c:182\r\nTHCudaCheck FAIL file=/tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c line=182 error=11 : invalid argument\r\nterminate called after throwing an instance of 'THException'\r\n  what():  cuda runtime error (11) : invalid argument at /tmp/pip-95zy2atz-build/torch/lib/THC/generic/THCStorage.c:182\r\n```\r\n\r\n"}