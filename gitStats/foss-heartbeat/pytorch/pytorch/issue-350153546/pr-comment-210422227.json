{"url": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/210422227", "pull_request_review_id": 146635498, "id": 210422227, "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMDQyMjIyNw==", "diff_hunk": "@@ -59,58 +59,76 @@ void Tensor::backward(\n   pImpl->backward(std::move(gradient), keep_graph, create_graph);\n }\n \n-TensorImpl::TensorImpl(TensorTypeId type_id, ScalarType scalar_type)\n-    : type_id_(type_id), scalar_type_(scalar_type) {\n-  auto type = &globalContext().getType(tensorTypeIdToBackend(type_id), scalar_type);\n-  Storage* storage = type->storage(true).release();\n-  StorageImpl* storage_impl = storage->pImpl();\n-  tensor = new THTensor(storage_impl);\n+TensorImpl::TensorImpl(TensorTypeId type_id, ScalarType scalar_type, bool is_variable)\n+    : TensorImpl(nullptr, type_id, scalar_type, is_variable) {\n+  // UndefinedTensors and SparseTensors don't have storages.\n+  if (type_id != UndefinedTensorId() && scalar_type != ScalarType::Undefined\n+      && type_id != SparseCPUTensorId() && type_id != SparseCUDATensorId()) {\n+    auto type = &globalContext().getType(tensorTypeIdToBackend(type_id), scalar_type);\n+    auto storage = type->storage(true);\n+    storage_ = storage->pImpl();\n+    storage_->retain();\n+  }\n }\n \n+TensorImpl::TensorImpl(StorageImpl* storage, TensorTypeId type_id, bool is_variable)\n+    : TensorImpl(storage, type_id, storage->scalar_type(), is_variable) {}\n+\n+TensorImpl::TensorImpl(StorageImpl* storage, TensorTypeId type_id, ScalarType scalar_type, bool is_variable)\n+    : storage_(storage),\n+      storage_offset_(0),\n+      sizes_{0},\n+      strides_{1},\n+      type_id_(type_id),\n+      scalar_type_(scalar_type),\n+      is_variable_(is_variable) {}\n+\n TensorImpl::~TensorImpl() {\n-  if (tensor) tensor->release();\n+  if (storage_) {\n+    storage_->release();\n+    storage_ = nullptr;\n+  }\n }\n \n IntList TensorImpl::sizes() const {\n-  // NB: dim in tensor is not synchronized with THTensor, so it's\n-  // important to apply dim here\n-  return IntList(THTensor_getSizePtr(tensor), dim());\n+  return sizes_;\n }\n \n IntList TensorImpl::strides() const {\n-  // NB: dim in tensor is not synchronized with THTensor, so it's\n-  // important to apply dim here\n-  return IntList(THTensor_getStridePtr(tensor), dim());\n+  return strides_;\n }\n \n void TensorImpl::release_resources() {\n-  if (tensor) {\n-      tensor->release();\n-      tensor = nullptr;\n+  if (storage_) {\n+    storage_->release();", "path": "aten/src/ATen/TensorImpl.cpp", "position": 62, "original_position": 61, "commit_id": "26e44a20d0db758b928f8751881fc2e033ace926", "original_commit_id": "2677739bea2ed0e492f8c47eb29485d252ec1bd4", "user": {"login": "ezyang", "id": 13564, "node_id": "MDQ6VXNlcjEzNTY0", "avatar_url": "https://avatars0.githubusercontent.com/u/13564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ezyang", "html_url": "https://github.com/ezyang", "followers_url": "https://api.github.com/users/ezyang/followers", "following_url": "https://api.github.com/users/ezyang/following{/other_user}", "gists_url": "https://api.github.com/users/ezyang/gists{/gist_id}", "starred_url": "https://api.github.com/users/ezyang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ezyang/subscriptions", "organizations_url": "https://api.github.com/users/ezyang/orgs", "repos_url": "https://api.github.com/users/ezyang/repos", "events_url": "https://api.github.com/users/ezyang/events{/privacy}", "received_events_url": "https://api.github.com/users/ezyang/received_events", "type": "User", "site_admin": false}, "body": "Don't you need to `storage_ = nullptr` here? Otherwise you'll free it again in the destructor.", "created_at": "2018-08-15T21:55:25Z", "updated_at": "2018-11-23T15:49:27Z", "html_url": "https://github.com/pytorch/pytorch/pull/10479#discussion_r210422227", "pull_request_url": "https://api.github.com/repos/pytorch/pytorch/pulls/10479", "author_association": "CONTRIBUTOR", "_links": {"self": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/comments/210422227"}, "html": {"href": "https://github.com/pytorch/pytorch/pull/10479#discussion_r210422227"}, "pull_request": {"href": "https://api.github.com/repos/pytorch/pytorch/pulls/10479"}}, "body_html": "<p>Don't you need to <code>storage_ = nullptr</code> here? Otherwise you'll free it again in the destructor.</p>", "body_text": "Don't you need to storage_ = nullptr here? Otherwise you'll free it again in the destructor."}