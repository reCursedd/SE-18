{"url": "https://api.github.com/repos/pytorch/pytorch/issues/1721", "repository_url": "https://api.github.com/repos/pytorch/pytorch", "labels_url": "https://api.github.com/repos/pytorch/pytorch/issues/1721/labels{/name}", "comments_url": "https://api.github.com/repos/pytorch/pytorch/issues/1721/comments", "events_url": "https://api.github.com/repos/pytorch/pytorch/issues/1721/events", "html_url": "https://github.com/pytorch/pytorch/issues/1721", "id": 233521768, "node_id": "MDU6SXNzdWUyMzM1MjE3Njg=", "number": 1721, "title": "non-cudnn LSTM and GRU biases have wrong shapes", "user": {"login": "ShigekiKarita", "id": 6745326, "node_id": "MDQ6VXNlcjY3NDUzMjY=", "avatar_url": "https://avatars3.githubusercontent.com/u/6745326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ShigekiKarita", "html_url": "https://github.com/ShigekiKarita", "followers_url": "https://api.github.com/users/ShigekiKarita/followers", "following_url": "https://api.github.com/users/ShigekiKarita/following{/other_user}", "gists_url": "https://api.github.com/users/ShigekiKarita/gists{/gist_id}", "starred_url": "https://api.github.com/users/ShigekiKarita/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ShigekiKarita/subscriptions", "organizations_url": "https://api.github.com/users/ShigekiKarita/orgs", "repos_url": "https://api.github.com/users/ShigekiKarita/repos", "events_url": "https://api.github.com/users/ShigekiKarita/events{/privacy}", "received_events_url": "https://api.github.com/users/ShigekiKarita/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-06-05T08:09:41Z", "updated_at": "2017-06-07T13:55:41Z", "closed_at": "2017-06-07T13:55:41Z", "author_association": "NONE", "body_html": "<div class=\"highlight highlight-source-python\"><pre><span class=\"pl-k\">import</span> torch\n<span class=\"pl-k\">from</span> torch.autograd <span class=\"pl-k\">import</span> Variable\n\n\ntorch.backends.cudnn.enabled <span class=\"pl-k\">=</span> <span class=\"pl-c1\">False</span>\nin_size <span class=\"pl-k\">=</span> <span class=\"pl-c1\">3</span>\nx <span class=\"pl-k\">=</span> Variable(torch.rand(<span class=\"pl-c1\">4</span>, <span class=\"pl-c1\">2</span>, in_size))\nmodel <span class=\"pl-k\">=</span> torch.nn.LSTM(in_size, <span class=\"pl-c1\">2</span>, <span class=\"pl-c1\">1</span>)  <span class=\"pl-c\"><span class=\"pl-c\">#</span> GRU is also NG, RNN is OK</span>\nmodel.cuda()\n<span class=\"pl-c1\">print</span>(model.bias_hh_l0.size())  <span class=\"pl-c\"><span class=\"pl-c\">#</span> 8</span>\ny <span class=\"pl-k\">=</span> model(x.cuda())\n<span class=\"pl-c1\">print</span>(model.bias_hh_l0.size())  <span class=\"pl-c\"><span class=\"pl-c\">#</span> 1x8 (!)</span>\nmodel.cpu()\nmodel(x.cpu())</pre></div>\n<p>then</p>\n<pre><code>torch.Size([8])\ntorch.Size([1, 8])\nTraceback (most recent call last):\n  File \"/home/skarita/work/playground/minasr/egs/lstm_cpu.py\", line 14, in &lt;module&gt;\n    model(x.cpu())\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/modules/module.py\", line 206, in __call__\n    result = self.forward(*input, **kwargs)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/modules/rnn.py\", line 91, in forward\n    output, hidden = func(input, self.all_weights, hx)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 343, in forward\n    return func(input, *fargs, **fkwargs)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 243, in forward\n    nexth, output = func(input, hidden, weight)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 83, in forward\n    hy, output = inner(input, hidden[l], weight[l])\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 112, in forward\n    hidden = inner(input[i], hidden, *weight)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 30, in LSTMCell\n    gates = F.linear(input, w_ih, b_ih) + F.linear(hx, w_hh, b_hh)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/functional.py\", line 449, in linear\n    return state(input, weight) if bias is None else state(input, weight, bias)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/linear.py\", line 14, in forward\n    output.addr_(self.add_buffer, bias)\nRuntimeError: vector and vector expected, got 1D, 2D tensors at /py/conda-bld/pytorch_1493679085273/work/torch/lib/TH/generic/THTensorMath.c:1350\n\nProcess finished with exit code 1\n</code></pre>\n<p>when there's no forward in cuda, it's ok.</p>", "body_text": "import torch\nfrom torch.autograd import Variable\n\n\ntorch.backends.cudnn.enabled = False\nin_size = 3\nx = Variable(torch.rand(4, 2, in_size))\nmodel = torch.nn.LSTM(in_size, 2, 1)  # GRU is also NG, RNN is OK\nmodel.cuda()\nprint(model.bias_hh_l0.size())  # 8\ny = model(x.cuda())\nprint(model.bias_hh_l0.size())  # 1x8 (!)\nmodel.cpu()\nmodel(x.cpu())\nthen\ntorch.Size([8])\ntorch.Size([1, 8])\nTraceback (most recent call last):\n  File \"/home/skarita/work/playground/minasr/egs/lstm_cpu.py\", line 14, in <module>\n    model(x.cpu())\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/modules/module.py\", line 206, in __call__\n    result = self.forward(*input, **kwargs)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/modules/rnn.py\", line 91, in forward\n    output, hidden = func(input, self.all_weights, hx)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 343, in forward\n    return func(input, *fargs, **fkwargs)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 243, in forward\n    nexth, output = func(input, hidden, weight)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 83, in forward\n    hy, output = inner(input, hidden[l], weight[l])\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 112, in forward\n    hidden = inner(input[i], hidden, *weight)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 30, in LSTMCell\n    gates = F.linear(input, w_ih, b_ih) + F.linear(hx, w_hh, b_hh)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/functional.py\", line 449, in linear\n    return state(input, weight) if bias is None else state(input, weight, bias)\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/linear.py\", line 14, in forward\n    output.addr_(self.add_buffer, bias)\nRuntimeError: vector and vector expected, got 1D, 2D tensors at /py/conda-bld/pytorch_1493679085273/work/torch/lib/TH/generic/THTensorMath.c:1350\n\nProcess finished with exit code 1\n\nwhen there's no forward in cuda, it's ok.", "body": "``` python\r\nimport torch\r\nfrom torch.autograd import Variable\r\n\r\n\r\ntorch.backends.cudnn.enabled = False\r\nin_size = 3\r\nx = Variable(torch.rand(4, 2, in_size))\r\nmodel = torch.nn.LSTM(in_size, 2, 1)  # GRU is also NG, RNN is OK\r\nmodel.cuda()\r\nprint(model.bias_hh_l0.size())  # 8\r\ny = model(x.cuda())\r\nprint(model.bias_hh_l0.size())  # 1x8 (!)\r\nmodel.cpu()\r\nmodel(x.cpu())\r\n```\r\n\r\nthen\r\n\r\n```\r\ntorch.Size([8])\r\ntorch.Size([1, 8])\r\nTraceback (most recent call last):\r\n  File \"/home/skarita/work/playground/minasr/egs/lstm_cpu.py\", line 14, in <module>\r\n    model(x.cpu())\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/modules/module.py\", line 206, in __call__\r\n    result = self.forward(*input, **kwargs)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/modules/rnn.py\", line 91, in forward\r\n    output, hidden = func(input, self.all_weights, hx)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 343, in forward\r\n    return func(input, *fargs, **fkwargs)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 243, in forward\r\n    nexth, output = func(input, hidden, weight)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 83, in forward\r\n    hy, output = inner(input, hidden[l], weight[l])\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 112, in forward\r\n    hidden = inner(input[i], hidden, *weight)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/rnn.py\", line 30, in LSTMCell\r\n    gates = F.linear(input, w_ih, b_ih) + F.linear(hx, w_hh, b_hh)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/functional.py\", line 449, in linear\r\n    return state(input, weight) if bias is None else state(input, weight, bias)\r\n  File \"/home/skarita/.pyenv/versions/anaconda3-4.3.0/envs/tf/lib/python3.6/site-packages/torch/nn/_functions/linear.py\", line 14, in forward\r\n    output.addr_(self.add_buffer, bias)\r\nRuntimeError: vector and vector expected, got 1D, 2D tensors at /py/conda-bld/pytorch_1493679085273/work/torch/lib/TH/generic/THTensorMath.c:1350\r\n\r\nProcess finished with exit code 1\r\n```\r\n\r\nwhen there's no forward in cuda, it's ok."}